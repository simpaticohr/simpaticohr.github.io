<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakAI Elite | Voice-to-Voice English Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.06); }
        .glass-dark { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }

        .listening-pulse { animation: lpulse 1.5s infinite cubic-bezier(0.66,0,0,1); }
        @keyframes lpulse {
            0% { box-shadow: 0 0 0 0 rgba(99,102,241,0.6); }
            100% { box-shadow: 0 0 0 24px rgba(99,102,241,0); }
        }

        .speaking-pulse { animation: spulse 1.5s infinite cubic-bezier(0.66,0,0,1); }
        @keyframes spulse {
            0% { box-shadow: 0 0 0 0 rgba(74,222,128,0.6); }
            100% { box-shadow: 0 0 0 24px rgba(74,222,128,0); }
        }

        .thinking-pulse { animation: tpulse 1s infinite ease-in-out; }
        @keyframes tpulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(250,204,21,0.4); }
            50% { box-shadow: 0 0 0 12px rgba(250,204,21,0); }
        }

        .score-ring { transition: stroke-dashoffset 1.5s ease; }

        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 2px; }

        .mode-card { transition: all 0.3s; cursor: pointer; }
        .mode-card:hover { transform: translateY(-2px); border-color: rgba(99,102,241,0.4); }
        .mode-card.active { border-color: rgba(99,102,241,0.6); background: rgba(99,102,241,0.1); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.4s ease forwards; }

        .score-bar-fill { transition: width 1.2s ease; }

        .tab-btn.active { background: rgba(99,102,241,0.15); color: #818cf8; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav class="glass border-b border-white/5 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-sm">S</div>
                <div>
                    <span class="font-bold text-base">SpeakAI <span class="text-indigo-400">Elite</span></span>
                    <span class="hidden sm:inline text-xs text-slate-500 ml-2">Cloudflare AI</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-800/50 border border-slate-700/50 text-xs">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse" id="connDot"></span>
                    <span id="connText" class="text-slate-400">Ready</span>
                </div>
                <button onclick="showSection('practice')" class="tab-btn active text-xs font-semibold px-3 py-1.5 rounded-lg" id="tab-practice">Practice</button>
                <button onclick="showSection('dashboard')" class="tab-btn text-xs font-semibold px-3 py-1.5 rounded-lg text-slate-400" id="tab-dashboard">Dashboard</button>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6">

        <!-- PRACTICE SECTION -->
        <div id="section-practice">

            <!-- Mode Selector -->
            <div id="modeSelector" class="mb-6">
                <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Choose Mode</h2>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent active" onclick="selectMode('free-talk', this)">
                        <div class="text-2xl mb-2">üí¨</div>
                        <div class="font-semibold text-sm">Free Talk</div>
                    </div>
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent" onclick="selectMode('interview-prep', this)">
                        <div class="text-2xl mb-2">üíº</div>
                        <div class="font-semibold text-sm">Interview</div>
                    </div>
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent" onclick="selectMode('business-english', this)">
                        <div class="text-2xl mb-2">üìä</div>
                        <div class="font-semibold text-sm">Business</div>
                    </div>
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent" onclick="selectMode('ielts-practice', this)">
                        <div class="text-2xl mb-2">üìù</div>
                        <div class="font-semibold text-sm">IELTS</div>
                    </div>
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent" onclick="selectMode('daily-conversation', this)">
                        <div class="text-2xl mb-2">‚òï</div>
                        <div class="font-semibold text-sm">Daily Chat</div>
                    </div>
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent" onclick="selectMode('pronunciation', this)">
                        <div class="text-2xl mb-2">üó£Ô∏è</div>
                        <div class="font-semibold text-sm">Pronunciation</div>
                    </div>
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent" onclick="selectMode('vocabulary-builder', this)">
                        <div class="text-2xl mb-2">üìö</div>
                        <div class="font-semibold text-sm">Vocabulary</div>
                    </div>
                    <div class="mode-card glass-dark rounded-2xl p-4 text-center border border-transparent" onclick="selectMode('role-play', this)">
                        <div class="text-2xl mb-2">üé≠</div>
                        <div class="font-semibold text-sm">Role Play</div>
                    </div>
                </div>
            </div>

            <!-- Main Arena -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4" style="min-height:520px;">

                <!-- LEFT: Mic -->
                <div class="glass rounded-3xl p-6 flex flex-col items-center justify-center relative overflow-hidden">
                    <div id="glowBg" class="absolute inset-0 bg-indigo-500/5 blur-3xl transition-opacity duration-700 opacity-0"></div>

                    <!-- Debug Info -->
                    <div id="debugInfo" class="absolute top-3 left-3 text-[10px] text-slate-600 font-mono z-20"></div>

                    <!-- Status -->
                    <div id="statusPill" class="relative z-10 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/80 border border-slate-700/50 text-xs font-medium mb-6">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-500" id="statusDot"></span>
                        <span id="statusLabel">Tap mic to begin</span>
                    </div>

                    <!-- Mic Button -->
                    <button id="micBtn" onclick="toggleSession()" class="relative z-10 w-32 h-32 rounded-full bg-slate-800 border-2 border-slate-600 flex items-center justify-center transition-all duration-300 hover:scale-105">
                        <svg id="micIcon" class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </button>

                    <!-- Mode & Timer -->
                    <p class="mt-4 font-semibold text-indigo-400 text-sm relative z-10" id="currentModeLabel">üí¨ Free Talk</p>
                    <p class="mt-2 text-slate-600 text-xs font-mono relative z-10" id="sessionTimer">00:00</p>

                    <!-- Volume Meter -->
                    <div class="mt-4 w-32 h-2 bg-slate-800 rounded-full overflow-hidden relative z-10">
                        <div id="volumeBar" class="h-full bg-indigo-500 rounded-full transition-all duration-100" style="width:0%"></div>
                    </div>
                    <p class="text-[10px] text-slate-600 mt-1 relative z-10" id="volumeLabel">Volume: 0</p>

                    <!-- End Button -->
                    <button id="endBtn" onclick="endSession()" class="mt-4 text-xs text-red-400 hover:text-red-300 transition relative z-10 hidden">‚èπ End Session</button>
                </div>

                <!-- CENTER: Chat -->
                <div class="glass rounded-3xl p-5 flex flex-col">
                    <div class="flex items-center justify-between mb-3 pb-3 border-b border-white/5">
                        <h3 class="font-semibold text-sm text-slate-300">Conversation</h3>
                        <span class="text-[10px] text-indigo-400 bg-indigo-500/10 px-2 py-0.5 rounded font-semibold">LIVE</span>
                    </div>
                    <div id="chatBox" class="chat-scroll flex-1 overflow-y-auto space-y-3 pr-1">
                        <div class="text-center text-slate-600 text-xs py-16">
                            <div class="text-3xl mb-3">üéôÔ∏è</div>
                            Tap the mic and start speaking...<br>Your conversation appears here.
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Scores -->
                <div class="glass rounded-3xl p-5 flex flex-col">
                    <div class="flex items-center justify-between mb-3 pb-3 border-b border-white/5">
                        <h3 class="font-semibold text-sm text-slate-300">Live Evaluation</h3>
                        <span class="text-[10px] text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded font-semibold" id="evalBadge">READY</span>
                    </div>

                    <!-- Score Ring -->
                    <div class="flex justify-center my-4">
                        <div class="relative w-24 h-24">
                            <svg class="w-24 h-24 -rotate-90" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="#1e293b" stroke-width="8"/>
                                <circle id="scoreRing" class="score-ring" cx="50" cy="50" r="42" fill="none" stroke="#6366f1" stroke-width="8" stroke-linecap="round" stroke-dasharray="264" stroke-dashoffset="264"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-2xl font-bold" id="overallScore">0</span>
                                <span class="text-[10px] text-slate-500">OVERALL</span>
                            </div>
                        </div>
                    </div>

                    <!-- Score Bars -->
                    <div class="space-y-3 flex-1">
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-slate-400">üìù Grammar</span><span class="font-semibold" id="score-grammar">0</span></div>
                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="score-bar-fill h-full bg-indigo-500 rounded-full" id="bar-grammar" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-slate-400">üìö Vocabulary</span><span class="font-semibold" id="score-vocabulary">0</span></div>
                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="score-bar-fill h-full bg-purple-500 rounded-full" id="bar-vocabulary" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-slate-400">üí¨ Fluency</span><span class="font-semibold" id="score-fluency">0</span></div>
                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="score-bar-fill h-full bg-cyan-500 rounded-full" id="bar-fluency" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-slate-400">üó£Ô∏è Pronunciation</span><span class="font-semibold" id="score-pronunciation">0</span></div>
                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="score-bar-fill h-full bg-amber-500 rounded-full" id="bar-pronunciation" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-slate-400">üí™ Confidence</span><span class="font-semibold" id="score-confidence">0</span></div>
                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="score-bar-fill h-full bg-emerald-500 rounded-full" id="bar-confidence" style="width:0%"></div></div>
                        </div>
                    </div>

                    <!-- Feedback -->
                    <div class="mt-3 pt-3 border-t border-white/5">
                        <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-2">Feedback</p>
                        <div id="feedbackBox" class="text-xs text-slate-400 leading-relaxed max-h-24 overflow-y-auto">
                            Start speaking to get feedback...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DASHBOARD SECTION -->
        <div id="section-dashboard" class="hidden">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div class="glass-dark rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-indigo-400" id="dash-sessions">0</div>
                    <div class="text-xs text-slate-500 mt-1">Sessions</div>
                </div>
                <div class="glass-dark rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-emerald-400" id="dash-minutes">0</div>
                    <div class="text-xs text-slate-500 mt-1">Minutes</div>
                </div>
                <div class="glass-dark rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-amber-400" id="dash-streak">0</div>
                    <div class="text-xs text-slate-500 mt-1">Streak üî•</div>
                </div>
                <div class="glass-dark rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-purple-400" id="dash-best">0</div>
                    <div class="text-xs text-slate-500 mt-1">Best Score</div>
                </div>
            </div>

            <div class="glass rounded-3xl p-6 mb-6">
                <h3 class="font-semibold text-sm text-slate-300 mb-4">üìä Average Scores</h3>
                <div class="grid grid-cols-3 sm:grid-cols-6 gap-4">
                    <div class="text-center"><div class="text-2xl font-bold text-indigo-400" id="dash-avg-grammar">0</div><div class="text-xs text-slate-500">Grammar</div></div>
                    <div class="text-center"><div class="text-2xl font-bold text-purple-400" id="dash-avg-vocabulary">0</div><div class="text-xs text-slate-500">Vocab</div></div>
                    <div class="text-center"><div class="text-2xl font-bold text-cyan-400" id="dash-avg-fluency">0</div><div class="text-xs text-slate-500">Fluency</div></div>
                    <div class="text-center"><div class="text-2xl font-bold text-amber-400" id="dash-avg-pronunciation">0</div><div class="text-xs text-slate-500">Pronun.</div></div>
                    <div class="text-center"><div class="text-2xl font-bold text-emerald-400" id="dash-avg-confidence">0</div><div class="text-xs text-slate-500">Confidence</div></div>
                    <div class="text-center"><div class="text-2xl font-bold text-rose-400" id="dash-avg-overall">0</div><div class="text-xs text-slate-500">Overall</div></div>
                </div>
            </div>

            <div class="glass rounded-3xl p-6">
                <h3 class="font-semibold text-sm text-slate-300 mb-4">üìú Recent Sessions</h3>
                <div id="sessionHistory" class="space-y-3">
                    <div class="text-center text-slate-600 text-xs py-8">No sessions yet</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // =============================================
        // CONFIG - CHANGE YOUR WORKER URL HERE
        // =============================================
        const WORKER_URL = "https://white-salad-c1fd.zelvora-global.workers.dev/";
        const USER_ID = localStorage.getItem('career_access_code') || 'guest_' + Math.random().toString(36).slice(2);

        // =============================================
        // STATE
        // =============================================
        let isActive = false;
        let isProcessing = false;
        let isSpeaking = false;
        let currentMode = 'free-talk';
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let micStream = null;
        let audioChunks = [];
        let chatHistory = [];
        let sessionScores = [];
        let sessionStartTime = null;
        let timerInterval = null;
        let turnCount = 0;
        let recordingStartTime = null;

        // TUNED Silence Detection
        const SILENCE_THRESHOLD = 10;
        const SILENCE_DURATION = 2000; // 2 seconds
        const MIN_RECORDING_TIME = 1500; // At least 1.5s of recording
        const MIN_AUDIO_SIZE = 3000; // Minimum blob size in bytes

        // Mode labels
        const modeLabels = {
            'free-talk': 'üí¨ Free Talk', 'interview-prep': 'üíº Interview',
            'business-english': 'üìä Business', 'ielts-practice': 'üìù IELTS',
            'daily-conversation': '‚òï Daily Chat', 'pronunciation': 'üó£Ô∏è Pronunciation',
            'vocabulary-builder': 'üìö Vocabulary', 'role-play': 'üé≠ Role Play'
        };

        // =============================================
        // MODE SELECTION
        // =============================================
        function selectMode(mode, el) {
            if (isActive) return;
            currentMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('currentModeLabel').textContent = modeLabels[mode];
        }

        // =============================================
        // SECTION SWITCHING
        // =============================================
        function showSection(name) {
            document.getElementById('section-practice').classList.toggle('hidden', name !== 'practice');
            document.getElementById('section-dashboard').classList.toggle('hidden', name !== 'dashboard');

            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');

            if (name === 'dashboard') loadDashboard();
        }

        // =============================================
        // SESSION CONTROL
        // =============================================
        function toggleSession() {
            if (isActive) {
                endSession();
            } else {
                startSession();
            }
        }

        async function startSession() {
            isActive = true;
            isProcessing = false;
            isSpeaking = false;
            chatHistory = [];
            sessionScores = [];
            turnCount = 0;
            sessionStartTime = Date.now();

            document.getElementById('endBtn').classList.remove('hidden');
            document.getElementById('modeSelector').style.opacity = '0.3';
            document.getElementById('modeSelector').style.pointerEvents = 'none';

            // Timer
            timerInterval = setInterval(updateTimer, 1000);

            // Clear chat
            document.getElementById('chatBox').innerHTML = '';
            addMessage('System', `Started ${modeLabels[currentMode]} mode. Speak clearly into your mic!`, 'system');

            try {
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000
                    }
                });

                setupVAD(micStream);
                beginRecording();
                updateUI('listening');
                debug('Mic active. Speak now!');

            } catch (e) {
                alert('‚ùå Microphone access is required.\n\nPlease allow microphone access and try again.');
                isActive = false;
                updateUI('idle');
            }
        }

        async function endSession() {
            isActive = false;
            isProcessing = false;
            isSpeaking = false;

            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                try { mediaRecorder.stop(); } catch (e) {}
            }
            if (audioContext) {
                try { audioContext.close(); } catch (e) {}
                audioContext = null;
            }
            if (micStream) {
                micStream.getTracks().forEach(t => t.stop());
                micStream = null;
            }
            clearInterval(timerInterval);
            window.speechSynthesis.cancel();

            updateUI('idle');
            document.getElementById('endBtn').classList.add('hidden');
            document.getElementById('modeSelector').style.opacity = '1';
            document.getElementById('modeSelector').style.pointerEvents = 'auto';

            if (turnCount > 0) {
                await saveSession();
            }

            addMessage('System', '‚úÖ Session ended. Well done! üëè', 'system');
            debug('Session ended');
        }

        // =============================================
        // RECORDING - FIXED VERSION
        // =============================================
        function beginRecording() {
            if (!isActive || !micStream) return;

            audioChunks = [];
            recordingStartTime = Date.now();

            try {
                mediaRecorder = new MediaRecorder(micStream, {
                    mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                        ? 'audio/webm;codecs=opus'
                        : 'audio/webm'
                });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    if (!isActive) return;

                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = [];

                    const recordingDuration = Date.now() - (recordingStartTime || Date.now());

                    debug(`Recorded: ${(blob.size / 1024).toFixed(1)}KB, ${(recordingDuration / 1000).toFixed(1)}s`);

                    // Only process if meaningful audio
                    if (blob.size >= MIN_AUDIO_SIZE && recordingDuration >= MIN_RECORDING_TIME) {
                        processAudio(blob);
                    } else {
                        debug(`Skipped: too short (${blob.size}B, ${recordingDuration}ms)`);
                        beginRecording(); // Restart immediately
                    }
                };

                // Record in chunks of 250ms for better data capture
                mediaRecorder.start(250);
                debug('Recording started...');

            } catch (e) {
                debug('Recording error: ' + e.message);
                console.error('MediaRecorder error:', e);
            }
        }

        // =============================================
        // VOICE ACTIVITY DETECTION (FIXED)
        // =============================================
        function setupVAD(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const mic = audioContext.createMediaStreamSource(stream);
            mic.connect(analyser);
            analyser.fftSize = 512;
            analyser.smoothingTimeConstant = 0.8;

            const bufLen = analyser.frequencyBinCount;
            const data = new Uint8Array(bufLen);
            let silenceStart = Date.now();
            let hasVoice = false;

            function monitor() {
                if (!isActive) return;

                // DON'T check silence while processing or AI is speaking
                if (isProcessing || isSpeaking) {
                    requestAnimationFrame(monitor);
                    return;
                }

                analyser.getByteFrequencyData(data);

                // Calculate RMS volume
                let sum = 0;
                for (let i = 0; i < bufLen; i++) sum += data[i] * data[i];
                const rms = Math.sqrt(sum / bufLen);
                const volume = Math.min(100, Math.round(rms * 1.5));

                // Update volume bar
                document.getElementById('volumeBar').style.width = `${volume}%`;
                document.getElementById('volumeLabel').textContent = `Volume: ${volume}`;

                // Visual mic feedback
                const btn = document.getElementById('micBtn');
                if (volume > 8) {
                    btn.style.transform = `scale(${1 + Math.min(volume / 200, 0.25)})`;
                    silenceStart = Date.now();
                    hasVoice = true;
                } else {
                    btn.style.transform = 'scale(1)';
                }

                // Silence detection - only trigger if we heard voice first
                const silenceTime = Date.now() - silenceStart;
                const recordingTime = Date.now() - (recordingStartTime || Date.now());

                if (hasVoice &&
                    silenceTime > SILENCE_DURATION &&
                    volume < SILENCE_THRESHOLD &&
                    recordingTime > MIN_RECORDING_TIME) {

                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        debug('Silence detected ‚Üí stopping recording');
                        hasVoice = false;
                        mediaRecorder.stop();
                        updateUI('processing');
                    }
                    silenceStart = Date.now();
                }

                requestAnimationFrame(monitor);
            }

            monitor();
        }

        // =============================================
        // AUDIO PROCESSING PIPELINE
        // =============================================
        async function processAudio(blob) {
            if (isProcessing) return;
            isProcessing = true;
            updateUI('processing');

            try {
                // 1. TRANSCRIBE
                debug('Sending to Whisper...');
                const fd = new FormData();
                fd.append('audio', blob, 'recording.webm');

                const tRes = await fetch(`${WORKER_URL}/api/transcribe`, {
                    method: 'POST',
                    body: fd
                });

                if (!tRes.ok) {
                    throw new Error(`Transcribe failed: ${tRes.status}`);
                }

                const tData = await tRes.json();
                debug(`Whisper: "${tData.transcription}"`);

                if (!tData.transcription || tData.transcription.trim().length < 2) {
                    debug('No speech detected, restarting...');
                    isProcessing = false;
                    updateUI('listening');
                    beginRecording();
                    return;
                }

                const userText = tData.transcription.trim();
                addMessage('You', userText, 'user');
                turnCount++;

                // 2. EVALUATE (fire and forget - parallel)
                const evalPromise = fetch(`${WORKER_URL}/api/evaluate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcription: userText, mode: currentMode })
                }).then(r => r.json()).catch(e => {
                    console.log('Eval error:', e);
                    return null;
                });

                // 3. GET AI RESPONSE
                debug('Getting AI response...');
                const chatRes = await fetch(`${WORKER_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: userText,
                        mode: currentMode,
                        history: chatHistory.slice(-8)
                    })
                });

                if (!chatRes.ok) {
                    throw new Error(`Chat failed: ${chatRes.status}`);
                }

                const chatData = await chatRes.json();
                const aiReply = chatData.response;
                debug(`AI: "${aiReply.substring(0, 50)}..."`);

                addMessage('AI Coach', aiReply, 'ai');

                // Update history
                chatHistory.push({ role: 'user', content: userText });
                chatHistory.push({ role: 'assistant', content: aiReply });

                // 4. PROCESS EVALUATION (from parallel request)
                const evalResult = await evalPromise;
                if (evalResult?.evaluation) {
                    updateScores(evalResult.evaluation);
                    sessionScores.push(evalResult.evaluation);
                }

                // 5. SPEAK AI RESPONSE
                isProcessing = false;
                await speakResponse(aiReply);

            } catch (e) {
                console.error('Pipeline error:', e);
                debug('Error: ' + e.message);
                addMessage('System', '‚ö†Ô∏è Connection issue. Retrying...', 'system');
                isProcessing = false;
                updateUI('listening');
                beginRecording();
            }
        }

        // =============================================
        // TEXT TO SPEECH
        // =============================================
        async function speakResponse(text) {
            isSpeaking = true;
            updateUI('speaking');

            return new Promise(resolve => {
                const utterance = new SpeechSynthesisUtterance(text);

                // Pick best voice
                const voices = window.speechSynthesis.getVoices();
                const preferred = voices.find(v =>
                    v.name.includes('Google US English') ||
                    v.name.includes('Samantha') ||
                    v.name.includes('Microsoft Zira')
                ) || voices.find(v => v.lang.startsWith('en')) || voices[0];

                if (preferred) {
                    utterance.voice = preferred;
                    debug(`Voice: ${preferred.name}`);
                }

                utterance.rate = 0.95;
                utterance.pitch = 1.0;

                utterance.onend = () => {
                    isSpeaking = false;
                    debug('AI finished speaking');
                    setTimeout(() => {
                        if (isActive) {
                            updateUI('listening');
                            beginRecording();
                        }
                        resolve();
                    }, 600);
                };

                utterance.onerror = (e) => {
                    console.log('TTS error:', e);
                    isSpeaking = false;
                    if (isActive) {
                        updateUI('listening');
                        beginRecording();
                    }
                    resolve();
                };

                window.speechSynthesis.speak(utterance);
            });
        }

        // =============================================
        // SCORE UPDATES
        // =============================================
        function updateScores(evalData) {
            const cats = ['grammar', 'vocabulary', 'fluency', 'pronunciation', 'confidence'];
            let total = 0;
            let count = 0;

            cats.forEach(cat => {
                const score = Math.min(100, Math.max(0, evalData[cat]?.score || 0));
                document.getElementById(`score-${cat}`).textContent = score;
                document.getElementById(`bar-${cat}`).style.width = `${score}%`;
                total += score;
                count++;
            });

            const overall = Math.round(total / count);
            document.getElementById('overallScore').textContent = overall;

            // Ring
            const ring = document.getElementById('scoreRing');
            ring.style.strokeDashoffset = 264 - (264 * overall / 100);
            ring.style.stroke = overall >= 80 ? '#4ade80' : overall >= 60 ? '#6366f1' : overall >= 40 ? '#facc15' : '#f87171';

            document.getElementById('evalBadge').textContent = `${overall}/100`;

            // Feedback
            let fb = [];
            if (evalData.corrections?.length > 0) fb.push(`<span class="text-red-400">‚úèÔ∏è ${evalData.corrections.slice(0, 2).join('; ')}</span>`);
            if (evalData.suggestions?.length > 0) fb.push(`<span class="text-emerald-400">üí° ${evalData.suggestions[0]}</span>`);
            if (evalData.overall?.feedback) fb.push(`<span class="text-slate-400">${evalData.overall.feedback}</span>`);
            if (fb.length > 0) document.getElementById('feedbackBox').innerHTML = fb.join('<br>');
        }

        // =============================================
        // UI MANAGEMENT
        // =============================================
        function updateUI(state) {
            const btn = document.getElementById('micBtn');
            const dot = document.getElementById('statusDot');
            const label = document.getElementById('statusLabel');
            const glow = document.getElementById('glowBg');

            btn.className = 'relative z-10 w-32 h-32 rounded-full flex items-center justify-center transition-all duration-300';

            switch (state) {
                case 'listening':
                    btn.classList.add('bg-indigo-600', 'listening-pulse');
                    dot.className = 'w-1.5 h-1.5 rounded-full bg-indigo-400 animate-pulse';
                    label.textContent = 'üéôÔ∏è Listening...';
                    glow.classList.add('opacity-100');
                    document.getElementById('connText').textContent = 'Listening';
                    document.getElementById('connDot').className = 'w-1.5 h-1.5 rounded-full bg-indigo-400 animate-pulse';
                    break;

                case 'processing':
                    btn.classList.add('bg-slate-700', 'border-2', 'border-yellow-500/30', 'thinking-pulse');
                    dot.className = 'w-1.5 h-1.5 rounded-full bg-yellow-400 animate-bounce';
                    label.textContent = 'üß† Analyzing...';
                    glow.classList.remove('opacity-100');
                    document.getElementById('connText').textContent = 'Processing';
                    document.getElementById('connDot').className = 'w-1.5 h-1.5 rounded-full bg-yellow-400 animate-bounce';
                    break;

                case 'speaking':
                    btn.classList.add('bg-emerald-600', 'speaking-pulse');
                    dot.className = 'w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse';
                    label.textContent = 'üîä AI Speaking...';
                    glow.classList.remove('opacity-100');
                    document.getElementById('connText').textContent = 'Speaking';
                    document.getElementById('connDot').className = 'w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse';
                    break;

                default:
                    btn.classList.add('bg-slate-800', 'border-2', 'border-slate-600', 'hover:scale-105');
                    dot.className = 'w-1.5 h-1.5 rounded-full bg-slate-500';
                    label.textContent = 'Tap mic to begin';
                    glow.classList.remove('opacity-100');
                    document.getElementById('volumeBar').style.width = '0%';
                    document.getElementById('volumeLabel').textContent = 'Volume: 0';
                    document.getElementById('connText').textContent = 'Ready';
                    document.getElementById('connDot').className = 'w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse';
            }
        }

        // =============================================
        // CHAT MESSAGES
        // =============================================
        function addMessage(sender, text, type) {
            const box = document.getElementById('chatBox');
            if (box.children[0]?.textContent?.includes('Tap the mic')) box.innerHTML = '';

            const div = document.createElement('div');
            div.className = 'slide-up';

            if (type === 'system') {
                div.innerHTML = `<div class="text-center text-slate-600 text-[11px] italic py-1">${text}</div>`;
            } else {
                const isUser = type === 'user';
                div.innerHTML = `
                    <div class="p-3 rounded-2xl text-xs leading-relaxed ${isUser
                        ? 'bg-indigo-500/10 border border-indigo-500/15 ml-8'
                        : 'bg-emerald-500/10 border border-emerald-500/15 mr-8'}">
                        <strong class="${isUser ? 'text-indigo-400' : 'text-emerald-400'} text-[11px] block mb-1">${sender}</strong>
                        ${text}
                    </div>`;
            }

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // =============================================
        // TIMER
        // =============================================
        function updateTimer() {
            if (!sessionStartTime) return;
            const e = Math.floor((Date.now() - sessionStartTime) / 1000);
            document.getElementById('sessionTimer').textContent =
                `${String(Math.floor(e / 60)).padStart(2, '0')}:${String(e % 60).padStart(2, '0')}`;
        }

        // =============================================
        // DEBUG
        // =============================================
        function debug(msg) {
            console.log('[SpeakAI]', msg);
            document.getElementById('debugInfo').textContent = msg;
        }

        // =============================================
        // SAVE & DASHBOARD
        // =============================================
        async function saveSession() {
            const mins = Math.round((Date.now() - sessionStartTime) / 60000);
            let avgScores = { grammar: 0, vocabulary: 0, fluency: 0, pronunciation: 0, confidence: 0, overall: 0 };

            if (sessionScores.length > 0) {
                ['grammar', 'vocabulary', 'fluency', 'pronunciation', 'confidence'].forEach(cat => {
                    avgScores[cat] = Math.round(sessionScores.reduce((s, e) => s + (e[cat]?.score || 0), 0) / sessionScores.length);
                });
                avgScores.overall = Math.round((avgScores.grammar + avgScores.vocabulary + avgScores.fluency + avgScores.pronunciation + avgScores.confidence) / 5);
            }

            try {
                await fetch(`${WORKER_URL}/api/save-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        sessionData: {
                            mode: currentMode,
                            modeLabel: modeLabels[currentMode],
                            durationMinutes: mins,
                            turns: turnCount,
                            scores: avgScores,
                            overallScore: avgScores.overall
                        }
                    })
                });
            } catch (e) { console.log('Save error:', e); }
        }

        async function loadDashboard() {
            try {
                const res = await fetch(`${WORKER_URL}/api/get-dashboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: USER_ID })
                });
                const data = await res.json();

                document.getElementById('dash-sessions').textContent = data.stats?.totalSessions || 0;
                document.getElementById('dash-minutes').textContent = data.stats?.totalMinutes || 0;
                document.getElementById('dash-streak').textContent = data.stats?.streak || 0;
                document.getElementById('dash-best').textContent = data.stats?.bestScore || 0;

                const avg = data.averageScores || {};
                ['grammar', 'vocabulary', 'fluency', 'pronunciation', 'confidence', 'overall'].forEach(c => {
                    const el = document.getElementById(`dash-avg-${c}`);
                    if (el) el.textContent = avg[c] || 0;
                });

                const sessions = data.recentSessions || [];
                const histEl = document.getElementById('sessionHistory');
                if (sessions.length === 0) {
                    histEl.innerHTML = '<div class="text-center text-slate-600 text-xs py-8">No sessions yet</div>';
                } else {
                    histEl.innerHTML = sessions.map(s => `
                        <div class="glass-dark rounded-xl p-4 flex items-center justify-between">
                            <div>
                                <div class="font-semibold text-sm">${s.modeLabel || s.mode}</div>
                                <div class="text-xs text-slate-500 mt-1">${s.turns || 0} turns ¬∑ ${s.durationMinutes || 0}m ¬∑ ${new Date(s.date).toLocaleDateString()}</div>
                            </div>
                            <div class="text-xl font-bold ${s.overallScore >= 70 ? 'text-emerald-400' : 'text-amber-400'}">${s.overallScore || 0}</div>
                        </div>
                    `).join('');
                }
            } catch (e) { console.log('Dashboard error:', e); }
        }

        // =============================================
        // INIT
        // =============================================
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        }

        // Test worker connection
        fetch(WORKER_URL)
            .then(r => r.json())
            .then(d => debug('Worker: ' + (d.status || 'Connected')))
            .catch(e => {
                debug('Worker connection failed!');
                document.getElementById('connDot').className = 'w-1.5 h-1.5 rounded-full bg-red-400';
                document.getElementById('connText').textContent = 'Offline';
            });
    </script>
</body>
</html>
