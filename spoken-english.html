<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spoken English Practice | Simpatico</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #0f172a, #020617);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  color: white;
}

.card {
  width: 320px;
  background: rgba(15, 23, 42, 0.85);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 0 40px rgba(0,0,0,0.4);
  text-align: center;
}

h2 {
  margin: 0 0 6px;
  font-size: 20px;
}

.status {
  font-size: 13px;
  color: #94a3b8;
  margin-bottom: 14px;
}

button {
  width: 100%;
  border: none;
  padding: 12px;
  border-radius: 10px;
  font-size: 15px;
  margin-top: 10px;
  cursor: pointer;
}

.start {
  background: #2563eb;
  color: white;
}

.stop {
  background: #334155;
  color: #cbd5f5;
}

.result {
  text-align: left;
  font-size: 13px;
  margin-top: 14px;
  color: #e5e7eb;
}

.score {
  font-size: 22px;
  font-weight: bold;
  text-align: center;
  margin-top: 10px;
}
</style>
</head>

<body>

<div class="card">
  <h2>Spoken English Practice</h2>
  <div class="status" id="status">Press start and speak for 5â€“10 seconds</div>

  <button class="start" id="startBtn">ðŸŽ¤ Start Speaking</button>
  <button class="stop" id="stopBtn" disabled>Stop</button>

  <div class="result" id="output"></div>
  <div class="score" id="score"></div>
</div>

<script>
let recorder;
let audioChunks = [];
let stream;

const WORKER_URL = "https://evalis-ai.simpaticoh rconsultancy.workers.dev/";

const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const output = document.getElementById("output");
const scoreEl = document.getElementById("score");

startBtn.onclick = async () => {
  output.innerHTML = "";
  scoreEl.innerHTML = "";
  audioChunks = [];

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  recorder = new MediaRecorder(stream, {
    mimeType: "audio/webm"
  });

  recorder.ondataavailable = e => {
    if (e.data.size > 0) audioChunks.push(e.data);
  };

  recorder.start();
  statusEl.textContent = "Listeningâ€¦ Speak clearly";
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = async () => {
  stopBtn.disabled = true;
  statusEl.textContent = "Processingâ€¦";

  recorder.stop();
  recorder.onstop = async () => {
    stream.getTracks().forEach(t => t.stop());

    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

    if (audioBlob.size < 5000) {
      statusEl.textContent = "No speech detected";
      startBtn.disabled = false;
      return;
    }

    const form = new FormData();
    form.append("audio", audioBlob, "speech.webm");

    try {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        body: form
      });

      const data = await res.json();

      output.innerHTML = `
        <strong>You said:</strong><br>${data.transcript || "(none)"}<br><br>
        <strong>Feedback:</strong><br>${data.feedback || "â€”"}
      `;

      scoreEl.textContent = `${data.score}/10`;
      statusEl.textContent = "Completed";
    } catch (err) {
      statusEl.textContent = "Server error";
    }

    startBtn.disabled = false;
  };
};
</script>

</body>
</html>
