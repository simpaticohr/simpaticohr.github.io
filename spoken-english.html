<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakAI | Elite Fluency Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
    (function () {
        if (!localStorage.getItem("career_access_code")) {
            window.location.replace("career-lab-gate.html");
        }
    })();
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* PULSE ANIMATION FOR LISTENING */
        .listening-ring {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            animation: pulse-blue 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-blue {
            to { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); }
        }

        /* SPEAKING ANIMATION */
        .speaking-ring {
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            animation: pulse-green 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-green {
            to { box-shadow: 0 0 0 20px rgba(74, 222, 128, 0); }
        }

        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="glass border-b border-white/5 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center font-bold">S</div>
                <span class="font-bold text-lg tracking-tight">SpeakAI <span class="text-indigo-400">Elite</span></span>
            </div>
            <button onclick="endSession()" class="text-xs font-semibold text-slate-400 hover:text-white uppercase tracking-wider">End Session</button>
        </div>
    </nav>

    <main class="flex-1 max-w-4xl mx-auto w-full p-6 flex flex-col gap-6">
        
        <div class="text-center py-4">
            <div id="status-pill" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-sm font-medium transition-all">
                <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                Ready to start
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[500px]">
            
            <div class="glass rounded-3xl p-8 flex flex-col items-center justify-center relative overflow-hidden">
                <div id="glow-bg" class="absolute inset-0 bg-indigo-500/10 blur-3xl opacity-0 transition-opacity duration-700"></div>

                <button id="micBtn" onclick="toggleSession()" class="relative z-10 w-32 h-32 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center transition-all duration-300 hover:scale-105 group">
                    <svg id="micIcon" class="w-10 h-10 text-white group-hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                </button>

                <p id="instruction" class="mt-8 text-slate-400 text-center text-sm">Tap microphone to begin<br>Hands-free mode</p>
            </div>

            <div class="glass rounded-3xl p-6 flex flex-col">
                <div class="flex items-center justify-between mb-4 border-b border-white/5 pb-4">
                    <h3 class="font-semibold text-slate-200">Live Transcript</h3>
                    <span class="text-xs text-indigo-400 bg-indigo-500/10 px-2 py-1 rounded">AI Active</span>
                </div>
                <div id="chat-box" class="chat-scroll flex-1 overflow-y-auto space-y-4 pr-2">
                    <div class="text-center text-slate-600 text-sm py-10">Conversation will appear here...</div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        const WORKER_URL = "https://divine-meadow-322b.simpaticohrconsultancy.workers.dev"; // Your Worker
        let isSessionActive = false;
        let mediaRecorder;
        let audioChunks = [];
        let audioContext, analyser, microphone, silenceTimer;
        
        // Settings for Silence Detection
        const SILENCE_THRESHOLD = 15; // Lower = more sensitive
        const SILENCE_DURATION = 1500; // 1.5 seconds of silence triggers send

        // --- 1. SESSION CONTROL ---
        
        async function toggleSession() {
            if (isSessionActive) {
                endSession();
            } else {
                startSession();
            }
        }

        async function startSession() {
            isSessionActive = true;
            updateStatus('listening');
            
            // Initial Greeting
            addMessage("System", "Session started. I'm listening...", "system");
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupAudioAnalysis(stream);
                startRecording(stream);
            } catch (e) {
                alert("Microphone access required.");
                endSession();
            }
        }

        function endSession() {
            isSessionActive = false;
            if (mediaRecorder) mediaRecorder.stop();
            if (audioContext) audioContext.close();
            clearTimeout(silenceTimer);
            updateStatus('idle');
            window.speechSynthesis.cancel(); // Stop AI talking
        }

        // --- 2. RECORDING & VAD (Silence Detection) ---

        function startRecording(stream) {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            
            mediaRecorder.onstop = async () => {
                if (!isSessionActive) return; // Don't process if stopped manually
                
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                await processAudio(audioBlob);
            };

            mediaRecorder.start();
        }

        function setupAudioAnalysis(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            let silenceStart = Date.now();

            function checkSilence() {
                if (!isSessionActive || document.getElementById('status-pill').innerText.includes('Speaking')) {
                    requestAnimationFrame(checkSilence);
                    return;
                }

                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i = 0; i < bufferLength; i++) sum += dataArray[i];
                let average = sum / bufferLength;

                // Visual Glow based on volume
                const micBtn = document.getElementById('micBtn');
                if (average > 5) {
                    micBtn.style.transform = `scale(${1 + average/100})`;
                    silenceStart = Date.now(); // Reset silence timer
                } else {
                    micBtn.style.transform = 'scale(1)';
                }

                // If silent for X seconds, stop recording
                if (Date.now() - silenceStart > SILENCE_DURATION && average < SILENCE_THRESHOLD) {
                    if (mediaRecorder && mediaRecorder.state === "recording") {
                        // Only stop if we actually have some data
                        if (audioChunks.length > 0 || average > 0) { 
                             mediaRecorder.stop(); 
                             updateStatus('processing');
                        }
                    }
                    silenceStart = Date.now(); // Prevent double trigger
                }

                requestAnimationFrame(checkSilence);
            }
            checkSilence();
        }

        // --- 3. API COMMUNICATION ---

        async function processAudio(blob) {
            if (blob.size < 1000) { // Ignore tiny accidental clips
                if(isSessionActive) restartRecording();
                return;
            }

            const fd = new FormData();
            fd.append('audio', blob);
            fd.append('accessCode', localStorage.getItem('career_access_code'));

            try {
                // Step A: Transcribe
                const tRes = await fetch(`${WORKER_URL}/api/transcribe`, { method: 'POST', body: fd });
                const tData = await tRes.json();
                
                if (!tData.transcription || tData.transcription.trim().length < 2) {
                    restartRecording(); // Noise detected, ignore
                    return;
                }

                addMessage("You", tData.transcription, "user");

                // Step B: Get AI Reply
                const aiRes = await fetch(`${WORKER_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: tData.transcription,
                        accessCode: localStorage.getItem('career_access_code')
                    })
                });
                const aiData = await aiRes.json();
                
                addMessage("AI Coach", aiData.response, "ai");
                
                // Step C: Speak & Restart
                speak(aiData.response);

            } catch (e) {
                console.error(e);
                restartRecording();
            }
        }

        // --- 4. TEXT TO SPEECH ---

        function speak(text) {
            updateStatus('speaking');
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Select a good voice
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => v.name.includes('Google US English') || v.lang === 'en-US');
            if (preferredVoice) utterance.voice = preferredVoice;

            utterance.rate = 1.0;
            utterance.onend = () => {
                setTimeout(restartRecording, 500); // Give user a breath before listening again
            };
            
            window.speechSynthesis.speak(utterance);
        }

        function restartRecording() {
            if (!isSessionActive) return;
            updateStatus('listening');
            if (mediaRecorder && mediaRecorder.state === "inactive") {
                mediaRecorder.start();
            }
        }

        // --- 5. UI UTILS ---

        function updateStatus(state) {
            const pill = document.getElementById('status-pill');
            const dot = pill.querySelector('span');
            const btn = document.getElementById('micBtn');
            const glow = document.getElementById('glow-bg');

            // Reset classes
            btn.className = "relative z-10 w-32 h-32 rounded-full flex items-center justify-center transition-all duration-300";

            if (state === 'listening') {
                pill.innerHTML = '<span class="w-2 h-2 rounded-full bg-indigo-400 animate-pulse"></span> Listening...';
                btn.classList.add('bg-indigo-600', 'listening-ring', 'text-white');
                glow.classList.add('opacity-100');
            } else if (state === 'processing') {
                pill.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-400 animate-bounce"></span> Thinking...';
                btn.classList.add('bg-slate-700', 'border', 'border-yellow-500/30');
                glow.classList.remove('opacity-100');
            } else if (state === 'speaking') {
                pill.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> AI Speaking...';
                btn.classList.add('bg-green-600', 'speaking-ring', 'text-white');
                glow.classList.remove('opacity-100');
            } else {
                pill.innerHTML = '<span class="w-2 h-2 rounded-full bg-slate-500"></span> Tap to Start';
                btn.classList.add('bg-slate-800', 'border', 'border-slate-600', 'hover:scale-105');
                glow.classList.remove('opacity-100');
            }
        }

        function addMessage(sender, text, type) {
            const box = document.getElementById('chat-box');
            // Clear initial message
            if (box.children[0]?.innerText.includes('Conversation will appear')) box.innerHTML = '';

            const div = document.createElement('div');
            div.className = `p-4 rounded-2xl text-sm leading-relaxed animate-fade-in ${
                type === 'user' ? 'bg-indigo-500/10 border border-indigo-500/20 ml-8' : 
                type === 'ai' ? 'bg-green-500/10 border border-green-500/20 mr-8' :
                'text-center text-slate-500 text-xs italic'
            }`;
            div.innerHTML = `<strong class="${type === 'user' ? 'text-indigo-400' : 'text-green-400'} block mb-1">${sender}</strong>${text}`;
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
