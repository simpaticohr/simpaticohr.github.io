<script>
let audioContext, processor, input, stream;
let audioData = [];

const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

async function startRecording() {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioContext = new AudioContext({ sampleRate: 16000 });

  input = audioContext.createMediaStreamSource(stream);
  processor = audioContext.createScriptProcessor(4096, 1, 1);

  processor.onaudioprocess = e => {
    audioData.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };

  input.connect(processor);
  processor.connect(audioContext.destination);

  setTimeout(stopRecording, 5000);
}

async function stopRecording() {
  processor.disconnect();
  input.disconnect();
  stream.getTracks().forEach(t => t.stop());

  const wavBlob = encodeWAV(audioData, audioContext.sampleRate);

  await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "audio/wav" },
    body: wavBlob
  });
}

function encodeWAV(buffers, sampleRate) {
  const length = buffers.reduce((a, b) => a + b.length, 0);
  const data = new Float32Array(length);
  let offset = 0;

  buffers.forEach(b => {
    data.set(b, offset);
    offset += b.length;
  });

  const buffer = new ArrayBuffer(44 + data.length * 2);
  const view = new DataView(buffer);

  function writeString(v, o, s) {
    for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i));
  }

  writeString(view, 0, "RIFF");
  view.setUint32(4, 36 + data.length * 2, true);
  writeString(view, 8, "WAVE");
  writeString(view, 12, "fmt ");
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(view, 36, "data");
  view.setUint32(40, data.length * 2, true);

  let index = 44;
  data.forEach(s => {
    view.setInt16(index, Math.max(-1, Math.min(1, s)) * 0x7fff, true);
    index += 2;
  });

  return new Blob([view], { type: "audio/wav" });
}
</script>
