<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakAI - Spoken English Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .recording-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .message-user {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .message-ai {
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Header -->
    <nav class="glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-2 rounded-xl">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                            SpeakAI Pro
                        </h1>
                        <p class="text-xs text-slate-400">Master English with AI</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="glass px-4 py-2 rounded-lg">
                        <span class="text-yellow-400">üî•</span>
                        <span class="text-sm font-semibold ml-2" id="streak">7 Day Streak</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <span class="text-2xl">‚è±Ô∏è</span>
                    </div>
                </div>
                <p class="text-sm text-slate-400 mb-1">Practice Time</p>
                <p class="text-2xl font-bold">342 min</p>
            </div>
            
            <div class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                        <span class="text-2xl">üéØ</span>
                    </div>
                </div>
                <p class="text-sm text-slate-400 mb-1">Accuracy Rate</p>
                <p class="text-2xl font-bold">87%</p>
            </div>
            
            <div class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <span class="text-2xl">üìà</span>
                    </div>
                </div>
                <p class="text-sm text-slate-400 mb-1">Weekly Progress</p>
                <p class="text-2xl font-bold">12 hrs</p>
            </div>
            
            <div class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                        <span class="text-2xl">‚ú®</span>
                    </div>
                </div>
                <p class="text-sm text-slate-400 mb-1">Level</p>
                <p class="text-2xl font-bold">Intermediate</p>
            </div>
        </div>

        <!-- Practice Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recording Panel -->
            <div class="glass rounded-2xl p-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    üé§ Voice Practice
                </h2>

                <!-- Recording Button -->
                <div class="flex flex-col items-center justify-center py-12 space-y-6">
                    <button id="recordBtn" onclick="toggleRecording()" 
                            class="w-32 h-32 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 shadow-2xl shadow-blue-500/50 flex items-center justify-center transition-all transform hover:scale-105">
                        <svg id="micIcon" class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </button>
                    
                    <div class="text-center">
                        <p id="statusText" class="text-lg font-semibold">Click to start speaking</p>
                        <p class="text-sm text-slate-400 mt-2">Powered by Whisper AI & Llama 3.3 70B</p>
                    </div>
                </div>

                <!-- Transcription Display -->
                <div id="transcriptionBox" class="hidden mt-6 p-6 bg-blue-500/10 border border-blue-500/30 rounded-xl">
                    <h3 class="text-sm font-semibold text-blue-400 mb-2">You said:</h3>
                    <p id="transcriptionText" class="text-lg"></p>
                </div>

                <!-- Score Display -->
                <div id="scoreBox" class="hidden mt-6 p-6 bg-gradient-to-r from-green-500/10 to-blue-500/10 border border-green-500/30 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-green-400">Pronunciation Score</h3>
                        <div id="scoreValue" class="text-3xl font-bold text-green-400">0%</div>
                    </div>
                    <div class="w-full bg-white/10 rounded-full h-3">
                        <div id="scoreBar" class="bg-gradient-to-r from-green-500 to-blue-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- AI Response Panel -->
            <div class="glass rounded-2xl p-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    üí¨ AI Feedback
                </h2>

                <div id="chatHistory" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                    <div class="text-center py-12 text-slate-400">
                        <span class="text-6xl mb-4 block">‚ú®</span>
                        <p>Start speaking to get instant AI feedback!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Practice Scenarios -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold mb-6">Practice Scenarios</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="scenarios">
                <!-- Scenarios will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://divine-meadow-322b.simpaticohrconsultancy.workers.dev';
        
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let conversationHistory = [];

        // Practice scenarios
        const scenarios = [
            { id: 1, title: 'Job Interview', icon: 'üíº', difficulty: 'Advanced', category: 'Business' },
            { id: 2, title: 'Ordering at Restaurant', icon: 'üçΩÔ∏è', difficulty: 'Beginner', category: 'Daily Life' },
            { id: 3, title: 'Airport Check-in', icon: '‚úàÔ∏è', difficulty: 'Intermediate', category: 'Travel' },
            { id: 4, title: 'Phone Conversation', icon: 'üì±', difficulty: 'Intermediate', category: 'Business' },
            { id: 5, title: 'Meeting New People', icon: 'üëã', difficulty: 'Beginner', category: 'Social' },
            { id: 6, title: 'Presentation Skills', icon: 'üìä', difficulty: 'Advanced', category: 'Business' },
        ];

        // Load scenarios
        function loadScenarios() {
            const container = document.getElementById('scenarios');
            container.innerHTML = scenarios.map(s => `
                <div class="glass rounded-2xl p-6 hover:bg-white/10 transition-all cursor-pointer">
                    <div class="text-4xl mb-4">${s.icon}</div>
                    <h3 class="text-xl font-bold mb-2">${s.title}</h3>
                    <div class="flex items-center gap-2 mb-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                            s.difficulty === 'Beginner' ? 'bg-green-500/20 text-green-400' :
                            s.difficulty === 'Intermediate' ? 'bg-yellow-500/20 text-yellow-400' :
                            'bg-red-500/20 text-red-400'
                        }">${s.difficulty}</span>
                        <span class="px-3 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">${s.category}</span>
                    </div>
                    <button class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl font-semibold hover:shadow-lg hover:shadow-blue-500/50 transition-all">
                        Start Practice
                    </button>
                </div>
            `).join('');
        }

        // Toggle recording
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                document.getElementById('recordBtn').classList.add('recording-pulse', 'from-red-500', 'to-pink-500');
                document.getElementById('recordBtn').classList.remove('from-blue-500', 'to-purple-500');
                document.getElementById('statusText').textContent = 'Recording... Click to stop';
                document.getElementById('micIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>';
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Unable to access microphone. Please grant permission.');
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Update UI
                document.getElementById('recordBtn').classList.remove('recording-pulse', 'from-red-500', 'to-pink-500');
                document.getElementById('recordBtn').classList.add('from-blue-500', 'to-purple-500');
                document.getElementById('statusText').textContent = 'Processing...';
                document.getElementById('micIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>';
            }
        }

        // Transcribe audio using Whisper
        async function transcribeAudio(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob);

                const response = await fetch(`${API_BASE}/api/transcribe`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    displayTranscription(data.transcription);
                    await getAIResponse(data.transcription);
                } else {
                    alert('Transcription failed: ' + data.error);
                }
                
                document.getElementById('statusText').textContent = 'Click to start speaking';
                
            } catch (error) {
                console.error('Transcription error:', error);
                alert('Error transcribing audio: ' + error.message);
                document.getElementById('statusText').textContent = 'Click to start speaking';
            }
        }

        // Display transcription
        function displayTranscription(text) {
            document.getElementById('transcriptionBox').classList.remove('hidden');
            document.getElementById('transcriptionText').textContent = text;
        }

        // Get AI response using Llama 3.3 70B
        async function getAIResponse(userMessage) {
            try {
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: userMessage,
                        context: conversationHistory.slice(-6),
                        mode: 'conversation'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    conversationHistory.push(
                        { role: 'user', content: userMessage },
                        { role: 'assistant', content: data.response }
                    );
                    displayConversation();
                    
                    // Simulate score (in production, call analyze-pronunciation endpoint)
                    const score = Math.floor(Math.random() * 30) + 70; // 70-100
                    displayScore(score);
                }
                
            } catch (error) {
                console.error('AI response error:', error);
                alert('Error getting AI response: ' + error.message);
            }
        }

        // Display conversation
        function displayConversation() {
            const container = document.getElementById('chatHistory');
            container.innerHTML = conversationHistory.map(msg => `
                <div class="${msg.role === 'user' ? 'message-user ml-8' : 'message-ai mr-8'} p-4 rounded-xl">
                    <p class="text-sm font-semibold mb-2 text-slate-400">${msg.role === 'user' ? 'You' : 'AI Coach'}</p>
                    <p class="leading-relaxed">${msg.content}</p>
                </div>
            `).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Display score
        function displayScore(score) {
            document.getElementById('scoreBox').classList.remove('hidden');
            document.getElementById('scoreValue').textContent = score + '%';
            document.getElementById('scoreBar').style.width = score + '%';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadScenarios();
        });
    </script>
</body>
</html>
