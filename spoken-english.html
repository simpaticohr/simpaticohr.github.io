<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spoken English Practice | SimpaticoHR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      margin: 0;
      height: 100vh;
      background: radial-gradient(circle at top, #0f172a, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
    }

    .card {
      width: 320px;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      text-align: center;
    }

    h2 {
      margin: 0 0 6px;
      font-size: 20px;
    }

    .status {
      font-size: 13px;
      color: #93c5fd;
      min-height: 18px;
      margin-bottom: 12px;
    }

    button {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    #startBtn {
      background: #2563eb;
      color: white;
    }

    #stopBtn {
      margin-top: 8px;
      background: #334155;
      color: #cbd5f5;
      display: none;
    }

    .result {
      margin-top: 14px;
      text-align: left;
      font-size: 13px;
      display: none;
    }

    .label {
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .box {
      background: rgba(2, 6, 23, 0.6);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
    }

    .score {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin-top: 6px;
    }

    .error {
      color: #f87171;
      margin-top: 8px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>Spoken English Practice</h2>
    <div id="status" class="status">Ready</div>

    <button id="startBtn">ðŸŽ¤ Start Speaking</button>
    <button id="stopBtn">Stop</button>

    <div id="error" class="error"></div>

    <div id="result" class="result">
      <div class="label">You said:</div>
      <div id="transcript" class="box"></div>

      <div class="label">Feedback:</div>
      <div id="feedback" class="box"></div>

      <div id="score" class="score"></div>
    </div>
  </div>

  <script>
    // ðŸ”´ MUST MATCH YOUR WORKER EXACTLY
    const WORKER_URL =
      "https://evalis-ai.simpaticohhrconsultancy.workers.dev";

    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const resultEl = document.getElementById("result");
    const transcriptEl = document.getElementById("transcript");
    const feedbackEl = document.getElementById("feedback");
    const scoreEl = document.getElementById("score");

    startBtn.onclick = async () => {
      errorEl.textContent = "";
      resultEl.style.display = "none";

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream, {
          mimeType: "audio/webm"
        });

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) audioChunks.push(e.data);
        };

        mediaRecorder.onstop = sendAudio;

        mediaRecorder.start();
        statusEl.textContent = "Listeningâ€¦ Speak clearly (5â€“10 sec)";
        startBtn.disabled = true;
        stopBtn.style.display = "block";
      } catch (err) {
        errorEl.textContent = "Microphone permission denied.";
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      startBtn.disabled = false;
      stopBtn.style.display = "none";
      statusEl.textContent = "Processingâ€¦";
    };

    async function sendAudio() {
      try {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "speech.webm");

        const res = await fetch(WORKER_URL, {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("Server unavailable");

        const data = await res.json();

        transcriptEl.textContent = data.transcript || "-";
        feedbackEl.textContent = data.feedback || "-";
        scoreEl.textContent = `${data.score || 0}/10`;

        resultEl.style.display = "block";
        statusEl.textContent = "Completed";
      } catch (err) {
        statusEl.textContent = "Error";
        errorEl.textContent = "Server unavailable.";
      }
    }
  </script>
</body>
</html>
