<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spoken English Practice</title>
<style>
  body {
    margin: 0;
    height: 100vh;
    background: radial-gradient(circle at top, #0b1f4b, #020617);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: system-ui, sans-serif;
    color: #fff;
  }
  .card {
    width: 320px;
    background: rgba(255,255,255,0.06);
    border-radius: 14px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,.4);
  }
  button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    margin-top: 10px;
    cursor: pointer;
  }
  .start { background: #2563eb; color: #fff; }
  .stop { background: #374151; color: #9ca3af; }
  .status { margin: 8px 0; font-size: 13px; color: #93c5fd; }
  .box {
    background: rgba(0,0,0,.35);
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    margin-top: 10px;
    text-align: left;
  }
  .score {
    text-align: center;
    font-size: 20px;
    margin-top: 8px;
    color: #22c55e;
  }
</style>
</head>
<body>

<div class="card">
  <h3>Spoken English Practice</h3>
  <div class="status" id="status">Press start and speak (7 sec)</div>

  <button class="start" id="startBtn">ðŸŽ¤ Start Speaking</button>
  <button class="stop" id="stopBtn" disabled>Stop</button>

  <div class="box" id="said"></div>
  <div class="box" id="feedback"></div>
  <div class="score" id="score"></div>
</div>

<script>
let recorder, chunks = [], stream;

const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const saidEl   = document.getElementById("said");
const feedEl   = document.getElementById("feedback");
const scoreEl  = document.getElementById("score");

startBtn.onclick = async () => {
  resetUI();
  statusEl.textContent = "Listeningâ€¦ speak clearly";

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  recorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
  chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = processAudio;

  recorder.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;

  setTimeout(() => {
    if (recorder && recorder.state === "recording") recorder.stop();
  }, 7000);
};

stopBtn.onclick = () => recorder && recorder.stop();

async function processAudio() {
  stopBtn.disabled = true;
  statusEl.textContent = "Processingâ€¦";

  stream.getTracks().forEach(t => t.stop());

  if (!chunks.length) {
    statusEl.textContent = "No speech detected";
    return;
  }

  const blob = new Blob(chunks, { type: "audio/webm" });
  const form = new FormData();
  form.append("audio", blob);

  try {
    const res = await fetch(
      "https://evalis-ai.simpaticohhrconsultancy.workers.dev/evaluate",
      { method: "POST", body: form }
    );

    const data = await res.json();

    saidEl.textContent = "You said: " + data.text;
    feedEl.textContent = "Feedback: " + data.feedback;
    scoreEl.textContent = data.score + " / 10";
    statusEl.textContent = "Completed";

  } catch {
    statusEl.textContent = "Server error";
  }

  startBtn.disabled = false;
}

function resetUI() {
  saidEl.textContent = "";
  feedEl.textContent = "";
  scoreEl.textContent = "";
}
</script>

</body>
</html>
