<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Spoken English Practice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #0b1d3a, #020617);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  color: #fff;
}
.card {
  width: 280px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(12px);
  border-radius: 14px;
  padding: 18px;
  text-align: center;
}
button {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 8px;
  margin-top: 8px;
  font-size: 14px;
}
.start { background:#2563eb; color:#fff; }
.stop { background:#374151; color:#ccc; }
small { color:#cbd5f5; }
pre {
  text-align:left;
  white-space:pre-wrap;
  font-size:12px;
}
.score {
  font-size:22px;
  margin-top:8px;
}
</style>
</head>

<body>
<div class="card">
  <h3>Spoken English Practice</h3>
  <small id="status">Tap start and speak</small>

  <button class="start" id="start">ðŸŽ¤ Start Speaking</button>
  <button class="stop" id="stop" disabled>Stop</button>

  <pre id="said"></pre>
  <pre id="feedback"></pre>
  <div class="score" id="score"></div>
</div>

<script>
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

let recorder, audioChunks = [];

const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const status = document.getElementById("status");
const said = document.getElementById("said");
const feedback = document.getElementById("feedback");
const scoreBox = document.getElementById("score");

startBtn.onclick = async () => {
  audioChunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  recorder = new MediaRecorder(stream);
  recorder.ondataavailable = e => audioChunks.push(e.data);
  recorder.start();
  status.textContent = "Listening...";
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = async () => {
  recorder.stop();
  status.textContent = "Processing...";
  stopBtn.disabled = true;

  recorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
    const form = new FormData();
    form.append("audio", audioBlob, "speech.webm");

    try {
      const res = await fetch(API, { method: "POST", body: form });
      const data = await res.json();

      said.textContent = "You said:\n" + (data.transcript || "");
      feedback.textContent = "Feedback:\n" + (data.feedback || "");
      scoreBox.textContent = data.score + " / 10";
      status.textContent = "Completed";
    } catch {
      feedback.textContent = "Feedback:\nServer error";
      scoreBox.textContent = "0 / 10";
      status.textContent = "Error";
    }

    startBtn.disabled = false;
  };
};
</script>
</body>
</html>
