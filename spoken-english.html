<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spoken English Practice | SimpaticoHR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont; }

    body {
      margin: 0;
      height: 100vh;
      background: radial-gradient(circle at top, #0f1c3f, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
    }

    .card {
      width: 92%;
      max-width: 360px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 25px 60px rgba(0,0,0,.6);
      text-align: center;
    }

    h2 { margin: 0 0 6px; font-size: 20px; }
    .status { font-size: 13px; color: #93c5fd; min-height: 18px; }

    button {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      margin-top: 14px;
      font-size: 15px;
      cursor: pointer;
    }

    .start {
      background: #2563eb;
      color: white;
    }

    .stop {
      background: #374151;
      color: #d1d5db;
    }

    .result {
      margin-top: 14px;
      text-align: left;
      font-size: 13px;
      color: #d1d5db;
    }

    .score {
      margin-top: 10px;
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      color: #22c55e;
    }

    .error { color: #f87171; }
  </style>
</head>

<body>
  <div class="card">
    <h2>Spoken English Practice</h2>
    <div id="status" class="status">Tap start and speak (5â€“10 sec)</div>

    <button id="startBtn" class="start">ðŸŽ¤ Start Speaking</button>
    <button id="stopBtn" class="stop" disabled>Stop</button>

    <div id="result" class="result"></div>
    <div id="score" class="score"></div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const API_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev/evaluate";

/* ---------- STATE ---------- */
let recognition;
let finalTranscript = "";
let listening = false;

/* ---------- INIT ---------- */
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");
const scoreEl = document.getElementById("score");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

/* ---------- SUPPORT CHECK ---------- */
window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!window.SpeechRecognition) {
  statusEl.innerHTML = "<span class='error'>Speech recognition not supported on this browser.</span>";
  startBtn.disabled = true;
}

/* ---------- SETUP ---------- */
function setupRecognition() {
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = () => {
    listening = true;
    finalTranscript = "";
    statusEl.textContent = "Listeningâ€¦ Speak clearly";
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };

  recognition.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const text = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += text + " ";
      } else {
        interim += text;
      }
    }
    resultEl.innerHTML = `<strong>You said:</strong><br>${finalTranscript}<em>${interim}</em>`;
  };

  recognition.onerror = (e) => {
    statusEl.innerHTML = "<span class='error'>Mic error. Check permission.</span>";
    resetUI();
  };

  recognition.onend = () => {
    if (listening) evaluateSpeech();
  };
}

/* ---------- CONTROLS ---------- */
startBtn.onclick = () => {
  setupRecognition();
  recognition.start();
};

stopBtn.onclick = () => {
  listening = false;
  recognition.stop();
  statusEl.textContent = "Processingâ€¦";
};

/* ---------- AI EVALUATION ---------- */
async function evaluateSpeech() {
  stopBtn.disabled = true;

  if (!finalTranscript.trim()) {
    statusEl.innerHTML = "<span class='error'>No speech detected.</span>";
    resetUI();
    return;
  }

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ transcript: finalTranscript.trim() })
    });

    if (!res.ok) throw new Error("Server error");

    const data = await res.json();

    statusEl.textContent = "Completed";
    resultEl.innerHTML = `<strong>Feedback:</strong><br>${data.feedback}`;
    scoreEl.textContent = `${data.score}/10`;

  } catch (err) {
    statusEl.innerHTML = "<span class='error'>Server unavailable.</span>";
  } finally {
    resetUI(false);
  }
}

/* ---------- RESET ---------- */
function resetUI(clear = true) {
  listening = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  if (clear) {
    resultEl.innerHTML = "";
    scoreEl.textContent = "";
  }
}
</script>
</body>
</html>
