<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin — SimpaticoHR</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#0D1117;--sidebar:#0A0E1A;--card:#161B26;--border:#21262D;
      --accent:#F59E0B;--red:#EF4444;--green:#10B981;--blue:#3B82F6;
      --text:#E6EDF3;--muted:#8B949E;--hover:rgba(255,255,255,.05);
    }
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:256px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:50}
    .sidebar-header{padding:22px 20px;border-bottom:1px solid var(--border)}
    .logo{font-size:1.25rem;font-weight:800;color:#fff}
    .logo span{color:var(--accent)}
    .role-badge{display:inline-flex;align-items:center;gap:5px;margin-top:6px;font-size:11px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.8px;background:rgba(239,68,68,.1);padding:3px 10px;border-radius:20px}
    .nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:2px;overflow-y:auto}
    .nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;color:var(--muted);font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;text-decoration:none;border:none;background:none;width:100%;text-align:left}
    .nav-item:hover{background:var(--hover);color:var(--text)}
    .nav-item.active{background:rgba(239,68,68,.12);color:#fff;font-weight:600}
    .nav-item i{width:18px;text-align:center;font-size:13px}
    .nav-divider{height:1px;background:var(--border);margin:10px 0}
    .sidebar-user{padding:16px 20px;border-top:1px solid var(--border);font-size:13px;color:var(--muted)}
    .sidebar-user strong{display:block;color:var(--text);font-size:14px;margin-bottom:2px}
    .main{margin-left:256px;min-height:100vh}
    .topbar{background:var(--card);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40}
    .topbar-title{font-size:18px;font-weight:700}
    .topbar-right{display:flex;align-items:center;gap:12px}
    .dot-live{width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;display:inline-block}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    .content{padding:24px 28px}
    .stat-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:24px}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;transition:border-color .2s}
    .stat-card:hover{border-color:rgba(245,158,11,.3)}
    .stat-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;margin-bottom:10px}
    .stat-value{font-size:26px;font-weight:800}
    .stat-label{font-size:12px;color:var(--muted);margin-top:2px;font-weight:500}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:20px;overflow:hidden}
    .panel-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
    .panel-title{font-size:15px;font-weight:700}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;padding:12px 18px;text-align:left;border-bottom:1px solid var(--border);background:rgba(255,255,255,.02)}
    td{padding:14px 18px;font-size:14px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
    tr:last-child td{border-bottom:none}
    tr:hover td{background:var(--hover)}
    .badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
    .badge-active{background:rgba(16,185,129,.15);color:#10B981;border:1px solid rgba(16,185,129,.2)}
    .badge-trial{background:rgba(245,158,11,.15);color:var(--accent);border:1px solid rgba(245,158,11,.2)}
    .badge-inactive{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
    .badge-basic{background:rgba(59,130,246,.15);color:#60A5FA;border:1px solid rgba(59,130,246,.2)}
    .badge-premium{background:rgba(168,85,247,.15);color:#C084FC;border:1px solid rgba(168,85,247,.2)}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;border:none;font-family:inherit}
    .btn-primary{background:var(--accent);color:#000}
    .btn-primary:hover{background:#D97706}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-ghost:hover{background:var(--hover)}
    .btn-danger{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.2)}
    .btn-sm{padding:5px 12px;font-size:12px}
    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
    .modal-overlay.open{display:flex}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:28px;width:100%;max-width:540px;max-height:90vh;overflow-y:auto}
    .modal-title{font-size:17px;font-weight:800;margin-bottom:4px}
    .modal-sub{font-size:13px;color:var(--muted);margin-bottom:22px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .form-group{display:flex;flex-direction:column;gap:5px}
    .form-group.full{grid-column:1/-1}
    .form-group label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
    .form-group input,.form-group select{padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none;font-family:inherit;transition:border-color .2s}
    .form-group input:focus,.form-group select:focus{border-color:var(--accent)}
    .form-group select option{background:#161B26}
    .modal-footer{display:flex;gap:10px;margin-top:22px;justify-content:flex-end}
    .search-wrap{position:relative}
    .search-wrap input{padding:8px 12px 8px 34px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;font-family:inherit;width:210px;transition:border-color .2s,width .3s}
    .search-wrap input:focus{border-color:var(--accent);width:270px}
    .search-wrap i{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:12px}
    #toasts{position:fixed;top:20px;right:20px;z-index:999;display:flex;flex-direction:column;gap:8px}
    .toast{background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 18px;border-radius:10px;font-size:13px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:tIn .3s,tOut .3s 2.7s forwards;min-width:260px}
    .toast.success{border-left:3px solid var(--green)}
    .toast.error{border-left:3px solid var(--red)}
    @keyframes tIn{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(110%);opacity:0}}
    .loader-row td{text-align:center;padding:40px;color:var(--muted)}
    .spin{display:inline-block;width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:50px 20px;color:var(--muted)}
    .empty-state i{font-size:36px;opacity:.25;margin-bottom:12px;display:block}
    .actions{display:flex;gap:6px}
    @media(max-width:1024px){.stat-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.content{padding:16px}.stat-grid{grid-template-columns:1fr 1fr}.form-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div id="toasts"></div>

<!-- ADD COMPANY MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-title">➕ Add New Company</div>
    <div class="modal-sub">Registers company + creates admin login</div>
    <div class="form-grid">
      <div class="form-group full"><label>Company Name *</label><input id="f_name" placeholder="Acme Corp"></div>
      <div class="form-group"><label>Admin Name *</label><input id="f_admin_name" placeholder="John Doe"></div>
      <div class="form-group"><label>Admin Email *</label><input id="f_email" type="email" placeholder="admin@company.com"></div>
      <div class="form-group"><label>Admin Phone</label><input id="f_phone" placeholder="+91 98765 43210"></div>
      <div class="form-group"><label>Industry</label><input id="f_industry" placeholder="Technology"></div>
      <div class="form-group"><label>Company Size</label>
        <select id="f_size">
          <option value="">Select size</option>
          <option value="1-10">1–10</option>
          <option value="11-50">11–50</option>
          <option value="51-200">51–200</option>
          <option value="201-500">201–500</option>
          <option value="500+">500+</option>
        </select>
      </div>
      <div class="form-group"><label>Admin Password *</label><input id="f_password" type="password" placeholder="Min 8 characters"></div>
      <div class="form-group"><label>Website</label><input id="f_website" placeholder="https://company.com"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="createBtn" onclick="createCompany()"><i class="fas fa-plus"></i> Create Company</button>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="logo">Simpatico<span>HR</span></div>
    <div class="role-badge"><i class="fas fa-shield-alt"></i> Super Admin</div>
  </div>
  <nav class="nav">
    <a class="nav-item active" id="navDash" onclick="showSection('companies',this)"><i class="fas fa-th-large"></i> Overview</a>
    <a class="nav-item" id="navComp" onclick="showSection('companies',this)"><i class="fas fa-building"></i> Companies</a>
    <a class="nav-item" id="navUsers" onclick="showSection('users',this)"><i class="fas fa-users"></i> All Users</a>
    <div class="nav-divider"></div>
    <a class="nav-item" onclick="alert('Platform config coming soon')"><i class="fas fa-cog"></i> Platform Config</a>
    <div class="nav-divider"></div>
    <a class="nav-item" style="color:rgba(239,68,68,.8)" onclick="signOut()"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
  </nav>
  <div class="sidebar-user">
    <strong id="adminName">Super Admin</strong>
    Full Platform Access
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="pageTitle">Super Admin Dashboard</div>
    <div class="topbar-right">
      <span style="font-size:13px;color:var(--muted)"><span class="dot-live"></span> Live</span>
      <button class="btn btn-primary btn-sm" onclick="showAddModal()"><i class="fas fa-plus"></i> Add Company</button>
    </div>
  </div>

  <div class="content">

    <!-- STATS -->
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(245,158,11,.1);color:var(--accent)"><i class="fas fa-building"></i></div>
        <div class="stat-value" id="sCo">—</div><div class="stat-label">Companies</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(59,130,246,.1);color:#60A5FA"><i class="fas fa-users"></i></div>
        <div class="stat-value" id="sUs">—</div><div class="stat-label">Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(16,185,129,.1);color:var(--green)"><i class="fas fa-briefcase"></i></div>
        <div class="stat-value" id="sJo">—</div><div class="stat-label">Jobs</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(168,85,247,.1);color:#C084FC"><i class="fas fa-file-alt"></i></div>
        <div class="stat-value" id="sAp">—</div><div class="stat-label">Applications</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(239,68,68,.1);color:var(--red)"><i class="fas fa-video"></i></div>
        <div class="stat-value" id="sIn">—</div><div class="stat-label">Interviews</div>
      </div>
    </div>

    <!-- COMPANIES -->
    <div class="panel" id="section-companies">
      <div class="panel-header">
        <div class="panel-title">All Companies</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="search-wrap"><i class="fas fa-search"></i><input id="compSearch" placeholder="Search..." oninput="filterCompanies()"></div>
          <button class="btn btn-primary btn-sm" onclick="showAddModal()"><i class="fas fa-plus"></i> Add Company</button>
          <button class="btn btn-ghost btn-sm" onclick="loadAll()"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Company</th><th>Industry</th><th>Plan</th><th>Subscription End</th><th>Status</th><th>Registered</th><th>Actions</th>
          </tr></thead>
          <tbody id="compTbody"><tr class="loader-row"><td colspan="7"><span class="spin"></span>Loading companies...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- USERS (hidden by default) -->
    <div class="panel" id="section-users" style="display:none">
      <div class="panel-header">
        <div class="panel-title">All Platform Users</div>
        <div style="display:flex;gap:8px">
          <div class="search-wrap"><i class="fas fa-search"></i><input id="userSearch" placeholder="Search..." oninput="filterUsers()"></div>
          <button class="btn btn-ghost btn-sm" onclick="loadUsers()"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Last Login</th></tr></thead>
          <tbody id="usersTbody"><tr class="loader-row"><td colspan="5"><span class="spin"></span>Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
// ═══════════════════════════════════════════════
// CONFIG — Correct API base from worker.js
// ═══════════════════════════════════════════════
const API = 'https://evalis-ai.simpaticohrconsultancy.workers.dev';

// Auth guard
const token = localStorage.getItem('simpatico_token');
if (!token) window.location.href = '../auth/login.html';

const H = {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json'
};

// ═══════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════
function toast(msg, type = '') {
  const c = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

// ═══════════════════════════════════════════════
// NAV
// ═══════════════════════════════════════════════
function showSection(sec, el) {
  document.getElementById('section-companies').style.display = sec === 'companies' ? 'block' : 'none';
  document.getElementById('section-users').style.display = sec === 'users' ? 'block' : 'none';
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (el) el.classList.add('active');
  const titles = { companies: 'All Companies', users: 'All Users' };
  document.getElementById('pageTitle').textContent = titles[sec] || 'Dashboard';
  if (sec === 'users') loadUsers();
}

// ═══════════════════════════════════════════════
// STATS — endpoint: GET /api/admin/stats
// Returns: { total_companies, total_users, total_jobs, total_applications, total_interviews }
// ═══════════════════════════════════════════════
let allCompanies = [];
let allUsers = [];

async function loadAll() {
  try {
    const r = await fetch(`${API}/api/admin/stats`, { headers: H });
    const stats = await r.json();

    if (!r.ok || stats.error) {
      toast('Access denied — super_admin role required', 'error');
      setTimeout(() => { localStorage.clear(); window.location.href = '../auth/login.html'; }, 1500);
      return;
    }

    // Worker returns flat fields: total_companies, total_users, etc.
    document.getElementById('sCo').textContent = stats.total_companies ?? 0;
    document.getElementById('sUs').textContent = stats.total_users ?? 0;
    document.getElementById('sJo').textContent = stats.total_jobs ?? 0;
    document.getElementById('sAp').textContent = stats.total_applications ?? 0;
    document.getElementById('sIn').textContent = stats.total_interviews ?? 0;
  } catch(e) {
    toast('Stats error: ' + e.message, 'error');
  }

  await loadCompanies();
}

// ═══════════════════════════════════════════════
// COMPANIES — endpoint: GET /api/admin/companies
// Returns: array of company objects from Supabase
// ═══════════════════════════════════════════════
async function loadCompanies() {
  document.getElementById('compTbody').innerHTML = `<tr class="loader-row"><td colspan="7"><span class="spin"></span>Loading...</td></tr>`;
  try {
    const r = await fetch(`${API}/api/admin/companies`, { headers: H });
    const data = await r.json();

    // Worker returns raw Supabase array
    allCompanies = Array.isArray(data) ? data : (data.companies || []);

    if (!allCompanies.length) {
      document.getElementById('compTbody').innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-building"></i>No companies registered yet<br><br><button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="showAddModal()"><i class="fas fa-plus"></i> Add First Company</button></div></td></tr>`;
      return;
    }
    renderCompanies(allCompanies);
  } catch(e) {
    document.getElementById('compTbody').innerHTML = `<tr class="loader-row"><td colspan="7" style="color:var(--red)">Error: ${e.message}</td></tr>`;
  }
}

function renderCompanies(list) {
  if (!list.length) {
    document.getElementById('compTbody').innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-search"></i>No results</div></td></tr>`;
    return;
  }
  document.getElementById('compTbody').innerHTML = list.map(c => {
    const plan = c.subscription_plan || 'trial';
    const isActive = c.is_active !== false;
    const subEnd = c.subscription_end ? new Date(c.subscription_end).toLocaleDateString('en-IN') : '—';
    const created = c.created_at ? new Date(c.created_at).toLocaleDateString('en-IN') : '—';
    return `<tr>
      <td>
        <div style="font-weight:600">${esc(c.name || '—')}</div>
        <div style="font-size:12px;color:var(--muted)">${esc(c.contact_email || '')}</div>
      </td>
      <td style="font-size:13px;color:var(--muted)">${esc(c.industry || '—')}</td>
      <td><span class="badge badge-${plan === 'trial' ? 'trial' : plan === 'basic' ? 'basic' : plan === 'premium' ? 'premium' : 'active'}">${plan.toUpperCase()}</span></td>
      <td style="font-size:13px">${subEnd}</td>
      <td><span class="badge ${isActive ? 'badge-active' : 'badge-inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
      <td style="font-size:12px;color:var(--muted)">${created}</td>
      <td><div class="actions">
        <button class="btn btn-danger btn-sm" title="Disable" onclick="toast('Direct disable coming soon','')"><i class="fas fa-ban"></i></button>
      </div></td>
    </tr>`;
  }).join('');
}

function filterCompanies() {
  const q = document.getElementById('compSearch').value.toLowerCase();
  renderCompanies(allCompanies.filter(c =>
    `${c.name} ${c.contact_email} ${c.industry} ${c.subscription_plan}`.toLowerCase().includes(q)
  ));
}

// ═══════════════════════════════════════════════
// USERS — no dedicated admin users endpoint in this worker
// We fetch from Supabase directly via /db proxy or list from companies
// ═══════════════════════════════════════════════
async function loadUsers() {
  document.getElementById('usersTbody').innerHTML = `<tr class="loader-row"><td colspan="5"><span class="spin"></span>Loading...</td></tr>`;
  try {
    // Worker doesn't have /api/admin/users — use analytics or notify user
    const r = await fetch(`${API}/api/admin/companies`, { headers: H });
    const companies = await r.json();
    const list = Array.isArray(companies) ? companies : [];

    if (!list.length) {
      document.getElementById('usersTbody').innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fas fa-users"></i>No companies / users yet</div></td></tr>`;
      return;
    }

    // Show company admins (contact_email from companies table)
    document.getElementById('usersTbody').innerHTML = list.map(c => `<tr>
      <td style="font-weight:600">${esc(c.name || '—')}</td>
      <td style="font-size:13px;color:var(--muted)">${esc(c.contact_email || '—')}</td>
      <td><span class="badge badge-basic">company_admin</span></td>
      <td>${esc(c.name || '—')}</td>
      <td style="font-size:12px;color:var(--muted)">${c.created_at ? new Date(c.created_at).toLocaleDateString('en-IN') : '—'}</td>
    </tr>`).join('');
  } catch(e) {
    document.getElementById('usersTbody').innerHTML = `<tr class="loader-row"><td colspan="5" style="color:var(--red)">Error: ${e.message}</td></tr>`;
  }
}

// ═══════════════════════════════════════════════
// ADD COMPANY — POST /api/auth/register-company
// Worker expects: { admin: { name, email, password, phone }, company: { name, industry, size, website } }
// ═══════════════════════════════════════════════
function showAddModal() { document.getElementById('addModal').classList.add('open'); }
function closeModal() { document.getElementById('addModal').classList.remove('open'); }

async function createCompany() {
  const name     = document.getElementById('f_name').value.trim();
  const adminName = document.getElementById('f_admin_name').value.trim();
  const email    = document.getElementById('f_email').value.trim();
  const phone    = document.getElementById('f_phone').value.trim();
  const password = document.getElementById('f_password').value.trim();
  const industry = document.getElementById('f_industry').value.trim();
  const size     = document.getElementById('f_size').value;
  const website  = document.getElementById('f_website').value.trim();

  if (!name)     { toast('Company name is required', 'error'); return; }
  if (!email)    { toast('Admin email is required', 'error'); return; }
  if (!password || password.length < 8) { toast('Password must be 8+ characters', 'error'); return; }
  if (!adminName) { toast('Admin name is required', 'error'); return; }

  const btn = document.getElementById('createBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin" style="border-top-color:#000;width:16px;height:16px"></span> Creating...';

  try {
    // Uses /api/auth/register-company endpoint from worker
    const r = await fetch(`${API}/api/auth/register-company`, {
      method: 'POST',
      headers: H,
      body: JSON.stringify({
        admin: { name: adminName, email, password, phone },
        company: { name, industry, size, website }
      })
    });
    const data = await r.json();
    if (!r.ok || data.error) throw new Error(data.error || 'Registration failed');

    toast(`✅ ${name} created successfully!`, 'success');
    closeModal();

    // Clear form
    ['f_name','f_admin_name','f_email','f_phone','f_password','f_industry','f_website'].forEach(id => {
      document.getElementById(id).value = '';
    });
    document.getElementById('f_size').value = '';

    // Show login credentials
    alert(`✅ Company "${name}" registered!\n\nLogin credentials:\nEmail: ${email}\nPassword: ${password}\n\n⚠️ Share this with the company admin.`);

    await loadAll();
  } catch(e) {
    if (e.message.toLowerCase().includes('already') || e.message.toLowerCase().includes('exist')) {
      toast('Email already registered', 'error');
    } else {
      toast('Error: ' + e.message, 'error');
    }
  }

  btn.disabled = false;
  btn.innerHTML = '<i class="fas fa-plus"></i> Create Company';
}

// ═══════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════
function esc(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function signOut() {
  if (confirm('Sign out of super admin?')) {
    localStorage.clear();
    window.location.href = '../auth/login.html';
  }
}

// Set admin name from localStorage
try {
  const u = JSON.parse(localStorage.getItem('simpatico_user') || '{}');
  document.getElementById('adminName').textContent = u.full_name || u.name || 'Super Admin';
} catch(e) {}

// INIT
loadAll();
</script>
</body>
</html>
