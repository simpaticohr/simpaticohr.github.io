<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin | Simpatico HR</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#020617;--card:rgba(15,23,42,.65);--border:rgba(255,255,255,.08);--accent:#6366f1;--accent2:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;--text:#f8fafc;--muted:#94a3b8;--glow:rgba(99,102,241,.15)}
    body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:radial-gradient(circle at 10% 20%,rgba(99,102,241,.15),transparent 40%),radial-gradient(circle at 90% 80%,rgba(79,70,229,.1),transparent 40%),var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
    .top-nav{backdrop-filter:blur(16px);background:rgba(2,6,23,.85);padding:1rem 6%;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .top-logo{font-weight:800;font-size:1.1rem;color:#fff;text-decoration:none}.top-logo span{color:var(--accent)}
    .top-links{display:flex;gap:12px;align-items:center}
    .top-link{color:var(--muted);text-decoration:none;font-size:12px;font-weight:600;padding:6px 12px;border-radius:8px;transition:all 0.2s}
    .top-link:hover{color:#fff;background:rgba(255,255,255,.05)}
    .container{max-width:960px;margin:0 auto;padding:20px}
    .login-card{max-width:420px;margin:80px auto;background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px;text-align:center;backdrop-filter:blur(22px)}
    .login-card h1{font-size:1.5rem;margin-bottom:8px;background:linear-gradient(135deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .login-card p{color:var(--muted);font-size:0.88rem;margin-bottom:24px}
    .login-input{width:100%;padding:14px 16px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:1rem;outline:none;font-family:inherit;margin-bottom:16px;text-align:center}
    .login-input:focus{border-color:rgba(245,158,11,.4);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
    .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#f59e0b,#ef4444);border:none;border-radius:14px;color:#fff;font-size:1rem;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.2s}
    .login-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(245,158,11,.3)}
    .login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .login-error{color:var(--red);font-size:0.85rem;margin-top:12px;display:none}
    .login-mode-toggle{margin-top:16px;font-size:.82rem;color:var(--muted)}
    .login-mode-toggle a{color:var(--accent);cursor:pointer;text-decoration:underline}
    .admin-wrap{display:none}
    .admin-header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px;flex-wrap:wrap;gap:10px}
    .admin-header h1{font-size:1.4rem;background:linear-gradient(135deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .admin-header-meta{font-size:.75rem;color:var(--muted)}
    .admin-tabs{display:flex;gap:0;background:rgba(255,255,255,.03);border-radius:14px;padding:4px;border:1px solid var(--border);margin-bottom:20px;flex-wrap:wrap}
    .admin-tab{flex:1;padding:10px 6px;text-align:center;border:none;background:transparent;color:var(--muted);font-size:0.68rem;font-weight:700;cursor:pointer;border-radius:10px;transition:all 0.25s ease;font-family:inherit;min-width:60px;overflow:hidden}
    .admin-tab.active{background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff}
    .admin-tab:hover:not(.active){background:rgba(245,158,11,.1)}
    .card{background:var(--card);backdrop-filter:blur(22px);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
    .card h3{font-size:0.95rem;margin-bottom:14px;display:flex;align-items:center;gap:8px;color:#f59e0b}
    label{display:block;font-size:0.78rem;color:var(--muted);margin:12px 0 4px;font-weight:600}
    select,input[type="text"],input[type="email"],input[type="number"],input[type="password"],input[type="date"],input[type="url"],textarea{width:100%;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;outline:none;transition:border-color 0.2s;font-family:inherit}
    select:focus,input:focus,textarea:focus{border-color:rgba(245,158,11,.4);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
    select option{background:#1e293b}
    textarea{resize:vertical;min-height:60px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
    .stat-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .2s}
    .stat-card:hover{border-color:rgba(99,102,241,.2);transform:translateY(-1px)}
    .stat-num{font-size:1.6rem;font-weight:800}.stat-lbl{font-size:0.7rem;color:var(--muted)}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-size:0.82rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-save{background:linear-gradient(135deg,#10b981,#059669)}.btn-danger{background:rgba(239,68,68,.15);color:var(--red)}.btn-primary{background:linear-gradient(135deg,#f59e0b,#ef4444)}.btn-accent{background:var(--accent)}.btn-full{width:100%;padding:14px;font-size:1rem;border-radius:14px}
    .btn-wa{background:linear-gradient(135deg,#25d366,#128c7e)}.btn-payroll{background:linear-gradient(135deg,#8b5cf6,#6366f1)}.btn-jd{background:linear-gradient(135deg,#ec4899,#8b5cf6)}.btn-onboard{background:linear-gradient(135deg,#06b6d4,#3b82f6)}
    .btn:hover:not(:disabled){transform:translateY(-1px)}
    .status-pill{padding:2px 8px;border-radius:10px;font-size:0.72rem;font-weight:700;display:inline-block}
    .score-badge{padding:2px 8px;border-radius:8px;font-size:0.75rem;font-weight:700;display:inline-block}
    .activity-log{max-height:300px;overflow-y:auto;font-size:0.78rem;color:var(--muted);background:rgba(0,0,0,.3);border-radius:10px;padding:12px}
    .activity-log div{padding:5px 0;border-bottom:1px solid rgba(255,255,255,.03)}
    .edit-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);flex-wrap:wrap}.edit-row:last-child{border-bottom:none}
    .edit-label{font-size:0.8rem;color:var(--muted);min-width:140px;font-weight:600}
    .edit-input{flex:1;padding:8px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;font-family:inherit;outline:none;min-width:200px}
    .edit-input:focus{border-color:rgba(245,158,11,.4)}
    .edit-color{width:40px;height:32px;border:none;border-radius:6px;cursor:pointer;background:transparent}
    .edit-preview{font-size:0.75rem;color:var(--muted);padding:2px 8px;background:rgba(255,255,255,.03);border-radius:6px}
    .toggle-switch{position:relative;width:44px;height:24px;background:rgba(255,255,255,.1);border-radius:12px;cursor:pointer;transition:all 0.3s;flex-shrink:0}
    .toggle-switch.on{background:var(--green)}.toggle-switch::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:all 0.3s}.toggle-switch.on::after{left:23px}
    .pay-table{width:100%;border-collapse:collapse;font-size:0.82rem}.pay-table th{text-align:left;padding:8px;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border);font-size:0.75rem}.pay-table td{padding:8px;border-bottom:1px solid var(--border)}
    .toast-box{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:rgba(15,23,42,.9);backdrop-filter:blur(12px);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:12px;font-size:0.85rem;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:tIn .3s ease,tOut .3s ease 2.7s forwards}
    @keyframes tIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(120%);opacity:0}}
    .hidden{display:none!important}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .token-display{background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:10px;padding:12px;font-family:monospace;font-size:0.82rem;word-break:break-all;margin:8px 0;cursor:pointer;transition:all 0.2s}
    .token-display:hover{border-color:var(--accent);background:rgba(99,102,241,.05)}
    .copy-box{display:flex;gap:8px;align-items:center;margin-top:8px}
    .copy-input{flex:1;padding:8px 12px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-size:0.78rem;font-family:monospace;outline:none}
    .copy-btn{padding:8px 14px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-weight:700;font-size:0.78rem;cursor:pointer;white-space:nowrap}
    .invite-card{background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:16px;margin-bottom:10px}
    .invite-card h4{color:var(--accent);font-size:0.9rem;margin-bottom:6px}
    .cand-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);gap:8px;flex-wrap:wrap}.cand-row:last-child{border-bottom:none}
    .cand-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.8rem;flex-shrink:0}
    .jd-output{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:12px;padding:16px;font-size:0.85rem;line-height:1.8;white-space:pre-wrap;max-height:500px;overflow-y:auto;color:#e2e8f0}
    .wa-preview{background:rgba(0,0,0,.3);border-radius:10px;padding:12px;font-size:0.82rem;line-height:1.7;white-space:pre-wrap;border-left:3px solid #25d366;color:#d1fae5}
    .wa-link-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:linear-gradient(135deg,#25d366,#128c7e);border:none;border-radius:8px;color:#fff;font-weight:700;font-size:0.78rem;cursor:pointer;text-decoration:none;margin-top:8px}
    .wa-template-card{background:rgba(37,211,102,.05);border:1px solid rgba(37,211,102,.15);border-radius:12px;padding:14px;margin-bottom:10px}
    .wa-template-card h4{color:#25d366;font-size:0.88rem;margin-bottom:6px}
    .kanban-board{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;overflow-x:auto;padding-bottom:8px;min-width:0}
    .kanban-col{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:14px;padding:12px;min-height:300px;min-width:150px}
    .kanban-col-header{font-size:0.78rem;font-weight:800;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
    .kanban-badge{background:rgba(255,255,255,.1);border-radius:10px;padding:1px 8px;font-size:0.7rem}
    .k-card{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px;cursor:grab;font-size:0.8rem;transition:all 0.2s}
    .k-card:hover{border-color:rgba(99,102,241,.4);background:rgba(99,102,241,.05)}
    .k-card-name{font-weight:700;margin-bottom:2px}
    .k-card-role{color:var(--muted);font-size:0.72rem}
    .calc-result{background:rgba(16,185,129,.05);border:1px solid rgba(16,185,129,.15);border-radius:10px;padding:14px;margin-top:12px}
    .calc-row{display:flex;justify-content:space-between;padding:5px 0;font-size:0.83rem;border-bottom:1px solid rgba(255,255,255,.04)}
    .calc-row:last-child{border-bottom:none;font-weight:800;color:#10b981;font-size:0.95rem}
    .calc-row.deduct{color:#f87171}
    .payslip-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9998;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
    .payslip-box{background:#fff;color:#000;border-radius:16px;padding:32px;max-width:680px;width:95%;max-height:90vh;overflow-y:auto;font-family:'Plus Jakarta Sans',sans-serif}
    .payslip-header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #6366f1;padding-bottom:16px;margin-bottom:20px}
    .payslip-company{font-size:1.3rem;font-weight:800;color:#6366f1}
    .payslip-table{width:100%;border-collapse:collapse;font-size:0.9rem}
    .payslip-table td{padding:8px 10px;border:1px solid #e2e8f0}
    .payslip-table thead td{background:#f1f5f9;font-weight:700;color:#475569}
    .payslip-total{background:#f0fdf4;font-weight:800;color:#059669}
    .feature-toggle-card{background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.15);border-radius:14px;padding:16px;margin-bottom:10px}
    .feature-toggle-card .ft-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
    .feature-toggle-card .ft-title{font-weight:800;font-size:0.92rem;display:flex;align-items:center;gap:8px}
    .feature-toggle-card .ft-desc{font-size:0.76rem;color:var(--muted);margin-top:4px}
    .ft-badge-on{background:rgba(16,185,129,.15);color:#10b981;padding:2px 10px;border-radius:10px;font-size:0.72rem;font-weight:800}
    .ft-badge-off{background:rgba(239,68,68,.15);color:#ef4444;padding:2px 10px;border-radius:10px;font-size:0.72rem;font-weight:800}
    .onboard-stage{background:rgba(6,182,212,.05);border:1px solid rgba(6,182,212,.15);border-radius:12px;padding:14px;margin-bottom:12px}
    .onboard-stage h4{color:#06b6d4;font-size:0.9rem;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .check-item{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.04)}
    .check-item:last-child{border-bottom:none}
    .check-item input[type="checkbox"]{width:16px;height:16px;cursor:pointer;accent-color:var(--green)}
    .check-item label{margin:0;font-size:0.83rem;cursor:pointer;color:var(--text)}
    .check-item.done label{text-decoration:line-through;color:var(--muted)}
    .progress-bar{height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden;margin:8px 0}
    .progress-fill{height:100%;background:linear-gradient(90deg,#06b6d4,#3b82f6);border-radius:4px;transition:width .5s}
    .client-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:10px;transition:all .2s}
    .client-card:hover{border-color:rgba(99,102,241,.3)}
    .client-card h4{font-size:.95rem;color:var(--accent);margin-bottom:4px}
    .client-meta{font-size:.75rem;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .sync-indicator{display:inline-flex;align-items:center;gap:4px;font-size:.7rem;padding:2px 8px;border-radius:8px}
    .sync-ok{background:rgba(16,185,129,.1);color:#10b981}
    .sync-err{background:rgba(239,68,68,.1);color:#ef4444}
    .sync-pending{background:rgba(245,158,11,.1);color:#f59e0b}
    @media(max-width:768px){
      .stat-grid{grid-template-columns:1fr 1fr}
      .row2,.row3,.row4{grid-template-columns:1fr}
      .edit-row{flex-direction:column;align-items:flex-start}
      .edit-input{width:100%}
      .admin-tab{font-size:0.6rem;min-width:46px;padding:8px 3px}
      .cand-row{flex-direction:column;align-items:flex-start}
      .top-nav{padding:1rem 4%}
      .kanban-board{grid-template-columns:repeat(3,minmax(150px,1fr))}
    }
    @media(max-width:480px){.kanban-board{grid-template-columns:repeat(2,minmax(140px,1fr))}}
    @media print{
      body>*:not(.payslip-modal){display:none!important}
      .payslip-modal{position:static!important;background:none!important}
      .payslip-box{box-shadow:none!important;max-height:none!important}
      button{display:none!important}
    }
  </style>
</head>
<body>
  <div class="toast-box" id="toasts"></div>

  <nav class="top-nav">
    <a class="top-logo" href="/">SIMPATICO <span>HR</span></a>
    <div class="top-links">
      <span id="syncStatus" class="sync-indicator sync-pending">â³ Not connected</span>
      <a class="top-link" href="/">ğŸ  Platform</a>
      <span class="top-link" style="color:var(--yellow);">ğŸ” Admin</span>
    </div>
  </nav>

  <!-- LOGIN -->
  <div id="loginScreen">
    <div class="login-card">
      <div style="font-size:3rem;margin-bottom:12px;">ğŸ”</div>
      <h1>Super Admin</h1>
      <p id="loginSubtext">Login with your admin credentials</p>
      <!-- API Login (default) -->
      <div id="apiLoginForm">
        <input type="email" class="login-input" id="loginEmail" placeholder="admin@simpaticohr.in" style="letter-spacing:normal">
        <input type="password" class="login-input" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
        <button class="login-btn" id="loginBtn" onclick="doLogin()">ğŸ”“ Login via API</button>
      </div>
      <!-- Offline Login -->
      <div id="offlineLoginForm" class="hidden">
        <input type="password" class="login-input" id="offlinePass" placeholder="Offline password" onkeydown="if(event.key==='Enter')doOfflineLogin()" style="letter-spacing:2px">
        <button class="login-btn" onclick="doOfflineLogin()">ğŸ”“ Offline Login</button>
      </div>
      <div class="login-error" id="loginError">âŒ Authentication failed</div>
      <div class="login-mode-toggle">
        <span id="toggleLoginMode"><a onclick="toggleLoginMode()">Switch to offline mode</a></span>
      </div>
      <div style="margin-top:12px;">
        <label style="margin:0;font-size:.72rem;">Worker URL</label>
        <input type="url" class="login-input" id="workerUrlInput" value="" style="font-size:.78rem;letter-spacing:normal;margin-bottom:0;padding:10px" placeholder="https://your-worker.workers.dev">
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="admin-wrap" id="adminWrap">
    <div class="container">
      <div class="admin-header">
        <div>
          <h1>ğŸ” Super Admin Panel</h1>
          <div class="admin-header-meta" id="adminMeta">â€”</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="apiIndicator" class="sync-indicator sync-ok">ğŸŸ¢ API Connected</span>
          <button class="btn btn-danger" onclick="doLogout()">ğŸšª Logout</button>
        </div>
      </div>

      <div class="admin-tabs" id="adminTabs">
        <button class="admin-tab active" onclick="showTab('dashboard')">ğŸ“Š Dash</button>
        <button class="admin-tab" onclick="showTab('clients')">ğŸ¢ Clients</button>
        <button class="admin-tab" onclick="showTab('users')">ğŸ‘¥ Users</button>
        <button class="admin-tab" onclick="showTab('jobs')">ğŸ’¼ Jobs</button>
        <button class="admin-tab" onclick="showTab('applications')">ğŸ“ Apps</button>
        <button class="admin-tab" onclick="showTab('tokens')">ğŸ« Tokens</button>
        <button class="admin-tab" onclick="showTab('jdbuilder')">âœï¸ JD AI</button>
        <button class="admin-tab" onclick="showTab('payroll')">ğŸ’° Payroll</button>
        <button class="admin-tab" onclick="showTab('whatsapp')">ğŸ’¬ WA</button>
        <button class="admin-tab" onclick="showTab('pipeline')">ğŸ”„ Pipe</button>
        <button class="admin-tab" onclick="showTab('settings')">âš™ï¸ Set</button>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-dashboard">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="sClients">0</div><div class="stat-lbl">Clients</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#6366f1;" id="sUsers">0</div><div class="stat-lbl">Users</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="sJobs">0</div><div class="stat-lbl">Jobs</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#3b82f6;" id="sApps">0</div><div class="stat-lbl">Applications</div></div>
        </div>
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#8b5cf6;" id="sActiveClients">0</div><div class="stat-lbl">Active Clients</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#25d366;" id="sEmployees">0</div><div class="stat-lbl">Employees (Local)</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#06b6d4;" id="sJdCount">0</div><div class="stat-lbl">JDs Generated</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#ec4899;" id="sWaSent">0</div><div class="stat-lbl">WA Messages</div></div>
        </div>
        <div class="card">
          <h3>âš¡ Quick Actions</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-save" onclick="showTab('clients')">ğŸ¢ Add Client</button>
            <button class="btn btn-jd" onclick="showTab('jdbuilder')">âœï¸ Generate JD</button>
            <button class="btn btn-wa" onclick="showTab('whatsapp')">ğŸ’¬ WhatsApp</button>
            <button class="btn btn-payroll" onclick="showTab('payroll')">ğŸ’° Payroll</button>
            <button class="btn btn-accent" onclick="showTab('tokens')">ğŸ« Token</button>
            <button class="btn" style="background:var(--blue);" onclick="exportAllData()">ğŸ“¥ Export</button>
          </div>
        </div>
        <div class="card"><h3>ğŸ“ˆ Recent Activity</h3><div class="activity-log" id="activityLog">Loading...</div></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• CLIENTS (API-INTEGRATED) â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-clients" class="hidden">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="clTotal">0</div><div class="stat-lbl">Total</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#6366f1;" id="clActive">0</div><div class="stat-lbl">Active</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="clJobs">0</div><div class="stat-lbl">Total Jobs</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#ef4444;" id="clHRs">0</div><div class="stat-lbl">HR Users</div></div>
        </div>
        <div class="card">
          <h3>ğŸ¢ Create New Client</h3>
          <div class="row2">
            <div><label>Company Name *</label><input type="text" id="nc_company" placeholder="Acme Technologies"></div>
            <div><label>Company Email *</label><input type="email" id="nc_email" placeholder="hr@acme.com"></div>
          </div>
          <div class="row3" style="margin-top:6px;">
            <div><label>Industry</label><input type="text" id="nc_industry" placeholder="Technology"></div>
            <div><label>Phone</label><input type="text" id="nc_phone" placeholder="+91 98765 43210"></div>
            <div><label>Website</label><input type="url" id="nc_website" placeholder="https://acme.com"></div>
          </div>
          <div class="row3" style="margin-top:6px;">
            <div><label>Plan</label>
              <select id="nc_plan">
                <option value="free">Free Trial</option>
                <option value="basic">Basic</option>
                <option value="premium" selected>Premium</option>
                <option value="enterprise">Enterprise</option>
              </select>
            </div>
            <div><label>Admin Name *</label><input type="text" id="nc_adminName" placeholder="John Doe"></div>
            <div><label>Admin Email *</label><input type="email" id="nc_adminEmail" placeholder="john@acme.com"></div>
          </div>
          <div class="row2" style="margin-top:6px;">
            <div><label>Admin Phone</label><input type="text" id="nc_adminPhone" placeholder="+91 98765 43210"></div>
            <div style="display:flex;align-items:flex-end;"><button class="btn btn-save btn-full" onclick="createClient()" id="createClientBtn">ğŸ¢ Create Client via API</button></div>
          </div>
        </div>
        <div class="card" id="clientCredentials" style="display:none;">
          <h3>ğŸ”‘ Client Credentials (Save These!)</h3>
          <div style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);border-radius:12px;padding:16px;">
            <div id="credentialsDisplay" style="font-family:monospace;font-size:.85rem;line-height:2;"></div>
            <button class="btn btn-accent" onclick="copyCredentials()" style="margin-top:10px;">ğŸ“‹ Copy All</button>
          </div>
        </div>
        <div class="card">
          <h3>ğŸ“‹ All Clients</h3>
          <div id="clientsList"><span class="loading"></span> Loading from API...</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• USERS (API-INTEGRATED) â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-users" class="hidden">
        <div class="card">
          <h3>ğŸ‘¥ All Platform Users</h3>
          <div id="usersList"><span class="loading"></span> Loading from API...</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• JOBS (API-INTEGRATED) â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-jobs" class="hidden">
        <div class="card">
          <h3>ğŸ’¼ All Jobs (All Clients)</h3>
          <div id="adminJobsList"><span class="loading"></span></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• APPLICATIONS (API-INTEGRATED) â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-applications" class="hidden">
        <div class="card">
          <h3>ğŸ“ All Applications</h3>
          <div id="adminAppsList"><span class="loading"></span></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• TOKENS â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-tokens" class="hidden">
        <div class="card">
          <h3>ğŸ« Generate Interview Token</h3>
          <div class="row2">
            <div><label>Candidate Name *</label><input type="text" id="tk_name" placeholder="John Doe"></div>
            <div><label>Candidate Email *</label><input type="email" id="tk_email" placeholder="john@email.com"></div>
          </div>
          <div class="row2" style="margin-top:4px;">
            <div><label>Job Role *</label>
              <select id="tk_role">
                <option value="">â€” Select â€”</option>
                <option>Frontend Developer</option><option>Backend Developer</option><option>Full Stack Developer</option>
                <option>Data Scientist</option><option>DevOps Engineer</option><option>UI/UX Designer</option>
                <option>Product Manager</option><option>QA Engineer</option><option>HR Recruiter</option>
                <option value="custom">âœï¸ Custom...</option>
              </select>
            </div>
            <div><label>Level</label>
              <select id="tk_level"><option>Fresher</option><option>Junior</option><option selected>Mid-Level</option><option>Senior</option><option>Lead</option></select>
            </div>
          </div>
          <div id="tk_customWrap" class="hidden" style="margin-top:4px;"><label>Custom Role</label><input type="text" id="tk_customRole" placeholder="Blockchain Developer"></div>
          <div class="row3" style="margin-top:4px;">
            <div><label>Questions</label><select id="tk_questions"><option>5</option><option>8</option><option selected>10</option><option>15</option></select></div>
            <div><label>Type</label><select id="tk_type"><option value="real">ğŸ”’ Proctored</option><option value="mock">ğŸ¯ Mock</option></select></div>
            <div><label>Expires</label><select id="tk_expiry"><option value="24">24h</option><option value="48">48h</option><option value="72" selected>72h</option><option value="168">7d</option></select></div>
          </div>
          <button class="btn btn-primary btn-full" onclick="generateToken()" style="margin-top:16px;">ğŸ« Generate Token</button>
        </div>
        <div class="card hidden" id="tokenResultCard">
          <h3>âœ… Token Generated!</h3>
          <div class="invite-card">
            <h4 id="tokenResultName">â€”</h4>
            <div style="font-size:0.78rem;color:var(--muted);" id="tokenResultMeta">â€”</div>
            <div class="copy-box"><input class="copy-input" id="tokenResultUrl" readonly><button class="copy-btn" onclick="copyEl('tokenResultUrl')">ğŸ“‹ Copy</button></div>
            <div class="token-display" id="tokenResultToken" onclick="copyText(this.textContent)" title="Click to copy">â€”</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button class="btn btn-wa" onclick="sendTokenWA()">ğŸ“² WhatsApp</button>
            <button class="btn btn-save" onclick="copyTokenEmail()">ğŸ“§ Email</button>
          </div>
        </div>
        <div class="card"><h3>ğŸ“‹ All Tokens</h3><div id="allTokensList"><span class="loading"></span></div></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• JD AI BUILDER â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-jdbuilder" class="hidden">
        <div class="card">
          <h3>âœï¸ AI Job Description Generator</h3>
          <div class="row2">
            <div><label>Job Title *</label><input type="text" id="jd_title" placeholder="Senior React Developer"></div>
            <div><label>Industry</label>
              <select id="jd_industry"><option>Technology</option><option>Finance</option><option>Healthcare</option><option>Education</option><option>Other</option></select>
            </div>
          </div>
          <div class="row3" style="margin-top:8px;">
            <div><label>Level</label><select id="jd_level"><option>Entry (0-2 yrs)</option><option selected>Mid (3-5 yrs)</option><option>Senior (6-10 yrs)</option><option>Lead (10+)</option></select></div>
            <div><label>Type</label><select id="jd_emptype"><option>Full-Time</option><option>Part-Time</option><option>Contract</option><option>Remote</option><option>Hybrid</option></select></div>
            <div><label>Location</label><input type="text" id="jd_location" placeholder="Bangalore / Remote"></div>
          </div>
          <div class="row2" style="margin-top:8px;">
            <div><label>Salary Range</label><input type="text" id="jd_salary" placeholder="â‚¹8-12 LPA"></div>
            <div><label>Key Skills</label><input type="text" id="jd_skills" placeholder="React, Node.js, AWS"></div>
          </div>
          <div style="margin-top:8px;"><label>Extra Notes</label><textarea id="jd_extra" placeholder="Culture, benefits..."></textarea></div>
          <button class="btn btn-jd btn-full" onclick="generateJD()" id="jd_genBtn" style="margin-top:14px;">âœ¨ Generate JD with AI</button>
        </div>
        <div class="card hidden" id="jd_resultCard">
          <h3>ğŸ“„ Generated JD</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
            <button class="btn btn-save" onclick="copyJD()">ğŸ“‹ Copy</button>
            <button class="btn btn-accent" onclick="saveJDAsJob()">ğŸ’¾ Save as Job</button>
            <button class="btn btn-primary" onclick="downloadJD()">â¬‡ï¸ Download</button>
          </div>
          <div id="jd_output" class="jd-output">â€”</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• PAYROLL (LOCAL) â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-payroll" class="hidden">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#8b5cf6;" id="py_empCount">0</div><div class="stat-lbl">Employees</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="py_totalPay">â‚¹0</div><div class="stat-lbl">Monthly Outflow</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="py_pending">0</div><div class="stat-lbl">Pending</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#3b82f6;" id="py_processed">0</div><div class="stat-lbl">Processed</div></div>
        </div>
        <div class="card">
          <h3>ğŸ‘¤ Add Employee</h3>
          <div class="row2">
            <div><label>Full Name *</label><input type="text" id="emp_name" placeholder="John Doe"></div>
            <div><label>Employee ID</label><input type="text" id="emp_id" placeholder="EMP-001"></div>
          </div>
          <div class="row2" style="margin-top:6px;">
            <div><label>Department</label><select id="emp_dept"><option>Engineering</option><option>HR</option><option>Sales</option><option>Marketing</option><option>Finance</option><option>Operations</option></select></div>
            <div><label>Designation</label><input type="text" id="emp_desig" placeholder="Senior Engineer"></div>
          </div>
          <div class="row3" style="margin-top:6px;">
            <div><label>Basic (â‚¹)</label><input type="number" id="emp_basic" placeholder="50000" oninput="calcPayroll()"></div>
            <div><label>HRA (â‚¹)</label><input type="number" id="emp_hra" placeholder="20000" oninput="calcPayroll()"></div>
            <div><label>Allowances (â‚¹)</label><input type="number" id="emp_allow" placeholder="10000" oninput="calcPayroll()"></div>
          </div>
          <div class="row4" style="margin-top:6px;">
            <div><label>PF %</label><input type="number" id="emp_pf" value="12" oninput="calcPayroll()"></div>
            <div><label>ESI %</label><input type="number" id="emp_esi" value="0.75" step="0.25" oninput="calcPayroll()"></div>
            <div><label>TDS (â‚¹)</label><input type="number" id="emp_tds" value="0" oninput="calcPayroll()"></div>
            <div><label>Bonus (â‚¹)</label><input type="number" id="emp_bonus" value="0" oninput="calcPayroll()"></div>
          </div>
          <div class="calc-result" id="calc_result" style="display:none;">
            <strong style="font-size:.88rem;color:var(--accent);">ğŸ“Š Salary Breakdown</strong>
            <div class="calc-row"><span>Gross</span><span id="cr_gross">â€”</span></div>
            <div class="calc-row deduct"><span>PF</span><span id="cr_pf">â€”</span></div>
            <div class="calc-row deduct"><span>ESI</span><span id="cr_esi">â€”</span></div>
            <div class="calc-row deduct"><span>TDS</span><span id="cr_tds">â€”</span></div>
            <div class="calc-row"><span>Net Take-Home</span><span id="cr_net">â€”</span></div>
          </div>
          <button class="btn btn-save btn-full" onclick="addEmployee()" style="margin-top:14px;">ğŸ’¾ Save Employee</button>
        </div>
        <div class="card">
          <h3>ğŸ‘¥ Employees</h3>
          <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
            <button class="btn btn-payroll" onclick="runBulkPayroll()">ğŸš€ Run Payroll</button>
            <button class="btn btn-save" onclick="exportPayrollCSV()">ğŸ“¥ Export CSV</button>
          </div>
          <div id="employeeList"><p style="color:var(--muted);text-align:center;">No employees.</p></div>
        </div>
      </div>

      <!-- Payslip Modal -->
      <div class="payslip-modal hidden" id="payslipModal"><div class="payslip-box" id="payslipContent"></div></div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• WHATSAPP â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-whatsapp" class="hidden">
        <div class="card">
          <h3>ğŸ’¬ WhatsApp Quick Send</h3>
          <div class="row2">
            <div><label>Phone (with code)</label><input type="text" id="wa_phone" placeholder="+919876543210"></div>
            <div><label>Template</label>
              <select id="wa_template" onchange="loadWATemplate()">
                <option value="interview">ğŸ¤ Interview</option><option value="shortlist">â­ Shortlisted</option>
                <option value="offer">ğŸ‰ Offer</option><option value="followup">ğŸ”” Follow-up</option>
                <option value="rejection">ğŸ’Œ Rejection</option><option value="custom">âœï¸ Custom</option>
              </select>
            </div>
          </div>
          <div class="row3" style="margin-top:8px;">
            <div><label>Name</label><input type="text" id="wa_cname" placeholder="John" oninput="previewWA()"></div>
            <div><label>Role</label><input type="text" id="wa_role" placeholder="Developer" oninput="previewWA()"></div>
            <div><label>Link</label><input type="text" id="wa_link" placeholder="https://..." oninput="previewWA()"></div>
          </div>
          <div style="margin-top:10px;"><label>Custom Message</label><textarea id="wa_custom" oninput="previewWA()"></textarea></div>
          <div id="wa_preview" class="wa-preview" style="display:none;margin-top:12px;">â€”</div>
          <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
            <a id="wa_sendLink" href="#" target="_blank" class="wa-link-btn" onclick="trackWA()">ğŸ“² Open WhatsApp</a>
            <button class="btn btn-save" onclick="copyWAMsg()">ğŸ“‹ Copy Message</button>
          </div>
        </div>
        <div class="card">
          <h3>ğŸ“š Templates</h3>
          <div id="wa_templates_list"></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• PIPELINE â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-pipeline" class="hidden">
        <div class="card" style="padding:14px;">
          <h3>ğŸ”„ Recruitment Pipeline</h3>
          <div class="kanban-board" id="kanbanBoard">
            <div class="kanban-col">
              <div class="kanban-col-header" style="color:#94a3b8;">ğŸ“¥ Applied <span class="kanban-badge" id="kc_applied">0</span></div>
              <div id="kcol_applied"></div>
            </div>
            <div class="kanban-col">
              <div class="kanban-col-header" style="color:#f59e0b;">â­ Shortlisted <span class="kanban-badge" id="kc_shortlisted">0</span></div>
              <div id="kcol_shortlisted"></div>
            </div>
            <div class="kanban-col">
              <div class="kanban-col-header" style="color:#3b82f6;">ğŸ¤ Interviewed <span class="kanban-badge" id="kc_interviewed">0</span></div>
              <div id="kcol_interviewed"></div>
            </div>
            <div class="kanban-col">
              <div class="kanban-col-header" style="color:#8b5cf6;">ğŸ¤ Offered <span class="kanban-badge" id="kc_offered">0</span></div>
              <div id="kcol_offered"></div>
            </div>
            <div class="kanban-col">
              <div class="kanban-col-header" style="color:#10b981;">âœ… Hired <span class="kanban-badge" id="kc_hired">0</span></div>
              <div id="kcol_hired"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-settings" class="hidden">
        <div class="card">
          <h3>ğŸ”Œ API Connection</h3>
          <div class="edit-row"><span class="edit-label">Worker URL</span><input class="edit-input" id="set_worker" placeholder="https://your-worker.workers.dev"><button class="btn btn-primary" onclick="testConnection()" style="margin-left:8px" id="testConnBtn">ğŸ” Test</button></div>
          <div class="edit-row"><span class="edit-label">Status</span><span id="connStatus" class="sync-indicator sync-pending">â³ Not tested</span></div>
        </div>
        <div class="card">
          <h3>ğŸ” Change Password</h3>
          <div class="edit-row"><span class="edit-label">Current</span><input class="edit-input" type="password" id="set_curPass"></div>
          <div class="edit-row"><span class="edit-label">New</span><input class="edit-input" type="password" id="set_newPass"></div>
          <button class="btn btn-primary" onclick="changePassword()" style="margin-top:8px;">ğŸ” Change</button>
        </div>
        <div class="card">
          <h3>ğŸ” Offline Password</h3>
          <div class="edit-row"><span class="edit-label">Offline Pass</span><input class="edit-input" type="password" id="set_offlinePass" placeholder="For when API is down"><button class="btn btn-save" onclick="saveOfflinePass()" style="margin-left:8px">Save</button></div>
        </div>
        <div class="card"><h3>ğŸ—ƒï¸ Data</h3><div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="exportAllData()">ğŸ“¥ Export All</button>
          <button class="btn btn-danger" onclick="dangerReset()">âš ï¸ Reset Local</button>
        </div></div>
      </div>

    </div>
  </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE STATE & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W_DEFAULT = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let AUTH_TOKEN = null;
let AUTH_USER = null;
let WORKER_URL = '';
let API_MODE = true; // true = API auth, false = offline

function getLS(k, fb) { try { return JSON.parse(localStorage.getItem(k)) || fb; } catch { return fb; } }
function setLS(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
function getW() { return WORKER_URL || localStorage.getItem('workerUrl') || W_DEFAULT; }
function fmtINR(n) { return 'â‚¹' + (n || 0).toLocaleString('en-IN'); }
function genUUID() { return crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 10); }

function toast(m, dur = 3200) {
  const c = document.getElementById("toasts"), t = document.createElement("div");
  t.className = "toast"; t.textContent = m; c.appendChild(t);
  setTimeout(() => t.remove(), dur);
}

function toggleSwitch(el) {
  el.classList.toggle('on');
  const n = el.nextElementSibling;
  if (n?.classList.contains('edit-preview')) n.textContent = el.classList.contains('on') ? 'On' : 'Off';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPER â€” all API calls go through here
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(method, path, body = null) {
  const url = getW() + path;
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' }
  };
  if (AUTH_TOKEN) opts.headers['Authorization'] = 'Bearer ' + AUTH_TOKEN;
  if (body) opts.body = JSON.stringify(body);

  try {
    const res = await fetch(url, opts);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  } catch (e) {
    console.error(`[API ${method} ${path}]`, e);
    throw e;
  }
}

// Legacy DB proxy â€” kept for backward compat (tokens, etc.)
async function db(action, table, data = null, filters = null, select = null, order = null) {
  return api('POST', '/db', { action, table, data, filters, select, order });
}

// AI Chat
async function aiChat(messages) {
  try {
    const r = await api('POST', '/ai', { messages });
    return r.response || '';
  } catch (e) {
    // Fallback to root endpoint
    try {
      const r = await api('POST', '/', { messages });
      return r.response || '';
    } catch { return ''; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH / LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let loginMode = 'api';

function toggleLoginMode() {
  loginMode = loginMode === 'api' ? 'offline' : 'api';
  document.getElementById('apiLoginForm').classList.toggle('hidden', loginMode !== 'api');
  document.getElementById('offlineLoginForm').classList.toggle('hidden', loginMode !== 'offline');
  document.getElementById('loginSubtext').textContent = loginMode === 'api'
    ? 'Login with your admin credentials'
    : 'Offline mode â€” local password only';
  document.getElementById('toggleLoginMode').innerHTML = loginMode === 'api'
    ? '<a onclick="toggleLoginMode()">Switch to offline mode</a>'
    : '<a onclick="toggleLoginMode()">Switch to API login</a>';
}

async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if (!email || !pass) { toast('âŒ Enter email and password'); return; }

  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'â³ Connecting...';

  // Save worker URL
  const wUrl = document.getElementById('workerUrlInput').value.trim();
  if (wUrl) { WORKER_URL = wUrl; localStorage.setItem('workerUrl', wUrl); }

  try {
    const data = await api('POST', '/auth/login', { email, password: pass });
    if (!data.success || !data.token) throw new Error(data.error || 'Login failed');

    // Verify superadmin role
    if (data.user.role !== 'superadmin') {
      throw new Error('Access denied. Super admin role required.');
    }

    AUTH_TOKEN = data.token;
    AUTH_USER = data.user;
    localStorage.setItem('auth_token', AUTH_TOKEN);
    localStorage.setItem('auth_user', JSON.stringify(AUTH_USER));

    showAdminPanel();
    toast('âœ… Welcome, ' + (data.user.name || 'Admin') + '!');
  } catch (e) {
    document.getElementById('loginError').textContent = 'âŒ ' + e.message;
    document.getElementById('loginError').style.display = 'block';
    setTimeout(() => document.getElementById('loginError').style.display = 'none', 4000);
  }
  btn.disabled = false; btn.textContent = 'ğŸ”“ Login via API';
}

function doOfflineLogin() {
  const pass = document.getElementById('offlinePass').value.trim();
  const stored = localStorage.getItem('offlinePassword') || 'superadmin@2025';
  if (pass === stored) {
    API_MODE = false;
    AUTH_USER = { name: 'Offline Admin', email: 'offline', role: 'superadmin' };
    showAdminPanel();
    toast('âœ… Offline mode â€” some features limited');
  } else {
    document.getElementById('loginError').textContent = 'âŒ Wrong offline password';
    document.getElementById('loginError').style.display = 'block';
    setTimeout(() => document.getElementById('loginError').style.display = 'none', 3000);
  }
}

function showAdminPanel() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('adminWrap').style.display = 'block';
  document.getElementById('adminMeta').textContent =
    `Logged in as: ${AUTH_USER?.name || '?'} (${AUTH_USER?.email || '?'}) â€¢ ${API_MODE ? 'ğŸŸ¢ API' : 'ğŸŸ¡ Offline'}`;
  document.getElementById('apiIndicator').className = API_MODE ? 'sync-indicator sync-ok' : 'sync-indicator sync-pending';
  document.getElementById('apiIndicator').textContent = API_MODE ? 'ğŸŸ¢ API Connected' : 'ğŸŸ¡ Offline Mode';
  updateSyncStatus(API_MODE ? 'ok' : 'pending', API_MODE ? 'Connected to API' : 'Offline mode');
  loadDashboard();
}

function doLogout() {
  AUTH_TOKEN = null; AUTH_USER = null; API_MODE = true;
  localStorage.removeItem('auth_token');
  localStorage.removeItem('auth_user');
  document.getElementById('adminWrap').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'block';
  document.getElementById('loginPass').value = '';
  toast('ğŸšª Logged out');
}

// Restore session
function restoreSession() {
  const token = localStorage.getItem('auth_token');
  const user = localStorage.getItem('auth_user');
  if (token && user) {
    try {
      const decoded = JSON.parse(atob(token));
      if (decoded.exp && decoded.exp > Date.now()) {
        AUTH_TOKEN = token;
        AUTH_USER = JSON.parse(user);
        if (AUTH_USER.role === 'superadmin') {
          showAdminPanel();
          return true;
        }
      }
    } catch {}
  }
  return false;
}

function updateSyncStatus(status, text) {
  const el = document.getElementById('syncStatus');
  el.className = 'sync-indicator sync-' + status;
  el.textContent = (status === 'ok' ? 'ğŸŸ¢' : status === 'err' ? 'ğŸ”´' : 'ğŸŸ¡') + ' ' + text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_TABS = ['dashboard', 'clients', 'users', 'jobs', 'applications', 'tokens', 'jdbuilder', 'payroll', 'whatsapp', 'pipeline', 'settings'];

function showTab(tab) {
  ALL_TABS.forEach(t => document.getElementById('tab-' + t)?.classList.add('hidden'));
  document.getElementById('tab-' + tab)?.classList.remove('hidden');
  document.querySelectorAll('.admin-tab').forEach((b, i) => b.classList.toggle('active', ALL_TABS[i] === tab));
  const loaders = {
    dashboard: loadDashboard, clients: loadClients, users: loadUsers, jobs: loadAdminJobs,
    applications: loadAdminApps, tokens: loadTokens, jdbuilder: () => {}, payroll: loadPayrollTab,
    whatsapp: initWA, pipeline: loadPipeline, settings: loadSettings
  };
  loaders[tab]?.();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  try {
    if (API_MODE) {
      const stats = await api('GET', '/admin/stats');
      document.getElementById('sClients').textContent = stats.totalClients || 0;
      document.getElementById('sUsers').textContent = stats.totalUsers || 0;
      document.getElementById('sJobs').textContent = stats.totalJobs || 0;
      document.getElementById('sApps').textContent = stats.totalApplications || 0;
      document.getElementById('sActiveClients').textContent = stats.activeClients || 0;
    }
  } catch (e) {
    console.error('Dashboard stats error:', e);
    updateSyncStatus('err', 'API Error');
  }

  // Local stats
  const emps = getLS('hr_employees', []);
  document.getElementById('sEmployees').textContent = emps.length;
  document.getElementById('sJdCount').textContent = getLS('jdCount', 0);
  document.getElementById('sWaSent').textContent = getLS('waSentCount', 0);

  // Activity log
  const log = document.getElementById('activityLog');
  if (API_MODE) {
    try {
      const [clients, apps] = await Promise.all([
        api('GET', '/admin/clients').catch(() => ({ clients: [] })),
        db('select', 'applications', null, null, null, 'created_at.desc').catch(() => [])
      ]);
      const items = [
        ...(clients.clients || []).map(c => ({ t: c.created_at, m: `ğŸ¢ ${c.company_name} â€” ${c.plan || 'free'} plan` })),
        ...(Array.isArray(apps) ? apps : []).slice(0, 20).map(a => ({ t: a.created_at, m: `ğŸ“ ${a.candidate_name || a.name || '?'} applied` }))
      ].sort((a, b) => new Date(b.t || 0) - new Date(a.t || 0)).slice(0, 20);
      log.innerHTML = items.length
        ? items.map(i => `<div><span style="font-size:.7rem;color:var(--muted);">${i.t ? new Date(i.t).toLocaleString() : '?'}</span> ${i.m}</div>`).join('')
        : '<div>No activity yet</div>';
    } catch { log.innerHTML = '<div>Could not load activity</div>'; }
  } else {
    log.innerHTML = '<div>Offline mode â€” limited activity data</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS (API-INTEGRATED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastCredentials = '';

async function createClient() {
  const company = document.getElementById('nc_company').value.trim();
  const email = document.getElementById('nc_email').value.trim();
  const adminName = document.getElementById('nc_adminName').value.trim();
  const adminEmail = document.getElementById('nc_adminEmail').value.trim();

  if (!company || !email || !adminName || !adminEmail) {
    toast('âŒ Fill all required fields'); return;
  }

  const btn = document.getElementById('createClientBtn');
  btn.disabled = true; btn.textContent = 'â³ Creating...';

  try {
    const result = await api('POST', '/admin/clients', {
      company_name: company,
      company_email: email,
      company_phone: document.getElementById('nc_phone').value.trim(),
      industry: document.getElementById('nc_industry').value.trim(),
      website: document.getElementById('nc_website').value.trim(),
      plan: document.getElementById('nc_plan').value,
      admin_name: adminName,
      admin_email: adminEmail,
      admin_phone: document.getElementById('nc_adminPhone').value.trim()
    });

    if (result.success) {
      _lastCredentials = `Company: ${company}\nAdmin Email: ${adminEmail}\nTemp Password: ${result.admin?.temp_password || 'N/A'}\nLogin: ${window.location.origin}/login.html`;
      document.getElementById('credentialsDisplay').innerHTML = _lastCredentials.replace(/\n/g, '<br>');
      document.getElementById('clientCredentials').style.display = 'block';

      // Clear form
      ['nc_company', 'nc_email', 'nc_industry', 'nc_phone', 'nc_website', 'nc_adminName', 'nc_adminEmail', 'nc_adminPhone'].forEach(id => document.getElementById(id).value = '');
      toast('âœ… Client "' + company + '" created!');
      loadClients();
    }
  } catch (e) {
    toast('âŒ ' + e.message);
  }
  btn.disabled = false; btn.textContent = 'ğŸ¢ Create Client via API';
}

function copyCredentials() {
  navigator.clipboard?.writeText(_lastCredentials);
  toast('ğŸ“‹ Credentials copied!');
}

async function loadClients() {
  const el = document.getElementById('clientsList');
  el.innerHTML = '<span class="loading"></span> Loading...';

  if (!API_MODE) { el.innerHTML = '<p style="color:var(--muted);text-align:center;">API required for client management</p>'; return; }

  try {
    const data = await api('GET', '/admin/clients');
    const clients = data.clients || [];

    document.getElementById('clTotal').textContent = clients.length;
    document.getElementById('clActive').textContent = clients.filter(c => c.is_active).length;
    document.getElementById('clJobs').textContent = clients.reduce((s, c) => s + (c.job_count || 0), 0);
    document.getElementById('clHRs').textContent = clients.reduce((s, c) => s + (c.hr_count || 0), 0);

    if (!clients.length) { el.innerHTML = '<p style="color:var(--muted);text-align:center;">No clients yet.</p>'; return; }

    el.innerHTML = clients.map(c => `
      <div class="client-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;">
          <div>
            <h4>${c.company_name}</h4>
            <div class="client-meta">
              <span>ğŸ“§ ${c.company_email}</span>
              <span>ğŸ“Š ${c.plan || 'free'}</span>
              <span>ğŸ’¼ ${c.job_count || 0} jobs</span>
              <span>ğŸ‘¥ ${c.hr_count || 0} HRs</span>
              <span>ğŸ‘¤ Admin: ${c.admin_email || 'N/A'}</span>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
            <span class="status-pill" style="color:${c.is_active ? '#10b981' : '#ef4444'};">${c.is_active ? 'ğŸŸ¢ Active' : 'ğŸ”´ Inactive'}</span>
            <button class="btn ${c.is_active ? 'btn-danger' : 'btn-save'}" style="padding:4px 10px;font-size:.72rem;" onclick="toggleClient('${c.id}')">${c.is_active ? 'Disable' : 'Enable'}</button>
            <button class="btn btn-accent" style="padding:4px 10px;font-size:.72rem;" onclick="resetClientPass('${c.id}')">ğŸ”‘ Reset</button>
            <button class="btn btn-danger" style="padding:4px 10px;font-size:.72rem;" onclick="deleteClient('${c.id}','${c.company_name}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>
    `).join('');
  } catch (e) {
    el.innerHTML = '<p style="color:var(--red);">âŒ ' + e.message + '</p>';
  }
}

async function toggleClient(id) {
  try {
    const r = await api('POST', `/admin/clients/${id}/toggle`);
    toast(r.is_active ? 'âœ… Activated' : 'ğŸš« Deactivated');
    loadClients();
  } catch (e) { toast('âŒ ' + e.message); }
}

async function resetClientPass(id) {
  if (!confirm('Reset admin password?')) return;
  try {
    const r = await api('POST', `/admin/clients/${id}/reset-password`);
    alert(`New password: ${r.temp_password}\n\n${r.message}`);
    navigator.clipboard?.writeText(r.temp_password);
    toast('ğŸ”‘ Password reset & copied');
  } catch (e) { toast('âŒ ' + e.message); }
}

async function deleteClient(id, name) {
  if (!confirm(`DELETE "${name}" and ALL its data?`)) return;
  if (prompt('Type DELETE to confirm:') !== 'DELETE') return;
  try {
    await api('DELETE', `/admin/clients/${id}`);
    toast('ğŸ—‘ï¸ Client deleted'); loadClients();
  } catch (e) { toast('âŒ ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS (API-INTEGRATED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUsers() {
  const el = document.getElementById('usersList');
  el.innerHTML = '<span class="loading"></span>';
  if (!API_MODE) { el.innerHTML = '<p style="color:var(--muted);">API required</p>'; return; }

  try {
    const data = await api('GET', '/admin/users');
    const users = data.users || [];
    if (!users.length) { el.innerHTML = '<p style="color:var(--muted);">No users</p>'; return; }

    el.innerHTML = `<div style="overflow-x:auto;"><table class="pay-table">
      <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Active</th><th>Last Login</th></tr></thead>
      <tbody>${users.map(u => {
        const roleColors = { superadmin: '#ef4444', client_admin: '#f59e0b', hr: '#3b82f6' };
        return `<tr>
          <td><strong>${u.name || '?'}</strong></td>
          <td style="font-size:.8rem;color:var(--muted);">${u.email}</td>
          <td><span class="status-pill" style="color:${roleColors[u.role] || '#94a3b8'};">${u.role}</span></td>
          <td>${u.company_name || 'â€”'}</td>
          <td>${u.is_active ? 'ğŸŸ¢' : 'ğŸ”´'}</td>
          <td style="font-size:.72rem;color:var(--muted);">${u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never'}</td>
        </tr>`;
      }).join('')}</tbody></table></div>`;
  } catch (e) { el.innerHTML = '<p style="color:var(--red);">âŒ ' + e.message + '</p>'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOBS (API-INTEGRATED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminJobs() {
  const el = document.getElementById('adminJobsList');
  el.innerHTML = '<span class="loading"></span>';
  try {
    const data = await api('GET', '/jobs');
    const jobs = data.jobs || [];
    if (!jobs.length) { el.innerHTML = '<p style="color:var(--muted);text-align:center;">No jobs</p>'; return; }
    el.innerHTML = jobs.map(j => `<div class="client-card">
      <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;">
        <div><h4>${j.title || '?'}</h4><div class="client-meta"><span>ğŸ¢ ${j.company_name || '?'}</span><span>ğŸ“ ${j.location || '?'}</span><span>ğŸ’¼ ${j.job_type || ''}</span><span>ğŸ“ ${j.applications_count || 0} apps</span></div></div>
        <span class="status-pill" style="color:${j.is_active ? '#10b981' : '#ef4444'};">${j.is_active ? 'Active' : 'Inactive'}</span>
      </div>
    </div>`).join('');
  } catch (e) { el.innerHTML = '<p style="color:var(--red);">âŒ ' + e.message + '</p>'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLICATIONS (API-INTEGRATED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminApps() {
  const el = document.getElementById('adminAppsList');
  el.innerHTML = '<span class="loading"></span>';
  try {
    const data = await db('select', 'applications', null, null, null, 'created_at.desc');
    const apps = Array.isArray(data) ? data : [];
    if (!apps.length) { el.innerHTML = '<p style="color:var(--muted);text-align:center;">No applications</p>'; return; }
    el.innerHTML = apps.slice(0, 50).map(a => {
      const name = a.candidate_name || a.name || '?';
      const email = a.candidate_email || a.email || '';
      const stc = { applied: '#f59e0b', shortlisted: '#3b82f6', interviewed: '#8b5cf6', offered: '#06b6d4', hired: '#10b981', rejected: '#ef4444' }[a.status] || '#94a3b8';
      return `<div class="cand-row">
        <div style="display:flex;align-items:center;gap:8px;flex:1;">
          <div class="cand-avatar">${name[0].toUpperCase()}</div>
          <div><strong>${name}</strong><div style="font-size:.72rem;color:var(--muted);">${email}</div></div>
        </div>
        <span class="status-pill" style="color:${stc};">${a.status || '?'}</span>
      </div>`;
    }).join('');
  } catch (e) { el.innerHTML = '<p style="color:var(--red);">âŒ ' + e.message + '</p>'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastToken = null;
document.getElementById('tk_role')?.addEventListener('change', e => {
  document.getElementById('tk_customWrap').classList.toggle('hidden', e.target.value !== 'custom');
});

async function generateToken() {
  const name = document.getElementById('tk_name').value.trim();
  const email = document.getElementById('tk_email').value.trim();
  const roleEl = document.getElementById('tk_role');
  let role = roleEl.value === 'custom' ? document.getElementById('tk_customRole').value.trim() : roleEl.value;
  if (!name || !email || !role) { toast('âŒ Fill required fields'); return; }

  const level = document.getElementById('tk_level').value;
  const questions = parseInt(document.getElementById('tk_questions').value) || 10;
  const type = document.getElementById('tk_type').value;
  const hours = parseInt(document.getElementById('tk_expiry').value) || 72;
  const token = genUUID();
  const expires = new Date(Date.now() + hours * 3600000);

  toast('â³ Creating...');
  try {
    await db('insert', 'interviews', {
      token, interview_type: type, status: 'pending',
      interview_role: role, interview_level: level, question_count: questions,
      expires_at: expires.toISOString(), created_at: new Date().toISOString()
    });

    const baseUrl = window.location.origin;
    const page = type === 'real' ? 'evalis-interview.html' : 'evalis-platform.html';
    const url = `${baseUrl}/${page}?token=${token}`;
    _lastToken = { name, email, role, level, token, url, expires, type, questions };

    document.getElementById('tokenResultCard').classList.remove('hidden');
    document.getElementById('tokenResultName').textContent = `${name} â€” ${role} (${level})`;
    document.getElementById('tokenResultMeta').textContent = `ğŸ“§ ${email} â€¢ ${questions}Q â€¢ ${type === 'real' ? 'ğŸ”’ Proctored' : 'ğŸ¯ Mock'}`;
    document.getElementById('tokenResultUrl').value = url;
    document.getElementById('tokenResultToken').textContent = 'Token: ' + token;
    toast('âœ… Token created!');
    loadAllTokens();
  } catch (e) { toast('âŒ ' + e.message); }
}

function copyEl(id) { navigator.clipboard?.writeText(document.getElementById(id).value); toast('ğŸ“‹ Copied!'); }
function copyText(t) { navigator.clipboard?.writeText(t); toast('ğŸ“‹ Copied!'); }

function sendTokenWA() {
  if (!_lastToken) return;
  const t = _lastToken;
  const msg = encodeURIComponent(`ğŸ¤ *Interview Invitation*\n\nHi ${t.name}! Shortlisted for *${t.role}* (${t.level}).\n\nğŸ”— ${t.url}\n\nğŸ“‹ ${t.questions} questions â€¢ ${t.type === 'real' ? 'ğŸ”’ Proctored' : 'ğŸ¯ Practice'}\nâ° Expires: ${t.expires.toLocaleDateString()}\n\nâ€” Simpatico HR`);
  window.open('https://wa.me/?text=' + msg, '_blank');
  incrementWA();
}

function copyTokenEmail() {
  if (!_lastToken) return;
  const t = _lastToken;
  const email = `Subject: Interview Invitation â€” ${t.role}\n\nDear ${t.name},\n\nYou've been shortlisted for ${t.role} (${t.level}).\n\nğŸ”— ${t.url}\n\nğŸ“‹ ${t.questions} questions â€¢ Expires: ${t.expires.toLocaleString()}\n\nBest regards,\nSimpatico HR`;
  navigator.clipboard?.writeText(email); toast('ğŸ“§ Email copied!');
}

async function loadAllTokens() {
  const el = document.getElementById('allTokensList');
  el.innerHTML = '<span class="loading"></span>';
  try {
    const data = await db('select', 'interviews', null, null, null, 'created_at.desc');
    const arr = Array.isArray(data) ? data : [];
    if (!arr.length) { el.innerHTML = '<p style="color:var(--muted);text-align:center;">No tokens</p>'; return; }
    el.innerHTML = arr.slice(0, 30).map(i => {
      const sc = { pending: '#f59e0b', in_progress: '#3b82f6', completed: '#10b981' }[i.status] || '#94a3b8';
      return `<div style="padding:10px;border-bottom:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:4px;">
          <div><strong>${i.interview_role || '?'}</strong> â€” ${i.interview_level || ''}
            <div style="font-size:.7rem;color:var(--muted);">${(i.token || '').substr(0, 12)}... â€¢ ${i.created_at ? new Date(i.created_at).toLocaleDateString() : ''}</div>
          </div>
          <div style="display:flex;gap:4px;align-items:center;">
            ${i.overall_score ? `<span class="score-badge" style="background:rgba(16,185,129,.15);color:#10b981;">${i.overall_score}/100</span>` : ''}
            <span class="status-pill" style="color:${sc};">${i.status}</span>
          </div>
        </div>
      </div>`;
    }).join('');
  } catch (e) { el.innerHTML = '<p style="color:var(--red);">âŒ ' + e.message + '</p>'; }
}

function loadTokens() { loadAllTokens(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JD AI BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _currentJD = '';

async function generateJD() {
  const title = document.getElementById('jd_title').value.trim();
  if (!title) { toast('âŒ Enter title'); return; }
  const btn = document.getElementById('jd_genBtn');
  btn.disabled = true; btn.textContent = 'â³ Generating...';
  document.getElementById('jd_resultCard').classList.remove('hidden');
  document.getElementById('jd_output').innerHTML = '<span class="loading"></span> AI generating...';

  const prompt = `Generate a comprehensive, ATS-optimized job description for:
Title: ${title}
Industry: ${document.getElementById('jd_industry').value}
Level: ${document.getElementById('jd_level').value}
Type: ${document.getElementById('jd_emptype').value}
Location: ${document.getElementById('jd_location').value || 'Not specified'}
Salary: ${document.getElementById('jd_salary').value || 'Competitive'}
Skills: ${document.getElementById('jd_skills').value || 'Based on role'}
Notes: ${document.getElementById('jd_extra').value || 'None'}

Include sections: About Company, Job Overview, Key Responsibilities (8-10 bullets), Required Qualifications, Preferred Qualifications, What We Offer, Skills & Technologies, How to Apply. Make it engaging and inclusive.`;

  try {
    const response = await aiChat([{ role: 'user', content: prompt }]);
    _currentJD = response || 'Failed to generate. Try again.';
    document.getElementById('jd_output').textContent = _currentJD;
    setLS('jdCount', (getLS('jdCount', 0) || 0) + 1);
    toast('âœ… JD generated!');
  } catch (e) {
    document.getElementById('jd_output').textContent = 'âŒ ' + e.message;
  }
  btn.disabled = false; btn.textContent = 'âœ¨ Generate JD with AI';
}

function copyJD() { if (_currentJD) { navigator.clipboard?.writeText(_currentJD); toast('ğŸ“‹ Copied!'); } }
function downloadJD() {
  if (!_currentJD) return;
  const blob = new Blob([_currentJD], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = (document.getElementById('jd_title').value || 'JD') + '.txt'; a.click();
}

async function saveJDAsJob() {
  if (!_currentJD) return;
  try {
    await db('insert', 'jobs', {
      title: document.getElementById('jd_title').value.trim(),
      description: _currentJD, is_active: true,
      location: document.getElementById('jd_location').value,
      job_type: document.getElementById('jd_emptype').value.toLowerCase(),
      created_at: new Date().toISOString()
    });
    toast('ğŸ’¾ Saved as job!');
  } catch (e) { toast('âŒ ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYROLL (LOCAL)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getEmployees() { return getLS('hr_employees', []); }
function saveEmployees(e) { setLS('hr_employees', e); }

function calcPayroll() {
  const basic = parseFloat(document.getElementById('emp_basic').value) || 0;
  const hra = parseFloat(document.getElementById('emp_hra').value) || 0;
  const allow = parseFloat(document.getElementById('emp_allow').value) || 0;
  const bonus = parseFloat(document.getElementById('emp_bonus').value) || 0;
  const pfPct = parseFloat(document.getElementById('emp_pf').value) || 12;
  const esiPct = parseFloat(document.getElementById('emp_esi').value) || 0.75;
  const tds = parseFloat(document.getElementById('emp_tds').value) || 0;
  if (!basic) { document.getElementById('calc_result').style.display = 'none'; return; }
  const gross = basic + hra + allow + bonus;
  const pf = Math.round((basic * pfPct) / 100);
  const esi = Math.round((gross * esiPct) / 100);
  const net = Math.round(gross - pf - esi - tds);
  document.getElementById('calc_result').style.display = 'block';
  document.getElementById('cr_gross').textContent = fmtINR(gross);
  document.getElementById('cr_pf').textContent = 'âˆ’' + fmtINR(pf);
  document.getElementById('cr_esi').textContent = 'âˆ’' + fmtINR(esi);
  document.getElementById('cr_tds').textContent = 'âˆ’' + fmtINR(tds);
  document.getElementById('cr_net').textContent = fmtINR(net);
}

function addEmployee() {
  const name = document.getElementById('emp_name').value.trim();
  if (!name) { toast('âŒ Name required'); return; }
  const emps = getEmployees();
  const id = document.getElementById('emp_id').value.trim() || 'EMP-' + String(emps.length + 1).padStart(3, '0');
  const basic = parseFloat(document.getElementById('emp_basic').value) || 0;
  const hra = parseFloat(document.getElementById('emp_hra').value) || 0;
  const allow = parseFloat(document.getElementById('emp_allow').value) || 0;
  const bonus = parseFloat(document.getElementById('emp_bonus').value) || 0;
  const pfPct = parseFloat(document.getElementById('emp_pf').value) || 12;
  const esiPct = parseFloat(document.getElementById('emp_esi').value) || 0.75;
  const tds = parseFloat(document.getElementById('emp_tds').value) || 0;
  const gross = Math.round(basic + hra + allow + bonus);
  const net = Math.round(gross - (basic * pfPct / 100) - (gross * esiPct / 100) - tds);

  const emp = { id, name, department: document.getElementById('emp_dept').value, designation: document.getElementById('emp_desig').value, basic, hra, allow, bonus, pfPct, esiPct, tds, gross, net };
  const existing = emps.findIndex(e => e.id === id);
  if (existing >= 0) emps[existing] = emp; else emps.push(emp);
  saveEmployees(emps);
  ['emp_name', 'emp_id', 'emp_desig', 'emp_basic', 'emp_hra', 'emp_allow', 'emp_bonus'].forEach(k => document.getElementById(k).value = '');
  document.getElementById('calc_result').style.display = 'none';
  toast('âœ… Saved!'); renderEmployees();
}

function renderEmployees() {
  const emps = getEmployees(); const el = document.getElementById('employeeList');
  document.getElementById('py_empCount').textContent = emps.length;
  document.getElementById('py_totalPay').textContent = fmtINR(emps.reduce((s, e) => s + (e.net || 0), 0));
  if (!emps.length) { el.innerHTML = '<p style="color:var(--muted);text-align:center;">No employees.</p>'; return; }
  el.innerHTML = `<table class="pay-table"><thead><tr><th>ID</th><th>Name</th><th>Dept</th><th>Gross</th><th>Net</th><th>Act</th></tr></thead><tbody>
    ${emps.map(e => `<tr><td style="font-family:monospace;color:var(--accent);">${e.id}</td><td><strong>${e.name}</strong></td><td>${e.department}</td><td style="color:var(--yellow);">${fmtINR(e.gross)}</td><td style="color:#10b981;font-weight:700;">${fmtINR(e.net)}</td>
    <td><button class="btn btn-payroll" style="padding:3px 8px;font-size:.7rem;" onclick="showPayslip('${e.id}')">ğŸ§¾</button><button class="btn btn-danger" style="padding:3px 8px;font-size:.7rem;" onclick="delEmp('${e.id}')">ğŸ—‘ï¸</button></td></tr>`).join('')}
  </tbody></table>`;
}

function delEmp(id) { if (!confirm('Delete?')) return; saveEmployees(getEmployees().filter(e => e.id !== id)); renderEmployees(); toast('ğŸ—‘ï¸'); }

function showPayslip(empId) {
  const e = getEmployees().find(x => x.id === empId); if (!e) return;
  const month = new Date().toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
  const pf = Math.round((e.basic * (e.pfPct || 12)) / 100);
  const esi = Math.round((e.gross * (e.esiPct || 0.75)) / 100);
  document.getElementById('payslipContent').innerHTML = `
    <div class="payslip-header"><div><div class="payslip-company">ğŸ¢ SIMPATICO HR</div></div><div style="text-align:right"><div style="font-size:1.1rem;font-weight:700;">SALARY SLIP</div><div style="font-size:.82rem;color:#64748b;">${month}</div></div></div>
    <table class="payslip-table" style="margin-bottom:16px;"><tr><td><strong>Name</strong></td><td>${e.name}</td><td><strong>ID</strong></td><td>${e.id}</td></tr><tr><td><strong>Dept</strong></td><td>${e.department}</td><td><strong>Designation</strong></td><td>${e.designation || 'â€”'}</td></tr></table>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
      <table class="payslip-table"><thead><tr><td>Earnings</td><td style="text-align:right">â‚¹</td></tr></thead><tbody><tr><td>Basic</td><td style="text-align:right">${fmtINR(e.basic)}</td></tr><tr><td>HRA</td><td style="text-align:right">${fmtINR(e.hra)}</td></tr><tr><td>Allowance</td><td style="text-align:right">${fmtINR(e.allow)}</td></tr><tr><td>Bonus</td><td style="text-align:right">${fmtINR(e.bonus)}</td></tr><tr class="payslip-total"><td><strong>Gross</strong></td><td style="text-align:right"><strong>${fmtINR(e.gross)}</strong></td></tr></tbody></table>
      <table class="payslip-table"><thead><tr><td>Deductions</td><td style="text-align:right">â‚¹</td></tr></thead><tbody><tr><td>PF (${e.pfPct}%)</td><td style="text-align:right;color:#dc2626;">${fmtINR(pf)}</td></tr><tr><td>ESI (${e.esiPct}%)</td><td style="text-align:right;color:#dc2626;">${fmtINR(esi)}</td></tr><tr><td>TDS</td><td style="text-align:right;color:#dc2626;">${fmtINR(e.tds)}</td></tr></tbody></table>
    </div>
    <table class="payslip-table"><tr style="background:#f0fdf4;font-size:1.1rem;font-weight:800;color:#059669;"><td>ğŸ’° NET PAY</td><td style="text-align:right;">${fmtINR(e.net)}</td></tr></table>
    <div style="display:flex;gap:8px;margin-top:16px;"><button onclick="window.print()" style="padding:10px 20px;background:#6366f1;border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;">ğŸ–¨ï¸ Print</button><button onclick="document.getElementById('payslipModal').classList.add('hidden')" style="padding:10px 20px;background:#f1f5f9;border:none;border-radius:8px;color:#475569;font-weight:700;cursor:pointer;">âœ• Close</button></div>`;
  document.getElementById('payslipModal').classList.remove('hidden');
}

function runBulkPayroll() {
  const emps = getEmployees(); if (!emps.length) { toast('âŒ No employees'); return; }
  toast(`âœ… Payroll processed for ${emps.length} employees â€” ${fmtINR(emps.reduce((s, e) => s + (e.net || 0), 0))}`);
}

function exportPayrollCSV() {
  const emps = getEmployees(); if (!emps.length) { toast('âŒ No employees'); return; }
  const csv = 'ID,Name,Department,Gross,Net\n' + emps.map(e => [e.id, e.name, e.department, e.gross, e.net].join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'payroll.csv'; a.click();
  toast('ğŸ“¥ Exported!');
}

function loadPayrollTab() { renderEmployees(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHATSAPP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WA_TEMPLATES = {
  interview: { name: 'ğŸ¤ Interview', body: `Hi *{name}*! ğŸ‘‹\n\nShortlisted for *{role}*.\n\nğŸ”— {link}\n\nâ° Expires in 72h.\n\nGood luck! ğŸ€\nâ€” *Simpatico HR*` },
  shortlist: { name: 'â­ Shortlisted', body: `Dear *{name}*,\n\nGreat news! ğŸ‰ You've been *shortlisted* for *{role}*.\n\nWe'll share next steps soon.\n\nâ€” *Simpatico HR*` },
  offer: { name: 'ğŸ‰ Offer', body: `Congratulations *{name}*! ğŸ¥³\n\nWe're offering you the *{role}* position!\n\nğŸ”— {link}\n\nWelcome! ğŸŠ\nâ€” *Simpatico HR*` },
  followup: { name: 'ğŸ”” Follow-up', body: `Hi *{name}*! ğŸ‘‹\n\nFollowing up on *{role}*. Available for a call?\n\nğŸ”— {link}\n\nâ€” *Simpatico HR*` },
  rejection: { name: 'ğŸ’Œ Rejection', body: `Dear *{name}*,\n\nThank you for your interest in *{role}*. We've moved forward with other candidates.\n\nWe encourage you to apply in the future.\n\nâ€” *Simpatico HR*` },
  custom: { name: 'âœï¸ Custom', body: '' }
};

function initWA() { previewWA(); renderWATemplates(); }

function loadWATemplate() {
  const tpl = WA_TEMPLATES[document.getElementById('wa_template').value];
  if (tpl?.body) document.getElementById('wa_custom').value = tpl.body;
  previewWA();
}

function previewWA() {
  const key = document.getElementById('wa_template').value;
  const name = document.getElementById('wa_cname').value || '{name}';
  const role = document.getElementById('wa_role').value || '{role}';
  const link = document.getElementById('wa_link').value || '{link}';
  let msg = key === 'custom' ? document.getElementById('wa_custom').value : (WA_TEMPLATES[key]?.body || document.getElementById('wa_custom').value);
  msg = msg.replace(/\{name\}/g, name).replace(/\{role\}/g, role).replace(/\{link\}/g, link);
  const preview = document.getElementById('wa_preview');
  if (msg) { preview.style.display = 'block'; preview.textContent = msg; } else preview.style.display = 'none';
  const phone = document.getElementById('wa_phone').value.replace(/\D/g, '');
  document.getElementById('wa_sendLink').href = phone ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}` : `https://wa.me/?text=${encodeURIComponent(msg)}`;
}

function copyWAMsg() {
  const key = document.getElementById('wa_template').value;
  let msg = key === 'custom' ? document.getElementById('wa_custom').value : (WA_TEMPLATES[key]?.body || '');
  msg = msg.replace(/\{name\}/g, document.getElementById('wa_cname').value || '{name}')
    .replace(/\{role\}/g, document.getElementById('wa_role').value || '{role}')
    .replace(/\{link\}/g, document.getElementById('wa_link').value || '{link}');
  navigator.clipboard?.writeText(msg); toast('ğŸ“‹ Copied!');
}

function trackWA() { incrementWA(); }
function incrementWA() { setLS('waSentCount', (getLS('waSentCount', 0) || 0) + 1); }

function renderWATemplates() {
  document.getElementById('wa_templates_list').innerHTML = Object.entries(WA_TEMPLATES).filter(([k]) => k !== 'custom').map(([k, t]) => `
    <div class="wa-template-card"><h4>${t.name}</h4><div class="wa-preview">${t.body.slice(0, 120)}...</div>
    <button class="btn btn-wa" style="padding:4px 12px;font-size:.75rem;margin-top:8px;" onclick="document.getElementById('wa_template').value='${k}';loadWATemplate()">Use</button></div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPipeline() {
  try {
    const data = await db('select', 'applications', null, null, null, 'created_at.desc');
    const apps = Array.isArray(data) ? data : [];
    const stages = ['applied', 'shortlisted', 'interviewed', 'offered', 'hired'];
    stages.forEach(stage => {
      const cards = apps.filter(a => a.status === stage);
      document.getElementById('kc_' + stage).textContent = cards.length;
      document.getElementById('kcol_' + stage).innerHTML = cards.slice(0, 15).map(c => {
        const name = c.candidate_name || c.name || '?';
        const email = c.candidate_email || c.email || '';
        return `<div class="k-card">
          <div class="k-card-name">${name}</div>
          <div class="k-card-role">${email}</div>
          <div style="display:flex;gap:3px;margin-top:6px;flex-wrap:wrap;">
            ${stages.filter(s => s !== stage).slice(0, 2).map(s => `<button class="btn btn-save" style="padding:2px 6px;font-size:.6rem;" onclick="moveApp('${c.id}','${s}')">â†’${s.slice(0, 4)}</button>`).join('')}
          </div>
        </div>`;
      }).join('') || `<div style="color:var(--muted);font-size:.75rem;text-align:center;padding:16px;">Empty</div>`;
    });
  } catch (e) { console.error(e); }
}

async function moveApp(id, status) {
  try { await db('update', 'applications', { status }, { id }); toast('âœ… Moved!'); loadPipeline(); }
  catch (e) { toast('âŒ ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettings() {
  document.getElementById('set_worker').value = getW();
}

async function testConnection() {
  const url = document.getElementById('set_worker').value.trim();
  if (!url) { toast('âŒ Enter URL'); return; }
  const btn = document.getElementById('testConnBtn');
  btn.disabled = true; btn.textContent = 'â³...';
  try {
    WORKER_URL = url; localStorage.setItem('workerUrl', url);
    const res = await fetch(url + '/health');
    const data = await res.json();
    if (data.status === 'operational') {
      document.getElementById('connStatus').className = 'sync-indicator sync-ok';
      document.getElementById('connStatus').textContent = 'ğŸŸ¢ Connected â€” Supabase: ' + (data.has_supabase ? 'âœ…' : 'âŒ') + ' Groq: ' + (data.has_groq ? 'âœ…' : 'âŒ');
      updateSyncStatus('ok', 'Connected');
      toast('âœ… Connection successful!');
    } else throw new Error('Unexpected response');
  } catch (e) {
    document.getElementById('connStatus').className = 'sync-indicator sync-err';
    document.getElementById('connStatus').textContent = 'ğŸ”´ Failed: ' + e.message;
    toast('âŒ ' + e.message);
  }
  btn.disabled = false; btn.textContent = 'ğŸ” Test';
}

async function changePassword() {
  const cur = document.getElementById('set_curPass').value;
  const newP = document.getElementById('set_newPass').value;
  if (!cur || !newP || newP.length < 6) { toast('âŒ Min 6 chars'); return; }
  try {
    await api('POST', '/auth/change-password', { current_password: cur, new_password: newP });
    toast('âœ… Password changed!');
    document.getElementById('set_curPass').value = '';
    document.getElementById('set_newPass').value = '';
  } catch (e) { toast('âŒ ' + e.message); }
}

function saveOfflinePass() {
  const p = document.getElementById('set_offlinePass').value.trim();
  if (!p || p.length < 4) { toast('âŒ Min 4 chars'); return; }
  localStorage.setItem('offlinePassword', p);
  toast('ğŸ’¾ Offline password saved!');
  document.getElementById('set_offlinePass').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportAllData() {
  toast('ğŸ“¥ Exporting...');
  try {
    const data = {
      exported: new Date().toISOString(),
      employees: getLS('hr_employees', []),
      jdCount: getLS('jdCount', 0),
      waSentCount: getLS('waSentCount', 0)
    };
    if (API_MODE) {
      try {
        const [clients, users] = await Promise.all([
          api('GET', '/admin/clients').catch(() => ({ clients: [] })),
          api('GET', '/admin/users').catch(() => ({ users: [] }))
        ]);
        data.clients = clients.clients;
        data.users = users.users;
      } catch {}
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'simpatico-export-' + Date.now() + '.json'; a.click();
    toast('âœ… Exported!');
  } catch (e) { toast('âŒ ' + e.message); }
}

function dangerReset() {
  if (!confirm('âš ï¸ Delete ALL local data?')) return;
  if (prompt('Type DELETE ALL:') !== 'DELETE ALL') return;
  localStorage.clear(); toast('ğŸ—‘ï¸ Cleared!'); setTimeout(() => location.reload(), 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  // Set worker URL from saved
  WORKER_URL = localStorage.getItem('workerUrl') || W_DEFAULT;
  document.getElementById('workerUrlInput').value = WORKER_URL;

  // Try to restore session
  if (!restoreSession()) {
    document.getElementById('loginEmail')?.focus();
  }
});
</script>
</body>
</html>
