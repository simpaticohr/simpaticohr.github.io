<!DOCTYPE html>
<html lang="en">
  <link rel="stylesheet" href="css/shared.css">
<script src="js/api.js"></script>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin | Simpatico HR</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#020617;--card:rgba(15,23,42,.65);--border:rgba(255,255,255,.08);--accent:#6366f1;--accent2:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;--text:#f8fafc;--muted:#94a3b8;--glow:rgba(99,102,241,.15)}
    body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:radial-gradient(circle at 10% 20%,rgba(99,102,241,.15),transparent 40%),radial-gradient(circle at 90% 80%,rgba(79,70,229,.1),transparent 40%),var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
    .top-nav{backdrop-filter:blur(16px);background:rgba(2,6,23,.85);padding:1rem 6%;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .top-logo{font-weight:800;font-size:1.1rem;color:#fff;text-decoration:none}.top-logo span{color:var(--accent)}
    .top-links{display:flex;gap:12px;align-items:center}
    .top-link{color:var(--muted);text-decoration:none;font-size:12px;font-weight:600;padding:6px 12px;border-radius:8px;transition:all 0.2s}
    .top-link:hover{color:#fff;background:rgba(255,255,255,.05)}
    .container{max-width:960px;margin:0 auto;padding:20px}
    .login-card{max-width:400px;margin:80px auto;background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px;text-align:center;backdrop-filter:blur(22px)}
    .login-card h1{font-size:1.5rem;margin-bottom:8px;background:linear-gradient(135deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .login-card p{color:var(--muted);font-size:0.88rem;margin-bottom:24px}
    .login-input{width:100%;padding:14px 16px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:1rem;outline:none;font-family:inherit;margin-bottom:12px;text-align:center}
    .login-input:focus{border-color:rgba(245,158,11,.4);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
    .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#f59e0b,#ef4444);border:none;border-radius:14px;color:#fff;font-size:1rem;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.2s}
    .login-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(245,158,11,.3)}
    .login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .login-error{color:var(--red);font-size:0.85rem;margin-top:12px;display:none}
    .admin-wrap{display:none}
    .admin-header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px;flex-wrap:wrap;gap:10px}
    .admin-header h1{font-size:1.4rem;background:linear-gradient(135deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .admin-header .user-info{font-size:.78rem;color:var(--muted)}
    .admin-tabs{display:flex;gap:0;background:rgba(255,255,255,.03);border-radius:14px;padding:4px;border:1px solid var(--border);margin-bottom:20px;flex-wrap:wrap}
    .admin-tab{flex:1;padding:10px 6px;text-align:center;border:none;background:transparent;color:var(--muted);font-size:0.72rem;font-weight:700;cursor:pointer;border-radius:10px;transition:all 0.2s;font-family:inherit;min-width:70px}
    .admin-tab.active{background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff}
    .admin-tab:hover:not(.active){background:rgba(245,158,11,.1)}
    .card{background:var(--card);backdrop-filter:blur(22px);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
    .card h3{font-size:0.95rem;margin-bottom:14px;display:flex;align-items:center;gap:8px;color:#f59e0b}
    label{display:block;font-size:0.78rem;color:var(--muted);margin:12px 0 4px;font-weight:600}
    select,input[type="text"],input[type="email"],input[type="number"],input[type="password"],input[type="tel"],textarea{width:100%;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;outline:none;transition:border-color 0.2s;font-family:inherit}
    select:focus,input:focus,textarea:focus{border-color:rgba(245,158,11,.4);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
    select option{background:#1e293b}
    textarea{resize:vertical;min-height:60px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
    .stat-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .stat-num{font-size:1.6rem;font-weight:800}.stat-lbl{font-size:0.7rem;color:var(--muted)}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-size:0.82rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s;color:#fff;display:inline-flex;align-items:center;gap:4px}
    .btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
    .btn-save{background:linear-gradient(135deg,#10b981,#059669)}.btn-danger{background:rgba(239,68,68,.15);color:var(--red)}
    .btn-primary{background:linear-gradient(135deg,#f59e0b,#ef4444)}.btn-accent{background:var(--accent)}.btn-blue{background:rgba(59,130,246,.15);color:var(--blue)}
    .btn-full{width:100%;padding:14px;font-size:1rem;border-radius:14px;justify-content:center}
    .btn-sm{padding:4px 10px;font-size:0.72rem}
    .btn:hover:not(:disabled){transform:translateY(-1px)}
    .status-pill{padding:2px 8px;border-radius:10px;font-size:0.72rem;font-weight:700;display:inline-block}
    .score-badge{padding:2px 8px;border-radius:8px;font-size:0.75rem;font-weight:700;display:inline-block}
    .badge-green{background:rgba(16,185,129,.15);color:var(--green)}
    .badge-red{background:rgba(239,68,68,.15);color:var(--red)}
    .badge-yellow{background:rgba(245,158,11,.15);color:var(--yellow)}
    .badge-blue{background:rgba(59,130,246,.15);color:var(--blue)}
    .badge-purple{background:rgba(139,92,246,.15);color:var(--accent2)}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:.82rem}
    th{text-align:left;padding:8px 10px;color:var(--muted);font-weight:700;font-size:.72rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
    td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.03)}
    tr:hover td{background:rgba(99,102,241,.02)}
    .activity-log{max-height:300px;overflow-y:auto;font-size:0.78rem;color:var(--muted);background:rgba(0,0,0,.3);border-radius:10px;padding:12px}
    .activity-log div{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.03)}
    .cand-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);gap:8px;flex-wrap:wrap}.cand-row:last-child{border-bottom:none}
    .cand-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.8rem;flex-shrink:0}
    .invite-card{background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:16px;margin-bottom:10px}
    .invite-card h4{color:var(--accent);font-size:0.9rem;margin-bottom:6px}
    .copy-box{display:flex;gap:8px;align-items:center;margin-top:8px}
    .copy-input{flex:1;padding:8px 12px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-size:0.78rem;font-family:monospace;outline:none}
    .copy-btn{padding:8px 14px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-weight:700;font-size:0.78rem;cursor:pointer;white-space:nowrap;font-family:inherit}
    .token-display{background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:10px;padding:12px;font-family:monospace;font-size:0.82rem;word-break:break-all;margin:8px 0;cursor:pointer;transition:all 0.2s}
    .token-display:hover{border-color:var(--accent);background:rgba(99,102,241,.05)}
    .search-bar{display:flex;gap:8px;margin-bottom:14px}.search-bar input{flex:1}
    .empty-state{text-align:center;padding:30px 20px;color:var(--muted)}.empty-state .icon{font-size:2rem;margin-bottom:8px;opacity:.5}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
    .modal{background:#0f172a;border:1px solid var(--border);border-radius:20px;padding:28px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto}
    .modal h3{font-size:1.1rem;margin-bottom:16px;color:#f59e0b}
    .modal-close{float:right;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer}
    .toast-box{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:rgba(15,23,42,.9);backdrop-filter:blur(12px);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:12px;font-size:0.85rem;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:tIn .3s ease,tOut .3s ease 2.7s forwards;max-width:350px}
    @keyframes tIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(120%);opacity:0}}
    .hidden{display:none!important}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:600px){.stat-grid{grid-template-columns:1fr 1fr}.row2,.row3{grid-template-columns:1fr}.admin-tab{font-size:0.65rem;min-width:50px;padding:8px 4px}.cand-row{flex-direction:column;align-items:flex-start}.top-nav{padding:1rem 4%}.top-links{gap:6px}}
  </style>
</head>
<body>
  <div class="toast-box" id="toasts"></div>

  <nav class="top-nav">
    <a class="top-logo" href="index.html">SIMPATICO <span>HR</span></a>
    <div class="top-links">
      <a class="top-link" href="index.html">ğŸ  Home</a>
      <a class="top-link" href="jobs.html">ğŸ’¼ Jobs</a>
      <span class="top-link" style="color:var(--yellow);">ğŸ” Admin</span>
    </div>
  </nav>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- LOGIN (uses /auth/login API) -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="loginScreen">
    <div class="login-card">
      <div style="font-size:3rem;margin-bottom:12px;">ğŸ”</div>
      <h1>Super Admin</h1>
      <p>Login with your superadmin credentials</p>
      <input type="email" class="login-input" id="loginEmail" placeholder="admin@simpaticohr.in" style="letter-spacing:normal;text-align:left;">
      <input type="password" class="login-input" id="loginPass" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="login-btn" onclick="doLogin()" id="loginBtn">ğŸ”“ Login</button>
      <div class="login-error" id="loginError"></div>
      <div style="margin-top:16px;font-size:.75rem;color:var(--muted);" id="healthStatus">Checking server...</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- ADMIN DASHBOARD -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="admin-wrap" id="adminWrap">
    <div class="container">
      <div class="admin-header">
        <div>
          <h1>ğŸ” Super Admin Panel</h1>
          <div class="user-info" id="adminUserInfo">â€”</div>
        </div>
        <button class="btn btn-danger" onclick="doLogout()">ğŸšª Logout</button>
      </div>

      <div class="admin-tabs" id="adminTabs">
        <button class="admin-tab active" onclick="showTab('dashboard')">ğŸ“Š Dash</button>
        <button class="admin-tab" onclick="showTab('clients')">ğŸ¢ Clients</button>
        <button class="admin-tab" onclick="showTab('users')">ğŸ‘¥ Users</button>
        <button class="admin-tab" onclick="showTab('tokens')">ğŸ« Tokens</button>
        <button class="admin-tab" onclick="showTab('jobs')">ğŸ’¼ Jobs</button>
        <button class="admin-tab" onclick="showTab('candidates')">ğŸ“ Apps</button>
        <button class="admin-tab" onclick="showTab('settings')">âš™ï¸ Settings</button>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- DASHBOARD -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-dashboard">
        <div class="stat-grid" id="statsGrid">
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="sClients">-</div><div class="stat-lbl">Clients</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#6366f1;" id="sUsers">-</div><div class="stat-lbl">Users</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#3b82f6;" id="sJobs">-</div><div class="stat-lbl">Jobs</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="sApps">-</div><div class="stat-lbl">Applications</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#8b5cf6;" id="sInterviews">-</div><div class="stat-lbl">Interviews</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#ef4444;" id="sRevenue">â‚¹0</div><div class="stat-lbl">Revenue</div></div>
        </div>
        <div class="card">
          <h3>ğŸ“Š Application Pipeline</h3>
          <div id="pipelineBreakdown" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>
        <div class="card">
          <h3>âš¡ Quick Actions</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-save" onclick="showTab('clients')">ğŸ¢ New Client</button>
            <button class="btn btn-primary" onclick="showTab('tokens')">ğŸ« Generate Token</button>
            <button class="btn btn-accent" onclick="showTab('jobs')">ğŸ’¼ View Jobs</button>
            <button class="btn btn-blue" onclick="exportData()">ğŸ“¥ Export</button>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- CLIENTS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-clients" class="hidden">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
            <h3 style="margin:0;">ğŸ¢ Clients</h3>
            <button class="btn btn-primary" onclick="showCreateClient()">+ New Client</button>
          </div>
          <div class="search-bar">
            <input type="text" id="clientSearch" placeholder="ğŸ” Search clients..." oninput="filterClients()">
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Company</th><th>Plan</th><th>Users</th><th>Jobs</th><th>Apps</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="clientsBody"><tr><td colspan="7" style="text-align:center;"><span class="loading"></span></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- USERS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-users" class="hidden">
        <div class="card">
          <h3>ğŸ‘¥ All Users</h3>
          <div class="search-bar">
            <input type="text" id="userSearch" placeholder="ğŸ” Search users..." oninput="filterUsers()">
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Status</th><th>Last Login</th></tr></thead>
              <tbody id="usersBody"><tr><td colspan="6" style="text-align:center;"><span class="loading"></span></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- TOKENS (Interview Token Generator) -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-tokens" class="hidden">
        <div class="card">
          <h3>ğŸ« Generate Interview Token</h3>
          <p style="font-size:0.82rem;color:var(--muted);margin-bottom:16px;">Create a proctored interview link for any candidate.</p>
          <div class="row2">
            <div><label>Candidate Name *</label><input type="text" id="tk_name" placeholder="John Doe"></div>
            <div><label>Candidate Email</label><input type="email" id="tk_email" placeholder="john@email.com"></div>
          </div>
          <div class="row2" style="margin-top:4px;">
            <div><label>Job Role *</label>
              <select id="tk_role">
                <option value="">â€” Select â€”</option>
                <option>Frontend Developer</option><option>Backend Developer</option>
                <option>Full Stack Developer</option><option>Data Scientist</option>
                <option>DevOps Engineer</option><option>UI/UX Designer</option>
                <option>Product Manager</option><option>QA Engineer</option>
                <option>Sales Representative</option><option>Marketing Manager</option>
                <option>HR Recruiter</option><option value="custom">âœï¸ Custom...</option>
              </select>
            </div>
            <div><label>Level</label>
              <select id="tk_level">
                <option>Fresher</option><option>Junior</option><option selected>Mid-Level</option><option>Senior</option><option>Lead</option>
              </select>
            </div>
          </div>
          <div id="tk_customWrap" class="hidden"><label>Custom Role</label><input type="text" id="tk_customRole" placeholder="Blockchain Developer"></div>
          <div class="row3" style="margin-top:4px;">
            <div><label>Questions</label>
              <select id="tk_questions"><option value="5">5</option><option value="8">8</option><option value="10" selected>10</option><option value="15">15</option></select>
            </div>
            <div><label>Language</label>
              <select id="tk_lang"><option value="en">English</option><option value="hi">Hindi</option><option value="ml">Malayalam</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="ar">Arabic</option></select>
            </div>
            <div><label>Expires In</label>
              <select id="tk_expiry"><option value="24">24h</option><option value="48">48h</option><option value="72" selected>72h</option><option value="168">7 days</option><option value="720">30 days</option></select>
            </div>
          </div>
          <div class="row2" style="margin-top:4px;">
            <div><label>Type</label>
              <select id="tk_type"><option value="real">ğŸ”’ Proctored</option><option value="mock">ğŸ¯ Mock</option></select>
            </div>
            <div><label>Phone (WhatsApp)</label>
              <input type="tel" id="tk_phone" placeholder="+91 XXXXX XXXXX">
            </div>
          </div>
          <button class="btn btn-primary btn-full" onclick="generateToken()" id="tkGenBtn" style="margin-top:16px;">ğŸ« Generate Interview Token</button>
        </div>

        <!-- Token Result -->
        <div class="card hidden" id="tokenResultCard">
          <h3>âœ… Token Generated!</h3>
          <div class="invite-card">
            <h4 id="tokenResultName">â€”</h4>
            <div style="font-size:0.78rem;color:var(--muted);" id="tokenResultMeta">â€”</div>
            <div class="copy-box">
              <input class="copy-input" id="tokenResultUrl" readonly>
              <button class="copy-btn" onclick="copyToClipboard(document.getElementById('tokenResultUrl').value,'URL')">ğŸ“‹ Copy</button>
            </div>
            <div class="token-display" id="tokenResultToken" onclick="copyToClipboard(this.dataset.token,'Token')">â€”</div>
            <div style="font-size:0.72rem;color:var(--muted);margin-top:8px;" id="tokenResultExpiry">â€”</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button class="btn btn-accent" onclick="copyInviteEmail()" style="flex:1;">ğŸ“§ Email Template</button>
            <button class="btn btn-save" onclick="copyWhatsApp()" style="flex:1;">ğŸ’¬ WhatsApp</button>
          </div>
        </div>

        <!-- All Tokens -->
        <div class="card">
          <h3>ğŸ“‹ All Interview Tokens</h3>
          <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
            <button class="btn btn-sm btn-accent" onclick="loadTokens('all')">All</button>
            <button class="btn btn-sm badge-yellow" onclick="loadTokens('pending')">Pending</button>
            <button class="btn btn-sm badge-blue" onclick="loadTokens('in_progress')">Active</button>
            <button class="btn btn-sm badge-green" onclick="loadTokens('completed')">Done</button>
          </div>
          <div id="allTokensList"><span class="loading"></span></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- JOBS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-jobs" class="hidden">
        <div class="card">
          <h3>ğŸ’¼ All Jobs (across all clients)</h3>
          <div id="adminJobsList"><span class="loading"></span></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- CANDIDATES / APPLICATIONS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-candidates" class="hidden">
        <div class="card">
          <h3>ğŸ“ Recent Applications</h3>
          <div id="adminAppsList"><span class="loading"></span></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SETTINGS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-settings" class="hidden">
        <div class="card">
          <h3>ğŸ” Change Password</h3>
          <label>Current Password</label>
          <input type="password" id="set_curPass">
          <label>New Password</label>
          <input type="password" id="set_newPass" placeholder="Min 6 chars">
          <button class="btn btn-primary" onclick="changePassword()" style="margin-top:12px;">ğŸ”‘ Change Password</button>
        </div>
        <div class="card">
          <h3>âš™ï¸ System Info</h3>
          <div id="systemInfo"><span class="loading"></span></div>
        </div>
      </div>

    </div>
  </div>

  <!-- CREATE CLIENT MODAL -->
  <div id="createClientModal" class="modal-bg hidden" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="modal">
      <button class="modal-close" onclick="document.getElementById('createClientModal').classList.add('hidden')">&times;</button>
      <h3>ğŸ¢ Create New Client</h3>
      <div class="row2">
        <div><label>Company Name *</label><input type="text" id="ccName" placeholder="Acme Corp"></div>
        <div><label>Industry</label><input type="text" id="ccIndustry" placeholder="Technology"></div>
      </div>
      <div class="row2" style="margin-top:4px;">
        <div><label>Admin Name</label><input type="text" id="ccAdminName" placeholder="John Doe"></div>
        <div><label>Admin Email *</label><input type="email" id="ccAdminEmail" placeholder="admin@acme.com"></div>
      </div>
      <div class="row2" style="margin-top:4px;">
        <div><label>Admin Phone</label><input type="tel" id="ccPhone" placeholder="+91 XXXXX"></div>
        <div><label>Website</label><input type="text" id="ccWebsite" placeholder="https://acme.com"></div>
      </div>
      <div class="row3" style="margin-top:4px;">
        <div><label>Plan</label>
          <select id="ccPlan"><option value="free">Free</option><option value="basic">Basic</option><option value="premium" selected>Premium</option><option value="enterprise">Enterprise</option></select>
        </div>
        <div><label>Max Jobs</label><input type="number" id="ccMaxJobs" value="50"></div>
        <div><label>Duration (days)</label><input type="number" id="ccDuration" value="365"></div>
      </div>
      <button class="btn btn-primary btn-full" onclick="createClient()" id="ccBtn" style="margin-top:16px;">ğŸ¢ Create Client</button>
      <div id="ccResult" style="margin-top:12px;font-size:.85rem;"></div>
    </div>
  </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = "https://api.simpaticohr.in";
let TOKEN = null;
let USER = null;
let _clients = [];
let _users = [];
let _lastToken = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPER â€” Proper auth, error handling, CORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(method, path, body = null) {
  const opts = {
    method,
    headers: { "Content-Type": "application/json" }
  };
  if (TOKEN) opts.headers["Authorization"] = "Bearer " + TOKEN;
  if (body) opts.body = JSON.stringify(body);

  let r;
  try {
    r = await fetch(API + path, opts);
  } catch (e) {
    throw new Error("Network error â€” cannot reach " + API + ". " + e.message);
  }

  const ct = r.headers.get("content-type") || "";
  if (!ct.includes("application/json")) {
    const txt = await r.text();
    console.error("[API] Non-JSON:", r.status, txt.substring(0, 300));
    throw new Error("Server error (non-JSON response, status " + r.status + ")");
  }

  const d = await r.json();
  if (d.error) throw new Error(d.error);
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(m) {
  const c = document.getElementById("toasts");
  const t = document.createElement("div");
  t.className = "toast"; t.textContent = m;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

function esc(s) {
  return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function timeAgo(d) {
  if (!d) return "Never";
  const ms = Date.now() - new Date(d).getTime();
  const m = Math.floor(ms / 60000);
  if (m < 1) return "Just now";
  if (m < 60) return m + "m ago";
  const h = Math.floor(m / 60);
  if (h < 24) return h + "h ago";
  const dy = Math.floor(h / 24);
  if (dy < 30) return dy + "d ago";
  return new Date(d).toLocaleDateString();
}

function copyToClipboard(text, label) {
  navigator.clipboard?.writeText(text);
  toast("ğŸ“‹ " + (label || "Copied") + "!");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH â€” Uses /auth/login properly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const email = document.getElementById("loginEmail").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  if (!email || !pass) { toast("âŒ Enter email and password"); return; }

  const btn = document.getElementById("loginBtn");
  const errEl = document.getElementById("loginError");
  btn.disabled = true; btn.textContent = "â³ Logging in...";
  errEl.style.display = "none";

  try {
    const data = await api("POST", "/auth/login", { email, password: pass });

    if (!data.token) throw new Error("No token received");
    if (data.user?.role !== "superadmin") {
      throw new Error("Superadmin access required. Your role: " + (data.user?.role || "unknown"));
    }

    TOKEN = data.token;
    USER = data.user;
    localStorage.setItem("sa_token", TOKEN);
    localStorage.setItem("sa_user", JSON.stringify(USER));

    showDashboard();
    toast("âœ… Welcome, " + (USER.name || "Admin") + "!");
  } catch (e) {
    errEl.textContent = "âŒ " + e.message;
    errEl.style.display = "block";
    console.error("[LOGIN]", e);
  }

  btn.disabled = false; btn.textContent = "ğŸ”“ Login";
}

function doLogout() {
  TOKEN = null; USER = null;
  localStorage.removeItem("sa_token");
  localStorage.removeItem("sa_user");
  document.getElementById("adminWrap").style.display = "none";
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("loginPass").value = "";
  toast("ğŸšª Logged out");
}

function checkSavedAuth() {
  const t = localStorage.getItem("sa_token");
  const u = localStorage.getItem("sa_user");
  if (t && u) {
    try {
      const decoded = JSON.parse(atob(t));
      if (decoded.exp && decoded.exp > Date.now() && decoded.role === "superadmin") {
        TOKEN = t;
        USER = JSON.parse(u);
        showDashboard();
        return true;
      }
    } catch (e) { console.warn("[AUTH]", e.message); }
    localStorage.removeItem("sa_token");
    localStorage.removeItem("sa_user");
  }
  return false;
}

function showDashboard() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("adminWrap").style.display = "block";
  document.getElementById("adminUserInfo").textContent =
    (USER?.name || "Admin") + " â€¢ " + (USER?.email || "") + " â€¢ superadmin";
  loadStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(tab) {
  const tabs = ["dashboard","clients","users","tokens","jobs","candidates","settings"];
  tabs.forEach(t => document.getElementById("tab-" + t)?.classList.add("hidden"));
  document.getElementById("tab-" + tab)?.classList.remove("hidden");
  document.querySelectorAll(".admin-tab").forEach((b, i) => b.classList.toggle("active", tabs[i] === tab));

  const loaders = {
    dashboard: loadStats,
    clients: loadClients,
    users: loadUsers,
    tokens: () => loadTokens("all"),
    jobs: loadJobs,
    candidates: loadApps,
    settings: loadSettings
  };
  if (loaders[tab]) loaders[tab]();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS â€” GET /admin/stats
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStats() {
  try {
    const d = await api("GET", "/admin/stats");
    document.getElementById("sClients").textContent = d.clients?.total || 0;
    document.getElementById("sUsers").textContent = d.users?.total || 0;
    document.getElementById("sJobs").textContent = d.jobs?.total || 0;
    document.getElementById("sApps").textContent = d.applications?.total || 0;
    document.getElementById("sInterviews").textContent = d.interviews?.total || 0;
    document.getElementById("sRevenue").textContent = "â‚¹" + (d.revenue || 0).toLocaleString();

    const byStatus = d.applications?.byStatus || {};
    const colors = {
      applied:"yellow",screened:"blue",shortlisted:"purple",
      interview_scheduled:"blue",interviewed:"purple",
      offered:"green",hired:"green",rejected:"red",withdrawn:"red"
    };
    document.getElementById("pipelineBreakdown").innerHTML =
      Object.entries(byStatus).map(([s, c]) =>
        `<span class="status-pill badge-${colors[s]||'blue'}">${s}: ${c}</span>`
      ).join("");
  } catch (e) {
    toast("âŒ Stats: " + e.message);
    console.error("[STATS]", e);
    ["sClients","sUsers","sJobs","sApps","sInterviews","sRevenue"].forEach(id => {
      document.getElementById(id).textContent = "!";
      document.getElementById(id).style.color = "var(--red)";
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS â€” GET/POST /admin/clients
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadClients() {
  try {
    const d = await api("GET", "/admin/clients");
    _clients = d.clients || [];
    renderClients(_clients);
  } catch (e) {
    toast("âŒ Clients: " + e.message);
    document.getElementById("clientsBody").innerHTML =
      `<tr><td colspan="7" style="text-align:center;color:var(--red);">âŒ ${esc(e.message)}</td></tr>`;
  }
}

function filterClients() {
  const q = document.getElementById("clientSearch").value.toLowerCase();
  renderClients(_clients.filter(c =>
    (c.company_name||"").toLowerCase().includes(q) ||
    (c.admin_email||"").toLowerCase().includes(q) ||
    (c.industry||"").toLowerCase().includes(q)
  ));
}

function renderClients(clients) {
  const tbody = document.getElementById("clientsBody");
  if (!clients.length) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">ğŸ¢</div>No clients</div></td></tr>';
    return;
  }
  const planColors = {free:"yellow",basic:"blue",premium:"purple",enterprise:"green"};
  tbody.innerHTML = clients.map(c => `<tr>
    <td>
      <div style="font-weight:700;">${esc(c.company_name)}</div>
      <div style="font-size:.7rem;color:var(--muted);">${esc(c.admin_email||c.company_email||"")}</div>
      ${c.industry?'<div style="font-size:.68rem;color:var(--muted);">'+esc(c.industry)+'</div>':""}
    </td>
    <td><span class="status-pill badge-${planColors[c.plan]||'blue'}">${c.plan||"free"}</span></td>
    <td>${c.user_count||0}</td>
    <td>${c.job_count||0}</td>
    <td>${c.app_count||0}</td>
    <td>
      <span class="status-pill ${c.is_active?'badge-green':'badge-red'}">${c.is_active?"Active":"Off"}</span>
      ${c.expires_at?'<div style="font-size:.68rem;color:var(--muted);">'+new Date(c.expires_at).toLocaleDateString()+'</div>':""}
    </td>
    <td>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        <button class="btn btn-sm ${c.is_active?'btn-danger':'btn-save'}" onclick="toggleClient('${c.id}')">${c.is_active?"â¸":"â–¶"}</button>
        <button class="btn btn-sm btn-blue" onclick="resetClientPw('${c.id}')">ğŸ”‘</button>
        <button class="btn btn-sm btn-danger" onclick="deleteClient('${c.id}','${esc(c.company_name)}')">ğŸ—‘</button>
      </div>
    </td>
  </tr>`).join("");
}

function showCreateClient() {
  document.getElementById("createClientModal").classList.remove("hidden");
  document.getElementById("ccResult").textContent = "";
}

async function createClient() {
  const name = document.getElementById("ccName").value.trim();
  const email = document.getElementById("ccAdminEmail").value.trim();
  if (!name || !email) { toast("âŒ Company name & admin email required"); return; }

  const btn = document.getElementById("ccBtn");
  btn.disabled = true; btn.textContent = "â³ Creating...";
  document.getElementById("ccResult").textContent = "";

  try {
    const data = await api("POST", "/admin/clients", {
      company_name: name,
      admin_name: document.getElementById("ccAdminName").value.trim(),
      admin_email: email,
      admin_phone: document.getElementById("ccPhone").value.trim(),
      industry: document.getElementById("ccIndustry").value.trim(),
      website: document.getElementById("ccWebsite").value.trim(),
      plan: document.getElementById("ccPlan").value,
      max_jobs: parseInt(document.getElementById("ccMaxJobs").value) || 50,
      duration_days: document.getElementById("ccDuration").value.trim()
    });

    document.getElementById("ccResult").innerHTML =
      `<div style="color:var(--green);background:rgba(16,185,129,.1);padding:12px;border-radius:10px;">
        âœ… ${esc(data.message || "Created!")}
        ${data.admin ? '<br><strong>Email:</strong> '+esc(data.admin.email)+'<br><strong>Password:</strong> '+esc(data.admin.password) : ""}
      </div>`;

    toast("âœ… Client created!");
    loadClients(); loadStats();

    ["ccName","ccAdminName","ccAdminEmail","ccPhone","ccIndustry","ccWebsite"].forEach(id =>
      document.getElementById(id).value = ""
    );
  } catch (e) {
    document.getElementById("ccResult").innerHTML =
      `<div style="color:var(--red);">âŒ ${esc(e.message)}</div>`;
  }
  btn.disabled = false; btn.textContent = "ğŸ¢ Create Client";
}

async function toggleClient(id) {
  try {
    const d = await api("POST", `/admin/clients/${id}/toggle`);
    toast("âœ… " + (d.is_active ? "Enabled" : "Disabled"));
    loadClients();
  } catch (e) { toast("âŒ " + e.message); }
}

async function resetClientPw(id) {
  if (!confirm("Reset admin password for this client?")) return;
  try {
    const d = await api("POST", `/admin/clients/${id}/reset-password`);
    toast("âœ… Password reset!");
    alert("Password reset!\n\nEmail: " + d.email + "\nNew Password: " + d.password);
  } catch (e) { toast("âŒ " + e.message); }
}

async function deleteClient(id, name) {
  if (!confirm("âš ï¸ DELETE \"" + name + "\" and ALL data? This cannot be undone!")) return;
  if (!confirm("FINAL: Delete \"" + name + "\" permanently?")) return;
  try {
    await api("DELETE", `/admin/clients/${id}`);
    toast("ğŸ—‘ï¸ Deleted");
    loadClients(); loadStats();
  } catch (e) { toast("âŒ " + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS â€” GET /admin/users
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUsers() {
  try {
    const d = await api("GET", "/admin/users");
    _users = d.users || [];
    renderUsers(_users);
  } catch (e) {
    toast("âŒ Users: " + e.message);
    document.getElementById("usersBody").innerHTML =
      `<tr><td colspan="6" style="text-align:center;color:var(--red);">âŒ ${esc(e.message)}</td></tr>`;
  }
}

function filterUsers() {
  const q = document.getElementById("userSearch").value.toLowerCase();
  renderUsers(_users.filter(u =>
    (u.name||"").toLowerCase().includes(q) ||
    (u.email||"").toLowerCase().includes(q) ||
    (u.company_name||"").toLowerCase().includes(q)
  ));
}

function renderUsers(users) {
  const tbody = document.getElementById("usersBody");
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="icon">ğŸ‘¥</div>No users</div></td></tr>';
    return;
  }
  const rc = {superadmin:"red",client_admin:"purple",hr:"blue"};
  tbody.innerHTML = users.map(u => `<tr>
    <td style="font-weight:600;">${esc(u.name)}</td>
    <td style="font-size:.82rem;">${esc(u.email)}</td>
    <td><span class="status-pill badge-${rc[u.role]||'blue'}">${u.role}</span></td>
    <td style="font-size:.82rem;">${esc(u.company_name||"â€”")}</td>
    <td><span class="status-pill ${u.is_active?'badge-green':'badge-red'}">${u.is_active?"Active":"Off"}</span></td>
    <td style="font-size:.78rem;color:var(--muted);">${timeAgo(u.last_login)}</td>
  </tr>`).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKENS â€” Uses /admin/clients data + /db for interviews
// Note: Superadmin can view ALL interviews across tenants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById("tk_role")?.addEventListener("change", e => {
  document.getElementById("tk_customWrap").classList.toggle("hidden", e.target.value !== "custom");
});

async function generateToken() {
  const name = document.getElementById("tk_name").value.trim();
  const roleEl = document.getElementById("tk_role");
  let role = roleEl.value === "custom" ? document.getElementById("tk_customRole").value.trim() : roleEl.value;

  if (!name) { toast("âŒ Enter candidate name"); return; }
  if (!role) { toast("âŒ Select a role"); return; }

  const btn = document.getElementById("tkGenBtn");
  btn.disabled = true; btn.textContent = "â³ Generating...";

  try {
    // Use the /db proxy since superadmin needs cross-tenant access
    const token = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + "-" + Math.random().toString(36).substring(2);
    const email = document.getElementById("tk_email").value.trim();
    const level = document.getElementById("tk_level").value;
    const questions = parseInt(document.getElementById("tk_questions").value) || 10;
    const lang = document.getElementById("tk_lang").value;
    const hours = parseInt(document.getElementById("tk_expiry").value) || 72;
    const type = document.getElementById("tk_type").value;
    const phone = document.getElementById("tk_phone").value.trim();
    const expires = new Date(Date.now() + hours * 3600000);

    // Insert interview record via /db proxy
    await api("POST", "/db", {
      action: "insert",
      table: "interviews",
      data: {
        token,
        interview_type: type,
        status: "pending",
        interview_role: role,
        interview_level: level,
        question_count: questions,
        interview_language: lang,
        candidate_name: name,
        candidate_email: email,
        expires_at: expires.toISOString(),
        created_at: new Date().toISOString()
      }
    });

    const interviewPage = "evalis-platform.html";
    const baseUrl = window.location.origin;
    const fullUrl = baseUrl + "/" + interviewPage + "?token=" + token;

    _lastToken = { name, email, role, level, token, url: fullUrl, expires, type, questions, lang, phone };

    document.getElementById("tokenResultCard").classList.remove("hidden");
    document.getElementById("tokenResultName").textContent = name + " â€” " + role + " (" + level + ")";
    document.getElementById("tokenResultMeta").textContent =
      (email ? "ğŸ“§ " + email + " â€¢ " : "") + "ğŸ”¢ " + questions + "Q â€¢ ğŸŒ " + lang + " â€¢ " + (type === "real" ? "ğŸ”’ Proctored" : "ğŸ¯ Mock");
    document.getElementById("tokenResultUrl").value = fullUrl;
    document.getElementById("tokenResultToken").textContent = "Token: " + token;
    document.getElementById("tokenResultToken").dataset.token = token;
    document.getElementById("tokenResultExpiry").textContent = "â° Expires: " + expires.toLocaleString();

    toast("âœ… Token generated for " + name);
    loadTokens("all");
  } catch (e) {
    toast("âŒ " + e.message);
    console.error("[TOKEN]", e);
  }

  btn.disabled = false; btn.textContent = "ğŸ« Generate Interview Token";
}

function copyInviteEmail() {
  if (!_lastToken) return;
  const t = _lastToken;
  const msg = `Subject: Interview Invitation â€” ${t.role}\n\nDear ${t.name},\n\nYou have been shortlisted for ${t.role} (${t.level}).\n\nPlease complete your AI interview:\n${t.url}\n\nQuestions: ${t.questions}\nType: ${t.type === "real" ? "Proctored" : "Practice"}\nExpires: ${t.expires.toLocaleString()}\n\nBest regards,\nSimpatico HR`;
  copyToClipboard(msg, "Email template");
}

function copyWhatsApp() {
  if (!_lastToken) return;
  const t = _lastToken;
  const msg = `ğŸ¤ *Interview Invitation*\n\nHi ${t.name}! You're shortlisted for *${t.role}* (${t.level}).\n\nğŸ”— ${t.url}\n\nğŸ“‹ ${t.questions}Q â€¢ ${t.type === "real" ? "ğŸ”’ Proctored" : "ğŸ¯ Practice"}\nâ° Expires: ${t.expires.toLocaleDateString()}\n\nâ€” Simpatico HR`;
  copyToClipboard(msg, "WhatsApp message");
}

async function loadTokens(filter) {
  const el = document.getElementById("allTokensList");
  el.innerHTML = '<span class="loading"></span> Loading...';

  try {
    const data = await api("POST", "/db", {
      action: "select",
      table: "interviews",
      order: "created_at.desc"
    });

    let arr = Array.isArray(data) ? data : [];
    const now = new Date();

    if (filter === "expired") arr = arr.filter(i => i.expires_at && new Date(i.expires_at) < now && i.status !== "completed");
    else if (filter && filter !== "all") arr = arr.filter(i => i.status === filter);

    if (!arr.length) {
      el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ«</div>No tokens found</div>';
      return;
    }

    el.innerHTML = arr.slice(0, 50).map(i => {
      const exp = i.expires_at ? new Date(i.expires_at) : null;
      const isExpired = exp && exp < now && i.status !== "completed";
      const sc = { pending: "#f59e0b", in_progress: "#3b82f6", completed: "#10b981" }[i.status] || "#94a3b8";
      const sb = { pending: "rgba(245,158,11,.15)", in_progress: "rgba(59,130,246,.15)", completed: "rgba(16,185,129,.15)" }[i.status] || "rgba(255,255,255,.05)";
      const url = window.location.origin + "/evalis-platform.html?token=" + i.token;

      return `<div style="padding:12px;border-bottom:1px solid var(--border);${isExpired ? "opacity:.5;" : ""}">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
          <div>
            <div style="font-weight:700;font-size:.9rem;">${esc(i.candidate_name || i.interview_role || "?")}</div>
            <div style="font-size:.72rem;color:var(--muted);">
              ${esc(i.interview_role || "")} â€¢ ${esc(i.interview_level || "")} â€¢
              ${i.token ? i.token.substring(0, 12) + "..." : ""} â€¢
              ${i.created_at ? timeAgo(i.created_at) : ""}
            </div>
          </div>
          <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
            ${i.overall_score ? `<span class="score-badge" style="background:rgba(16,185,129,.15);color:${i.overall_score >= 70 ? "#10b981" : i.overall_score >= 50 ? "#f59e0b" : "#ef4444"};">${i.overall_score}/100</span>` : ""}
            <span class="status-pill" style="background:${isExpired ? "rgba(239,68,68,.15)" : sb};color:${isExpired ? "#ef4444" : sc};">${isExpired ? "Expired" : i.status || "?"}</span>
          </div>
        </div>
        <div style="display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;">
          <button class="btn btn-sm btn-accent" onclick="copyToClipboard('${url}','URL')">ğŸ“‹ URL</button>
          <button class="btn btn-sm badge-yellow" onclick="copyToClipboard('${i.token}','Token')">ğŸ”‘</button>
          ${i.status === "completed" ? `<button class="btn btn-sm btn-blue" onclick="viewTokenResult('${i.id}')">ğŸ“Š</button>` : ""}
          <button class="btn btn-sm btn-danger" onclick="deleteToken('${i.id}')">ğŸ—‘</button>
        </div>
      </div>`;
    }).join("");
  } catch (e) {
    el.innerHTML = '<div style="color:var(--red);padding:12px;">âŒ ' + esc(e.message) + '</div>';
  }
}

async function viewTokenResult(id) {
  try {
    const data = await api("POST", "/db", {
      action: "select", table: "interviews", filters: { id }
    });
    const i = Array.isArray(data) ? data[0] : data;
    if (!i) { toast("âŒ Not found"); return; }
    alert(
      `ğŸ“Š Interview Result\n\n` +
      `ğŸ¯ Role: ${i.interview_role || "?"}\n` +
      `ğŸ‘¤ Candidate: ${i.candidate_name || "?"}\n` +
      `ğŸ“Š Score: ${i.overall_score || "?"}/100\n` +
      `ğŸ·ï¸ Grade: ${i.grade || "?"}\n` +
      `ğŸ’¡ Recommendation: ${i.recommendation || "?"}\n\n` +
      `ğŸ“ Summary:\n${i.summary || "N/A"}\n\n` +
      `âš ï¸ Violations: ${i.violation_count || 0}\n` +
      `â±ï¸ Duration: ${i.duration_seconds ? Math.round(i.duration_seconds / 60) + "m" : "?"}`
    );
  } catch (e) { toast("âŒ " + e.message); }
}

async function deleteToken(id) {
  if (!confirm("Delete this interview token?")) return;
  try {
    await api("POST", "/db", { action: "delete", table: "interviews", filters: { id } });
    toast("ğŸ—‘ï¸ Deleted");
    loadTokens("all");
  } catch (e) { toast("âŒ " + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOBS â€” View all jobs across clients
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadJobs() {
  const el = document.getElementById("adminJobsList");
  el.innerHTML = '<span class="loading"></span>';
  try {
    const data = await api("POST", "/db", {
      action: "select", table: "jobs", order: "created_at.desc"
    });
    const arr = Array.isArray(data) ? data : [];
    if (!arr.length) { el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’¼</div>No jobs</div>'; return; }

    el.innerHTML = arr.map(j => `<div style="padding:12px;border-bottom:1px solid var(--border);">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
        <div>
          <div style="font-weight:700;color:var(--accent);">${esc(j.title)}</div>
          <div style="font-size:.72rem;color:var(--muted);">
            ğŸ“ ${esc(j.location || "Remote")} â€¢ ğŸ’¼ ${esc(j.job_type || "")} â€¢ ğŸ“Š ${esc(j.level || "")} â€¢ ğŸ“ ${j.applications_count || 0} apps
          </div>
        </div>
        <span class="status-pill ${j.is_active ? 'badge-green' : 'badge-red'}">${j.is_active ? "Active" : "Off"}</span>
      </div>
    </div>`).join("");
  } catch (e) { el.innerHTML = '<div style="color:var(--red);">âŒ ' + esc(e.message) + '</div>'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLICATIONS â€” View all
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadApps() {
  const el = document.getElementById("adminAppsList");
  el.innerHTML = '<span class="loading"></span>';
  try {
    const data = await api("POST", "/db", {
      action: "select", table: "applications", order: "created_at.desc"
    });
    const arr = Array.isArray(data) ? data : [];
    if (!arr.length) { el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div>No applications</div>'; return; }

    const statusColors = {
      applied: "yellow", screened: "blue", shortlisted: "purple",
      interviewed: "purple", hired: "green", rejected: "red"
    };

    el.innerHTML = arr.slice(0, 50).map(c => {
      const sc = c.ats_score || 0;
      const scCol = sc >= 70 ? "#10b981" : sc >= 50 ? "#f59e0b" : sc > 0 ? "#ef4444" : "#94a3b8";
      return `<div class="cand-row">
        <div style="display:flex;align-items:center;gap:8px;flex:1;">
          <div class="cand-avatar">${(c.candidate_name || c.name || "?")[0].toUpperCase()}</div>
          <div>
            <div style="font-weight:700;font-size:.88rem;">${esc(c.candidate_name || c.name || "?")}</div>
            <div style="font-size:.72rem;color:var(--muted);">${esc(c.candidate_email || c.email || "")} â€¢ ${timeAgo(c.created_at)}</div>
          </div>
        </div>
        <div style="display:flex;gap:4px;align-items:center;">
          ${sc ? `<span class="score-badge" style="background:rgba(16,185,129,.1);color:${scCol};">ATS:${sc}</span>` : ""}
          <span class="status-pill badge-${statusColors[c.status] || 'blue'}">${c.status || "?"}</span>
        </div>
      </div>`;
    }).join("");
  } catch (e) { el.innerHTML = '<div style="color:var(--red);">âŒ ' + esc(e.message) + '</div>'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings() {
  const el = document.getElementById("systemInfo");
  try {
    const h = await api("GET", "/health");
    el.innerHTML = `
      <div style="font-size:.85rem;line-height:2;">
        <div>âœ… <strong>API:</strong> ${API}</div>
        <div>ğŸ“¦ <strong>Version:</strong> ${h.version || "?"}</div>
        <div>${h.supabase ? "âœ…" : "âŒ"} <strong>Supabase:</strong> ${h.supabase ? "Connected" : "Not configured"}</div>
        <div>${h.groq ? "âœ…" : "âŒ"} <strong>Groq AI:</strong> ${h.groq ? "Available" : "Not configured"}</div>
        <div>${h.ai ? "âœ…" : "âŒ"} <strong>CF Workers AI:</strong> ${h.ai ? "Available" : "Not configured"}</div>
        <div>${h.resend ? "âœ…" : "âŒ"} <strong>Resend Email:</strong> ${h.resend ? "Configured" : "Not configured"}</div>
        <div>ğŸ• <strong>Server Time:</strong> ${h.time || "?"}</div>
      </div>`;
  } catch (e) {
    el.innerHTML = `<div style="color:var(--red);">âŒ Cannot reach server: ${esc(e.message)}</div>`;
  }
}

async function changePassword() {
  const cur = document.getElementById("set_curPass").value.trim();
  const newP = document.getElementById("set_newPass").value.trim();
  if (!cur || !newP) { toast("âŒ Fill both fields"); return; }
  if (newP.length < 6) { toast("âŒ Min 6 characters"); return; }

  try {
    await api("POST", "/auth/password", { current: cur, password: newP });
    toast("âœ… Password changed!");
    document.getElementById("set_curPass").value = "";
    document.getElementById("set_newPass").value = "";
  } catch (e) { toast("âŒ " + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportData() {
  toast("ğŸ“¥ Exporting...");
  try {
    const [stats, clients, users] = await Promise.all([
      api("GET", "/admin/stats").catch(() => ({})),
      api("GET", "/admin/clients").catch(() => ({ clients: [] })),
      api("GET", "/admin/users").catch(() => ({ users: [] }))
    ]);
    const data = {
      exported: new Date().toISOString(),
      stats, clients: clients.clients, users: users.users
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "simpatico-admin-export-" + Date.now() + ".json";
    a.click(); URL.revokeObjectURL(url);
    toast("âœ… Exported!");
  } catch (e) { toast("âŒ " + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEALTH CHECK + INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkHealth() {
  const el = document.getElementById("healthStatus");
  try {
    const h = await fetch(API + "/health");
    if (h.ok) {
      const d = await h.json();
      el.innerHTML = `<span style="color:var(--green);">âœ… Server v${d.version || "?"} â€” ${d.status}</span>`;
    } else {
      el.innerHTML = `<span style="color:var(--red);">âŒ Server error (${h.status})</span>`;
    }
  } catch (e) {
    el.innerHTML = `<span style="color:var(--red);">âŒ Cannot reach ${API}</span>`;
  }
}

window.addEventListener("DOMContentLoaded", () => {
  checkHealth();
  if (!checkSavedAuth()) {
    document.getElementById("loginEmail")?.focus();
  }
});
</script>
</body>
</html>
