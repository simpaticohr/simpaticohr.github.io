<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin | Simpatico HR</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#020617;--card:rgba(15,23,42,.65);--border:rgba(255,255,255,.08);--accent:#6366f1;--accent2:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;--text:#f8fafc;--muted:#94a3b8;--glow:rgba(99,102,241,.15)}
    body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:radial-gradient(circle at 10% 20%,rgba(99,102,241,.15),transparent 40%),radial-gradient(circle at 90% 80%,rgba(79,70,229,.1),transparent 40%),var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
    .top-nav{backdrop-filter:blur(16px);background:rgba(2,6,23,.85);padding:1rem 6%;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .top-logo{font-weight:800;font-size:1.1rem;color:#fff;text-decoration:none}.top-logo span{color:var(--accent)}
    .top-links{display:flex;gap:12px;align-items:center}
    .top-link{color:var(--muted);text-decoration:none;font-size:12px;font-weight:600;padding:6px 12px;border-radius:8px;transition:all 0.2s}
    .top-link:hover{color:#fff;background:rgba(255,255,255,.05)}
    .container{max-width:900px;margin:0 auto;padding:20px}
    .login-card{max-width:400px;margin:80px auto;background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px;text-align:center;backdrop-filter:blur(22px)}
    .login-card h1{font-size:1.5rem;margin-bottom:8px;background:linear-gradient(135deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .login-card p{color:var(--muted);font-size:0.88rem;margin-bottom:24px}
    .login-input{width:100%;padding:14px 16px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:1rem;outline:none;font-family:inherit;margin-bottom:16px;text-align:center;letter-spacing:2px}
    .login-input:focus{border-color:rgba(245,158,11,.4);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
    .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#f59e0b,#ef4444);border:none;border-radius:14px;color:#fff;font-size:1rem;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.2s}
    .login-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(245,158,11,.3)}
    .login-error{color:var(--red);font-size:0.85rem;margin-top:12px;display:none}
    .admin-wrap{display:none}
    .admin-header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px}
    .admin-header h1{font-size:1.4rem;background:linear-gradient(135deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .admin-tabs{display:flex;gap:0;background:rgba(255,255,255,.03);border-radius:14px;padding:4px;border:1px solid var(--border);margin-bottom:20px;flex-wrap:wrap}
    .admin-tab{flex:1;padding:10px 6px;text-align:center;border:none;background:transparent;color:var(--muted);font-size:0.72rem;font-weight:700;cursor:pointer;border-radius:10px;transition:all 0.2s;font-family:inherit;min-width:70px}
    .admin-tab.active{background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff}
    .admin-tab:hover:not(.active){background:rgba(245,158,11,.1)}
    .card{background:var(--card);backdrop-filter:blur(22px);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
    .card h3{font-size:0.95rem;margin-bottom:14px;display:flex;align-items:center;gap:8px;color:#f59e0b}
    label{display:block;font-size:0.78rem;color:var(--muted);margin:12px 0 4px;font-weight:600}
    select,input[type="text"],input[type="email"],input[type="number"],input[type="password"],input[type="date"],textarea{width:100%;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;outline:none;transition:border-color 0.2s;font-family:inherit}
    select:focus,input:focus,textarea:focus{border-color:rgba(245,158,11,.4);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
    select option{background:#1e293b}
    textarea{resize:vertical;min-height:60px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
    .stat-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .stat-num{font-size:1.6rem;font-weight:800}.stat-lbl{font-size:0.7rem;color:var(--muted)}
    .edit-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);flex-wrap:wrap}.edit-row:last-child{border-bottom:none}
    .edit-label{font-size:0.8rem;color:var(--muted);min-width:140px;font-weight:600}
    .edit-input{flex:1;padding:8px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;font-family:inherit;outline:none;min-width:200px}
    .edit-input:focus{border-color:rgba(245,158,11,.4)}
    .edit-color{width:40px;height:32px;border:none;border-radius:6px;cursor:pointer;background:transparent}
    .edit-preview{font-size:0.75rem;color:var(--muted);padding:2px 8px;background:rgba(255,255,255,.03);border-radius:6px}
    .pay-table{width:100%;border-collapse:collapse;font-size:0.82rem}.pay-table th{text-align:left;padding:8px;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border);font-size:0.75rem}.pay-table td{padding:8px;border-bottom:1px solid var(--border)}
    .toggle-switch{position:relative;width:44px;height:24px;background:rgba(255,255,255,.1);border-radius:12px;cursor:pointer;transition:all 0.3s;flex-shrink:0}
    .toggle-switch.on{background:var(--green)}.toggle-switch::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:all 0.3s}.toggle-switch.on::after{left:23px}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-size:0.82rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s;color:#fff}
    .btn-save{background:linear-gradient(135deg,#10b981,#059669)}.btn-danger{background:rgba(239,68,68,.15);color:var(--red)}.btn-primary{background:linear-gradient(135deg,#f59e0b,#ef4444)}.btn-accent{background:var(--accent)}.btn-full{width:100%;padding:14px;font-size:1rem;border-radius:14px}
    .btn:hover{transform:translateY(-1px)}
    .status-pill{padding:2px 8px;border-radius:10px;font-size:0.72rem;font-weight:700;display:inline-block}
    .score-badge{padding:2px 8px;border-radius:8px;font-size:0.75rem;font-weight:700;display:inline-block}
    .activity-log{max-height:250px;overflow-y:auto;font-size:0.78rem;color:var(--muted);background:rgba(0,0,0,.3);border-radius:10px;padding:10px}
    .activity-log div{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.03)}
    .cand-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);gap:8px;flex-wrap:wrap}.cand-row:last-child{border-bottom:none}
    .cand-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.8rem;flex-shrink:0}
    .toast-box{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:rgba(15,23,42,.9);backdrop-filter:blur(12px);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:12px;font-size:0.85rem;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:tIn .3s ease,tOut .3s ease 2.7s forwards}
    @keyframes tIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(120%);opacity:0}}
    .hidden{display:none!important}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .job-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:10px;cursor:pointer;transition:all 0.2s}
    .job-card:hover{border-color:rgba(99,102,241,.3)}
    .job-card h4{font-size:0.95rem;margin-bottom:4px;color:var(--accent)}
    .job-meta{font-size:0.78rem;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .token-display{background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:10px;padding:12px;font-family:monospace;font-size:0.82rem;word-break:break-all;margin:8px 0;cursor:pointer;transition:all 0.2s}
    .token-display:hover{border-color:var(--accent);background:rgba(99,102,241,.05)}
    .token-display:active{transform:scale(0.98)}
    .usage-bar{height:6px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden;margin-top:4px}
    .usage-fill{height:100%;border-radius:3px;transition:width 0.5s}
    .invite-card{background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:16px;margin-bottom:10px}
    .invite-card h4{color:var(--accent);font-size:0.9rem;margin-bottom:6px}
    .copy-box{display:flex;gap:8px;align-items:center;margin-top:8px}
    .copy-input{flex:1;padding:8px 12px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-size:0.78rem;font-family:monospace;outline:none}
    .copy-btn{padding:8px 14px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-weight:700;font-size:0.78rem;cursor:pointer;white-space:nowrap}
    .copy-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px var(--glow)}
    @media(max-width:600px){.stat-grid{grid-template-columns:1fr 1fr}.row2,.row3{grid-template-columns:1fr}.edit-row{flex-direction:column;align-items:flex-start}.edit-input{width:100%}.admin-tab{font-size:0.65rem;min-width:50px;padding:8px 4px}.cand-row{flex-direction:column;align-items:flex-start}.top-nav{padding:1rem 4%}}
  </style>
</head>
<body>
  <div class="toast-box" id="toasts"></div>

  <nav class="top-nav">
    <a class="top-logo" href="evalis-platform.html">SIMPATICO <span>HR</span></a>
    <div class="top-links">
      <a class="top-link" href="evalis-platform.html">ğŸ  Platform</a>
      <a class="top-link" href="career-lab.html">ğŸ§  Career Lab</a>
      <span class="top-link" style="color:var(--yellow);">ğŸ” Admin</span>
    </div>
  </nav>

  <!-- LOGIN -->
  <div id="loginScreen">
    <div class="login-card">
      <div style="font-size:3rem;margin-bottom:12px;">ğŸ”</div>
      <h1>Super Admin</h1>
      <p>Enter password to access</p>
      <input type="password" class="login-input" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="login-btn" onclick="doLogin()">ğŸ”“ Login</button>
      <div class="login-error" id="loginError">âŒ Wrong password</div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="admin-wrap" id="adminWrap">
    <div class="container">
      <div class="admin-header">
        <h1>ğŸ” Super Admin Panel</h1>
        <button class="btn btn-danger" onclick="doLogout()">ğŸšª Logout</button>
      </div>

      <div class="admin-tabs" id="adminTabs">
        <button class="admin-tab active" onclick="showTab('dashboard')">ğŸ“Š Dash</button>
        <button class="admin-tab" onclick="showTab('tokens')">ğŸ« Tokens</button>
        <button class="admin-tab" onclick="showTab('editor')">ğŸ¨ Site</button>
        <button class="admin-tab" onclick="showTab('payments')">ğŸ’³ Pay</button>
        <button class="admin-tab" onclick="showTab('access')">ğŸ”‘ Codes</button>
        <button class="admin-tab" onclick="showTab('clients')">ğŸ¢ Clients</button>
        <button class="admin-tab" onclick="showTab('jobs')">ğŸ’¼ Jobs</button>
        <button class="admin-tab" onclick="showTab('candidates')">ğŸ‘¥ People</button>
        <button class="admin-tab" onclick="showTab('usage')">ğŸ“ˆ Usage</button>
        <button class="admin-tab" onclick="showTab('settings')">âš™ï¸ Set</button>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- DASHBOARD -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-dashboard">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="sRevenue">â‚¹0</div><div class="stat-lbl">Revenue</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#6366f1;" id="sUsers">0</div><div class="stat-lbl">Applications</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="sInterviews">0</div><div class="stat-lbl">Interviews</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#3b82f6;" id="sJobs">0</div><div class="stat-lbl">Jobs</div></div>
        </div>
        <div class="card"><h3>ğŸ“ˆ Activity</h3><div class="activity-log" id="activityLog">Loading...</div></div>
        <div class="card"><h3>âš¡ Quick Actions</h3><div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="showTab('tokens')">ğŸ« Generate Token</button>
          <button class="btn btn-save" onclick="showTab('clients')">ğŸ¢ Add Client</button>
          <button class="btn btn-accent" onclick="showTab('jobs')">ğŸ’¼ Jobs</button>
          <button class="btn" style="background:var(--blue);" onclick="exportAllData()">ğŸ“¥ Export</button>
        </div></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- ğŸ« INTERVIEW TOKEN GENERATOR (NEW/FIXED) -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-tokens" class="hidden">
        <div class="card">
          <h3>ğŸ« Generate Interview Token</h3>
          <p style="font-size:0.82rem;color:var(--muted);margin-bottom:16px;">Create a proctored interview link for any candidate. The token gives one-time access to the AI interview.</p>

          <div class="row2">
            <div><label>Candidate Name *</label><input type="text" id="tk_name" placeholder="John Doe"></div>
            <div><label>Candidate Email *</label><input type="email" id="tk_email" placeholder="john@email.com"></div>
          </div>
          <div class="row2" style="margin-top:4px;">
            <div><label>Job Role *</label>
              <select id="tk_role">
                <option value="">â€” Select Role â€”</option>
                <option value="Frontend Developer">Frontend Developer</option>
                <option value="Backend Developer">Backend Developer</option>
                <option value="Full Stack Developer">Full Stack Developer</option>
                <option value="Mobile Developer">Mobile Developer</option>
                <option value="Data Scientist">Data Scientist</option>
                <option value="DevOps Engineer">DevOps Engineer</option>
                <option value="UI/UX Designer">UI/UX Designer</option>
                <option value="Product Manager">Product Manager</option>
                <option value="QA Engineer">QA Engineer</option>
                <option value="Cybersecurity Analyst">Cybersecurity</option>
                <option value="Sales Representative">Sales</option>
                <option value="Marketing Manager">Marketing</option>
                <option value="HR Recruiter">HR</option>
                <option value="Finance Analyst">Finance</option>
                <option value="Customer Support">Support</option>
                <option value="custom">âœï¸ Custom...</option>
              </select>
            </div>
            <div><label>Level</label>
              <select id="tk_level">
                <option value="Fresher">Fresher</option>
                <option value="Junior">Junior</option>
                <option value="Mid-Level" selected>Mid-Level</option>
                <option value="Senior">Senior</option>
                <option value="Lead">Lead</option>
              </select>
            </div>
          </div>
          <div id="tk_customWrap" class="hidden" style="margin-top:4px;"><label>Custom Role</label><input type="text" id="tk_customRole" placeholder="e.g. Blockchain Developer"></div>
          <div class="row3" style="margin-top:4px;">
            <div><label>Questions</label>
              <select id="tk_questions">
                <option value="5">5</option>
                <option value="8">8</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
              </select>
            </div>
            <div><label>Language</label>
              <select id="tk_lang">
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="ml">Malayalam</option>
                <option value="ta">Tamil</option>
                <option value="te">Telugu</option>
                <option value="ar">Arabic</option>
              </select>
            </div>
            <div><label>Expires In</label>
              <select id="tk_expiry">
                <option value="24">24 Hours</option>
                <option value="48">48 Hours</option>
                <option value="72" selected>72 Hours</option>
                <option value="168">7 Days</option>
                <option value="720">30 Days</option>
              </select>
            </div>
          </div>
          <div class="row2" style="margin-top:4px;">
            <div><label>Interview Type</label>
              <select id="tk_type">
                <option value="real">ğŸ”’ Proctored (Real)</option>
                <option value="mock">ğŸ¯ Mock (Practice)</option>
              </select>
            </div>
            <div><label>Link to Job</label>
              <select id="tk_jobId"><option value="">â€” None â€”</option></select>
            </div>
          </div>

          <button class="btn btn-primary btn-full" onclick="generateToken()" style="margin-top:16px;">ğŸ« Generate Interview Token</button>
        </div>

        <!-- Generated Token Display -->
        <div class="card hidden" id="tokenResultCard">
          <h3>âœ… Token Generated!</h3>
          <div class="invite-card">
            <h4 id="tokenResultName">â€”</h4>
            <div style="font-size:0.78rem;color:var(--muted);" id="tokenResultMeta">â€”</div>
            <div class="copy-box">
              <input class="copy-input" id="tokenResultUrl" readonly>
              <button class="copy-btn" onclick="copyTokenUrl()">ğŸ“‹ Copy</button>
            </div>
            <div class="token-display" id="tokenResultToken" onclick="copyTokenRaw()" title="Click to copy token">â€”</div>
            <div style="font-size:0.72rem;color:var(--muted);margin-top:8px;">
              <span id="tokenResultExpiry">â€”</span>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button class="btn btn-accent" onclick="copyInviteEmail()" style="flex:1;">ğŸ“§ Copy Email Template</button>
            <button class="btn btn-save" onclick="copyWhatsApp()" style="flex:1;">ğŸ’¬ Copy WhatsApp</button>
          </div>
        </div>

        <!-- Bulk Token Generator -->
        <div class="card">
          <h3>ğŸ“¦ Bulk Generate</h3>
          <p style="font-size:0.82rem;color:var(--muted);margin-bottom:12px;">Paste emails (one per line) to generate tokens for multiple candidates at once.</p>
          <label>Emails (one per line)</label>
          <textarea id="tk_bulkEmails" placeholder="john@email.com&#10;jane@email.com&#10;bob@email.com" style="min-height:100px;"></textarea>
          <div class="row2" style="margin-top:4px;">
            <div><label>Role for all</label><input type="text" id="tk_bulkRole" placeholder="Frontend Developer"></div>
            <div><label>Level for all</label>
              <select id="tk_bulkLevel">
                <option value="Mid-Level" selected>Mid-Level</option>
                <option value="Fresher">Fresher</option>
                <option value="Junior">Junior</option>
                <option value="Senior">Senior</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary btn-full" onclick="bulkGenerateTokens()" style="margin-top:12px;">ğŸ“¦ Generate All Tokens</button>
          <div id="bulkResults" class="hidden" style="margin-top:12px;"></div>
        </div>

        <!-- All Tokens -->
        <div class="card">
          <h3>ğŸ“‹ All Interview Tokens</h3>
          <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
            <button class="btn btn-accent" style="padding:6px 12px;font-size:0.75rem;" onclick="filterTokens('all')">All</button>
            <button class="btn" style="padding:6px 12px;font-size:0.75rem;background:rgba(245,158,11,.15);color:#f59e0b;" onclick="filterTokens('pending')">Pending</button>
            <button class="btn" style="padding:6px 12px;font-size:0.75rem;background:rgba(59,130,246,.15);color:#3b82f6;" onclick="filterTokens('in_progress')">In Progress</button>
            <button class="btn" style="padding:6px 12px;font-size:0.75rem;background:rgba(16,185,129,.15);color:#10b981;" onclick="filterTokens('completed')">Completed</button>
            <button class="btn" style="padding:6px 12px;font-size:0.75rem;background:rgba(239,68,68,.15);color:#ef4444;" onclick="filterTokens('expired')">Expired</button>
          </div>
          <div id="allTokensList"><span class="loading"></span> Loading...</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- EDITOR -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-editor" class="hidden">
        <div class="card"><h3>ğŸ·ï¸ Branding</h3>
          <div class="edit-row"><span class="edit-label">Site Title</span><input class="edit-input" id="ed_title" value="AI Interview Platform" onchange="saveSiteConfig()"></div>
          <div class="edit-row"><span class="edit-label">Subtitle</span><input class="edit-input" id="ed_subtitle" value="Intelligent â€¢ Adaptive â€¢ Proctored" onchange="saveSiteConfig()"></div>
          <div class="edit-row"><span class="edit-label">Company</span><input class="edit-input" id="ed_company" value="SIMPATICO HR" onchange="saveSiteConfig()"></div>
        </div>
        <div class="card"><h3>ğŸ¨ Colors</h3>
          <div class="edit-row"><span class="edit-label">Primary</span><input type="color" class="edit-color" id="ed_primary" value="#6366f1" onchange="saveSiteConfig()"><span class="edit-preview">#6366f1</span></div>
          <div class="edit-row"><span class="edit-label">Secondary</span><input type="color" class="edit-color" id="ed_secondary" value="#8b5cf6" onchange="saveSiteConfig()"><span class="edit-preview">#8b5cf6</span></div>
          <div class="edit-row"><span class="edit-label">Success</span><input type="color" class="edit-color" id="ed_success" value="#10b981" onchange="saveSiteConfig()"><span class="edit-preview">#10b981</span></div>
          <div class="edit-row"><span class="edit-label">Background</span><input type="color" class="edit-color" id="ed_bg" value="#020617" onchange="saveSiteConfig()"><span class="edit-preview">#020617</span></div>
        </div>
        <div class="card"><h3>ğŸ”¤ Font & Style</h3>
          <div class="edit-row"><span class="edit-label">Font</span><select class="edit-input" id="ed_font" onchange="saveSiteConfig()"><option value="'Plus Jakarta Sans',system-ui,sans-serif">Jakarta Sans</option><option value="'Inter',system-ui,sans-serif">Inter</option><option value="'Poppins',system-ui,sans-serif">Poppins</option><option value="system-ui,sans-serif">System</option></select></div>
          <div class="edit-row"><span class="edit-label">Radius</span><input type="range" class="edit-input" id="ed_radius" min="0" max="30" step="2" value="20" style="max-width:200px;" oninput="document.getElementById('rv').textContent=this.value+'px'" onchange="saveSiteConfig()"><span class="edit-preview" id="rv">20px</span></div>
        </div>
        <div class="card"><h3>ğŸ“¢ Banner</h3>
          <div class="edit-row"><span class="edit-label">Show</span><div class="toggle-switch" id="tog_banner" onclick="toggleSwitch(this);saveSiteConfig()"></div><span class="edit-preview">Off</span></div>
          <div class="edit-row"><span class="edit-label">Text</span><input class="edit-input" id="ed_bannerText" value="ğŸ‰ AI Mock Interviews now available!" onchange="saveSiteConfig()"></div>
          <div class="edit-row"><span class="edit-label">Color</span><input type="color" class="edit-color" id="ed_bannerColor" value="#6366f1" onchange="saveSiteConfig()"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:16px;">
          <button class="btn btn-save btn-full" onclick="saveSiteConfig();toast('ğŸ’¾ Published!')">ğŸ’¾ Save & Publish</button>
          <button class="btn btn-danger" style="padding:14px;" onclick="resetSiteConfig()">ğŸ”„ Reset</button>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAYMENTS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-payments" class="hidden">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="pTotal">â‚¹0</div><div class="stat-lbl">Revenue</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#6366f1;" id="pCount">0</div><div class="stat-lbl">Total</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="pPending">0</div><div class="stat-lbl">Pending</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#3b82f6;" id="pActive">0</div><div class="stat-lbl">Active</div></div>
        </div>
        <div class="card"><h3>ğŸ’° Pricing</h3>
          <div class="edit-row"><span class="edit-label">Mock Price (â‚¹)</span><input class="edit-input" type="number" id="ed_price" value="199" style="max-width:120px;"></div>
          <div class="edit-row"><span class="edit-label">Duration</span><select class="edit-input" id="ed_days" style="max-width:160px;"><option value="7">7 days</option><option value="30" selected>30 days</option><option value="90">90 days</option><option value="365">1 year</option></select></div>
          <div class="edit-row"><span class="edit-label">Mock Paid</span><div class="toggle-switch on" id="tog_paid" onclick="toggleSwitch(this)"></div><span class="edit-preview">On</span></div>
          <button class="btn btn-save" onclick="savePricing()" style="margin-top:10px;">ğŸ’¾ Save</button>
        </div>
        <div class="card"><h3>ğŸ¦ Gateway</h3>
          <div class="edit-row"><span class="edit-label">Razorpay Key</span><input class="edit-input" type="password" id="ed_razorKey" placeholder="rzp_live_xxxx"></div>
          <div class="edit-row"><span class="edit-label">UPI ID</span><input class="edit-input" id="ed_upiId" placeholder="your@upi"></div>
          <button class="btn btn-save" onclick="saveGateway()" style="margin-top:10px;">ğŸ’¾ Save</button>
        </div>
        <div class="card"><h3>ğŸ“œ History</h3><div style="overflow-x:auto;"><table class="pay-table"><thead><tr><th>Date</th><th>User</th><th>Amount</th><th>Type</th><th>Status</th><th>Act</th></tr></thead><tbody id="payHistory"><tr><td colspan="6" style="text-align:center;color:var(--muted);">Loading...</td></tr></tbody></table></div></div>
        <div class="card"><h3>âœ‹ Manual Payment</h3>
          <div class="row2"><div><label>Email *</label><input type="email" id="mp_email" placeholder="user@email.com"></div><div><label>Amount</label><input type="number" id="mp_amount" value="199"></div></div>
          <div class="row2" style="margin-top:4px;"><div><label>Days</label><input type="number" id="mp_days" value="30"></div><div><label>Note</label><input type="text" id="mp_note" placeholder="UPI / Cash"></div></div>
          <button class="btn btn-save btn-full" onclick="addManualPayment()" style="margin-top:12px;">âœ… Add Payment</button>
        </div>
      </div>

      <!-- ACCESS CODES -->
      <div id="tab-access" class="hidden">
        <div class="card"><h3>ğŸ”‘ Generate Code</h3>
          <div class="row2"><div><label>Code *</label><input type="text" id="ac_code" placeholder="CAMPUS2025"></div><div><label>Max Uses</label><input type="number" id="ac_max" value="50"></div></div>
          <div class="row2" style="margin-top:4px;"><div><label>Days</label><input type="number" id="ac_days" value="30"></div><div><label>Expires</label><input type="date" id="ac_expiry"></div></div>
          <div style="display:flex;gap:8px;margin-top:12px;"><button class="btn btn-save" style="flex:1;padding:12px;" onclick="genCode()">ğŸ”‘ Generate</button><button class="btn btn-primary" style="padding:12px;" onclick="genRandom()">ğŸ² Random</button></div>
        </div>
        <div class="card"><h3>ğŸ“‹ All Codes</h3><div id="codesList">Loading...</div></div>
      </div>

      <!-- CLIENTS -->
      <div id="tab-clients" class="hidden">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="clTotal">0</div><div class="stat-lbl">Total</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#6366f1;" id="clActive">0</div><div class="stat-lbl">Active</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="clExpiring">0</div><div class="stat-lbl">Expiring</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#ef4444;" id="clExpired">0</div><div class="stat-lbl">Expired</div></div>
        </div>
        <div class="card"><h3>ğŸ¢ Add Client (Quick)</h3>
          <div class="row2"><div><label>Company *</label><input type="text" id="cl_name" placeholder="TCS, Infosys"></div><div><label>Email *</label><input type="email" id="cl_email" placeholder="hr@company.com"></div></div>
          <div class="row2" style="margin-top:4px;"><div><label>Plan</label><select id="cl_plan"><option value="starter">Starter â‚¹999</option><option value="professional" selected>Pro â‚¹2,999</option><option value="enterprise">Enterprise â‚¹9,999</option></select></div><div><label>Duration</label><select id="cl_duration"><option value="30">1 Month</option><option value="90">3 Months</option><option value="365" selected>1 Year</option></select></div></div>
          <div class="row2" style="margin-top:4px;"><div><label>Amount Paid</label><input type="number" id="cl_amount" value="2999"></div><div><label>Payment</label><select id="cl_payMethod"><option value="razorpay">Razorpay</option><option value="bank">Bank</option><option value="upi">UPI</option><option value="free">Free Trial</option></select></div></div>
          <button class="btn btn-save btn-full" onclick="addClient()" style="margin-top:12px;">ğŸ¢ Add Client</button>
        </div>
        <div class="card"><h3>ğŸ“‹ All Clients</h3><div id="clientsList">Loading...</div></div>
      </div>

      <!-- JOBS -->
      <div id="tab-jobs" class="hidden"><div class="card"><h3>ğŸ’¼ All Jobs</h3><div id="adminJobsList"><span class="loading"></span></div></div></div>

      <!-- CANDIDATES -->
      <div id="tab-candidates" class="hidden">
        <div class="card"><h3>ğŸ‘¥ Applications</h3><div id="adminCandList"><span class="loading"></span></div></div>
        <div class="card"><h3>ğŸ¤ Interviews</h3><div id="adminIntList"><span class="loading"></span></div></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- ğŸ“ˆ USAGE ANALYTICS (NEW) -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="tab-usage" class="hidden">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" style="color:#10b981;" id="uToday">0</div><div class="stat-lbl">Today</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#6366f1;" id="uWeek">0</div><div class="stat-lbl">This Week</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#f59e0b;" id="uMonth">0</div><div class="stat-lbl">This Month</div></div>
          <div class="stat-card"><div class="stat-num" style="color:#3b82f6;" id="uTotal">0</div><div class="stat-lbl">All Time</div></div>
        </div>
        <div class="card">
          <h3>ğŸ“Š Interview Analytics</h3>
          <div id="usageBreakdown">Loading...</div>
        </div>
        <div class="card">
          <h3>ğŸŒ API Usage</h3>
          <div id="apiUsage">
            <div class="edit-row"><span class="edit-label">Puter.js (Free)</span><span class="edit-preview" id="apiPuter">â€”</span></div>
            <div class="edit-row"><span class="edit-label">Groq (Free tier)</span><span class="edit-preview" id="apiGroq">â€”</span></div>
            <div class="edit-row"><span class="edit-label">Cloudflare Workers</span><span class="edit-preview" id="apiCF">â€”</span></div>
          </div>
        </div>
        <div class="card">
          <h3>ğŸ‘¥ Top Candidates</h3>
          <div id="topCandidates">Loading...</div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div id="tab-settings" class="hidden">
        <div class="card"><h3>ğŸ” Passwords</h3>
          <div class="edit-row"><span class="edit-label">Admin Pass</span><input class="edit-input" type="password" id="set_adminPass" placeholder="Min 6 chars"><button class="btn btn-primary" onclick="changeAdminPass()" style="margin-left:8px;">Change</button></div>
          <div class="edit-row"><span class="edit-label">HR Pass</span><input class="edit-input" type="password" id="set_hrPass" placeholder="Min 4 chars"><button class="btn btn-primary" onclick="changeHRPass()" style="margin-left:8px;">Change</button></div>
        </div>
        <div class="card"><h3>âš™ï¸ Platform</h3>
          <div class="edit-row"><span class="edit-label">Worker URL</span><input class="edit-input" id="set_worker" value="https://evalis-ai.simpaticohrconsultancy.workers.dev"></div>
          <div class="edit-row"><span class="edit-label">Max Violations</span><input class="edit-input" type="number" id="set_violations" value="3" style="max-width:100px;"></div>
          <div class="edit-row"><span class="edit-label">Maintenance</span><div class="toggle-switch" id="tog_maint" onclick="toggleSwitch(this)"></div><span class="edit-preview">Off</span></div>
          <button class="btn btn-save btn-full" onclick="savePlatformSettings()" style="margin-top:12px;">ğŸ’¾ Save</button>
        </div>
        <div class="card"><h3>ğŸ—ƒï¸ Data</h3><div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="exportAllData()">ğŸ“¥ Export</button>
          <button class="btn btn-accent" onclick="importData()">ğŸ“¤ Import</button>
          <button class="btn btn-danger" onclick="dangerReset()">âš ï¸ Reset All</button>
        </div></div>
      </div>

    </div>
  </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ADMIN_DEFAULT="superadmin@2025";
const W_DEFAULT="https://evalis-ai.simpaticohrconsultancy.workers.dev";
function getConfig(k,fb){try{return JSON.parse(localStorage.getItem("adminConfig")||"{}")[k]??fb}catch(e){return fb}}
function setConfig(k,v){try{const c=JSON.parse(localStorage.getItem("adminConfig")||"{}");c[k]=v;localStorage.setItem("adminConfig",JSON.stringify(c))}catch(e){}}
function getW(){return getConfig('workerUrl',W_DEFAULT)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function db(a,t,d=null,f=null,s=null,o=null){
  const r=await fetch(getW()+"/db",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:a,table:t,data:d,filters:f,select:s,order:o})});
  return await r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(m){const c=document.getElementById("toasts"),t=document.createElement("div");t.className="toast";t.textContent=m;c.appendChild(t);setTimeout(()=>t.remove(),3200)}
function toggleSwitch(el){el.classList.toggle('on');const n=el.nextElementSibling;if(n?.classList.contains('edit-preview'))n.textContent=el.classList.contains('on')?'On':'Off'}
function genUUID(){return crypto.randomUUID?crypto.randomUUID():(Date.now().toString(36)+'-'+Math.random().toString(36).substring(2,10)+'-'+Math.random().toString(36).substring(2,6))}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin(){
  const pwd=document.getElementById('loginPass').value;
  if(pwd===getConfig('adminPassword',ADMIN_DEFAULT)){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('adminWrap').style.display='block';
    setConfig('lastLogin',new Date().toISOString());
    loadDashboard();toast('âœ… Welcome, Admin!');
  }else{
    document.getElementById('loginError').style.display='block';
    setTimeout(()=>document.getElementById('loginError').style.display='none',3000);
  }
}
function doLogout(){
  document.getElementById('adminWrap').style.display='none';
  document.getElementById('loginScreen').style.display='block';
  document.getElementById('loginPass').value='';toast('ğŸšª Logged out');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(tab){
  const tabs=['dashboard','tokens','editor','payments','access','clients','jobs','candidates','usage','settings'];
  tabs.forEach(t=>document.getElementById('tab-'+t)?.classList.add('hidden'));
  document.getElementById('tab-'+tab)?.classList.remove('hidden');
  document.querySelectorAll('.admin-tab').forEach((b,i)=>b.classList.toggle('active',tabs[i]===tab));
  if(tab==='dashboard')loadDashboard();
  if(tab==='tokens')loadTokens();
  if(tab==='payments')loadPayments();
  if(tab==='access')loadCodes();
  if(tab==='clients')loadClients();
  if(tab==='jobs')loadAdminJobs();
  if(tab==='candidates')loadAdminCandidates();
  if(tab==='usage')loadUsageAnalytics();
  if(tab==='settings')loadSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard(){
  try{
    const[pay,apps,ints,jobs]=await Promise.all([db('select','payments').catch(()=>[]),db('select','applications').catch(()=>[]),db('select','interviews').catch(()=>[]),db('select','jobs').catch(()=>[])]);
    const pa=Array.isArray(pay)?pay:[];const aa=Array.isArray(apps)?apps:[];const ia=Array.isArray(ints)?ints:[];const ja=Array.isArray(jobs)?jobs:[];
    const rev=pa.filter(p=>p.status==='completed').reduce((s,p)=>s+(p.amount||0),0);
    document.getElementById('sRevenue').textContent='â‚¹'+rev.toLocaleString();
    document.getElementById('sUsers').textContent=aa.length;
    document.getElementById('sInterviews').textContent=ia.length;
    document.getElementById('sJobs').textContent=ja.length;
    const log=document.getElementById('activityLog');
    const items=[...aa.map(a=>({t:a.created_at,m:`ğŸ“ ${a.name||'?'} applied${a.ats_score?' (ATS:'+a.ats_score+')':''}`})),...ia.map(i=>({t:i.started_at||i.created_at,m:`ğŸ¤ ${i.interview_role||'?'}: ${i.status} ${i.overall_score?'('+i.overall_score+'/100)':''}`})),...pa.map(p=>({t:p.created_at,m:`ğŸ’³ â‚¹${p.amount} ${p.type||''}: ${p.status}`}))].sort((a,b)=>new Date(b.t||0)-new Date(a.t||0)).slice(0,30);
    log.innerHTML=items.length?items.map(i=>`<div><span style="font-size:0.7rem;color:var(--muted);">${i.t?new Date(i.t).toLocaleString():'?'}</span> ${i.m}</div>`).join(''):'<div>No activity yet</div>';
  }catch(e){console.error(e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ« TOKEN GENERATION (FIXED & COMPLETE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastGeneratedToken=null;

document.getElementById('tk_role')?.addEventListener('change',e=>{
  document.getElementById('tk_customWrap').classList.toggle('hidden',e.target.value!=='custom');
});

async function loadTokenJobs(){
  try{
    const data=await db('select','jobs',null,{is_active:true});
    const arr=Array.isArray(data)?data:[];
    const sel=document.getElementById('tk_jobId');
    sel.innerHTML='<option value="">â€” None (standalone) â€”</option>';
    arr.forEach(j=>{sel.innerHTML+=`<option value="${j.id}">${j.title} (${j.level||''})</option>`});
  }catch(e){}
}

async function generateToken(){
  const name=document.getElementById('tk_name').value.trim();
  const email=document.getElementById('tk_email').value.trim();
  const roleEl=document.getElementById('tk_role');
  let role=roleEl.value==='custom'?document.getElementById('tk_customRole').value.trim():roleEl.value;

  if(!name){toast('âŒ Enter candidate name');return}
  if(!email){toast('âŒ Enter candidate email');return}
  if(!role){toast('âŒ Select a role');return}

  const level=document.getElementById('tk_level').value;
  const questions=parseInt(document.getElementById('tk_questions').value)||10;
  const lang=document.getElementById('tk_lang').value;
  const hours=parseInt(document.getElementById('tk_expiry').value)||72;
  const type=document.getElementById('tk_type').value;
  const jobId=document.getElementById('tk_jobId').value||null;

  const token=genUUID();
  const expires=new Date(Date.now()+hours*3600000);

  toast('â³ Creating token...');

  try{
    // Step 1: Create application record
    let appId=null;
    try{
      const appResult=await db('insert','applications',{
        job_id:jobId,name,email,
        resume_text:'',status:'shortlisted',
        created_at:new Date().toISOString()
      });
      const app=Array.isArray(appResult)?appResult[0]:appResult;
      appId=app?.id||null;
    }catch(e){console.log('[Token] App insert skipped:',e.message)}

    // Step 2: Create interview record with token
    await db('insert','interviews',{
      application_id:appId,
      job_id:jobId,
      token:token,
      interview_type:type,
      status:'pending',
      interview_role:role,
      interview_level:level,
      question_count:questions,
      interview_language:lang,
      expires_at:expires.toISOString(),
      created_at:new Date().toISOString()
    });

    // Step 3: Build the interview URL
    const baseUrl=window.location.origin;
    const interviewPage=type==='real'?'evalis-interview.html':'evalis-platform.html';
    const fullUrl=baseUrl+'/'+interviewPage+'?token='+token;

    // Step 4: Display result
    _lastGeneratedToken={name,email,role,level,token,url:fullUrl,expires,type,questions,lang};

    document.getElementById('tokenResultCard').classList.remove('hidden');
    document.getElementById('tokenResultName').textContent=name+' â€” '+role+' ('+level+')';
    document.getElementById('tokenResultMeta').textContent='ğŸ“§ '+email+' â€¢ ğŸ”¢ '+questions+' questions â€¢ ğŸŒ '+lang+' â€¢ '+(type==='real'?'ğŸ”’ Proctored':'ğŸ¯ Mock');
    document.getElementById('tokenResultUrl').value=fullUrl;
    document.getElementById('tokenResultToken').textContent='Token: '+token;
    document.getElementById('tokenResultExpiry').textContent='â° Expires: '+expires.toLocaleString()+' ('+hours+'h)';

    toast('âœ… Token generated for '+name+'!');

    // Reload token list
    loadAllTokens();
  }catch(e){
    toast('âŒ Failed: '+e.message);
    console.error('[Token]',e);
  }
}

function copyTokenUrl(){
  if(!_lastGeneratedToken)return;
  navigator.clipboard?.writeText(_lastGeneratedToken.url);
  toast('ğŸ“‹ Interview URL copied!');
}

function copyTokenRaw(){
  if(!_lastGeneratedToken)return;
  navigator.clipboard?.writeText(_lastGeneratedToken.token);
  toast('ğŸ“‹ Token copied!');
}

function copyInviteEmail(){
  if(!_lastGeneratedToken)return;
  const t=_lastGeneratedToken;
  const email=`Subject: Interview Invitation â€” ${t.role} at Simpatico HR

Dear ${t.name},

Congratulations! You have been shortlisted for the ${t.role} (${t.level}) position.

Please complete your ${t.type==='real'?'proctored':'mock'} AI interview using the link below:

ğŸ”— ${t.url}

ğŸ“‹ Details:
â€¢ Role: ${t.role} (${t.level})
â€¢ Questions: ${t.questions}
â€¢ Type: ${t.type==='real'?'Proctored (screen share + camera required)':'Mock Practice'}
â€¢ Expires: ${t.expires.toLocaleString()}

${t.type==='real'?'âš ï¸ Important:\nâ€¢ Use Chrome/Edge browser\nâ€¢ Share your entire screen\nâ€¢ Enable camera\nâ€¢ Single attempt only\nâ€¢ Tab switching = violation\n':''}
Best regards,
Simpatico HR Consultancy`;

  navigator.clipboard?.writeText(email);
  toast('ğŸ“§ Email template copied!');
}

function copyWhatsApp(){
  if(!_lastGeneratedToken)return;
  const t=_lastGeneratedToken;
  const msg=`ğŸ¤ *Interview Invitation*

Hi ${t.name}! You're shortlisted for *${t.role}* (${t.level}).

Complete your AI interview here:
${t.url}

ğŸ“‹ ${t.questions} questions â€¢ ${t.type==='real'?'ğŸ”’ Proctored':'ğŸ¯ Practice'}
â° Expires: ${t.expires.toLocaleDateString()}

Good luck! ğŸ€
â€” Simpatico HR`;

  navigator.clipboard?.writeText(msg);
  toast('ğŸ’¬ WhatsApp message copied!');
}

// Bulk Generate
async function bulkGenerateTokens(){
  const emails=document.getElementById('tk_bulkEmails').value.trim().split('\n').map(e=>e.trim()).filter(e=>e&&e.includes('@'));
  const role=document.getElementById('tk_bulkRole').value.trim();
  const level=document.getElementById('tk_bulkLevel').value;

  if(!emails.length){toast('âŒ Enter at least one email');return}
  if(!role){toast('âŒ Enter role');return}

  toast('â³ Generating '+emails.length+' tokens...');
  const results=[];
  const el=document.getElementById('bulkResults');
  el.classList.remove('hidden');
  el.innerHTML='<p style="color:var(--muted);">Processing...</p>';

  for(const email of emails){
    const token=genUUID();
    const name=email.split('@')[0].replace(/[._]/g,' ');
    try{
      let appId=null;
      try{
        const r=await db('insert','applications',{name,email,status:'shortlisted',created_at:new Date().toISOString()});
        const a=Array.isArray(r)?r[0]:r;appId=a?.id;
      }catch(e){}

      await db('insert','interviews',{
        application_id:appId,token,
        interview_type:'real',status:'pending',
        interview_role:role,interview_level:level,
        question_count:10,interview_language:'en',
        expires_at:new Date(Date.now()+72*3600000).toISOString(),
        created_at:new Date().toISOString()
      });

      const url=window.location.origin+'/evalis-interview.html?token='+token;
      results.push({email,token,url,ok:true});
    }catch(e){
      results.push({email,token:'',url:'',ok:false,error:e.message});
    }
  }

  el.innerHTML='<div style="font-size:0.82rem;">'+results.map(r=>
    r.ok?`<div style="padding:6px 0;border-bottom:1px solid var(--border);"><span style="color:var(--green);">âœ…</span> <strong>${r.email}</strong><div class="copy-box" style="margin-top:4px;"><input class="copy-input" value="${r.url}" readonly><button class="copy-btn" onclick="navigator.clipboard?.writeText('${r.url}');toast('ğŸ“‹ Copied!')">ğŸ“‹</button></div></div>`
    :`<div style="padding:6px 0;border-bottom:1px solid var(--border);color:var(--red);">âŒ ${r.email}: ${r.error}</div>`
  ).join('')+'</div>';

  const csv=results.filter(r=>r.ok).map(r=>r.email+','+r.url).join('\n');
  if(csv){
    el.innerHTML+=`<button class="btn btn-accent" style="margin-top:12px;padding:10px 16px;" onclick="navigator.clipboard?.writeText(\`${csv.replace(/`/g,'')}\`);toast('ğŸ“‹ All URLs copied!')">ğŸ“‹ Copy All URLs (CSV)</button>`;
  }

  toast('âœ… Generated '+results.filter(r=>r.ok).length+'/'+emails.length+' tokens');
  loadAllTokens();
}

// Load All Tokens
let _tokenFilter='all';
function filterTokens(f){_tokenFilter=f;loadAllTokens()}

async function loadAllTokens(){
  const el=document.getElementById('allTokensList');
  el.innerHTML='<span class="loading"></span> Loading...';
  try{
    const data=await db('select','interviews',null,null,null,'created_at.desc');
    let arr=Array.isArray(data)?data:[];
    const now=new Date();

    if(_tokenFilter==='expired')arr=arr.filter(i=>i.expires_at&&new Date(i.expires_at)<now&&i.status!=='completed');
    else if(_tokenFilter!=='all')arr=arr.filter(i=>i.status===_tokenFilter);

    if(!arr.length){el.innerHTML='<p style="color:var(--muted);text-align:center;padding:20px;">No tokens found</p>';return}

    el.innerHTML=arr.slice(0,50).map(i=>{
      const exp=i.expires_at?new Date(i.expires_at):null;
      const isExpired=exp&&exp<now&&i.status!=='completed';
      const sc={pending:'#f59e0b',in_progress:'#3b82f6',completed:'#10b981'}[i.status]||'#94a3b8';
      const sb={pending:'rgba(245,158,11,.15)',in_progress:'rgba(59,130,246,.15)',completed:'rgba(16,185,129,.15)'}[i.status]||'rgba(255,255,255,.05)';
      const url=window.location.origin+'/'+(i.interview_type==='real'?'evalis-interview.html':'evalis-platform.html')+'?token='+i.token;

      return`<div style="padding:12px;border-bottom:1px solid var(--border);${isExpired?'opacity:0.5;':''}">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
          <div>
            <div style="font-weight:700;font-size:0.9rem;">${i.interview_role||'?'} â€” ${i.interview_level||''}</div>
            <div style="font-size:0.72rem;color:var(--muted);">Token: ${(i.token||'?').substring(0,16)}... â€¢ ${i.created_at?new Date(i.created_at).toLocaleDateString():''}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
            ${i.overall_score?`<span class="score-badge" style="background:rgba(16,185,129,.15);color:${i.overall_score>=70?'#10b981':i.overall_score>=50?'#f59e0b':'#ef4444'};">${i.overall_score}/100</span>`:''}
            <span class="status-pill" style="background:${isExpired?'rgba(239,68,68,.15)':sb};color:${isExpired?'#ef4444':sc};">${isExpired?'Expired':i.status||'?'}</span>
            <span class="status-pill" style="color:${i.interview_type==='real'?'#ef4444':'#10b981'};">${i.interview_type==='real'?'ğŸ”’':'ğŸ¯'}</span>
          </div>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">
          <button class="btn btn-accent" style="padding:3px 10px;font-size:0.72rem;" onclick="navigator.clipboard?.writeText('${url}');toast('ğŸ“‹ URL copied!')">ğŸ“‹ URL</button>
          <button class="btn" style="padding:3px 10px;font-size:0.72rem;background:rgba(245,158,11,.15);color:#f59e0b;" onclick="navigator.clipboard?.writeText('${i.token}');toast('ğŸ“‹ Token copied!')">ğŸ”‘ Token</button>
          ${i.status==='pending'&&!isExpired?`<button class="btn btn-save" style="padding:3px 10px;font-size:0.72rem;" onclick="resendToken('${i.token}','${(i.interview_role||'').replace(/'/g,"\\'")}')">ğŸ“§ Resend</button>`:''}
          ${i.status==='completed'?`<button class="btn" style="padding:3px 10px;font-size:0.72rem;background:rgba(59,130,246,.15);color:#3b82f6;" onclick="viewResult('${i.id}')">ğŸ“Š Results</button>`:''}
          <button class="btn btn-danger" style="padding:3px 10px;font-size:0.72rem;" onclick="revokeToken('${i.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`;
    }).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}

function resendToken(token,role){
  const url=window.location.origin+'/evalis-interview.html?token='+token;
  const msg=`ğŸ¤ Interview Reminder\n\nYour AI interview for "${role}" is still pending.\n\nğŸ”— ${url}\n\nâ€” Simpatico HR`;
  navigator.clipboard?.writeText(msg);
  toast('ğŸ“‹ Resend message copied!');
}

async function viewResult(id){
  try{
    const data=await db('select','interviews',null,{id});
    const i=Array.isArray(data)?data[0]:data;
    if(!i){toast('âŒ Not found');return}
    alert(`ğŸ“Š Interview Result\n\nğŸ¯ Role: ${i.interview_role||'?'}\nğŸ“Š Score: ${i.overall_score||'?'}/100\nğŸ·ï¸ Grade: ${i.grade||'?'}\nğŸ’¡ Recommendation: ${i.recommendation||'?'}\n\nğŸ“ Summary:\n${i.summary||'N/A'}\n\nğŸ’ª Strengths:\n${(i.strengths||[]).map(s=>'â€¢ '+s).join('\n')||'N/A'}\n\nğŸ“ˆ Improvements:\n${(i.improvements||[]).map(s=>'â€¢ '+s).join('\n')||'N/A'}\n\nâš ï¸ Violations: ${i.violation_count||0}\nâ±ï¸ Duration: ${i.duration_seconds?Math.round(i.duration_seconds/60)+'m':'?'}`);
  }catch(e){toast('âŒ '+e.message)}
}

async function revokeToken(id){
  if(!confirm('Delete this token?'))return;
  try{await db('delete','interviews',null,{id});toast('ğŸ—‘ï¸ Deleted');loadAllTokens()}catch(e){toast('âŒ '+e.message)}
}

function loadTokens(){loadTokenJobs();loadAllTokens()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SITE EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSiteConfig(){
  const config={siteTitle:document.getElementById('ed_title').value,siteSubtitle:document.getElementById('ed_subtitle').value,companyName:document.getElementById('ed_company').value,colorPrimary:document.getElementById('ed_primary').value,colorSecondary:document.getElementById('ed_secondary').value,colorSuccess:document.getElementById('ed_success').value,colorBg:document.getElementById('ed_bg').value,font:document.getElementById('ed_font').value,radius:document.getElementById('ed_radius').value,bannerShow:document.getElementById('tog_banner').classList.contains('on'),bannerText:document.getElementById('ed_bannerText').value,bannerColor:document.getElementById('ed_bannerColor').value};
  localStorage.setItem("siteConfig",JSON.stringify(config));
  toast('ğŸ’¾ Saved!');
}
function resetSiteConfig(){if(!confirm('Reset all?'))return;localStorage.removeItem("siteConfig");toast('ğŸ”„ Reset!');location.reload()}
function loadSiteConfig(){try{const c=JSON.parse(localStorage.getItem("siteConfig")||"{}");if(c.siteTitle)document.getElementById('ed_title').value=c.siteTitle;if(c.siteSubtitle)document.getElementById('ed_subtitle').value=c.siteSubtitle;if(c.companyName)document.getElementById('ed_company').value=c.companyName;if(c.colorPrimary)document.getElementById('ed_primary').value=c.colorPrimary;if(c.colorSecondary)document.getElementById('ed_secondary').value=c.colorSecondary;if(c.colorSuccess)document.getElementById('ed_success').value=c.colorSuccess;if(c.colorBg)document.getElementById('ed_bg').value=c.colorBg;if(c.font)document.getElementById('ed_font').value=c.font;if(c.radius)document.getElementById('ed_radius').value=c.radius;if(c.bannerShow)document.getElementById('tog_banner').classList.add('on');if(c.bannerText)document.getElementById('ed_bannerText').value=c.bannerText;if(c.bannerColor)document.getElementById('ed_bannerColor').value=c.bannerColor}catch(e){}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPayments(){
  try{
    const data=await db('select','payments',null,null,null,'created_at.desc');const arr=Array.isArray(data)?data:[];
    const total=arr.filter(p=>p.status==='completed').reduce((s,p)=>s+(p.amount||0),0);
    document.getElementById('pTotal').textContent='â‚¹'+total.toLocaleString();document.getElementById('pCount').textContent=arr.length;
    document.getElementById('pPending').textContent=arr.filter(p=>p.status==='pending').length;
    document.getElementById('pActive').textContent=arr.filter(p=>p.status==='completed').length;
    const tbody=document.getElementById('payHistory');
    if(!arr.length){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--muted);">No payments</td></tr>';return}
    tbody.innerHTML=arr.map(p=>{const sc=p.status==='completed'?'#10b981':'#f59e0b';const sb=p.status==='completed'?'rgba(16,185,129,.15)':'rgba(245,158,11,.15)';
    return`<tr><td>${p.created_at?new Date(p.created_at).toLocaleDateString():'?'}</td><td>${p.email||p.user_email||'?'}</td><td style="font-weight:700;">â‚¹${(p.amount||0).toLocaleString()}</td><td>${p.type||'?'}</td><td><span class="status-pill" style="background:${sb};color:${sc};">${p.status||'?'}</span></td><td><button class="btn btn-danger" style="padding:4px 8px;font-size:0.72rem;" onclick="deletePay('${p.id}')">ğŸ—‘ï¸</button></td></tr>`}).join('')
  }catch(e){console.error(e)}
  document.getElementById('ed_price').value=getConfig('mockPrice',199);
  document.getElementById('ed_days').value=getConfig('accessDays',30);
  if(getConfig('mockPaid',true))document.getElementById('tog_paid').classList.add('on');
  document.getElementById('ed_razorKey').value=getConfig('razorpayKey','');
  document.getElementById('ed_upiId').value=getConfig('upiId','');
}
async function deletePay(id){if(!confirm('Delete?'))return;try{await db('delete','payments',null,{id});toast('ğŸ—‘ï¸');loadPayments()}catch(e){toast('âŒ '+e.message)}}
async function addManualPayment(){
  const email=document.getElementById('mp_email').value.trim();if(!email){toast('âŒ Enter email');return}
  try{await db('insert','payments',{email,user_email:email,amount:parseInt(document.getElementById('mp_amount').value)||199,currency:'INR',currency_symbol:'â‚¹',type:'manual',status:'completed',note:document.getElementById('mp_note').value.trim()||'Manual',days_granted:parseInt(document.getElementById('mp_days').value)||30,created_at:new Date().toISOString()});
  toast('âœ… Added');document.getElementById('mp_email').value='';loadPayments()}catch(e){toast('âŒ '+e.message)}
}
function savePricing(){setConfig('mockPrice',document.getElementById('ed_price').value);setConfig('accessDays',document.getElementById('ed_days').value);setConfig('mockPaid',document.getElementById('tog_paid').classList.contains('on'));toast('ğŸ’¾ Saved!')}
function saveGateway(){setConfig('razorpayKey',document.getElementById('ed_razorKey').value.trim());setConfig('upiId',document.getElementById('ed_upiId').value.trim());toast('ğŸ’¾ Saved!')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCESS CODES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function genCode(){
  const code=document.getElementById('ac_code').value.trim().toUpperCase();if(!code){toast('âŒ Enter code');return}
  try{const exp=document.getElementById('ac_expiry').value;
  await db('insert','access_codes',{code,max_uses:parseInt(document.getElementById('ac_max').value)||50,used:0,days:parseInt(document.getElementById('ac_days').value)||30,is_active:true,expires_at:exp?new Date(exp).toISOString():null,created_at:new Date().toISOString()});
  toast('âœ… '+code);document.getElementById('ac_code').value='';loadCodes()}catch(e){toast('âŒ '+e.message)}
}
function genRandom(){const ch='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let c='SIM-';for(let i=0;i<8;i++)c+=ch.charAt(Math.floor(Math.random()*ch.length));document.getElementById('ac_code').value=c;toast('ğŸ² '+c)}
async function loadCodes(){
  const el=document.getElementById('codesList');
  try{const data=await db('select','access_codes',null,null,null,'created_at.desc');const arr=Array.isArray(data)?data:[];
  if(!arr.length){el.innerHTML='<p style="color:var(--muted);text-align:center;">No codes</p>';return}
  el.innerHTML=arr.map(c=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px;"><div><div style="font-weight:700;color:var(--accent);">${c.code}</div><div style="font-size:0.72rem;color:var(--muted);">${c.used||0}/${c.max_uses||'âˆ'} â€¢ ${c.days||30}d â€¢ ${c.is_active?'ğŸŸ¢':'ğŸ”´'}</div></div><div style="display:flex;gap:6px;"><button class="btn btn-accent" style="padding:4px 10px;font-size:0.75rem;" onclick="navigator.clipboard?.writeText('${c.code}');toast('ğŸ“‹')">ğŸ“‹</button><button class="btn btn-danger" style="padding:4px 10px;font-size:0.75rem;" onclick="delCode('${c.id}')">ğŸ—‘ï¸</button></div></div>`).join('')}catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}
async function delCode(id){if(!confirm('Delete?'))return;try{await db('delete','access_codes',null,{id});toast('ğŸ—‘ï¸');loadCodes()}catch(e){toast('âŒ '+e.message)}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addClient(){
  const name=document.getElementById('cl_name').value.trim();const email=document.getElementById('cl_email').value.trim();
  if(!name||!email){toast('âŒ Company & email required');return}
  const days=parseInt(document.getElementById('cl_duration').value)||365;
  const expires=new Date();expires.setDate(expires.getDate()+days);
  const password='HR-'+Math.random().toString(36).substring(2,10).toUpperCase();
  try{
    await db('insert','hr_clients',{company_name:name,email,plan:document.getElementById('cl_plan').value,amount_paid:parseInt(document.getElementById('cl_amount').value)||0,payment_method:document.getElementById('cl_payMethod').value,hr_password:password,status:'active',created_at:new Date().toISOString(),expires_at:expires.toISOString()});
    alert('âœ… Client Created!\n\nCompany: '+name+'\nEmail: '+email+'\nPassword: '+password+'\nExpires: '+expires.toLocaleDateString());
    try{navigator.clipboard?.writeText('Company: '+name+'\nPassword: '+password)}catch(e){}
    document.getElementById('cl_name').value='';document.getElementById('cl_email').value='';
    loadClients();toast('âœ… Added!');
  }catch(e){toast('âŒ '+e.message)}
}

async function loadClients(){
  const el=document.getElementById('clientsList');el.innerHTML='<span class="loading"></span>';
  try{
    const data=await db('select','hr_clients',null,null,null,'created_at.desc');const arr=Array.isArray(data)?data:[];const now=new Date();
    document.getElementById('clTotal').textContent=arr.length;
    document.getElementById('clActive').textContent=arr.filter(c=>c.status==='active'&&new Date(c.expires_at)>now).length;
    document.getElementById('clExpiring').textContent=arr.filter(c=>{const d=(new Date(c.expires_at)-now)/86400000;return c.status==='active'&&d>0&&d<=7}).length;
    document.getElementById('clExpired').textContent=arr.filter(c=>new Date(c.expires_at)<=now).length;
    if(!arr.length){el.innerHTML='<p style="color:var(--muted);text-align:center;">No clients</p>';return}
    el.innerHTML=arr.map(c=>{const exp=new Date(c.expires_at);const ie=exp<=now;const sc=ie?'#ef4444':'#10b981';
    return`<div style="padding:12px;border-bottom:1px solid var(--border);"><div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;"><div><strong>${c.company_name}</strong><div style="font-size:0.72rem;color:var(--muted);">${c.email} â€¢ ${c.plan} â€¢ Exp: ${exp.toLocaleDateString()}</div></div><span class="status-pill" style="color:${sc};">${ie?'Expired':'Active'}</span></div></div>`}).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOBS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminJobs(){
  const el=document.getElementById('adminJobsList');el.innerHTML='<span class="loading"></span>';
  try{const data=await db('select','jobs',null,null,null,'created_at.desc');const arr=Array.isArray(data)?data:[];
  if(!arr.length){el.innerHTML='<p style="color:var(--muted);text-align:center;">No jobs</p>';return}
  el.innerHTML=arr.map(j=>`<div class="job-card"><div style="display:flex;justify-content:space-between;"><h4>${j.title||'?'}</h4><div style="display:flex;gap:6px;"><span class="status-pill" style="color:${j.is_active?'#10b981':'#ef4444'};">${j.is_active?'Active':'Off'}</span><button class="btn ${j.is_active?'btn-danger':'btn-save'}" style="padding:3px 8px;font-size:0.7rem;" onclick="toggleJob('${j.id}',${!j.is_active})">${j.is_active?'Disable':'Enable'}</button><button class="btn btn-danger" style="padding:3px 8px;font-size:0.7rem;" onclick="deleteJob('${j.id}')">ğŸ—‘ï¸</button></div></div><div class="job-meta"><span>ğŸ¢ ${j["Company Name"]||j.department||''}</span><span>ğŸ“ ${j.location||''}</span><span>ğŸ“Š ${j.level||''}</span></div></div>`).join('')}catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}
async function toggleJob(id,active){try{await db('update','jobs',{is_active:active},{id});toast(active?'âœ…':'ğŸš«');loadAdminJobs()}catch(e){toast('âŒ '+e.message)}}
async function deleteJob(id){if(!confirm('Delete?'))return;try{await db('delete','jobs',null,{id});toast('ğŸ—‘ï¸');loadAdminJobs()}catch(e){toast('âŒ '+e.message)}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANDIDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminCandidates(){
  const el=document.getElementById('adminCandList');el.innerHTML='<span class="loading"></span>';
  try{const data=await db('select','applications',null,null,null,'created_at.desc');const arr=Array.isArray(data)?data:[];
  if(!arr.length){el.innerHTML='<p style="color:var(--muted);text-align:center;">No applications</p>';return}
  el.innerHTML=arr.map(c=>{const sc=c.ats_score||0;const col=sc>=70?'#10b981':sc>=50?'#f59e0b':'#ef4444';const bg=sc>=70?'rgba(16,185,129,.15)':sc>=50?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)';const stc={applied:'#f59e0b',shortlisted:'#10b981',interviewed:'#3b82f6',rejected:'#ef4444'}[c.status]||'#94a3b8';const stb={applied:'rgba(245,158,11,.15)',shortlisted:'rgba(16,185,129,.15)',interviewed:'rgba(59,130,246,.15)',rejected:'rgba(239,68,68,.15)'}[c.status]||'rgba(255,255,255,.05)';
  return`<div class="cand-row"><div style="display:flex;align-items:center;gap:8px;flex:1;"><div class="cand-avatar">${(c.name||'?')[0].toUpperCase()}</div><div><div style="font-weight:700;font-size:0.88rem;">${c.name||'?'}</div><div style="font-size:0.72rem;color:var(--muted);">${c.email||''}</div></div></div><div style="display:flex;gap:6px;align-items:center;"><span class="score-badge" style="background:${bg};color:${col};">ATS:${sc}</span><span class="status-pill" style="background:${stb};color:${stc};">${c.status||'?'}</span><button class="btn btn-danger" style="padding:3px 8px;font-size:0.7rem;" onclick="deleteApp('${c.id}')">ğŸ—‘ï¸</button></div></div>`}).join('')}catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}

  const el2=document.getElementById('adminIntList');el2.innerHTML='<span class="loading"></span>';
  try{const data=await db('select','interviews',null,null,null,'created_at.desc');const arr=Array.isArray(data)?data:[];
  if(!arr.length){el2.innerHTML='<p style="color:var(--muted);text-align:center;">No interviews</p>';return}
  el2.innerHTML=arr.slice(0,30).map(i=>{const sc=i.overall_score||0;const col=sc>=70?'#10b981':sc>=50?'#f59e0b':'#ef4444';const stc={pending:'#f59e0b',in_progress:'#3b82f6',completed:'#10b981'}[i.status]||'#94a3b8';
  return`<div class="cand-row"><div style="flex:1;"><div style="font-weight:700;">${i.interview_role||'?'} â€” ${i.interview_level||''}</div><div style="font-size:0.72rem;color:var(--muted);">${i.status} â€¢ ${i.created_at?new Date(i.created_at).toLocaleDateString():''}</div></div><div style="display:flex;gap:6px;">${sc?`<span class="score-badge" style="background:rgba(16,185,129,.15);color:${col};">${sc}/100</span>`:''}<span class="status-pill" style="color:${stc};">${i.status}</span></div></div>`}).join('')}catch(e){el2.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}
async function deleteApp(id){if(!confirm('Delete?'))return;try{await db('delete','applications',null,{id});toast('ğŸ—‘ï¸');loadAdminCandidates()}catch(e){toast('âŒ '+e.message)}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ˆ USAGE ANALYTICS (NEW)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUsageAnalytics(){
  try{
    const ints=await db('select','interviews').catch(()=>[]);
    const arr=Array.isArray(ints)?ints:[];
    const now=new Date();
    const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const weekAgo=new Date(today.getTime()-7*86400000);
    const monthAgo=new Date(today.getTime()-30*86400000);

    document.getElementById('uTotal').textContent=arr.length;
    document.getElementById('uToday').textContent=arr.filter(i=>new Date(i.created_at)>=today).length;
    document.getElementById('uWeek').textContent=arr.filter(i=>new Date(i.created_at)>=weekAgo).length;
    document.getElementById('uMonth').textContent=arr.filter(i=>new Date(i.created_at)>=monthAgo).length;

    // Breakdown
    const completed=arr.filter(i=>i.status==='completed');
    const pending=arr.filter(i=>i.status==='pending');
    const inProgress=arr.filter(i=>i.status==='in_progress');
    const avgScore=completed.length?Math.round(completed.reduce((s,i)=>s+(i.overall_score||0),0)/completed.length):0;

    const roles={};arr.forEach(i=>{const r=i.interview_role||'Unknown';roles[r]=(roles[r]||0)+1});
    const topRoles=Object.entries(roles).sort((a,b)=>b[1]-a[1]).slice(0,10);

    document.getElementById('usageBreakdown').innerHTML=`
      <div class="row2" style="margin-bottom:12px;">
        <div style="text-align:center;padding:12px;background:rgba(16,185,129,.05);border-radius:10px;">
          <div style="font-size:1.4rem;font-weight:800;color:#10b981;">${completed.length}</div>
          <div style="font-size:0.72rem;color:var(--muted);">Completed</div>
        </div>
        <div style="text-align:center;padding:12px;background:rgba(245,158,11,.05);border-radius:10px;">
          <div style="font-size:1.4rem;font-weight:800;color:#f59e0b;">${pending.length}</div>
          <div style="font-size:0.72rem;color:var(--muted);">Pending</div>
        </div>
      </div>
      <div class="edit-row"><span class="edit-label">Avg Score</span><span class="score-badge" style="background:rgba(16,185,129,.15);color:${avgScore>=70?'#10b981':avgScore>=50?'#f59e0b':'#ef4444'};">${avgScore}/100</span></div>
      <div class="edit-row"><span class="edit-label">Completion Rate</span><span class="edit-preview">${arr.length?Math.round(completed.length/arr.length*100):0}%</span></div>
      <div style="margin-top:12px;"><strong style="font-size:0.85rem;">Top Roles:</strong></div>
      ${topRoles.map(([r,c])=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:0.82rem;"><span>${r}</span><span style="color:var(--accent);font-weight:700;">${c}</span></div>`).join('')}
    `;

    // API usage (estimated)
    document.getElementById('apiPuter').textContent='~'+arr.length*2+' calls (unlimited)';
    document.getElementById('apiGroq').textContent='Backup only';
    document.getElementById('apiCF').textContent='Backup only';

    // Top candidates
    const topEl=document.getElementById('topCandidates');
    const top=completed.filter(i=>i.overall_score).sort((a,b)=>(b.overall_score||0)-(a.overall_score||0)).slice(0,10);
    topEl.innerHTML=top.length?top.map(i=>`<div class="cand-row"><div><strong>${i.interview_role||'?'}</strong><div style="font-size:0.72rem;color:var(--muted);">${i.interview_level||''} â€¢ ${i.completed_at?new Date(i.completed_at).toLocaleDateString():''}</div></div><span class="score-badge" style="background:rgba(16,185,129,.15);color:${(i.overall_score||0)>=70?'#10b981':'#f59e0b'};">${i.overall_score}/100 ${i.grade||''}</span></div>`).join(''):'<p style="color:var(--muted);text-align:center;">No completed interviews</p>';

  }catch(e){console.error(e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettings(){
  document.getElementById('set_worker').value=getConfig('workerUrl',W_DEFAULT);
  document.getElementById('set_violations').value=getConfig('maxViolations',3);
  if(getConfig('maintenance',false))document.getElementById('tog_maint').classList.add('on');
}
function changeAdminPass(){const p=document.getElementById('set_adminPass').value.trim();if(!p||p.length<6){toast('âŒ Min 6 chars');return}setConfig('adminPassword',p);toast('âœ… Changed!');document.getElementById('set_adminPass').value=''}
function changeHRPass(){const p=document.getElementById('set_hrPass').value.trim();if(!p||p.length<4){toast('âŒ Min 4 chars');return}setConfig('hrPassword',p);toast('âœ… Changed!');document.getElementById('set_hrPass').value=''}
function savePlatformSettings(){setConfig('workerUrl',document.getElementById('set_worker').value);setConfig('maxViolations',document.getElementById('set_violations').value);setConfig('maintenance',document.getElementById('tog_maint').classList.contains('on'));toast('ğŸ’¾ Saved!')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT / RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportAllData(){
  toast('ğŸ“¥ Exporting...');
  try{const[jobs,apps,ints,pay,codes,clients]=await Promise.all([db('select','jobs').catch(()=>[]),db('select','applications').catch(()=>[]),db('select','interviews').catch(()=>[]),db('select','payments').catch(()=>[]),db('select','access_codes').catch(()=>[]),db('select','hr_clients').catch(()=>[])]);
  const data={exported:new Date().toISOString(),adminConfig:JSON.parse(localStorage.getItem("adminConfig")||"{}"),siteConfig:JSON.parse(localStorage.getItem("siteConfig")||"{}"),jobs,applications:apps,interviews:ints,payments:pay,access_codes:codes,hr_clients:clients};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='simpatico-export-'+Date.now()+'.json';a.click();URL.revokeObjectURL(url);toast('âœ… Exported!')}catch(e){toast('âŒ '+e.message)}
}
function importData(){const input=document.createElement('input');input.type='file';input.accept='.json';input.onchange=async e=>{const file=e.target.files[0];if(!file)return;try{const data=JSON.parse(await file.text());if(data.adminConfig)localStorage.setItem("adminConfig",JSON.stringify(data.adminConfig));if(data.siteConfig)localStorage.setItem("siteConfig",JSON.stringify(data.siteConfig));toast('âœ… Imported!')}catch(err){toast('âŒ Invalid')}};input.click()}
function dangerReset(){if(!confirm('âš ï¸ DELETE ALL?'))return;if(prompt('Type DELETE ALL:')!=='DELETE ALL')return;localStorage.clear();toast('ğŸ—‘ï¸ Cleared!');setTimeout(()=>location.reload(),1000)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  loadSiteConfig();
  document.getElementById('loginPass')?.focus();
});
</script>
</body>
</html>
