<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform | Simpatico HR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#020617;--card:rgba(15,23,42,.65);--card2:rgba(30,41,59,.5);--border:rgba(255,255,255,.08);--accent:#6366f1;--accent2:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;--text:#f8fafc;--muted:#94a3b8;--glow:rgba(99,102,241,.15)}
    body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:radial-gradient(circle at 10% 20%,rgba(99,102,241,.15),transparent 40%),radial-gradient(circle at 90% 80%,rgba(79,70,229,.1),transparent 40%),var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
    .container{max-width:780px;margin:0 auto;padding:16px;position:relative;z-index:1}
    .top-nav{backdrop-filter:blur(16px);background:rgba(2,6,23,.85);padding:1rem 6%;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .top-logo{font-weight:800;font-size:1.1rem;color:#fff;text-decoration:none}.top-logo span{color:var(--accent)}
    .top-links{display:flex;gap:12px;align-items:center}
    .top-link{color:var(--muted);text-decoration:none;font-size:12px;font-weight:600;padding:6px 12px;border-radius:8px;transition:all 0.2s}
    .top-link:hover{color:#fff;background:rgba(255,255,255,.05)}
    .header{text-align:center;padding:30px 0 20px}
    .header h1{font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#fff,#94a3b8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:var(--muted);font-size:0.9rem;margin-top:4px}
    .card{background:var(--card);backdrop-filter:blur(22px);border:1px solid var(--border);border-radius:20px;padding:24px;margin-bottom:14px}
    .card h2{font-size:1rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    label{display:block;font-size:0.78rem;color:var(--muted);margin:12px 0 4px;font-weight:600}
    select,input[type="text"],input[type="email"],input[type="tel"],input[type="password"],textarea{width:100%;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;outline:none;transition:border-color 0.2s;font-family:inherit}
    select:focus,input:focus,textarea:focus{border-color:rgba(99,102,241,.4);box-shadow:0 0 0 3px var(--glow)}
    select option{background:#1e293b}
    textarea{resize:vertical;min-height:80px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .upload-area{border:2px dashed var(--border);border-radius:14px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s;margin-top:8px}
    .upload-area:hover{border-color:rgba(99,102,241,.4);background:rgba(99,102,241,.03)}
    .upload-area.ok{border-color:var(--green);background:rgba(16,185,129,.05)}
    .upload-area p{font-size:0.85rem;color:var(--muted)}
    .upload-area strong{color:var(--accent)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border:none;border-radius:10px;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s;color:#fff;font-family:inherit}
    .btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
    .btn-go{width:100%;padding:14px;font-size:1rem;background:linear-gradient(135deg,var(--accent),var(--accent2));margin-top:16px;border-radius:14px}
    .btn-go:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 20px var(--glow)}
    .btn-secondary{background:transparent;border:1px solid var(--border);color:#fff;width:100%;margin-top:8px;padding:12px;border-radius:12px}
    .btn-secondary:hover{border-color:rgba(99,102,241,.4)}
    .btn-sm{padding:6px 12px;font-size:0.78rem;border-radius:8px}
    .btn-danger{background:rgba(239,68,68,.15);color:var(--red)}
    .btn-success{background:rgba(16,185,129,.15);color:var(--green)}
    .nav{display:flex;gap:0;margin-bottom:16px;background:rgba(255,255,255,.03);border-radius:14px;padding:4px;border:1px solid var(--border);flex-wrap:wrap}
    .nav-btn{flex:1;padding:10px 6px;text-align:center;border:none;background:transparent;color:var(--muted);font-size:0.78rem;font-weight:700;cursor:pointer;border-radius:10px;transition:all 0.2s;font-family:inherit;min-width:60px}
    .nav-btn.active{background:var(--accent);color:#fff}
    .nav-btn:hover:not(.active){background:rgba(99,102,241,.1)}
    .mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
    .mode-card{background:var(--card);border:2px solid var(--border);border-radius:20px;padding:20px 16px;text-align:center;cursor:pointer;transition:all 0.3s}
    .mode-card:hover{border-color:rgba(99,102,241,.4);transform:translateY(-2px);box-shadow:0 8px 24px var(--glow)}
    .mode-card.selected{border-color:var(--accent);background:rgba(99,102,241,.05)}
    .mode-card .mode-icon{font-size:2.2rem;margin-bottom:8px}
    .mode-card h3{font-size:0.95rem;margin-bottom:4px}
    .mode-card p{font-size:0.78rem;color:var(--muted);line-height:1.4}
    .mode-badge{display:inline-block;padding:2px 10px;border-radius:10px;font-size:0.7rem;font-weight:800;margin-top:6px}
    .job-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:10px;transition:all 0.2s;cursor:pointer}
    .job-card:hover{border-color:rgba(99,102,241,.3)}
    .job-card h3{font-size:0.95rem;margin-bottom:4px;color:var(--accent)}
    .job-meta{font-size:0.78rem;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .skill-tag{background:rgba(99,102,241,.1);color:#a5b4fc;padding:2px 8px;border-radius:6px;font-size:0.72rem;display:inline-block;margin:2px}
    .cand-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);gap:8px;flex-wrap:wrap}.cand-row:last-child{border-bottom:none}
    .cand-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.8rem;flex-shrink:0}
    .score-badge{padding:2px 8px;border-radius:8px;font-size:0.75rem;font-weight:700}
    .status-pill{padding:2px 8px;border-radius:10px;font-size:0.72rem;font-weight:700}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
    .stat-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center}
    .stat-num{font-size:1.4rem;font-weight:800;color:var(--accent)}
    .stat-label{font-size:0.7rem;color:var(--muted)}
    .progress-wrap{background:rgba(255,255,255,.05);border-radius:20px;height:8px;overflow:hidden;margin-bottom:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:20px;transition:width 0.5s;width:0%}
    .progress-info{display:flex;justify-content:space-between;font-size:0.8rem;color:var(--muted);margin-bottom:16px}
    .q-tag{background:rgba(99,102,241,.15);color:var(--accent);padding:2px 10px;border-radius:12px;font-weight:700}
    .followup-tag{background:rgba(139,92,246,.15);color:var(--accent2);padding:2px 10px;border-radius:12px;font-weight:700;font-size:0.75rem}
    .orb-container{display:flex;justify-content:center;margin:24px 0 16px}
    .orb{width:110px;height:110px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(99,102,241,.8),rgba(139,92,246,.6),rgba(99,102,241,.3));position:relative;animation:orbFloat 4s ease-in-out infinite;box-shadow:0 0 30px rgba(99,102,241,.3),0 0 60px rgba(139,92,246,.15),inset 0 0 30px rgba(255,255,255,.1);margin:0 auto}
    .orb::before{content:'';position:absolute;inset:-8px;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);border-right-color:var(--accent2);animation:orbSpin 3s linear infinite}
    .orb::after{content:'';position:absolute;inset:10px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,.2),transparent 70%);animation:orbPulse 2s ease-in-out infinite}
    @keyframes orbFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes orbSpin{to{transform:rotate(360deg)}}
    @keyframes orbPulse{0%,100%{opacity:.5;transform:scale(.9)}50%{opacity:1;transform:scale(1.1)}}
    .orb.speaking{background:radial-gradient(circle at 35% 35%,rgba(16,185,129,.9),rgba(99,102,241,.6),rgba(16,185,129,.3));box-shadow:0 0 40px rgba(16,185,129,.4);animation:orbFloat 2s ease-in-out infinite,orbSpeak .5s ease-in-out infinite}
    @keyframes orbSpeak{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.06)}}
    .orb.listening{background:radial-gradient(circle at 35% 35%,rgba(99,102,241,.9),rgba(139,92,246,.8),rgba(99,102,241,.3));box-shadow:0 0 40px rgba(99,102,241,.5);animation:orbFloat 2s ease-in-out infinite,orbListen 1s ease-in-out infinite}
    @keyframes orbListen{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.04)}}
    .orb.thinking{opacity:.6;animation:orbFloat 1.5s ease-in-out infinite}
    .orb.processing{background:radial-gradient(circle at 35% 35%,rgba(245,158,11,.9),rgba(139,92,246,.6),rgba(245,158,11,.3));box-shadow:0 0 40px rgba(245,158,11,.4);animation:orbFloat 1.5s ease-in-out infinite}
    .orb-label{margin-top:12px;font-size:0.8rem;color:var(--muted);letter-spacing:1px;text-align:center}
    .question-box{background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(139,92,246,.08));border:1px solid rgba(99,102,241,.15);border-radius:16px;padding:20px;margin-bottom:16px;font-size:1.05rem;line-height:1.7;min-height:70px;text-align:center}
    .error-box{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:12px;margin-bottom:12px;font-size:0.85rem;color:var(--red);display:none}
    .error-box.show{display:block}
    .thinking{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:0.85rem;margin:12px 0}
    .thinking-dots span{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;animation:dot 1.2s infinite}
    .thinking-dots span:nth-child(2){animation-delay:.2s}.thinking-dots span:nth-child(3){animation-delay:.4s}
    @keyframes dot{0%,100%{opacity:.2;transform:scale(.8)}50%{opacity:1;transform:scale(1.3)}}
    .silence-bar-wrap{width:80%;max-width:300px;margin:12px auto;text-align:center;display:none}
    .silence-bar-wrap.show{display:block}
    .silence-bar{height:4px;background:var(--card2);border-radius:2px;overflow:hidden}
    .silence-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .3s linear;width:100%}
    .silence-text{font-size:0.75rem;color:var(--muted);margin-top:4px}
    .wave-wrap{display:flex;justify-content:center;align-items:center;gap:3px;height:40px;margin:12px 0}
    .wave-bar{width:4px;height:8px;background:var(--accent);border-radius:4px}
    .wave-wrap.active .wave-bar{animation:wave .8s ease-in-out infinite alternate}
    .wave-bar:nth-child(1){animation-delay:0s}.wave-bar:nth-child(2){animation-delay:.1s}.wave-bar:nth-child(3){animation-delay:.2s}.wave-bar:nth-child(4){animation-delay:.3s}.wave-bar:nth-child(5){animation-delay:.4s}.wave-bar:nth-child(6){animation-delay:.3s}.wave-bar:nth-child(7){animation-delay:.2s}.wave-bar:nth-child(8){animation-delay:.1s}.wave-bar:nth-child(9){animation-delay:0s}
    @keyframes wave{from{height:8px}to{height:36px}}
    .timer{text-align:center;font-size:1.4rem;font-weight:700;font-variant-numeric:tabular-nums;margin:8px 0}
    .hf-info{text-align:center;font-size:0.8rem;color:var(--muted);padding:8px;background:rgba(99,102,241,.05);border-radius:10px;margin-bottom:12px}
    .btn-end{background:rgba(239,68,68,.15);color:var(--red);width:100%;margin-top:16px;padding:12px;border-radius:12px;border:none;cursor:pointer;font-family:inherit;font-weight:700}
    .status-bar{display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.8rem;color:var(--muted);margin-bottom:12px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .score-ring{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
    .score-num{font-size:2.2rem;font-weight:800}
    .score-max{font-size:0.9rem;color:var(--muted)}
    .grade-badge{display:inline-block;padding:4px 16px;border-radius:16px;font-weight:700;font-size:0.85rem;margin-bottom:12px}
    .hire-badge{display:inline-block;padding:6px 20px;border-radius:20px;font-weight:700;font-size:0.9rem;margin-bottom:16px}
    .summary-section{margin-bottom:16px}
    .summary-section h3{font-size:0.9rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .summary-list{list-style:none;padding:0}
    .summary-list li{padding:6px 0;font-size:0.85rem;color:var(--muted);border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:8px}
    .summary-list li:last-child{border-bottom:none}
    .fb-item{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px}
    .fb-item .fb-q{font-weight:700;color:var(--accent);margin-bottom:4px;font-size:0.9rem}
    .fb-item .fb-a{font-size:0.8rem;color:var(--muted);margin-bottom:6px;font-style:italic;opacity:.8}
    .fb-item .fb-score{font-size:0.75rem;padding:2px 8px;border-radius:8px;display:inline-block;margin-bottom:6px}
    .fb-item .fb-text{font-size:0.85rem;color:var(--muted);line-height:1.5}
    .fb-item .fb-type{font-size:0.7rem;padding:1px 6px;border-radius:4px;display:inline-block;margin-left:6px}
    .proctor-bar{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);border-radius:12px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;font-size:0.8rem}
    .proctor-cam{width:120px;height:90px;border-radius:10px;border:2px solid var(--border);overflow:hidden;position:fixed;bottom:16px;right:16px;z-index:100;background:#000}
    .proctor-cam video{width:100%;height:100%;object-fit:cover}
    .proctor-cam .cam-label{position:absolute;bottom:2px;left:4px;font-size:0.6rem;color:rgba(255,255,255,.7);background:rgba(0,0,0,.5);padding:1px 4px;border-radius:3px}
    .violation-item{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(239,68,68,.08);border-radius:8px;margin-bottom:4px;font-size:0.78rem;color:var(--red)}
    .screen-share-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:20px}
    .screen-share-overlay h2{color:var(--text)}
    .screen-share-overlay p{color:var(--muted);font-size:0.9rem;max-width:400px;text-align:center;line-height:1.6}
    .toast-box{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:rgba(15,23,42,.9);backdrop-filter:blur(12px);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:12px;font-size:0.85rem;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:tIn .3s ease,tOut .3s ease 2.7s forwards}
    @keyframes tIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(120%);opacity:0}}
    .hidden{display:none!important}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hr-login-card{max-width:380px;margin:40px auto;text-align:center}
    .hr-login-card h2{margin-bottom:16px;color:var(--yellow)}
    .hr-user-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding:10px 14px;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.15);border-radius:12px;flex-wrap:wrap;gap:8px}
    .hr-user-bar .hr-name{font-weight:700;font-size:.9rem}
    .hr-user-bar .hr-meta{font-size:.75rem;color:var(--muted)}
    @media(max-width:600px){
      .container{padding:10px}.header h1{font-size:1.5rem}
      .row2,.row3,.mode-cards{grid-template-columns:1fr}
      .stat-grid{grid-template-columns:1fr 1fr}
      .orb{width:90px;height:90px}
      .nav-btn{font-size:0.7rem;padding:8px 4px}
      .proctor-cam{width:80px;height:60px}
      .cand-row{flex-direction:column;align-items:flex-start}
      .top-nav{padding:1rem 4%}.top-links{gap:6px}.top-link{font-size:11px;padding:4px 8px}
    }
  </style>
</head>
<body>
  <div class="toast-box" id="toasts"></div>

  <nav class="top-nav">
    <a class="top-logo" href="/">SIMPATICO <span>HR</span></a>
    <div class="top-links">
      <a class="top-link" href="career-lab.html">ğŸ§  Career Lab</a>
      <a class="top-link" href="/">Home</a>
      <span class="top-link" id="hrAuthStatus" style="display:none;color:var(--green);font-size:11px;">ğŸŸ¢ HR</span>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h1>ğŸ§  AI Interview Platform</h1>
      <p>Intelligent â€¢ Adaptive â€¢ Proctored</p>
    </div>

    <div class="nav" id="mainNav">
      <button class="nav-btn active" onclick="nav('home')">ğŸ  Home</button>
      <button class="nav-btn" onclick="nav('jobs')">ğŸ’¼ Jobs</button>
      <button class="nav-btn" onclick="nav('apply')">ğŸ“ Apply</button>
      <button class="nav-btn" onclick="nav('setup')">ğŸ¤ Interview</button>
      <button class="nav-btn" onclick="nav('hr')">ğŸ¢ HR</button>
    </div>

    <!-- HOME -->
    <div id="page-home">
      <div class="mode-cards">
        <div class="mode-card" onclick="nav('jobs')"><div class="mode-icon">ğŸ’¼</div><h3>Browse Jobs</h3><p>View openings & apply</p><span class="mode-badge" style="background:rgba(16,185,129,.15);color:var(--green);">APPLY</span></div>
        <div class="mode-card" id="mockCard" onclick="startMode('mock')"><div class="mode-icon">ğŸ¯</div><h3>Mock Interview</h3><p>Practice freely. No monitoring.</p><span class="mode-badge" id="mockBadge" style="background:rgba(99,102,241,.15);color:var(--accent);">FREE</span></div>
        <div class="mode-card" onclick="startMode('real')"><div class="mode-icon">ğŸ”’</div><h3>Real Interview</h3><p>Proctored. Anti-cheat. One attempt.</p><span class="mode-badge" style="background:rgba(239,68,68,.15);color:var(--red);">PROCTORED</span></div>
        <div class="mode-card" onclick="nav('hr')"><div class="mode-icon">ğŸ¢</div><h3>HR Dashboard</h3><p>Post jobs, manage candidates</p><span class="mode-badge" style="background:rgba(245,158,11,.15);color:var(--yellow);">LOGIN</span></div>
      </div>
    </div>

    <!-- JOBS (PUBLIC â€” uses GET /jobs) -->
    <div id="page-jobs" class="hidden">
      <div class="card">
        <h2>ğŸ’¼ Open Positions</h2>
        <div style="margin-bottom:12px;">
          <input type="text" id="jobSearch" placeholder="ğŸ” Search jobs..." oninput="searchJobs()" style="margin-bottom:0;">
        </div>
        <div id="jobsList"><span class="loading"></span> Loading...</div>
      </div>
    </div>

    <!-- APPLY (PUBLIC â€” uses POST /jobs/:id/apply) -->
    <div id="page-apply" class="hidden">
      <div class="card">
        <h2>ğŸ“ Job Application</h2>
        <div id="applyJobInfo" style="color:var(--accent);font-weight:700;margin-bottom:12px;"></div>
        <div class="row2">
          <div><label>Full Name *</label><input type="text" id="applyName" placeholder="Your name"></div>
          <div><label>Email *</label><input type="email" id="applyEmail" placeholder="you@email.com"></div>
        </div>
        <div class="row2">
          <div><label>Phone</label><input type="tel" id="applyPhone" placeholder="+91 XXXXX XXXXX"></div>
          <div><label>Contact Preference</label>
            <select id="applyContactPref">
              <option value="email">ğŸ“§ Email</option>
              <option value="whatsapp">ğŸ’¬ WhatsApp</option>
              <option value="both">ğŸ“§+ğŸ’¬ Both</option>
              <option value="phone">ğŸ“ Phone</option>
            </select>
          </div>
        </div>
        <label>Cover Letter (optional)</label>
        <textarea id="applyCover" placeholder="Why are you a great fit?" style="min-height:60px;"></textarea>
        <label>Upload Resume (PDF) *</label>
        <div class="upload-area" id="applyUpload" onclick="document.getElementById('applyFile').click()">
          <p>ğŸ“‚ Click to upload <strong>PDF, TXT</strong></p>
          <p id="applyFileName" style="font-size:0.78rem;color:var(--muted);margin-top:4px;">No file</p>
          <input type="file" id="applyFile" accept=".pdf,.txt,.doc,.docx" hidden>
        </div>
        <button class="btn btn-go" id="applyBtn" onclick="submitApplication()">ğŸ“¨ Submit Application</button>
        <div id="applyStatus" style="text-align:center;margin-top:12px;font-size:0.9rem;"></div>
      </div>
    </div>

    <!-- INTERVIEW SETUP -->
    <div id="page-setup" class="hidden">
      <div class="card">
        <h2>âš™ï¸ Interview Setup</h2>
        <div id="modeIndicator" style="text-align:center;margin-bottom:14px;"></div>
        <label>ğŸŒ Language</label>
        <select id="langSel">
          <option value="en">English</option><option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option><option value="ml">à´®à´²à´¯à´¾à´³à´‚</option><option value="ta">à®¤à®®à®¿à®´à¯</option><option value="te">à°¤à±†à°²à±à°—à±</option><option value="kn">à²•à²¨à³à²¨à²¡</option><option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾</option><option value="es">EspaÃ±ol</option><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="fr">FranÃ§ais</option><option value="de">Deutsch</option><option value="ur">Ø§Ø±Ø¯Ùˆ</option>
        </select>
        <label>ğŸ’¼ Job Role</label>
        <select id="roleSel">
          <option value="">â€” Select â€”</option><option value="Frontend Developer">Frontend Developer</option><option value="Backend Developer">Backend Developer</option><option value="Full Stack Developer">Full Stack Developer</option><option value="Data Scientist">Data Scientist</option><option value="DevOps Engineer">DevOps Engineer</option><option value="UI/UX Designer">UI/UX Designer</option><option value="Product Manager">Product Manager</option><option value="QA Engineer">QA Engineer</option><option value="Sales Representative">Sales</option><option value="Marketing Manager">Marketing</option><option value="HR Recruiter">HR</option><option value="custom">âœï¸ Custom...</option>
        </select>
        <div id="customWrap" class="hidden"><label>Enter Role</label><input type="text" id="customRole" placeholder="e.g. Blockchain Developer"></div>
        <div class="row2">
          <div><label>ğŸ“Š Level</label><select id="levelSel"><option>Fresher</option><option>Junior</option><option selected>Mid-Level</option><option>Senior</option><option>Lead</option></select></div>
          <div><label>ğŸ”¢ Questions</label><select id="qCount"><option value="5">5</option><option value="8">8</option><option value="10" selected>10</option><option value="15">15</option></select></div>
        </div>
      </div>
      <div class="card hidden" id="realInfoCard">
        <h2>ğŸ‘¤ Your Information</h2>
        <div class="row2"><div><label>Full Name *</label><input type="text" id="candName"></div><div><label>Email *</label><input type="email" id="candEmail"></div></div>
        <label>Interview Token *</label><input type="text" id="candToken" placeholder="Paste token from invitation">
      </div>
      <div class="card"><h2>ğŸ“„ Resume</h2>
        <div class="upload-area" id="cvUpArea" onclick="document.getElementById('cvFile').click()">
          <p>ğŸ“‚ Upload <strong>PDF, DOC, TXT</strong></p>
          <p id="cvFileName" style="font-size:0.78rem;color:var(--muted);margin-top:4px;">No file</p>
          <input type="file" id="cvFile" accept=".pdf,.doc,.docx,.txt" hidden>
        </div>
      </div>
      <div class="card hidden" id="proctorReqCard">
        <h2>ğŸ”’ Proctoring Requirements</h2>
        <div style="font-size:0.85rem;color:var(--muted);line-height:1.8;">
          <p>âœ… Screen sharing â€” entire screen</p><p>âœ… Camera â€” face visible</p><p>âœ… Tab switching â€” flagged</p><p>âœ… Copy/Paste â€” disabled</p><p>âœ… Single attempt</p>
          <p style="margin-top:8px;color:var(--yellow);">âš ï¸ 3+ violations = auto-termination</p>
        </div>
      </div>
      <button class="btn btn-go" id="startBtn" onclick="startInterview()">ğŸš€ Start Interview</button>
      <button class="btn btn-secondary" onclick="nav('home')">â† Back</button>
    </div>

    <!-- SCREEN SHARE OVERLAY -->
    <div id="screenShareOverlay" class="screen-share-overlay hidden">
      <h2>ğŸ–¥ï¸ Screen Share Required</h2><p>Share your <strong>entire screen</strong> to start.</p>
      <button class="btn btn-go" style="width:auto;padding:14px 40px;" onclick="requestScreenShare()">ğŸ“º Share Screen</button>
    </div>

    <!-- LIVE INTERVIEW -->
    <div id="page-live" class="hidden">
      <div class="card">
        <div class="proctor-bar" id="proctorBar" style="display:none;"><div style="display:flex;align-items:center;gap:4px;color:var(--green);"><div class="status-dot"></div>Proctored</div><div>âš ï¸ <span id="violationCount" style="color:var(--red);font-weight:700;">0</span>/3</div></div>
        <div class="progress-wrap"><div class="progress-fill" id="progBar"></div></div>
        <div class="progress-info"><span id="progText">Q 1/10</span><span class="q-tag" id="qTag">Q1</span></div>
        <div class="status-bar"><div class="status-dot"></div><span>Active</span></div>
        <div class="orb-container"><div><div class="orb" id="orb"></div><div class="orb-label" id="orbLabel">Preparing...</div></div></div>
        <div class="error-box" id="errorBox"></div>
        <div class="question-box" id="questionBox">Preparing...</div>
        <div class="thinking hidden" id="thinkBox"><div class="thinking-dots"><span></span><span></span><span></span></div><span>Analyzing...</span></div>
        <div class="hf-info" id="hfInfo">ğŸ¤ Hands-free â€” Speak naturally</div>
        <div class="wave-wrap" id="waveWrap"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
        <div class="silence-bar-wrap" id="silenceWrap"><div class="silence-bar"><div class="silence-fill" id="silenceFill"></div></div><div class="silence-text" id="silenceText"></div></div>
        <div class="timer" id="timer">00:00</div>
        <button class="btn-end" onclick="endEarly()">â¹ End Early</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="page-results" class="hidden">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">ğŸ† Interview Complete!</h2>
        <div class="score-ring" id="scoreRing"><div style="text-align:center"><div class="score-num" id="scoreNum">0</div><div class="score-max">/ 100</div></div></div>
        <div id="gradeBadge" class="grade-badge">â€”</div><br>
        <div id="hireBadge" class="hire-badge" style="display:none;"></div>
        <p id="scoreSummary" style="color:var(--muted);margin-bottom:20px;line-height:1.6;"></p>
        <div id="retryWrap" style="display:none;"><button class="btn btn-secondary" onclick="retryEvaluation()">ğŸ”„ Retry</button></div>
      </div>
      <div class="card" id="violationsCard" style="display:none;"><h2>ğŸ” Proctoring</h2><div id="violationsList"></div></div>
      <div class="card" id="strengthsCard" style="display:none;">
        <div class="summary-section"><h3>ğŸ’ª Strengths</h3><ul class="summary-list" id="strengthsList"></ul></div>
        <div class="summary-section"><h3>ğŸ“ˆ Improvements</h3><ul class="summary-list" id="improveList"></ul></div>
      </div>
      <div class="card"><h2>ğŸ“ Feedback</h2><div id="fbList"></div></div>
      <button class="btn btn-go" onclick="nav('home')">ğŸ  Home</button>
    </div>

    <!-- HR DASHBOARD (AUTH-GATED) -->
    <div id="page-hr" class="hidden">
      <!-- HR Login Form -->
      <div id="hrLoginSection">
        <div class="card hr-login-card">
          <h2>ğŸ¢ HR Dashboard</h2>
          <p style="color:var(--muted);margin-bottom:16px;">Login with your HR credentials</p>
          <label>Email</label>
          <input type="email" id="hrLoginEmail" placeholder="hr@company.com">
          <label>Password</label>
          <input type="password" id="hrLoginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')hrLogin()">
          <button class="btn btn-go" onclick="hrLogin()" id="hrLoginBtn">ğŸ”“ Login</button>
          <div id="hrLoginError" style="color:var(--red);font-size:.85rem;margin-top:8px;display:none;"></div>
        </div>
      </div>

      <!-- HR Dashboard (shown after auth) -->
      <div id="hrDashSection" class="hidden">
        <div class="hr-user-bar">
          <div>
            <div class="hr-name" id="hrUserName">â€”</div>
            <div class="hr-meta" id="hrUserMeta">â€”</div>
          </div>
          <button class="btn btn-sm btn-danger" onclick="hrLogout()">ğŸšª Logout</button>
        </div>
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-num" id="statJobs">0</div><div class="stat-label">Jobs</div></div>
          <div class="stat-card"><div class="stat-num" id="statApps">0</div><div class="stat-label">Applications</div></div>
          <div class="stat-card"><div class="stat-num" id="statShort">0</div><div class="stat-label">Shortlisted</div></div>
          <div class="stat-card"><div class="stat-num" id="statInt">0</div><div class="stat-label">Hired</div></div>
        </div>
        <div class="card">
          <h2>ğŸ“¢ Post Job</h2>
          <label>Title *</label><input type="text" id="hrTitle" placeholder="Senior Frontend Developer">
          <div class="row2"><div><label>Type</label><select id="hrJobType"><option value="full-time">Full-Time</option><option value="part-time">Part-Time</option><option value="contract">Contract</option><option value="remote">Remote</option></select></div><div><label>Department</label><input type="text" id="hrDept" placeholder="Engineering"></div></div>
          <div class="row2"><div><label>Location</label><input type="text" id="hrLocation" placeholder="Kochi, Kerala"></div><div><label>Level</label><select id="hrLevel"><option>Fresher</option><option>Junior</option><option selected>Mid-Level</option><option>Senior</option><option>Lead</option></select></div></div>
          <div class="row2"><div><label>Min Salary</label><input type="text" id="hrSalaryMin" placeholder="500000"></div><div><label>Max Salary</label><input type="text" id="hrSalaryMax" placeholder="1000000"></div></div>
          <label>Description</label><textarea id="hrJD" placeholder="Job description..."></textarea>
          <label>Skills (comma separated)</label><input type="text" id="hrSkills" placeholder="React, TypeScript, Node.js">
          <button class="btn btn-go" onclick="postJob()" id="postJobBtn">ğŸ“¢ Post Job</button>
        </div>
        <div class="card"><h2>ğŸ“ Your Jobs</h2><div id="hrJobsList"><span class="loading"></span></div></div>
        <div class="card"><h2>ğŸ“ Applications</h2>
          <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
            <button class="btn btn-sm" style="background:var(--accent);" onclick="loadHRApps('')">All</button>
            <button class="btn btn-sm btn-success" onclick="loadHRApps('applied')">Applied</button>
            <button class="btn btn-sm" style="background:rgba(59,130,246,.15);color:var(--blue);" onclick="loadHRApps('shortlisted')">Shortlisted</button>
            <button class="btn btn-sm" style="background:rgba(139,92,246,.15);color:var(--accent2);" onclick="loadHRApps('hired')">Hired</button>
          </div>
          <div id="hrCandList"><span class="loading"></span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Proctor Cam -->
  <div class="proctor-cam hidden" id="proctorCam"><video id="proctorVideo" autoplay muted playsinline></video><div class="cam-label">ğŸ”´ REC</div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” FIXED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W = "https://api.simpaticohr.in";
const SILENCE_TIMEOUT = 3.0, MIN_ANS = 10, MAX_RETRIES = 3, MAX_VIOLATIONS = 3;

// STATE (keep same)
let cv = "", lang = "en", role = "", level = "", totalQ = 10;
let mainQ = 0, isFollowUp = false, chat = [], answers = [];
let rec = null, transcript = "", timerInt = null, secs = 0;
let listening = false, silTimer = null, lastSpeech = 0;
let speaking = false, processing = false, ansStart = 0;
let evalRetry = 0, violations = [], screenStr = null, camStr = null;
let curJobId = null, curAppId = null, curToken = null, curInterview = null;
let interviewStartTime = null;

const L = {
  en:{s:"en-US",t:"en-US",n:"English"},hi:{s:"hi-IN",t:"hi-IN",n:"Hindi"},
  ml:{s:"ml-IN",t:"ml-IN",n:"Malayalam"},ta:{s:"ta-IN",t:"ta-IN",n:"Tamil"},
  te:{s:"te-IN",t:"te-IN",n:"Telugu"},kn:{s:"kn-IN",t:"kn-IN",n:"Kannada"},
  bn:{s:"bn-IN",t:"bn-IN",n:"Bengali"},es:{s:"es-ES",t:"es-ES",n:"Spanish"},
  ar:{s:"ar-SA",t:"ar-SA",n:"Arabic"},fr:{s:"fr-FR",t:"fr-FR",n:"French"},
  de:{s:"de-DE",t:"de-DE",n:"German"},ur:{s:"ur-PK",t:"ur-PK",n:"Urdu"}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPERS â€” FIXED (use proper endpoints)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiCall(method, path, body = null) {
  const opts = {
    method,
    headers: { "Content-Type": "application/json" }
  };
  if (body) opts.body = JSON.stringify(body);

  const r = await fetch(W + path, opts);
  const d = await r.json();
  if (d.error) throw new Error(d.error);
  return d;
}

async function callAI(messages) {
  const ctrl = new AbortController();
  const tm = setTimeout(() => ctrl.abort(), 45000);
  try {
    const r = await fetch(W + "/ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages }),
      signal: ctrl.signal
    });
    clearTimeout(tm);
    if (!r.ok) throw new Error("Error " + r.status);
    const d = await r.json();
    if (!d.response) throw new Error("Empty AI response");
    return d.response;
  } catch (e) {
    clearTimeout(tm);
    if (e.name === "AbortError") throw new Error("AI Timeout");
    throw e;
  }
}

function toast(m) {
  const c = document.getElementById("toasts");
  const t = document.createElement("div");
  t.className = "toast";
  t.textContent = m;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

function showError(m) {
  const b = document.getElementById("errorBox");
  if (b) { b.textContent = m; b.classList.add("show"); setTimeout(() => b.classList.remove("show"), 8000); }
}

function safeJSON(raw) {
  let c = raw.replace(/```json\s*/gi, "").replace(/```\s*/g, "").trim();
  const m = c.match(/\{[\s\S]*\}/);
  if (!m) throw new Error("No JSON");
  c = m[0].replace(/,\s*([}\]])/g, "$1");
  try { return JSON.parse(c); }
  catch {
    c = c.replace(/[\x00-\x1F\x7F]/g, " ");
    try { return JSON.parse(c); }
    catch { return exFields(raw); }
  }
}

function exFields(raw) {
  const gn = k => { const m = raw.match(new RegExp(`"${k}"\\s*:\\s*(\\d+)`)); return m ? parseInt(m[1]) : 0; };
  const gs = k => { const m = raw.match(new RegExp(`"${k}"\\s*:\\s*"([^"]*?)"`)); return m ? m[1] : ""; };
  const ga = k => { const m = raw.match(new RegExp(`"${k}"\\s*:\\s*\\[([^\\]]*?)\\]`, "s")); if (!m) return []; const i = m[1].match(/"([^"]*?)"/g); return i ? i.map(s => s.replace(/"/g, "")) : []; };
  const fb = [];
  for (const m of raw.matchAll(/"question"\s*:\s*"([^"]*?)"[^}]*?"score"\s*:\s*(\d+)[^}]*?"comment"\s*:\s*"([^"]*?)"/gs)) {
    fb.push({ question: m[1].substring(0, 100), score: parseInt(m[2]), comment: m[3], type: "main" });
  }
  return {
    overallScore: gn("overallScore") || 50,
    grade: gs("grade") || "C",
    recommendation: gs("recommendation") || "Pending",
    summary: gs("summary") || "Evaluation complete.",
    strengths: ga("strengths"),
    improvements: ga("improvements"),
    feedback: fb.length ? fb : answers.map(a => ({
      question: a.question.substring(0, 80),
      score: a.skipped ? 0 : 5,
      comment: a.skipped ? "Skipped" : "Recorded",
      type: a.type
    }))
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE EXTRACTORS (keep same)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function extractFile(f) {
  const ext = f.name.split(".").pop().toLowerCase();
  let text = "";
  if (ext === "txt") text = await f.text();
  else if (ext === "pdf") text = await extractPDF(f);
  else text = await f.text();
  return text.replace(/\s+/g, " ").replace(/[^\x20-\x7E\n]/g, "").trim().substring(0, 5000);
}

async function extractPDF(f) {
  if (!window.pdfjsLib) return await f.text();
  try {
    const b = await f.arrayBuffer();
    const p = await pdfjsLib.getDocument({ data: b }).promise;
    let t = "";
    for (let i = 1; i <= p.numPages; i++) {
      const pg = await p.getPage(i);
      const c = await pg.getTextContent();
      t += c.items.map(x => x.str).join(" ") + "\n";
    }
    return t;
  } catch { return await f.text(); }
}

document.getElementById("cvFile").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("cvFileName").textContent = "â³ Processing...";
  try {
    cv = await extractFile(file);
    if (cv.length < 30) {
      document.getElementById("cvFileName").textContent = "âš ï¸ Could not read file";
      cv = "";
      return;
    }
    document.getElementById("cvFileName").textContent = "âœ… " + file.name;
    document.getElementById("cvUpArea").classList.add("ok");
    toast("âœ… Resume loaded!");
  } catch {
    document.getElementById("cvFileName").textContent = "âŒ Error reading file";
    cv = "";
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN VALIDATION â€” FIXED (use /interviews/validate)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function validateToken() {
  const token = document.getElementById("tokenInput").value.trim();
  if (!token) { toast("âŒ Paste your token"); return; }
  await loadInterview(token);
}

async function loadInterview(token) {
  toast("ğŸ” Validating token...");
  try {
    // â˜… Use the proper /interviews/validate endpoint
    const data = await apiCall("POST", "/interviews/validate", { token });

    if (!data.interview) {
      toast("âŒ Invalid or expired token");
      return;
    }

    const d = data.interview;
    curToken = token;
    curInterview = d;
    curAppId = d.application_id || null;
    curJobId = d.job_id || null;

    role = d.role || d.interview_role || "";
    level = d.level || d.interview_level || "Mid-Level";
    totalQ = d.questions || d.question_count || 10;

    if (d.language || d.interview_language) {
      document.getElementById("langSel").value = d.language || d.interview_language;
    }

    // Load resume from application if available
    if (d.resume_text && d.resume_text.length > 50) {
      cv = d.resume_text;
      document.getElementById("cvFileName").textContent = "âœ… Resume loaded from application";
      document.getElementById("cvUpArea").classList.add("ok");
    }

    // Show interview info
    document.getElementById("interviewInfo").innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.85rem;">
        <div><span style="color:var(--text2);">ğŸ‘¤ Candidate:</span> <strong>${d.candidate_name || "â€”"}</strong></div>
        <div><span style="color:var(--text2);">ğŸ’¼ Role:</span> <strong style="color:var(--accent);">${role || "â€”"}</strong></div>
        <div><span style="color:var(--text2);">ğŸ“Š Level:</span> <strong>${level}</strong></div>
        <div><span style="color:var(--text2);">ğŸ”¢ Questions:</span> <strong>${totalQ}</strong></div>
        <div><span style="color:var(--text2);">ğŸ”’ Type:</span> <strong style="color:var(--red);">${d.type === "real" ? "Proctored" : "Practice"}</strong></div>
      </div>`;

    // Show setup page
    document.getElementById("page-landing").classList.add("hidden");
    document.getElementById("page-setup").classList.remove("hidden");
    toast("âœ… Token valid! Review settings and start.");

  } catch (e) {
    toast("âŒ " + e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(p) {
  ["landing", "setup", "live", "results"].forEach(x =>
    document.getElementById("page-" + x)?.classList.add("hidden")
  );
  document.getElementById("page-" + p)?.classList.remove("hidden");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORB / TTS / STT / SILENCE / TIMER (keep same logic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setOrb(s) {
  const o = document.getElementById("orb"), l = document.getElementById("orbLabel");
  if (!o) return;
  o.className = "orb";
  switch (s) {
    case "speaking": o.classList.add("speaking"); l.textContent = "Speaking..."; break;
    case "listening": o.classList.add("listening"); l.textContent = "Listening..."; break;
    case "thinking": o.classList.add("thinking"); l.textContent = "Thinking..."; break;
    case "processing": o.classList.add("processing"); l.textContent = "Processing..."; break;
    default: l.textContent = "Ready";
  }
}

function updateProg() {
  const p = Math.round((mainQ / totalQ) * 100);
  document.getElementById("progBar").style.width = p + "%";
  if (isFollowUp) {
    document.getElementById("progText").textContent = `Follow-up Q${mainQ}/${totalQ}`;
    document.getElementById("qTag").textContent = `Q${mainQ}â†©`;
    document.getElementById("qTag").className = "followup-tag";
  } else {
    document.getElementById("progText").textContent = `Question ${mainQ}/${totalQ} â€” ${p}%`;
    document.getElementById("qTag").textContent = `Q${mainQ}`;
    document.getElementById("qTag").className = "q-tag";
  }
}

if ("speechSynthesis" in window) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => {};
}

function speak(text) {
  return new Promise(resolve => {
    if (!("speechSynthesis" in window)) { resolve(); return; }
    speechSynthesis.cancel();
    speaking = true;
    setOrb("speaking");
    setTimeout(() => {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = L[lang]?.t || "en-US";
      u.rate = 0.92;
      u.pitch = 1;
      u.volume = 1;
      const voices = speechSynthesis.getVoices();
      const tl = (L[lang]?.t || "en-US").split("-")[0];
      const v = voices.find(v => v.lang.startsWith(tl));
      if (v) u.voice = v;
      // Keep-alive for long utterances
      const ka = setInterval(() => {
        if (!speaking) { clearInterval(ka); return; }
        speechSynthesis.pause();
        speechSynthesis.resume();
      }, 10000);
      u.onend = () => { clearInterval(ka); speaking = false; resolve(); };
      u.onerror = () => { clearInterval(ka); speaking = false; resolve(); };
      speechSynthesis.speak(u);
    }, 100);
  });
}

function initSTT() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { toast("âš ï¸ Use Chrome for speech recognition"); return; }
  rec = new SR();
  rec.lang = L[lang]?.s || "en-US";
  rec.interimResults = true;
  rec.continuous = true;
  rec.onresult = e => {
    let f = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) f += e.results[i][0].transcript + " ";
    }
    if (f) {
      transcript += f;
      lastSpeech = Date.now();
      resetSil();
      startSil();
    }
  };
  rec.onerror = e => {
    if (e.error !== "no-speech" && e.error !== "aborted") {
      console.error("[STT]", e.error);
    }
  };
  rec.onend = () => {
    if (listening && !processing && !speaking) {
      try { rec.start(); } catch {}
    }
  };
}

function startListen() {
  if (!rec || listening) return;
  listening = true;
  transcript = "";
  lastSpeech = Date.now();
  ansStart = Date.now();
  try { rec.start(); }
  catch {
    try { rec.stop(); } catch {}
    setTimeout(() => { try { rec.start(); } catch {} }, 200);
  }
  setOrb("listening");
  document.getElementById("waveWrap").classList.add("active");
  document.getElementById("hfInfo").textContent = "ğŸ¤ Listening... speak naturally";
  startTimer();
  startSil();
}

function stopListen() {
  listening = false;
  resetSil();
  try { rec?.stop(); } catch {}
  document.getElementById("waveWrap")?.classList.remove("active");
  stopTimer();
}

function startSil() {
  resetSil();
  silTimer = setInterval(() => {
    if (!listening || processing || speaking) return;
    const sf = (Date.now() - lastSpeech) / 1000;
    if (transcript.trim().length >= MIN_ANS && sf >= 1) {
      const rem = Math.max(0, SILENCE_TIMEOUT - sf);
      document.getElementById("silenceWrap").classList.add("show");
      document.getElementById("silenceFill").style.width = (rem / SILENCE_TIMEOUT * 100) + "%";
      document.getElementById("silenceText").textContent = rem > 0 ? `Auto-submit ${rem.toFixed(1)}s...` : "Submitting...";
      if (sf >= SILENCE_TIMEOUT) autoSubmit();
    } else {
      document.getElementById("silenceWrap").classList.remove("show");
    }
  }, 200);
}

function resetSil() {
  clearInterval(silTimer);
  silTimer = null;
  document.getElementById("silenceWrap")?.classList.remove("show");
}

function startTimer() {
  secs = 0;
  showTime();
  timerInt = setInterval(() => { secs++; showTime(); }, 1000);
}

function stopTimer() { clearInterval(timerInt); }

function showTime() {
  const el = document.getElementById("timer");
  if (el) {
    el.textContent = `${Math.floor(secs / 60).toString().padStart(2, "0")}:${(secs % 60).toString().padStart(2, "0")}`;
  }
}

function showThink(s) {
  document.getElementById("thinkBox")?.classList.toggle("hidden", !s);
  const w = document.getElementById("waveWrap");
  if (w) w.style.display = s ? "none" : "flex";
  const h = document.getElementById("hfInfo");
  if (h) h.style.display = s ? "none" : "block";
  document.getElementById("silenceWrap")?.classList.remove("show");
  if (s) document.getElementById("questionBox").textContent = "";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCTORING (keep same)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addViolation(type, detail) {
  violations.push({ type, detail, time: new Date().toLocaleTimeString(), qNum: mainQ });
  document.getElementById("violationCount").textContent = violations.length;
  toast("âš ï¸ " + detail);
  if (violations.length >= MAX_VIOLATIONS) {
    toast("ğŸš« Too many violations â€” terminated!");
    endEarly();
  }
}

function startProctor() {
  document.getElementById("proctorBar").style.display = "flex";
  violations = [];
  document.addEventListener("visibilitychange", onVis);
  window.addEventListener("blur", onBlur);
  document.addEventListener("copy", onClip);
  document.addEventListener("paste", onClip);
  document.addEventListener("cut", onClip);
  document.addEventListener("contextmenu", onCtx);
  document.addEventListener("keydown", onKey);
  startCam();
}

function stopProctor() {
  document.removeEventListener("visibilitychange", onVis);
  window.removeEventListener("blur", onBlur);
  document.removeEventListener("copy", onClip);
  document.removeEventListener("paste", onClip);
  document.removeEventListener("cut", onClip);
  document.removeEventListener("contextmenu", onCtx);
  document.removeEventListener("keydown", onKey);
  if (screenStr) { screenStr.getTracks().forEach(t => t.stop()); screenStr = null; }
  if (camStr) { camStr.getTracks().forEach(t => t.stop()); camStr = null; }
  document.getElementById("proctorCam")?.classList.add("hidden");
  document.getElementById("proctorBar").style.display = "none";
}

function onVis() { if (document.hidden) addViolation("tab", "Switched tab"); }
function onBlur() { if (!document.hidden) addViolation("blur", "Window lost focus"); }
function onClip(e) { e.preventDefault(); addViolation("clip", "Attempted " + e.type); }
function onCtx(e) { e.preventDefault(); }
function onKey(e) {
  if ((e.ctrlKey || e.metaKey) && ["c", "v", "u", "s", "a", "p"].includes(e.key.toLowerCase())) {
    e.preventDefault();
    addViolation("key", "Ctrl+" + e.key.toUpperCase());
  }
  if (e.key === "F12" || (e.ctrlKey && e.shiftKey && ["i", "j", "c"].includes(e.key.toLowerCase()))) {
    e.preventDefault();
    addViolation("dev", "DevTools attempt");
  }
}

async function startCam() {
  try {
    camStr = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    document.getElementById("proctorVideo").srcObject = camStr;
    document.getElementById("proctorCam").classList.remove("hidden");
  } catch {
    addViolation("cam", "Camera access denied");
  }
}

async function requestScreenShare() {
  try {
    screenStr = await navigator.mediaDevices.getDisplayMedia({ video: { displaySurface: "monitor" } });
    screenStr.getVideoTracks()[0].onended = () => {
      addViolation("screen", "Screen share stopped");
    };
    document.getElementById("screenShareOverlay").classList.add("hidden");
    toast("âœ… Screen sharing active");
    actuallyStart();
  } catch {
    toast("âŒ Screen share is required for proctored interviews");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START INTERVIEW â€” FIXED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startInterview() {
  if (!curInterview || !curToken) {
    toast("âŒ No valid interview token");
    return;
  }
  lang = document.getElementById("langSel").value;
  mainQ = 0;
  isFollowUp = false;
  answers = [];
  chat = [];
  evalRetry = 0;
  violations = [];
  interviewStartTime = new Date().toISOString();

  // Show screen share overlay for proctored
  document.getElementById("screenShareOverlay").classList.remove("hidden");
}

async function actuallyStart() {
  document.getElementById("screenShareOverlay").classList.add("hidden");

  const sys = `You are an expert AI interviewer for a ${level}-level "${role}" position.
LANGUAGE: ${L[lang]?.n || "English"} only.
${cv ? "\nRESUME:\n" + cv + "\n" : ""}
RULES:
1. Ask ${totalQ} MAIN questions. Mix behavioral, technical, situational.
2. For vague answers, ask C.L.A.I.M. follow-ups.
3. Follow-ups don't count toward ${totalQ} total.
4. Be conversational, professional. Adapt to ${level} level.
FORMAT: [NEXT] new question | [FOLLOWUP] follow-up | [DONE] end message
Start with [NEXT] and first question.`;

  chat = [{ role: "system", content: sys }];
  showPage("live");
  startProctor();
  setOrb("thinking");
  showThink(true);

  try {
    const fq = await callAI(chat);
    chat.push({ role: "assistant", content: fq });
    const cl = fq.replace(/\[NEXT\]\s*/i, "").replace(/\[FOLLOWUP\]\s*/i, "").trim();
    mainQ = 1;
    isFollowUp = false;
    showThink(false);
    document.getElementById("questionBox").textContent = cl;
    updateProg();
    initSTT();
    await speak(cl);
    startListen();
    toast("ğŸ¯ Interview started!");
  } catch (e) {
    showError("âŒ Could not start: " + e.message);
    showThink(false);
    setOrb("idle");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO SUBMIT + NEXT QUESTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function autoSubmit() {
  if (processing) return;
  processing = true;
  stopListen();
  setOrb("processing");

  const ans = transcript.trim();
  if (!ans || ans.length < MIN_ANS) {
    processing = false;
    toast("ğŸ¤ Still listening...");
    setTimeout(() => startListen(), 500);
    return;
  }

  const q = document.getElementById("questionBox").textContent;
  const dur = Math.round((Date.now() - ansStart) / 1000);
  answers.push({
    question: q,
    answer: ans,
    type: isFollowUp ? "followup" : "main",
    mainQNum: mainQ,
    duration: dur,
    skipped: false
  });
  transcript = "";
  await getNext(ans);
  processing = false;
}

async function getNext(ans) {
  showThink(true);
  setOrb("thinking");

  const p = `Candidate answered: "${ans}"
Main asked: ${mainQ}/${totalQ}.
- Vague â†’ [FOLLOWUP] probe
- Good â†’ [NEXT] new question
${mainQ >= totalQ && !isFollowUp ? "- All done â†’ [DONE] brief thanks" : ""}
Output ONLY tag + question. Stay in ${L[lang]?.n || "English"}.`;

  chat.push({ role: "user", content: p });

  try {
    const r = await callAI(chat);
    chat.push({ role: "assistant", content: r });
    showThink(false);

    const u = r.toUpperCase();
    const cl = r.replace(/\[FOLLOWUP\]\s*/i, "").replace(/\[NEXT\]\s*/i, "").replace(/\[DONE\]\s*/i, "").trim();

    if (u.includes("[DONE]")) {
      document.getElementById("questionBox").textContent = cl;
      mainQ = totalQ;
      updateProg();
      await speak(cl);
      setTimeout(() => showResults(), 2000);
      return;
    }
    if (u.includes("[NEXT]")) { mainQ++; isFollowUp = false; if (mainQ > totalQ) mainQ = totalQ; }
    if (u.includes("[FOLLOWUP]")) isFollowUp = true;

    document.getElementById("questionBox").textContent = cl;
    updateProg();
    await speak(cl);
    startListen();
  } catch (e) {
    showError("âŒ " + e.message);
    showThink(false);
    setOrb("idle");
  }
}

function endEarly() {
  if (answers.length < 1) { toast("âš ï¸ Answer at least 1 question"); return; }
  stopListen();
  speechSynthesis?.cancel();
  showResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS â€” FIXED (use /interviews/submit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showResults() {
  stopListen();
  speechSynthesis?.cancel();
  stopProctor();
  showPage("results");
  toast("ğŸ“Š Evaluating your performance...");
  await genEval();
}

async function genEval() {
  const qa = answers.map(a => {
    const t = a.type === "followup" ? "FOLLOW-UP" : "MAIN Q" + a.mainQNum;
    return `[${t}] (${a.duration || 0}s)\nQ: ${a.question.replace(/["\n\r\t\\]/g, " ").substring(0, 200)}\nA: ${a.skipped ? "SKIPPED" : a.answer.replace(/["\n\r\t\\]/g, " ").substring(0, 300)}`;
  }).join("\n\n");

  const em = [
    { role: "system", content: "You are a hiring evaluator. Return ONLY valid JSON. No markdown." },
    {
      role: "user", content: `Evaluate this ${level} interview for ${role}.
${violations.length ? "VIOLATIONS: " + violations.length + "\n" : ""}Transcript:\n${qa}\n
Return ONLY: {"overallScore":65,"grade":"B","recommendation":"Lean Hire","summary":"Brief.","strengths":["s1"],"improvements":["i1"],"feedback":[{"question":"q","score":7,"comment":"c","type":"main"}]}
Keep strings short. ONLY JSON.`
    }
  ];

  try {
    const raw = await callAI(em);
    const r = safeJSON(raw);

    if (typeof r.overallScore !== "number" || r.overallScore < 0 || r.overallScore > 100) {
      r.overallScore = 50;
    }
    if (violations.length) {
      r.overallScore = Math.max(0, r.overallScore - violations.length * 5);
      r.summary += " (" + violations.length + " violations, -" + violations.length * 5 + "pts)";
    }

    renderRes(r);
    await saveResults(r);
    toast("ğŸ† Evaluation complete!");
    document.getElementById("retryWrap").style.display = "none";
  } catch (e) {
    console.error("[EVAL]", e);
    evalRetry++;
    if (evalRetry < MAX_RETRIES) {
      toast("âš ï¸ Retry " + evalRetry + "/" + MAX_RETRIES);
      await genEval();
    } else {
      toast("âš ï¸ Using local evaluation");
      renderFallback();
      document.getElementById("retryWrap").style.display = "block";
    }
  }
}

async function saveResults(r) {
  if (!curToken) return;

  try {
    // â˜… Use the proper /interviews/submit endpoint
    await apiCall("POST", "/interviews/submit", {
      token: curToken,
      score: r.overallScore,
      grade: r.grade,
      recommendation: r.recommendation,
      summary: r.summary,
      strengths: r.strengths || [],
      improvements: r.improvements || [],
      feedback: r.feedback || [],
      answers: answers,
      violations: violations.length,
      violation_log: violations,
      duration: secs,
      started_at: interviewStartTime
    });
    console.log("[SUBMIT] Results saved successfully");
  } catch (e) {
    console.error("[SUBMIT]", e.message);
    toast("âš ï¸ Could not save results to server");
  }
}

async function retryEvaluation() {
  evalRetry = 0;
  toast("ğŸ”„ Retrying evaluation...");
  document.getElementById("scoreNum").textContent = "0";
  document.getElementById("gradeBadge").textContent = "â€”";
  document.getElementById("fbList").innerHTML = "";
  document.getElementById("strengthsCard").style.display = "none";
  document.getElementById("hireBadge").style.display = "none";
  document.getElementById("retryWrap").style.display = "none";
  await genEval();
}

function renderFallback() {
  const ma = answers.filter(a => a.type === "main" && !a.skipped).length;
  const sc = Math.max(0, Math.round((ma / Math.max(totalQ, 1)) * 70) - violations.length * 5);
  renderRes({
    overallScore: sc,
    grade: sc >= 70 ? "B" : sc >= 50 ? "C" : "D",
    recommendation: sc >= 60 ? "Lean Hire" : "Lean No Hire",
    summary: `Answered ${ma}/${totalQ}.${violations.length ? " " + violations.length + " violations." : ""}`,
    strengths: ma > 0 ? ["Participated in interview"] : [],
    improvements: ["Provide more detailed answers"],
    feedback: answers.map(a => ({
      question: a.question.substring(0, 80),
      score: a.skipped ? 0 : 5,
      comment: a.skipped ? "Skipped" : "Answer recorded",
      type: a.type
    }))
  });
}

function renderRes(r) {
  const sc = r.overallScore || 0;
  const gr = r.grade || "?";
  const ok = sc >= 80, mid = sc >= 60;
  const col = ok ? "#3fb950" : mid ? "#d29922" : "#f85149";
  const bg = ok ? "rgba(63,185,80,0.15)" : mid ? "rgba(210,153,34,0.15)" : "rgba(248,81,73,0.15)";

  document.getElementById("scoreRing").style.background =
    `conic-gradient(${col} ${sc * 3.6}deg, rgba(255,255,255,0.05) 0deg)`;

  const b = document.getElementById("gradeBadge");
  b.textContent = "Grade: " + gr;
  b.style.background = bg;
  b.style.color = col;

  if (r.recommendation) {
    const h = document.getElementById("hireBadge");
    h.style.display = "inline-block";
    h.textContent = r.recommendation;
    const hire = r.recommendation.toLowerCase().includes("hire") && !r.recommendation.toLowerCase().includes("no");
    h.style.background = hire ? "rgba(63,185,80,0.15)" : "rgba(248,81,73,0.15)";
    h.style.color = hire ? "#3fb950" : "#f85149";
  }

  document.getElementById("scoreSummary").textContent = r.summary || "";

  if (r.strengths?.length || r.improvements?.length) {
    document.getElementById("strengthsCard").style.display = "block";
    document.getElementById("strengthsList").innerHTML =
      (r.strengths || []).map(s => "<li><span>âœ…</span> " + s + "</li>").join("");
    document.getElementById("improveList").innerHTML =
      (r.improvements || []).map(s => "<li><span>ğŸ“ˆ</span> " + s + "</li>").join("");
  }

  if (violations.length) {
    document.getElementById("violationsCard").style.display = "block";
    document.getElementById("violationsList").innerHTML =
      violations.map(v => '<div class="violation-item"><span style="font-size:0.7rem;color:var(--text2);">' + v.time + '</span> âš ï¸ ' + v.detail + "</div>").join("");
  }

  const list = document.getElementById("fbList");
  list.innerHTML = "";
  (r.feedback || []).forEach((fb, i) => {
    const s = fb.score || 0;
    const c = s >= 7 ? "#3fb950" : s >= 5 ? "#d29922" : "#f85149";
    const bg2 = s >= 7 ? "rgba(63,185,80,0.15)" : s >= 5 ? "rgba(210,153,34,0.15)" : "rgba(248,81,73,0.15)";
    const tc = fb.type === "followup" ? "rgba(188,140,255,0.15)" : "rgba(99,102,241,0.15)";
    const tt = fb.type === "followup" ? "#bc8cff" : "#6366f1";
    const tl = fb.type === "followup" ? "Follow-up" : "Main";
    const ma = answers[i];
    const pv = ma ? (ma.skipped ? "[Skipped]" : ma.answer.substring(0, 120) + (ma.answer.length > 120 ? "..." : "")) : "";

    const d = document.createElement("div");
    d.className = "fb-item";
    d.innerHTML = `
      <div class="fb-q">${fb.question}<span class="fb-type" style="background:${tc};color:${tt};">${tl}</span></div>
      ${pv ? `<div class="fb-a">"${pv}"</div>` : ""}
      <span class="fb-score" style="background:${bg2};color:${c};">${s}/10</span>
      <div class="fb-text">${fb.comment}</div>`;
    list.appendChild(d);
  });

  // Animate score counter
  let cur = 0;
  const el = document.getElementById("scoreNum");
  const iv = setInterval(() => {
    cur += Math.ceil(sc / 30);
    if (cur >= sc) { cur = sc; clearInterval(iv); }
    el.textContent = cur;
  }, 30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-CHECK TOKEN FROM URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener("DOMContentLoaded", () => {
  if (window.pdfjsLib) console.log("âœ… PDF.js loaded");
  if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
    console.warn("âš ï¸ Use Chrome for speech recognition");
  }
  const token = new URLSearchParams(location.search).get("token");
  if (token) {
    document.getElementById("tokenInput").value = token;
    loadInterview(token);
  }
});
</script>
</body>
</html>
