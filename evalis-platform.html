<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform | Simpatico HR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#020617;--card:rgba(15,23,42,.65);--card2:rgba(30,41,59,.5);--border:rgba(255,255,255,.08);--accent:#6366f1;--accent2:#8b5cf6;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;--text:#f8fafc;--muted:#94a3b8;--glow:rgba(99,102,241,.15)}
    body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:radial-gradient(circle at 10% 20%,rgba(99,102,241,.15),transparent 40%),radial-gradient(circle at 90% 80%,rgba(79,70,229,.1),transparent 40%),var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
    .container{max-width:780px;margin:0 auto;padding:16px;position:relative;z-index:1}

    /* Nav */
    .top-nav{backdrop-filter:blur(16px);background:rgba(2,6,23,.85);padding:1rem 6%;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .top-logo{font-weight:800;font-size:1.1rem;color:#fff;text-decoration:none}.top-logo span{color:var(--accent)}
    .top-links{display:flex;gap:12px;align-items:center}
    .top-link{color:var(--muted);text-decoration:none;font-size:12px;font-weight:600;padding:6px 12px;border-radius:8px;transition:all 0.2s}
    .top-link:hover{color:#fff;background:rgba(255,255,255,.05)}

    .header{text-align:center;padding:30px 0 20px}
    .header h1{font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#fff,#94a3b8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:var(--muted);font-size:0.9rem;margin-top:4px}
    .card{background:var(--card);backdrop-filter:blur(22px);border:1px solid var(--border);border-radius:20px;padding:24px;margin-bottom:14px}
    .card h2{font-size:1rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    label{display:block;font-size:0.78rem;color:var(--muted);margin:12px 0 4px;font-weight:600}
    select,input[type="text"],input[type="email"],input[type="tel"],textarea{width:100%;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;outline:none;transition:border-color 0.2s;font-family:inherit}
    select:focus,input:focus,textarea:focus{border-color:rgba(99,102,241,.4);box-shadow:0 0 0 3px var(--glow)}
    select option{background:#1e293b}
    textarea{resize:vertical;min-height:80px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .upload-area{border:2px dashed var(--border);border-radius:14px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s;margin-top:8px}
    .upload-area:hover{border-color:rgba(99,102,241,.4);background:rgba(99,102,241,.03)}
    .upload-area.ok{border-color:var(--green);background:rgba(16,185,129,.05)}
    .upload-area p{font-size:0.85rem;color:var(--muted)}
    .upload-area strong{color:var(--accent)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border:none;border-radius:10px;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s;color:#fff;font-family:inherit}
    .btn-go{width:100%;padding:14px;font-size:1rem;background:linear-gradient(135deg,var(--accent),var(--accent2));margin-top:16px;border-radius:14px}
    .btn-go:hover{transform:translateY(-1px);box-shadow:0 6px 20px var(--glow)}
    .btn-go:disabled{opacity:0.4;cursor:not-allowed;transform:none}
    .btn-secondary{background:transparent;border:1px solid var(--border);color:#fff;width:100%;margin-top:8px;padding:12px;border-radius:12px}
    .btn-secondary:hover{border-color:rgba(99,102,241,.4)}
    .btn-sm{padding:6px 12px;font-size:0.78rem;border-radius:8px}
    .btn-danger{background:rgba(239,68,68,.15);color:var(--red)}
    .btn-success{background:rgba(16,185,129,.15);color:var(--green)}

    /* Nav tabs */
    .nav{display:flex;gap:0;margin-bottom:16px;background:rgba(255,255,255,.03);border-radius:14px;padding:4px;border:1px solid var(--border);flex-wrap:wrap}
    .nav-btn{flex:1;padding:10px 6px;text-align:center;border:none;background:transparent;color:var(--muted);font-size:0.78rem;font-weight:700;cursor:pointer;border-radius:10px;transition:all 0.2s;font-family:inherit;min-width:60px}
    .nav-btn.active{background:var(--accent);color:#fff}
    .nav-btn:hover:not(.active){background:rgba(99,102,241,.1)}

    /* Mode cards */
    .mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
    .mode-card{background:var(--card);border:2px solid var(--border);border-radius:20px;padding:20px 16px;text-align:center;cursor:pointer;transition:all 0.3s}
    .mode-card:hover{border-color:rgba(99,102,241,.4);transform:translateY(-2px);box-shadow:0 8px 24px var(--glow)}
    .mode-card.selected{border-color:var(--accent);background:rgba(99,102,241,.05)}
    .mode-card .mode-icon{font-size:2.2rem;margin-bottom:8px}
    .mode-card h3{font-size:0.95rem;margin-bottom:4px}
    .mode-card p{font-size:0.78rem;color:var(--muted);line-height:1.4}
    .mode-badge{display:inline-block;padding:2px 10px;border-radius:10px;font-size:0.7rem;font-weight:800;margin-top:6px}

    /* Job & Candidate */
    .job-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:10px;transition:all 0.2s;cursor:pointer}
    .job-card:hover{border-color:rgba(99,102,241,.3)}
    .job-card h3{font-size:0.95rem;margin-bottom:4px;color:var(--accent)}
    .job-meta{font-size:0.78rem;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .skill-tag{background:rgba(99,102,241,.1);color:#a5b4fc;padding:2px 8px;border-radius:6px;font-size:0.72rem;display:inline-block;margin:2px}
    .cand-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);gap:8px;flex-wrap:wrap}
    .cand-row:last-child{border-bottom:none}
    .cand-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.8rem;flex-shrink:0}
    .score-badge{padding:2px 8px;border-radius:8px;font-size:0.75rem;font-weight:700}
    .status-pill{padding:2px 8px;border-radius:10px;font-size:0.72rem;font-weight:700}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
    .stat-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center}
    .stat-num{font-size:1.4rem;font-weight:800;color:var(--accent)}
    .stat-label{font-size:0.7rem;color:var(--muted)}

    /* Interview UI */
    .progress-wrap{background:rgba(255,255,255,.05);border-radius:20px;height:8px;overflow:hidden;margin-bottom:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:20px;transition:width 0.5s;width:0%}
    .progress-info{display:flex;justify-content:space-between;font-size:0.8rem;color:var(--muted);margin-bottom:16px}
    .q-tag{background:rgba(99,102,241,.15);color:var(--accent);padding:2px 10px;border-radius:12px;font-weight:700}
    .followup-tag{background:rgba(139,92,246,.15);color:var(--accent2);padding:2px 10px;border-radius:12px;font-weight:700;font-size:0.75rem}
    .orb-container{display:flex;justify-content:center;margin:24px 0 16px}
    .orb{width:110px;height:110px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(99,102,241,.8),rgba(139,92,246,.6),rgba(99,102,241,.3));position:relative;animation:orbFloat 4s ease-in-out infinite;box-shadow:0 0 30px rgba(99,102,241,.3),0 0 60px rgba(139,92,246,.15),inset 0 0 30px rgba(255,255,255,.1);margin:0 auto}
    .orb::before{content:'';position:absolute;inset:-8px;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);border-right-color:var(--accent2);animation:orbSpin 3s linear infinite}
    .orb::after{content:'';position:absolute;inset:10px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,.2),transparent 70%);animation:orbPulse 2s ease-in-out infinite}
    @keyframes orbFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes orbSpin{to{transform:rotate(360deg)}}
    @keyframes orbPulse{0%,100%{opacity:.5;transform:scale(.9)}50%{opacity:1;transform:scale(1.1)}}
    .orb.speaking{background:radial-gradient(circle at 35% 35%,rgba(16,185,129,.9),rgba(99,102,241,.6),rgba(16,185,129,.3));box-shadow:0 0 40px rgba(16,185,129,.4);animation:orbFloat 2s ease-in-out infinite,orbSpeak .5s ease-in-out infinite}
    @keyframes orbSpeak{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.06)}}
    .orb.listening{background:radial-gradient(circle at 35% 35%,rgba(99,102,241,.9),rgba(139,92,246,.8),rgba(99,102,241,.3));box-shadow:0 0 40px rgba(99,102,241,.5);animation:orbFloat 2s ease-in-out infinite,orbListen 1s ease-in-out infinite}
    @keyframes orbListen{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.04)}}
    .orb.thinking{opacity:.6;animation:orbFloat 1.5s ease-in-out infinite}
    .orb.processing{background:radial-gradient(circle at 35% 35%,rgba(245,158,11,.9),rgba(139,92,246,.6),rgba(245,158,11,.3));box-shadow:0 0 40px rgba(245,158,11,.4);animation:orbFloat 1.5s ease-in-out infinite}
    .orb-label{margin-top:12px;font-size:0.8rem;color:var(--muted);letter-spacing:1px;text-align:center}
    .question-box{background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(139,92,246,.08));border:1px solid rgba(99,102,241,.15);border-radius:16px;padding:20px;margin-bottom:16px;font-size:1.05rem;line-height:1.7;min-height:70px;text-align:center}
    .error-box{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:12px;margin-bottom:12px;font-size:0.85rem;color:var(--red);display:none}
    .error-box.show{display:block}
    .thinking{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:0.85rem;margin:12px 0}
    .thinking-dots span{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;animation:dot 1.2s infinite}
    .thinking-dots span:nth-child(2){animation-delay:.2s}
    .thinking-dots span:nth-child(3){animation-delay:.4s}
    @keyframes dot{0%,100%{opacity:.2;transform:scale(.8)}50%{opacity:1;transform:scale(1.3)}}
    .silence-bar-wrap{width:80%;max-width:300px;margin:12px auto;text-align:center;display:none}
    .silence-bar-wrap.show{display:block}
    .silence-bar{height:4px;background:var(--card2);border-radius:2px;overflow:hidden}
    .silence-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .3s linear;width:100%}
    .silence-text{font-size:0.75rem;color:var(--muted);margin-top:4px}
    .wave-wrap{display:flex;justify-content:center;align-items:center;gap:3px;height:40px;margin:12px 0}
    .wave-bar{width:4px;height:8px;background:var(--accent);border-radius:4px}
    .wave-wrap.active .wave-bar{animation:wave .8s ease-in-out infinite alternate}
    .wave-bar:nth-child(1){animation-delay:0s}.wave-bar:nth-child(2){animation-delay:.1s}.wave-bar:nth-child(3){animation-delay:.2s}.wave-bar:nth-child(4){animation-delay:.3s}.wave-bar:nth-child(5){animation-delay:.4s}.wave-bar:nth-child(6){animation-delay:.3s}.wave-bar:nth-child(7){animation-delay:.2s}.wave-bar:nth-child(8){animation-delay:.1s}.wave-bar:nth-child(9){animation-delay:0s}
    @keyframes wave{from{height:8px}to{height:36px}}
    .timer{text-align:center;font-size:1.4rem;font-weight:700;font-variant-numeric:tabular-nums;margin:8px 0}
    .hf-info{text-align:center;font-size:0.8rem;color:var(--muted);padding:8px;background:rgba(99,102,241,.05);border-radius:10px;margin-bottom:12px}
    .btn-end{background:rgba(239,68,68,.15);color:var(--red);width:100%;margin-top:16px;padding:12px;border-radius:12px;border:none;cursor:pointer;font-family:inherit;font-weight:700}
    .status-bar{display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.8rem;color:var(--muted);margin-bottom:12px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

    /* Results */
    .score-ring{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
    .score-num{font-size:2.2rem;font-weight:800}
    .score-max{font-size:0.9rem;color:var(--muted)}
    .grade-badge{display:inline-block;padding:4px 16px;border-radius:16px;font-weight:700;font-size:0.85rem;margin-bottom:12px}
    .hire-badge{display:inline-block;padding:6px 20px;border-radius:20px;font-weight:700;font-size:0.9rem;margin-bottom:16px}
    .summary-section{margin-bottom:16px}
    .summary-section h3{font-size:0.9rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .summary-list{list-style:none;padding:0}
    .summary-list li{padding:6px 0;font-size:0.85rem;color:var(--muted);border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:8px}
    .summary-list li:last-child{border-bottom:none}
    .fb-item{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px}
    .fb-item .fb-q{font-weight:700;color:var(--accent);margin-bottom:4px;font-size:0.9rem}
    .fb-item .fb-a{font-size:0.8rem;color:var(--muted);margin-bottom:6px;font-style:italic;opacity:.8}
    .fb-item .fb-score{font-size:0.75rem;padding:2px 8px;border-radius:8px;display:inline-block;margin-bottom:6px}
    .fb-item .fb-text{font-size:0.85rem;color:var(--muted);line-height:1.5}
    .fb-item .fb-type{font-size:0.7rem;padding:1px 6px;border-radius:4px;display:inline-block;margin-left:6px}

    /* Proctoring */
    .proctor-bar{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);border-radius:12px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;font-size:0.8rem}
    .proctor-cam{width:120px;height:90px;border-radius:10px;border:2px solid var(--border);overflow:hidden;position:fixed;bottom:16px;right:16px;z-index:100;background:#000}
    .proctor-cam video{width:100%;height:100%;object-fit:cover}
    .proctor-cam .cam-label{position:absolute;bottom:2px;left:4px;font-size:0.6rem;color:rgba(255,255,255,.7);background:rgba(0,0,0,.5);padding:1px 4px;border-radius:3px}
    .violation-item{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(239,68,68,.08);border-radius:8px;margin-bottom:4px;font-size:0.78rem;color:var(--red)}
    .screen-share-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:20px}
    .screen-share-overlay h2{color:var(--text)}
    .screen-share-overlay p{color:var(--muted);font-size:0.9rem;max-width:400px;text-align:center;line-height:1.6}

    .toast-box{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:rgba(15,23,42,.9);backdrop-filter:blur(12px);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:12px;font-size:0.85rem;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:tIn .3s ease,tOut .3s ease 2.7s forwards}
    @keyframes tIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(120%);opacity:0}}
    .hidden{display:none!important}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:600px){
      .container{padding:10px}.header h1{font-size:1.5rem}
      .row2,.row3,.mode-cards{grid-template-columns:1fr}
      .stat-grid{grid-template-columns:1fr 1fr}
      .orb{width:90px;height:90px}
      .nav-btn{font-size:0.7rem;padding:8px 4px}
      .proctor-cam{width:80px;height:60px}
      .cand-row{flex-direction:column;align-items:flex-start}
      .top-nav{padding:1rem 4%}.top-links{gap:6px}.top-link{font-size:11px;padding:4px 8px}
    }
  </style>
</head>
<body>
  <div class="toast-box" id="toasts"></div>

  <!-- Top Nav -->
  <nav class="top-nav">
    <a class="top-logo" href="index.html">SIMPATICO <span>HR</span></a>
    <div class="top-links">
      <a class="top-link" href="career-lab.html">ğŸ§  Career Lab</a>
      <a class="top-link" href="jobs.html">ğŸ’¼ Jobs</a>
      <a class="top-link" href="index.html">Home</a>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h1>ğŸ§  AI Interview Platform</h1>
      <p>Intelligent â€¢ Adaptive â€¢ Proctored</p>
    </div>

    <!-- NAV -->
    <div class="nav" id="mainNav">
      <button class="nav-btn active" onclick="nav('home')">ğŸ  Home</button>
      <button class="nav-btn" onclick="nav('jobs')">ğŸ’¼ Jobs</button>
      <button class="nav-btn" onclick="nav('apply')">ğŸ“ Apply</button>
      <button class="nav-btn" onclick="nav('setup')">ğŸ¤ Interview</button>
      <button class="nav-btn" onclick="nav('hr')">ğŸ¢ HR</button>
    </div>

    <!-- HOME -->
    <div id="page-home">
      <div class="mode-cards">
        <div class="mode-card" onclick="nav('jobs')"><div class="mode-icon">ğŸ’¼</div><h3>Browse Jobs</h3><p>View openings & apply</p><span class="mode-badge" style="background:rgba(16,185,129,.15);color:var(--green);">APPLY</span></div>
        <div class="mode-card" onclick="startMode('mock')"><div class="mode-icon">ğŸ¯</div><h3>Mock Interview</h3><p>Practice freely. No monitoring.</p><span class="mode-badge" style="background:rgba(99,102,241,.15);color:var(--accent);">FREE</span></div>
        <div class="mode-card" onclick="startMode('real')"><div class="mode-icon">ğŸ”’</div><h3>Real Interview</h3><p>Proctored. Anti-cheat. One attempt.</p><span class="mode-badge" style="background:rgba(239,68,68,.15);color:var(--red);">PROCTORED</span></div>
        <div class="mode-card" onclick="nav('hr')"><div class="mode-icon">ğŸ¢</div><h3>HR Dashboard</h3><p>Post jobs, manage candidates</p><span class="mode-badge" style="background:rgba(245,158,11,.15);color:var(--yellow);">ADMIN</span></div>
      </div>
    </div>

    <!-- JOBS -->
    <div id="page-jobs" class="hidden">
      <div class="card"><h2>ğŸ’¼ Open Positions</h2><div id="jobsList"><span class="loading"></span> Loading...</div></div>
    </div>

    <!-- APPLY -->
    <div id="page-apply" class="hidden">
      <div class="card">
        <h2>ğŸ“ Job Application</h2>
        <div id="applyJobInfo" style="color:var(--accent);font-weight:700;margin-bottom:12px;"></div>
        <div class="row2"><div><label>Full Name *</label><input type="text" id="applyName" placeholder="Your name"></div><div><label>Email *</label><input type="email" id="applyEmail" placeholder="you@email.com"></div></div>
        <label>Phone</label><input type="tel" id="applyPhone" placeholder="+91 XXXXX XXXXX">
        <label>Upload Resume (PDF) *</label>
        <div class="upload-area" id="applyUpload" onclick="document.getElementById('applyFile').click()">
          <p>ğŸ“‚ Click to upload <strong>PDF, TXT</strong></p>
          <p id="applyFileName" style="font-size:0.78rem;color:var(--muted);margin-top:4px;">No file</p>
          <input type="file" id="applyFile" accept=".pdf,.txt,.doc,.docx" hidden>
        </div>
        <button class="btn btn-go" id="applyBtn" onclick="submitApplication()">ğŸ“¨ Submit Application</button>
        <div id="applyStatus" style="text-align:center;margin-top:12px;font-size:0.9rem;"></div>
      </div>
    </div>

    <!-- INTERVIEW SETUP -->
    <div id="page-setup" class="hidden">
      <div class="card">
        <h2>âš™ï¸ Interview Setup</h2>
        <div id="modeIndicator" style="text-align:center;margin-bottom:14px;"></div>
        <label>ğŸŒ Language</label>
        <select id="langSel">
          <option value="en">English</option><option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)</option><option value="ml">à´®à´²à´¯à´¾à´³à´‚ (Malayalam)</option><option value="ta">à®¤à®®à®¿à®´à¯ (Tamil)</option><option value="te">à°¤à±†à°²à±à°—à± (Telugu)</option><option value="kn">à²•à²¨à³à²¨à²¡ (Kannada)</option><option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾ (Bengali)</option><option value="es">EspaÃ±ol</option><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="fr">FranÃ§ais</option><option value="de">Deutsch</option><option value="ur">Ø§Ø±Ø¯Ùˆ</option>
        </select>
        <label>ğŸ’¼ Job Role</label>
        <select id="roleSel">
          <option value="">â€” Select â€”</option><option value="Frontend Developer">Frontend Developer</option><option value="Backend Developer">Backend Developer</option><option value="Full Stack Developer">Full Stack Developer</option><option value="Mobile Developer">Mobile Developer</option><option value="Data Scientist">Data Scientist</option><option value="DevOps Engineer">DevOps Engineer</option><option value="UI/UX Designer">UI/UX Designer</option><option value="Product Manager">Product Manager</option><option value="QA Engineer">QA Engineer</option><option value="Cybersecurity Analyst">Cybersecurity</option><option value="Sales Representative">Sales</option><option value="Marketing Manager">Marketing</option><option value="HR Recruiter">HR</option><option value="Finance Analyst">Finance</option><option value="Customer Support">Support</option><option value="custom">âœï¸ Custom...</option>
        </select>
        <div id="customWrap" class="hidden"><label>Enter Role</label><input type="text" id="customRole" placeholder="e.g. Blockchain Developer"></div>
        <div class="row2">
          <div><label>ğŸ“Š Level</label><select id="levelSel"><option value="Fresher">Fresher</option><option value="Junior">Junior</option><option value="Mid-Level" selected>Mid-Level</option><option value="Senior">Senior</option><option value="Lead">Lead</option></select></div>
          <div><label>ğŸ”¢ Questions</label><select id="qCount"><option value="5">5</option><option value="8">8</option><option value="10" selected>10</option><option value="15">15</option></select></div>
        </div>
      </div>
      <div class="card hidden" id="realInfoCard">
        <h2>ğŸ‘¤ Your Information</h2>
        <div class="row2"><div><label>Full Name *</label><input type="text" id="candName"></div><div><label>Email *</label><input type="email" id="candEmail"></div></div>
        <label>Interview Token</label><input type="text" id="candToken" placeholder="Paste from invitation email">
      </div>
      <div class="card"><h2>ğŸ“„ Resume</h2>
        <div class="upload-area" id="cvUpArea" onclick="document.getElementById('cvFile').click()">
          <p>ğŸ“‚ Upload <strong>PDF, DOC, TXT</strong></p>
          <p id="cvFileName" style="font-size:0.78rem;color:var(--muted);margin-top:4px;">No file</p>
          <input type="file" id="cvFile" accept=".pdf,.doc,.docx,.txt" hidden>
        </div>
      </div>
      <div class="card hidden" id="proctorReqCard">
        <h2>ğŸ”’ Proctoring Requirements</h2>
        <div style="font-size:0.85rem;color:var(--muted);line-height:1.8;">
          <p>âœ… Screen sharing â€” entire screen monitored</p><p>âœ… Camera â€” face must be visible</p><p>âœ… Tab switching â€” flagged as violation</p><p>âœ… Copy/Paste â€” disabled</p><p>âœ… Single attempt â€” cannot restart</p>
          <p style="margin-top:8px;color:var(--yellow);">âš ï¸ 3+ violations = auto-termination</p>
        </div>
      </div>
      <button class="btn btn-go" id="startBtn" onclick="startInterview()">ğŸš€ Start Interview</button>
      <button class="btn btn-secondary" onclick="nav('home')">â† Back</button>
    </div>

    <!-- SCREEN SHARE OVERLAY -->
    <div id="screenShareOverlay" class="screen-share-overlay hidden">
      <h2>ğŸ–¥ï¸ Screen Share Required</h2><p>Share your <strong>entire screen</strong> to start.</p>
      <button class="btn btn-go" style="width:auto;padding:14px 40px;" onclick="requestScreenShare()">ğŸ“º Share Screen</button>
    </div>

    <!-- LIVE INTERVIEW -->
    <div id="page-live" class="hidden">
      <div class="card">
        <div class="proctor-bar" id="proctorBar" style="display:none;"><div style="display:flex;align-items:center;gap:4px;color:var(--green);"><div class="status-dot"></div>Proctored</div><div>âš ï¸ Violations: <span id="violationCount" style="color:var(--red);font-weight:700;">0</span>/3</div></div>
        <div class="progress-wrap"><div class="progress-fill" id="progBar"></div></div>
        <div class="progress-info"><span id="progText">Question 1 of 10</span><span class="q-tag" id="qTag">Q1</span></div>
        <div class="status-bar"><div class="status-dot"></div><span>Interview Active</span></div>
        <div class="orb-container"><div><div class="orb" id="orb"></div><div class="orb-label" id="orbLabel">Preparing...</div></div></div>
        <div class="error-box" id="errorBox"></div>
        <div class="question-box" id="questionBox">Preparing your first question...</div>
        <div class="thinking hidden" id="thinkBox"><div class="thinking-dots"><span></span><span></span><span></span></div><span>Analyzing...</span></div>
        <div class="hf-info" id="hfInfo">ğŸ¤ Hands-free â€” Speak naturally. Auto-submits after pause.</div>
        <div class="wave-wrap" id="waveWrap"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
        <div class="silence-bar-wrap" id="silenceWrap"><div class="silence-bar"><div class="silence-fill" id="silenceFill"></div></div><div class="silence-text" id="silenceText"></div></div>
        <div class="timer" id="timer">00:00</div>
        <button class="btn-end" onclick="endEarly()">â¹ End Interview Early</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="page-results" class="hidden">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">ğŸ† Interview Complete!</h2>
        <div class="score-ring" id="scoreRing"><div style="text-align:center"><div class="score-num" id="scoreNum">0</div><div class="score-max">/ 100</div></div></div>
        <div id="gradeBadge" class="grade-badge">â€”</div><br>
        <div id="hireBadge" class="hire-badge" style="display:none;"></div>
        <p id="scoreSummary" style="color:var(--muted);margin-bottom:20px;line-height:1.6;"></p>
        <div id="retryWrap" style="display:none;"><button class="btn btn-secondary" onclick="retryEvaluation()">ğŸ”„ Retry Evaluation</button></div>
      </div>
      <div class="card" id="violationsCard" style="display:none;"><h2>ğŸ” Proctoring Report</h2><div id="violationsList"></div></div>
      <div class="card" id="strengthsCard" style="display:none;">
        <div class="summary-section"><h3>ğŸ’ª Strengths</h3><ul class="summary-list" id="strengthsList"></ul></div>
        <div class="summary-section"><h3>ğŸ“ˆ Improvements</h3><ul class="summary-list" id="improveList"></ul></div>
      </div>
      <div class="card"><h2>ğŸ“ Detailed Feedback</h2><div id="fbList"></div></div>
      <button class="btn btn-go" onclick="nav('home')">ğŸ  Home</button>
    </div>

    <!-- HR DASHBOARD -->
    <div id="page-hr" class="hidden">
      <div class="stat-grid"><div class="stat-card"><div class="stat-num" id="statJobs">0</div><div class="stat-label">Jobs</div></div><div class="stat-card"><div class="stat-num" id="statApps">0</div><div class="stat-label">Applications</div></div><div class="stat-card"><div class="stat-num" id="statShort">0</div><div class="stat-label">Shortlisted</div></div><div class="stat-card"><div class="stat-num" id="statInt">0</div><div class="stat-label">Interviews</div></div></div>
      <div class="card">
        <h2>ğŸ“¢ Post Job</h2>
        <label>Title *</label><input type="text" id="hrTitle" placeholder="e.g. Senior Frontend Developer">
        <div class="row2"><div><label>Category</label><select id="hrCat"><option value="IT/Software">IT/Software</option><option value="Accounting">Accounting</option><option value="Sales/Marketing">Sales/Marketing</option><option value="Management">Management</option></select></div><div><label>Department</label><input type="text" id="hrDept" placeholder="Engineering"></div></div>
        <div class="row2"><div><label>Company</label><input type="text" id="hrCompany" placeholder="Company name"></div><div><label>Location</label><input type="text" id="hrLocation" placeholder="Kochi, Kerala"></div></div>
        <div class="row3"><div><label>Level</label><select id="hrLevel"><option value="Fresher">Fresher</option><option value="Junior">Junior</option><option value="Mid-Level" selected>Mid-Level</option><option value="Senior">Senior</option><option value="Lead">Lead</option></select></div><div><label>Questions</label><select id="hrQCount"><option value="5">5</option><option value="8">8</option><option value="10" selected>10</option><option value="15">15</option></select></div><div><label>ATS Threshold</label><select id="hrATS"><option value="0">Manual</option><option value="50">50+</option><option value="60">60+</option><option value="70" selected>70+</option><option value="80">80+</option></select></div></div>
        <label>Description</label><textarea id="hrJD" placeholder="Job description..."></textarea>
        <label>Skills (comma separated)</label><input type="text" id="hrSkills" placeholder="React, TypeScript, Node.js">
        <button class="btn btn-go" onclick="postJob()">ğŸ“¢ Post Job</button>
      </div>
      <div class="card"><h2>ğŸ“ Jobs</h2><div id="hrJobsList"></div></div>
      <div class="card" id="hrCandCard" style="display:none;"><h2 id="hrCandTitle">ğŸ‘¥ Candidates</h2><div id="hrCandList"></div></div>
    </div>
  </div>

  <!-- Proctor Cam -->
  <div class="proctor-cam hidden" id="proctorCam"><video id="proctorVideo" autoplay muted playsinline></video><div class="cam-label">ğŸ”´ REC</div></div>

<script>
  const W="https://evalis-ai.simpaticohrconsultancy.workers.dev";
const SILENCE_TIMEOUT=3.0,MIN_ANS=10,MAX_RETRIES=3,MAX_VIOLATIONS=3;
const HR_PASSWORD="simpatico2025";
let hrAuth=false;
let mode="mock",cv="",lang="en",role="",level="",totalQ=10;
let mainQ=0,isFollowUp=false,chat=[],answers=[];
let rec=null,transcript="",timerInt=null,secs=0;
let listening=false,silTimer=null,lastSpeech=0;
let speaking=false,processing=false,ansStart=0;
let evalRetry=0,violations=[],screenStr=null,camStr=null;
let curJobId=null,curAppId=null,selHRJob=null;let _resumeFile=null;

const L={
  en:{s:"en-US",t:"en-US",n:"English"},
  hi:{s:"hi-IN",t:"hi-IN",n:"Hindi"},
  ml:{s:"ml-IN",t:"ml-IN",n:"Malayalam"},
  ta:{s:"ta-IN",t:"ta-IN",n:"Tamil"},
  te:{s:"te-IN",t:"te-IN",n:"Telugu"},
  kn:{s:"kn-IN",t:"kn-IN",n:"Kannada"},
  bn:{s:"bn-IN",t:"bn-IN",n:"Bengali"},
  es:{s:"es-ES",t:"es-ES",n:"Spanish"},
  ar:{s:"ar-SA",t:"ar-SA",n:"Arabic"},
  fr:{s:"fr-FR",t:"fr-FR",n:"French"},
  de:{s:"de-DE",t:"de-DE",n:"German"},
  ur:{s:"ur-PK",t:"ur-PK",n:"Urdu"}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DB + UPLOAD (Worker Proxy)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function db(a,t,d=null,f=null,s=null,o=null){
  const r=await fetch(W+"/db",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:a,table:t,data:d,filters:f,select:s,order:o})});
  return await r.json();
}

async function uploadFile(file,fn){
  const fd=new FormData();fd.append("file",file);fd.append("fileName",fn);
  const r=await fetch(W+"/upload",{method:"POST",body:fd});
  return await r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(m){
  const c=document.getElementById("toasts"),t=document.createElement("div");
  t.className="toast";t.textContent=m;c.appendChild(t);
  setTimeout(()=>t.remove(),3200);
}

function showError(m){
  const b=document.getElementById("errorBox");
  if(b){b.textContent=m;b.classList.add("show");setTimeout(()=>b.classList.remove("show"),8000)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION (with HR password)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nav(p){
  if(p==='hr'&&!hrAuth){
    const pwd=prompt("ğŸ”’ Enter HR Admin Password:");
    if(!pwd)return;
    if(pwd!==HR_PASSWORD){toast("âŒ Wrong password!");return}
    hrAuth=true;toast("âœ… HR Access granted!");
  }
  const pages=['home','jobs','apply','setup','live','results','hr'];
  pages.forEach(x=>document.getElementById('page-'+x)?.classList.add('hidden'));
  document.getElementById('page-'+p)?.classList.remove('hidden');
  document.querySelectorAll('#mainNav .nav-btn').forEach(b=>b.classList.remove('active'));
  const map={home:0,jobs:1,apply:2,setup:3,live:3,results:3,hr:4};
  document.querySelectorAll('#mainNav .nav-btn')[map[p]||0]?.classList.add('active');
  if(p==='jobs')loadJobs();
  if(p==='hr')loadHR();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOBS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadJobs(){
  const el=document.getElementById('jobsList');
  el.innerHTML='<span class="loading"></span> Loading...';
  try{
    const data=await db('select','jobs',null,{is_active:true},null,'created_at.desc');
    if(!data||data.error||!Array.isArray(data)||!data.length){
      el.innerHTML='<p style="color:var(--muted);text-align:center;padding:20px;">No open positions.</p>';return;
    }
    el.innerHTML=data.map(j=>`<div class="job-card">
      <h3>${j.title||''}</h3>
      <div class="job-meta">
        <span>ğŸ¢ ${j["Company Name"]||j.department||''}</span>
        <span>ğŸ“ ${j.location||''} ${j.Country?'('+j.Country+')':''}</span>
        <span>ğŸ“Š ${j.level||'Mid-Level'}</span>
      </div>
      <p style="font-size:0.82rem;color:var(--muted);margin:6px 0;">${(j.description||'').substring(0,180)}</p>
      <div>${(j.skills||[]).map(s=>'<span class="skill-tag">'+s+'</span>').join('')}</div>
      <button class="btn btn-go" style="margin-top:10px;padding:10px;" 
        onclick="applyTo('${j.id}','${(j.title||'').replace(/'/g,"\\'")}')">ğŸ“ Apply</button>
    </div>`).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">Error: '+e.message+'</p>'}
}

function applyTo(id,title){
  curJobId=id;
  document.getElementById('applyJobInfo').textContent='Applying for: '+title;
  nav('apply');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('applyFile').addEventListener('change',async e=>{
  const file=e.target.files[0];if(!file)return;
  document.getElementById('applyFileName').textContent='â³ Processing...';
  try{
    cv=await exFile(file);
    if(cv.length<30){document.getElementById('applyFileName').textContent='âš ï¸ Try TXT';cv='';return}
    document.getElementById('applyFileName').textContent='âœ… '+file.name;
    document.getElementById('applyUpload').classList.add('ok');
    _resumeFile=file;toast('âœ… Loaded!');
  }catch(err){document.getElementById('applyFileName').textContent='âŒ Error';cv=''}
});

async function submitApplication(){
  const name=document.getElementById('applyName').value.trim();
  const email=document.getElementById('applyEmail').value.trim();
  if(!name||!email){toast('âŒ Name & Email required');return}
  if(!cv){toast('âŒ Upload resume');return}
  const btn=document.getElementById('applyBtn');
  btn.disabled=true;btn.textContent='â³ Submitting...';
  const st=document.getElementById('applyStatus');st.textContent='';
  try{
    let resume_url='';
    if(_resumeFile){
      st.textContent='ğŸ“¤ Uploading...';
      const fn=Date.now()+'_'+_resumeFile.name;
      const up=await uploadFile(_resumeFile,fn);
      resume_url=up.url||'';
    }
    st.textContent='ğŸ“ Saving...';
    const result=await db('insert','applications',{
      job_id:curJobId||null,name,email,
      phone:document.getElementById('applyPhone').value.trim(),
      resume_url,resume_text:cv.substring(0,5000),status:'applied'
    });
    const app=Array.isArray(result)?result[0]:result;
    curAppId=app?.id;
    st.textContent='ğŸ¤– AI screening...';
    if(app?.id)await runATS(app);
    st.innerHTML='<span style="color:var(--green);">âœ… Application submitted!</span>';
    toast('âœ… Submitted!');
    document.getElementById('applyName').value='';
    document.getElementById('applyEmail').value='';
    document.getElementById('applyFileName').textContent='No file';
    document.getElementById('applyUpload').classList.remove('ok');
    cv='';_resumeFile=null;
  }catch(err){st.innerHTML='<span style="color:var(--red);">âŒ '+err.message+'</span>'}
  btn.disabled=false;btn.textContent='ğŸ“¨ Submit Application';
}

async function runATS(app){
  try{
    let jd='',sk=[],th=70,jr='',jl='';
    if(app.job_id){
      const job=await db('select','jobs',null,{id:app.job_id});
      const j=Array.isArray(job)?job[0]:job;
      if(j){jd=j.description||'';sk=j.skills||[];th=j.ats_threshold||70;jr=j.title;jl=j.level}
    }
    const raw=await callAI([
      {role:"system",content:"ATS screening AI. Return ONLY valid JSON."},
      {role:"user",content:`Score resume for "${jr||'General'}" (${jl||'Mid-Level'}).\nJob: ${jd||'Standard'}\nSkills: ${sk.join(',')||'General'}\nResume: ${app.resume_text||cv}\nReturn ONLY: {"atsScore":75,"matchedSkills":["s1"],"missingSkills":["s1"],"summary":"Brief"}`}
    ]);
    const r=safeJSON(raw);
    const score=Math.min(100,Math.max(0,r.atsScore||50));
    const status=th>0&&score>=th?'shortlisted':'applied';
    await db('update','applications',{
      ats_score:score,ats_matched_skills:r.matchedSkills||[],
      ats_missing_skills:r.missingSkills||[],ats_summary:r.summary||'',status
    },{id:app.id});
    if(status==='shortlisted'){
      const token=crypto.randomUUID?crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36);
      await db('insert','interviews',{
        application_id:app.id,job_id:app.job_id,token,
        interview_type:'real',status:'pending',interview_role:jr,
        interview_level:jl,question_count:10,interview_language:'en',
        expires_at:new Date(Date.now()+72*3600000).toISOString()
      });
    }
  }catch(e){console.error('[ATS]',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE EXTRACTORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exFile(f){
  const ext=f.name.split('.').pop().toLowerCase();let t='';
  if(ext==='txt')t=await f.text();
  else if(ext==='pdf')t=await exPDF(f);
  else if(ext==='doc'||ext==='docx')t=await exDOC(f);
  else t=await f.text();
  return t.replace(/\s+/g,' ').replace(/[^\x20-\x7E\n]/g,'').trim().substring(0,5000);
}

async function exPDF(f){
  if(!window.pdfjsLib)return await exFB(f);
  try{
    const b=await f.arrayBuffer(),p=await pdfjsLib.getDocument({data:b}).promise;
    let t='';
    for(let i=1;i<=p.numPages;i++){
      const pg=await p.getPage(i),c=await pg.getTextContent();
      t+=c.items.map(x=>x.str).join(' ')+'\n';
    }
    return t;
  }catch(e){return await exFB(f)}
}

async function exDOC(f){
  const b=await f.arrayBuffer();
  if(f.name.endsWith('.docx')){
    try{
      const t=new TextDecoder('utf-8').decode(new Uint8Array(b));
      const m=t.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);
      if(m&&m.length)return m.map(x=>x.replace(/<[^>]+>/g,'')).join(' ');
    }catch(e){}
  }
  return await exFB(f);
}

async function exFB(f){
  const b=await f.arrayBuffer();
  const t=new TextDecoder('utf-8',{fatal:false}).decode(b);
  const r=t.match(/[a-zA-Z0-9@.,:;!?\-/()\s]{5,}/g);
  return r?r.filter(s=>(s.match(/[a-zA-Z]/g)||[]).length/s.length>0.5&&s.trim().length>5).join(' '):'';
}

document.getElementById('cvFile').addEventListener('change',async e=>{
  const file=e.target.files[0];if(!file)return;
  document.getElementById('cvFileName').textContent='â³ Processing...';
  try{
    cv=await exFile(file);
    if(cv.length<30){document.getElementById('cvFileName').textContent='âš ï¸ Try TXT';cv='';return}
    document.getElementById('cvFileName').textContent='âœ… '+file.name;
    document.getElementById('cvUpArea').classList.add('ok');
    toast('âœ… Loaded!');
  }catch(e){document.getElementById('cvFileName').textContent='âŒ Error';cv=''}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callAI(messages){
  const ctrl=new AbortController();
  const tm=setTimeout(()=>ctrl.abort(),45000);
  try{
    const r=await fetch(W,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages}),signal:ctrl.signal});
    clearTimeout(tm);
    if(!r.ok)throw new Error('Error '+r.status);
    const d=await r.json();
    if(!d.response)throw new Error("Empty");
    return d.response;
  }catch(e){clearTimeout(tm);if(e.name==='AbortError')throw new Error("Timeout");throw e}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JSON PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function safeJSON(raw){
  let c=raw.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();
  const m=c.match(/\{[\s\S]*\}/);if(!m)throw new Error('No JSON');
  c=m[0].replace(/,\s*([}\]])/g,'$1');
  c=c.replace(/:\s*"([^"]*?)"/gs,(m,v)=>': "'+v.replace(/\n/g,' ').replace(/\r/g,'').replace(/\t/g,' ').replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'"');
  try{return JSON.parse(c)}
  catch(e){try{return JSON.parse(c.replace(/[\x00-\x1F\x7F]/g,' '))}
  catch(e2){return exFields(raw)}}
}

function exFields(raw){
  const gn=k=>{const m=raw.match(new RegExp(`"${k}"\\s*:\\s*(\\d+)`));return m?parseInt(m[1]):0};
  const gs=k=>{const m=raw.match(new RegExp(`"${k}"\\s*:\\s*"([^"]*?)"`));return m?m[1]:''};
  const ga=k=>{const m=raw.match(new RegExp(`"${k}"\\s*:\\s*\\[([^\\]]*?)\\]`,'s'));if(!m)return[];const i=m[1].match(/"([^"]*?)"/g);return i?i.map(s=>s.replace(/"/g,'')):[]};
  const fb=[];
  for(const m of raw.matchAll(/"question"\s*:\s*"([^"]*?)"[^}]*?"score"\s*:\s*(\d+)[^}]*?"comment"\s*:\s*"([^"]*?)"/gs))
    fb.push({question:m[1].substring(0,100),score:parseInt(m[2]),comment:m[3],type:'main'});
  return{
    overallScore:gn('overallScore')||50,grade:gs('grade')||'C',
    recommendation:gs('recommendation')||'Pending',summary:gs('summary')||'Done.',
    strengths:ga('strengths'),improvements:ga('improvements'),
    feedback:fb.length?fb:answers.map(a=>({question:a.question.substring(0,80),score:a.skipped?0:5,comment:a.skipped?'Skipped':'Recorded',type:a.type}))
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERVIEW SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById("roleSel").addEventListener("change",e=>{
  document.getElementById("customWrap").classList.toggle("hidden",e.target.value!=="custom");
});

function startMode(m){
  mode=m;nav('setup');
  const ind=document.getElementById('modeIndicator');
  if(m==='real'){
    ind.innerHTML='<span class="mode-badge" style="background:rgba(239,68,68,.15);color:var(--red);font-size:0.85rem;padding:6px 16px;">ğŸ”’ PROCTORED</span>';
    document.getElementById('realInfoCard').classList.remove('hidden');
    document.getElementById('proctorReqCard').classList.remove('hidden');
  }else{
    ind.innerHTML='<span class="mode-badge" style="background:rgba(16,185,129,.15);color:var(--green);font-size:0.85rem;padding:6px 16px;">ğŸ¯ MOCK PRACTICE</span>';
    document.getElementById('realInfoCard').classList.add('hidden');
    document.getElementById('proctorReqCard').classList.add('hidden');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setOrb(s){
  const o=document.getElementById('orb'),l=document.getElementById('orbLabel');
  if(!o)return;o.className='orb';
  switch(s){
    case'speaking':o.classList.add('speaking');l.textContent='Speaking...';break;
    case'listening':o.classList.add('listening');l.textContent='Listening...';break;
    case'thinking':o.classList.add('thinking');l.textContent='Thinking...';break;
    case'processing':o.classList.add('processing');l.textContent='Processing...';break;
    default:l.textContent='Ready';
  }
}

function updateProg(){
  const p=Math.round((mainQ/totalQ)*100);
  document.getElementById('progBar').style.width=p+'%';
  if(isFollowUp){
    document.getElementById('progText').textContent=`Follow-up Q${mainQ}/${totalQ}`;
    document.getElementById('qTag').textContent=`Q${mainQ}â†©`;
    document.getElementById('qTag').className='followup-tag';
  }else{
    document.getElementById('progText').textContent=`Question ${mainQ}/${totalQ} â€” ${p}%`;
    document.getElementById('qTag').textContent=`Q${mainQ}`;
    document.getElementById('qTag').className='q-tag';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â˜… FIXED TTS (Text-to-Speech)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let voicesLoaded=false;
let cachedVoices=[];

function loadVoices(){
  cachedVoices=speechSynthesis.getVoices();
  if(cachedVoices.length>0){
    voicesLoaded=true;
    console.log('[TTS] Loaded',cachedVoices.length,'voices');
  }
}

if('speechSynthesis' in window){
  loadVoices();
  speechSynthesis.onvoiceschanged=()=>{loadVoices()};
  // Force load on some browsers
  setTimeout(loadVoices,100);
  setTimeout(loadVoices,500);
  setTimeout(loadVoices,1000);
}

function speak(text){
  return new Promise(resolve=>{
    if(!('speechSynthesis' in window)){
      console.warn('[TTS] Not supported');
      resolve();return;
    }

    // Cancel any ongoing speech
    speechSynthesis.cancel();
    speaking=true;
    setOrb('speaking');

    function doSpeak(){
      try{
        const utterance=new SpeechSynthesisUtterance(text);
        utterance.lang=L[lang]?.t||'en-US';
        utterance.rate=0.92;
        utterance.pitch=1;
        utterance.volume=1;

        // Find best voice
        const targetLang=(L[lang]?.t||'en-US').split('-')[0];
        const voices=speechSynthesis.getVoices();

        if(voices.length>0){
          // Prefer non-default voice for better quality
          const match=voices.find(v=>v.lang.startsWith(targetLang)&&!v.localService)
            ||voices.find(v=>v.lang.startsWith(targetLang))
            ||voices.find(v=>v.lang.startsWith('en'));
          if(match){
            utterance.voice=match;
            console.log('[TTS] Using voice:',match.name,match.lang);
          }
        }

        utterance.onend=()=>{
          speaking=false;
          console.log('[TTS] Finished speaking');
          resolve();
        };

        utterance.onerror=(e)=>{
          console.error('[TTS] Error:',e.error||e);
          speaking=false;
          resolve();
        };

        // Chrome bug: long text gets cut off
        // Workaround: keep speechSynthesis alive
        const keepAlive=setInterval(()=>{
          if(!speaking){clearInterval(keepAlive);return}
          speechSynthesis.pause();
          speechSynthesis.resume();
        },10000);

        utterance.onend=()=>{
          clearInterval(keepAlive);
          speaking=false;
          resolve();
        };

        utterance.onerror=(e)=>{
          clearInterval(keepAlive);
          console.error('[TTS] Error:',e.error||e);
          speaking=false;
          resolve();
        };

        speechSynthesis.speak(utterance);
        console.log('[TTS] Speaking:',text.substring(0,50)+'...');

      }catch(err){
        console.error('[TTS] Exception:',err);
        speaking=false;
        resolve();
      }
    }

    // Wait for voices to be ready
    const voices=speechSynthesis.getVoices();
    if(voices.length>0){
      setTimeout(doSpeak,150);
    }else{
      console.log('[TTS] Waiting for voices...');
      const handler=()=>{
        speechSynthesis.onvoiceschanged=null;
        setTimeout(doSpeak,150);
      };
      speechSynthesis.onvoiceschanged=handler;
      // Fallback: try anyway after 1 second
      setTimeout(()=>{
        if(speaking&&!speechSynthesis.speaking){
          console.log('[TTS] Fallback: speaking without voice match');
          speechSynthesis.onvoiceschanged=null;
          doSpeak();
        }
      },1000);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STT (Speech-to-Text)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSTT(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('âš ï¸ Use Chrome');return}
  rec=new SR();
  rec.lang=L[lang]?.s||'en-US';
  rec.interimResults=true;
  rec.continuous=true;
  rec.onresult=e=>{
    let f='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal)f+=e.results[i][0].transcript+' ';
    }
    if(f){transcript+=f;lastSpeech=Date.now();resetSil();startSil()}
  };
  rec.onerror=e=>{if(e.error!=='no-speech'&&e.error!=='aborted')console.error('[STT]',e.error)};
  rec.onend=()=>{if(listening&&!processing&&!speaking)try{rec.start()}catch(e){}};
}

function startListen(){
  if(!rec||listening)return;
  listening=true;transcript='';lastSpeech=Date.now();ansStart=Date.now();
  try{rec.start()}catch(e){try{rec.stop()}catch(e2){}setTimeout(()=>{try{rec.start()}catch(e3){}},200)}
  setOrb('listening');
  document.getElementById('waveWrap').classList.add('active');
  document.getElementById('hfInfo').textContent='ğŸ¤ Listening...';
  startTimer();startSil();
}

function stopListen(){
  listening=false;resetSil();
  try{rec?.stop()}catch(e){}
  document.getElementById('waveWrap')?.classList.remove('active');
  stopTimer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SILENCE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSil(){
  resetSil();
  silTimer=setInterval(()=>{
    if(!listening||processing||speaking)return;
    const sf=(Date.now()-lastSpeech)/1000;
    if(transcript.trim().length>=MIN_ANS&&sf>=1){
      const rem=Math.max(0,SILENCE_TIMEOUT-sf);
      document.getElementById('silenceWrap').classList.add('show');
      document.getElementById('silenceFill').style.width=(rem/SILENCE_TIMEOUT*100)+'%';
      document.getElementById('silenceText').textContent=rem>0?`Auto-submit ${rem.toFixed(1)}s...`:'Submitting...';
      if(sf>=SILENCE_TIMEOUT)autoSubmit();
    }else{
      document.getElementById('silenceWrap').classList.remove('show');
    }
  },200);
}

function resetSil(){
  clearInterval(silTimer);silTimer=null;
  document.getElementById('silenceWrap')?.classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimer(){secs=0;showTime();timerInt=setInterval(()=>{secs++;showTime()},1000)}
function stopTimer(){clearInterval(timerInt)}
function showTime(){
  const el=document.getElementById('timer');
  if(el)el.textContent=`${Math.floor(secs/60).toString().padStart(2,'0')}:${(secs%60).toString().padStart(2,'0')}`;
}

function showThink(s){
  document.getElementById('thinkBox')?.classList.toggle('hidden',!s);
  const w=document.getElementById('waveWrap');if(w)w.style.display=s?'none':'flex';
  const h=document.getElementById('hfInfo');if(h)h.style.display=s?'none':'block';
  document.getElementById('silenceWrap')?.classList.remove('show');
  if(s)document.getElementById('questionBox').textContent='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCTORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addViolation(type,detail){
  if(mode!=='real')return;
  violations.push({type,detail,time:new Date().toLocaleTimeString(),qNum:mainQ});
  document.getElementById('violationCount').textContent=violations.length;
  toast('âš ï¸ '+detail);
  if(violations.length>=MAX_VIOLATIONS){toast('ğŸš« Terminated!');endEarly()}
}

function startProctor(){
  if(mode!=='real')return;
  document.getElementById('proctorBar').style.display='flex';
  violations=[];
  document.addEventListener('visibilitychange',onVis);
  window.addEventListener('blur',onBlur);
  document.addEventListener('copy',onClip);
  document.addEventListener('paste',onClip);
  document.addEventListener('cut',onClip);
  document.addEventListener('contextmenu',onCtx);
  document.addEventListener('keydown',onKey);
  startCam();
}

function stopProctor(){
  document.removeEventListener('visibilitychange',onVis);
  window.removeEventListener('blur',onBlur);
  document.removeEventListener('copy',onClip);
  document.removeEventListener('paste',onClip);
  document.removeEventListener('cut',onClip);
  document.removeEventListener('contextmenu',onCtx);
  document.removeEventListener('keydown',onKey);
  if(screenStr){screenStr.getTracks().forEach(t=>t.stop());screenStr=null}
  if(camStr){camStr.getTracks().forEach(t=>t.stop());camStr=null}
  document.getElementById('proctorCam')?.classList.add('hidden');
  document.getElementById('proctorBar').style.display='none';
}

function onVis(){if(document.hidden&&mode==='real')addViolation('tab','Switched tab')}
function onBlur(){if(mode==='real'&&!document.hidden)addViolation('blur','Window lost focus')}
function onClip(e){if(mode==='real'){e.preventDefault();addViolation('clip','Attempted '+e.type)}}
function onCtx(e){if(mode==='real')e.preventDefault()}
function onKey(e){
  if(mode!=='real')return;
  if((e.ctrlKey||e.metaKey)&&['c','v','u','s','a','p'].includes(e.key.toLowerCase())){
    e.preventDefault();addViolation('key','Ctrl+'+e.key.toUpperCase());
  }
  if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&['i','j','c'].includes(e.key.toLowerCase()))){
    e.preventDefault();addViolation('dev','DevTools attempt');
  }
}

async function startCam(){
  try{
    camStr=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    document.getElementById('proctorVideo').srcObject=camStr;
    document.getElementById('proctorCam').classList.remove('hidden');
  }catch(e){addViolation('cam','Camera denied')}
}

async function requestScreenShare(){
  try{
    screenStr=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:'monitor'}});
    screenStr.getVideoTracks()[0].onended=()=>{
      if(mode==='real')addViolation('screen','Screen share stopped');
    };
    document.getElementById('screenShareOverlay').classList.add('hidden');
    toast('âœ… Screen sharing active');
    actuallyStart();
  }catch(e){toast('âŒ Screen share required')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â˜… START INTERVIEW (with token validation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startInterview(){
  const rs=document.getElementById('roleSel').value;
  if(!rs){toast('âŒ Select role');return}
  role=rs==='custom'?document.getElementById('customRole').value.trim():rs;
  if(!role){toast('âŒ Enter role');return}
  lang=document.getElementById('langSel').value;
  level=document.getElementById('levelSel').value;
  totalQ=parseInt(document.getElementById('qCount').value);
  mainQ=0;isFollowUp=false;answers=[];chat=[];evalRetry=0;violations=[];

  if(mode==='real'){
    const n=document.getElementById('candName').value.trim();
    const e=document.getElementById('candEmail').value.trim();
    const token=document.getElementById('candToken').value.trim();

    if(!n||!e){toast('âŒ Name & Email required');return}

    // Validate token
    if(!token){
      toast('âŒ Token required!');
      alert('ğŸ”’ You need a valid interview token.\n\nTokens are sent by HR after your application is shortlisted.\n\nTo practice, use Mock Interview instead.');
      return;
    }

    try{
      toast('ğŸ” Validating token...');
      const data=await db('select','interviews',null,{token});
      const interview=Array.isArray(data)?data[0]:data;

      if(!interview||interview.error){
        toast('âŒ Invalid token!');
        alert('This token is not valid.');return;
      }
      if(interview.status==='completed'){
        toast('âŒ Already completed!');
        alert('This interview was already completed.');return;
      }
      if(interview.expires_at&&new Date(interview.expires_at)<new Date()){
        toast('âŒ Token expired!');
        alert('This token has expired. Contact HR.');return;
      }

      curAppId=interview.application_id;
      curJobId=interview.job_id;

      await db('update','interviews',{
        status:'in_progress',started_at:new Date().toISOString()
      },{token});

      toast('âœ… Token verified!');
    }catch(err){
      toast('âŒ Validation failed: '+err.message);return;
    }

    document.getElementById('screenShareOverlay').classList.remove('hidden');
    return;
  }

  // Mock mode
  const btn=document.getElementById('startBtn');
  btn.disabled=true;btn.textContent='â³ Connecting...';
  try{
    const t=await fetch(W,{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({messages:[{role:'user',content:'Say OK'}]})});
    if(!t.ok)throw new Error('Worker error');
  }catch(e){
    toast('âŒ '+e.message);
    btn.disabled=false;btn.textContent='ğŸš€ Start Interview';return;
  }
  btn.disabled=false;btn.textContent='ğŸš€ Start Interview';
  actuallyStart();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTUALLY START INTERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function actuallyStart(){
  document.getElementById('screenShareOverlay').classList.add('hidden');
  const sys=`You are an expert AI interviewer for a ${level}-level "${role}" position.
LANGUAGE: ${L[lang]?.n||'English'} only.
${cv?'\nRESUME:\n'+cv+'\n':''}
RULES:
1. Ask ${totalQ} MAIN questions. Mix behavioral, technical, situational.
2. For vague answers, ask C.L.A.I.M. follow-ups.
3. Follow-ups don't count toward ${totalQ} total.
4. Be conversational, professional. Adapt to ${level} level.
FORMAT: [NEXT] new question | [FOLLOWUP] follow-up | [DONE] end message
Start with [NEXT] and first question.`;

  chat=[{role:'system',content:sys}];
  nav('live');
  if(mode==='real')startProctor();
  setOrb('thinking');showThink(true);

  try{
    const fq=await callAI(chat);
    chat.push({role:'assistant',content:fq});
    const cl=fq.replace(/\[NEXT\]\s*/i,'').replace(/\[FOLLOWUP\]\s*/i,'').trim();
    mainQ=1;isFollowUp=false;
    showThink(false);
    document.getElementById('questionBox').textContent=cl;
    updateProg();
    initSTT();
    await speak(cl);
    startListen();
    toast('ğŸ¯ Started!');
  }catch(e){
    showError('âŒ '+e.message);
    showThink(false);setOrb('idle');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO SUBMIT + NEXT QUESTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function autoSubmit(){
  if(processing)return;processing=true;stopListen();setOrb('processing');
  const ans=transcript.trim();
  if(!ans||ans.length<MIN_ANS){
    processing=false;toast('ğŸ¤ Still listening...');
    setTimeout(()=>startListen(),500);return;
  }
  const q=document.getElementById('questionBox').textContent;
  const dur=Math.round((Date.now()-ansStart)/1000);
  answers.push({question:q,answer:ans,type:isFollowUp?'followup':'main',mainQNum:mainQ,duration:dur,skipped:false});
  transcript='';
  await getNext(ans);
  processing=false;
}

async function getNext(ans){
  showThink(true);setOrb('thinking');
  const p=`Candidate answered: "${ans}"
Main asked: ${mainQ}/${totalQ}.
- Vague â†’ [FOLLOWUP] probe
- Good â†’ [NEXT] new question
${mainQ>=totalQ&&!isFollowUp?'- All done â†’ [DONE] brief thanks':''}
Output ONLY tag + question. Stay in ${L[lang]?.n||'English'}.`;

  chat.push({role:'user',content:p});
  try{
    const r=await callAI(chat);
    chat.push({role:'assistant',content:r});
    showThink(false);
    const u=r.toUpperCase();
    const cl=r.replace(/\[FOLLOWUP\]\s*/i,'').replace(/\[NEXT\]\s*/i,'').replace(/\[DONE\]\s*/i,'').trim();

    if(u.includes('[DONE]')){
      document.getElementById('questionBox').textContent=cl;
      mainQ=totalQ;updateProg();
      await speak(cl);
      setTimeout(()=>showResults(),2000);return;
    }
    if(u.includes('[NEXT]')){mainQ++;isFollowUp=false;if(mainQ>totalQ)mainQ=totalQ}
    if(u.includes('[FOLLOWUP]'))isFollowUp=true;

    document.getElementById('questionBox').textContent=cl;
    updateProg();
    await speak(cl);
    startListen();
  }catch(e){showError('âŒ '+e.message);showThink(false);setOrb('idle')}
}

function endEarly(){
  if(answers.length<1){toast('âš ï¸ Answer at least 1');return}
  stopListen();speechSynthesis?.cancel();showResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showResults(){
  stopListen();speechSynthesis?.cancel();stopProctor();
  nav('results');toast('ğŸ“Š Evaluating...');
  await genEval();
}

async function genEval(){
  const qa=answers.map(a=>{
    const t=a.type==='followup'?'FOLLOW-UP':'MAIN Q'+a.mainQNum;
    return`[${t}] (${a.duration||0}s)\nQ: ${a.question.replace(/["\n\r\t\\]/g,' ').substring(0,200)}\nA: ${a.skipped?'SKIPPED':a.answer.replace(/["\n\r\t\\]/g,' ').substring(0,300)}`;
  }).join('\n\n');

  const em=[
    {role:'system',content:'Hiring evaluator. Return ONLY valid JSON. No markdown.'},
    {role:'user',content:`Evaluate this ${level} interview for ${role}.
${violations.length?'VIOLATIONS: '+violations.length+'\n':''}Transcript:
${qa}
Return ONLY: {"overallScore":65,"grade":"B","recommendation":"Lean Hire","summary":"Brief.","strengths":["s1"],"improvements":["i1"],"feedback":[{"question":"q","score":7,"comment":"c","type":"main"}]}
Keep strings short. ONLY JSON.`}
  ];

  try{
    const raw=await callAI(em);
    const r=safeJSON(raw);
    if(typeof r.overallScore!=='number'||r.overallScore<0||r.overallScore>100)r.overallScore=50;
    if(violations.length){
      r.overallScore=Math.max(0,r.overallScore-violations.length*5);
      r.summary+=' ('+violations.length+' violations, -'+violations.length*5+'pts)';
    }
    renderRes(r);
    await saveResults(r);
    toast('ğŸ† Done!');
    document.getElementById('retryWrap').style.display='none';
  }catch(e){
    console.error('[EVAL]',e);evalRetry++;
    if(evalRetry<MAX_RETRIES){toast('âš ï¸ Retry '+evalRetry+'/'+MAX_RETRIES);await genEval()}
    else{toast('âš ï¸ Local eval');renderFallback();document.getElementById('retryWrap').style.display='block'}
  }
}

async function saveResults(r){
  try{
    if(!curAppId)return;
    const token=crypto.randomUUID?crypto.randomUUID():Date.now().toString(36);
    await db('insert','interviews',{
      application_id:curAppId,job_id:curJobId,token,
      interview_type:mode,status:'completed',
      interview_role:role,interview_level:level,interview_language:lang,
      question_count:totalQ,
      started_at:new Date(Date.now()-secs*1000).toISOString(),
      completed_at:new Date().toISOString(),
      duration_seconds:secs,overall_score:r.overallScore,
      grade:r.grade,recommendation:r.recommendation,summary:r.summary,
      strengths:r.strengths||[],improvements:r.improvements||[],
      feedback:r.feedback||[],answers:answers,
      violation_log:violations,violation_count:violations.length
    });
    await db('update','applications',{status:'interviewed'},{id:curAppId});
    console.log('[DB] Results saved!');
  }catch(e){console.error('[DB]',e)}
}

async function retryEvaluation(){
  evalRetry=0;toast('ğŸ”„ Retrying...');
  document.getElementById('scoreNum').textContent='0';
  document.getElementById('gradeBadge').textContent='â€”';
  document.getElementById('fbList').innerHTML='';
  document.getElementById('strengthsCard').style.display='none';
  document.getElementById('hireBadge').style.display='none';
  document.getElementById('retryWrap').style.display='none';
  await genEval();
}

function renderFallback(){
  const ma=answers.filter(a=>a.type==='main'&&!a.skipped).length;
  const sc=Math.max(0,Math.round((ma/Math.max(totalQ,1))*70)-violations.length*5);
  renderRes({
    overallScore:sc,grade:sc>=70?'B':sc>=50?'C':'D',
    recommendation:sc>=60?'Lean Hire':'Lean No Hire',
    summary:`Answered ${ma}/${totalQ}.${violations.length?' '+violations.length+' violations.':''}`,
    strengths:ma>0?['Participated']:[],improvements:['More detail'],
    feedback:answers.map(a=>({question:a.question.substring(0,80),score:a.skipped?0:5,comment:a.skipped?'Skipped':'Recorded',type:a.type}))
  });
}

function renderRes(r){
  const sc=r.overallScore||0,gr=r.grade||'?';
  const ok=sc>=80,mid=sc>=60;
  const col=ok?'#10b981':mid?'#f59e0b':'#ef4444';
  const bg=ok?'rgba(16,185,129,.15)':mid?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)';

  document.getElementById('scoreRing').style.background=`conic-gradient(${col} ${sc*3.6}deg, rgba(255,255,255,.05) 0deg)`;
  const b=document.getElementById('gradeBadge');
  b.textContent='Grade: '+gr;b.style.background=bg;b.style.color=col;

  if(r.recommendation){
    const h=document.getElementById('hireBadge');h.style.display='inline-block';
    h.textContent=r.recommendation;
    const hire=r.recommendation.toLowerCase().includes('hire')&&!r.recommendation.toLowerCase().includes('no');
    h.style.background=hire?'rgba(16,185,129,.15)':'rgba(239,68,68,.15)';
    h.style.color=hire?'#10b981':'#ef4444';
  }

  document.getElementById('scoreSummary').textContent=r.summary||'';

  if(r.strengths?.length||r.improvements?.length){
    document.getElementById('strengthsCard').style.display='block';
    const sl=document.getElementById('strengthsList');sl.innerHTML='';
    (r.strengths||[]).forEach(s=>{sl.innerHTML+='<li><span>âœ…</span> '+s+'</li>'});
    const il=document.getElementById('improveList');il.innerHTML='';
    (r.improvements||[]).forEach(s=>{il.innerHTML+='<li><span>ğŸ“ˆ</span> '+s+'</li>'});
  }

  if(violations.length){
    document.getElementById('violationsCard').style.display='block';
    const vl=document.getElementById('violationsList');vl.innerHTML='';
    violations.forEach(v=>{
      vl.innerHTML+='<div class="violation-item"><span style="font-size:0.7rem;color:var(--muted);">'+v.time+'</span> âš ï¸ '+v.detail+'</div>';
    });
  }

  const list=document.getElementById('fbList');list.innerHTML='';
  (r.feedback||[]).forEach((fb,i)=>{
    const s=fb.score||0;
    const c=s>=7?'#10b981':s>=5?'#f59e0b':'#ef4444';
    const bg2=s>=7?'rgba(16,185,129,.15)':s>=5?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)';
    const tc=fb.type==='followup'?'rgba(139,92,246,.15)':'rgba(99,102,241,.15)';
    const tt=fb.type==='followup'?'#a78bfa':'#818cf8';
    const tl=fb.type==='followup'?'Follow-up':'Main';
    const ma=answers[i];
    const pv=ma?(ma.skipped?'[Skipped]':ma.answer.substring(0,120)+(ma.answer.length>120?'...':'')):'';
    const d=document.createElement('div');d.className='fb-item';
    d.innerHTML=`<div class="fb-q">${fb.question}<span class="fb-type" style="background:${tc};color:${tt};">${tl}</span></div>${pv?`<div class="fb-a">"${pv}"</div>`:''}<span class="fb-score" style="background:${bg2};color:${c};">${s}/10</span><div class="fb-text">${fb.comment}</div>`;
    list.appendChild(d);
  });

  // Animated score counter
  let cur=0;
  const el=document.getElementById('scoreNum');
  const iv=setInterval(()=>{
    cur+=Math.ceil(sc/30);
    if(cur>=sc){cur=sc;clearInterval(iv)}
    el.textContent=cur;
  },30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HR DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHR(){
  try{
    const jobs=await db('select','jobs');
    const apps=await db('select','applications');
    const ints=await db('select','interviews');
    document.getElementById('statJobs').textContent=Array.isArray(jobs)?jobs.length:0;
    document.getElementById('statApps').textContent=Array.isArray(apps)?apps.length:0;
    document.getElementById('statShort').textContent=Array.isArray(apps)?apps.filter(a=>a.status==='shortlisted').length:0;
    document.getElementById('statInt').textContent=Array.isArray(ints)?ints.length:0;
  }catch(e){console.error(e)}
  loadHRJobs();
}

async function loadHRJobs(){
  const el=document.getElementById('hrJobsList');
  try{
    const data=await db('select','jobs',null,null,null,'created_at.desc');
    if(!data?.length||data.error){
      el.innerHTML='<p style="color:var(--muted);text-align:center;">No jobs.</p>';return;
    }
    el.innerHTML=data.map(j=>`<div class="job-card" onclick="loadCands('${j.id}','${(j.title||'').replace(/'/g,"\\'")}')">
      <div style="display:flex;justify-content:space-between;">
        <h3>${j.title}</h3>
        <span class="status-pill" style="background:${j.is_active?'rgba(16,185,129,.15)':'rgba(239,68,68,.15)'};color:${j.is_active?'#10b981':'#ef4444'};">
          ${j.is_active?'Active':'Inactive'}
        </span>
      </div>
      <div class="job-meta">
        <span>ğŸ¢ ${j["Company Name"]||j.department||''}</span>
        <span>ğŸ“ ${j.location||''}</span>
        <span>ğŸ“Š ${j.level||''}</span>
        <span>ğŸ¯ ATS:${j.ats_threshold>0?j.ats_threshold+'+':'Manual'}</span>
      </div>
    </div>`).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}

async function postJob(){
  const title=document.getElementById('hrTitle').value.trim();
  if(!title){toast('âŒ Enter title');return}
  try{
    await db('insert','jobs',{
      title,
      category:document.getElementById('hrCat').value,
      department:document.getElementById('hrDept').value.trim(),
      "Company Name":document.getElementById('hrCompany').value.trim(),
      location:document.getElementById('hrLocation').value.trim(),
      level:document.getElementById('hrLevel').value,
      description:document.getElementById('hrJD').value.trim(),
      skills:document.getElementById('hrSkills').value.split(',').map(s=>s.trim()).filter(Boolean),
      question_count:parseInt(document.getElementById('hrQCount').value),
      ats_threshold:parseInt(document.getElementById('hrATS').value),
      is_active:true,status:'active'
    });
    toast('âœ… Posted!');
    document.getElementById('hrTitle').value='';
    document.getElementById('hrJD').value='';
    document.getElementById('hrSkills').value='';
    document.getElementById('hrDept').value='';
    document.getElementById('hrCompany').value='';
    document.getElementById('hrLocation').value='';
    loadHRJobs();loadHR();
  }catch(e){toast('âŒ '+e.message)}
}

async function loadCands(jobId,title){
  selHRJob=jobId;
  document.getElementById('hrCandCard').style.display='block';
  document.getElementById('hrCandTitle').textContent='ğŸ‘¥ '+(title||'Candidates');
  const el=document.getElementById('hrCandList');
  el.innerHTML='<span class="loading"></span>';
  try{
    const data=await db('select','applications',null,{job_id:jobId},null,'created_at.desc');
    if(!data?.length||data.error){
      el.innerHTML='<p style="color:var(--muted);text-align:center;padding:16px;">No candidates.</p>';return;
    }
    el.innerHTML=data.map(c=>{
      const sc=c.ats_score||0;
      const col=sc>=70?'#10b981':sc>=50?'#f59e0b':'#ef4444';
      const bg=sc>=70?'rgba(16,185,129,.15)':sc>=50?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)';
      const stc={applied:'#f59e0b',shortlisted:'#10b981',interviewed:'#3b82f6',rejected:'#ef4444'}[c.status]||'#94a3b8';
      const stb={applied:'rgba(245,158,11,.15)',shortlisted:'rgba(16,185,129,.15)',interviewed:'rgba(59,130,246,.15)',rejected:'rgba(239,68,68,.15)'}[c.status]||'rgba(255,255,255,.05)';
      return`<div class="cand-row">
        <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:180px;">
          <div class="cand-avatar">${(c.name||'?')[0].toUpperCase()}</div>
          <div>
            <div style="font-weight:700;font-size:0.88rem;">${c.name||'?'}</div>
            <div style="font-size:0.72rem;color:var(--muted);">${c.email||''}</div>
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <span class="score-badge" style="background:${bg};color:${col};">ATS:${sc}</span>
          <span class="status-pill" style="background:${stb};color:${stc};">${c.status}</span>
          ${c.status==='applied'?`<button class="btn btn-sm btn-success" onclick="event.stopPropagation();shortlist('${c.id}')">âœ…</button>`:''}
          ${c.status==='shortlisted'?`<button class="btn btn-sm" style="background:var(--accent);color:#fff;" onclick="event.stopPropagation();sendInvite('${c.id}','${(c.email||'').replace(/'/g,"\\'")}')">ğŸ“§</button>`:''}
          ${c.status!=='rejected'?`<button class="btn btn-sm btn-danger" onclick="event.stopPropagation();reject('${c.id}')">âŒ</button>`:''}
          ${c.resume_url?`<a href="${c.resume_url}" target="_blank" class="btn btn-sm btn-secondary" style="text-decoration:none;" onclick="event.stopPropagation()">ğŸ“„</a>`:''}
        </div>
      </div>`;
    }).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}

async function shortlist(id){
  try{await db('update','applications',{status:'shortlisted'},{id});toast('âœ… Shortlisted');loadCands(selHRJob,'')}
  catch(e){toast('âŒ '+e.message)}
}

async function reject(id){
  try{await db('update','applications',{status:'rejected'},{id});toast('Rejected');loadCands(selHRJob,'')}
  catch(e){toast('âŒ '+e.message)}
}

async function sendInvite(appId,email){
  try{
    const token=crypto.randomUUID?crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36);
    const job=await db('select','jobs',null,{id:selHRJob});
    const j=Array.isArray(job)?job[0]:job;
    await db('insert','interviews',{
      application_id:appId,job_id:selHRJob,token,
      interview_type:'real',status:'pending',
      interview_role:j?.title||'',interview_level:j?.level||'Mid-Level',
      question_count:j?.question_count||10,
      interview_language:j?.interview_language||'en',
      expires_at:new Date(Date.now()+72*3600000).toISOString()
    });
    const url=`${location.origin}${location.pathname}?token=${token}`;
    try{await navigator.clipboard.writeText(url)}catch(e){}
    toast('âœ… Link created!');
    alert(`ğŸ“§ Send to ${email}:\n\n${url}\n\n(Copied to clipboard!)`);
    loadCands(selHRJob,'');
  }catch(e){toast('âŒ '+e.message)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN FROM URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkToken(){
  const params=new URLSearchParams(location.search);
  const token=params.get('token');

  // Handle #hr hash
  const hash=location.hash.replace('#','');
  if(hash==='hr'){nav('hr');return}
  if(hash&&!token){nav(hash);return}

  if(!token)return;

  toast('ğŸ”’ Token detected...');
  try{
    const data=await db('select','interviews',null,{token});
    const d=Array.isArray(data)?data[0]:data;

    if(!d||d.error){toast('âŒ Invalid token');return}
    if(d.status==='completed'){toast('âŒ Already completed');alert('This interview was already completed.');return}
    if(d.expires_at&&new Date(d.expires_at)<new Date()){toast('âŒ Expired');alert('Token expired. Contact HR.');return}

    mode='real';curAppId=d.application_id;curJobId=d.job_id;
    startMode('real');

    if(d.interview_role){document.getElementById('roleSel').value=d.interview_role;role=d.interview_role}
    if(d.interview_level)document.getElementById('levelSel').value=d.interview_level;
    if(d.question_count)document.getElementById('qCount').value=d.question_count;
    if(d.interview_language)document.getElementById('langSel').value=d.interview_language;

    if(d.application_id){
      const apps=await db('select','applications',null,{id:d.application_id});
      const a=Array.isArray(apps)?apps[0]:apps;
      if(a){
        document.getElementById('candName').value=a.name||'';
        document.getElementById('candEmail').value=a.email||'';
        if(a.resume_text){cv=a.resume_text;document.getElementById('cvFileName').textContent='âœ… Resume loaded'}
      }
    }

    document.getElementById('candToken').value=token;
    toast('âœ… Interview loaded! Click Start.');
  }catch(e){toast('âŒ '+e.message)}
}

function checkMode(){
  const params=new URLSearchParams(location.search);
  const m=params.get('mode');
  if(m==='real')startMode('real');
  else if(m==='mock')startMode('mock');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  if(window.pdfjsLib)console.log('âœ… PDF.js loaded');
  if(!window.SpeechRecognition&&!window.webkitSpeechRecognition)console.warn('âš ï¸ Use Chrome for voice');
  console.log('[TTS] Voices ready:',speechSynthesis.getVoices().length);
  checkToken();
  checkMode();
});
</script>
</body>
</html>
