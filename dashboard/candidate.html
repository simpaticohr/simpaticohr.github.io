<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidate Dashboard - SimpaticoHR</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #F3F4F6; color: #1F2937; }

        /* ── Sidebar ── */
        .sidebar {
            position: fixed; left: 0; top: 0; bottom: 0; width: 260px;
            background: linear-gradient(180deg, #1E1B4B 0%, #312E81 100%);
            color: #fff; padding: 0; z-index: 100; transition: transform 0.3s;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logo { font-size: 22px; font-weight: 800; }
        .sidebar-logo span { color: #FCD34D; }
        .sidebar-role { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-nav { padding: 16px 12px; }
        .nav-label { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1.2px; padding: 12px 12px 6px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px;
            color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; font-weight: 500;
            margin-bottom: 2px; transition: all 0.2s; cursor: pointer;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-item.active { background: rgba(79,70,229,0.4); color: #fff; }
        .nav-item i { width: 20px; text-align: center; font-size: 15px; }
        .nav-badge {
            margin-left: auto; background: #EF4444; color: #fff; font-size: 10px;
            padding: 2px 7px; border-radius: 10px; font-weight: 600;
        }

        /* ── Main Content ── */
        .main { margin-left: 260px; padding: 0; min-height: 100vh; }
        .topbar {
            background: #fff; padding: 16px 30px; display: flex; align-items: center;
            justify-content: space-between; border-bottom: 1px solid #E5E7EB;
            position: sticky; top: 0; z-index: 50;
        }
        .topbar-left { display: flex; align-items: center; gap: 16px; }
        .menu-toggle { display: none; background: none; border: none; font-size: 20px; color: #374151; cursor: pointer; }
        .page-title { font-size: 20px; font-weight: 700; color: #1F2937; }
        .topbar-right { display: flex; align-items: center; gap: 16px; }
        .notif-btn {
            position: relative; background: #F3F4F6; border: none; width: 40px; height: 40px;
            border-radius: 10px; cursor: pointer; font-size: 16px; color: #6B7280;
        }
        .notif-btn .dot {
            position: absolute; top: 8px; right: 8px; width: 8px; height: 8px;
            background: #EF4444; border-radius: 50%; border: 2px solid #fff;
        }
        .user-menu {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            padding: 6px 12px; border-radius: 10px; transition: background 0.2s;
        }
        .user-menu:hover { background: #F3F4F6; }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 10px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-weight: 700; font-size: 14px;
        }
        .user-info { line-height: 1.3; }
        .user-info .name { font-size: 13px; font-weight: 600; color: #1F2937; }
        .user-info .role { font-size: 11px; color: #9CA3AF; }

        .content { padding: 24px 30px; }

        /* ── Cards ── */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: #fff; border-radius: 14px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            display: flex; align-items: center; gap: 16px; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-icon {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .stat-icon.blue { background: #DBEAFE; color: #2563EB; }
        .stat-icon.green { background: #D1FAE5; color: #059669; }
        .stat-icon.purple { background: #EDE9FE; color: #7C3AED; }
        .stat-icon.orange { background: #FEF3C7; color: #D97706; }
        .stat-value { font-size: 26px; font-weight: 800; color: #1F2937; }
        .stat-label { font-size: 13px; color: #6B7280; }

        .panel {
            background: #fff; border-radius: 14px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom: 24px;
        }
        .panel-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 18px; padding-bottom: 14px; border-bottom: 1px solid #F3F4F6;
        }
        .panel-title { font-size: 16px; font-weight: 700; color: #1F2937; }
        .panel-action {
            padding: 7px 14px; background: #EEF2FF; color: #4F46E5; border: none;
            border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;
            font-family: 'Inter', sans-serif; transition: background 0.2s;
        }
        .panel-action:hover { background: #E0E7FF; }

        /* ── Tab Views ── */
        .tab-section { display: none; }
        .tab-section.active { display: block; }

        /* ── Job Cards ── */
        .job-list { display: flex; flex-direction: column; gap: 14px; }
        .job-card {
            border: 1px solid #E5E7EB; border-radius: 12px; padding: 18px 20px;
            display: flex; align-items: center; gap: 16px; transition: all 0.2s;
            cursor: pointer;
        }
        .job-card:hover { border-color: #818CF8; box-shadow: 0 2px 8px rgba(79,70,229,0.1); }
        .job-logo {
            width: 48px; height: 48px; border-radius: 12px; background: #F3F4F6;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #4F46E5; font-size: 16px;
        }
        .job-info { flex: 1; }
        .job-title { font-size: 15px; font-weight: 600; color: #1F2937; margin-bottom: 4px; }
        .job-company { font-size: 13px; color: #6B7280; }
        .job-meta { display: flex; gap: 14px; margin-top: 6px; flex-wrap: wrap; }
        .job-meta span { font-size: 12px; color: #9CA3AF; display: flex; align-items: center; gap: 4px; }
        .job-actions { display: flex; gap: 8px; }
        .btn-sm {
            padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500;
            border: none; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s;
        }
        .btn-primary { background: #4F46E5; color: #fff; }
        .btn-primary:hover { background: #4338CA; }
        .btn-outline { background: #fff; color: #4F46E5; border: 1px solid #E0E7FF; }
        .btn-outline:hover { background: #EEF2FF; }

        /* ── Application Status ── */
        .app-item {
            display: flex; align-items: center; gap: 14px; padding: 14px 0;
            border-bottom: 1px solid #F3F4F6;
        }
        .app-item:last-child { border-bottom: none; }
        .app-status-badge {
            padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: capitalize;
        }
        .status-applied { background: #DBEAFE; color: #2563EB; }
        .status-screened { background: #FEF3C7; color: #D97706; }
        .status-shortlisted { background: #D1FAE5; color: #059669; }
        .status-interview_scheduled { background: #EDE9FE; color: #7C3AED; }
        .status-interview_completed { background: #E0E7FF; color: #4338CA; }
        .status-selected { background: #D1FAE5; color: #047857; }
        .status-rejected { background: #FEE2E2; color: #DC2626; }
        .status-hired { background: #A7F3D0; color: #065F46; }
        .status-offer_sent { background: #FEF3C7; color: #92400E; }

        /* ── Interview Cards ── */
        .interview-card {
            border: 1px solid #E5E7EB; border-radius: 12px; padding: 18px;
            margin-bottom: 12px; transition: all 0.2s;
        }
        .interview-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .interview-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .interview-title { font-size: 15px; font-weight: 600; }
        .interview-time {
            display: flex; align-items: center; gap: 6px; font-size: 13px; color: #6B7280; margin-top: 4px;
        }
        .interview-time i { color: #4F46E5; }
        .btn-join {
            padding: 8px 20px; background: linear-gradient(135deg, #10B981, #059669);
            color: #fff; border: none; border-radius: 8px; font-size: 13px;
            font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif;
        }
        .btn-join:hover { box-shadow: 0 4px 12px rgba(16,185,129,0.4); }

        /* ── Profile Section ── */
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .profile-field label { font-size: 12px; color: #6B7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .profile-field .value { font-size: 15px; color: #1F2937; margin-top: 4px; font-weight: 500; }
        .skill-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .skill-tag {
            padding: 4px 12px; background: #EEF2FF; color: #4F46E5; border-radius: 6px;
            font-size: 12px; font-weight: 500;
        }

        /* ── Empty States ── */
        .empty-state {
            text-align: center; padding: 50px 20px; color: #9CA3AF;
        }
        .empty-state i { font-size: 48px; margin-bottom: 16px; color: #D1D5DB; }
        .empty-state h3 { font-size: 16px; color: #6B7280; margin-bottom: 6px; }
        .empty-state p { font-size: 13px; }

        /* ── Responsive ── */
        @media(max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
            .menu-toggle { display: block; }
            .content { padding: 16px; }
            .stat-grid { grid-template-columns: 1fr 1fr; }
            .profile-grid { grid-template-columns: 1fr; }
            .topbar { padding: 12px 16px; }
            .user-info { display: none; }
        }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 90; }
        .overlay.active { display: block; }

        /* ── Search ── */
        .search-bar {
            display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .search-input {
            flex: 1; min-width: 200px; padding: 10px 14px 10px 38px; border: 2px solid #E5E7EB;
            border-radius: 10px; font-size: 14px; font-family: 'Inter', sans-serif;
            outline: none; background: #fff; position: relative;
        }
        .search-input:focus { border-color: #4F46E5; }
        .search-wrap { position: relative; flex: 1; min-width: 200px; }
        .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF; }
        .filter-select {
            padding: 10px 14px; border: 2px solid #E5E7EB; border-radius: 10px;
            font-size: 14px; font-family: 'Inter', sans-serif; outline: none; background: #fff;
        }

        /* Loading */
        .loader { text-align: center; padding: 40px; color: #6B7280; }
        .loader .spin { width: 30px; height: 30px; border: 3px solid #E5E7EB; border-top-color: #4F46E5; border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- Overlay for mobile sidebar -->
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">Simpatico<span>HR</span></div>
        <div class="sidebar-role">Candidate Portal</div>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-label">Main</div>
        <a class="nav-item active" onclick="switchTab('dashboard')">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <a class="nav-item" onclick="switchTab('jobs')">
            <i class="fas fa-briefcase"></i> Browse Jobs
        </a>
        <a class="nav-item" onclick="switchTab('applications')">
            <i class="fas fa-file-alt"></i> My Applications
            <span class="nav-badge" id="appCountBadge" style="display:none">0</span>
        </a>
        <a class="nav-item" onclick="switchTab('interviews')">
            <i class="fas fa-video"></i> Interviews
            <span class="nav-badge" id="intCountBadge" style="display:none">0</span>
        </a>

        <div class="nav-label">Account</div>
        <a class="nav-item" onclick="switchTab('profile')">
            <i class="fas fa-user-circle"></i> My Profile
        </a>
        <a class="nav-item" onclick="switchTab('notifications')">
            <i class="fas fa-bell"></i> Notifications
        </a>
        <a class="nav-item" onclick="logout()" style="color: rgba(255,100,100,0.8);">
            <i class="fas fa-sign-out-alt"></i> Sign Out
        </a>
    </nav>
</aside>

<!-- Main -->
<div class="main">
    <div class="topbar">
        <div class="topbar-left">
            <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div class="page-title" id="pageTitle">Dashboard</div>
        </div>
        <div class="topbar-right">
            <button class="notif-btn" onclick="switchTab('notifications')">
                <i class="fas fa-bell"></i>
                <div class="dot" id="notifDot" style="display:none"></div>
            </button>
            <div class="user-menu" id="userMenu">
                <div class="user-avatar" id="userAvatar">C</div>
                <div class="user-info">
                    <div class="name" id="userName">Candidate</div>
                    <div class="role">Candidate</div>
                </div>
            </div>
        </div>
    </div>

    <div class="content">

        <!-- ═══ DASHBOARD TAB ═══ -->
        <div class="tab-section active" id="tab-dashboard">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="fas fa-paper-plane"></i></div>
                    <div>
                        <div class="stat-value" id="statApplied">0</div>
                        <div class="stat-label">Applications Sent</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                    <div>
                        <div class="stat-value" id="statShortlisted">0</div>
                        <div class="stat-label">Shortlisted</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple"><i class="fas fa-video"></i></div>
                    <div>
                        <div class="stat-value" id="statInterviews">0</div>
                        <div class="stat-label">Interviews</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange"><i class="fas fa-trophy"></i></div>
                    <div>
                        <div class="stat-value" id="statOffers">0</div>
                        <div class="stat-label">Offers</div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Interviews -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-calendar-check" style="color:#4F46E5; margin-right:8px"></i> Upcoming Interviews</div>
                    <button class="panel-action" onclick="switchTab('interviews')">View All</button>
                </div>
                <div id="upcomingInterviews">
                    <div class="loader"><div class="spin"></div>Loading...</div>
                </div>
            </div>

            <!-- Recent Applications -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-file-alt" style="color:#10B981; margin-right:8px"></i> Recent Applications</div>
                    <button class="panel-action" onclick="switchTab('applications')">View All</button>
                </div>
                <div id="recentApplications">
                    <div class="loader"><div class="spin"></div>Loading...</div>
                </div>
            </div>
        </div>

        <!-- ═══ BROWSE JOBS TAB ═══ -->
        <div class="tab-section" id="tab-jobs">
            <div class="search-bar">
                <div class="search-wrap" style="flex:2">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" id="jobSearch" placeholder="Search jobs by title, skill, company..." style="padding-left:38px; width:100%">
                </div>
                <select class="filter-select" id="jobLocation">
                    <option value="">All Locations</option>
                    <option>Bangalore</option>
                    <option>Mumbai</option>
                    <option>Delhi</option>
                    <option>Hyderabad</option>
                    <option>Chennai</option>
                    <option>Pune</option>
                    <option>Remote</option>
                </select>
                <select class="filter-select" id="jobType">
                    <option value="">All Types</option>
                    <option value="full_time">Full Time</option>
                    <option value="part_time">Part Time</option>
                    <option value="contract">Contract</option>
                    <option value="internship">Internship</option>
                </select>
                <button class="btn-sm btn-primary" onclick="searchJobs()"><i class="fas fa-search"></i> Search</button>
            </div>
            <div id="jobListings" class="job-list">
                <div class="loader"><div class="spin"></div>Loading jobs...</div>
            </div>
        </div>

        <!-- ═══ MY APPLICATIONS TAB ═══ -->
        <div class="tab-section" id="tab-applications">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">My Applications</div>
                </div>
                <div id="myApplications">
                    <div class="loader"><div class="spin"></div>Loading...</div>
                </div>
            </div>
        </div>

        <!-- ═══ INTERVIEWS TAB ═══ -->
        <div class="tab-section" id="tab-interviews">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">My Interviews</div>
                </div>
                <div id="myInterviews">
                    <div class="loader"><div class="spin"></div>Loading...</div>
                </div>
            </div>
        </div>

        <!-- ═══ PROFILE TAB ═══ -->
        <div class="tab-section" id="tab-profile">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">My Profile</div>
                    <button class="panel-action" onclick="editProfile()"><i class="fas fa-edit" style="margin-right:4px"></i> Edit</button>
                </div>
                <div class="profile-grid" id="profileData">
                    <div class="loader"><div class="spin"></div>Loading profile...</div>
                </div>
            </div>
        </div>

        <!-- ═══ NOTIFICATIONS TAB ═══ -->
        <div class="tab-section" id="tab-notifications">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Notifications</div>
                </div>
                <div id="notifList">
                    <div class="loader"><div class="spin"></div>Loading...</div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Apply Modal -->
<div id="applyModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200; display:none; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; padding:30px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
        <h3 style="margin-bottom:4px; font-size:18px;">Apply for Job</h3>
        <p id="applyJobTitle" style="color:#6B7280; font-size:14px; margin-bottom:20px;"></p>
        <div id="applyAlert" class="alert" style="display:none"></div>
        <form id="applyForm">
            <input type="hidden" id="applyJobId">
            <div class="form-group">
                <label style="font-size:13px; font-weight:600; color:#374151; display:block; margin-bottom:4px;">Cover Letter (Optional)</label>
                <textarea id="applyCover" style="width:100%; padding:10px; border:2px solid #E5E7EB; border-radius:10px; font-size:14px; font-family:'Inter',sans-serif; min-height:100px; resize:vertical;" placeholder="Why are you interested in this role?"></textarea>
            </div>
            <div class="form-group">
                <label style="font-size:13px; font-weight:600; color:#374151; display:block; margin-bottom:4px;">Resume URL (Optional)</label>
                <input type="url" id="applyResume" style="width:100%; padding:10px; border:2px solid #E5E7EB; border-radius:10px; font-size:14px;" placeholder="https://drive.google.com/...">
            </div>
            <div style="display:flex; gap:10px; margin-top:16px;">
                <button type="button" onclick="closeApplyModal()" style="flex:1; padding:11px; background:#F3F4F6; color:#374151; border:none; border-radius:10px; font-size:14px; cursor:pointer; font-family:'Inter',sans-serif;">Cancel</button>
                <button type="submit" style="flex:2; padding:11px; background:#4F46E5; color:#fff; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif;">Submit Application</button>
            </div>
        </form>
    </div>
</div>

<script>
    const API = 'https://evalis-ai.simpaticohrconsultancy.workers.dev';
    let token = localStorage.getItem('simpatico_token');
    let user = null;

    try { user = JSON.parse(localStorage.getItem('simpatico_user')); } catch(e) {}

    if (!token || !user) {
        window.location.href = '../auth/login.html';
    }

    // Set user info
    if (user) {
        document.getElementById('userName').textContent = user.full_name || 'Candidate';
        document.getElementById('userAvatar').textContent = (user.full_name || 'C')[0].toUpperCase();
    }

    // API helper
    async function api(path, options = {}) {
        const res = await fetch(${API}${path}, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': Bearer ${token},
                ...options.headers
            }
        });
        if (res.status === 401) {
            localStorage.clear();
            window.location.href = '../auth/login.html';
            return;
        }
        return res.json();
    }

    // Sidebar toggle
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
    }

    // Tab switching
    function switchTab(tab) {
        document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab-${tab}).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event?.target?.closest('.nav-item')?.classList.add('active');

        const titles = {
            dashboard: 'Dashboard', jobs: 'Browse Jobs', applications: 'My Applications',
            interviews: 'My Interviews', profile: 'My Profile', notifications: 'Notifications'
        };
        document.getElementById('pageTitle').textContent = titles[tab] || 'Dashboard';

        // Load data for tab
        if (tab === 'jobs') searchJobs();
        if (tab === 'applications') loadApplications();
        if (tab === 'interviews') loadInterviews();
        if (tab === 'profile') loadProfile();
        if (tab === 'notifications') loadNotifications();

        // Close mobile sidebar
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('overlay').classList.remove('active');
    }

    // ═══ Load Dashboard ═══
    async function loadDashboard() {
        try {
            const [apps, interviews] = await Promise.all([
                api('/api/applications'),
                api('/api/interviews')
            ]);

            // Stats
            const applied = (apps || []).length;
            const shortlisted = (apps || []).filter(a => ['shortlisted','interview_scheduled','interview_completed','selected'].includes(a.status)).length;
            const interviewCount = (interviews || []).length;
            const offers = (apps || []).filter(a => ['offer_sent','offer_accepted','hired'].includes(a.status)).length;

            document.getElementById('statApplied').textContent = applied;
            document.getElementById('statShortlisted').textContent = shortlisted;
            document.getElementById('statInterviews').textContent = interviewCount;
            document.getElementById('statOffers').textContent = offers;

            if (applied > 0) {
                document.getElementById('appCountBadge').textContent = applied;
                document.getElementById('appCountBadge').style.display = 'inline';
            }

            // Upcoming interviews
            const upcoming = (interviews || []).filter(i => i.status === 'scheduled' && new Date(i.scheduled_at) > new Date());
            const upEl = document.getElementById('upcomingInterviews');
            if (upcoming.length === 0) {
                upEl.innerHTML = '<div class="empty-state"><i class="fas fa-calendar"></i><h3>No upcoming interviews</h3><p>When you\'re scheduled for interviews, they will appear here.</p></div>';
            } else {
                upEl.innerHTML = upcoming.slice(0, 3).map(i => `
                    <div class="interview-card">
                        <div class="interview-header">
                            <div>
                                <div class="interview-title">${i.title || 'Interview'}</div>
                                <div style="font-size:13px; color:#6B7280;">${i.job?.title || ''} ${i.job?.companies?.name ? '- ' + i.job.companies.name : ''}</div>
                                <div class="interview-time">
                                    <i class="fas fa-clock"></i>
                                    ${new Date(i.scheduled_at).toLocaleDateString('en-IN', { weekday: 'short', month: 'short', day: 'numeric' })}
                                    at ${new Date(i.scheduled_at).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}
                                    <span style="margin-left:8px; color:#9CA3AF">(${i.duration_minutes || 45} min)</span>
                                </div>
                            </div>
                            ${i.meeting_url ? <a href="${i.meeting_url}" target="_blank" class="btn-join"><i class="fas fa-video" style="margin-right:4px"></i> Join</a> : ''}
                        </div>
                    </div>
                `).join('');
            }

            // Recent applications
            const recEl = document.getElementById('recentApplications');
            if ((apps || []).length === 0) {
                recEl.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><h3>No applications yet</h3><p>Browse jobs and start applying!</p></div>';
            } else {
                recEl.innerHTML = apps.slice(0, 5).map(a => `
                    <div class="app-item">
                        <div class="job-logo">${(a.job?.title || 'J')[0]}</div>
                        <div style="flex:1">
                            <div style="font-size:14px; font-weight:600;">${a.job?.title || 'Job'}</div>
                            <div style="font-size:12px; color:#6B7280;">${a.job?.companies?.name || a.job?.department || ''} · Applied ${new Date(a.created_at).toLocaleDateString('en-IN')}</div>
                        </div>
                        <span class="app-status-badge status-${a.status}">${a.status.replace(/_/g, ' ')}</span>
                    </div>
                `).join('');
            }

        } catch(err) {
            console.error('Dashboard load error:', err);
        }
    }

    // ═══ Browse Jobs ═══
    async function searchJobs() {
        const search = document.getElementById('jobSearch')?.value || '';
        const location = document.getElementById('jobLocation')?.value || '';
        const type = document.getElementById('jobType')?.value || '';

        const el = document.getElementById('jobListings');
        el.innerHTML = '<div class="loader"><div class="spin"></div>Searching jobs...</div>';

        try {
            let query = /api/jobs/public?q=${encodeURIComponent(search)};
            if (location) query += &location=${encodeURIComponent(location)};
            if (type) query += &type=${type};

            const jobs = await api(query);

            if (!jobs || jobs.length === 0) {
                el.innerHTML = '<div class="empty-state"><i class="fas fa-briefcase"></i><h3>No jobs found</h3><p>Try adjusting your search filters</p></div>';
                return;
            }

            el.innerHTML = jobs.map(j => `
                <div class="job-card">
                    <div class="job-logo">${(j.companies?.name || j.title || 'C')[0].toUpperCase()}</div>
                    <div class="job-info">
                        <div class="job-title">${j.title}</div>
                        <div class="job-company">${j.companies?.name || 'Company'}</div>
                        <div class="job-meta">
                            <span><i class="fas fa-map-marker-alt"></i> ${j.location || 'Not specified'}</span>
                            <span><i class="fas fa-building"></i> ${(j.location_type || 'onsite').replace('_', ' ')}</span>
                            <span><i class="fas fa-clock"></i> ${(j.employment_type || 'full_time').replace('_', ' ')}</span>
                            ${j.experience_min ? <span><i class="fas fa-briefcase"></i> ${j.experience_min}-${j.experience_max || '?'} yrs</span> : ''}
                            ${j.salary_min ? <span><i class="fas fa-rupee-sign"></i> ${(j.salary_min/100000).toFixed(0)}-${(j.salary_max/100000).toFixed(0)} LPA</span> : ''}
                        </div>
                    </div>
                    <div class="job-actions">
                        <button class="btn-sm btn-primary" onclick="openApplyModal('${j.id}', '${j.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-paper-plane" style="margin-right:4px"></i> Apply
                        </button>
                    </div>
                </div>
            `).join('');

        } catch(err) {
            el.innerHTML = <div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading jobs</h3><p>${err.message}</p></div>;
        }
    }

    // ═══ Apply Modal ═══
    function openApplyModal(jobId, jobTitle) {
        document.getElementById('applyJobId').value = jobId;
        document.getElementById('applyJobTitle').textContent = jobTitle;
        document.getElementById('applyModal').style.display = 'flex';
    }

    function closeApplyModal() {
        document.getElementById('applyModal').style.display = 'none';
    }

    document.getElementById('applyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const jobId = document.getElementById('applyJobId').value;
        const coverLetter = document.getElementById('applyCover').value.trim();
        const resumeUrl = document.getElementById('applyResume').value.trim();
        const alertEl = document.getElementById('applyAlert');

        try {
            const result = await api('/api/applications', {
                method: 'POST',
                body: JSON.stringify({
                    job_id: jobId,
                    cover_letter: coverLetter || null,
                    resume_url: resumeUrl || null,
                    source: 'portal'
                })
            });

            if (result.error) throw new Error(result.error);

            alertEl.className = 'alert alert-success';
            alertEl.textContent = 'Application submitted successfully!';
            alertEl.style.display = 'block';

            setTimeout(() => {
                closeApplyModal();
                alertEl.style.display = 'none';
                loadDashboard();
            }, 1500);

        } catch(err) {
            alertEl.className = 'alert alert-error';
            alertEl.textContent = err.message || 'Failed to submit application';
            alertEl.style.display = 'block';
        }
    });

    // ═══ My Applications ═══
    async function loadApplications() {
        const el = document.getElementById('myApplications');
        el.innerHTML = '<div class="loader"><div class="spin"></div>Loading applications...</div>';

        try {
            const apps = await api('/api/applications');
            if (!apps || apps.length === 0) {
                el.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><h3>No applications yet</h3><p>Browse jobs and start applying!</p></div>';
                return;
            }
            el.innerHTML = apps.map(a => `
                <div class="app-item">
                    <div class="job-logo">${(a.job?.title || 'J')[0]}</div>
                    <div style="flex:1">
                        <div style="font-size:15px; font-weight:600;">${a.job?.title || 'Job'}</div>
                        <div style="font-size:13px; color:#6B7280; margin-top:2px;">
                            ${a.job?.companies?.name || a.job?.department || ''}
                            ${a.job?.location ? ' · ' + a.job.location : ''}
                        </div>
                        <div style="font-size:12px; color:#9CA3AF; margin-top:4px;">
                            Applied on ${new Date(a.created_at).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' })}
                            ${a.ai_match_score ? ` · Match: ${a.ai_match_score}%` : ''}
                        </div>
                    </div>
                    <span class="app-status-badge status-${a.status}">${a.status.replace(/_/g, ' ')}</span>
                </div>
            `).join('');
        } catch(err) {
            el.innerHTML = <div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error</h3><p>${err.message}</p></div>;
        }
    }

    // ═══ My Interviews ═══
    async function loadInterviews() {
        const el = document.getElementById('myInterviews');
        el.innerHTML = '<div class="loader"><div class="spin"></div>Loading interviews...</div>';

        try {
            const interviews = await api('/api/interviews');
            if (!interviews || interviews.length === 0) {
                el.innerHTML = '<div class="empty-state"><i class="fas fa-video"></i><h3>No interviews scheduled</h3><p>Interviews will appear here when scheduled by employers.</p></div>';
                return;
            }
            el.innerHTML = interviews.map(i => {
                const dt = new Date(i.scheduled_at);
                const isPast = dt < new Date();
                return `
                    <div class="interview-card">
                        <div class="interview-header">
                            <div>
                                <div class="interview-title">${i.title || 'Interview'}</div>
                                <div style="font-size:13px; color:#6B7280;">${i.job?.title || ''} ${i.job?.companies?.name ? '- ' + i.job.companies.name : ''}</div>
                                <div class="interview-time">
                                    <i class="fas fa-clock"></i>
                                    ${dt.toLocaleDateString('en-IN', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                                    at ${dt.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
                                    <span style="font-size:12px; padding:3px 8px; border-radius:6px; background:#EEF2FF; color:#4F46E5;">
                                        <i class="fas fa-${i.interview_type === 'ai_proctored' ? 'shield-alt' : 'video'}"></i> ${(i.interview_type || '').replace(/_/g, ' ')}
                                    </span>
                                    <span style="font-size:12px; padding:3px 8px; border-radius:6px; background:#F3F4F6; color:#6B7280;">
                                        ${i.duration_minutes || 45} min
                                    </span>
                                    ${i.proctoring_enabled ? '<span style="font-size:12px; padding:3px 8px; border-radius:6px; background:#FEF3C7; color:#92400E;"><i class="fas fa-eye"></i> Proctored</span>' : ''}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <span class="app-status-badge status-${i.status === 'scheduled' ? 'applied' : i.status === 'completed' ? 'shortlisted' : 'screened'}">${i.status}</span>
                                ${!isPast && i.status === 'scheduled' && i.meeting_url ? `
                                    <br><a href="${i.meeting_url}" target="_blank" class="btn-join" style="margin-top:8px; display:inline-block;">
                                        <i class="fas fa-video" style="margin-right:4px"></i> Join Interview
                                    </a>` : ''}
                                ${i.status === 'completed' && i.overall_score ? <div style="margin-top:6px; font-size:13px; color:#059669; font-weight:600;">Score: ${i.overall_score}%</div> : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch(err) {
            el.innerHTML = <div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error</h3><p>${err.message}</p></div>;
        }
    }

    // ═══ Profile ═══
    async function loadProfile() {
        const el = document.getElementById('profileData');
        el.innerHTML = '<div class="loader"><div class="spin"></div>Loading profile...</div>';

        try {
            const data = await api('/api/auth/me');
            const u = data.user;
            el.innerHTML = `
                <div class="profile-field"><label>Full Name</label><div class="value">${u.full_name || '-'}</div></div>
                <div class="profile-field"><label>Email</label><div class="value">${u.email || '-'}</div></div>
                <div class="profile-field"><label>Phone</label><div class="value">${u.phone || '-'}</div></div>
                <div class="profile-field"><label>Role</label><div class="value" style="text-transform:capitalize;">${(u.role || '').replace('_', ' ')}</div></div>
                <div class="profile-field"><label>Last Login</label><div class="value">${u.last_login ? new Date(u.last_login).toLocaleString('en-IN') : 'First login'}</div></div>
                <div class="profile-field"><label>Joined</label><div class="value">${new Date(u.created_at).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div>
            `;
        } catch(err) {
            el.innerHTML = <p style="color:#EF4444">Error loading profile: ${err.message}</p>;
        }
    }

    // ═══ Notifications ═══
    async function loadNotifications() {
        const el = document.getElementById('notifList');
        el.innerHTML = '<div class="loader"><div class="spin"></div>Loading...</div>';

        try {
            const notifs = await api('/api/notifications');
            if (!notifs || notifs.length === 0) {
                el.innerHTML = '<div class="empty-state"><i class="fas fa-bell-slash"></i><h3>No notifications</h3><p>You\'re all caught up!</p></div>';
                return;
            }
            el.innerHTML = notifs.map(n => `
                <div class="app-item" style="opacity:${n.status === 'read' ? '0.6' : '1'}">
                    <div style="width:36px; height:36px; border-radius:10px; background:${n.status === 'read' ? '#F3F4F6' : '#EEF2FF'}; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-${n.type === 'email' ? 'envelope' : n.type === 'whatsapp' ? 'comment' : 'bell'}" style="color:${n.status === 'read' ? '#9CA3AF' : '#4F46E5'}; font-size:14px;"></i>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:14px; font-weight:${n.status === 'read' ? '400' : '600'};">${n.subject || n.body?.substring(0, 60) || 'Notification'}</div>
                        <div style="font-size:12px; color:#9CA3AF; margin-top:2px;">${new Date(n.created_at).toLocaleString('en-IN')}</div>
                    </div>
                </div>
            `).join('');
        } catch(err) {
            el.innerHTML = <div class="empty-state"><p>${err.message}</p></div>;
        }
    }

    function editProfile() {
        alert('Profile editing coming soon! Please contact HR for any changes.');
    }

    function logout() {
        if (confirm('Are you sure you want to sign out?')) {
            localStorage.clear();
            window.location.href = '../auth/login.html';
        }
    }

    // Enter key for job search
    document.getElementById('jobSearch')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchJobs();
    });

    // Initial load
    loadDashboard();
</script>
</body>
</html>
