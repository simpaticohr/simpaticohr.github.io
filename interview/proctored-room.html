<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview - SimpaticoHR</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-surface: #1a1a2e;
            --bg-input: #0f0f1a;
            --border: #2a2a3e;
            --primary: #6366f1;
            --primary-glow: rgba(99,102,241,.25);
            --accent: #22d3ee;
            --accent-glow: rgba(34,211,238,.15);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --text-dim: #64748b;
            --text-muted: #475569;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
        }

        .app { display: flex; flex-direction: column; height: 100vh; }

        /* ‚ïê‚ïê‚ïê Top Bar ‚ïê‚ïê‚ïê */
        .topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background: var(--bg-card);
            border-bottom: 1px solid var(--border); height: 52px; flex-shrink: 0;
            transition: background .3s;
        }
        .tb-left { display: flex; align-items: center; gap: 12px; }
        .tb-logo { font-size: 15px; font-weight: 800; }
        .tb-logo span { color: #fcd34d; }
        .tb-badge {
            padding: 3px 10px; background: rgba(239,68,68,.15); color: #f87171;
            border-radius: 6px; font-size: 10px; font-weight: 700;
            letter-spacing: .5px; text-transform: uppercase;
            display: flex; align-items: center; gap: 4px;
        }
        .tb-badge .dot { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: .3; } }
        .tb-center { display: flex; align-items: center; gap: 20px; }
        .trust-pill {
            display: flex; align-items: center; gap: 8px;
            padding: 4px 12px; background: var(--bg-surface); border-radius: 20px;
            border: 1px solid var(--border);
        }
        .trust-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; }
        .trust-ring {
            width: 28px; height: 28px; border-radius: 50%; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .trust-ring svg { position: absolute; transform: rotate(-90deg); }
        .trust-ring .val { font-size: 9px; font-weight: 800; z-index: 1; }
        .timer-pill {
            padding: 5px 14px; background: var(--bg-surface); border-radius: 20px;
            border: 1px solid var(--border); font-size: 13px; font-weight: 700;
            font-variant-numeric: tabular-nums; display: flex; align-items: center; gap: 6px;
        }
        .timer-pill i { color: var(--danger); font-size: 11px; }
        .timer-pill.warn { color: var(--danger); border-color: rgba(239,68,68,.3); }
        .tb-right { display: flex; align-items: center; gap: 10px; }
        .tb-btn {
            padding: 6px 14px; border-radius: 8px; border: none; font-size: 12px;
            font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all .2s;
        }
        .btn-end { background: var(--danger); color: #fff; }
        .btn-end:hover { box-shadow: 0 0 20px rgba(239,68,68,.3); }

        /* ‚ïê‚ïê‚ïê Main Area ‚ïê‚ïê‚ïê */
        .main-area { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* ‚ïê‚ïê‚ïê Full-screen Video ‚ïê‚ïê‚ïê */
        .video-section {
            flex: 1; display: flex; flex-direction: column;
            position: relative; min-width: 0;
        }
        .video-container {
            flex: 1; position: relative; background: #000;
            overflow: hidden;
        }
        .video-container video { width: 100%; height: 100%; object-fit: cover; }
        .video-overlay-top {
            position: absolute; top: 0; left: 0; right: 0; padding: 12px 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,.7), transparent);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10;
        }
        .vo-rec { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #f87171; font-weight: 600; }
        .vo-rec .rdot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: blink 1.5s infinite; }
        .vo-quality { font-size: 10px; color: var(--text-dim); padding: 3px 8px; background: rgba(0,0,0,.5); border-radius: 4px; }

        /* ‚ïê‚ïê‚ïê AI Orb Overlay ‚ïê‚ïê‚ïê */
        .ai-orb-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 20; display: flex; flex-direction: column; align-items: center;
            pointer-events: none;
        }
        .ai-orb {
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circle at 40% 40%, #818cf8, #6366f1, #4f46e5);
            box-shadow: 0 0 60px rgba(99,102,241,.3), 0 0 120px rgba(99,102,241,.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; transition: all .5s;
            position: relative;
        }
        .ai-orb::before {
            content: ''; position: absolute; inset: -4px; border-radius: 50%;
            border: 2px solid rgba(99,102,241,.3);
            animation: orb-pulse 3s ease-in-out infinite;
        }
        .ai-orb::after {
            content: ''; position: absolute; inset: -12px; border-radius: 50%;
            border: 1px solid rgba(99,102,241,.15);
            animation: orb-pulse 3s ease-in-out infinite .5s;
        }
        @keyframes orb-pulse {
            0%, 100% { transform: scale(1); opacity: .6; }
            50% { transform: scale(1.15); opacity: 1; }
        }
        .ai-orb.speaking {
            animation: orb-speak .3s ease-in-out infinite alternate;
            box-shadow: 0 0 80px rgba(99,102,241,.5), 0 0 160px rgba(99,102,241,.25);
        }
        @keyframes orb-speak {
            0% { transform: scale(1); }
            100% { transform: scale(1.08); }
        }
        .ai-orb.listening {
            background: radial-gradient(circle at 40% 40%, #34d399, #10b981, #059669);
            box-shadow: 0 0 60px rgba(16,185,129,.3), 0 0 120px rgba(16,185,129,.15);
        }
        .ai-orb.listening::before { border-color: rgba(16,185,129,.3); }
        .ai-orb.listening::after { border-color: rgba(16,185,129,.15); }

        .ai-status-text {
            margin-top: 16px; font-size: 13px; font-weight: 600;
            color: rgba(255,255,255,.8); text-shadow: 0 2px 8px rgba(0,0,0,.5);
            letter-spacing: .5px; text-transform: uppercase;
        }
        .ai-subtitle-text {
            margin-top: 6px; font-size: 18px; font-weight: 500;
            color: rgba(255,255,255,.95); text-shadow: 0 2px 12px rgba(0,0,0,.7);
            max-width: 600px; text-align: center; line-height: 1.5;
            opacity: 0; transition: opacity .3s;
        }
        .ai-subtitle-text.show { opacity: 1; }

        /* ‚ïê‚ïê‚ïê Listening Visualizer ‚ïê‚ïê‚ïê */
        .listen-viz {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: flex; align-items: center; gap: 3px;
            height: 50px; opacity: 0; transition: opacity .3s;
            pointer-events: none;
        }
        .listen-viz.active { opacity: 1; }
        .listen-viz .bar {
            width: 4px; background: var(--success); border-radius: 2px;
            transition: height .1s;
            height: 6px;
        }

        /* ‚ïê‚ïê‚ïê Self Cam ‚ïê‚ïê‚ïê */
        .self-cam {
            position: absolute; bottom: 20px; right: 20px;
            width: 180px; height: 135px; border-radius: 16px;
            overflow: hidden; border: 2px solid var(--border);
            background: var(--bg-surface); z-index: 15;
            box-shadow: 0 8px 30px rgba(0,0,0,.4);
        }
        .self-cam video { width: 100%; height: 100%; object-fit: cover; }
        .self-cam-label {
            position: absolute; bottom: 6px; left: 8px; font-size: 10px;
            color: rgba(255,255,255,.7); background: rgba(0,0,0,.5);
            padding: 2px 8px; border-radius: 4px; font-weight: 600;
        }

        /* ‚ïê‚ïê‚ïê Bottom Controls ‚ïê‚ïê‚ïê */
        .video-controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 25; display: flex; align-items: center; gap: 10px;
            padding: 8px 16px; background: rgba(18,18,26,.85);
            backdrop-filter: blur(12px); border-radius: 20px;
            border: 1px solid var(--border);
        }
        .vc-btn {
            width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--bg-surface); color: var(--text); cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 15px;
            transition: all .2s;
        }
        .vc-btn:hover { background: var(--border); }
        .vc-btn.off { background: rgba(239,68,68,.15); color: #f87171; border-color: rgba(239,68,68,.3); }
        .vc-btn.active-mic {
            background: rgba(16,185,129,.15); color: #34d399; border-color: rgba(16,185,129,.3);
            animation: mic-glow 2s ease-in-out infinite;
        }
        @keyframes mic-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,.2); }
            50% { box-shadow: 0 0 0 8px rgba(16,185,129,0); }
        }
        .vc-btn.end { background: var(--danger); color: #fff; border-color: var(--danger); width: 56px; }
        .vc-btn.end:hover { box-shadow: 0 0 20px rgba(239,68,68,.3); }

        .q-tracker {
            position: absolute; top: 14px; right: 16px; z-index: 15;
            background: rgba(0,0,0,.5); backdrop-filter: blur(8px);
            padding: 6px 14px; border-radius: 10px; font-size: 11px;
            color: var(--text-dim); font-weight: 600; border: 1px solid rgba(255,255,255,.05);
        }

        /* ‚ïê‚ïê‚ïê Setup Overlay ‚ïê‚ïê‚ïê */
        .setup-overlay {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 500;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .setup-card {
            background: var(--bg-card); border-radius: 24px; padding: 40px;
            max-width: 520px; width: 100%; text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 0 80px rgba(99,102,241,.1);
        }
        .setup-card h1 { font-size: 26px; font-weight: 900; margin-bottom: 4px; }
        .setup-card h1 span { color: #fcd34d; }
        .setup-sub { color: var(--text-dim); font-size: 13px; margin-bottom: 24px; }

        .setup-job-card {
            background: var(--bg-surface); border-radius: 14px; padding: 16px;
            text-align: left; margin-bottom: 20px; border: 1px solid var(--border);
        }
        .sjc-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
        .sjc-meta { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-dim); margin-bottom: 8px; }
        .sjc-meta span { display: flex; align-items: center; gap: 4px; }
        .sjc-skills { display: flex; gap: 5px; flex-wrap: wrap; }
        .sjc-skill {
            padding: 3px 9px; background: rgba(99,102,241,.1); color: var(--primary);
            border-radius: 6px; font-size: 11px; font-weight: 500;
        }

        .setup-cam { width: 280px; height: 210px; border-radius: 14px; overflow: hidden; background: #000; margin: 0 auto 20px; border: 2px solid var(--border); position: relative; }
        .setup-cam video { width: 100%; height: 100%; object-fit: cover; }
        .face-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            width: 120px; height: 150px; border: 2px dashed rgba(99,102,241,.4);
            border-radius: 50%; opacity: .5;
        }

        .checks { max-width: 300px; margin: 0 auto 20px; }
        .chk {
            display: flex; align-items: center; gap: 10px; padding: 7px 0; font-size: 13px;
        }
        .chk-icon {
            width: 24px; height: 24px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0;
        }
        .chk-pass { background: var(--success); color: #fff; }
        .chk-fail { background: var(--danger); color: #fff; }
        .chk-wait { background: var(--bg-surface); color: var(--text-muted); border: 1px solid var(--border); }
        .chk-spin { background: var(--bg-surface); color: var(--primary); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: .4; } }

        .setup-note {
            padding: 12px 16px; background: rgba(245,158,11,.08);
            border: 1px solid rgba(245,158,11,.2); border-radius: 10px;
            font-size: 12px; color: #fcd34d; line-height: 1.6; margin-bottom: 16px;
        }
        .setup-voice-note {
            padding: 12px 16px; background: rgba(99,102,241,.08);
            border: 1px solid rgba(99,102,241,.2); border-radius: 10px;
            font-size: 12px; color: #a5b4fc; line-height: 1.6; margin-bottom: 20px;
        }
        .setup-voice-note i { margin-right: 4px; }
        .btn-begin {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), #a855f7);
            color: #fff; border: none; border-radius: 14px; font-size: 16px;
            font-weight: 800; cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all .3s;
        }
        .btn-begin:hover { box-shadow: 0 8px 30px var(--primary-glow); transform: translateY(-1px); }
        .btn-begin:disabled { opacity: .4; cursor: not-allowed; transform: none; }

        /* ‚ïê‚ïê‚ïê Responsive ‚ïê‚ïê‚ïê */
        @media(max-width: 900px) {
            .self-cam { width: 120px; height: 90px; bottom: 90px; right: 12px; }
            .ai-orb { width: 90px; height: 90px; font-size: 32px; }
            .ai-subtitle-text { font-size: 15px; max-width: 90vw; }
        }
    </style>
</head>
<body>

<!-- SETUP SCREEN -->
<div class="setup-overlay" id="setupOverlay">
    <div class="setup-card">
        <h1>Simpatico<span>HR</span></h1>
        <p class="setup-sub">AI Voice Interview</p>

        <div class="setup-job-card" id="setupJobCard">
            <div class="sjc-title" id="sjcTitle">Loading position...</div>
            <div class="sjc-meta">
                <span id="sjcDept"><i class="fas fa-building"></i> ‚Äî</span>
                <span id="sjcExp"><i class="fas fa-briefcase"></i> ‚Äî</span>
                <span id="sjcLoc"><i class="fas fa-map-marker-alt"></i> ‚Äî</span>
            </div>
            <div class="sjc-skills" id="sjcSkills"></div>
        </div>

        <div class="setup-cam">
            <video id="setupVid" autoplay muted playsinline></video>
            <div class="face-guide"></div>
        </div>

        <div class="checks">
            <div class="chk"><div class="chk-icon chk-wait" id="c1"><i class="fas fa-video"></i></div> Camera</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c2"><i class="fas fa-microphone"></i></div> Microphone</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c3"><i class="fas fa-user-check"></i></div> Face Detection</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c4"><i class="fas fa-volume-up"></i></div> Speaker / Audio</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c5"><i class="fas fa-wifi"></i></div> Connection</div>
        </div>

        <div class="setup-note">
            <i class="fas fa-shield-alt" style="margin-right:4px"></i>
            <strong>This is a proctored AI interview.</strong> Your camera, microphone, and browser activity will be monitored. Do not switch tabs or use external tools.
        </div>

        <div class="setup-voice-note">
            <i class="fas fa-headset"></i>
            <strong>Hands-free voice interview.</strong> The AI will speak questions aloud. Just talk naturally ‚Äî your mic is always listening. No typing needed.
        </div>

        <button class="btn-begin" id="btnBegin" disabled onclick="startSession()">
            <i class="fas fa-headset" style="margin-right:6px"></i> Begin Voice Interview
        </button>
    </div>
</div>

<!-- INTERVIEW ROOM -->
<div class="app" id="interviewApp" style="display:none">
    <div class="topbar">
        <div class="tb-left">
            <div class="tb-logo">Simpatico<span>HR</span></div>
            <div class="tb-badge"><div class="dot"></div> PROCTORED</div>
        </div>
        <div class="tb-center">
            <div class="trust-pill">
                <span class="trust-label">Trust</span>
                <div class="trust-ring">
                    <svg width="28" height="28"><circle cx="14" cy="14" r="12" fill="none" stroke="var(--border)" stroke-width="2.5"/><circle id="trustCircle" cx="14" cy="14" r="12" fill="none" stroke="var(--success)" stroke-width="2.5" stroke-dasharray="75.4" stroke-dashoffset="0" stroke-linecap="round"/></svg>
                    <span class="val" id="trustVal">100</span>
                </div>
            </div>
            <div class="timer-pill" id="timerPill">
                <i class="fas fa-clock"></i> <span id="timerText">15:00</span>
            </div>
        </div>
        <div class="tb-right">
            <span style="font-size:11px;color:var(--text-muted)" id="qTracker">Q 0 / ~10</span>
            <button class="tb-btn btn-end" onclick="endSession()"><i class="fas fa-phone-slash" style="margin-right:3px"></i> End</button>
        </div>
    </div>

    <div class="main-area">
        <div class="video-section">
            <div class="video-container">
                <video id="mainVid" autoplay muted playsinline style="display:none"></video>
                <div style="width:100%;height:100%;background:linear-gradient(135deg,#0a0a1a,#1a1a3e,#0a0a1a);"></div>

                <div class="video-overlay-top">
                    <div class="vo-rec"><div class="rdot"></div> REC</div>
                    <div class="vo-quality" id="voQuality">HD</div>
                </div>

                <div class="q-tracker" id="qTrackerOverlay">Q 0 / ~10</div>

                <!-- AI Orb -->
                <div class="ai-orb-container">
                    <div class="ai-orb" id="aiOrb">ü§ñ</div>
                    <div class="ai-status-text" id="aiStatusText">CONNECTING</div>
                    <div class="ai-subtitle-text" id="aiSubtitleText"></div>
                </div>

                <!-- Listening Visualizer -->
                <div class="listen-viz" id="listenViz"></div>

                <!-- Self Camera -->
                <div class="self-cam">
                    <video id="selfVid" autoplay muted playsinline></video>
                    <div class="self-cam-label">You</div>
                </div>
            </div>

            <!-- Bottom Controls -->
            <div class="video-controls">
                <button class="vc-btn" id="vcCam" onclick="toggleCam()"><i class="fas fa-video"></i></button>
                <button class="vc-btn active-mic" id="vcMic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                <button class="vc-btn" onclick="goFullscreen()"><i class="fas fa-expand"></i></button>
                <button class="vc-btn end" onclick="endSession()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API = 'https://evalis-ai.simpaticohrconsultancy.workers.dev';
const token = localStorage.getItem('simpatico_token');
const user = JSON.parse(localStorage.getItem('simpatico_user') || '{}');
const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get('room');

if (!token || !user.id) { alert('Please login first'); window.location.href='../auth/login.html'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mediaStream = null;
let interviewMeta = null;
let job = null;
let trust = 100;
let seconds = 15 * 60; // 15 minutes
let timerInt = null;
let camOn = true, micOn = true;
let recognition = null;
let isListening = false;
let isSpeaking = false; // AI is speaking
let silenceTimer = null;
let currentTranscript = '';
let finalTranscript = '';
let lastSpeechTime = 0;
const SILENCE_THRESHOLD = 2200; // ms of silence before auto-submit
const MIN_ANSWER_LENGTH = 3; // minimum words to accept

// Audio visualizer
let audioCtx, analyser, micSource, vizBars = [];

// Conversation State
let convoState = {
    phase: 'intro',
    questionCount: 0,
    maxQuestions: 10,
    currentSkillIdx: 0,
    skills: [],
    skillScores: {},
    overallScores: { technical: [], behavioral: [], problem_solving: [], communication: [] },
    history: [],
    currentTopic: null,
    followUpDepth: 0,
    maxFollowUpDepth: 2,
    candidateExperience: 0,
    level: 'mid',
    jobTitle: '',
    department: '',
    answeredSkills: new Set(),
    weakAreas: [],
    strongAreas: [],
};
let procLogs = [];

// TTS
let speechSynth = window.speechSynthesis;
let preferredVoice = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(path, opts = {}) {
    return fetch(`${API}${path}`, {
        ...opts,
        headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}`, ...opts.headers }
    }).then(r => r.json()).catch(e => ({ error: e.message }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
    try {
        const interviews = await api('/api/interviews');
        interviewMeta = (interviews || []).find(i => i.room_id === roomId);
        if (interviewMeta) {
            seconds = Math.min((interviewMeta.duration_minutes || 15), 15) * 60;
            if (interviewMeta.job_id) {
                const jRes = await api(`/api/jobs/${interviewMeta.job_id}`);
                if (jRes && !jRes.error) job = jRes;
            }
            if (!job && interviewMeta.job) job = interviewMeta.job;
        }
    } catch(e) { console.warn(e); }

    if (job) {
        document.getElementById('sjcTitle').textContent = job.title || 'Interview';
        document.getElementById('sjcDept').innerHTML = `<i class="fas fa-building"></i> ${job.department || 'General'}`;
        document.getElementById('sjcExp').innerHTML = `<i class="fas fa-briefcase"></i> ${job.experience_min||0}‚Äì${job.experience_max||'?'} yrs`;
        document.getElementById('sjcLoc').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${job.location || 'Remote'}`;
        const skEl = document.getElementById('sjcSkills');
        (job.skills_required || []).forEach(s => { skEl.innerHTML += `<span class="sjc-skill">${s}</span>`; });

        convoState.skills = [...(job.skills_required || [])];
        convoState.jobTitle = job.title || '';
        convoState.department = job.department || '';
        const avgExp = ((job.experience_min||0) + (job.experience_max||5)) / 2;
        if (avgExp <= 1) convoState.level = 'fresher';
        else if (avgExp <= 3) convoState.level = 'junior';
        else if (avgExp <= 7) convoState.level = 'senior';
        else convoState.level = 'lead';
        convoState.candidateExperience = avgExp;
    }

    // Pre-select a good TTS voice
    loadVoices();
    speechSynth.onvoiceschanged = loadVoices;

    await setupMedia();
}

function loadVoices() {
    const voices = speechSynth.getVoices();
    // Prefer natural English female voices
    const preferred = [        'Google UK English Female', 'Google US English', 'Samantha',        'Microsoft Zira', 'Karen', 'Moira', 'Fiona', 'Google UK English Male',        'Microsoft David', 'Daniel'    ];
    for (const name of preferred) {
        const v = voices.find(v => v.name.includes(name));
        if (v) { preferredVoice = v; return; }
    }
    // Fallback to any English voice
    preferredVoice = voices.find(v => v.lang.startsWith('en')) || voices[0] || null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEDIA SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function setupMedia() {
    setChk('c5','spin');
    try { await api('/api/auth/me'); setChk('c5','pass'); } catch(e) { setChk('c5','fail'); }

    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
            video:{ width:{ideal:1280},height:{ideal:720},facingMode:'user' },
            audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }
        });
        document.getElementById('setupVid').srcObject = mediaStream;
        setChk('c1','pass'); setChk('c2','pass');
        setChk('c3','spin'); setChk('c4','spin');
        setTimeout(() => {
            setChk('c3','pass'); setChk('c4','pass');
            document.getElementById('btnBegin').disabled = false;
        }, 2000);
    } catch(err) {
        setChk('c1','fail'); setChk('c2','fail');
        alert('Camera and microphone are required.');
    }

    // Setup speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-IN';
        recognition.maxAlternatives = 1;

        recognition.onresult = handleSpeechResult;
        recognition.onerror = (e) => {
            console.warn('Speech error:', e.error);
            if (e.error === 'no-speech' || e.error === 'audio-capture') {
                restartListening();
            }
        };
        recognition.onend = () => {
            if (isListening && !isSpeaking) {
                // Auto-restart if we should be listening
                setTimeout(() => {
                    try { recognition.start(); } catch(e) {}
                }, 100);
            }
        };
    }
}

function setChk(id, state) {
    const el = document.getElementById(id);
    const m = { pass:'chk-pass', fail:'chk-fail', wait:'chk-wait', spin:'chk-spin' };
    const i = { pass:'fa-check', fail:'fa-times', wait:'fa-hourglass-half', spin:'fa-spinner' };
    el.className = `chk-icon ${m[state]}`;
    el.innerHTML = `<i class="fas ${i[state]}"></i>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO VISUALIZER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initAudioVisualizer() {
    const vizEl = document.getElementById('listenViz');
    // Create bars
    for (let i = 0; i < 32; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        vizEl.appendChild(bar);
        vizBars.push(bar);
    }

    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 128;
        analyser.smoothingTimeConstant = 0.8;
        micSource = audioCtx.createMediaStreamSource(mediaStream);
        micSource.connect(analyser);
        animateViz();
    } catch(e) { console.warn('Audio viz error:', e); }
}

function animateViz() {
    if (!analyser) return;
    requestAnimationFrame(animateViz);

    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);

    vizBars.forEach((bar, i) => {
        const idx = Math.floor(i * data.length / vizBars.length);
        const val = data[idx] || 0;
        const h = Math.max(4, (val / 255) * 50);
        bar.style.height = h + 'px';
        const intensity = val / 255;
        bar.style.background = `rgba(${16 + intensity * 80}, ${185 - intensity * 40}, ${129}, ${0.5 + intensity * 0.5})`;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startSession() {
    document.getElementById('setupOverlay').style.display = 'none';
    document.getElementById('interviewApp').style.display = 'flex';

    document.getElementById('mainVid').srcObject = mediaStream;
    document.getElementById('selfVid').srcObject = mediaStream;

    if (interviewMeta?.id) api(`/api/interviews/${interviewMeta.id}/start`, { method:'POST' }).catch(()=>{});

    timerInt = setInterval(tick, 1000);
    startProctoring();
    initAudioVisualizer();

    try { await document.documentElement.requestFullscreen(); } catch(e){}

    // AI speaks the first message
    const introText = buildIntroMessage();
    await aiSpeak(introText, 'intro');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEXT-TO-SPEECH ‚Äî AI Voice
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function aiSpeak(text, phase, meta = {}) {
    return new Promise((resolve) => {
        isSpeaking = true;
        stopListening();

        const orb = document.getElementById('aiOrb');
        const statusText = document.getElementById('aiStatusText');
        const subtitleText = document.getElementById('aiSubtitleText');

        orb.classList.add('speaking');
        orb.classList.remove('listening');
        statusText.textContent = 'AI SPEAKING';

        // Show clean text as subtitle
        const cleanText = text.replace(/\*\*/g, '').replace(/\n/g, ' ').trim();
        subtitleText.textContent = cleanText;
        subtitleText.classList.add('show');

        // Hide listening viz
        document.getElementById('listenViz').classList.remove('active');

        // Cancel any ongoing speech
        speechSynth.cancel();

        const utter = new SpeechSynthesisUtterance(cleanText);
        if (preferredVoice) utter.voice = preferredVoice;
        utter.rate = 1.0;
        utter.pitch = 1.0;
        utter.volume = 1.0;

        utter.onend = () => {
            isSpeaking = false;
            orb.classList.remove('speaking');
            subtitleText.classList.remove('show');

            if (!meta.isClosing) {
                // Start listening for candidate's answer
                startListening();
            } else {
                statusText.textContent = 'INTERVIEW COMPLETE';
                setTimeout(() => endSession(), 4000);
            }
            resolve();
        };

        utter.onerror = () => {
            isSpeaking = false;
            orb.classList.remove('speaking');
            subtitleText.classList.remove('show');
            if (!meta.isClosing) startListening();
            resolve();
        };

        // Chrome bug fix: long text stops speaking
        // Break into chunks if needed
        if (cleanText.length > 200) {
            speakLongText(cleanText, utter, meta, resolve);
        } else {
            speechSynth.speak(utter);
        }

        // Store in history as AI message
        convoState.history.push({
            role: 'ai', phase, text, meta, timestamp: Date.now()
        });
    });
}

function speakLongText(text, baseUtter, meta, resolve) {
    // Split by sentences
    const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
    const chunks = [];
    let current = '';

    for (const s of sentences) {
        if ((current + s).length > 180) {
            if (current) chunks.push(current.trim());
            current = s;
        } else {
            current += s;
        }
    }
    if (current.trim()) chunks.push(current.trim());

    let idx = 0;
    function speakNext() {
        if (idx >= chunks.length) {
            isSpeaking = false;
            document.getElementById('aiOrb').classList.remove('speaking');
            document.getElementById('aiSubtitleText').classList.remove('show');
            if (!meta.isClosing) startListening();
            else {
                document.getElementById('aiStatusText').textContent = 'INTERVIEW COMPLETE';
                setTimeout(() => endSession(), 4000);
            }
            resolve();
            return;
        }

        const u = new SpeechSynthesisUtterance(chunks[idx]);
        if (preferredVoice) u.voice = preferredVoice;
        u.rate = baseUtter.rate;
        u.pitch = baseUtter.pitch;
        u.volume = baseUtter.volume;

        document.getElementById('aiSubtitleText').textContent = chunks[idx];

        u.onend = () => { idx++; speakNext(); };
        u.onerror = () => { idx++; speakNext(); };
        speechSynth.speak(u);
    }

    speakNext();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTINUOUS LISTENING ‚Äî Hands-free
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startListening() {
    if (!recognition || isSpeaking) return;

    isListening = true;
    finalTranscript = '';
    currentTranscript = '';
    lastSpeechTime = 0;

    const orb = document.getElementById('aiOrb');
    const statusText = document.getElementById('aiStatusText');

    orb.classList.add('listening');
    statusText.textContent = 'LISTENING';
    document.getElementById('listenViz').classList.add('active');
    document.getElementById('vcMic').classList.add('active-mic');

    try { recognition.start(); } catch(e) {}

    // Start silence detection loop
    startSilenceDetection();
}

function stopListening() {
    isListening = false;
    clearTimeout(silenceTimer);

    document.getElementById('listenViz').classList.remove('active');
    document.getElementById('vcMic').classList.remove('active-mic');

    try { recognition.stop(); } catch(e) {}
}

function restartListening() {
    if (!isListening || isSpeaking) return;
    try { recognition.stop(); } catch(e) {}
    setTimeout(() => {
        if (isListening && !isSpeaking) {
            try { recognition.start(); } catch(e) {}
        }
    }, 200);
}

function handleSpeechResult(e) {
    if (isSpeaking) return; // Ignore while AI is speaking

    let interim = '';
    let final = '';

    for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) {
            final += t + ' ';
        } else {
            interim += t;
        }
    }

    if (final) {
        finalTranscript += final;
        lastSpeechTime = Date.now();
    }

    if (interim) {
        currentTranscript = interim;
        lastSpeechTime = Date.now();
    }

    // Update status to show we're hearing them
    const totalWords = (finalTranscript + currentTranscript).trim().split(/\s+/).filter(Boolean).length;
    if (totalWords > 0) {
        document.getElementById('aiStatusText').textContent = `LISTENING ¬∑ ${totalWords} words`;
    }
}

function startSilenceDetection() {
    clearTimeout(silenceTimer);

    function check() {
        if (!isListening || isSpeaking) return;

        const fullText = (finalTranscript + currentTranscript).trim();
        const words = fullText.split(/\s+/).filter(Boolean).length;
        const timeSinceLastSpeech = Date.now() - lastSpeechTime;

        if (words >= MIN_ANSWER_LENGTH && lastSpeechTime > 0 && timeSinceLastSpeech >= SILENCE_THRESHOLD) {
            // Silence detected after speech ‚Äî auto-submit
            submitVoiceAnswer(fullText);
            return;
        }

        silenceTimer = setTimeout(check, 300);
    }

    silenceTimer = setTimeout(check, 500);
}

async function submitVoiceAnswer(text) {
    stopListening();

    const orb = document.getElementById('aiOrb');
    const statusText = document.getElementById('aiStatusText');

    orb.classList.remove('listening');
    statusText.textContent = 'PROCESSING';

    const words = text.split(/\s+/).filter(Boolean).length;
    addProcLog('info', `Answer received (${words} words)`);

    if (interviewMeta?.id) {
        api('/api/proctor/log', { method:'POST', body:JSON.stringify({
            interview_id: interviewMeta.id, candidate_id: user.id,
            event_type: 'answer_submitted', severity: 'info',
            description: `Q${convoState.questionCount + 1} answered (${words} words)`
        })}).catch(()=>{});
    }

    // Process the answer
    await processUserAnswer(text);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONVERSATION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildIntroMessage() {
    const name = user.full_name?.split(' ')[0] || 'there';
    const title = convoState.jobTitle || 'this position';
    return `Hi ${name}! Welcome to your interview for the ${title} role${convoState.department ? ' in ' + convoState.department : ''}. I'm your AI interviewer today. I'll be evaluating your technical skills, problem-solving ability, and how you approach challenges. This will be a natural voice conversation, just like speaking with a real interviewer. I'll ask one question at a time and may follow up based on your responses. Let's start simple. Tell me about yourself, your background, and what brings you to this role.`;
}

async function processUserAnswer(text) {
    const state = convoState;
    state.questionCount++;

    const analysis = analyzeAnswer(text, state.currentTopic);

    state.history.push({
        role: 'candidate', phase: state.phase, topic: state.currentTopic,
        answer: text, analysis, timestamp: Date.now()
    });

    if (analysis.category) {
        if (!state.overallScores[analysis.category]) state.overallScores[analysis.category] = [];
        state.overallScores[analysis.category].push(analysis.score);
    }
    if (state.currentTopic?.skill) {
        if (!state.skillScores[state.currentTopic.skill]) state.skillScores[state.currentTopic.skill] = [];
        state.skillScores[state.currentTopic.skill].push(analysis.score);
        if (analysis.score >= 65) state.answeredSkills.add(state.currentTopic.skill);
    }

    if (analysis.score >= 75) state.strongAreas.push(state.currentTopic?.label || state.phase);
    if (analysis.score < 40) state.weakAreas.push(state.currentTopic?.label || state.phase);

    const nextAction = decideNextAction(state, analysis, text);

    // Brief pause before AI speaks
    await sleep(600);

    // Speak the next question
    await aiSpeak(nextAction.message, nextAction.phase, nextAction.meta);

    state.phase = nextAction.phase;
    state.currentTopic = nextAction.topic || null;
    if (nextAction.followUpDepth !== undefined) state.followUpDepth = nextAction.followUpDepth;

    document.getElementById('qTracker').textContent = `Q ${state.questionCount} / ~${state.maxQuestions}`;
    document.getElementById('qTrackerOverlay').textContent = `Q ${state.questionCount} / ~${state.maxQuestions}`;
}

function analyzeAnswer(text, topic) {
    const words = text.trim().split(/\s+/).length;
    const lower = text.toLowerCase();

    let score = 0;
    let category = 'behavioral';
    const flags = [];

    if (words < 5) { score = 5; flags.push('extremely_brief'); }
    else if (words < 15) { score = 20; flags.push('too_brief'); }
    else if (words < 30) { score = 40; }
    else if (words < 60) { score = 60; }
    else if (words < 120) { score = 75; }
    else if (words < 250) { score = 85; }
    else { score = 90; }

    const star = {
        situation: /when i|at my|in my (previous|last|current)|there was|we had|the (project|team|company)|i was working/i.test(text),
        task: /i (needed|had) to|my (role|responsibility|task|goal)|was responsible|was asked to|the challenge/i.test(text),
        action: /i (did|implemented|built|created|designed|led|decided|proposed|developed|migrated|optimized|wrote|refactored)/i.test(text),
        result: /result(ed)?|outcome|improv(ed|ement)|reduc(ed|tion)|increas(ed)|achiev(ed)|deliver(ed)|saved|faster|better|success|impact/i.test(text)
    };
    const starCount = Object.values(star).filter(Boolean).length;
    score = Math.min(100, score + starCount * 4);
    if (starCount >= 3) flags.push('good_star');

    const techSignals = [        /architecture|design pattern|trade.?off|scalab|latency|throughput/i,        /database|api|microservice|serverless|docker|kubernetes|ci.?cd/i,        /algorithm|complexity|big.?o|hash|tree|graph|dynamic programming/i,        /react|angular|vue|node|python|java|typescript|golang|rust|sql/i,        /aws|gcp|azure|redis|kafka|elasticsearch|mongodb|postgres/i,        /testing|unit test|integration|tdd|bdd|coverage/i,        /security|authentication|authorization|encryption|oauth|jwt/i,        /performance|caching|cdn|load balanc|horizontal scal/i,    ];
    const techHits = techSignals.filter(r => r.test(text)).length;
    score = Math.min(100, score + techHits * 3);
    if (techHits >= 3) { flags.push('high_technical_depth'); category = 'technical'; }
    else if (techHits >= 1) { category = 'technical'; }

    const specificSignals = /\d+%|\d+ (users|requests|million|thousand|team members|developers|months|weeks|days|hours)|reduced by|improved by|from \d+ to \d+/i;
    if (specificSignals.test(text)) { score = Math.min(100, score + 8); flags.push('quantified_impact'); }

    if (topic?.skill) {
        const skillLower = topic.skill.toLowerCase();
        if (lower.includes(skillLower)) {
            score = Math.min(100, score + 5); flags.push('skill_mentioned');
        } else {
            score = Math.max(0, score - 5); flags.push('skill_not_mentioned');
        }
    }

    const fillers = (lower.match(/\b(um|uh|like|basically|actually|you know|i mean|so yeah)\b/g) || []).length;
    if (fillers > 3) { score = Math.max(0, score - 5); flags.push('many_fillers'); }

    if (/i believe|i'm confident|in my experience|i've successfully/i.test(text)) {
        score = Math.min(100, score + 3); flags.push('confident');
    }
    if (/i'm not sure|i don't know|i think maybe|i guess/i.test(text)) {
        score = Math.max(0, score - 5); flags.push('uncertain');
    }

    return { score: Math.round(score), words, starCount, techHits, flags, category };
}

function decideNextAction(state, analysis, answerText) {
    const { phase, questionCount, skills, currentSkillIdx, followUpDepth, maxFollowUpDepth, level, jobTitle } = state;

    if (questionCount >= state.maxQuestions || seconds <= 60) {
        return {
            phase: 'closing',
            message: buildClosingMessage(state),
            topic: null,
            meta: { isClosing: true }
        };
    }

    const needsFollowUp = (
        analysis.score < 45 ||
        analysis.flags.includes('too_brief') ||
        analysis.flags.includes('extremely_brief') ||
        (analysis.flags.includes('skill_not_mentioned') && followUpDepth < maxFollowUpDepth) ||
        (analysis.flags.includes('uncertain') && followUpDepth < 1)
    );

    const canDeepDive = (
        analysis.score >= 65 &&
        analysis.flags.includes('high_technical_depth') &&
        followUpDepth < maxFollowUpDepth
    );

    if (needsFollowUp && followUpDepth < maxFollowUpDepth) {
        return {
            phase: phase,
            message: buildFollowUp(state, analysis, answerText),
            topic: state.currentTopic,
            followUpDepth: followUpDepth + 1,
            meta: { isFollowUp: true, reason: analysis.flags }
        };
    }

    if (canDeepDive && followUpDepth < maxFollowUpDepth) {
        return {
            phase: 'deep_dive',
            message: buildDeepDive(state, analysis, answerText),
            topic: state.currentTopic,
            followUpDepth: followUpDepth + 1,
            meta: { isDeepDive: true }
        };
    }

    switch (phase) {
        case 'intro':
            return buildSkillQuestion(state, 0);
        case 'skill_probe':
        case 'deep_dive':
            const nextSkillIdx = currentSkillIdx + 1;
            if (nextSkillIdx < skills.length && nextSkillIdx < 3) {
                return buildSkillQuestion(state, nextSkillIdx);
            }
            return buildScenarioQuestion(state);
        case 'scenario':
            return buildBehavioralQuestion(state);
        case 'behavioral':
            const uncoveredSkills = skills.filter(s => !state.answeredSkills.has(s));
            if (uncoveredSkills.length > 0 && questionCount < state.maxQuestions - 2) {
                return buildSkillQuestion(state, skills.indexOf(uncoveredSkills[0]));
            }
            return {
                phase: 'closing_q',
                message: buildClosingQuestion(state),
                topic: { label: 'Closing', type: 'closing' },
                followUpDepth: 0, meta: {}
            };
        case 'closing_q':
            return {
                phase: 'closing',
                message: buildClosingMessage(state),
                topic: null,
                meta: { isClosing: true }
            };
        default:
            return buildSkillQuestion(state, 0);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUESTION BUILDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildSkillQuestion(state, skillIdx) {
    const skill = state.skills[skillIdx] || state.skills[0] || 'your core technology';
    state.currentSkillIdx = skillIdx;

    const transitions = [        `Great, thanks for sharing.`,        `I appreciate the detail.`,        `That's helpful context.`,
        `Interesting.`,
        `Thanks for walking me through that.`,
        `Got it.`
    ];
    const transition = state.questionCount > 0 ? transitions[Math.floor(Math.random() * transitions.length)] + ' ' : '';

    let question = '';
    switch (state.level) {
        case 'fresher':
            const fresherQs = [
                `${transition}Let's talk about ${skill}. What's your understanding of it, and have you built anything with it, even in coursework or personal projects?`,
                `${transition}Now I'd like to explore your knowledge of ${skill}. Can you explain what it is, why it's used, and walk me through any hands-on experience you have?`,
                `${transition}Moving to ${skill}. Can you describe a project or assignment where you used it? What did you build and what challenges did you face?`
            ];
            question = fresherQs[Math.floor(Math.random() * fresherQs.length)];
            break;
        case 'junior':
            const juniorQs = [
                `${transition}Let's dive into ${skill}. Tell me about a real project where you used ${skill}. What was the problem, and how did you solve it?`,                `${transition}I'd like to understand your ${skill} experience better. Can you walk me through a specific feature or module you built with it? What design decisions did you make?`,
            ];
            question = juniorQs[Math.floor(Math.random() * juniorQs.length)];
            break;
        case 'mid':
            const midQs = [
                `${transition}Let's go deeper on ${skill}. Tell me about the most complex problem you've solved using ${skill}. Walk me through the architecture, the trade-offs you considered, and the outcome.`,
                `${transition}For a ${state.jobTitle} at this level, ${skill} is critical. Can you describe a production system you built or significantly improved using ${skill}? I'm interested in scale, challenges, and your specific decisions.`,            ];
            question = midQs[Math.floor(Math.random() * midQs.length)];
            break;
        case 'senior':
        case 'lead':
            const seniorQs = [                `${transition}As a senior professional, I'd like to hear about your architectural experience with ${skill}. How have you used it at scale? What patterns do you follow, and what anti-patterns have you seen teams fall into?`,
                `${transition}Let's discuss ${skill} at a systems level. If you were designing a high-traffic system today using ${skill}, walk me through your architecture choices and how you'd handle failures.`,
                `${transition}In your experience leading with ${skill}, how do you make technology decisions for your team? Tell me about a time you chose ${skill} over an alternative, or chose not to use it.`
            ];
            question = seniorQs[Math.floor(Math.random() * seniorQs.length)];
            break;
    }

    return {
        phase: 'skill_probe', message: question,
        topic: { skill, label: skill, type: 'skill' },
        followUpDepth: 0, meta: { skill }
    };
}

function buildFollowUp(state, analysis, answer) {
    const topic = state.currentTopic;
    const flags = analysis.flags;

    if (flags.includes('extremely_brief') || flags.includes('too_brief')) {
        const probes = [
            `I'd love to hear more. Could you elaborate with a concrete example? A project, a task, or a problem you actually worked on. What happened, what did you do, and what was the result?`,            `That's quite brief. Can you walk me through a specific scenario? Even a small project counts. What was the context, your approach, and what did you learn?`,
            `I need a bit more detail. Think of one real example from your experience and describe it step by step. The situation, what you did, and the outcome.`
        ];
        return probes[Math.floor(Math.random() * probes.length)];
    }

    if (flags.includes('skill_not_mentioned') && topic?.skill) {
        return `You didn't specifically mention ${topic.skill} in your answer. How comfortable are you with ${topic.skill} specifically? Can you give me a direct example of using it?`;    }    if (flags.includes('uncertain')) {        return `It sounds like you might not be very sure about this area. That's okay. Can you tell me what you do know about it, or describe the closest experience you've had?`;    }    if (analysis.starCount < 2) {        return `Good start. Can you help me understand the impact of what you did? What measurable results came from your work? Any numbers, improvements, or outcomes you can share?`;    }    return `Interesting. Could you elaborate a bit more on the technical specifics? What were the key decisions you made, and why?`;}function buildDeepDive(state, analysis, answer) {    const deepDives = [        `That's impressive work. Let me probe deeper. What were the biggest technical challenges you faced? How did you debug or resolve them?`,
        `Great answer. If you had to redo this project from scratch today, what would you do differently? Any architectural changes?`,
        `You mentioned solid technical work. How did you ensure quality and reliability? What testing strategies did you use?`,
        `I'm curious about the trade-offs. Every technical decision has pros and cons. What alternatives did you consider, and why did you go with this approach?`,        `Solid experience. How did this work perform at scale? Were there any performance bottlenecks, and how did you address them?`,    ];
    return deepDives[Math.floor(Math.random() * deepDives.length)];
}

function buildScenarioQuestion(state) {
    const title = state.jobTitle;
    const scenarios = {
        fresher: [
            `Now let's do a scenario. Imagine it's your first week as a ${title}. Your manager assigns you a task using a technology you've never worked with, and the deadline is in 3 days. How would you approach this?`,
            `Here's a situation. You're working on a feature and realize the approach your senior suggested won't work well. But they're quite experienced. What do you do?`
        ],
        junior: [            `Scenario time. You've deployed a feature to production and users are reporting intermittent errors that you can't reproduce locally. Walk me through your debugging process from start to finish.`,            `Imagine you're working on a tight deadline and you find a critical bug in a teammate's code during review. Fixing it properly would delay the release by 2 days. What's your call?`
        ],
        mid: [
            `Let's do a design scenario. You need to build a real-time notification system that handles 100 thousand concurrent users. Walk me through your architecture, what technologies, what patterns, and how you handle failures.`,            `You're leading a feature that requires coordination across 3 teams. Two teams disagree on the API contract. How do you drive alignment and keep the project on track?`
        ],
        senior: [
            `Strategic scenario. Your company's main product has accumulated significant technical debt. Performance is degrading and the team's velocity has dropped 40 percent. Leadership wants new features but the codebase is fragile. How do you make the case for and execute a technical debt reduction initiative?`,
            `You're architecting a system that needs to handle 10x traffic growth over the next year with 99.99 percent uptime. Current architecture is monolithic. Walk me through your migration strategy.`        ],
        lead: [            `As a tech lead, your team of 8 is struggling with quality. Bugs in production have increased 3x over the quarter. Team morale is dipping. What's your 90-day plan to turn this around?`,
            `You need to choose between building a critical component in-house, which gives you full control but takes 6 months, or using a third-party service that ships in 2 weeks but has vendor lock-in risk. Walk me through your decision framework.`
        ]
    };

    const levelScenarios = scenarios[state.level] || scenarios.mid;
    const question = levelScenarios[Math.floor(Math.random() * levelScenarios.length)];

    return {
        phase: 'scenario',
        message: `Thanks for your technical insights. ${question}`,
        topic: { label: 'Problem Solving', type: 'scenario' },
        followUpDepth: 0, meta: {}
    };
}

function buildBehavioralQuestion(state) {
    const questions = [
        `Good problem-solving approach. Now a people question. Tell me about a time you received critical feedback on your work. How did you handle it, and what changed as a result?`,
        `Let's talk about teamwork. Describe a situation where you had a disagreement with a colleague about a technical approach. How did you resolve it?`,        `Almost there. What's something you've failed at in your career? Not a humble brag, a real failure. What happened, and what did you learn from it?`,        `Quick one on growth. What's a technology or concept you recently learned outside of your day job? Why did you pick it up, and have you applied it?`
    ];

    return {
        phase: 'behavioral',
        message: questions[Math.floor(Math.random() * questions.length)],
        topic: { label: 'Behavioral', type: 'behavioral' },
        followUpDepth: 0, meta: {}
    };
}

function buildClosingQuestion(state) {
    return {
        phase: 'closing_q',
        message: `We're coming to the end of our interview. Before we wrap up, do you have any questions about the role or the team? Also, is there anything about your experience that we didn't cover that you'd like to highlight?`,        topic: { label: 'Closing', type: 'closing' },        followUpDepth: 0, meta: {}    };}function buildClosingMessage(state) {    const name = user.full_name?.split(' ')[0] || 'there';
    const strong = state.strongAreas.length ? state.strongAreas.slice(0,3).join(', ') : 'multiple areas';
    const skillsCovered = Object.keys(state.skillScores).join(', ') || 'core skills';

    return `Thank you so much, ${name}! That brings us to the end of our interview. We covered ${skillsCovered}, problem-solving, and behavioral questions today. I was particularly impressed by your responses on ${strong}. The hiring team will review your full interview transcript, scores, and proctoring report. You should hear back within a few business days. Best of luck!`;
}

function calculateOverallScore(state) {
    const all = [...(state.overallScores.technical || []), ...(state.overallScores.behavioral || []), ...(state.overallScores.problem_solving || []), ...(state.overallScores.communication || [])];
    if (!all.length) return 0;
    return Math.round(all.reduce((a,b) => a+b, 0) / all.length);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROCTORING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startProctoring() {
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            trust = Math.max(0, trust - 8); updateTrust();
            addProcLog('danger', 'Tab switch detected');
            logProc('tab_switch', 'high');
            // Flash warning via topbar
            const tb = document.querySelector('.topbar');
            tb.style.background = 'rgba(239,68,68,.15)';
            setTimeout(() => tb.style.background = 'var(--bg-card)', 3000);
        }
    });
    window.addEventListener('blur', () => { trust=Math.max(0,trust-2); updateTrust(); addProcLog('warn','Window blur'); });
    document.addEventListener('copy', e => { e.preventDefault(); trust=Math.max(0,trust-4); updateTrust(); addProcLog('warn','Copy blocked'); logProc('copy_paste','medium'); });
    document.addEventListener('paste', e => { e.preventDefault(); trust=Math.max(0,trust-4); updateTrust(); addProcLog('warn','Paste blocked'); logProc('copy_paste','medium'); });
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if (e.key==='F12'||(e.ctrlKey&&e.shiftKey&&['i','j','c'].includes(e.key.toLowerCase()))) {
            e.preventDefault(); trust=Math.max(0,trust-10); updateTrust();
            addProcLog('danger','DevTools attempt'); logProc('devtools','critical');
        }
    });
    setInterval(() => {
        if (!camOn) return;
        const r = Math.random();
        if (r < .03) { trust=Math.max(0,trust-8); updateTrust(); addProcLog('danger','Face not detected'); logProc('face_not_detected','high'); }
        else if (r < .06) { trust=Math.max(0,trust-3); updateTrust(); addProcLog('warn','Eye gaze deviation'); logProc('eye_deviation','medium'); }
    }, 10000);
    addProcLog('info','Proctoring active');
}

function updateTrust() {
    document.getElementById('trustVal').textContent = trust;
    const circ = document.getElementById('trustCircle');
    const offset = 75.4 * (1 - trust/100);
    circ.setAttribute('stroke-dashoffset', offset);
    circ.setAttribute('stroke', trust>=70?'var(--success)':trust>=40?'var(--warning)':'var(--danger)');
}

function addProcLog(level, msg) {
    const time = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    procLogs.unshift({ time, level, msg });
}

function logProc(type, sev) {
    if (!interviewMeta?.id) return;
    api('/api/proctor/log',{method:'POST',body:JSON.stringify({interview_id:interviewMeta.id,candidate_id:user.id,event_type:type,severity:sev,confidence_score:trust})}).catch(()=>{});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCam() {
    camOn=!camOn;
    mediaStream.getVideoTracks().forEach(t=>t.enabled=camOn);
    document.getElementById('vcCam').classList.toggle('off',!camOn);
    if(!camOn) { trust=Math.max(0,trust-10); updateTrust(); addProcLog('danger','Camera OFF'); logProc('camera_off','high'); }
}

function toggleMic() {
    micOn=!micOn;
    mediaStream.getAudioTracks().forEach(t=>t.enabled=micOn);
    const btn = document.getElementById('vcMic');
    btn.classList.toggle('off',!micOn);
    btn.classList.toggle('active-mic', micOn && isListening);

    if (!micOn) {
        stopListening();
        trust=Math.max(0,trust-10); updateTrust();
        addProcLog('danger','Microphone OFF'); logProc('mic_off','high');
    } else if (!isSpeaking) {
        startListening();
    }
}

function goFullscreen() { try{document.documentElement.requestFullscreen()}catch(e){} }

// Timer
function tick() {
    seconds--;
    if (seconds<=0) { endSession(); return; }
    const m=Math.floor(seconds/60), s=seconds%60;
    document.getElementById('timerText').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (seconds<=120) document.getElementById('timerPill').classList.add('warn');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// END SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function endSession() {
    clearInterval(timerInt);
    stopListening();
    speechSynth.cancel();

    const score = calculateOverallScore(convoState);

    if (interviewMeta?.id) {
        await api(`/api/interviews/${interviewMeta.id}/end`, { method:'POST', body:JSON.stringify({
            overall_score: score,
            feedback: {
                total_questions: convoState.questionCount,
                skill_scores: convoState.skillScores,
                overall_scores: convoState.overallScores,
                strong_areas: convoState.strongAreas,
                weak_areas: convoState.weakAreas,
                trust_score: trust,
                history: convoState.history,
                skills_tested: Object.keys(convoState.skillScores),
                job_title: convoState.jobTitle,
                level: convoState.level
            }
        })}).catch(()=>{});
    }

    if (mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
    if (audioCtx) audioCtx.close().catch(()=>{});

    document.getElementById('interviewApp').innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:var(--bg-dark)">
            <div style="background:var(--bg-card);border-radius:24px;padding:50px;max-width:480px;text-align:center;border:1px solid var(--border)">
                <div style="font-size:48px;margin-bottom:16px">${score>=60?'üéâ':'üìù'}</div>
                <h2 style="font-size:22px;margin-bottom:8px">Interview Complete!</h2>
                <p style="color:var(--text-dim);font-size:14px;margin-bottom:28px;line-height:1.6">Your voice interview has been recorded and will be reviewed by the hiring team.</p>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:28px">
                    <div style="background:var(--bg-surface);padding:16px;border-radius:12px">
                        <div style="font-size:28px;font-weight:900;color:${score>=70?'var(--success)':score>=40?'var(--warning)':'var(--danger)'}">${score}%</div>
                        <div style="font-size:11px;color:var(--text-muted)">Score</div>
                    </div>
                    <div style="background:var(--bg-surface);padding:16px;border-radius:12px">
                        <div style="font-size:28px;font-weight:900;color:${trust>=70?'var(--success)':'var(--danger)'}">${trust}%</div>
                        <div style="font-size:11px;color:var(--text-muted)">Trust</div>
                    </div>
                    <div style="background:var(--bg-surface);padding:16px;border-radius:12px">
                        <div style="font-size:28px;font-weight:900;color:var(--primary)">${convoState.questionCount}</div>
                        <div style="font-size:11px;color:var(--text-muted)">Questions</div>
                    </div>
                </div>
                ${Object.keys(convoState.skillScores).length ? `
                <div style="text-align:left;margin-bottom:20px">
                    <div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Skills Assessed</div>
                    ${Object.entries(convoState.skillScores).map(([skill,scores]) => {
                        const avg = Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
                        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <span style="min-width:80px;font-size:12px;color:var(--text-dim)">${skill}</span>
                            <div style="flex:1;height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="width:${avg}%;height:100%;background:${avg>=70?'var(--success)':avg>=40?'var(--warning)':'var(--danger)'};border-radius:3px"></div></div>
                            <span style="font-size:12px;font-weight:700;color:${avg>=70?'var(--success)':avg>=40?'var(--warning)':'var(--danger)'}; min-width:35px;text-align:right">${avg}%</span>
                        </div>`;
                    }).join('')}
                </div>` : ''}
                <a href="../dashboard/candidate.html" style="display:inline-flex;align-items:center;gap:6px;padding:12px 28px;background:var(--primary);color:#fff;border-radius:12px;text-decoration:none;font-weight:700;font-size:14px">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
init();
</script>
</body>
</html>
