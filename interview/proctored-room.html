<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview - SimpaticoHR</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-surface: #1a1a2e;
            --bg-input: #0f0f1a;
            --border: #2a2a3e;
            --primary: #6366f1;
            --primary-glow: rgba(99,102,241,.25);
            --accent: #22d3ee;
            --accent-glow: rgba(34,211,238,.15);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --text-dim: #64748b;
            --text-muted: #475569;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ‚ïê‚ïê‚ïê Layout ‚ïê‚ïê‚ïê */
        .app { display: flex; flex-direction: column; height: 100vh; }

        /* ‚ïê‚ïê‚ïê Top Bar ‚ïê‚ïê‚ïê */
        .topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background: var(--bg-card);
            border-bottom: 1px solid var(--border); height: 52px; flex-shrink: 0;
        }
        .tb-left { display: flex; align-items: center; gap: 12px; }
        .tb-logo { font-size: 15px; font-weight: 800; }
        .tb-logo span { color: #fcd34d; }
        .tb-badge {
            padding: 3px 10px; background: rgba(239,68,68,.15); color: #f87171;
            border-radius: 6px; font-size: 10px; font-weight: 700;
            letter-spacing: .5px; text-transform: uppercase;
            display: flex; align-items: center; gap: 4px;
        }
        .tb-badge .dot { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: .3; } }
        .tb-center { display: flex; align-items: center; gap: 20px; }
        .trust-pill {
            display: flex; align-items: center; gap: 8px;
            padding: 4px 12px; background: var(--bg-surface); border-radius: 20px;
            border: 1px solid var(--border);
        }
        .trust-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; }
        .trust-ring {
            width: 28px; height: 28px; border-radius: 50%; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .trust-ring svg { position: absolute; transform: rotate(-90deg); }
        .trust-ring .val { font-size: 9px; font-weight: 800; z-index: 1; }
        .timer-pill {
            padding: 5px 14px; background: var(--bg-surface); border-radius: 20px;
            border: 1px solid var(--border); font-size: 13px; font-weight: 700;
            font-variant-numeric: tabular-nums; display: flex; align-items: center; gap: 6px;
        }
        .timer-pill i { color: var(--danger); font-size: 11px; }
        .timer-pill.warn { color: var(--danger); border-color: rgba(239,68,68,.3); }
        .tb-right { display: flex; align-items: center; gap: 10px; }
        .tb-btn {
            padding: 6px 14px; border-radius: 8px; border: none; font-size: 12px;
            font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all .2s;
        }
        .btn-end { background: var(--danger); color: #fff; }
        .btn-end:hover { box-shadow: 0 0 20px rgba(239,68,68,.3); }

        /* ‚ïê‚ïê‚ïê Main Area ‚ïê‚ïê‚ïê */
        .main-area { flex: 1; display: flex; overflow: hidden; }

        /* ‚ïê‚ïê‚ïê Left: Video ‚ïê‚ïê‚ïê */
        .video-section {
            flex: 1; display: flex; flex-direction: column;
            padding: 16px; gap: 12px; min-width: 0;
        }
        .video-container {
            flex: 1; position: relative; background: #000;
            border-radius: 16px; overflow: hidden;
            border: 1px solid var(--border);
        }
        .video-container video { width: 100%; height: 100%; object-fit: cover; }
        .video-overlay-top {
            position: absolute; top: 0; left: 0; right: 0; padding: 12px 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,.7), transparent);
            display: flex; align-items: center; justify-content: space-between;
        }
        .vo-rec { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #f87171; font-weight: 600; }
        .vo-rec .rdot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: blink 1.5s infinite; }
        .vo-quality { font-size: 10px; color: var(--text-dim); padding: 3px 8px; background: rgba(0,0,0,.5); border-radius: 4px; }

        .self-cam {
            position: absolute; bottom: 14px; right: 14px;
            width: 140px; height: 105px; border-radius: 12px;
            overflow: hidden; border: 2px solid var(--border);
            background: var(--bg-surface);
        }
        .self-cam video { width: 100%; height: 100%; object-fit: cover; }

        .video-controls {
            display: flex; align-items: center; justify-content: center; gap: 10px; padding: 4px 0;
        }
        .vc-btn {
            width: 40px; height: 40px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--bg-surface); color: var(--text); cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 15px;
            transition: all .2s;
        }
        .vc-btn:hover { background: var(--border); }
        .vc-btn.off { background: rgba(239,68,68,.15); color: #f87171; border-color: rgba(239,68,68,.3); }
        .vc-btn.end { background: var(--danger); color: #fff; border-color: var(--danger); }

        /* ‚ïê‚ïê‚ïê Right: Conversation ‚ïê‚ïê‚ïê */
        .convo-section {
            width: 440px; display: flex; flex-direction: column;
            background: var(--bg-card); border-left: 1px solid var(--border);
        }

        /* ‚îÄ‚îÄ Convo Header ‚îÄ‚îÄ */
        .convo-header {
            padding: 14px 18px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px;
        }
        .ai-avatar {
            width: 38px; height: 38px; border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; flex-shrink: 0;
        }
        .ai-info h3 { font-size: 14px; font-weight: 700; }
        .ai-info p { font-size: 11px; color: var(--text-dim); }
        .convo-tabs {
            display: flex; margin-left: auto; gap: 2px;
            background: var(--bg-surface); border-radius: 8px; padding: 2px;
        }
        .convo-tab {
            padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; color: var(--text-dim); transition: all .2s; border: none;
            background: none; font-family: 'Inter', sans-serif;
        }
        .convo-tab.active { background: var(--primary); color: #fff; }

        /* ‚îÄ‚îÄ Chat Messages ‚îÄ‚îÄ */
        .convo-body { flex: 1; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        .convo-body::-webkit-scrollbar { width: 4px; }
        .convo-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .msg { margin-bottom: 16px; display: flex; gap: 10px; animation: fadeIn .3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

        .msg-ai { align-items: flex-start; }
        .msg-user { flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px; height: 32px; border-radius: 10px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; font-size: 13px;
        }
        .msg-ai .msg-avatar { background: linear-gradient(135deg, var(--primary), #a855f7); }
        .msg-user .msg-avatar { background: linear-gradient(135deg, #059669, #10b981); }

        .msg-bubble {
            max-width: 85%; border-radius: 14px; padding: 12px 16px;
            font-size: 13.5px; line-height: 1.7; position: relative;
        }
        .msg-ai .msg-bubble {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-top-left-radius: 4px;
        }
        .msg-user .msg-bubble {
            background: linear-gradient(135deg, rgba(99,102,241,.15), rgba(168,85,247,.1));
            border: 1px solid rgba(99,102,241,.2);
            border-top-right-radius: 4px;
        }

        .msg-meta {
            font-size: 10px; color: var(--text-muted); margin-top: 6px;
            display: flex; align-items: center; gap: 8px;
        }
        .msg-skill-tag {
            display: inline-block; padding: 1px 7px; background: rgba(34,211,238,.1);
            color: var(--accent); border-radius: 4px; font-size: 10px; font-weight: 600;
        }

        /* ‚îÄ‚îÄ Typing Indicator ‚îÄ‚îÄ */
        .typing-indicator {
            display: none; margin-bottom: 16px; align-items: flex-start; gap: 10px;
        }
        .typing-indicator.show { display: flex; }
        .typing-dots {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 14px 18px; display: flex; gap: 5px;
        }
        .typing-dots span {
            width: 7px; height: 7px; background: var(--text-muted); border-radius: 50%;
            animation: bounce .6s infinite alternate;
        }
        .typing-dots span:nth-child(2) { animation-delay: .15s; }
        .typing-dots span:nth-child(3) { animation-delay: .3s; }
        @keyframes bounce { to { opacity: .3; transform: translateY(-4px); } }

        /* ‚îÄ‚îÄ Score Inline ‚îÄ‚îÄ */
        .score-inline {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;
            margin-left: 6px;
        }
        .score-high { background: rgba(16,185,129,.15); color: #34d399; }
        .score-mid { background: rgba(245,158,11,.15); color: #fbbf24; }
        .score-low { background: rgba(239,68,68,.15); color: #f87171; }

        /* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ */
        .convo-input {
            padding: 14px 16px; border-top: 1px solid var(--border);
            background: var(--bg-card);
        }
        .input-mode-tabs {
            display: flex; gap: 6px; margin-bottom: 10px;
        }
        .imt {
            padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; border: 1px solid var(--border); background: none;
            color: var(--text-dim); font-family: 'Inter', sans-serif; transition: all .2s;
            display: flex; align-items: center; gap: 4px;
        }
        .imt.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .imt i { font-size: 12px; }

        .text-input-wrap {
            display: flex; gap: 8px; align-items: flex-end;
        }
        .text-input {
            flex: 1; padding: 10px 14px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 12px;
            color: var(--text); font-size: 13px; font-family: 'Inter', sans-serif;
            resize: none; min-height: 42px; max-height: 120px; outline: none;
            line-height: 1.5;
        }
        .text-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
        .text-input::placeholder { color: var(--text-muted); }
        .send-btn {
            width: 42px; height: 42px; border-radius: 12px; border: none;
            background: var(--primary); color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: all .2s; flex-shrink: 0;
        }
        .send-btn:hover { box-shadow: 0 0 20px var(--primary-glow); }
        .send-btn:disabled { opacity: .4; cursor: not-allowed; }

        /* Voice Input */
        .voice-input-area { display: none; text-align: center; padding: 10px 0; }
        .voice-input-area.active { display: block; }
        .voice-btn {
            width: 56px; height: 56px; border-radius: 50%; border: 2px solid var(--primary);
            background: var(--bg-surface); color: var(--primary); cursor: pointer;
            font-size: 22px; transition: all .3s; margin: 0 auto;
            display: flex; align-items: center; justify-content: center;
        }
        .voice-btn.recording {
            background: var(--danger); border-color: var(--danger); color: #fff;
            animation: pulse-ring 1.5s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239,68,68,.4); }
            70% { box-shadow: 0 0 0 15px rgba(239,68,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
        }
        .voice-status { font-size: 12px; color: var(--text-dim); margin-top: 8px; }
        .voice-transcript {
            margin-top: 8px; padding: 8px 12px; background: var(--bg-input);
            border-radius: 8px; font-size: 12px; color: var(--text);
            max-height: 60px; overflow-y: auto; display: none;
        }

        .input-hint { font-size: 10px; color: var(--text-muted); margin-top: 6px; text-align: center; }

        /* ‚ïê‚ïê‚ïê Proctoring Panel (hidden by default) ‚ïê‚ïê‚ïê */
        .proctor-panel { display: none; flex: 1; overflow-y: auto; padding: 16px; }
        .proctor-panel.active { display: block; }
        .pp-item {
            padding: 8px 0; border-bottom: 1px solid rgba(42,42,62,.5);
            display: flex; gap: 8px; font-size: 12px;
        }
        .pp-time { color: var(--text-muted); min-width: 60px; }
        .pp-msg { color: var(--text-dim); }
        .pp-msg.warn { color: var(--warning); }
        .pp-msg.danger { color: var(--danger); }

        /* ‚ïê‚ïê‚ïê Setup Overlay ‚ïê‚ïê‚ïê */
        .setup-overlay {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 500;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .setup-card {
            background: var(--bg-card); border-radius: 24px; padding: 40px;
            max-width: 520px; width: 100%; text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 0 80px rgba(99,102,241,.1);
        }
        .setup-card h1 { font-size: 26px; font-weight: 900; margin-bottom: 4px; }
        .setup-card h1 span { color: #fcd34d; }
        .setup-sub { color: var(--text-dim); font-size: 13px; margin-bottom: 24px; }

        .setup-job-card {
            background: var(--bg-surface); border-radius: 14px; padding: 16px;
            text-align: left; margin-bottom: 20px; border: 1px solid var(--border);
        }
        .sjc-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
        .sjc-meta { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-dim); margin-bottom: 8px; }
        .sjc-meta span { display: flex; align-items: center; gap: 4px; }
        .sjc-skills { display: flex; gap: 5px; flex-wrap: wrap; }
        .sjc-skill {
            padding: 3px 9px; background: rgba(99,102,241,.1); color: var(--primary);
            border-radius: 6px; font-size: 11px; font-weight: 500;
        }

        .setup-cam { width: 280px; height: 210px; border-radius: 14px; overflow: hidden; background: #000; margin: 0 auto 20px; border: 2px solid var(--border); position: relative; }
        .setup-cam video { width: 100%; height: 100%; object-fit: cover; }
        .face-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            width: 120px; height: 150px; border: 2px dashed rgba(99,102,241,.4);
            border-radius: 50%; opacity: .5;
        }

        .checks { max-width: 300px; margin: 0 auto 20px; }
        .chk {
            display: flex; align-items: center; gap: 10px; padding: 7px 0; font-size: 13px;
        }
        .chk-icon {
            width: 24px; height: 24px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0;
        }
        .chk-pass { background: var(--success); color: #fff; }
        .chk-fail { background: var(--danger); color: #fff; }
        .chk-wait { background: var(--bg-surface); color: var(--text-muted); border: 1px solid var(--border); }
        .chk-spin { background: var(--bg-surface); color: var(--primary); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: .4; } }

        .setup-note {
            padding: 12px 16px; background: rgba(245,158,11,.08);
            border: 1px solid rgba(245,158,11,.2); border-radius: 10px;
            font-size: 12px; color: #fcd34d; line-height: 1.6; margin-bottom: 20px;
        }
        .btn-begin {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), #a855f7);
            color: #fff; border: none; border-radius: 14px; font-size: 16px;
            font-weight: 800; cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all .3s;
        }
        .btn-begin:hover { box-shadow: 0 8px 30px var(--primary-glow); transform: translateY(-1px); }
        .btn-begin:disabled { opacity: .4; cursor: not-allowed; transform: none; }

        /* ‚ïê‚ïê‚ïê Responsive ‚ïê‚ïê‚ïê */
        @media(max-width: 900px) {
            .main-area { flex-direction: column; }
            .convo-section { width: 100%; max-height: 50vh; }
            .self-cam { width: 100px; height: 75px; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SETUP SCREEN                                   -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="setup-overlay" id="setupOverlay">
    <div class="setup-card">
        <h1>Simpatico<span>HR</span></h1>
        <p class="setup-sub">AI-Powered Technical Interview</p>

        <div class="setup-job-card" id="setupJobCard">
            <div class="sjc-title" id="sjcTitle">Loading position...</div>
            <div class="sjc-meta">
                <span id="sjcDept"><i class="fas fa-building"></i> ‚Äî</span>
                <span id="sjcExp"><i class="fas fa-briefcase"></i> ‚Äî</span>
                <span id="sjcLoc"><i class="fas fa-map-marker-alt"></i> ‚Äî</span>
            </div>
            <div class="sjc-skills" id="sjcSkills"></div>
        </div>

        <div class="setup-cam">
            <video id="setupVid" autoplay muted playsinline></video>
            <div class="face-guide"></div>
        </div>

        <div class="checks">
            <div class="chk"><div class="chk-icon chk-wait" id="c1"><i class="fas fa-video"></i></div> Camera</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c2"><i class="fas fa-microphone"></i></div> Microphone</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c3"><i class="fas fa-user-check"></i></div> Face Detection</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c4"><i class="fas fa-volume-up"></i></div> Speaker / Audio</div>
            <div class="chk"><div class="chk-icon chk-wait" id="c5"><i class="fas fa-wifi"></i></div> Connection</div>
        </div>

        <div class="setup-note">
            <i class="fas fa-shield-alt" style="margin-right:4px"></i>
            <strong>This is a proctored AI interview.</strong> Your camera, microphone, screen, and browser activity will be monitored. Do not switch tabs, use external tools, or have other people present.
        </div>

        <button class="btn-begin" id="btnBegin" disabled onclick="startSession()">
            <i class="fas fa-play-circle" style="margin-right:6px"></i> Begin Interview
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- INTERVIEW ROOM                                 -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app" id="interviewApp" style="display:none">

    <!-- Top Bar -->
    <div class="topbar">
        <div class="tb-left">
            <div class="tb-logo">Simpatico<span>HR</span></div>
            <div class="tb-badge"><div class="dot"></div> PROCTORED</div>
        </div>
        <div class="tb-center">
            <div class="trust-pill">
                <span class="trust-label">Trust</span>
                <div class="trust-ring">
                    <svg width="28" height="28"><circle cx="14" cy="14" r="12" fill="none" stroke="var(--border)" stroke-width="2.5"/><circle id="trustCircle" cx="14" cy="14" r="12" fill="none" stroke="var(--success)" stroke-width="2.5" stroke-dasharray="75.4" stroke-dashoffset="0" stroke-linecap="round"/></svg>
                    <span class="val" id="trustVal">100</span>
                </div>
            </div>
            <div class="timer-pill" id="timerPill">
                <i class="fas fa-clock"></i> <span id="timerText">45:00</span>
            </div>
        </div>
        <div class="tb-right">
            <span style="font-size:11px;color:var(--text-muted)" id="qTracker">Q 0 / ‚Äî</span>
            <button class="tb-btn btn-end" onclick="endSession()"><i class="fas fa-phone-slash" style="margin-right:3px"></i> End</button>
        </div>
    </div>

    <!-- Main -->
    <div class="main-area">
        <!-- Video -->
        <div class="video-section">
            <div class="video-container">
                <video id="mainVid" autoplay muted playsinline></video>
                <div class="video-overlay-top">
                    <div class="vo-rec"><div class="rdot"></div> REC</div>
                    <div class="vo-quality" id="voQuality">HD</div>
                </div>
                <div class="self-cam"><video id="selfVid" autoplay muted playsinline></video></div>
            </div>
            <div class="video-controls">
                <button class="vc-btn" id="vcCam" onclick="toggleCam()"><i class="fas fa-video"></i></button>
                <button class="vc-btn" id="vcMic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                <button class="vc-btn" onclick="goFullscreen()"><i class="fas fa-expand"></i></button>
                <button class="vc-btn end" onclick="endSession()"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>

        <!-- Conversation -->
        <div class="convo-section">
            <div class="convo-header">
                <div class="ai-avatar">ü§ñ</div>
                <div class="ai-info">
                    <h3>AI Interviewer</h3>
                    <p id="aiSubtitle">Evaluating for <span id="aiJobTitle">‚Äî</span></p>
                </div>
                <div class="convo-tabs">
                    <button class="convo-tab active" onclick="showPanel('chat')">Chat</button>
                    <button class="convo-tab" onclick="showPanel('proctor')">Monitor</button>
                </div>
            </div>

            <!-- Chat Body -->
            <div class="convo-body" id="chatBody">
                <!-- Messages rendered here -->
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="msg-avatar" style="background:linear-gradient(135deg,var(--primary),#a855f7)">ü§ñ</div>
                <div class="typing-dots"><span></span><span></span><span></span></div>
            </div>

            <!-- Proctor Panel -->
            <div class="proctor-panel" id="proctorPanel"></div>

            <!-- Input -->
            <div class="convo-input">
                <div class="input-mode-tabs">
                    <button class="imt active" id="imtText" onclick="setInputMode('text')"><i class="fas fa-keyboard"></i> Type</button>
                    <button class="imt" id="imtVoice" onclick="setInputMode('voice')"><i class="fas fa-microphone"></i> Speak</button>
                </div>

                <!-- Text Mode -->
                <div class="text-input-wrap" id="textInputArea">
                    <textarea class="text-input" id="userInput" rows="1" placeholder="Type your answer..." onkeydown="handleInputKey(event)" oninput="autoResize(this)"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendUserMessage()" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

                <!-- Voice Mode -->
                <div class="voice-input-area" id="voiceInputArea">
                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div class="voice-status" id="voiceStatus">Click to start speaking</div>
                    <div class="voice-transcript" id="voiceTranscript"></div>
                </div>

                <div class="input-hint" id="inputHint">Press Enter to send ¬∑ Shift+Enter for new line</div>
            </div>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API = 'https://evalis-ai.simpaticohrconsultancy.workers.dev';
const token = localStorage.getItem('simpatico_token');
const user = JSON.parse(localStorage.getItem('simpatico_user') || '{}');
const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get('room');

if (!token || !user.id) { alert('Please login first'); window.location.href='../auth/login.html'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mediaStream = null;
let interviewMeta = null; // interview record
let job = null; // job details
let trust = 100;
let seconds = 45 * 60;
let timerInt = null;
let camOn = true, micOn = true;
let recognition = null; // SpeechRecognition
let isRecording = false;
let inputMode = 'text'; // 'text' | 'voice'

// ‚îÄ‚îÄ Conversation State (the brain) ‚îÄ‚îÄ
let convoState = {
    phase: 'intro', // intro | skill_probe | scenario | deep_dive | culture | closing
    questionCount: 0,
    maxQuestions: 12,
    currentSkillIdx: 0,
    skills: [],
    skillScores: {},
    overallScores: { technical: [], behavioral: [], problem_solving: [], communication: [] },
    history: [], // full Q&A history
    currentTopic: null,
    followUpDepth: 0,
    maxFollowUpDepth: 2,
    candidateExperience: 0,
    level: 'mid', // fresher | junior | mid | senior | lead
    jobTitle: '',
    department: '',
    answeredSkills: new Set(),
    weakAreas: [],
    strongAreas: [],
};
let procLogs = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(path, opts = {}) {
    return fetch(`${API}${path}`, {
        ...opts,
        headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}`, ...opts.headers }
    }).then(r => r.json()).catch(e => ({ error: e.message }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT ‚Äî Load interview + job data
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
    try {
        const interviews = await api('/api/interviews');
        interviewMeta = (interviews || []).find(i => i.room_id === roomId);
        if (interviewMeta) {
            seconds = (interviewMeta.duration_minutes || 45) * 60;
            if (interviewMeta.job_id) {
                const jRes = await api(`/api/jobs/${interviewMeta.job_id}`);
                if (jRes && !jRes.error) job = jRes;
            }
            if (!job && interviewMeta.job) job = interviewMeta.job;
        }
    } catch(e) { console.warn(e); }

    // Populate setup card
    if (job) {
        document.getElementById('sjcTitle').textContent = job.title || 'Interview';
        document.getElementById('sjcDept').innerHTML = `<i class="fas fa-building"></i> ${job.department || 'General'}`;
        document.getElementById('sjcExp').innerHTML = `<i class="fas fa-briefcase"></i> ${job.experience_min||0}‚Äì${job.experience_max||'?'} yrs`;
        document.getElementById('sjcLoc').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${job.location || 'Remote'}`;
        const skEl = document.getElementById('sjcSkills');
        (job.skills_required || []).forEach(s => { skEl.innerHTML += `<span class="sjc-skill">${s}</span>`; });

        // Init convo state from JD
        convoState.skills = [...(job.skills_required || [])];
        convoState.jobTitle = job.title || '';
        convoState.department = job.department || '';
        const avgExp = ((job.experience_min||0) + (job.experience_max||5)) / 2;
        if (avgExp <= 1) convoState.level = 'fresher';
        else if (avgExp <= 3) convoState.level = 'junior';
        else if (avgExp <= 7) convoState.level = 'senior';
        else convoState.level = 'lead';
        convoState.candidateExperience = avgExp;
    }

    await setupMedia();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEDIA SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function setupMedia() {
    setChk('c5','spin');
    try { await api('/api/auth/me'); setChk('c5','pass'); } catch(e) { setChk('c5','fail'); }

    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video:{ width:{ideal:1280},height:{ideal:720},facingMode:'user' }, audio:{ echoCancellation:true,noiseSuppression:true } });
        document.getElementById('setupVid').srcObject = mediaStream;
        setChk('c1','pass'); setChk('c2','pass');
        setChk('c3','spin'); setChk('c4','spin');
        setTimeout(() => { setChk('c3','pass'); setChk('c4','pass'); document.getElementById('btnBegin').disabled=false; }, 2000);
    } catch(err) {
        setChk('c1','fail'); setChk('c2','fail');
        alert('Camera and microphone are required.');
    }

    // Setup speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-IN';
        recognition.onresult = handleSpeechResult;
        recognition.onend = () => { if (isRecording) recognition.start(); };
    }
}

function setChk(id, state) {
    const el = document.getElementById(id);
    const m = { pass:'chk-pass', fail:'chk-fail', wait:'chk-wait', spin:'chk-spin' };
    const i = { pass:'fa-check', fail:'fa-times', wait:'fa-hourglass-half', spin:'fa-spinner' };
    el.className = `chk-icon ${m[state]}`;
    el.innerHTML = `<i class="fas ${i[state]}"></i>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startSession() {
    document.getElementById('setupOverlay').style.display = 'none';
    document.getElementById('interviewApp').style.display = 'flex';

    document.getElementById('mainVid').srcObject = mediaStream;
    document.getElementById('selfVid').srcObject = mediaStream;
    document.getElementById('aiJobTitle').textContent = convoState.jobTitle || 'Position';

    if (interviewMeta?.id) api(`/api/interviews/${interviewMeta.id}/start`, { method:'POST' }).catch(()=>{});

    timerInt = setInterval(tick, 1000);
    startProctoring();

    try { await document.documentElement.requestFullscreen(); } catch(e){}

    // ‚îÄ‚îÄ AI sends first message ‚îÄ‚îÄ
    await aiSay(buildIntroMessage(), 'intro');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONVERSATION ENGINE ‚Äî The core AI interviewer brain
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildIntroMessage() {
    const name = user.full_name?.split(' ')[0] || 'there';
    const title = convoState.jobTitle || 'this position';
    return `Hi ${name}! üëã Welcome to your interview for the **${title}** role${convoState.department ? ' in ' + convoState.department : ''}.\n\nI'm your AI interviewer today. I'll be evaluating your technical skills, problem-solving ability, and how you approach challenges.\n\nThis will be a conversational interview ‚Äî just like speaking with a real interviewer. I'll ask one question at a time and may follow up based on your responses.\n\nBefore we dive in, could you give me a brief introduction? **Tell me about yourself, your background, and what brings you to this role.**`;
}

async function processUserAnswer(text) {
    const state = convoState;
    state.questionCount++;

    // ‚îÄ‚îÄ Analyze the answer ‚îÄ‚îÄ
    const analysis = analyzeAnswer(text, state.currentTopic);

    // Store in history
    state.history.push({
        phase: state.phase,
        topic: state.currentTopic,
        question: getLastAIMessage(),
        answer: text,
        analysis: analysis,
        timestamp: Date.now()
    });

    // Update score tracking
    if (analysis.category) {
        if (!state.overallScores[analysis.category]) state.overallScores[analysis.category] = [];
        state.overallScores[analysis.category].push(analysis.score);
    }
    if (state.currentTopic?.skill) {
        if (!state.skillScores[state.currentTopic.skill]) state.skillScores[state.currentTopic.skill] = [];
        state.skillScores[state.currentTopic.skill].push(analysis.score);
        if (analysis.score >= 65) state.answeredSkills.add(state.currentTopic.skill);
    }

    // Track strong/weak areas
    if (analysis.score >= 75) state.strongAreas.push(state.currentTopic?.label || state.phase);
    if (analysis.score < 40) state.weakAreas.push(state.currentTopic?.label || state.phase);

    // ‚îÄ‚îÄ Decide next move ‚îÄ‚îÄ
    const nextAction = decideNextAction(state, analysis, text);

    // Show brief acknowledgment + score to interviewer (not visible to candidate in production)
    // Then ask next question
    await aiSay(nextAction.message, nextAction.phase, nextAction.meta);

    // Update state
    state.phase = nextAction.phase;
    state.currentTopic = nextAction.topic || null;
    if (nextAction.followUpDepth !== undefined) state.followUpDepth = nextAction.followUpDepth;

    // Update tracker
    document.getElementById('qTracker').textContent = `Q ${state.questionCount} / ~${state.maxQuestions}`;
}

function analyzeAnswer(text, topic) {
    const words = text.trim().split(/\s+/).length;
    const lower = text.toLowerCase();

    let score = 0;
    let category = 'behavioral';
    const flags = [];

    // ‚îÄ‚îÄ Length scoring ‚îÄ‚îÄ
    if (words < 5) { score = 5; flags.push('extremely_brief'); }
    else if (words < 15) { score = 20; flags.push('too_brief'); }
    else if (words < 30) { score = 40; }
    else if (words < 60) { score = 60; }
    else if (words < 120) { score = 75; }
    else if (words < 250) { score = 85; }
    else { score = 90; }

    // ‚îÄ‚îÄ STAR Method Detection ‚îÄ‚îÄ
    const star = {
        situation: /when i|at my|in my (previous|last|current)|there was|we had|the (project|team|company)|i was working/i.test(text),
        task: /i (needed|had) to|my (role|responsibility|task|goal)|was responsible|was asked to|the challenge/i.test(text),
        action: /i (did|implemented|built|created|designed|led|decided|proposed|developed|migrated|optimized|wrote|refactored)/i.test(text),
        result: /result(ed)?|outcome|improv(ed|ement)|reduc(ed|tion)|increas(ed)|achiev(ed)|deliver(ed)|saved|faster|better|success|impact/i.test(text)
    };
    const starCount = Object.values(star).filter(Boolean).length;
    score = Math.min(100, score + starCount * 4);
    if (starCount >= 3) flags.push('good_star');

    // ‚îÄ‚îÄ Technical Depth ‚îÄ‚îÄ
    const techSignals = [
        /architecture|design pattern|trade.?off|scalab|latency|throughput/i,
        /database|api|microservice|serverless|docker|kubernetes|ci.?cd/i,
        /algorithm|complexity|big.?o|hash|tree|graph|dynamic programming/i,
        /react|angular|vue|node|python|java|typescript|golang|rust|sql/i,
        /aws|gcp|azure|redis|kafka|elasticsearch|mongodb|postgres/i,
        /testing|unit test|integration|tdd|bdd|coverage/i,
        /security|authentication|authorization|encryption|oauth|jwt/i,
        /performance|caching|cdn|load balanc|horizontal scal/i,
    ];
    const techHits = techSignals.filter(r => r.test(text)).length;
    score = Math.min(100, score + techHits * 3);
    if (techHits >= 3) { flags.push('high_technical_depth'); category = 'technical'; }
    else if (techHits >= 1) { category = 'technical'; }

    // ‚îÄ‚îÄ Specificity ‚îÄ‚îÄ
    const specificSignals = /\d+%|\d+ (users|requests|million|thousand|team members|developers|months|weeks|days|hours)|reduced by|improved by|from \d+ to \d+/i;
    if (specificSignals.test(text)) { score = Math.min(100, score + 8); flags.push('quantified_impact'); }

    // ‚îÄ‚îÄ Skill mention check ‚îÄ‚îÄ
    if (topic?.skill) {
        const skillLower = topic.skill.toLowerCase();
        if (lower.includes(skillLower)) {
            score = Math.min(100, score + 5);
            flags.push('skill_mentioned');
        } else {
            score = Math.max(0, score - 5);
            flags.push('skill_not_mentioned');
        }
    }

    // ‚îÄ‚îÄ Communication quality ‚îÄ‚îÄ
    const fillers = (lower.match(/\b(um|uh|like|basically|actually|you know|i mean|so yeah)\b/g) || []).length;
    if (fillers > 3) { score = Math.max(0, score - 5); flags.push('many_fillers'); }

    // ‚îÄ‚îÄ Confidence signals ‚îÄ‚îÄ
    if (/i believe|i'm confident|in my experience|i've successfully/i.test(text)) {
        score = Math.min(100, score + 3);
        flags.push('confident');
    }
    if (/i'm not sure|i don't know|i think maybe|i guess/i.test(text)) {
        score = Math.max(0, score - 5);
        flags.push('uncertain');
    }

    return { score: Math.round(score), words, starCount, techHits, flags, category };
}

function decideNextAction(state, analysis, answerText) {
    const { phase, questionCount, skills, currentSkillIdx, followUpDepth, maxFollowUpDepth, level, jobTitle } = state;
    const lower = answerText.toLowerCase();

    // ‚îÄ‚îÄ Should we end? ‚îÄ‚îÄ
    if (questionCount >= state.maxQuestions || seconds <= 120) {
        return {
            phase: 'closing',
            message: buildClosingMessage(state),
            topic: null,
            meta: { isClosing: true }
        };
    }

    // ‚îÄ‚îÄ Follow-up logic ‚îÄ‚îÄ
    const needsFollowUp = (
        analysis.score < 45 ||
        analysis.flags.includes('too_brief') ||
        analysis.flags.includes('extremely_brief') ||
        (analysis.flags.includes('skill_not_mentioned') && followUpDepth < maxFollowUpDepth) ||
        (analysis.flags.includes('uncertain') && followUpDepth < 1)
    );

    const canDeepDive = (
        analysis.score >= 65 &&
        analysis.flags.includes('high_technical_depth') &&
        followUpDepth < maxFollowUpDepth
    );

    if (needsFollowUp && followUpDepth < maxFollowUpDepth) {
        return {
            phase: phase,
            message: buildFollowUp(state, analysis, answerText),
            topic: state.currentTopic,
            followUpDepth: followUpDepth + 1,
            meta: { isFollowUp: true, reason: analysis.flags }
        };
    }

    if (canDeepDive && followUpDepth < maxFollowUpDepth) {
        return {
            phase: 'deep_dive',
            message: buildDeepDive(state, analysis, answerText),
            topic: state.currentTopic,
            followUpDepth: followUpDepth + 1,
            meta: { isDeepDive: true }
        };
    }

    // ‚îÄ‚îÄ Phase transitions ‚îÄ‚îÄ
    // Reset follow-up depth for new topic
    switch (phase) {
        case 'intro':
            // After intro, start skill probing
            return buildSkillQuestion(state, 0);

        case 'skill_probe':
        case 'deep_dive':
            // Move to next skill or scenario
            const nextSkillIdx = currentSkillIdx + 1;
            if (nextSkillIdx < skills.length && nextSkillIdx < 4) {
                return buildSkillQuestion(state, nextSkillIdx);
            }
            // After skills, do scenario
            return buildScenarioQuestion(state);

        case 'scenario':
            // After scenario, do behavioral/culture
            return buildBehavioralQuestion(state);

        case 'behavioral':
            // Check if we need more skill coverage
            const uncoveredSkills = skills.filter(s => !state.answeredSkills.has(s));
            if (uncoveredSkills.length > 0 && questionCount < state.maxQuestions - 2) {
                return buildSkillQuestion(state, skills.indexOf(uncoveredSkills[0]));
            }
            // Closing question
            return {
                phase: 'closing_q',
                message: buildClosingQuestion(state),
                topic: { label: 'Closing', type: 'closing' },
                followUpDepth: 0,
                meta: {}
            };

        case 'closing_q':
            return {
                phase: 'closing',
                message: buildClosingMessage(state),
                topic: null,
                meta: { isClosing: true }
            };

        default:
            return buildSkillQuestion(state, 0);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUESTION BUILDERS ‚Äî Natural conversational style
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildSkillQuestion(state, skillIdx) {
    const skill = state.skills[skillIdx] || state.skills[0] || 'your core technology';
    state.currentSkillIdx = skillIdx;

    const transitions = [
        `Great, thanks for sharing that.`,
        `I appreciate the detail.`,
        `That's helpful context.`,
        `Interesting background.`,
        `Thanks for walking me through that.`,
        `Got it.`
    ];
    const transition = transitions[Math.floor(Math.random() * transitions.length)];

    let question = '';
    switch (state.level) {
        case 'fresher':
            const fresherQs = [
                `${transition} Let's talk about **${skill}**. What's your understanding of it, and have you built anything with it ‚Äî even in coursework or personal projects?`,
                `${transition} Now I'd like to explore your knowledge of **${skill}**. Can you explain what it is, why it's used, and walk me through any hands-on experience you have?`,
                `${transition} Moving to **${skill}** ‚Äî can you describe a project or assignment where you used it? What did you build and what challenges did you face?`
            ];
            question = fresherQs[Math.floor(Math.random() * fresherQs.length)];
            break;

        case 'junior':
            const juniorQs = [
                `${transition} Let's dive into **${skill}**. Tell me about a real project where you used ${skill} in a professional or significant personal project. What was the problem, and how did you solve it?`,
                `${transition} I'd like to understand your ${skill} experience better. Can you walk me through a specific feature or module you built with it? What design decisions did you make?`,
            ];
            question = juniorQs[Math.floor(Math.random() * juniorQs.length)];
            break;

        case 'mid':
            const midQs = [
                `${transition} Let's go deeper on **${skill}**. Tell me about the most complex problem you've solved using ${skill}. Walk me through the architecture, the trade-offs you considered, and the outcome.`,
                `${transition} For a ${state.jobTitle} at this level, ${skill} is critical. Can you describe a production system you built or significantly improved using ${skill}? I'm interested in scale, challenges, and your specific decisions.`,
            ];
            question = midQs[Math.floor(Math.random() * midQs.length)];
            break;

        case 'senior':
        case 'lead':
            const seniorQs = [
                `${transition} As a senior professional, I'd like to hear about your architectural experience with **${skill}**. How have you used it at scale? What patterns do you follow, and what anti-patterns have you seen teams fall into?`,
                `${transition} Let's discuss **${skill}** at a systems level. If you were designing a high-traffic system today using ${skill}, walk me through your architecture choices, how you'd handle failures, and where ${skill} shines versus where you'd choose alternatives.`,
                `${transition} In your experience leading with **${skill}**, how do you make technology decisions for your team? Tell me about a time you chose ${skill} over an alternative ‚Äî or chose NOT to use it. What was the reasoning?`
            ];
            question = seniorQs[Math.floor(Math.random() * seniorQs.length)];
            break;
    }

    return {
        phase: 'skill_probe',
        message: question,
        topic: { skill, label: skill, type: 'skill' },
        followUpDepth: 0,
        meta: { skill }
    };
}

function buildFollowUp(state, analysis, answer) {
    const topic = state.currentTopic;
    const flags = analysis.flags;

    if (flags.includes('extremely_brief') || flags.includes('too_brief')) {
        const probes = [
            `I'd love to hear more. Could you elaborate? Specifically, I'm looking for a concrete example ‚Äî a project, a task, or a problem you actually worked on. What happened, what did you do, and what was the result?`,
            `That's quite brief ‚Äî can you walk me through a specific scenario? Even a small project counts. What was the context, what was your approach, and what did you learn?`,
            `I need a bit more detail to evaluate properly. Think of one real example from your experience and describe it step by step ‚Äî the situation, what you did, and the outcome.`
        ];
        return probes[Math.floor(Math.random() * probes.length)];
    }

    if (flags.includes('skill_not_mentioned') && topic?.skill) {
        return `You didn't specifically mention **${topic.skill}** in your answer. How comfortable are you with ${topic.skill} specifically? Can you give me a direct example of using it?`;
    }

    if (flags.includes('uncertain')) {
        return `It sounds like you might not be very sure about this area. That's okay ‚Äî can you tell me what you *do* know about it? Or describe the closest experience you've had?`;
    }

    if (analysis.starCount < 2) {
        return `Good start. Can you help me understand the **impact** of what you did? What measurable results came from your work ‚Äî any numbers, improvements, or outcomes you can share?`;
    }

    return `Interesting. Could you elaborate a bit more on the technical specifics? What were the key decisions you made, and why?`;
}

function buildDeepDive(state, analysis, answer) {
    const topic = state.currentTopic;
    const skill = topic?.skill || 'this';

    const deepDives = [
        `That's impressive work. Let me probe a bit deeper ‚Äî what were the **biggest technical challenges** you faced? How did you debug or resolve them?`,
        `Great answer. Now, if you had to **redo this project from scratch** today, what would you do differently? Any architectural changes?`,
        `You mentioned some solid technical work. How did you ensure **quality and reliability**? What testing strategies did you use? How did you handle edge cases?`,
        `I'm curious about the **trade-offs**. Every technical decision has pros and cons ‚Äî what alternatives did you consider, and why did you go with this approach?`,
        `Solid experience. How did this work perform at **scale**? Were there any performance bottlenecks, and how did you address them?`,
        `One more thing ‚Äî how did you **collaborate** with your team on this? Were there disagreements about the approach? How were they resolved?`
    ];

    return deepDives[Math.floor(Math.random() * deepDives.length)];
}

function buildScenarioQuestion(state) {
    const title = state.jobTitle;
    const scenarios = {
        fresher: [
            `Now let's do a scenario. Imagine it's your first week as a ${title}. Your manager assigns you a task using a technology you've never worked with, and the deadline is in 3 days. **How would you approach this?** Walk me through your thought process.`,
            `Here's a situation: You're working on a feature and realize the approach your senior suggested won't work well. But they're quite experienced. **What do you do?** How do you handle this?`
        ],
        junior: [
            `Scenario time. You've deployed a feature to production and users are reporting intermittent errors that you can't reproduce locally. **Walk me through your debugging process** from start to finish.`,
            `Imagine you're working on a tight deadline and you find a critical bug in a teammate's code during code review. Fixing it properly would delay the release by 2 days. **What's your call?**`
        ],
        mid: [
            `Let's do a design scenario. You need to build a **real-time notification system** that handles 100K concurrent users. Walk me through your architecture ‚Äî what technologies, what patterns, how you handle failures.`,
            `You're leading a feature that requires coordination across 3 teams. Two teams disagree on the API contract. **How do you drive alignment** and keep the project on track?`
        ],
        senior: [
            `Strategic scenario: Your company's main product has accumulated significant technical debt. Performance is degrading, and the team's velocity has dropped 40%. Leadership wants new features, but the codebase is fragile. **How do you make the case for and execute a technical debt reduction initiative?**`,
            `You're architecting a system that needs to handle **10x traffic growth** over the next year, with 99.99% uptime. Current architecture is monolithic. **Walk me through your migration strategy.** What's the timeline, risks, and how do you ensure zero downtime?`
        ],
        lead: [
            `As a tech lead, your team of 8 is struggling with quality ‚Äî bugs in production have increased 3x over the quarter. Team morale is dipping. **What's your 90-day plan** to turn this around?`,
            `Strategic question: You need to choose between building a critical component in-house (gives you full control but takes 6 months) or using a third-party service (ships in 2 weeks but has vendor lock-in risk). **Walk me through your decision framework.**`
        ]
    };

    const levelScenarios = scenarios[state.level] || scenarios.mid;
    const question = levelScenarios[Math.floor(Math.random() * levelScenarios.length)];

    return {
        phase: 'scenario',
        message: `Thanks for your technical insights. ${question}`,
        topic: { label: 'Problem Solving', type: 'scenario' },
        followUpDepth: 0,
        meta: {}
    };
}

function buildBehavioralQuestion(state) {
    const questions = [
        `Good problem-solving approach. Now, a people question: **Tell me about a time you received critical feedback** on your work. How did you handle it, and what changed as a result?`,
        `Let's talk about teamwork. **Describe a situation where you had a disagreement** with a colleague about a technical approach. How did you resolve it? What was the outcome?`,
        `Almost there. **What's something you've failed at** in your career? Not a humble-brag ‚Äî a real failure. What happened, and what did you learn from it?`,
        `Quick one on growth: **What's a technology or concept you recently learned** outside of your day job? Why did you pick it up, and have you applied it?`
    ];

    return {
        phase: 'behavioral',
        message: questions[Math.floor(Math.random() * questions.length)],
        topic: { label: 'Behavioral', type: 'behavioral' },
        followUpDepth: 0,
        meta: {}
    };
}

function buildClosingQuestion(state) {
    return {
        phase: 'closing_q',
        message: `We're coming to the end of our interview. Before we wrap up ‚Äî **do you have any questions for me** about the role, the team, or anything else? Also, is there anything about your experience or skills that we didn't cover that you'd like to highlight?`,
        topic: { label: 'Closing', type: 'closing' },
        followUpDepth: 0,
        meta: {}
    };
}

function buildClosingMessage(state) {
    const name = user.full_name?.split(' ')[0] || 'there';
    const avgScore = calculateOverallScore(state);
    const strong = state.strongAreas.length ? state.strongAreas.slice(0,3).join(', ') : 'multiple areas';
    const skillsCovered = Object.keys(state.skillScores).join(', ') || 'core skills';

    return `Thank you so much, ${name}! That brings us to the end of our interview. üéâ\n\nWe covered **${skillsCovered}**, problem-solving, and behavioral questions today. I was particularly impressed by your responses on **${strong}**.\n\nThe hiring team will review your full interview transcript, scores, and proctoring report. You should hear back within a few business days.\n\nBest of luck! üçÄ`;
}

function calculateOverallScore(state) {
    const all = [...(state.overallScores.technical || []), ...(state.overallScores.behavioral || []), ...(state.overallScores.problem_solving || []), ...(state.overallScores.communication || [])];
    if (!all.length) return 0;
    return Math.round(all.reduce((a,b) => a+b, 0) / all.length);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI ‚Äî Message Rendering
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function aiSay(text, phase, meta = {}) {
    // Show typing
    const typingEl = document.getElementById('typingIndicator');
    typingEl.classList.add('show');
    scrollChat();

    // Simulate AI "thinking" time (feels natural)
    const thinkTime = Math.min(2500, 800 + text.length * 3);
    await sleep(thinkTime);

    typingEl.classList.remove('show');

    // Render AI message
    const body = document.getElementById('chatBody');
    const msgId = 'msg-' + Date.now();
    const skillTag = meta?.skill ? `<span class="msg-skill-tag">${meta.skill}</span>` : '';
    const phaseLabel = phase || '';

    body.innerHTML += `
        <div class="msg msg-ai" id="${msgId}">
            <div class="msg-avatar">ü§ñ</div>
            <div>
                <div class="msg-bubble">${formatMarkdown(text)}</div>
                <div class="msg-meta">
                    <span>${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}</span>
                    ${skillTag}
                    ${meta.isFollowUp ? '<span style="color:var(--warning)">‚Ü™ follow-up</span>' : ''}
                    ${meta.isDeepDive ? '<span style="color:var(--accent)">üî¨ deep dive</span>' : ''}
                </div>
            </div>
        </div>
    `;
    scrollChat();

    // Enable input
    enableInput(!meta.isClosing);
    if (meta.isClosing) {
        setTimeout(() => endSession(), 5000);
    }
}

function addUserMsg(text) {
    const body = document.getElementById('chatBody');
    body.innerHTML += `
        <div class="msg msg-user">
            <div class="msg-avatar">${(user.full_name||'U')[0]}</div>
            <div>
                <div class="msg-bubble">${escapeHtml(text)}</div>
                <div class="msg-meta"><span>${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}</span> <span>${text.split(/\s+/).length} words</span></div>
            </div>
        </div>
    `;
    scrollChat();
}

function formatMarkdown(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
}
function escapeHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function scrollChat() { const b = document.getElementById('chatBody'); setTimeout(()=>b.scrollTop=b.scrollHeight, 50); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function getLastAIMessage() { const msgs = document.querySelectorAll('.msg-ai .msg-bubble'); return msgs.length ? msgs[msgs.length-1].textContent : ''; }

function enableInput(enabled) {
    document.getElementById('userInput').disabled = !enabled;
    document.getElementById('sendBtn').disabled = !enabled;
    if (enabled) document.getElementById('userInput').focus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function sendUserMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;

    addUserMsg(text);
    input.value = '';
    input.style.height = '42px';
    enableInput(false);

    // Process answer
    processUserAnswer(text);

    // Log
    addProcLog('info', `Candidate answered (${text.split(/\s+/).length} words)`);
    if (interviewMeta?.id) {
        api('/api/proctor/log', { method:'POST', body:JSON.stringify({
            interview_id: interviewMeta.id, candidate_id: user.id,
            event_type: 'answer_submitted', severity: 'info',
            description: `Q${convoState.questionCount} answered`
        })}).catch(()=>{});
    }
}

function handleInputKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
    }
    // Enable send button
    document.getElementById('sendBtn').disabled = !e.target.value.trim();
}

function autoResize(el) {
    el.style.height = '42px';
    el.style.height = Math.min(120, el.scrollHeight) + 'px';
    document.getElementById('sendBtn').disabled = !el.value.trim();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function setInputMode(mode) {
    inputMode = mode;
    document.getElementById('imtText').classList.toggle('active', mode==='text');
    document.getElementById('imtVoice').classList.toggle('active', mode==='voice');
    document.getElementById('textInputArea').style.display = mode==='text' ? 'flex' : 'none';
    document.getElementById('voiceInputArea').classList.toggle('active', mode==='voice');
    document.getElementById('inputHint').textContent = mode==='text' ? 'Press Enter to send ¬∑ Shift+Enter for new line' : 'Click the microphone to start/stop recording';
}

function toggleVoice() {
    if (!recognition) { alert('Speech recognition not supported in this browser. Please use Chrome.'); return; }
    if (isRecording) {
        recognition.stop();
        isRecording = false;
        document.getElementById('voiceBtn').classList.remove('recording');
        document.getElementById('voiceStatus').textContent = 'Processing...';
        // Send the transcript
        const transcript = document.getElementById('voiceTranscript').textContent.trim();
        if (transcript) {
            addUserMsg(transcript);
            document.getElementById('voiceTranscript').textContent = '';
            document.getElementById('voiceTranscript').style.display = 'none';
            enableInput(false);
            processUserAnswer(transcript);
        }
        document.getElementById('voiceStatus').textContent = 'Click to start speaking';
    } else {
        recognition.start();
        isRecording = true;
        document.getElementById('voiceBtn').classList.add('recording');
        document.getElementById('voiceStatus').textContent = 'Listening... speak clearly';
        document.getElementById('voiceTranscript').style.display = 'block';
        document.getElementById('voiceTranscript').textContent = '';
    }
}

function handleSpeechResult(e) {
    let final = '', interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) final += e.results[i][0].transcript;
        else interim += e.results[i][0].transcript;
    }
    document.getElementById('voiceTranscript').textContent = final + interim;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROCTORING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startProctoring() {
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            trust = Math.max(0, trust - 8);
            updateTrust();
            showWarn('‚ö†Ô∏è Tab switch detected! This has been recorded.');
            addProcLog('danger', 'Tab switch detected');
            logProc('tab_switch', 'high');
        }
    });
    window.addEventListener('blur', () => { trust=Math.max(0,trust-2); updateTrust(); addProcLog('warn','Window blur'); });
    document.addEventListener('copy', e => { e.preventDefault(); trust=Math.max(0,trust-4); updateTrust(); addProcLog('warn','Copy blocked'); logProc('copy_paste','medium'); });
    document.addEventListener('paste', e => { e.preventDefault(); trust=Math.max(0,trust-4); updateTrust(); addProcLog('warn','Paste blocked'); logProc('copy_paste','medium'); });
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if (e.key==='F12'||(e.ctrlKey&&e.shiftKey&&['i','j','c'].includes(e.key.toLowerCase()))) {
            e.preventDefault(); trust=Math.max(0,trust-10); updateTrust();
            addProcLog('danger','DevTools attempt'); logProc('devtools','critical');
            showWarn('‚ö†Ô∏è Developer tools are NOT allowed!');
        }
    });
    // Face check simulation
    setInterval(() => {
        if (!camOn) return;
        const r = Math.random();
        if (r < .03) { trust=Math.max(0,trust-8); updateTrust(); addProcLog('danger','Face not detected'); logProc('face_not_detected','high'); showWarn('‚ö†Ô∏è Face not visible!'); }
        else if (r < .06) { trust=Math.max(0,trust-3); updateTrust(); addProcLog('warn','Eye gaze deviation'); logProc('eye_deviation','medium'); }
    }, 10000);
    addProcLog('info','Proctoring active');
}

function updateTrust() {
    document.getElementById('trustVal').textContent = trust;
    const circ = document.getElementById('trustCircle');
    const offset = 75.4 * (1 - trust/100);
    circ.setAttribute('stroke-dashoffset', offset);
    circ.setAttribute('stroke', trust>=70?'var(--success)':trust>=40?'var(--warning)':'var(--danger)');
}

function showWarn(msg) {
    // Use a simple approach - flash the topbar
    const tb = document.querySelector('.topbar');
    tb.style.background = 'rgba(239,68,68,.15)';
    setTimeout(() => tb.style.background = 'var(--bg-card)', 3000);
    addProcLog('danger', msg.replace('‚ö†Ô∏è ',''));
}

function addProcLog(level, msg) {
    const time = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    procLogs.unshift({ time, level, msg });
    const el = document.getElementById('proctorPanel');
    el.innerHTML = procLogs.slice(0,50).map(l => `
        <div class="pp-item"><span class="pp-time">${l.time}</span><span class="pp-msg ${l.level==='warn'?'warn':l.level==='danger'?'danger':''}">${l.msg}</span></div>
    `).join('');
}

function logProc(type, sev) {
    if (!interviewMeta?.id) return;
    api('/api/proctor/log',{method:'POST',body:JSON.stringify({interview_id:interviewMeta.id,candidate_id:user.id,event_type:type,severity:sev,confidence_score:trust})}).catch(()=>{});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCam() { camOn=!camOn; mediaStream.getVideoTracks().forEach(t=>t.enabled=camOn); document.getElementById('vcCam').classList.toggle('off',!camOn); if(!camOn){trust=Math.max(0,trust-10);updateTrust();addProcLog('danger','Camera OFF');logProc('camera_off','high');} }
function toggleMic() { micOn=!micOn; mediaStream.getAudioTracks().forEach(t=>t.enabled=micOn); document.getElementById('vcMic').classList.toggle('off',!micOn); }
function goFullscreen() { try{document.documentElement.requestFullscreen()}catch(e){} }

function showPanel(p) {
    document.querySelectorAll('.convo-tab').forEach(t=>t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('chatBody').style.display = p==='chat'?'block':'none';
    document.getElementById('typingIndicator').style.display = p==='chat'?'':'none';
    document.getElementById('proctorPanel').classList.toggle('active', p==='proctor');
}

// Timer
function tick() {
    seconds--;
    if (seconds<=0) { endSession(); return; }
    const m=Math.floor(seconds/60), s=seconds%60;
    document.getElementById('timerText').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (seconds<=300) document.getElementById('timerPill').classList.add('warn');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// END SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function endSession() {
    clearInterval(timerInt);
    const score = calculateOverallScore(convoState);

    if (interviewMeta?.id) {
        await api(`/api/interviews/${interviewMeta.id}/end`, { method:'POST', body:JSON.stringify({
            overall_score: score,
            feedback: {
                total_questions: convoState.questionCount,
                skill_scores: convoState.skillScores,
                overall_scores: convoState.overallScores,
                strong_areas: convoState.strongAreas,
                weak_areas: convoState.weakAreas,
                trust_score: trust,
                history: convoState.history,
                skills_tested: Object.keys(convoState.skillScores),
                job_title: convoState.jobTitle,
                level: convoState.level
            }
        })}).catch(()=>{});
    }

    if (mediaStream) mediaStream.getTracks().forEach(t=>t.stop());

    // Show results
    document.getElementById('interviewApp').innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:var(--bg-dark)">
            <div style="background:var(--bg-card);border-radius:24px;padding:50px;max-width:480px;text-align:center;border:1px solid var(--border)">
                <div style="font-size:48px;margin-bottom:16px">${score>=60?'üéâ':'üìù'}</div>
                <h2 style="font-size:22px;margin-bottom:8px">Interview Complete!</h2>
                <p style="color:var(--text-dim);font-size:14px;margin-bottom:28px;line-height:1.6">Your interview has been recorded and will be reviewed by the hiring team.</p>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:28px">
                    <div style="background:var(--bg-surface);padding:16px;border-radius:12px">
                        <div style="font-size:28px;font-weight:900;color:${score>=70?'var(--success)':score>=40?'var(--warning)':'var(--danger)'}">${score}%</div>
                        <div style="font-size:11px;color:var(--text-muted)">Score</div>
                    </div>
                    <div style="background:var(--bg-surface);padding:16px;border-radius:12px">
                        <div style="font-size:28px;font-weight:900;color:${trust>=70?'var(--success)':'var(--danger)'}">${trust}%</div>
                        <div style="font-size:11px;color:var(--text-muted)">Trust</div>
                    </div>
                    <div style="background:var(--bg-surface);padding:16px;border-radius:12px">
                        <div style="font-size:28px;font-weight:900;color:var(--primary)">${convoState.questionCount}</div>
                        <div style="font-size:11px;color:var(--text-muted)">Questions</div>
                    </div>
                </div>
                ${Object.keys(convoState.skillScores).length ? `
                <div style="text-align:left;margin-bottom:20px">
                    <div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Skills Assessed</div>
                    ${Object.entries(convoState.skillScores).map(([skill,scores]) => {
                        const avg = Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
                        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <span style="min-width:80px;font-size:12px;color:var(--text-dim)">${skill}</span>
                            <div style="flex:1;height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="width:${avg}%;height:100%;background:${avg>=70?'var(--success)':avg>=40?'var(--warning)':'var(--danger)'};border-radius:3px"></div></div>
                            <span style="font-size:12px;font-weight:700;color:${avg>=70?'var(--success)':avg>=40?'var(--warning)':'var(--danger)'}; min-width:35px;text-align:right">${avg}%</span>
                        </div>`;
                    }).join('')}
                </div>` : ''}
                <a href="../dashboard/candidate.html" style="display:inline-flex;align-items:center;gap:6px;padding:12px 28px;background:var(--primary);color:#fff;border-radius:12px;text-decoration:none;font-weight:700;font-size:14px">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
init();
</script>
</body>
</html>
