<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Simpatico HR ‚Äî AI Interview Intelligence</title>
<meta name="theme-color" content="#050510">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --primary:#6366f1;--primary-glow:rgba(99,102,241,.25);
    --accent:#06d6a0;--accent-glow:rgba(6,214,160,.25);
    --danger:#ef4444;--warning:#f59e0b;
    --bg-0:#050510;--bg-2:#111128;
    --border:rgba(255,255,255,.06);--border-hover:rgba(255,255,255,.12);
    --text:#f0f0ff;--text-dim:#8888aa;--text-muted:#555577;
    --glass:rgba(255,255,255,.03);--glass-border:rgba(255,255,255,.08);
    --radius:16px;--radius-sm:12px;--radius-xs:8px;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',-apple-system,system-ui,sans-serif;background:var(--bg-0);color:var(--text);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:4px}
  .bg-anim{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .bg-anim .orb{position:absolute;border-radius:50%;filter:blur(100px);opacity:.12;animation:orbF 25s ease-in-out infinite}
  .orb-1{width:600px;height:600px;background:var(--primary);top:-200px;left:-100px}
  .orb-2{width:400px;height:400px;background:var(--accent);bottom:-100px;right:-100px;animation-delay:-8s}
  .orb-3{width:300px;height:300px;background:#a855f7;top:50%;left:50%;transform:translate(-50%,-50%);animation-delay:-16s}
  @keyframes orbF{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(40px,-30px) scale(1.08)}66%{transform:translate(-30px,25px) scale(.95)}}
  .z1{position:relative;z-index:1}
  .glass-card{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px)}
  .auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;gap:28px;padding:24px;text-align:center}
  .brand{display:flex;flex-direction:column;align-items:center;gap:10px}
  .brand-icon{width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 0 50px var(--primary-glow);animation:bf 3s ease-in-out infinite}
  @keyframes bf{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  .brand h1{font-size:2.2rem;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .brand p{color:var(--text-dim);font-size:.9rem;letter-spacing:.5px}
  .auth-card{width:100%;max-width:440px;padding:36px 30px;display:flex;flex-direction:column;gap:22px}
  .field-group{display:flex;flex-direction:column;gap:6px;text-align:left}
  .field-label{font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px}
  .field-input{width:100%;padding:14px 18px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);font-size:16px;font-family:'JetBrains Mono',monospace;letter-spacing:1.5px;text-align:center;outline:none;transition:all .3s}
  .field-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
  .field-input::placeholder{color:var(--text-muted);font-family:'Inter',sans-serif;letter-spacing:0}
  .upload-zone{border:2px dashed var(--border-hover);border-radius:var(--radius-sm);padding:30px;text-align:center;cursor:pointer;transition:all .3s}
  .upload-zone:hover,.upload-zone.dragover{border-color:var(--primary);background:rgba(99,102,241,.04)}
  .upload-zone.loaded{border-color:var(--accent);border-style:solid;background:rgba(6,214,160,.04)}
  .upload-icon{font-size:2.2rem;margin-bottom:8px;display:block}
  .upload-text{font-size:.9rem;color:var(--text-dim)}
  .upload-file{font-size:.8rem;color:var(--text-muted);margin-top:6px}
  .btn{padding:14px 24px;border-radius:var(--radius-sm);border:none;font-size:.95rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px;-webkit-tap-highlight-color:transparent;user-select:none;position:relative;overflow:hidden}
  .btn:active{transform:scale(.97)}.btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
  .btn-primary{background:linear-gradient(135deg,var(--primary),#8b5cf6);color:#fff;box-shadow:0 4px 24px var(--primary-glow)}
  .btn-primary:hover:not(:disabled){box-shadow:0 6px 32px rgba(99,102,241,.4);transform:translateY(-1px)}
  .btn-accent{background:linear-gradient(135deg,var(--accent),#34d399);color:#000;box-shadow:0 4px 24px var(--accent-glow)}
  .btn-danger{background:rgba(239,68,68,.15);color:var(--danger);border:1px solid rgba(239,68,68,.25)}
  .btn-danger:hover:not(:disabled){background:rgba(239,68,68,.25)}
  .btn-ghost{background:rgba(255,255,255,.05);color:var(--text);border:1px solid var(--border)}
  .btn-ghost:hover:not(:disabled){background:rgba(255,255,255,.08);border-color:var(--border-hover)}
  .btn-sm{padding:10px 16px;font-size:.85rem}.btn-lg{padding:16px 32px;font-size:1.05rem}
  .interview-screen{display:none}.interview-screen.active{display:block}
  .topbar{position:sticky;top:0;z-index:100;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;background:rgba(5,5,16,.88);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--border)}
  .topbar-brand{display:flex;align-items:center;gap:10px}
  .topbar-logo{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:14px}
  .topbar-name{font-weight:700;font-size:.95rem}
  .topbar-meta{display:flex;align-items:center;gap:14px}
  .timer{font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:600;color:var(--primary);background:rgba(99,102,241,.1);padding:5px 12px;border-radius:20px;font-variant-numeric:tabular-nums}
  .mic-ind{display:flex;align-items:center;gap:6px;font-size:.78rem;font-weight:500;color:var(--text-muted)}
  .mic-ind.on{color:var(--accent)}.mic-ind.err{color:var(--danger)}
  .mic-dot{width:7px;height:7px;border-radius:50%;background:var(--text-muted);transition:all .3s}
  .mic-ind.on .mic-dot{background:var(--accent);box-shadow:0 0 10px var(--accent-glow);animation:pulse 1.4s infinite}
  @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.7)}}
  .mic-ind.speaking{color:var(--primary)}
  .mic-ind.speaking .mic-dot{background:var(--primary);box-shadow:0 0 10px var(--primary-glow);animation:pulse 1s infinite}
  .chat-area{max-width:740px;margin:0 auto;padding:16px 20px 260px;min-height:calc(100dvh - 60px)}
  .msg{margin-bottom:18px;max-width:85%;animation:msgS .35s cubic-bezier(.175,.885,.32,1.275)}
  @keyframes msgS{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
  .msg-label{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;opacity:.55}
  .msg-bubble{padding:16px 20px;border-radius:var(--radius);line-height:1.65;font-size:.93rem}
  .msg.ai{margin-right:auto}.msg.ai .msg-label{color:var(--primary)}
  .msg.ai .msg-bubble{background:linear-gradient(135deg,rgba(99,102,241,.07),rgba(139,92,246,.04));border:1px solid rgba(99,102,241,.12);border-bottom-left-radius:4px}
  .msg.user{margin-left:auto}.msg.user .msg-label{color:var(--accent);text-align:right}
  .msg.user .msg-bubble{background:linear-gradient(135deg,rgba(6,214,160,.07),rgba(52,211,153,.04));border:1px solid rgba(6,214,160,.12);border-bottom-right-radius:4px}
  .typing-wrap{display:none;margin-bottom:18px}.typing-wrap.active{display:block}
  .typing-dots{display:flex;gap:5px;padding:16px 20px;background:linear-gradient(135deg,rgba(99,102,241,.07),rgba(139,92,246,.04));border:1px solid rgba(99,102,241,.12);border-radius:var(--radius);border-bottom-left-radius:4px;width:fit-content}
  .typing-dots span{width:8px;height:8px;border-radius:50%;background:var(--primary);animation:dotB 1.4s infinite}
  .typing-dots span:nth-child(2){animation-delay:.15s}.typing-dots span:nth-child(3){animation-delay:.3s}
  @keyframes dotB{0%,60%,100%{transform:translateY(0);opacity:.25}30%{transform:translateY(-10px);opacity:1}}
  .dock{position:fixed;bottom:0;left:0;right:0;z-index:100;background:linear-gradient(to top,var(--bg-0) 65%,transparent);padding:24px 16px 16px;padding-bottom:calc(env(safe-area-inset-bottom,16px) + 16px)}
  .dock-inner{max-width:740px;margin:0 auto;display:flex;flex-direction:column;gap:12px;align-items:center}
  .live-box{width:100%;min-height:46px;padding:12px 18px;border-radius:var(--radius-sm);background:rgba(0,0,0,.4);border:1px solid var(--border);font-size:.9rem;color:var(--text-muted);text-align:center;transition:all .3s;font-style:italic}
  .live-box.has-text{color:var(--text);font-style:normal;border-color:rgba(99,102,241,.3);background:rgba(99,102,241,.04);text-align:left}
  .live-box.ai-speaking{color:var(--primary);font-style:normal;border-color:rgba(99,102,241,.2);background:rgba(99,102,241,.03)}
  .viz{display:flex;gap:2px;align-items:center;height:24px}
  .viz .vb{width:3px;border-radius:2px;background:var(--primary);height:4px;transition:height .08s ease;opacity:.65}
  .dock-row{display:flex;gap:10px;width:100%}.dock-row .btn{flex:1}.dock-row .btn-fixed{flex:none}
  .fallback-row{display:none;width:100%;gap:8px}.fallback-row.active{display:flex}
  .fallback-input{flex:1;padding:14px 16px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);font-size:16px;font-family:inherit;outline:none}
  .fallback-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
  .score-row{display:none;width:100%}.score-row.active{display:flex}
  .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120px);padding:14px 28px;border-radius:var(--radius-sm);font-size:.9rem;font-weight:500;z-index:9999;transition:transform .5s cubic-bezier(.175,.885,.32,1.275);pointer-events:none;background:var(--bg-2);border:1px solid var(--border-hover);box-shadow:0 12px 48px rgba(0,0,0,.6);backdrop-filter:blur(20px)}
  .toast.show{transform:translateX(-50%) translateY(0)}
  .admin-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);align-items:center;justify-content:center;padding:24px}
  .admin-overlay.active{display:flex}
  .admin-panel{width:100%;max-width:480px;padding:32px;max-height:85dvh;overflow-y:auto}
  .admin-panel h2{font-size:1.3rem;font-weight:700;margin-bottom:24px;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .admin-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border)}.admin-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
  .admin-label{font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px;margin-bottom:10px}
  .code-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .code-item{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(0,0,0,.3);border-radius:var(--radius-xs);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:.85rem}
  .code-item-meta{font-family:'Inter',sans-serif;font-size:.75rem;color:var(--text-dim)}
  .select-field{width:100%;padding:12px 14px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);font-size:14px;font-family:inherit;outline:none}
  .score-card{padding:28px;margin-bottom:18px;max-width:100%}
  .score-header{text-align:center;margin-bottom:24px}
  .score-big{font-size:4rem;font-weight:800;line-height:1;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .score-verdict{font-size:.95rem;color:var(--text-dim);margin-top:6px}
  .dim-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:20px 0}
  .dim-item{padding:14px;border-radius:var(--radius-xs);background:rgba(0,0,0,.3);border:1px solid var(--border)}
  .dim-name{font-size:.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px}
  .dim-score{font-size:1.7rem;font-weight:700;margin:4px 0}
  .dim-bar{height:4px;border-radius:2px;background:rgba(255,255,255,.06);overflow:hidden}
  .dim-fill{height:100%;border-radius:2px;transition:width 1.2s cubic-bezier(.4,0,.2,1)}
  .score-sect{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
  .score-sect h4{font-size:.78rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
  .score-sect ul{list-style:none;display:flex;flex-direction:column;gap:8px}
  .score-sect li{font-size:.9rem;color:var(--text);line-height:1.5;padding-left:18px;position:relative}
  .score-sect li::before{content:'';position:absolute;left:0;top:8px;width:6px;height:6px;border-radius:50%}
  .list-green li::before{background:var(--accent)}.list-red li::before{background:var(--danger)}.list-yellow li::before{background:var(--warning)}
  .rec-badge{display:inline-block;padding:10px 24px;border-radius:24px;font-weight:700;font-size:.95rem;margin-top:8px;letter-spacing:.3px}
  .rec-strong-hire{background:rgba(6,214,160,.12);color:var(--accent);border:1px solid rgba(6,214,160,.25)}
  .rec-hire{background:rgba(52,211,153,.1);color:#34d399;border:1px solid rgba(52,211,153,.2)}
  .rec-lean-hire{background:rgba(245,158,11,.1);color:var(--warning);border:1px solid rgba(245,158,11,.2)}
  .rec-lean-no{background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15)}
  .rec-no-hire{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.25)}
  @media(max-width:480px){.msg{max-width:93%}.msg-bubble{padding:14px 16px;font-size:.9rem}.auth-card{padding:28px 22px}.dim-grid{grid-template-columns:1fr}.brand h1{font-size:1.8rem}.chat-area{padding:12px 14px 280px}}
</style>
</head>
<body>
<div class="bg-anim"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div></div>
<div class="toast" id="toast"></div>

<div class="admin-overlay" id="adminOverlay">
  <div class="admin-panel glass-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
      <h2 style="margin:0">‚öôÔ∏è Admin Panel</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeAdmin()">‚úï</button>
    </div>
    <div class="admin-section">
      <div class="admin-label">Generate Access Code</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <input type="text" class="field-input" id="adminLabel" placeholder="Label (e.g. John)" style="letter-spacing:0;text-align:left;font-family:inherit">
        <div style="display:flex;gap:10px">
          <select class="select-field" id="adminDuration">
            <option value="1">1 Hour</option><option value="6">6 Hours</option>
            <option value="24" selected>24 Hours</option><option value="72">3 Days</option>
            <option value="168">7 Days</option><option value="720">30 Days</option>
          </select>
          <button class="btn btn-primary btn-sm" onclick="adminGenCode()">Generate</button>
        </div>
      </div>
      <div id="adminGenResult" style="margin-top:12px"></div>
    </div>
    <div class="admin-section">
      <div class="admin-label">Active Codes</div>
      <button class="btn btn-ghost btn-sm" onclick="adminListCodes()" style="width:100%;margin-top:6px">üîÑ Refresh</button>
      <div class="code-list" id="codeList"></div>
    </div>
  </div>
</div>

<div class="z1">

<div class="auth-screen" id="authScreen">
  <div class="brand">
    <div class="brand-icon">üß†</div>
    <h1>Simpatico HR</h1>
    <p>AI-Powered Interview Intelligence</p>
  </div>
  <div class="auth-card glass-card">
    <div class="field-group">
      <label class="field-label">Access Code</label>
      <input type="text" class="field-input" id="accessCode" placeholder="Enter your access code" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
    <div class="field-group">
      <label class="field-label">Resume / CV</label>
      <div class="upload-zone" id="uploadArea" onclick="document.getElementById('cvFile').click()">
        <input type="file" id="cvFile" accept=".pdf,.txt,.doc,.docx" hidden>
        <span class="upload-icon">üìÑ</span>
        <div class="upload-text">Drop your resume here or click to upload</div>
        <div class="upload-file" id="fileName">PDF, TXT, DOC supported</div>
      </div>
    </div>
    <button class="btn btn-primary btn-lg" style="width:100%" onclick="startInterview()" id="btnStart">üéôÔ∏è Begin Interview</button>
    <button class="btn btn-ghost btn-sm" id="adminBtn" style="width:100%;display:none" onclick="openAdmin()">‚öôÔ∏è Admin Panel</button>
    <p style="text-align:center;font-size:.72rem;color:var(--text-muted);margin-top:4px">Powered by Simpatico HR Consultancy</p>
  </div>
</div>

<div class="interview-screen" id="interviewScreen">
  <div class="topbar">
    <div class="topbar-brand"><div class="topbar-logo">üß†</div><span class="topbar-name">Simpatico HR</span></div>
    <div class="topbar-meta">
      <span class="timer" id="timer">00:00</span>
      <div class="mic-ind" id="micInd"><div class="mic-dot"></div><span id="micLabel">Init</span></div>
    </div>
  </div>
  <div class="chat-area" id="chatArea">
    <div class="typing-wrap" id="typingWrap"><div class="typing-dots"><span></span><span></span><span></span></div></div>
  </div>
  <div class="dock">
    <div class="dock-inner">
      <div class="live-box" id="liveBox">üéôÔ∏è Listening for your response...</div>
      <div class="viz" id="viz"></div>
      <div class="dock-row" id="voiceRow">
        <button class="btn btn-ghost" id="btnMic" onclick="toggleListening()">üéôÔ∏è Listening</button>
        <button class="btn btn-primary btn-fixed" id="btnSend" onclick="sendCurrent()" disabled>Send ‚û§</button>
        <button class="btn btn-danger btn-fixed" onclick="endInterview()">‚èπÔ∏è End</button>
      </div>
      <div class="fallback-row" id="fallbackRow">
        <input type="text" class="fallback-input" id="fallbackInput" placeholder="Type your answer..." enterkeyhint="send">
        <button class="btn btn-primary btn-fixed" onclick="sendFallback()">‚û§</button>
        <button class="btn btn-danger btn-fixed" onclick="endInterview()">‚èπÔ∏è</button>
      </div>
      <div class="dock-row score-row" id="scoreRow">
        <button class="btn btn-accent btn-lg" style="width:100%" onclick="getScore()">üìä Generate Performance Report</button>
      </div>
    </div>
  </div>
</div>

</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const WORKER = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

// ============================================================
// STATE
// ============================================================
let accessCode = "";
let cvText = "";
let history = [];
let timerRef = null;
let secs = 0;
let isActive = false;
let isSending = false;
let micStream = null;

// ============================================================
// ‚òÖ STATE MACHINE ‚Äî The core fix
// States: IDLE ‚Üí LISTENING ‚Üí SENDING ‚Üí AI_SPEAKING ‚Üí LISTENING ‚Üí ...
// Recognition ONLY runs in LISTENING state. NEVER during AI_SPEAKING.
// ============================================================
let appState = "IDLE"; // IDLE | LISTENING | SENDING | AI_SPEAKING

function setState(newState) {
  const prev = appState;
  appState = newState;
  console.log(`[STATE] ${prev} ‚Üí ${newState}`);
  updateUI();
}

function updateUI() {
  const ind = document.getElementById("micInd");
  const lbl = document.getElementById("micLabel");
  const btn = document.getElementById("btnMic");
  const lb = document.getElementById("liveBox");

  switch(appState) {
    case "LISTENING":
      ind.className = "mic-ind on";
      lbl.textContent = "Listening";
      btn.innerHTML = "‚è∏Ô∏è Pause";
      btn.disabled = false;
      lb.className = "live-box";
      if (!lb.classList.contains("has-text")) lb.textContent = "üéôÔ∏è Listening ‚Äî speak now...";
      break;
    case "AI_SPEAKING":
      ind.className = "mic-ind speaking";
      lbl.textContent = "AI Speaking";
      btn.innerHTML = "üîä AI Speaking";
      btn.disabled = true;
      lb.textContent = "üîä AI is speaking...";
      lb.className = "live-box ai-speaking";
      break;
    case "SENDING":
      ind.className = "mic-ind";
      lbl.textContent = "Processing";
      btn.disabled = true;
      break;
    case "IDLE":
      ind.className = "mic-ind";
      lbl.textContent = "Off";
      btn.innerHTML = "üéôÔ∏è Start";
      btn.disabled = false;
      break;
  }
}

// ============================================================
// SPEECH RECOGNITION ‚Äî Simple, no auto-restart during TTS
// ============================================================
let recognition = null;
let recFinal = "";
let recInterim = "";
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const srSupported = !!SR;
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

function createRecognition() {
  if (!srSupported) return null;
  const r = new SR();
  r.continuous = !isIOS;
  r.interimResults = true;
  r.maxAlternatives = 1;
  r.lang = "en-US";

  r.onstart = () => {
    console.log("[SR] ‚úÖ Started ‚Äî speak now");
  };

  r.onresult = (e) => {
    recInterim = "";
    let chunk = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) chunk += t + " ";
      else recInterim += t;
    }
    if (chunk) {
      recFinal += chunk;
      console.log("[SR] üé§ Heard:", chunk.trim());
    }
    const full = recFinal + recInterim;
    setLiveBox(full);
    if (full.trim()) document.getElementById("btnSend").disabled = false;
  };

  r.onerror = (e) => {
    console.warn("[SR] Error:", e.error);
    if (e.error === "not-allowed") {
      showFallback();
      showToast("üéôÔ∏è Mic access denied");
      return;
    }
    // For recoverable errors, restart only if we should be listening
    if (appState === "LISTENING") {
      setTimeout(() => startListening(), 300);
    }
  };

  r.onend = () => {
    console.log("[SR] Ended. AppState:", appState);
    // Only restart if we're supposed to be listening
    if (appState === "LISTENING") {
      console.log("[SR] Restarting (appState is LISTENING)");
      setTimeout(() => startListening(), 200);
    }
    // If AI_SPEAKING or SENDING ‚Äî do NOT restart. That's the fix.
  };

  return r;
}

function startListening() {
  if (!srSupported) return;
  if (appState !== "LISTENING") {
    console.log("[SR] Skipping start ‚Äî appState is", appState);
    return;
  }
  try {
    // Kill old instance
    if (recognition) { try { recognition.abort(); } catch(e) {} }
    recognition = createRecognition();
    recognition.start();
  } catch(e) {
    console.warn("[SR] Start failed:", e.message);
    if (appState === "LISTENING") {
      setTimeout(() => startListening(), 500);
    }
  }
}

function stopListening() {
  if (recognition) {
    try { recognition.abort(); } catch(e) {}
    recognition = null;
  }
}

function clearTranscript() {
  recFinal = "";
  recInterim = "";
}

function getTranscript() {
  return (recFinal + recInterim).trim();
}

// ============================================================
// TTS ‚Äî Speak then callback, NO recognition running
// ============================================================
let ttsWD = null;
let ttsPoll = null;
let ttsKA = null;

function speak(text, onDone) {
  // If no TTS support, callback immediately
  if (!('speechSynthesis' in window)) {
    console.log("[TTS] Not supported, skipping");
    if (onDone) onDone();
    return;
  }

  setState("AI_SPEAKING");

  // Make sure recognition is fully stopped
  stopListening();

  // Clean slate
  speechSynthesis.cancel();
  clearTimeout(ttsWD);
  clearInterval(ttsPoll);
  clearInterval(ttsKA);

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.05;
  u.pitch = 1.0;
  u.volume = 1.0;

  // Best voice
  const voices = speechSynthesis.getVoices();
  const pref = voices.find(v =>
    v.name.includes("Samantha") || v.name.includes("Google US") ||
    v.name.includes("Microsoft Aria") || v.name.includes("Microsoft Zira") ||
    (v.lang === "en-US" && v.localService)
  );
  if (pref) u.voice = pref;

  let done = false;

  function finish() {
    if (done) return;
    done = true;
    clearTimeout(ttsWD);
    clearInterval(ttsPoll);
    clearInterval(ttsKA);
    speechSynthesis.cancel();
    console.log("[TTS] ‚úÖ Done speaking");
    if (onDone) onDone();
  }

  u.onend = () => { console.log("[TTS] onend"); finish(); };
  u.onerror = () => { console.log("[TTS] onerror"); finish(); };

  // Watchdog
  const est = Math.max(text.length * 90, 3000) + 2000;
  ttsWD = setTimeout(() => { console.warn("[TTS] Watchdog @", est); finish(); }, est);

  // Poll
  let pc = 0;
  ttsPoll = setInterval(() => {
    pc++;
    if (!speechSynthesis.speaking && pc > 3) { console.log("[TTS] Poll done"); clearInterval(ttsPoll); finish(); }
    if (pc > est / 400 + 5) { clearInterval(ttsPoll); finish(); }
  }, 400);

  // Chrome 15s fix
  ttsKA = setInterval(() => {
    if (speechSynthesis.speaking && !speechSynthesis.paused) {
      speechSynthesis.pause();
      speechSynthesis.resume();
    } else if (!speechSynthesis.speaking) {
      clearInterval(ttsKA);
    }
  }, 5000);

  speechSynthesis.speak(u);
  console.log("[TTS] üîä Speaking:", text.substring(0, 60) + "...");
}

// Preload voices
if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}

// ============================================================
// AUDIO VISUALIZER
// ============================================================
let audioCtx = null;
let analyser = null;

function initViz() {
  const v = document.getElementById("viz"); v.innerHTML = "";
  for (let i = 0; i < 28; i++) { const b = document.createElement("div"); b.className = "vb"; v.appendChild(b); }

  if (micStream) {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 64;
      audioCtx.createMediaStreamSource(micStream).connect(analyser);
      drawViz();
    } catch(e) {}
  }
}

function drawViz() {
  if (!analyser) return;
  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  const bars = document.querySelectorAll("#viz .vb");
  if (bars.length) {
    const step = Math.floor(data.length / bars.length);
    for (let i = 0; i < bars.length; i++) {
      const v = data[i * step] || 0;
      bars[i].style.height = Math.max(3, (v / 255) * 30) + "px";
    }
  }
  requestAnimationFrame(drawViz);
}

// ============================================================
// UI HELPERS
// ============================================================
function setLiveBox(text) {
  const el = document.getElementById("liveBox");
  if (text && text.trim()) { el.textContent = text; el.className = "live-box has-text"; }
  else if (appState === "LISTENING") { el.textContent = "üéôÔ∏è Listening ‚Äî speak now..."; el.className = "live-box"; }
}

function showFallback() {
  document.getElementById("voiceRow").style.display = "none";
  document.getElementById("fallbackRow").className = "fallback-row active";
  document.getElementById("liveBox").textContent = "‚å®Ô∏è Voice unavailable ‚Äî type below";
  document.getElementById("viz").style.display = "none";
}

function toggleListening() {
  if (appState === "LISTENING") {
    stopListening();
    setState("IDLE");
  } else if (appState === "IDLE") {
    setState("LISTENING");
    clearTranscript();
    setLiveBox("");
    startListening();
  }
}

function addMsg(role, text) {
  const area = document.getElementById("chatArea");
  const typing = document.getElementById("typingWrap");
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.innerHTML = `<div class="msg-label">${role === "ai" ? "üß† Simpatico HR" : "üë§ You"}</div><div class="msg-bubble">${escHtml(text)}</div>`;
  area.insertBefore(div, typing);
  area.scrollTop = area.scrollHeight;
}

function escHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function showTyping(show) {
  document.getElementById("typingWrap").className = show ? "typing-wrap active" : "typing-wrap";
  if (show) document.getElementById("chatArea").scrollTop = document.getElementById("chatArea").scrollHeight;
}

function startTimer() {
  secs = 0;
  timerRef = setInterval(() => {
    secs++;
    document.getElementById("timer").textContent = String(Math.floor(secs/60)).padStart(2,"0") + ":" + String(secs%60).padStart(2,"0");
  }, 1000);
}

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg; t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 3500);
}

// ============================================================
// ‚òÖ HANDS-FREE FLOW: speak ‚Üí wait ‚Üí listen ‚Üí user talks ‚Üí
//   silence ‚Üí auto-send ‚Üí AI responds ‚Üí speak ‚Üí repeat
// ============================================================
let autoSendTimer = null;
const AUTO_SEND_DELAY = 2500; // 2.5s of silence = auto-send

function startAutoSendWatch() {
  clearTimeout(autoSendTimer);

  // Watch for silence after user speaks
  autoSendTimer = setInterval(() => {
    if (appState !== "LISTENING") { clearInterval(autoSendTimer); return; }

    const text = getTranscript();
    if (!text) return; // No speech yet, keep waiting

    // Check if user stopped speaking (no new text for AUTO_SEND_DELAY)
    // We detect this by checking if recFinal hasn't changed
    if (!autoSendWatch.lastText) autoSendWatch.lastText = "";
    if (!autoSendWatch.stableTime) autoSendWatch.stableTime = 0;

    if (text === autoSendWatch.lastText) {
      autoSendWatch.stableTime += 500;
      if (autoSendWatch.stableTime >= AUTO_SEND_DELAY && text.trim().length > 2) {
        console.log("[AUTO] Silence detected ‚Äî auto-sending");
        clearInterval(autoSendTimer);
        autoSendWatch.lastText = "";
        autoSendWatch.stableTime = 0;
        sendCurrent();
      }
    } else {
      autoSendWatch.lastText = text;
      autoSendWatch.stableTime = 0;
    }
  }, 500);
}

const autoSendWatch = { lastText: "", stableTime: 0 };

// ‚òÖ Begin listening phase (after TTS or after send)
function beginListening() {
  clearTranscript();
  setLiveBox("");
  document.getElementById("btnSend").disabled = true;
  setState("LISTENING");
  startListening();

  // Start watching for auto-send
  autoSendWatch.lastText = "";
  autoSendWatch.stableTime = 0;
  startAutoSendWatch();
}

// ============================================================
// API
// ============================================================
async function api(mode, extra = {}) {
  const fd = new FormData();
  fd.append("mode", mode);
  fd.append("accessCode", accessCode);
  fd.append("cvText", cvText);
  fd.append("history", JSON.stringify(history));
  for (const [k,v] of Object.entries(extra)) fd.append(k,v);
  const res = await fetch(WORKER, { method: "POST", body: fd });
  const data = await res.json();
  if (!res.ok) { showToast(data.reply || "Error " + res.status); throw new Error(data.reply); }
  return data;
}

// ============================================================
// CV UPLOAD
// ============================================================
document.getElementById("cvFile").addEventListener("change", async (e) => {
  const file = e.target.files[0]; if (!file) return;
  document.getElementById("fileName").textContent = "‚úÖ " + file.name;
  document.getElementById("uploadArea").classList.add("loaded");
  if (file.type === "text/plain") cvText = await file.text();
  else if (file.type === "application/pdf") {
    try { const buf = await file.arrayBuffer(); const txt = new TextDecoder("utf-8").decode(buf); const p = txt.match(/[\x20-\x7E]{4,}/g); cvText = p ? p.join(" ").substring(0,4000) : `[PDF:${file.name}]`; } catch(e) { cvText = `[PDF:${file.name}]`; }
  } else cvText = `[Uploaded:${file.name}]`;
  showToast("‚úÖ Resume loaded!");
});

const ua = document.getElementById("uploadArea");
ua.addEventListener("dragover", e => { e.preventDefault(); ua.classList.add("dragover"); });
ua.addEventListener("dragleave", () => ua.classList.remove("dragover"));
ua.addEventListener("drop", e => {
  e.preventDefault(); ua.classList.remove("dragover");
  if (e.dataTransfer.files[0]) { document.getElementById("cvFile").files = e.dataTransfer.files; document.getElementById("cvFile").dispatchEvent(new Event("change")); }
});

document.getElementById("accessCode").addEventListener("input", e => {
  document.getElementById("adminBtn").style.display = e.target.value.trim() === "ADMIN-MASTER-999" ? "flex" : "none";
});

// ============================================================
// ‚òÖ INTERVIEW FLOW
// ============================================================
async function startInterview() {
  accessCode = document.getElementById("accessCode").value.trim();
  if (!accessCode) { showToast("‚ö†Ô∏è Enter your access code"); return; }

  const btn = document.getElementById("btnStart");
  btn.disabled = true;
  btn.innerHTML = "‚è≥ Connecting...";

  // ‚òÖ Get mic permission from user click
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    console.log("[MIC] ‚úÖ Permission granted");
  } catch(e) {
    console.warn("[MIC] Denied:", e);
    showToast("üéôÔ∏è Mic denied ‚Äî you can still type");
  }

  try {
    const data = await api("start");

    document.getElementById("authScreen").style.display = "none";
    document.getElementById("interviewScreen").classList.add("active");
    isActive = true;
    history = data.history || [];
    startTimer();
    initViz();
    addMsg("ai", data.reply);

    // ‚òÖ Speak AI greeting, THEN start listening
    speak(data.reply, () => {
      // TTS done ‚Üí now start listening
      if (isActive) {
        if (srSupported && micStream) {
          beginListening();
        } else {
          showFallback();
        }
      }
    });

  } catch(e) {
    console.error(e);
    btn.disabled = false;
    btn.innerHTML = "üéôÔ∏è Begin Interview";
  }
}

async function sendCurrent() {
  if (isSending) return;
  const text = getTranscript();
  if (!text || text.trim().length < 2) { showToast("üéôÔ∏è Say something first!"); return; }

  isSending = true;
  clearInterval(autoSendTimer);

  // ‚òÖ Stop recognition FIRST
  stopListening();
  setState("SENDING");

  document.getElementById("btnSend").disabled = true;
  addMsg("user", text);
  clearTranscript();
  setLiveBox("");
  showTyping(true);

  try {
    const data = await api("interview", { userMessage: text });
    showTyping(false);
    history = data.history || history;
    addMsg("ai", data.reply);

    // ‚òÖ Speak AI reply, THEN listen again
    speak(data.reply, () => {
      if (isActive) beginListening();
    });
  } catch(e) {
    showTyping(false);
    if (isActive) beginListening();
  }
  isSending = false;
}

function sendFallback() {
  const input = document.getElementById("fallbackInput");
  const text = input.value.trim();
  if (!text || isSending) return;
  isSending = true;
  input.value = "";
  addMsg("user", text);
  showTyping(true);
  setState("SENDING");

  api("interview", { userMessage: text }).then(data => {
    showTyping(false);
    history = data.history || history;
    addMsg("ai", data.reply);
    speak(data.reply, () => { isSending = false; });
  }).catch(() => { showTyping(false); isSending = false; });
}

function endInterview() {
  isActive = false;
  stopListening();
  clearInterval(timerRef);
  clearInterval(autoSendTimer);
  speechSynthesis.cancel();
  clearTimeout(ttsWD); clearInterval(ttsPoll); clearInterval(ttsKA);
  setState("IDLE");

  document.getElementById("voiceRow").style.display = "none";
  document.getElementById("fallbackRow").className = "fallback-row";
  document.getElementById("liveBox").style.display = "none";
  document.getElementById("viz").style.display = "none";
  document.getElementById("scoreRow").className = "dock-row score-row active";
  document.getElementById("micLabel").textContent = "Ended";
  addMsg("ai", "Interview complete. Click below to generate your performance report.");
  showToast("‚èπÔ∏è Interview ended");
}

async function getScore() {
  document.getElementById("scoreRow").className = "dock-row score-row";
  showTyping(true);
  showToast("üìä Analyzing performance...");
  try {
    const data = await api("score");
    showTyping(false);
    renderScore(data.reply);
  } catch(e) {
    showTyping(false);
    addMsg("ai", "Failed to generate report. Try again.");
    document.getElementById("scoreRow").className = "dock-row score-row active";
  }
}

// ============================================================
// SCORE RENDERER
// ============================================================
function renderScore(raw) {
  const area = document.getElementById("chatArea");
  const typing = document.getElementById("typingWrap");
  const oM = raw.match(/OVERALL SCORE:\s*(\d+)/i);
  const oS = oM ? parseInt(oM[1]) : null;
  const vM = raw.match(/OVERALL SCORE:\s*\d+\/?1?0?0?\s*[‚Äî\-‚Äì]\s*(.+)/i);
  const verdict = vM ? vM[1].trim() : "";
  const dims = [];
  [{n:"Technical Depth",p:/Technical Depth:\s*(\d+)/i},{n:"Communication",p:/Communication:\s*(\d+)/i},{n:"Problem Solving",p:/Problem Solving:\s*(\d+)/i},{n:"Leadership",p:/Leadership[^:]*:\s*(\d+)/i},{n:"Cultural Fit",p:/Cultural Fit:\s*(\d+)/i}].forEach(d=>{const m=raw.match(d.p);if(m)dims.push({n:d.n,s:parseInt(m[1])})});
  function pL(t,h,nx){const re=new RegExp(h+"[:\\s]*([\\s\\S]*?)(?="+nx.join("|")+"|$)","i");const m=t.match(re);if(!m)return[];return m[1].split(/\n/).map(l=>l.replace(/^[\d.\-‚Ä¢*]+\s*/,"").trim()).filter(l=>l.length>3)}
  const str=pL(raw,"TOP STRENGTHS",["RED FLAG","CONCERN","IMPROVEMENT","HIRING"]);
  const con=pL(raw,"RED FLAGS?|CONCERNS?",["IMPROVEMENT","HIRING"]);
  const imp=pL(raw,"IMPROVEMENT AREAS?",["HIRING RECOMMENDATION"]);
  const rM=raw.match(/HIRING RECOMMENDATION:\s*(STRONG HIRE|HIRE|LEAN HIRE|LEAN NO HIRE|NO HIRE)/i);
  const rec=rM?rM[1].toUpperCase():"";
  const rJM=raw.match(/HIRING RECOMMENDATION:[^\n]*\n([\s\S]*?)$/i);
  const rJ=rJM?rJM[1].trim().split("\n").filter(l=>l.trim()).join(" "):"";

  if(!oS&&!dims.length){const d=document.createElement("div");d.className="msg ai";d.style.maxWidth="100%";d.innerHTML=`<div class="msg-label">üìä Report</div><div class="msg-bubble" style="white-space:pre-wrap;font-family:'JetBrains Mono',monospace;font-size:.82rem">${escHtml(raw)}</div>`;area.insertBefore(d,typing);area.scrollTop=area.scrollHeight;return}

  const card=document.createElement("div");card.className="score-card glass-card";card.style.animation="msgS .5s ease";
  const clr=s=>s>=80?"var(--accent)":s>=60?"var(--primary)":s>=40?"var(--warning)":"var(--danger)";
  const rc=r=>{const k=r.toLowerCase().replace(/\s+/g,"-");return k==="strong-hire"?"rec-strong-hire":k==="hire"?"rec-hire":k==="lean-hire"?"rec-lean-hire":k==="lean-no-hire"?"rec-lean-no":"rec-no-hire"};
  let h="";
  if(oS!==null)h+=`<div class="score-header"><div class="score-big">${oS}</div><div class="score-verdict">${verdict||"out of 100"}</div></div>`;
  if(dims.length){h+=`<div class="dim-grid">`;dims.forEach(d=>{const c=clr(d.s);h+=`<div class="dim-item"><div class="dim-name">${d.n}</div><div class="dim-score" style="color:${c}">${d.s}</div><div class="dim-bar"><div class="dim-fill" style="width:${d.s}%;background:${c}"></div></div></div>`});h+=`</div>`}
  if(str.length){h+=`<div class="score-sect"><h4>üí™ Strengths</h4><ul class="list-green">`;str.forEach(s=>h+=`<li>${escHtml(s)}</li>`);h+=`</ul></div>`}
  if(con.length&&!con[0].toLowerCase().includes("none")){h+=`<div class="score-sect"><h4>üö© Red Flags</h4><ul class="list-red">`;con.forEach(c=>h+=`<li>${escHtml(c)}</li>`);h+=`</ul></div>`}
  if(imp.length){h+=`<div class="score-sect"><h4>üìà Improve</h4><ul class="list-yellow">`;imp.forEach(a=>h+=`<li>${escHtml(a)}</li>`);h+=`</ul></div>`}
  if(rec){h+=`<div class="score-sect" style="text-align:center"><h4>üèÜ Recommendation</h4><div class="rec-badge ${rc(rec)}">${rec}</div>${rJ?`<p style="margin-top:14px;font-size:.9rem;color:var(--text-dim);line-height:1.6">${escHtml(rJ)}</p>`:""}</div>`}
  card.innerHTML=h;area.insertBefore(card,typing);area.scrollTop=area.scrollHeight;
}

// ============================================================
// ADMIN
// ============================================================
function openAdmin(){document.getElementById("adminOverlay").classList.add("active")}
function closeAdmin(){document.getElementById("adminOverlay").classList.remove("active")}
async function adminGenCode(){const l=document.getElementById("adminLabel").value.trim()||"user";const d=document.getElementById("adminDuration").value;try{const data=await api("admin-gen",{duration:d,label:l});document.getElementById("adminGenResult").innerHTML=`<div class="code-item" style="border-color:var(--accent)"><span style="color:var(--accent);font-weight:700">${data.code}</span><span class="code-item-meta">${l}¬∑${d}h</span></div>`;showToast("‚úÖ "+data.code);adminListCodes()}catch(e){}}
async function adminListCodes(){try{const data=await api("admin-list");const list=document.getElementById("codeList");list.innerHTML="";if(!data.codes||!data.codes.length){list.innerHTML=`<div style="color:var(--text-muted);font-size:.85rem;padding:12px">No active codes</div>`;return}data.codes.forEach(c=>{let p={};try{p=JSON.parse(c.data)}catch(e){p={label:c.data}}const el=document.createElement("div");el.className="code-item";el.innerHTML=`<span>${c.code}</span><span class="code-item-meta">${p.label||""}¬∑${p.expiresIn||""}</span>`;list.appendChild(el)})}catch(e){}}

// ============================================================
// LIFECYCLE
// ============================================================
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && isActive && appState === "LISTENING") {
    setTimeout(() => startListening(), 300);
  }
});

document.addEventListener("touchstart", () => {
  if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
}, { once: true });

window.addEventListener("beforeunload", e => { if (isActive) { e.preventDefault(); e.returnValue = ""; } });
document.getElementById("accessCode").addEventListener("keydown", e => { if (e.key === "Enter") startInterview(); });
document.getElementById("fallbackInput").addEventListener("keydown", e => { if (e.key === "Enter") sendFallback(); });
</script>
</body>
</html>
