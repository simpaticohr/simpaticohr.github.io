<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Evalis AI â€“ Hands-Free Interview</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #0f172a, #020617);
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: system-ui, sans-serif;
  color: white;
}

.card {
  background: #111827;
  padding: 24px;
  border-radius: 16px;
  width: 300px;
  text-align: center;
  box-shadow: 0 0 40px rgba(59,130,246,.3);
}

.orb {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  margin: 0 auto 14px;
  background: radial-gradient(circle, #60a5fa, #2563eb);
  box-shadow: 0 0 20px rgba(96,165,250,.8);
}

#question {
  font-size: 15px;
  margin-bottom: 8px;
}

#status {
  font-size: 12px;
  opacity: .8;
  min-height: 16px;
}

button {
  margin-top: 14px;
  padding: 10px 18px;
  border-radius: 999px;
  border: none;
  background: #2563eb;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="card">
  <div class="orb"></div>
  <div id="question">Tap Start to begin</div>
  <div id="status"></div>
  <button id="startBtn">â–¶ Start Interview</button>
</div>

<script>
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

let state = "idle";          // idle | listening | thinking | speaking
let stage = "introduction"; // interview stage
let recognition;
let started = false;

/* ---------- UI ---------- */
function setStatus(text="") {
  document.getElementById("status").textContent = text;
}
function setQuestion(text) {
  document.getElementById("question").textContent = text;
}

/* ---------- SPEAK ---------- */
function speak(text) {
  state = "speaking";
  setStatus("Speakingâ€¦");
  setQuestion(text);

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";

  u.onend = () => {
    state = "listening";
    startListening(); // ðŸ” AUTO-RESTART MIC (hands-free)
  };

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ---------- LISTEN ---------- */
function startListening() {
  if (state !== "listening") return;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("Speech recognition not supported");
    return;
  }

  recognition = new SR();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;

  let finalAnswer = "";
  setStatus("Listeningâ€¦");

  recognition.onresult = e => {
    finalAnswer = e.results[0][0].transcript;
  };

  recognition.onend = async () => {
    if (!finalAnswer) {
      startListening(); // retry silently
      return;
    }

    state = "thinking";
    setStatus("Thinkingâ€¦");

    try {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          answer: finalAnswer,
          state: stage
        })
      });

      const data = await res.json();
      stage = data.nextState || stage;

      speak(data.followUp || "Tell me more.");

    } catch (e) {
      speak("Please repeat that.");
    }
  };

  recognition.onerror = () => {
    startListening(); // recover automatically
  };

  recognition.start();
}

/* ---------- START (ONE TAP ONLY) ---------- */
document.getElementById("startBtn").onclick = () => {
  if (started) return;
  started = true;
  document.getElementById("startBtn").style.display = "none";

  speak("Tell me about yourself.");
};
</script>

</body>
</html>
