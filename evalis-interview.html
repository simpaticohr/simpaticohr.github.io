<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform</title>

  <!-- ‚òÖ PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --bg: #06090f;
      --card: #0d1117;
      --card2: #161b22;
      --border: #21262d;
      --accent: #58a6ff;
      --accent2: #bc8cff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --text: #e6edf3;
      --text2: #8b949e;
      --glow: rgba(88,166,255,0.15);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background:
        radial-gradient(ellipse at 20% 0%, rgba(88,166,255,0.06) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(188,140,255,0.06) 0%, transparent 60%);
      z-index: 0; pointer-events: none;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
      z-index: 1;
    }

    /* ‚òÖ Header */
    .header { text-align: center; padding: 30px 0 20px; }
    .header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header p { color: var(--text2); font-size: 0.9rem; margin-top: 4px; }

    /* ‚òÖ Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 14px;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚òÖ Form */
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text2);
      margin: 12px 0 4px;
      font-weight: 500;
    }
    label:first-child { margin-top: 0; }

    select, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }
    select:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow);
    }
    select option { background: var(--card); }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* ‚òÖ Upload */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 12px;
    }
    .upload-area:hover { border-color: var(--accent); background: rgba(88,166,255,0.03); }
    .upload-area.ok { border-color: var(--green); background: rgba(63,185,80,0.05); }
    .upload-area p { font-size: 0.85rem; color: var(--text2); }
    .upload-area strong { color: var(--accent); }
    #fName { margin-top: 8px; font-size: 0.8rem; color: var(--text2); }

    /* ‚òÖ Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #fff;
      font-family: inherit;
    }
    .btn-go {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      margin-top: 16px;
    }
    .btn-go:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--glow);
    }
    .btn-go:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    /* ‚òÖ Model badge */
    .model-badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 10px;
      border-radius: 20px;
      background: rgba(139,92,246,0.15);
      color: var(--accent2);
    }

    /* ‚òÖ Progress */
    .progress-wrap {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      height: 8px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 20px;
      transition: width 0.5s ease;
      width: 0%;
    }
    .progress-text {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text2);
      margin-bottom: 16px;
    }

    /* ‚òÖ Screens */
    #interviewScreen { display: none; }
    #resultScreen { display: none; }

    /* ============================================================
       ‚òÖ ORB ANIMATION
       ============================================================ */
    .orb-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .orb {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%,
        rgba(88,166,255,0.8),
        rgba(188,140,255,0.6),
        rgba(88,166,255,0.3)
      );
      position: relative;
      animation: orbFloat 4s ease-in-out infinite;
      box-shadow:
        0 0 30px rgba(88,166,255,0.3),
        0 0 60px rgba(188,140,255,0.15),
        inset 0 0 30px rgba(255,255,255,0.1);
    }

    /* Rotating ring */
    .orb::before {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: var(--accent);
      border-right-color: var(--accent2);
      animation: orbSpin 3s linear infinite;
    }

    /* Inner glow pulse */
    .orb::after {
      content: '';
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.2), transparent 70%);
      animation: orbPulse 2s ease-in-out infinite;
    }

    @keyframes orbFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    @keyframes orbSpin {
      to { transform: rotate(360deg); }
    }
    @keyframes orbPulse {
      0%, 100% { opacity: 0.5; transform: scale(0.9); }
      50% { opacity: 1; transform: scale(1.1); }
    }

    /* ‚òÖ Orb States */
    .orb.speaking {
      background: radial-gradient(circle at 35% 35%,
        rgba(63,185,80,0.9),
        rgba(88,166,255,0.6),
        rgba(63,185,80,0.3)
      );
      box-shadow:
        0 0 40px rgba(63,185,80,0.4),
        0 0 80px rgba(63,185,80,0.15),
        inset 0 0 30px rgba(255,255,255,0.1);
      animation: orbFloat 2s ease-in-out infinite, orbSpeak 0.5s ease-in-out infinite;
    }
    @keyframes orbSpeak {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-4px) scale(1.06); }
    }

    .orb.listening {
      background: radial-gradient(circle at 35% 35%,
        rgba(248,81,73,0.9),
        rgba(188,140,255,0.6),
        rgba(248,81,73,0.3)
      );
      box-shadow:
        0 0 40px rgba(248,81,73,0.4),
        0 0 80px rgba(248,81,73,0.15),
        inset 0 0 30px rgba(255,255,255,0.1);
    }

    .orb.thinking {
      animation: orbFloat 1.5s ease-in-out infinite;
      opacity: 0.6;
    }

    .orb-label {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text2);
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ‚òÖ Status */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text2);
      margin-bottom: 12px;
    }
    .status-left { display: flex; align-items: center; gap: 6px; }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: blink 2s infinite;
    }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

    /* ‚òÖ Question box */
    .question-box {
      background: linear-gradient(135deg, rgba(88,166,255,0.08), rgba(188,140,255,0.08));
      border: 1px solid rgba(88,166,255,0.15);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
      font-size: 1.05rem;
      line-height: 1.7;
      min-height: 70px;
    }

    /* ‚òÖ Error box */
    .error-box {
      background: rgba(248,81,73,0.1);
      border: 1px solid rgba(248,81,73,0.3);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 12px;
      font-size: 0.85rem;
      color: var(--red);
      display: none;
    }
    .error-box.show { display: block; }

    /* ‚òÖ Thinking dots */
    .thinking {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text2);
      font-size: 0.85rem;
      margin: 12px 0;
    }
    .thinking-dots span {
      display: inline-block;
      width: 6px; height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: dot 1.2s infinite;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot {
      0%,100% { opacity:0.2; transform:scale(0.8); }
      50% { opacity:1; transform:scale(1.3); }
    }

    /* ‚òÖ Waveform */
    .wave-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3px;
      height: 40px;
      margin: 12px 0;
    }
    .wave-bar {
      width: 4px; height: 8px;
      background: var(--accent);
      border-radius: 4px;
    }
    .wave-wrap.active .wave-bar {
      animation: wave 0.8s ease-in-out infinite alternate;
    }
    .wave-bar:nth-child(1) { animation-delay: 0s; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    .wave-bar:nth-child(6) { animation-delay: 0.3s; }
    .wave-bar:nth-child(7) { animation-delay: 0.2s; }
    .wave-bar:nth-child(8) { animation-delay: 0.1s; }
    .wave-bar:nth-child(9) { animation-delay: 0s; }
    @keyframes wave { from { height: 8px; } to { height: 36px; } }

    /* ‚òÖ Mic */
    .mic-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 16px 0;
    }
    .mic-btn {
      width: 72px; height: 72px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-size: 1.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .mic-btn:hover { transform: scale(1.08); box-shadow: 0 0 25px var(--glow); }
    .mic-btn.rec {
      background: linear-gradient(135deg, var(--red), #da3633);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(248,81,73,0.4); }
      50% { box-shadow: 0 0 0 14px rgba(248,81,73,0); }
    }
    .mic-text {
      font-size: 0.8rem;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .timer {
      font-size: 1.4rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    /* ‚òÖ Controls */
    .ctrls { display: flex; gap: 8px; margin-top: 12px; }
    .ctrls .btn { flex: 1; padding: 10px; font-size: 0.85rem; border-radius: 10px; }
    .btn-repeat { background: rgba(188,140,255,0.15); color: var(--accent2); }
    .btn-skip { background: rgba(255,255,255,0.06); color: var(--text); }
    .btn-done { background: var(--green); }
    .btn-speak { background: rgba(88,166,255,0.15); color: var(--accent); }
    .btn-end { background: rgba(248,81,73,0.15); color: var(--red); width: 100%; margin-top: 10px; padding: 12px; }

    /* ‚òÖ Results */
    .score-ring {
      width: 150px; height: 150px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }
    .score-inner { text-align: center; }
    .score-num { font-size: 2.2rem; font-weight: 800; }
    .score-max { font-size: 0.9rem; color: var(--text2); }
    .grade-badge {
      display: inline-block;
      padding: 4px 16px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    .fb-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
    }
    .fb-item .fb-q { font-weight: 600; color: var(--accent); margin-bottom: 4px; font-size: 0.9rem; }
    .fb-item .fb-score {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 8px;
      display: inline-block;
      margin-bottom: 6px;
    }
    .fb-item .fb-text { font-size: 0.85rem; color: var(--text2); line-height: 1.5; }

    /* ‚òÖ Toast */
    .toast-box {
      position: fixed; top: 16px; right: 16px; z-index: 9999;
      display: flex; flex-direction: column; gap: 8px;
    }
    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 0.85rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      animation: tIn 0.3s ease, tOut 0.3s ease 2.7s forwards;
    }
    @keyframes tIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes tOut { to { transform: translateX(120%); opacity: 0; } }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      .header h1 { font-size: 1.5rem; }
      .row2 { grid-template-columns: 1fr; }
      .orb { width: 80px; height: 80px; }
      .mic-btn { width: 64px; height: 64px; font-size: 1.5rem; }
      .ctrls { flex-wrap: wrap; }
      .ctrls .btn { flex: 1 1 45%; }
    }
  </style>
</head>

<body>
  <div class="toast-box" id="toasts"></div>

  <div class="container">
    <div class="header">
      <h1>üß† AI Interviewer</h1>
      <p>Adaptive interviews ‚Ä¢ Powered by Llama 3.3 70B</p>
    </div>

    <!-- ============================================================
         ‚òÖ SETUP SCREEN
         ============================================================ -->
    <div id="setupScreen">
      <div class="card">
        <h2>‚öôÔ∏è Interview Setup</h2>

        <label>üåê Language</label>
        <select id="langSel">
          <option value="en">English</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
          <option value="es">Espa√±ol (Spanish)</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
          <option value="fr">Fran√ßais (French)</option>
          <option value="de">Deutsch (German)</option>
          <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
        </select>

        <label>üíº Job Role</label>
        <select id="roleSel">
          <option value="">‚Äî Select Role ‚Äî</option>
          <option value="Frontend Developer">Frontend Developer</option>
          <option value="Backend Developer">Backend Developer</option>
          <option value="Full Stack Developer">Full Stack Developer</option>
          <option value="Mobile Developer">Mobile Developer</option>
          <option value="Data Scientist">Data Scientist / Analyst</option>
          <option value="DevOps Engineer">DevOps / Cloud Engineer</option>
          <option value="UI/UX Designer">UI/UX Designer</option>
          <option value="Product Manager">Product Manager</option>
          <option value="QA Engineer">QA / Test Engineer</option>
          <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
          <option value="Sales Representative">Sales / BDR</option>
          <option value="Marketing Manager">Marketing Manager</option>
          <option value="HR Recruiter">HR / Recruiter</option>
          <option value="Finance Analyst">Finance / Accounting</option>
          <option value="Customer Support">Customer Support</option>
          <option value="custom">‚úèÔ∏è Custom Role...</option>
        </select>

        <div id="customWrap" class="hidden">
          <label>Enter Role</label>
          <input type="text" id="customRole" placeholder="e.g. Blockchain Developer">
        </div>

        <div class="row2">
          <div>
            <label>üìä Level</label>
            <select id="levelSel">
              <option value="Fresher">Fresher / Entry</option>
              <option value="Junior">Junior (1-2 yrs)</option>
              <option value="Mid-Level" selected>Mid-Level (3-5 yrs)</option>
              <option value="Senior">Senior (5-10 yrs)</option>
              <option value="Lead">Lead / Principal (10+)</option>
            </select>
          </div>
          <div>
            <label>üî¢ Questions</label>
            <select id="qCount">
              <option value="5">5 (~10 min)</option>
              <option value="8">8 (~15 min)</option>
              <option value="10" selected>10 (~20 min)</option>
              <option value="15">15 (~30 min)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìÑ Resume (Optional)</h2>
        <div id="upArea" class="upload-area" onclick="document.getElementById('cvF').click()">
          <p>üìÇ Click to upload <strong>PDF, DOC, DOCX, TXT</strong></p>
          <p id="fName">No file selected</p>
          <input type="file" id="cvF" accept=".pdf,.doc,.docx,.txt" hidden>
        </div>
      </div>

      <button class="btn btn-go" id="startBtn" onclick="startInterview()">
        üöÄ Start Interview
      </button>
    </div>

    <!-- ============================================================
         ‚òÖ INTERVIEW SCREEN
         ============================================================ -->
    <div id="interviewScreen">
      <div class="card">
        <div class="progress-wrap"><div class="progress-fill" id="progBar"></div></div>
        <div class="progress-text" id="progText">Question 1 / 10</div>

        <div class="status-bar">
          <div class="status-left">
            <div class="status-dot"></div>
            <span>Interview Active</span>
          </div>
          <span class="model-badge" id="modelBadge">üß† 70B</span>
        </div>

        <!-- ‚òÖ ORB ANIMATION -->
        <div class="orb-container">
          <div>
            <div class="orb" id="orb"></div>
            <div class="orb-label" id="orbLabel">AI Interviewer</div>
          </div>
        </div>

        <!-- Error display -->
        <div class="error-box" id="errorBox"></div>

        <!-- Question -->
        <div class="question-box" id="questionBox">
          Preparing your first question...
        </div>

        <!-- Thinking -->
        <div class="thinking hidden" id="thinkBox">
          <div class="thinking-dots"><span></span><span></span><span></span></div>
          <span>AI is analyzing...</span>
        </div>

        <!-- Mic area -->
        <div class="mic-wrap" id="micWrap">
          <div class="wave-wrap" id="waveWrap">
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div>
          </div>
          <button class="mic-btn" id="micBtn" onclick="toggleMic()">üé§</button>
          <span class="mic-text" id="micText">Tap to start speaking</span>
          <span class="timer" id="timer">00:00</span>
        </div>

        <div class="ctrls">
          <button class="btn btn-speak" onclick="speakQuestion()">üîä Speak</button>
          <button class="btn btn-repeat" onclick="speakQuestion()">üîÅ Repeat</button>
          <button class="btn btn-skip" onclick="skipQuestion()">‚è≠ Skip</button>
          <button class="btn btn-done" onclick="submitAnswer()">‚úÖ Submit</button>
        </div>
        <button class="btn btn-end" onclick="endEarly()">‚èπ End Interview Early</button>
      </div>
    </div>

    <!-- ============================================================
         ‚òÖ RESULT SCREEN
         ============================================================ -->
    <div id="resultScreen">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">üèÜ Interview Complete!</h2>
        <div class="score-ring" id="scoreRing">
          <div class="score-inner">
            <div class="score-num" id="scoreNum">0</div>
            <div class="score-max">/ 100</div>
          </div>
        </div>
        <div id="gradeBadge" class="grade-badge">‚Äî</div>
        <p id="scoreSummary" style="color:var(--text2);margin-bottom:20px;line-height:1.6;"></p>
      </div>

      <div class="card">
        <h2>üìù Detailed Feedback</h2>
        <div id="fbList"></div>
      </div>

      <button class="btn btn-go" onclick="location.reload()">üîÑ New Interview</button>
    </div>
  </div>

  <!-- ============================================================
       ‚òÖ JAVASCRIPT
       ============================================================ -->
  <script>
    // ‚òÖ‚òÖ‚òÖ YOUR CLOUDFLARE WORKER URL ‚òÖ‚òÖ‚òÖ
    const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev/";

    // ‚òÖ State
    let cv = "";
    let lang = "en";
    let role = "";
    let level = "";
    let totalQ = 10;
    let currentQ = 0;
    let chatMessages = [];
    let answers = [];
    let isRecording = false;
    let recognition = null;
    let currentTranscript = "";
    let timerInterval = null;
    let seconds = 0;
    let ttsReady = false;

    const langMap = {
      en: { speech: "en-US", tts: "en-US", name: "English" },
      hi: { speech: "hi-IN", tts: "hi-IN", name: "Hindi" },
      es: { speech: "es-ES", tts: "es-ES", name: "Spanish" },
      ar: { speech: "ar-SA", tts: "ar-SA", name: "Arabic" },
      fr: { speech: "fr-FR", tts: "fr-FR", name: "French" },
      de: { speech: "de-DE", tts: "de-DE", name: "German" },
      ur: { speech: "ur-PK", tts: "ur-PK", name: "Urdu" }
    };

    // ‚òÖ Toast
    function toast(msg) {
      const c = document.getElementById("toasts");
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // ‚òÖ Show error in UI
    function showError(msg) {
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      box.classList.add("show");
      setTimeout(() => box.classList.remove("show"), 8000);
    }

    // ‚òÖ Custom role toggle
    document.getElementById("roleSel").addEventListener("change", e => {
      document.getElementById("customWrap").classList.toggle("hidden", e.target.value !== "custom");
    });

    // ‚òÖ Orb state
    function setOrb(state) {
      const orb = document.getElementById("orb");
      const label = document.getElementById("orbLabel");
      orb.className = "orb";
      if (state === "speaking") {
        orb.classList.add("speaking");
        label.textContent = "üîä Speaking...";
      } else if (state === "listening") {
        orb.classList.add("listening");
        label.textContent = "üé§ Listening...";
      } else if (state === "thinking") {
        orb.classList.add("thinking");
        label.textContent = "ü§î Thinking...";
      } else {
        label.textContent = "AI Interviewer";
      }
    }

    // ============================================================
    // ‚òÖ TTS ‚Äî Text to Speech (FIXED)
    // ============================================================

    // Pre-load voices
    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = () => {
        ttsReady = true;
        console.log("‚úÖ TTS voices loaded:", speechSynthesis.getVoices().length);
      };
      // Fallback if event doesn't fire
      setTimeout(() => { ttsReady = true; }, 1000);
    }

    function speakText(text) {
      if (!('speechSynthesis' in window)) {
        console.warn("TTS not supported");
        return;
      }

      // Cancel any ongoing speech
      speechSynthesis.cancel();

      // Small delay to ensure cancel completes
      setTimeout(() => {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = langMap[lang].tts;
        utter.rate = 0.9;
        utter.pitch = 1;
        utter.volume = 1;

        // Try to find a matching voice
        const voices = speechSynthesis.getVoices();
        const langCode = langMap[lang].tts;
        const match = voices.find(v => v.lang.startsWith(langCode.split('-')[0]));
        if (match) utter.voice = match;

        utter.onstart = () => {
          setOrb("speaking");
          console.log("[TTS] Speaking...");
        };

        utter.onend = () => {
          setOrb("idle");
          console.log("[TTS] Done.");
        };

        utter.onerror = (e) => {
          console.error("[TTS] Error:", e.error);
          setOrb("idle");
        };

        speechSynthesis.speak(utter);
      }, 100);
    }

    function speakQuestion() {
      const q = document.getElementById("questionBox").textContent;
      if (q && !q.includes("Preparing") && !q.includes("Error")) {
        speakText(q);
        toast("üîä Speaking question...");
      }
    }

    // ============================================================
    // ‚òÖ CV UPLOAD
    // ============================================================
    document.getElementById("cvF").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById("fName").textContent = "‚è≥ Processing " + file.name + "...";
      document.getElementById("upArea").classList.remove("ok");

      try {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'txt') cv = await file.text();
        else if (ext === 'pdf') cv = await extractPDF(file);
        else if (ext === 'doc' || ext === 'docx') cv = await extractDOC(file);
        else cv = await file.text();

        cv = cv.replace(/\s+/g, ' ').replace(/[^\x20-\x7E\n]/g, '').trim().substring(0, 5000);

        if (cv.length < 30) {
          document.getElementById("fName").textContent = "‚ö†Ô∏è Could not extract ‚Äî try TXT";
          toast("‚ö†Ô∏è Try .txt format"); cv = ""; return;
        }
        document.getElementById("fName").textContent = `‚úÖ ${file.name} (${cv.length} chars)`;
        document.getElementById("upArea").classList.add("ok");
        toast("‚úÖ Resume loaded!");
      } catch(err) {
        console.error(err);
        document.getElementById("fName").textContent = "‚ùå Error reading file";
        cv = "";
      }
    });

    async function extractPDF(file) {
      if (!window.pdfjsLib) return extractFallback(file);
      try {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let t = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const pg = await pdf.getPage(i);
          const c = await pg.getTextContent();
          t += c.items.map(x => x.str).join(' ') + "\n";
        }
        return t;
      } catch(e) { return extractFallback(file); }
    }

    async function extractDOC(file) {
      const buf = await file.arrayBuffer();
      if (file.name.endsWith('.docx')) {
        try {
          const t = new TextDecoder('utf-8').decode(new Uint8Array(buf));
          const m = t.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);
          if (m && m.length) return m.map(x => x.replace(/<[^>]+>/g, '')).join(' ');
        } catch(e) {}
      }
      return extractFallback(file);
    }

    async function extractFallback(file) {
      const buf = await file.arrayBuffer();
      const t = new TextDecoder('utf-8', { fatal: false }).decode(buf);
      const r = t.match(/[a-zA-Z0-9@.,:;!?\-/()\s]{5,}/g);
      if (!r) return "";
      return r.filter(s => {
        return (s.match(/[a-zA-Z]/g) || []).length / s.length > 0.5 && s.trim().length > 5;
      }).join(' ');
    }

    // ============================================================
    // ‚òÖ CLOUDFLARE AI CALL
    // ============================================================
    async function callAI(messages) {
      console.log("[AI] Calling worker with", messages.length, "messages");

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000); // 30s timeout

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
          signal: controller.signal
        });

        clearTimeout(timeout);

        if (!res.ok) {
          const errText = await res.text();
          console.error("[AI] HTTP Error:", res.status, errText);
          throw new Error(`Worker returned ${res.status}: ${errText}`);
        }

        const data = await res.json();
        console.log("[AI] Response:", data);

        // Update model badge
        const badge = document.getElementById("modelBadge");
        if (badge && data.model) {
          if (data.model.includes("70b")) {
            badge.textContent = "üß† 70B";
            badge.style.background = "rgba(63,185,80,0.15)";
            badge.style.color = "#3fb950";
          } else {
            badge.textContent = "‚ö° 8B fallback";
            badge.style.background = "rgba(245,158,11,0.15)";
            badge.style.color = "#d29922";
          }
        }

        if (!data.response) {
          throw new Error("Empty response from AI");
        }

        return data.response;

      } catch(err) {
        clearTimeout(timeout);

        if (err.name === 'AbortError') {
          throw new Error("Request timed out (30s). Try again.");
        }

        throw err;
      }
    }

    // ============================================================
    // ‚òÖ START INTERVIEW
    // ============================================================
    async function startInterview() {
      const roleSel = document.getElementById("roleSel").value;
      if (!roleSel) { toast("‚ùå Select a job role"); return; }

      role = roleSel === "custom" ? document.getElementById("customRole").value.trim() : roleSel;
      if (!role) { toast("‚ùå Enter a custom role"); return; }

      lang = document.getElementById("langSel").value;
      level = document.getElementById("levelSel").value;
      totalQ = parseInt(document.getElementById("qCount").value);

      const btn = document.getElementById("startBtn");
      btn.disabled = true;
      btn.textContent = "‚è≥ Connecting to AI...";

      // ‚òÖ Test worker connection first
      try {
        const testRes = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [
              { role: "user", content: "Say OK" }
            ]
          })
        });

        if (!testRes.ok) {
          const errText = await testRes.text();
          throw new Error(`Worker error ${testRes.status}: ${errText}`);
        }

        console.log("‚úÖ Worker connection successful");
      } catch(err) {
        console.error("‚ùå Worker test failed:", err);
        toast("‚ùå Cannot connect to AI server: " + err.message);
        btn.disabled = false;
        btn.textContent = "üöÄ Start Interview";
        return;
      }

      // Build system prompt
      const systemPrompt = `You are an expert AI interviewer conducting a professional ${level}-level interview for "${role}".

LANGUAGE: Respond ONLY in ${langMap[lang].name}.

${cv ? `CANDIDATE RESUME:\n${cv}\n` : "No resume provided."}

RULES:
1. Ask exactly ${totalQ} main questions. Mix behavioral, technical, and situational.
2. Use C.L.A.I.M. follow-up framework for vague answers:
   - Claims: Verify what they did
   - Learning: What they learned
   - Alternatives: Other approaches
   - Impact: Metrics/results
   - Mechanism: Exact process
3. Follow-ups don't count toward ${totalQ} total.
4. Be conversational and professional.
5. Adapt to ${level} level.
6. Never repeat topics.

Ask your FIRST question now. Output ONLY the question text.`;

      chatMessages = [
        { role: "system", content: systemPrompt }
      ];

      // Switch screen
      document.getElementById("setupScreen").style.display = "none";
      document.getElementById("interviewScreen").style.display = "block";
      setOrb("thinking");
      showThinking(true);

      try {
        btn.textContent = "‚è≥ Generating first question...";

        const firstQ = await callAI(chatMessages);
        chatMessages.push({ role: "assistant", content: firstQ });

        showThinking(false);
        document.getElementById("questionBox").textContent = firstQ;
        updateProgress();

        // ‚òÖ Speak the question (with delay for browser to be ready)
        setTimeout(() => speakText(firstQ), 500);

        initSpeechRecognition();
        toast("üéØ Interview started! Good luck!");

      } catch(err) {
        console.error("[START]", err);
        showError("‚ùå Error: " + err.message);
        toast("‚ùå " + err.message);
        showThinking(false);
        document.getElementById("questionBox").textContent = "‚ùå Error loading question. Check console (F12) for details.";
        setOrb("idle");
      }

      btn.disabled = false;
      btn.textContent = "üöÄ Start Interview";
    }

    // ============================================================
    // ‚òÖ GET NEXT QUESTION / FOLLOW-UP
    // ============================================================
    async function getNextResponse(answerText) {
      showThinking(true);
      setOrb("thinking");

      const prompt = `The candidate answered: "${answerText}"

This was answer ${currentQ} of ${totalQ}.

Decide:
1. If vague/unverified claims ‚Üí ask a C.L.A.I.M. FOLLOW-UP. Prefix: [FOLLOWUP]
2. If thorough ‚Üí ask NEXT main question. Prefix: [NEXT]
${currentQ >= totalQ ? "3. This was the LAST question. Prefix: [DONE] and briefly thank the candidate." : ""}

Output ONLY the prefix tag and question. Stay in ${langMap[lang].name}.`;

      chatMessages.push({ role: "user", content: prompt });

      try {
        const response = await callAI(chatMessages);
        chatMessages.push({ role: "assistant", content: response });

        showThinking(false);

        // Parse
        const cleaned = response
          .replace(/\[FOLLOWUP\]\s*/i, '')
          .replace(/\[NEXT\]\s*/i, '')
          .replace(/\[DONE\]\s*/i, '')
          .trim();

        if (response.toUpperCase().includes("[DONE]") || currentQ >= totalQ) {
          speakText(cleaned);
          setOrb("speaking");
          setTimeout(() => showResults(), 4000);
          return;
        }

        if (response.toUpperCase().includes("[NEXT]")) {
          currentQ++;
        }

        document.getElementById("questionBox").textContent = cleaned;
        updateProgress();

        // ‚òÖ Speak the new question
        setTimeout(() => speakText(cleaned), 300);

      } catch(err) {
        console.error("[NEXT]", err);
        showError("‚ùå AI error: " + err.message);
        toast("‚ùå " + err.message);
        showThinking(false);
        setOrb("idle");
      }
    }

    // ============================================================
    // ‚òÖ SUBMIT ANSWER
    // ============================================================
    async function submitAnswer() {
      if (isRecording) toggleMic();

      await new Promise(r => setTimeout(r, 300));

      const answer = currentTranscript.trim();
      if (!answer) {
        toast("‚ö†Ô∏è No answer detected. Tap üé§ and speak first.");
        return;
      }

      const question = document.getElementById("questionBox").textContent;
      answers.push({ question, answer, skipped: false });
      console.log(`[A${currentQ}]`, answer);

      currentTranscript = "";
      resetTimer();

      await getNextResponse(answer);
    }

    function skipQuestion() {
      if (isRecording) toggleMic();
      const question = document.getElementById("questionBox").textContent;
      answers.push({ question, answer: "[SKIPPED]", skipped: true });
      currentTranscript = "";
      resetTimer();
      currentQ++;
      toast("‚è≠ Skipped");
      if (currentQ >= totalQ) showResults();
      else getNextResponse("[The candidate skipped this question]");
    }

    function endEarly() {
      if (answers.length < 1) { toast("‚ö†Ô∏è Answer at least 1 question"); return; }
      if (isRecording) toggleMic();
      speechSynthesis.cancel();
      showResults();
    }

    // ============================================================
    // ‚òÖ SPEECH RECOGNITION (Hidden transcription)
    // ============================================================
    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { toast("‚ö†Ô∏è Use Chrome for voice input"); return; }

      recognition = new SR();
      recognition.lang = langMap[lang].speech;
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onresult = (e) => {
        let final = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            final += e.results[i][0].transcript + " ";
          }
        }
        if (final) currentTranscript += final;
        // ‚òÖ Hidden ‚Äî no UI update
        console.log("[STT]", final || "(interim)");
      };

      recognition.onerror = (e) => {
        if (e.error !== 'no-speech' && e.error !== 'aborted') {
          console.error("[STT]", e.error);
        }
      };

      recognition.onend = () => {
        if (isRecording) {
          try { recognition.start(); } catch(e) {}
        }
      };

      console.log("‚úÖ Speech recognition ready");
    }

    function toggleMic() {
      if (!recognition) { toast("‚ö†Ô∏è Speech not available"); return; }

      const btn = document.getElementById("micBtn");
      const label = document.getElementById("micText");
      const wave = document.getElementById("waveWrap");

      if (isRecording) {
        isRecording = false;
        recognition.stop();
        btn.classList.remove("rec");
        btn.textContent = "üé§";
        label.textContent = "Tap to start speaking";
        wave.classList.remove("active");
        setOrb("idle");
        stopTimer();
      } else {
        // Stop TTS first
        speechSynthesis.cancel();
        setOrb("listening");

        isRecording = true;
        currentTranscript = "";

        try {
          recognition.start();
        } catch(e) {
          recognition.stop();
          setTimeout(() => { try { recognition.start(); } catch(e2) {} }, 150);
        }

        btn.classList.add("rec");
        btn.textContent = "‚èπ";
        label.textContent = "Listening... Tap to stop";
        wave.classList.add("active");
        startTimer();
      }
    }

    // ============================================================
    // ‚òÖ TIMER
    // ============================================================
    function startTimer() {
      seconds = 0; showTime();
      timerInterval = setInterval(() => { seconds++; showTime(); }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }
    function resetTimer() { clearInterval(timerInterval); seconds = 0; showTime(); }
    function showTime() {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      document.getElementById("timer").textContent = `${m}:${s}`;
    }

    // ============================================================
    // ‚òÖ PROGRESS & THINKING
    // ============================================================
    function updateProgress() {
      const pct = Math.round((currentQ / totalQ) * 100);
      document.getElementById("progBar").style.width = pct + "%";
      document.getElementById("progText").textContent = `Question ${Math.min(currentQ + 1, totalQ)} of ${totalQ} ‚Äî ${pct}%`;
    }

    function showThinking(show) {
      document.getElementById("thinkBox").classList.toggle("hidden", !show);
      document.getElementById("micWrap").style.display = show ? "none" : "flex";
      if (show) {
        document.getElementById("questionBox").textContent = "";
        setOrb("thinking");
      }
    }

    // ============================================================
    // ‚òÖ RESULTS
    // ============================================================
    async function showResults() {
      document.getElementById("interviewScreen").style.display = "none";
      document.getElementById("resultScreen").style.display = "block";
      speechSynthesis.cancel();
      toast("üìä Generating evaluation...");

      const qaPairs = answers.map((a, i) =>
        `Q${i+1}: ${a.question}\nA${i+1}: ${a.skipped ? "[SKIPPED]" : a.answer}`
      ).join('\n\n');

      const evalMessages = [
        {
          role: "system",
          content: `You are an expert interview evaluator. Be fair and constructive. Respond in ${langMap[lang].name} for summary text, but keep JSON keys in English.`
        },
        {
          role: "user",
          content: `Evaluate this ${level}-level interview for "${role}".

INTERVIEW:
${qaPairs}

RESPOND IN STRICT JSON ONLY (no markdown, no code fences, no backticks, no extra text):
{
  "overallScore": 0-100,
  "grade": "A+/A/B+/B/C+/C/D/F",
  "summary": "2-3 sentence assessment",
  "feedback": [
    {
      "question": "short question text",
      "score": 0-10,
      "comment": "specific feedback"
    }
  ]
}

Skipped questions = 0. Be honest.`
        }
      ];

      try {
        const raw = await callAI(evalMessages);
        const cleaned = raw.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const jsonStr = cleaned.match(/\{[\s\S]*\}/)?.[0] || cleaned;
        const result = JSON.parse(jsonStr);
        renderResults(result);
        toast("üèÜ Evaluation complete!");
      } catch(err) {
        console.error("[RESULTS]", err);
        document.getElementById("scoreNum").textContent = "?";
        document.getElementById("scoreSummary").textContent = "Error: " + err.message;
        toast("‚ùå Evaluation error");
      }
    }

    function renderResults(r) {
      const score = r.overallScore || 0;
      const grade = r.grade || "?";
      const isGood = score >= 80;
      const isOk = score >= 60;
      const color = isGood ? '#3fb950' : isOk ? '#d29922' : '#f85149';
      const colorBg = isGood ? 'rgba(63,185,80,0.15)' : isOk ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';

      document.getElementById("scoreRing").style.background =
        `conic-gradient(${color} ${score * 3.6}deg, rgba(255,255,255,0.05) 0deg)`;

      const badge = document.getElementById("gradeBadge");
      badge.textContent = `Grade: ${grade}`;
      badge.style.background = colorBg;
      badge.style.color = color;

      document.getElementById("scoreSummary").textContent = r.summary || "";

      const list = document.getElementById("fbList");
      list.innerHTML = "";
      (r.feedback || []).forEach((fb, i) => {
        const sc = fb.score || 0;
        const c = sc >= 7 ? '#3fb950' : sc >= 5 ? '#d29922' : '#f85149';
        const bg = sc >= 7 ? 'rgba(63,185,80,0.15)' : sc >= 5 ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';
        const div = document.createElement("div");
        div.className = "fb-item";
        div.innerHTML = `
          <div class="fb-q">Q${i+1}: ${fb.question}</div>
          <span class="fb-score" style="background:${bg};color:${c};">${sc}/10</span>
          <div class="fb-text">${fb.comment}</div>`;
        list.appendChild(div);
      });

      // Animate score
      let cur = 0;
      const el = document.getElementById("scoreNum");
      const iv = setInterval(() => {
        cur += Math.ceil(score / 30);
        if (cur >= score) { cur = score; clearInterval(iv); }
        el.textContent = cur;
      }, 30);
    }

    // ============================================================
    // ‚òÖ INIT
    // ============================================================
    window.addEventListener('DOMContentLoaded', () => {
      if (window.pdfjsLib) console.log("‚úÖ PDF.js v" + pdfjsLib.version);
      else console.warn("‚ö†Ô∏è PDF.js not loaded");

      if (!window.SpeechRecognition && !window.webkitSpeechRecognition)
        console.warn("‚ö†Ô∏è SpeechRecognition not supported ‚Äî use Chrome");

      console.log("‚úÖ Worker URL:", WORKER_URL);

      // ‚òÖ Check if Worker URL is still placeholder
      if (WORKER_URL.includes("YOUR-NAME")) {
        console.error("https://evalis-ai.simpaticohrconsultancy.workers.dev/.");
      }
    });
  </script>
</body>
</html>
