<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Simpatico HR ‚Äî AI Interview Intelligence</title>
<meta name="description" content="Enterprise AI-Powered Interview Platform by Simpatico HR">
<meta name="theme-color" content="#050510">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #6366f1;
    --primary-glow: rgba(99,102,241,0.25);
    --accent: #06d6a0;
    --accent-glow: rgba(6,214,160,0.25);
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-0: #050510;
    --bg-1: #0a0a1a;
    --bg-2: #111128;
    --bg-3: #1a1a3e;
    --border: rgba(255,255,255,0.06);
    --border-hover: rgba(255,255,255,0.12);
    --text-primary: #f0f0ff;
    --text-secondary: #8888aa;
    --text-muted: #555577;
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.08);
    --radius: 16px;
    --radius-sm: 12px;
    --radius-xs: 8px;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Inter', -apple-system, system-ui, sans-serif;
    background: var(--bg-0);
    color: var(--text-primary);
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-text-size-adjust: 100%;
    -webkit-font-smoothing: antialiased;
  }

  /* --- ANIMATED BACKGROUND --- */
  .bg-gradient {
    position: fixed; inset: 0; z-index: 0;
    overflow: hidden; pointer-events: none;
  }

  .bg-gradient .orb {
    position: absolute; border-radius: 50%;
    filter: blur(80px); opacity: 0.12;
    animation: orbFloat 20s ease-in-out infinite;
  }

  .orb-1 { width:600px; height:600px; background:var(--primary); top:-200px; left:-100px; }
  .orb-2 { width:400px; height:400px; background:var(--accent); bottom:-100px; right:-100px; animation-delay:-7s; }
  .orb-3 { width:300px; height:300px; background:#a855f7; top:50%; left:50%; transform:translate(-50%,-50%); animation-delay:-14s; }

  @keyframes orbFloat {
    0%, 100% { transform: translate(0,0) scale(1); }
    33% { transform: translate(30px,-30px) scale(1.05); }
    66% { transform: translate(-20px,20px) scale(0.95); }
  }

  .relative { position: relative; z-index: 1; }

  .glass-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }

  /* ============================
     AUTH SCREEN
     ============================ */
  .auth-screen {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; min-height: 100dvh;
    gap: 28px; padding: 24px; text-align: center;
  }

  .brand { display:flex; flex-direction:column; align-items:center; gap:12px; }

  .brand-logo {
    width:72px; height:72px; border-radius:20px;
    background: linear-gradient(135deg, var(--primary), #a855f7);
    display:flex; align-items:center; justify-content:center;
    font-size:32px;
    box-shadow: 0 0 40px var(--primary-glow);
    animation: logoFloat 3s ease-in-out infinite;
  }

  @keyframes logoFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }

  .brand h1 {
    font-size:2rem; font-weight:800; letter-spacing:-0.5px;
    background: linear-gradient(135deg, var(--text-primary), var(--primary));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }

  .brand p { color: var(--text-secondary); font-size: 0.95rem; }

  .auth-card {
    width:100%; max-width:420px; padding:32px 28px;
    display:flex; flex-direction:column; gap:20px;
  }

  .field-group { display:flex; flex-direction:column; gap:6px; text-align:left; }

  .field-label {
    font-size:0.8rem; font-weight:600; color:var(--text-secondary);
    text-transform:uppercase; letter-spacing:0.5px;
  }

  .field-input {
    width:100%; padding:14px 16px; border-radius:var(--radius-sm);
    border:1.5px solid var(--border); background:rgba(0,0,0,0.3);
    color:var(--text-primary); font-size:16px; font-family:inherit;
    outline:none; transition:all 0.3s;
  }

  .field-input:focus {
    border-color:var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
  }

  .field-input::placeholder { color: var(--text-muted); }

  .upload-zone {
    border:2px dashed var(--border-hover); border-radius:var(--radius-sm);
    padding:28px; text-align:center; cursor:pointer; transition:all 0.3s;
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color:var(--primary); background:rgba(99,102,241,0.05);
  }

  .upload-zone.loaded {
    border-color:var(--accent); border-style:solid; background:rgba(6,214,160,0.05);
  }

  .upload-icon { font-size:2rem; margin-bottom:8px; }
  .upload-text { font-size:0.9rem; color:var(--text-secondary); }
  .upload-file { font-size:0.8rem; color:var(--text-muted); margin-top:6px; }

  /* --- BUTTONS --- */
  .btn {
    padding:14px 24px; border-radius:var(--radius-sm); border:none;
    font-size:0.95rem; font-weight:600; font-family:inherit; cursor:pointer;
    transition:all 0.2s; display:flex; align-items:center; justify-content:center;
    gap:8px; -webkit-tap-highlight-color:transparent; user-select:none;
    position:relative; overflow:hidden;
  }

  .btn:active { transform: scale(0.97); }
  .btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }

  .btn-primary {
    background:linear-gradient(135deg, var(--primary), #8b5cf6);
    color:white; box-shadow:0 4px 20px var(--primary-glow);
  }

  .btn-primary:hover:not(:disabled) {
    box-shadow:0 6px 30px rgba(99,102,241,0.5); transform:translateY(-1px);
  }

  .btn-accent {
    background:linear-gradient(135deg, var(--accent), #34d399);
    color:#000; box-shadow:0 4px 20px var(--accent-glow);
  }

  .btn-danger {
    background:linear-gradient(135deg, var(--danger), #dc2626);
    color:white;
  }

  .btn-ghost {
    background:rgba(255,255,255,0.05); color:var(--text-primary);
    border:1px solid var(--border);
  }

  .btn-ghost:hover { background:rgba(255,255,255,0.08); }
  .btn-sm { padding:10px 16px; font-size:0.85rem; }
  .btn-lg { padding:16px 32px; font-size:1.05rem; }

  /* ============================
     INTERVIEW SCREEN
     ============================ */
  .interview-screen { display: none; }
  .interview-screen.active { display: block; }

  .interview-header {
    display:flex; justify-content:space-between; align-items:center;
    padding:16px 0; border-bottom:1px solid var(--border); margin-bottom:12px;
  }

  .header-brand { display:flex; align-items:center; gap:10px; }

  .logo-sm {
    width:32px; height:32px; border-radius:8px;
    background:linear-gradient(135deg, var(--primary), #8b5cf6);
    display:flex; align-items:center; justify-content:center; font-size:14px;
  }

  .header-brand span { font-weight:700; font-size:1rem; }

  .header-meta { display:flex; align-items:center; gap:16px; }

  .timer {
    font-variant-numeric:tabular-nums; font-size:1rem; font-weight:600;
    color:var(--primary); background:rgba(99,102,241,0.1);
    padding:6px 12px; border-radius:var(--radius-xs);
    font-family:'JetBrains Mono', monospace;
  }

  .mic-indicator {
    display:flex; align-items:center; gap:6px;
    font-size:0.8rem; color:var(--text-muted); font-weight:500;
  }

  .mic-indicator.active { color: var(--accent); }
  .mic-indicator.error { color: var(--danger); }

  .mic-dot {
    width:8px; height:8px; border-radius:50%;
    background:var(--text-muted); transition:all 0.3s;
  }

  .mic-indicator.active .mic-dot {
    background:var(--accent);
    animation: pulse 1.5s infinite;
    box-shadow:0 0 10px var(--accent-glow);
  }

  @keyframes pulse {
    0%, 100% { opacity:1; transform:scale(1); }
    50% { opacity:0.5; transform:scale(1.6); }
  }

  /* --- CHAT --- */
  .chat {
    height: calc(100dvh - 300px);
    overflow-y: auto; scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch; padding:12px 0;
  }

  .msg {
    margin-bottom:16px; max-width:85%;
    animation: msgIn 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes msgIn {
    from { opacity:0; transform:translateY(12px) scale(0.98); }
    to { opacity:1; transform:translateY(0) scale(1); }
  }

  .msg-bubble {
    padding:16px 20px; border-radius:var(--radius);
    line-height:1.6; font-size:0.93rem;
  }

  .msg-label {
    font-size:0.7rem; font-weight:600; text-transform:uppercase;
    letter-spacing:0.5px; margin-bottom:6px; opacity:0.6;
  }

  .msg.ai { margin-right:auto; }
  .msg.ai .msg-bubble {
    background:linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05));
    border:1px solid rgba(99,102,241,0.15);
    border-bottom-left-radius:4px;
  }

  .msg.user { margin-left:auto; }
  .msg.user .msg-bubble {
    background:linear-gradient(135deg, rgba(6,214,160,0.08), rgba(52,211,153,0.05));
    border:1px solid rgba(6,214,160,0.15);
    border-bottom-right-radius:4px;
  }

  .msg.user .msg-label { text-align:right; }

  .msg.system { max-width:100%; }
  .msg.system .msg-bubble {
    background:rgba(0,0,0,0.3); border:1px solid var(--border);
    font-family:'JetBrains Mono', monospace;
    font-size:0.82rem; white-space:pre-wrap; line-height:1.7;
  }

  /* --- TYPING INDICATOR --- */
  .typing-indicator { display:none; margin-bottom:16px; }
  .typing-indicator.active { display:block; }

  .typing-dots {
    display:flex; gap:4px; padding:16px 20px;
    background:linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05));
    border:1px solid rgba(99,102,241,0.15);
    border-radius:var(--radius); border-bottom-left-radius:4px;
    width:fit-content;
  }

  .typing-dots span {
    width:8px; height:8px; border-radius:50%;
    background:var(--primary); animation:dotBounce 1.4s infinite;
  }

  .typing-dots span:nth-child(2) { animation-delay:0.2s; }
  .typing-dots span:nth-child(3) { animation-delay:0.4s; }

  @keyframes dotBounce {
    0%, 60%, 100% { transform:translateY(0); opacity:0.3; }
    30% { transform:translateY(-8px); opacity:1; }
  }

  /* --- CONTROLS DOCK --- */
  .controls {
    position:fixed; bottom:0; left:0; right:0;
    background:linear-gradient(transparent, var(--bg-0) 30%);
    padding:24px 16px;
    padding-bottom:calc(env(safe-area-inset-bottom, 16px) + 16px);
    z-index:10;
  }

  .controls-inner {
    max-width:760px; margin:0 auto;
    display:flex; flex-direction:column; gap:14px; align-items:center;
  }

  .live-box {
    width:100%; min-height:44px; padding:12px 18px;
    border-radius:var(--radius-sm);
    background:rgba(0,0,0,0.4); border:1px solid var(--border);
    font-size:0.9rem; color:var(--text-muted);
    text-align:center; transition:all 0.3s; font-style:italic;
  }

  .live-box.has-text {
    color:var(--text-primary); font-style:normal;
    border-color:var(--primary); background:rgba(99,102,241,0.05);
    text-align:left;
  }

  .viz-container { display:flex; gap:2px; align-items:center; height:24px; }

  .viz-container .vbar {
    width:3px; border-radius:2px; background:var(--primary);
    height:4px; transition:height 0.08s ease;
  }

  .btn-row { display:flex; gap:10px; width:100%; }
  .btn-row .btn { flex:1; }
  .btn-row .btn-fixed { flex:none; }

  .fallback-row { display:none; width:100%; gap:8px; }
  .fallback-row.active { display:flex; }

  .fallback-input {
    flex:1; padding:14px 16px; border-radius:var(--radius-sm);
    border:1.5px solid var(--border); background:rgba(0,0,0,0.3);
    color:var(--text-primary); font-size:16px; font-family:inherit; outline:none;
  }

  .fallback-input:focus {
    border-color:var(--primary); box-shadow:0 0 0 3px var(--primary-glow);
  }

  .score-row { display:none; }
  .score-row.active { display:flex; }

  /* --- TOAST --- */
  .toast {
    position:fixed; top:20px; left:50%;
    transform:translateX(-50%) translateY(-120px);
    padding:14px 28px; border-radius:var(--radius-sm);
    font-size:0.9rem; font-weight:500; z-index:1000;
    transition:transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events:none;
    background:var(--bg-2); border:1px solid var(--border-hover);
    box-shadow:0 10px 40px rgba(0,0,0,0.5);
    backdrop-filter:blur(20px);
  }

  .toast.show { transform: translateX(-50%) translateY(0); }

  /* --- SCORE DASHBOARD --- */
  .score-card {
    padding:24px; margin-bottom:16px; max-width:100%;
    animation: msgIn 0.5s ease;
  }

  .score-header { text-align:center; margin-bottom:20px; }

  .score-big {
    font-size:3.5rem; font-weight:800; line-height:1;
    background:linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }

  .score-verdict { font-size:0.95rem; color:var(--text-secondary); margin-top:4px; }

  .dimension-grid {
    display:grid; grid-template-columns:1fr 1fr;
    gap:10px; margin:20px 0;
  }

  .dim-card {
    padding:14px; border-radius:var(--radius-xs);
    background:rgba(0,0,0,0.3); border:1px solid var(--border);
  }

  .dim-name {
    font-size:0.75rem; color:var(--text-muted);
    text-transform:uppercase; letter-spacing:0.3px;
  }

  .dim-score { font-size:1.6rem; font-weight:700; margin:4px 0; }

  .dim-bar {
    height:4px; border-radius:2px; background:var(--border); overflow:hidden;
  }

  .dim-bar-fill {
    height:100%; border-radius:2px; transition:width 1s ease;
  }

  .score-section {
    margin-top:16px; padding-top:16px; border-top:1px solid var(--border);
  }

  .score-section h4 {
    font-size:0.8rem; color:var(--text-secondary);
    text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;
  }

  .score-section ul {
    list-style:none; display:flex; flex-direction:column; gap:6px;
  }

  .score-section li {
    font-size:0.9rem; color:var(--text-primary);
    padding-left:18px; position:relative;
  }

  .score-section li::before {
    content:''; position:absolute; left:0; top:8px;
    width:6px; height:6px; border-radius:50%;
  }

  .strength-list li::before { background:var(--accent); }
  .concern-list li::before { background:var(--danger); }
  .improve-list li::before { background:var(--warning); }

  .recommendation-badge {
    display:inline-block; padding:8px 20px; border-radius:20px;
    font-weight:700; font-size:0.9rem; margin-top:8px;
  }

  .rec-strong-hire { background:rgba(6,214,160,0.15); color:var(--accent); border:1px solid rgba(6,214,160,0.3); }
  .rec-hire { background:rgba(52,211,153,0.1); color:#34d399; border:1px solid rgba(52,211,153,0.2); }
  .rec-lean-hire { background:rgba(245,158,11,0.1); color:var(--warning); border:1px solid rgba(245,158,11,0.2); }
  .rec-lean-no { background:rgba(239,68,68,0.1); color:#f87171; border:1px solid rgba(239,68,68,0.2); }
  .rec-no-hire { background:rgba(239,68,68,0.15); color:var(--danger); border:1px solid rgba(239,68,68,0.3); }

  /* --- ADMIN OVERLAY --- */
  .admin-overlay {
    display:none; position:fixed; inset:0; z-index:500;
    background:rgba(0,0,0,0.7); backdrop-filter:blur(8px);
    -webkit-backdrop-filter:blur(8px);
    align-items:center; justify-content:center; padding:24px;
  }

  .admin-overlay.active { display:flex; }

  .admin-panel {
    width:100%; max-width:480px; padding:32px;
    max-height:80dvh; overflow-y:auto;
  }

  .admin-panel h2 {
    font-size:1.3rem; font-weight:700;
    background:linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }

  .admin-section {
    margin-bottom:24px; padding-bottom:24px;
    border-bottom:1px solid var(--border);
  }

  .admin-section:last-child { border-bottom:none; }

  .admin-label {
    font-size:0.75rem; font-weight:600; color:var(--text-secondary);
    text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;
  }

  .code-list { display:flex; flex-direction:column; gap:8px; margin-top:12px; }

  .code-item {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 14px; background:rgba(0,0,0,0.3);
    border-radius:var(--radius-xs); border:1px solid var(--border);
    font-family:'JetBrains Mono', monospace; font-size:0.85rem;
  }

  .code-item-label {
    font-family:'Inter', sans-serif; font-size:0.75rem; color:var(--text-secondary);
  }

  /* --- RESPONSIVE --- */
  @media (max-width: 480px) {
    .chat { height: calc(100dvh - 340px); }
    .msg { max-width: 92%; }
    .msg-bubble { padding:14px 16px; font-size:0.9rem; }
    .dimension-grid { grid-template-columns: 1fr; }
    .auth-card { padding:24px 20px; }
    .interview-header { padding:12px 0; flex-wrap:wrap; gap:8px; }
    .header-meta { gap:10px; }
    .brand h1 { font-size:1.6rem; }
  }
</style>
</head>
<body>

<!-- ANIMATED BG -->
<div class="bg-gradient">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ADMIN OVERLAY -->
<div class="admin-overlay" id="adminOverlay">
  <div class="admin-panel glass-card" id="adminPanel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
      <h2>‚öôÔ∏è Admin Panel</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeAdmin()">‚úï Close</button>
    </div>

    <div class="admin-section">
      <div class="admin-label">Generate Access Code</div>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:8px;">
        <input type="text" class="field-input" id="adminLabel" placeholder="Label (e.g. John Doe)" style="font-family:'Inter',sans-serif;">
        <div style="display:flex; gap:10px;">
          <select class="field-input" id="adminDuration" style="font-family:'Inter',sans-serif;">
            <option value="1">1 Hour</option>
            <option value="6">6 Hours</option>
            <option value="24" selected>24 Hours</option>
            <option value="72">3 Days</option>
            <option value="168">7 Days</option>
            <option value="720">30 Days</option>
          </select>
          <button class="btn btn-primary btn-sm" onclick="adminGenCode()">Generate</button>
        </div>
      </div>
      <div id="adminGenResult" style="margin-top:12px;"></div>
    </div>

    <div class="admin-section">
      <div class="admin-label">Active Codes</div>
      <button class="btn btn-ghost btn-sm" onclick="adminListCodes()" style="margin-top:8px; width:100%;">üîÑ Refresh List</button>
      <div class="code-list" id="codeList"></div>
    </div>
  </div>
</div>

<div class="relative">

<!-- ============================
     AUTH SCREEN
     ============================ -->
<div class="auth-screen" id="authScreen">
  <div class="brand">
    <div class="brand-logo">üß†</div>
    <h1>Simpatico HR</h1>
    <p>AI-Powered Interview Intelligence</p>
  </div>

  <div class="auth-card glass-card">
    <div class="field-group">
      <label class="field-label">Access Code</label>
      <input type="text" class="field-input" id="accessCode"
             placeholder="Enter your access code"
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>

    <div class="field-group">
      <label class="field-label">Resume / CV</label>
      <div class="upload-zone" id="uploadArea" onclick="document.getElementById('cvFile').click()">
        <input type="file" id="cvFile" accept=".pdf,.txt,.doc,.docx" hidden>
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Drop your resume here or click to upload</div>
        <div class="upload-file" id="fileName">PDF, TXT, DOC supported</div>
      </div>
    </div>

    <button class="btn btn-primary btn-lg" onclick="startInterview()" id="btnStart" style="width:100%;">
      üéôÔ∏è Start Interview
    </button>

    <button class="btn btn-ghost btn-sm" id="adminBtn" style="display:none; width:100%;" onclick="openAdmin()">
      ‚öôÔ∏è Admin Panel
    </button>

    <p style="text-align:center; font-size:0.75rem; color:var(--text-muted);">
      Powered by Simpatico HR Consultancy
    </p>
  </div>
</div>

<!-- ============================
     INTERVIEW SCREEN
     ============================ -->
<div class="interview-screen" id="interviewScreen">
  <div style="max-width:760px; margin:0 auto; padding:0 16px;">
    <div class="interview-header">
      <div class="header-brand">
        <div class="logo-sm">üß†</div>
        <span>Simpatico HR</span>
      </div>
      <div class="header-meta">
        <div class="timer" id="timer">00:00</div>
        <div class="mic-indicator" id="micIndicator">
          <div class="mic-dot"></div>
          <span id="micLabel">Init</span>
        </div>
      </div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>
  </div>

  <!-- CONTROLS DOCK -->
  <div class="controls">
    <div class="controls-inner">
      <div class="live-box" id="liveBox">üéôÔ∏è Listening for your response...</div>

      <div class="viz-container" id="visualizer"></div>

      <div class="btn-row" id="voiceRow">
        <button class="btn btn-ghost" id="btnMic" onclick="toggleListening()">
          üéôÔ∏è Listening
        </button>
        <button class="btn btn-primary" id="btnSend" onclick="sendCurrent()" disabled>
          Send ‚û§
        </button>
        <button class="btn btn-danger btn-fixed" id="btnEnd" onclick="endInterview()">
          ‚èπÔ∏è End
        </button>
      </div>

      <div class="fallback-row" id="fallbackRow">
        <input type="text" class="fallback-input" id="fallbackInput"
               placeholder="Type your answer..." enterkeyhint="send">
        <button class="btn btn-primary btn-fixed" onclick="sendFallback()">‚û§</button>
        <button class="btn btn-danger btn-fixed" onclick="endInterview()">‚èπÔ∏è</button>
      </div>

      <div class="btn-row score-row" id="scoreRow">
        <button class="btn btn-accent btn-lg" onclick="getScore()" style="width:100%;">
          üìä Generate Performance Report
        </button>
      </div>
    </div>
  </div>
</div>

</div>

<script>
// ============================================
// CONFIG
// ============================================
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

// ============================================
// STATE
// ============================================
let accessCode = "";
let cvText = "";
let history = [];
let timerInterval = null;
let seconds = 0;
let isInterviewActive = false;
let isSending = false;

// ============================================
// CONTINUOUS LISTENING ENGINE (Production-Grade)
// ============================================
class ContinuousListeningEngine {
  constructor() {
    this.recognition = null;
    this.isListening = false;
    this.isPaused = false;
    this.isSupported = false;
    this.finalTranscript = "";
    this.interimTranscript = "";
    this.restartAttempts = 0;
    this.maxRestartAttempts = 100;
    this.restartDelay = 80;
    this.silenceTimer = null;
    this.silenceThreshold = 1800;
    this.lastSpeechTime = 0;
    this.audioContext = null;
    this.analyser = null;
    this.mediaStream = null;
    this.animFrameId = null;
    this.isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    this.wakeLock = null;

    this.onInterim = null;
    this.onFinal = null;
    this.onStateChange = null;
    this.onVolumeChange = null;

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    this.isSupported = !!SR;
  }

  _createRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const r = new SR();
    r.continuous = !this.isIOS;
    r.interimResults = true;
    r.maxAlternatives = 1;
    r.lang = "en-US";

    r.onstart = () => {
      this.isListening = true;
      this.restartAttempts = 0;
      this.restartDelay = 80;
      this._fire("listening");
    };

    r.onresult = (e) => {
      this.interimTranscript = "";
      let newFinals = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) newFinals += t + " ";
        else this.interimTranscript += t;
      }
      if (newFinals) {
        this.finalTranscript += newFinals;
        this.lastSpeechTime = Date.now();
        this._resetSilenceTimer();
      }
      const display = this.finalTranscript + this.interimTranscript;
      if (this.interimTranscript && this.onInterim) this.onInterim(display);
      if (newFinals && this.onFinal) this.onFinal(display);
    };

    r.onerror = (e) => {
      console.warn("SR error:", e.error);
      const recoverable = ["no-speech", "audio-capture", "network", "aborted"];
      if (recoverable.includes(e.error) && !this.isPaused && isInterviewActive) {
        this._scheduleRestart();
      } else if (e.error === "not-allowed") {
        this._fire("denied");
        showToast("üéôÔ∏è Microphone denied. Please allow mic access.");
      }
    };

    r.onend = () => {
      this.isListening = false;
      if (!this.isPaused && isInterviewActive) this._scheduleRestart();
      else this._fire("stopped");
    };

    this.recognition = r;
  }

  _scheduleRestart() {
    if (this.restartAttempts >= this.maxRestartAttempts) {
      this._fire("error");
      showToast("‚ö†Ô∏è Mic lost. Tap mic button to retry.");
      return;
    }
    this.restartAttempts++;
    const delay = Math.min(this.restartDelay * Math.pow(1.2, this.restartAttempts - 1), 2000);
    setTimeout(() => {
      if (!this.isPaused && isInterviewActive) this._safeStart();
    }, delay);
  }

  _safeStart() {
    try {
      this._createRecognition();
      this.recognition.start();
    } catch(e) {
      console.warn("SR start fail:", e.message);
      setTimeout(() => this._safeStart(), 400);
    }
  }

  _resetSilenceTimer() {
    clearTimeout(this.silenceTimer);
    this.silenceTimer = setTimeout(() => {
      if (this.finalTranscript.trim().length > 0) {
        this._fire("ready-to-send");
      }
    }, this.silenceThreshold);
  }

  _fire(state) { if (this.onStateChange) this.onStateChange(state); }

  async start() {
    if (!this.isSupported) return false;
    this.isPaused = false;
    this.finalTranscript = "";
    this.interimTranscript = "";
    this.restartAttempts = 0;

    // Get mic stream for visualizer
    try {
      this.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      this._initVisualizer(this.mediaStream);
    } catch(e) {
      console.warn("getUserMedia failed:", e);
    }

    // Wake Lock
    await this._acquireWakeLock();

    this._safeStart();
    return true;
  }

  pause() {
    this.isPaused = true;
    clearTimeout(this.silenceTimer);
    try { this.recognition.stop(); } catch(e) {}
    this._fire("paused");
  }

  resume() {
    if (!this.isSupported) return;
    this.isPaused = false;
    this.finalTranscript = "";
    this.interimTranscript = "";
    this._safeStart();
  }

  stop() {
    this.isPaused = true;
    clearTimeout(this.silenceTimer);
    try { this.recognition.stop(); } catch(e) {}
    this._destroyVisualizer();
    this._releaseWakeLock();
    this._fire("stopped");
  }

  getCurrentTranscript() { return (this.finalTranscript + this.interimTranscript).trim(); }

  clearTranscript() { this.finalTranscript = ""; this.interimTranscript = ""; }

  // --- VISUALIZER ---
  _initVisualizer(stream) {
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      this.analyser = this.audioContext.createAnalyser();
      this.analyser.fftSize = 64;
      this.audioContext.createMediaStreamSource(stream).connect(this.analyser);
      this._drawVisualizer();
    } catch(e) { console.warn("Visualizer fail:", e); }
  }

  _drawVisualizer() {
    if (!this.analyser || this.isPaused) return;
    const data = new Uint8Array(this.analyser.frequencyBinCount);
    this.analyser.getByteFrequencyData(data);
    if (this.onVolumeChange) this.onVolumeChange(data);
    this.animFrameId = requestAnimationFrame(() => this._drawVisualizer());
  }

  _destroyVisualizer() {
    if (this.animFrameId) cancelAnimationFrame(this.animFrameId);
    if (this.audioContext) { this.audioContext.close().catch(()=>{}); this.audioContext = null; this.analyser = null; }
    if (this.mediaStream) { this.mediaStream.getTracks().forEach(t=>t.stop()); this.mediaStream = null; }
  }

  // --- WAKE LOCK ---
  async _acquireWakeLock() {
    if ('wakeLock' in navigator) {
      try {
        this.wakeLock = await navigator.wakeLock.request('screen');
        this.wakeLock.addEventListener('release', () => {
          if (!this.isPaused && isInterviewActive) this._acquireWakeLock();
        });
      } catch(e) {}
    }
  }

  _releaseWakeLock() {
    if (this.wakeLock) { this.wakeLock.release().catch(()=>{}); this.wakeLock = null; }
  }
}

// ============================================
// ENGINE INSTANCE
// ============================================
const engine = new ContinuousListeningEngine();

engine.onInterim = (text) => {
  updateLiveBox(text);
  document.getElementById("btnSend").disabled = false;
};

engine.onFinal = (text) => {
  updateLiveBox(text);
  document.getElementById("btnSend").disabled = false;
};

engine.onStateChange = (state) => {
  const mic = document.getElementById("micIndicator");
  const label = document.getElementById("micLabel");
  const btn = document.getElementById("btnMic");

  switch(state) {
    case "listening":
      mic.className = "mic-indicator active";
      label.textContent = "Listening";
      btn.innerHTML = "üéôÔ∏è Listening";
      btn.disabled = false;
      break;
    case "paused":
      mic.className = "mic-indicator";
      label.textContent = "Paused";
      btn.innerHTML = "üéôÔ∏è Resume";
      btn.disabled = false;
      break;
    case "ready-to-send":
      mic.className = "mic-indicator active";
      label.textContent = "Ready";
      break;
    case "stopped":
      mic.className = "mic-indicator";
      label.textContent = "Off";
      btn.innerHTML = "üéôÔ∏è Start";
      btn.disabled = false;
      break;
    case "denied":
      mic.className = "mic-indicator error";
      label.textContent = "Denied";
      showFallbackInput();
      break;
    case "error":
      mic.className = "mic-indicator error";
      label.textContent = "Error";
      btn.innerHTML = "üéôÔ∏è Retry";
      btn.disabled = false;
      break;
  }
};

engine.onVolumeChange = (data) => {
  const bars = document.querySelectorAll("#visualizer .vbar");
  if (!bars.length) return;
  const step = Math.floor(data.length / bars.length);
  for (let i = 0; i < bars.length; i++) {
    const val = data[i * step] || 0;
    bars[i].style.height = Math.max(3, (val / 255) * 28) + "px";
  }
};

// ============================================
// TTS WITH BULLETPROOF MIC RESUME (4-Layer)
// ============================================
let ttsWatchdog = null;
let ttsPollInterval = null;
let ttsKeepAlive = null;

function speak(text) {
  if (!('speechSynthesis' in window)) {
    if (isInterviewActive) setTimeout(() => engine.resume(), 300);
    return;
  }

  // Pause mic so it doesn't hear speaker
  if (engine.isListening) engine.pause();

  // Kill any ongoing speech
  speechSynthesis.cancel();
  clearTimeout(ttsWatchdog);
  clearInterval(ttsPollInterval);
  clearInterval(ttsKeepAlive);

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.05;
  u.pitch = 1.0;
  u.volume = 1.0;

  // Pick best voice
  const voices = speechSynthesis.getVoices();
  const pref = voices.find(v =>
    v.name.includes("Samantha") || v.name.includes("Google US") ||
    v.name.includes("Microsoft Aria") || (v.lang === "en-US" && v.localService)
  );
  if (pref) u.voice = pref;

  let hasResumed = false;

  function resumeMic() {
    if (hasResumed) return;
    hasResumed = true;
    clearTimeout(ttsWatchdog);
    clearInterval(ttsPollInterval);
    clearInterval(ttsKeepAlive);
    speechSynthesis.cancel();
    console.log("[TTS] Mic resuming");
    if (isInterviewActive) {
      setTimeout(() => engine.resume(), 300);
    }
  }

  // LAYER 1: Normal TTS finish
  u.onend = () => {
    console.log("[TTS] onend fired");
    resumeMic();
  };

  // LAYER 2: TTS error
  u.onerror = (e) => {
    console.warn("[TTS] onerror:", e);
    resumeMic();
  };

  // LAYER 3: Watchdog timer ‚Äî estimated duration + buffer
  const estimatedMs = Math.max(text.length * 100, 3000) + 2000;
  ttsWatchdog = setTimeout(() => {
    console.warn("[TTS] Watchdog triggered ‚Äî forcing resume");
    resumeMic();
  }, estimatedMs);

  // LAYER 4: Poll check ‚Äî every 500ms see if TTS stopped
  let pollCount = 0;
  const maxPolls = Math.ceil(estimatedMs / 500) + 6;
  ttsPollInterval = setInterval(() => {
    pollCount++;
    if (!speechSynthesis.speaking && pollCount > 3) {
      console.log("[TTS] Poll detected silence");
      resumeMic();
    }
    if (pollCount >= maxPolls) {
      resumeMic();
    }
  }, 500);

  // CHROME FIX: Chrome kills TTS after ~15s. Pause/resume keeps it alive.
  ttsKeepAlive = setInterval(() => {
    if (speechSynthesis.speaking && !hasResumed) {
      speechSynthesis.pause();
      speechSynthesis.resume();
    } else {
      clearInterval(ttsKeepAlive);
    }
  }, 5000);

  speechSynthesis.speak(u);
}

// Load voices
if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}

// Global Chrome TTS keep-alive
if (typeof speechSynthesis !== 'undefined') {
  setInterval(() => {
    if (speechSynthesis.speaking && !speechSynthesis.paused) {
      speechSynthesis.pause();
      speechSynthesis.resume();
    }
  }, 10000);
}

// ============================================
// UI HELPERS
// ============================================
function initViz() {
  const v = document.getElementById("visualizer");
  v.innerHTML = "";
  for (let i = 0; i < 24; i++) {
    const b = document.createElement("div");
    b.className = "vbar";
    v.appendChild(b);
  }
}

function updateLiveBox(text) {
  const el = document.getElementById("liveBox");
  if (text && text.trim()) {
    el.textContent = text;
    el.className = "live-box has-text";
  } else {
    el.textContent = "üéôÔ∏è Listening for your response...";
    el.className = "live-box";
  }
}

function showFallbackInput() {
  document.getElementById("voiceRow").style.display = "none";
  document.getElementById("fallbackRow").className = "fallback-row active";
  document.getElementById("liveBox").textContent = "‚å®Ô∏è Voice unavailable ‚Äî type below";
  document.getElementById("visualizer").style.display = "none";
  document.getElementById("fallbackInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendFallback();
  });
}

function toggleListening() {
  if (engine.isListening) engine.pause();
  else engine.resume();
}

function addMsg(role, text) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = `msg ${role}`;

  const label = document.createElement("div");
  label.className = "msg-label";
  label.textContent = role === "ai" ? "üß† Simpatico AI" : "üë§ You";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  bubble.textContent = text;

  div.appendChild(label);
  div.appendChild(bubble);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function showTyping(show) {
  const el = document.getElementById("typingIndicator");
  el.className = show ? "typing-indicator active" : "typing-indicator";
  if (show) {
    const chat = document.getElementById("chat");
    chat.scrollTop = chat.scrollHeight;
  }
}

function startTimer() {
  seconds = 0;
  timerInterval = setInterval(() => {
    seconds++;
    const m = String(Math.floor(seconds / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    document.getElementById("timer").textContent = `${m}:${s}`;
  }, 1000);
}

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 3500);
}

// ============================================
// API
// ============================================
async function apiCall(mode, extra = {}) {
  const fd = new FormData();
  fd.append("mode", mode);
  fd.append("accessCode", accessCode);
  fd.append("cvText", cvText);
  fd.append("history", JSON.stringify(history));
  for (const [k, v] of Object.entries(extra)) fd.append(k, v);

  const res = await fetch(WORKER_URL, { method: "POST", body: fd });
  const data = await res.json();

  if (res.status === 403) { showToast(data.reply); throw new Error("Access denied"); }
  if (res.status === 500) { showToast("‚ö†Ô∏è Server error ‚Äî check Worker bindings"); throw new Error(data.reply || "Server error"); }
  if (!res.ok) { showToast(data.reply || "Something went wrong"); throw new Error("API Error"); }

  return data;
}

// ============================================
// CV UPLOAD
// ============================================
document.getElementById("cvFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("fileName").textContent = "‚úÖ " + file.name;
  document.getElementById("uploadArea").classList.add("loaded");

  if (file.type === "text/plain") {
    cvText = await file.text();
  } else if (file.type === "application/pdf") {
    try {
      const buf = await file.arrayBuffer();
      const txt = new TextDecoder("utf-8").decode(buf);
      const readable = txt.match(/[\x20-\x7E]{4,}/g);
      cvText = readable ? readable.join(" ").substring(0, 4000) : `[PDF: ${file.name}]`;
    } catch(e) { cvText = `[PDF: ${file.name}]`; }
  } else {
    cvText = `[Uploaded: ${file.name}]`;
  }
  showToast("‚úÖ Resume loaded!");
});

// Drag & drop
const uploadEl = document.getElementById("uploadArea");
uploadEl.addEventListener("dragover", (e) => { e.preventDefault(); uploadEl.classList.add("dragover"); });
uploadEl.addEventListener("dragleave", () => uploadEl.classList.remove("dragover"));
uploadEl.addEventListener("drop", (e) => {
  e.preventDefault(); uploadEl.classList.remove("dragover");
  if (e.dataTransfer.files[0]) {
    document.getElementById("cvFile").files = e.dataTransfer.files;
    document.getElementById("cvFile").dispatchEvent(new Event("change"));
  }
});

// Show admin button when admin key entered
document.getElementById("accessCode").addEventListener("input", (e) => {
  const v = e.target.value.trim();
  document.getElementById("adminBtn").style.display =
    (v === "ADMIN-MASTER-999" || v.length > 12) ? "flex" : "none";
});

// ============================================
// INTERVIEW FLOW
// ============================================
async function startInterview() {
  accessCode = document.getElementById("accessCode").value.trim();
  if (!accessCode) { showToast("‚ö†Ô∏è Enter your access code"); return; }

  const btn = document.getElementById("btnStart");
  btn.disabled = true;
  btn.innerHTML = "‚è≥ Connecting...";

  try {
    const data = await apiCall("start");

    // Switch screens
    document.getElementById("authScreen").style.display = "none";
    document.getElementById("interviewScreen").classList.add("active");
    isInterviewActive = true;

    // Init
    history = data.history || [];
    addMsg("ai", data.reply);
    startTimer();
    initViz();

    // Speak AI greeting, then start mic
    speak(data.reply);

    // Also start mic for browsers where TTS is not available
    if (!('speechSynthesis' in window)) {
      if (engine.isSupported) {
        const ok = await engine.start();
        if (!ok) showFallbackInput();
      } else {
        showFallbackInput();
      }
    } else {
      // Mic will be started by speak() ‚Üí resumeMic() after TTS ends
      // But we need to init the engine first
      if (engine.isSupported) {
        engine.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true }).catch(() => null);
        if (engine.mediaStream) engine._initVisualizer(engine.mediaStream);
        await engine._acquireWakeLock();
        // Engine will be started by resumeMic after TTS
      } else {
        showFallbackInput();
      }
    }

  } catch(e) {
    console.error(e);
    btn.disabled = false;
    btn.innerHTML = "üéôÔ∏è Start Interview";
  }
}

async function sendCurrent() {
  if (isSending) return;
  const text = engine.getCurrentTranscript();
  if (!text) { showToast("üéôÔ∏è Say something first!"); return; }

  isSending = true;
  document.getElementById("btnSend").disabled = true;
  engine.pause();

  addMsg("user", text);
  engine.clearTranscript();
  updateLiveBox("");
  showTyping(true);

  try {
    const data = await apiCall("interview", { userMessage: text });
    showTyping(false);
    history = data.history || history;
    addMsg("ai", data.reply);
    speak(data.reply); // Will auto-resume mic after TTS
  } catch(e) {
    console.error(e);
    showTyping(false);
    if (isInterviewActive) engine.resume();
  }
  isSending = false;
}

function sendFallback() {
  if (isSending) return;
  const input = document.getElementById("fallbackInput");
  const text = input.value.trim();
  if (!text) return;

  isSending = true;
  input.value = "";
  addMsg("user", text);
  showTyping(true);

  apiCall("interview", { userMessage: text }).then(data => {
    showTyping(false);
    history = data.history || history;
    addMsg("ai", data.reply);
    speak(data.reply);
    isSending = false;
  }).catch((e) => {
    console.error(e);
    showTyping(false);
    isSending = false;
  });
}

function endInterview() {
  isInterviewActive = false;
  engine.stop();
  clearInterval(timerInterval);
  speechSynthesis.cancel();
  clearTimeout(ttsWatchdog);
  clearInterval(ttsPollInterval);
  clearInterval(ttsKeepAlive);

  document.getElementById("voiceRow").style.display = "none";
  document.getElementById("fallbackRow").className = "fallback-row";
  document.getElementById("liveBox").style.display = "none";
  document.getElementById("visualizer").style.display = "none";
  document.getElementById("scoreRow").className = "btn-row score-row active";
  document.getElementById("micLabel").textContent = "Ended";

  addMsg("ai", "Interview concluded. Click below to generate your performance report.");
  showToast("‚èπÔ∏è Interview ended");
}

async function getScore() {
  document.getElementById("scoreRow").className = "btn-row score-row";
  showTyping(true);
  showToast("üìä Generating report...");

  try {
    const data = await apiCall("score");
    showTyping(false);
    renderScoreCard(data.reply);
  } catch(e) {
    console.error(e);
    showTyping(false);
    addMsg("ai", "Failed to generate report. Please try again.");
    document.getElementById("scoreRow").className = "btn-row score-row active";
  }
}

// ============================================
// SCORE CARD VISUAL RENDERER
// ============================================
function renderScoreCard(rawText) {
  const chat = document.getElementById("chat");

  // Parse overall score
  const overallMatch = rawText.match(/OVERALL SCORE:\s*(\d+)/i);
  const overallScore = overallMatch ? parseInt(overallMatch[1]) : null;
  const verdictMatch = rawText.match(/OVERALL SCORE:\s*\d+\/?1?0?0?\s*[‚Äî\-‚Äì]\s*(.+)/i);
  const verdict = verdictMatch ? verdictMatch[1].trim() : "out of 100";

  // Parse dimensions
  const dims = [];
  const dimPatterns = [
    { name: "Technical Depth", pattern: /Technical Depth:\s*(\d+)/i },
    { name: "Communication", pattern: /Communication:\s*(\d+)/i },
    { name: "Problem Solving", pattern: /Problem Solving:\s*(\d+)/i },
    { name: "Leadership", pattern: /Leadership[^:]*:\s*(\d+)/i },
    { name: "Cultural Fit", pattern: /Cultural Fit:\s*(\d+)/i },
  ];
  dimPatterns.forEach(d => {
    const m = rawText.match(d.pattern);
    if (m) dims.push({ name: d.name, score: parseInt(m[1]) });
  });

  // Parse bullet lists
  const parseList = (text, header, nextHeaders) => {
    const nh = nextHeaders.join("|");
    const regex = new RegExp(header + "[:\\s]*([\\s\\S]*?)(?=" + nh + "|$)", "i");
    const m = text.match(regex);
    if (!m) return [];
    return m[1].split(/\n/).map(l => l.replace(/^[\d.\-‚Ä¢*]+\s*/, "").trim()).filter(l => l.length > 3);
  };

  const strengths = parseList(rawText, "TOP STRENGTHS", ["RED FLAGS", "CONCERN", "IMPROVEMENT", "HIRING"]);
  const concerns = parseList(rawText, "RED FLAGS|CONCERNS", ["IMPROVEMENT", "HIRING"]);
  const improvements = parseList(rawText, "IMPROVEMENT AREAS", ["HIRING RECOMMENDATION"]);

  const recMatch = rawText.match(/HIRING RECOMMENDATION:\s*(STRONG HIRE|HIRE|LEAN HIRE|LEAN NO HIRE|NO HIRE)/i);
  const recommendation = recMatch ? recMatch[1].toUpperCase() : "";
  const recJustMatch = rawText.match(/HIRING RECOMMENDATION:[^\n]*\n([\s\S]*?)$/i);
  const recJustification = recJustMatch ? recJustMatch[1].trim().split("\n").filter(l => l.trim()).join(" ") : "";

  // Fallback: if parsing fails, show raw text
  if (!overallScore && dims.length === 0) {
    const div = document.createElement("div");
    div.className = "msg system";
    const lbl = document.createElement("div");
    lbl.className = "msg-label";
    lbl.textContent = "üìä Interview Report";
    const bubble = document.createElement("div");
    bubble.className = "msg-bubble";
    bubble.textContent = rawText;
    div.appendChild(lbl);
    div.appendChild(bubble);
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return;
  }

  // Build visual card
  const card = document.createElement("div");
  card.className = "score-card glass-card";

  const getColor = (score) => {
    if (score >= 80) return "var(--accent)";
    if (score >= 60) return "var(--primary)";
    if (score >= 40) return "var(--warning)";
    return "var(--danger)";
  };

  const getRecClass = (rec) => {
    const r = rec.toLowerCase().replace(/\s+/g, "-");
    if (r === "strong-hire") return "rec-strong-hire";
    if (r === "hire") return "rec-hire";
    if (r === "lean-hire") return "rec-lean-hire";
    if (r === "lean-no-hire") return "rec-lean-no";
    return "rec-no-hire";
  };

  let html = "";

  // Overall score
  if (overallScore !== null) {
    html += `<div class="score-header">
      <div class="score-big">${overallScore}</div>
      <div class="score-verdict">${verdict}</div>
    </div>`;
  }

  // Dimension grid
  if (dims.length > 0) {
    html += `<div class="dimension-grid">`;
    dims.forEach(d => {
      const color = getColor(d.score);
      html += `<div class="dim-card">
        <div class="dim-name">${d.name}</div>
        <div class="dim-score" style="color:${color}">${d.score}</div>
        <div class="dim-bar"><div class="dim-bar-fill" style="width:${d.score}%; background:${color}"></div></div>
      </div>`;
    });
    html += `</div>`;
  }

  // Strengths
  if (strengths.length) {
    html += `<div class="score-section"><h4>üí™ Top Strengths</h4><ul class="strength-list">`;
    strengths.forEach(s => html += `<li>${s}</li>`);
    html += `</ul></div>`;
  }

  // Concerns
  if (concerns.length && !concerns[0].toLowerCase().includes("none")) {
    html += `<div class="score-section"><h4>üö© Red Flags</h4><ul class="concern-list">`;
    concerns.forEach(c => html += `<li>${c}</li>`);
    html += `</ul></div>`;
  }

  // Improvements
  if (improvements.length) {
    html += `<div class="score-section"><h4>üìà Improvement Areas</h4><ul class="improve-list">`;
    improvements.forEach(a => html += `<li>${a}</li>`);
    html += `</ul></div>`;
  }

  // Recommendation
  if (recommendation) {
    html += `<div class="score-section" style="text-align:center;">
      <h4>üèÜ Hiring Recommendation</h4>
      <div class="recommendation-badge ${getRecClass(recommendation)}">${recommendation}</div>
      ${recJustification ? `<p style="margin-top:12px; font-size:0.9rem; color:var(--text-secondary); line-height:1.6;">${recJustification}</p>` : ""}
    </div>`;
  }

  card.innerHTML = html;
  chat.appendChild(card);
  chat.scrollTop = chat.scrollHeight;
}

// ============================================
// ADMIN PANEL
// ============================================
function openAdmin() { document.getElementById("adminOverlay").classList.add("active"); }
function closeAdmin() { document.getElementById("adminOverlay").classList.remove("active"); }

async function adminGenCode() {
  const label = document.getElementById("adminLabel").value.trim() || "user";
  const duration = document.getElementById("adminDuration").value;
  try {
    const data = await apiCall("admin-gen", { duration, label });
    const code = data.code || data.reply;
    document.getElementById("adminGenResult").innerHTML =
      `<div class="code-item" style="border-color:var(--accent); margin-top:8px;">
        <span style="color:var(--accent); font-weight:700;">${code}</span>
        <span class="code-item-label">${label} ¬∑ ${duration}h</span>
      </div>`;
    showToast("‚úÖ Code generated!");
    adminListCodes();
  } catch(e) { console.error(e); }
}

async function adminListCodes() {
  try {
    const data = await apiCall("admin-list");
    const list = document.getElementById("codeList");
    list.innerHTML = "";
    if (!data.codes || data.codes.length === 0) {
      list.innerHTML = `<div style="color:var(--text-muted); font-size:0.85rem; padding:12px;">No active codes</div>`;
      return;
    }
    data.codes.forEach(c => {
      let parsed = {};
      try { parsed = JSON.parse(c.data); } catch(e) { parsed = { label: c.data }; }
      const item = document.createElement("div");
      item.className = "code-item";
      item.innerHTML = `<span>${c.code}</span><span class="code-item-label">${parsed.label || ""} ¬∑ ${parsed.expiresIn || ""}</span>`;
      list.appendChild(item);
    });
  } catch(e) { console.error(e); }
}

// ============================================
// LIFECYCLE HANDLERS
// ============================================

// Resume mic when tab becomes visible again
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && isInterviewActive && !engine.isPaused) {
    setTimeout(() => {
      if (!engine.isListening) engine.resume();
    }, 300);
  }
});

// iOS audio context resume
document.addEventListener("touchstart", () => {
  if (engine.audioContext && engine.audioContext.state === "suspended") {
    engine.audioContext.resume();
  }
}, { once: true });

// Prevent accidental close during interview
window.addEventListener("beforeunload", (e) => {
  if (isInterviewActive) { e.preventDefault(); e.returnValue = ""; }
});

// Enter key on access code
document.getElementById("accessCode").addEventListener("keydown", (e) => {
  if (e.key === "Enter") startInterview();
});
</script>
</body>
</html>
