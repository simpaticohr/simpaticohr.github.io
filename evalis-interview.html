<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Evalis AI Interview</title>
  <style>
    body {
      background:#0f172a;
      color:white;
      font-family:sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    .card {
      background:#1e293b;
      padding:20px;
      border-radius:16px;
      width:420px;
    }
    button {
      width:100%;
      padding:12px;
      margin-top:10px;
      border:none;
      border-radius:10px;
      background:#4f46e5;
      color:white;
      font-weight:bold;
    }
    #log {
      margin-top:15px;
      background:#020617;
      padding:12px;
      height:200px;
      overflow:auto;
      border-radius:10px;
      font-size:13px;
    }
  </style>
</head>
<body>

<div class="card">
  <h3>Evalis AI Interview</h3>
  <button id="start">Start Speaking</button>
  <div id="log"></div>
</div>

<script>
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

let audioCtx;
let processor;
let input;
let stream;
let pcmData = [];

const log = t => {
  const d = document.createElement("div");
  d.textContent = t;
  document.getElementById("log").appendChild(d);
};

document.getElementById("start").onclick = async () => {
  pcmData = [];

  audioCtx = new AudioContext({ sampleRate: 16000 });
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  input = audioCtx.createMediaStreamSource(stream);

  processor = audioCtx.createScriptProcessor(4096, 1, 1);
  input.connect(processor);
  processor.connect(audioCtx.destination);

  processor.onaudioprocess = e => {
    const channel = e.inputBuffer.getChannelData(0);
    pcmData.push(...channel);
  };

  log("ðŸŽ¤ Listening (5 seconds)...");

  setTimeout(stopAndSend, 5000);
};

async function stopAndSend() {
  processor.disconnect();
  input.disconnect();
  stream.getTracks().forEach(t => t.stop());

  // Convert float PCM â†’ int16
  const pcm16 = pcmData.map(x =>
    Math.max(-1, Math.min(1, x)) * 32767
  );

  log("ðŸ“¤ Sending audio to Whisper...");

  const fd = new FormData();
  fd.append("mode", "interview");
  fd.append("audio", new Blob([new Int16Array(pcm16)]));

  const res = await fetch(WORKER_URL, {
    method: "POST",
    body: fd
  });

  const data = await res.json();
  log("AI: " + data.reply);
}
</script>

</body>
</html>
