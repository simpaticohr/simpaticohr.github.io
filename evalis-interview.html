<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evalis AI – Live Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root { --primary:#6366f1; --bg:#020617; }
body {
  margin:0;
  background:var(--bg);
  color:white;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
}
.card {
  width:90%;
  max-width:440px;
  background:rgba(255,255,255,.05);
  border-radius:22px;
  padding:28px;
  text-align:center;
  border:1px solid rgba(255,255,255,.12);
}
button {
  background:var(--primary);
  color:white;
  border:none;
  padding:14px;
  border-radius:14px;
  width:100%;
  font-size:16px;
  font-weight:700;
  margin-top:10px;
}
button:disabled { opacity:.35; }
#log {
  margin-top:20px;
  max-height:220px;
  overflow-y:auto;
  text-align:left;
  font-size:14px;
}
.msg { margin-bottom:8px; }
.msg b { color:var(--primary); }
small { color:#94a3b8; }
</style>
</head>

<body>

<div class="card">
  <h2 id="timer">15:00</h2>
  <p id="status">Upload resume to begin</p>

  <input type="file" id="cvInput" accept="application/pdf">
  <small id="uploadStatus"></small>

  <button id="startBtn" disabled>Start Interview</button>
  <button id="endBtn" style="display:none;background:#ef4444">End Interview</button>

  <div id="log"></div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ================= STATE ================= */
let cvText = "";
let history = [];
let interviewActive = false;

/* ================= TIMER ================= */
let timeLeft = 15 * 60;
let timerInterval = null;

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      document.getElementById("endBtn").click();
    }
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    document.getElementById("timer").textContent =
      `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }, 1000);
}

/* ================= SAFE FETCH ================= */
function fetchWithTimeout(url, options = {}, timeout = 15000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Request timeout")), timeout)
    )
  ]);
}

/* ================= UI ================= */
function addMsg(who, text) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<b>${who}:</b> ${text}`;
  document.getElementById("log").prepend(div);
}

/* ================= TTS + MIC ================= */
function speak(text) {
  if (typeof Android !== "undefined" && Android.speak) {
    Android.speak(text);
    setTimeout(() => {
      if (typeof AndroidSpeech !== "undefined") {
        AndroidSpeech.startListening();
      }
    }, Math.min(3500 + text.length * 30, 9000));
    return;
  }

  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.onend = () => {
    if (typeof AndroidSpeech !== "undefined") {
      AndroidSpeech.startListening();
    }
  };
  speechSynthesis.speak(u);
}

/* ================= FILE UPLOAD ================= */
document.getElementById("cvInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById("uploadStatus").textContent = "Reading resume…";
  document.getElementById("startBtn").disabled = true;

  try {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const c = await page.getTextContent();
      text += c.items.map(it => it.str).join(" ") + " ";
    }

    if (text.length < 50) throw new Error("Invalid resume");

    cvText = text;
    document.getElementById("uploadStatus").textContent = "Resume ready ✓";
    document.getElementById("startBtn").disabled = false;

  } catch {
    document.getElementById("uploadStatus").textContent = "Error reading PDF";
  }
};

/* ================= START INTERVIEW ================= */
document.getElementById("startBtn").onclick = async () => {
  interviewActive = true;
  startTimer();

  document.getElementById("startBtn").style.display = "none";
  document.getElementById("endBtn").style.display = "block";
  document.getElementById("status").textContent = "Connecting to AI…";

  const fd = new FormData();
  fd.append("mode", "start");
  fd.append("cvText", cvText);

  try {
    const r = await fetchWithTimeout(API, { method:"POST", body:fd });
    if (!r.ok) throw new Error("HTTP " + r.status);

    const d = await r.json();
    history = d.history || [];

    addMsg("AI", d.reply);
    speak(d.reply);
    document.getElementById("status").textContent = "Listening…";

  } catch (err) {
    document.getElementById("status").textContent = "AI connection failed";
    addMsg("System", err.message);
  }
};

/* ================= RECEIVE VOICE ================= */
window.receiveVoskText = text => {
  if (!interviewActive || !text) return;
  sendUserText(text);
};

async function sendUserText(text) {
  addMsg("You", text);
  document.getElementById("status").textContent = "AI thinking…";

  const fd = new FormData();
  fd.append("mode", "interview");
  fd.append("text", text);
  fd.append("history", JSON.stringify(history));
  fd.append("cvText", cvText);

  try {
    const r = await fetchWithTimeout(API, { method:"POST", body:fd });
    if (!r.ok) throw new Error("HTTP " + r.status);

    const d = await r.json();
    history = d.history || history;

    addMsg("AI", d.reply);
    speak(d.reply);
    document.getElementById("status").textContent = "Listening…";

  } catch (err) {
    document.getElementById("status").textContent = "AI error";
    addMsg("System", err.message);
  }
}

/* ================= END INTERVIEW ================= */
document.getElementById("endBtn").onclick = async () => {
  interviewActive = false;
  clearInterval(timerInterval);

  document.getElementById("status").textContent = "Generating feedback…";

  const fd = new FormData();
  fd.append("mode", "score");
  fd.append("history", JSON.stringify(history));

  try {
    const r = await fetchWithTimeout(API, { method:"POST", body:fd });
    const d = await r.json();

    document.body.innerHTML = `
      <div class="card">
        <h2>Interview Complete</h2>
        <pre style="white-space:pre-wrap">${d.reply}</pre>
        <button onclick="location.reload()">New Interview</button>
      </div>`;
  } catch {
    location.reload();
  }
};
</script>

</body>
</html>
