<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Simpatico HR ‚Äî AI Interview</title>
<meta name="theme-color" content="#050510">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root{--primary:#6366f1;--accent:#06d6a0;--danger:#ef4444;--warning:#f59e0b;--bg:#050510;--bg2:#0d0d1a;--border:rgba(255,255,255,.06);--text:#f0f0ff;--dim:#8888aa;--muted:#555577;--glass:rgba(255,255,255,.03);--R:16px;--Rs:12px;--Rx:8px}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--muted);border-radius:4px}

  /* BG */
  .bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .bg .orb{position:absolute;border-radius:50%;filter:blur(100px);opacity:.1;animation:oF 25s ease-in-out infinite}
  .o1{width:500px;height:500px;background:var(--primary);top:-150px;left:-100px}
  .o2{width:350px;height:350px;background:var(--accent);bottom:-80px;right:-80px;animation-delay:-8s}
  @keyframes oF{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(30px,-20px) scale(1.05)}}

  .z1{position:relative;z-index:1}
  .gc{background:var(--glass);border:1px solid rgba(255,255,255,.08);border-radius:var(--R);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px)}

  /* AUTH */
  .auth{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;gap:24px;padding:24px;text-align:center}
  .brand{display:flex;flex-direction:column;align-items:center;gap:10px}
  .brand-icon{width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 0 50px rgba(99,102,241,.3);animation:float 3s ease-in-out infinite}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  .brand h1{font-size:2.2rem;font-weight:800;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .brand p{color:var(--dim);font-size:.9rem}
  .acard{width:100%;max-width:440px;padding:36px 30px;display:flex;flex-direction:column;gap:20px}
  .fg{display:flex;flex-direction:column;gap:6px;text-align:left}
  .fl{font-size:.75rem;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.6px}
  .fi{width:100%;padding:14px;border-radius:var(--Rs);border:1.5px solid var(--border);background:rgba(0,0,0,.3);color:var(--text);font-size:16px;outline:none;transition:all .3s}
  .fi:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.25)}
  .fi::placeholder{color:var(--muted)}
  .uz{border:2px dashed rgba(255,255,255,.1);border-radius:var(--Rs);padding:28px;text-align:center;cursor:pointer;transition:all .3s}
  .uz:hover,.uz.dg{border-color:var(--primary);background:rgba(99,102,241,.04)}
  .uz.ok{border-color:var(--accent);border-style:solid;background:rgba(6,214,160,.04)}
  .btn{padding:14px 24px;border-radius:var(--Rs);border:none;font-size:.95rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px;user-select:none}
  .btn:active{transform:scale(.97)}.btn:disabled{opacity:.35;cursor:not-allowed}
  .bp{background:linear-gradient(135deg,var(--primary),#8b5cf6);color:#fff;box-shadow:0 4px 20px rgba(99,102,241,.3)}
  .bp:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 30px rgba(99,102,241,.4)}
  .ba{background:linear-gradient(135deg,var(--accent),#34d399);color:#000;box-shadow:0 4px 20px rgba(6,214,160,.3)}
  .bd{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.2)}
  .bg2{background:rgba(255,255,255,.05);color:var(--text);border:1px solid var(--border)}
  .bsm{padding:10px 16px;font-size:.85rem}.blg{padding:16px 32px;font-size:1.05rem}

  /* INTERVIEW */
  .iv{display:none}.iv.active{display:flex;flex-direction:column;min-height:100dvh}
  .topbar{padding:14px 20px;display:flex;justify-content:space-between;align-items:center;background:rgba(5,5,16,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
  .tb{display:flex;align-items:center;gap:10px}
  .tlogo{width:28px;height:28px;border-radius:7px;background:linear-gradient(135deg,var(--primary),#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:12px}
  .tname{font-weight:700;font-size:.9rem}
  .tmeta{display:flex;align-items:center;gap:12px}
  .timer{font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:600;color:var(--primary);background:rgba(99,102,241,.1);padding:4px 10px;border-radius:16px}
  .sbadge{font-size:.72rem;font-weight:600;padding:4px 10px;border-radius:16px}
  .s-listen{background:rgba(6,214,160,.12);color:var(--accent)}
  .s-speak{background:rgba(99,102,241,.12);color:var(--primary)}
  .s-think{background:rgba(245,158,11,.12);color:var(--warning)}
  .s-idle{background:rgba(85,85,119,.15);color:var(--muted)}

  /* ORB */
  .orb-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:24px}
  .orb-container{position:relative;width:200px;height:200px}
  .orb-glow{position:absolute;inset:-30px;border-radius:50%;filter:blur(40px);opacity:.3;transition:all .3s}
  .orb-main{width:200px;height:200px;border-radius:50%;position:relative;transition:all .3s;display:flex;align-items:center;justify-content:center}
  .orb-main canvas{border-radius:50%}
  .orb-label{font-size:.85rem;font-weight:500;color:var(--dim);text-align:center;min-height:24px;transition:all .3s}

  /* State colors */
  .orb-listening .orb-glow{background:var(--accent)}
  .orb-listening .orb-main{box-shadow:0 0 60px rgba(6,214,160,.2)}
  .orb-speaking .orb-glow{background:var(--primary)}
  .orb-speaking .orb-main{box-shadow:0 0 60px rgba(99,102,241,.2)}
  .orb-thinking .orb-glow{background:var(--warning)}
  .orb-thinking .orb-main{box-shadow:0 0 60px rgba(245,158,11,.2);animation:orbPulse 1.5s ease-in-out infinite}
  @keyframes orbPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

  /* TRANSCRIPT AREA */
  .transcript-area{width:100%;max-width:600px;max-height:200px;overflow-y:auto;padding:0 20px;scroll-behavior:smooth}
  .t-msg{margin-bottom:12px;animation:msgS .3s ease}
  @keyframes msgS{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .t-ai{text-align:left}
  .t-user{text-align:right}
  .t-bubble{display:inline-block;padding:10px 16px;border-radius:var(--Rs);font-size:.88rem;line-height:1.5;max-width:85%}
  .t-ai .t-bubble{background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.12)}
  .t-user .t-bubble{background:rgba(6,214,160,.08);border:1px solid rgba(6,214,160,.12)}
  .t-label{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;opacity:.5}
  .t-ai .t-label{color:var(--primary)}
  .t-user .t-label{color:var(--accent)}

  /* BOTTOM CONTROLS */
  .bottom-dock{padding:16px 20px;padding-bottom:calc(env(safe-area-inset-bottom,12px) + 12px);background:rgba(5,5,16,.9);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;justify-content:center;gap:12px}
  .score-row{display:none;width:100%;max-width:400px}.score-row.active{display:flex}

  /* TOAST */
  .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);padding:12px 24px;border-radius:var(--Rs);font-size:.88rem;font-weight:500;z-index:9999;transition:transform .4s cubic-bezier(.175,.885,.32,1.275);pointer-events:none;background:var(--bg2);border:1px solid rgba(255,255,255,.1);box-shadow:0 10px 40px rgba(0,0,0,.5)}
  .toast.show{transform:translateX(-50%) translateY(0)}

  /* ADMIN */
  .adm-ov{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:24px}
  .adm-ov.active{display:flex}
  .adm-panel{width:100%;max-width:440px;padding:28px;max-height:80dvh;overflow-y:auto}
  .adm-panel h2{font-size:1.2rem;font-weight:700;margin-bottom:20px;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .adm-s{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border)}.adm-s:last-child{border:none}
  .adm-l{font-size:.72rem;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
  .clist{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .citem{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(0,0,0,.3);border-radius:var(--Rx);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:.82rem}

  /* SCORE CARD */
  .sc{padding:24px;margin:12px 0;max-width:100%}.sc-h{text-align:center;margin-bottom:20px}
  .sc-big{font-size:3.5rem;font-weight:800;line-height:1;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .sc-v{font-size:.9rem;color:var(--dim);margin-top:4px}
  .dg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:16px 0}
  .di{padding:12px;border-radius:var(--Rx);background:rgba(0,0,0,.3);border:1px solid var(--border)}
  .dn{font-size:.7rem;color:var(--muted);text-transform:uppercase}.ds{font-size:1.5rem;font-weight:700;margin:3px 0}
  .db{height:3px;border-radius:2px;background:rgba(255,255,255,.06);overflow:hidden}.df{height:100%;border-radius:2px;transition:width 1s}
  .ss{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
  .ss h4{font-size:.75rem;color:var(--dim);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px}
  .ss ul{list-style:none;display:flex;flex-direction:column;gap:6px}
  .ss li{font-size:.88rem;padding-left:16px;position:relative;line-height:1.4}
  .ss li::before{content:'';position:absolute;left:0;top:7px;width:5px;height:5px;border-radius:50%}
  .lg li::before{background:var(--accent)}.lr li::before{background:var(--danger)}.ly li::before{background:var(--warning)}
  .rb{display:inline-block;padding:8px 20px;border-radius:20px;font-weight:700;font-size:.9rem;margin-top:6px}
  .r-sh{background:rgba(6,214,160,.12);color:var(--accent);border:1px solid rgba(6,214,160,.2)}
  .r-h{background:rgba(52,211,153,.1);color:#34d399;border:1px solid rgba(52,211,153,.18)}
  .r-lh{background:rgba(245,158,11,.1);color:var(--warning);border:1px solid rgba(245,158,11,.18)}
  .r-ln{background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.12)}
  .r-n{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.2)}

  @media(max-width:480px){.acard{padding:28px 22px}.brand h1{font-size:1.8rem}.orb-container{width:160px;height:160px}.orb-main{width:160px;height:160px}.dg{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="bg"><div class="orb o1"></div><div class="orb o2"></div></div>
<div class="toast" id="toast"></div>

<!-- ADMIN -->
<div class="adm-ov" id="admOv">
  <div class="adm-panel gc">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 style="margin:0">‚öôÔ∏è Admin</h2>
      <button class="btn bg2 bsm" onclick="document.getElementById('admOv').classList.remove('active')">‚úï</button>
    </div>
    <div class="adm-s">
      <div class="adm-l">Generate Code</div>
      <input class="fi" id="aLabel" placeholder="Label" style="margin-bottom:8px;font-family:inherit;letter-spacing:0;text-align:left">
      <div style="display:flex;gap:8px">
        <select class="fi" id="aDur" style="font-family:inherit;letter-spacing:0"><option value="1">1h</option><option value="6">6h</option><option value="24" selected>24h</option><option value="72">3d</option><option value="168">7d</option></select>
        <button class="btn bp bsm" onclick="aGen()">Go</button>
      </div>
      <div id="aRes" style="margin-top:10px"></div>
    </div>
    <div class="adm-s">
      <div class="adm-l">Active Codes</div>
      <button class="btn bg2 bsm" onclick="aList()" style="width:100%;margin-top:4px">üîÑ Refresh</button>
      <div class="clist" id="cList"></div>
    </div>
  </div>
</div>

<div class="z1">

<!-- AUTH -->
<div class="auth" id="authScreen">
  <div class="brand">
    <div class="brand-icon">üß†</div>
    <h1>Simpatico HR</h1>
    <p>AI-Powered Interview Intelligence</p>
  </div>
  <div class="acard gc">
    <div class="fg">
      <label class="fl">Access Code</label>
      <input class="fi" id="accessCode" placeholder="Enter code" autocomplete="off" spellcheck="false" style="font-family:'JetBrains Mono',monospace;letter-spacing:1.5px;text-align:center">
    </div>
    <div class="fg">
      <label class="fl">Resume</label>
      <div class="uz" id="upArea" onclick="document.getElementById('cvF').click()">
        <input type="file" id="cvF" accept=".pdf,.txt,.doc,.docx" hidden>
        <div style="font-size:2rem;margin-bottom:6px">üìÑ</div>
        <div style="font-size:.88rem;color:var(--dim)">Drop resume or click to upload</div>
        <div style="font-size:.78rem;color:var(--muted);margin-top:4px" id="fName">PDF, TXT, DOC</div>
      </div>
    </div>
    <button class="btn bp blg" style="width:100%" onclick="begin()" id="btnStart">üéôÔ∏è Begin Interview</button>
    <button class="btn bg2 bsm" id="admBtn" style="width:100%;display:none" onclick="document.getElementById('admOv').classList.add('active')">‚öôÔ∏è Admin</button>
    <p style="text-align:center;font-size:.7rem;color:var(--muted)">Simpatico HR Consultancy</p>
  </div>
</div>

<!-- INTERVIEW -->
<div class="iv" id="ivScreen">
  <div class="topbar">
    <div class="tb"><div class="tlogo">üß†</div><span class="tname">Simpatico HR</span></div>
    <div class="tmeta">
      <span class="timer" id="timer">00:00</span>
      <span class="sbadge s-idle" id="sBadge">Starting</span>
    </div>
  </div>

  <div class="orb-wrap">
    <!-- TRANSCRIPT -->
    <div class="transcript-area" id="tArea"></div>

    <!-- ORB -->
    <div class="orb-container orb-listening" id="orbWrap">
      <div class="orb-glow"></div>
      <div class="orb-main">
        <canvas id="orbCanvas" width="200" height="200"></canvas>
      </div>
    </div>
    <div class="orb-label" id="orbLabel">Listening...</div>
  </div>

  <div class="bottom-dock">
    <button class="btn bd" onclick="endIv()" id="endBtn">‚èπÔ∏è End Interview</button>
    <div class="score-row" id="scoreRow">
      <button class="btn ba blg" style="width:100%" onclick="getScore()">üìä Get Report</button>
    </div>
  </div>
</div>

</div>

<script>
const W = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let code="",cv="",hist=[],tRef=null,sec=0,active=false,sending=false;

// ============================================================
// ‚òÖ CONTINUOUS RECORDER ‚Äî Always-on mic, auto speech detection
// ============================================================
let stream=null, actx=null, analyser=null, micData=null;
let recorder=null, chunks=[], recording=false;
let speechStart=0, silenceStart=0, hasSpeech=false;
const VOL_SPEECH = 18;   // volume above = speaking
const VOL_SILENCE = 12;  // volume below = silence
const SILENCE_MS = 2500; // 2.5s silence after speech = send
const MIN_SPEECH = 800;  // min speech duration to send
let phase = "idle"; // idle | listening | sending | speaking

// Orb canvas
let orbCtx=null, orbAnim=null;

async function initAudio() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
    actx = new (window.AudioContext||window.webkitAudioContext)();
    analyser = actx.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.8;
    actx.createMediaStreamSource(stream).connect(analyser);
    micData = new Uint8Array(analyser.frequencyBinCount);
    console.log("[AUDIO] ‚úÖ Mic ready");
    return true;
  } catch(e) {
    console.error("[AUDIO] ‚ùå", e);
    toast("üéôÔ∏è Mic denied");
    return false;
  }
}

function getVolume() {
  if (!analyser) return 0;
  analyser.getByteFrequencyData(micData);
  let sum=0;
  for (let i=0; i<micData.length; i++) sum += micData[i];
  return sum / micData.length;
}

function startContinuousListening() {
  setPhase("listening");
  hasSpeech = false;
  speechStart = 0;
  silenceStart = 0;

  // Check volume every 100ms
  const monitor = setInterval(() => {
    if (phase !== "listening") { clearInterval(monitor); return; }
    if (!active) { clearInterval(monitor); return; }

    const vol = getVolume();

    if (vol > VOL_SPEECH) {
      // Speaking detected
      if (!hasSpeech) {
        hasSpeech = true;
        speechStart = Date.now();
        startChunkRecording();
        console.log("[LISTEN] üó£Ô∏è Speech detected");
      }
      silenceStart = 0;
    } else if (hasSpeech && vol < VOL_SILENCE) {
      // Silence after speech
      if (!silenceStart) silenceStart = Date.now();

      const silentFor = Date.now() - silenceStart;
      const spoke = Date.now() - speechStart;

      if (silentFor >= SILENCE_MS && spoke >= MIN_SPEECH) {
        console.log(`[LISTEN] ‚úÖ Auto-send (spoke ${(spoke/1000).toFixed(1)}s, silent ${(silentFor/1000).toFixed(1)}s)`);
        clearInterval(monitor);
        stopChunkRecording();
      }
    }
  }, 100);
}

function startChunkRecording() {
  if (recording) return;
  chunks = [];
  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
               MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
  recorder = new MediaRecorder(stream, { mimeType: mime });
  recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
  recorder.onstop = () => { recording = false; processAudio(); };
  recorder.start(200);
  recording = true;
}

function stopChunkRecording() {
  if (recorder && recording) {
    try { recorder.stop(); } catch(e) {}
  }
}

async function processAudio() {
  if (chunks.length === 0) { startContinuousListening(); return; }
  if (sending) { startContinuousListening(); return; }

  const blob = new Blob(chunks, { type: recorder?.mimeType || 'audio/webm' });
  if (blob.size < 1000) { console.log("[PROC] Too small"); startContinuousListening(); return; }

  sending = true;
  setPhase("sending");

  try {
    // Transcribe
    const fd = new FormData();
    fd.append("mode", "transcribe");
    fd.append("accessCode", code);
    fd.append("audio", blob, "audio.webm");
    const tres = await fetch(W, { method: "POST", body: fd });
    const tdata = await tres.json();
    const text = (tdata.text || "").trim();

    console.log("[WHISPER]", text);

    if (!text || text.length < 2) {
      console.log("[PROC] Empty transcript");
      sending = false;
      startContinuousListening();
      return;
    }

    addT("user", text);

    // AI respond
    const adata = await api("interview", { userMessage: text });
    hist = adata.history || hist;
    addT("ai", adata.reply);

    // Speak, then listen again
    sending = false;
    speakThen(adata.reply, () => {
      if (active) startContinuousListening();
    });

  } catch(e) {
    console.error("[PROC]", e);
    sending = false;
    if (active) startContinuousListening();
  }
}

function setPhase(p) {
  phase = p;
  const badge = document.getElementById("sBadge");
  const wrap = document.getElementById("orbWrap");
  const label = document.getElementById("orbLabel");

  switch(p) {
    case "listening":
      badge.className = "sbadge s-listen"; badge.textContent = "üéôÔ∏è Listening";
      wrap.className = "orb-container orb-listening";
      label.textContent = "Listening ‚Äî speak anytime...";
      break;
    case "sending":
      badge.className = "sbadge s-think"; badge.textContent = "‚è≥ Processing";
      wrap.className = "orb-container orb-thinking";
      label.textContent = "Processing your answer...";
      break;
    case "speaking":
      badge.className = "sbadge s-speak"; badge.textContent = "üîä AI Speaking";
      wrap.className = "orb-container orb-speaking";
      label.textContent = "AI is responding...";
      break;
    default:
      badge.className = "sbadge s-idle"; badge.textContent = "Ready";
      wrap.className = "orb-container";
      label.textContent = "";
  }
}

// ============================================================
// ORB ANIMATION ‚Äî Canvas-based, reacts to mic volume
// ============================================================
function initOrb() {
  const canvas = document.getElementById("orbCanvas");
  const w = canvas.width, h = canvas.height;
  orbCtx = canvas.getContext("2d");

  let t = 0;
  function draw() {
    t += 0.02;
    const vol = getVolume();
    const intensity = Math.min(vol / 60, 1); // 0-1 range

    orbCtx.clearRect(0, 0, w, h);

    const cx = w/2, cy = h/2;

    // Color based on phase
    let r, g, b;
    if (phase === "listening") { r=6; g=214; b=160; }
    else if (phase === "speaking") { r=99; g=102; b=241; }
    else if (phase === "sending") { r=245; g=158; b=11; }
    else { r=100; g=100; b=140; }

    // Multiple blob layers
    for (let layer = 3; layer >= 0; layer--) {
      const baseR = 50 + layer * 12;
      const wobble = (intensity * 20 + 3) * (1 + layer * 0.3);

      orbCtx.beginPath();
      for (let a = 0; a <= Math.PI * 2; a += 0.05) {
        const noise = Math.sin(a * 3 + t * (1 + layer * 0.5)) * wobble
                    + Math.sin(a * 5 - t * 0.7) * wobble * 0.5
                    + Math.cos(a * 2 + t * 1.3) * wobble * 0.3;
        const radius = baseR + noise;
        const x = cx + Math.cos(a) * radius;
        const y = cy + Math.sin(a) * radius;
        if (a === 0) orbCtx.moveTo(x, y);
        else orbCtx.lineTo(x, y);
      }
      orbCtx.closePath();

      const alpha = (0.15 + intensity * 0.15) * (1 - layer * 0.2);
      orbCtx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
      orbCtx.fill();
    }

    // Center bright core
    const coreR = 30 + intensity * 15;
    const grad = orbCtx.createRadialGradient(cx, cy, 0, cx, cy, coreR);
    grad.addColorStop(0, `rgba(${r},${g},${b},${0.6 + intensity * 0.3})`);
    grad.addColorStop(0.5, `rgba(${r},${g},${b},${0.2 + intensity * 0.1})`);
    grad.addColorStop(1, `rgba(${r},${g},${b},0)`);
    orbCtx.beginPath();
    orbCtx.arc(cx, cy, coreR, 0, Math.PI * 2);
    orbCtx.fillStyle = grad;
    orbCtx.fill();

    orbAnim = requestAnimationFrame(draw);
  }
  draw();
}

// ============================================================
// TTS
// ============================================================
let ttsWD=null, ttsPoll=null, ttsKA=null;

function speakThen(text, cb) {
  if (!('speechSynthesis' in window)) { if (cb) cb(); return; }

  setPhase("speaking");
  speechSynthesis.cancel();
  clearTimeout(ttsWD); clearInterval(ttsPoll); clearInterval(ttsKA);

  const u = new SpeechSynthesisUtterance(text);
  u.rate=1.05; u.pitch=1; u.volume=1;
  const v = speechSynthesis.getVoices();
  const pf = v.find(x => x.name.includes("Samantha")||x.name.includes("Google US")||x.name.includes("Microsoft Aria")||(x.lang==="en-US"&&x.localService));
  if (pf) u.voice = pf;

  let done=false;
  function fin() { if(done)return; done=true; clearTimeout(ttsWD); clearInterval(ttsPoll); clearInterval(ttsKA); speechSynthesis.cancel(); console.log("[TTS] ‚úÖ"); if(cb)cb(); }

  u.onend=fin; u.onerror=fin;
  const est=Math.max(text.length*90,3000)+2000;
  ttsWD=setTimeout(fin,est);
  let pc=0; ttsPoll=setInterval(()=>{pc++;if(!speechSynthesis.speaking&&pc>3){clearInterval(ttsPoll);fin()}if(pc>est/400+5){clearInterval(ttsPoll);fin()}},400);
  ttsKA=setInterval(()=>{if(speechSynthesis.speaking&&!speechSynthesis.paused){speechSynthesis.pause();speechSynthesis.resume()}else if(!speechSynthesis.speaking)clearInterval(ttsKA)},5000);

  speechSynthesis.speak(u);
}

if('speechSynthesis' in window){speechSynthesis.getVoices();speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices()}

// ============================================================
// UI
// ============================================================
function addT(role, text) {
  const area = document.getElementById("tArea");
  const div = document.createElement("div");
  div.className = `t-msg t-${role}`;
  div.innerHTML = `<div class="t-label">${role==="ai"?"üß† Simpatico":"üë§ You"}</div><div class="t-bubble">${esc(text)}</div>`;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function esc(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function toast(m){const t=document.getElementById("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),3500)}
function startTimer(){sec=0;tRef=setInterval(()=>{sec++;document.getElementById("timer").textContent=String(Math.floor(sec/60)).padStart(2,"0")+":"+String(sec%60).padStart(2,"0")},1000)}

async function api(mode, extra={}) {
  const fd=new FormData();fd.append("mode",mode);fd.append("accessCode",code);fd.append("cvText",cv);fd.append("history",JSON.stringify(hist));
  for(const[k,v]of Object.entries(extra))fd.append(k,v);
  const r=await fetch(W,{method:"POST",body:fd});const d=await r.json();
  if(!r.ok){toast(d.reply||"Error");throw new Error(d.reply)}return d;
}

// CV
document.getElementById("cvF").addEventListener("change",async e=>{
  const f=e.target.files[0];if(!f)return;
  document.getElementById("fName").textContent="‚úÖ "+f.name;
  document.getElementById("upArea").classList.add("ok");
  if(f.type==="text/plain")cv=await f.text();
  else if(f.type==="application/pdf"){try{const b=await f.arrayBuffer();const t=new TextDecoder().decode(b);const p=t.match(/[\x20-\x7E]{4,}/g);cv=p?p.join(" ").substring(0,4000):"[PDF]"}catch(e){cv="[PDF]"}}
  else cv="[File]";
  toast("‚úÖ Resume loaded!");
});

const upA=document.getElementById("upArea");
upA.addEventListener("dragover",e=>{e.preventDefault();upA.classList.add("dg")});
upA.addEventListener("dragleave",()=>upA.classList.remove("dg"));
upA.addEventListener("drop",e=>{e.preventDefault();upA.classList.remove("dg");if(e.dataTransfer.files[0]){document.getElementById("cvF").files=e.dataTransfer.files;document.getElementById("cvF").dispatchEvent(new Event("change"))}});
document.getElementById("accessCode").addEventListener("input",e=>{document.getElementById("admBtn").style.display=e.target.value.trim()==="ADMIN-MASTER-999"?"flex":"none"});

// ============================================================
// ‚òÖ INTERVIEW FLOW
// ============================================================
async function begin() {
  code=document.getElementById("accessCode").value.trim();
  if(!code){toast("‚ö†Ô∏è Enter code");return}

  const btn=document.getElementById("btnStart");
  btn.disabled=true;btn.innerHTML="‚è≥ Connecting...";

  const micOk=await initAudio();
  if(!micOk){btn.disabled=false;btn.innerHTML="üéôÔ∏è Begin Interview";return}

  try{
    const data=await api("start");

    document.getElementById("authScreen").style.display="none";
    document.getElementById("ivScreen").classList.add("active");
    active=true;
    hist=data.history||[];
    startTimer();
    initOrb();
    addT("ai",data.reply);

    // Speak greeting, then start continuous listening
    speakThen(data.reply, () => {
      if(active) startContinuousListening();
    });
  }catch(e){
    console.error(e);
    btn.disabled=false;btn.innerHTML="üéôÔ∏è Begin Interview";
  }
}

function endIv() {
  active=false;phase="idle";
  if(recording){try{recorder.stop()}catch(e){}}
  clearInterval(tRef);
  speechSynthesis.cancel();
  clearTimeout(ttsWD);clearInterval(ttsPoll);clearInterval(ttsKA);
  if(orbAnim)cancelAnimationFrame(orbAnim);
  setPhase("idle");

  document.getElementById("endBtn").style.display="none";
  document.getElementById("scoreRow").className="score-row active";
  document.getElementById("orbLabel").textContent="Interview ended";
  addT("ai","Interview complete. Generate your report below.");
  toast("‚èπÔ∏è Ended");
}

async function getScore() {
  document.getElementById("scoreRow").className="score-row";
  setPhase("sending");
  document.getElementById("orbLabel").textContent="Generating report...";
  toast("üìä Analyzing...");
  try{
    const d=await api("score");
    renderScore(d.reply);
    setPhase("idle");
    document.getElementById("orbLabel").textContent="Report ready ‚Üì";
  }catch(e){
    document.getElementById("scoreRow").className="score-row active";
    setPhase("idle");
    addT("ai","Failed. Try again.");
  }
}

// ============================================================
// SCORE
// ============================================================
function renderScore(raw) {
  const area=document.getElementById("tArea");
  const oM=raw.match(/OVERALL SCORE:\s*(\d+)/i),oS=oM?parseInt(oM[1]):null;
  const vM=raw.match(/OVERALL SCORE:\s*\d+\/?1?0?0?\s*[‚Äî\-‚Äì]\s*(.+)/i),vd=vM?vM[1].trim():"";
  const dims=[];
  [{n:"Technical",p:/Technical Depth:\s*(\d+)/i},{n:"Communication",p:/Communication:\s*(\d+)/i},{n:"Problem Solving",p:/Problem Solving:\s*(\d+)/i},{n:"Leadership",p:/Leadership[^:]*:\s*(\d+)/i},{n:"Cultural Fit",p:/Cultural Fit:\s*(\d+)/i}].forEach(d=>{const m=raw.match(d.p);if(m)dims.push({n:d.n,s:parseInt(m[1])})});
  function pL(t,h,nx){const re=new RegExp(h+"[:\\s]*([\\s\\S]*?)(?="+nx.join("|")+"|$)","i");const m=t.match(re);if(!m)return[];return m[1].split(/\n/).map(l=>l.replace(/^[\d.\-‚Ä¢*]+\s*/,"").trim()).filter(l=>l.length>3)}
  const str=pL(raw,"TOP STRENGTHS",["RED FLAG","CONCERN","IMPROVEMENT","HIRING"]);
  const con=pL(raw,"RED FLAGS?|CONCERNS?",["IMPROVEMENT","HIRING"]);
  const imp=pL(raw,"IMPROVEMENT AREAS?",["HIRING RECOMMENDATION"]);
  const rM=raw.match(/HIRING RECOMMENDATION:\s*(STRONG HIRE|HIRE|LEAN HIRE|LEAN NO HIRE|NO HIRE)/i),rec=rM?rM[1].toUpperCase():"";
  const rJM=raw.match(/HIRING RECOMMENDATION:[^\n]*\n([\s\S]*?)$/i),rJ=rJM?rJM[1].trim().split("\n").filter(l=>l.trim()).join(" "):"";

  if(!oS&&!dims.length){addT("ai",raw);return}

  const card=document.createElement("div");card.className="sc gc";card.style.animation="msgS .5s ease";
  const cl=s=>s>=80?"var(--accent)":s>=60?"var(--primary)":s>=40?"var(--warning)":"var(--danger)";
  const rc=r=>{const k=r.toLowerCase().replace(/\s+/g,"-");return{["strong-hire"]:"r-sh",hire:"r-h",["lean-hire"]:"r-lh",["lean-no-hire"]:"r-ln"}[k]||"r-n"};
  let h="";
  if(oS!==null)h+=`<div class="sc-h"><div class="sc-big">${oS}</div><div class="sc-v">${vd||"/100"}</div></div>`;
  if(dims.length){h+=`<div class="dg">`;dims.forEach(d=>{const c=cl(d.s);h+=`<div class="di"><div class="dn">${d.n}</div><div class="ds" style="color:${c}">${d.s}</div><div class="db"><div class="df" style="width:${d.s}%;background:${c}"></div></div></div>`});h+=`</div>`}
  if(str.length){h+=`<div class="ss"><h4>üí™ Strengths</h4><ul class="lg">`;str.forEach(s=>h+=`<li>${esc(s)}</li>`);h+=`</ul></div>`}
  if(con.length&&!con[0].toLowerCase().includes("none")){h+=`<div class="ss"><h4>üö© Red Flags</h4><ul class="lr">`;con.forEach(c=>h+=`<li>${esc(c)}</li>`);h+=`</ul></div>`}
  if(imp.length){h+=`<div class="ss"><h4>üìà Improve</h4><ul class="ly">`;imp.forEach(a=>h+=`<li>${esc(a)}</li>`);h+=`</ul></div>`}
  if(rec){h+=`<div class="ss" style="text-align:center"><h4>üèÜ Verdict</h4><div class="rb ${rc(rec)}">${rec}</div>${rJ?`<p style="margin-top:12px;font-size:.88rem;color:var(--dim);line-height:1.5">${esc(rJ)}</p>`:""}</div>`}
  card.innerHTML=h;area.appendChild(card);area.scrollTop=area.scrollHeight;
}

// ADMIN
async function aGen(){const l=document.getElementById("aLabel").value.trim()||"user",d=document.getElementById("aDur").value;try{const r=await api("admin-gen",{duration:d,label:l});document.getElementById("aRes").innerHTML=`<div class="citem" style="border-color:var(--accent)"><span style="color:var(--accent);font-weight:700">${r.code}</span></div>`;toast("‚úÖ "+r.code);aList()}catch(e){}}
async function aList(){try{const r=await api("admin-list");const l=document.getElementById("cList");l.innerHTML="";if(!r.codes||!r.codes.length){l.innerHTML=`<div style="color:var(--muted);padding:10px;font-size:.85rem">None</div>`;return}r.codes.forEach(c=>{let p={};try{p=JSON.parse(c.data)}catch(e){}const el=document.createElement("div");el.className="citem";el.innerHTML=`<span>${c.code}</span><span style="font-family:Inter;font-size:.72rem;color:var(--dim)">${p.label||""}</span>`;l.appendChild(el)})}catch(e){}}

// LIFECYCLE
document.addEventListener("touchstart",()=>{if(actx&&actx.state==="suspended")actx.resume()},{once:true});
window.addEventListener("beforeunload",e=>{if(active){e.preventDefault();e.returnValue=""}});
document.getElementById("accessCode").addEventListener("keydown",e=>{if(e.key==="Enter")begin()});
</script>
</body>
</html>
