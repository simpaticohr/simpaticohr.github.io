<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite AI Interviewer</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root {
  --bg:#0f172a;
  --card:#1e293b;
  --accent:#4f46e5;
  --muted:#94a3b8;
}
body{
  margin:0;
  background:var(--bg);
  color:white;
  font-family:Inter,system-ui,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.container{
  width:92%;
  max-width:480px;
  background:var(--card);
  padding:28px;
  border-radius:22px;
  border:1px solid #334155;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
}
#status{
  font-size:12px;
  letter-spacing:2px;
  color:var(--muted);
  margin-bottom:10px;
  text-transform:uppercase;
}
.timer{
  font-size:3rem;
  font-weight:800;
  color:var(--accent);
  text-align:center;
  font-family:monospace;
  margin:12px 0;
}
input[type=file]{
  width:100%;
  font-size:12px;
  color:var(--muted);
}
button{
  width:100%;
  margin-top:15px;
  padding:16px;
  border:none;
  border-radius:12px;
  background:var(--accent);
  color:white;
  font-weight:700;
  cursor:pointer;
}
button:disabled{
  opacity:.5;
  cursor:not-allowed;
}
#transcript{
  margin-top:20px;
  height:200px;
  overflow-y:auto;
  background:#020617;
  padding:14px;
  border-radius:12px;
  border:1px solid #334155;
  font-size:14px;
}
.ai{color:#a5b4fc;margin-bottom:10px}
.user{color:#94a3b8;font-style:italic;margin-bottom:8px}
</style>
</head>

<body>

<div class="container">
  <div id="status">Upload resume to begin</div>
  <div class="timer" id="timer">15:00</div>

  <input type="file" id="cvInput" accept=".pdf">
  <button id="startBtn" disabled>Start Interview</button>

  <div id="transcript"></div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let cvText = "";
let history = [];
let active = false;
let busy = false;
let timeLeft = 900;

/* ================= PDF PARSER ================= */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

document.getElementById("cvInput").onchange = async e => {
  const file = e.target.files[0];
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument(buffer).promise;

  let text = "";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const c = await page.getTextContent();
    text += c.items.map(x=>x.str).join(" ")+" ";
  }

  cvText = text.trim();
  document.getElementById("status").innerText = "Resume loaded";
  document.getElementById("startBtn").disabled = false;
};

/* ================= UI HELPERS ================= */
function addAI(t){
  transcript.innerHTML += `<div class="ai">AI: ${t}</div>`;
  transcript.scrollTop = transcript.scrollHeight;
}
function addUser(t){
  transcript.innerHTML += `<div class="user">You: ${t}</div>`;
  transcript.scrollTop = transcript.scrollHeight;
}

/* ================= SPEAK ================= */
function speak(text){
  if(!text) return;
  addAI(text);
  document.getElementById("status").innerText = "Interviewer speaking";

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1;
  u.pitch = .95;

  u.onend = ()=>{
    busy = false;
    if(active) setTimeout(startTurn,600);
  };

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ================= LISTEN LOOP ================= */
async function startTurn(){
  if(!active || busy || timeLeft<=0) return;
  busy = true;

  document.getElementById("status").innerText = "Listening";

  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const rec = new MediaRecorder(stream);
  const chunks = [];

  rec.ondataavailable = e=>chunks.push(e.data);

  rec.onstop = async ()=>{
    stream.getTracks().forEach(t=>t.stop());
    const audioBlob = new Blob(chunks,{type:"audio/webm"});

    // ---- silence guard ----
    if(audioBlob.size < 2000){
      busy = false;
      speak("Please speak clearly and answer in detail.");
      return;
    }

    document.getElementById("status").innerText = "Thinking";

    const fd = new FormData();
    fd.append("mode","interview");
    fd.append("audio",audioBlob);
    fd.append("cvText",cvText);
    fd.append("history",JSON.stringify(history));

    try{
      const res = await fetch(WORKER_URL,{method:"POST",body:fd});
      const data = await res.json();

      if(!data.transcript || data.transcript.length < 5){
        busy = false;
        speak("I could not hear you clearly. Please repeat.");
        return;
      }

      history = data.history;
      addUser(data.transcript);
      speak(data.reply);

    }catch{
      busy = false;
      speak("Connection issue. Please continue.");
    }
  };

  rec.start();
  setTimeout(()=>rec.state==="recording"&&rec.stop(),8000);
}

/* ================= TIMER ================= */
setInterval(()=>{
  if(!active) return;
  timeLeft--;
  const m=Math.floor(timeLeft/60);
  const s=timeLeft%60;
  timer.innerText=`${m}:${s<10?"0":""}${s}`;
  if(timeLeft<=0){
    active=false;
    speak("The interview has concluded. Thank you.");
  }
},1000);

/* ================= START ================= */
startBtn.onclick = async ()=>{
  active=true;
  busy=true;
  startBtn.style.display="none";

  const fd=new FormData();
  fd.append("mode","start");
  fd.append("cvText",cvText);

  const res=await fetch(WORKER_URL,{method:"POST",body:fd});
  const data=await res.json();

  history=data.history;
  speak(data.reply);
};
</script>

</body>
</html>
