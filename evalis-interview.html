<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Evalis AI â€“ Live Interview</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(circle at top, #0b1d3a, #020617);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: system-ui;
  color: white;
}
.card {
  width: 92%;
  max-width: 460px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(14px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 22px;
  padding: 26px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.6);
}
button {
  width: 100%;
  padding: 15px;
  margin-top: 12px;
  border: none;
  border-radius: 12px;
  background: #4f46e5;
  color: white;
  font-weight: 700;
  cursor: pointer;
}
button:disabled { opacity: 0.5; cursor: not-allowed; }
#status {
  font-size: 12px;
  color: #94a3b8;
  text-align: center;
  margin-bottom: 10px;
}
#log {
  margin-top: 18px;
  background: #020617;
  padding: 14px;
  height: 220px;
  overflow-y: auto;
  border-radius: 14px;
  font-size: 14px;
  border: 1px solid #334155;
}
.ai { color:#a5b4fc; margin-bottom: 10px; }
.user { color:#94a3b8; font-style: italic; margin-bottom: 10px; }
</style>
</head>

<body>
<div class="card">
  <h3>Evalis AI â€“ Live Interview</h3>
  <div id="status">Upload CV to start</div>

  <input type="file" id="cvInput" accept=".pdf">
  <button id="startBtn" disabled>Start Interview</button>
  <button id="endBtn" style="display:none;background:#ef4444">Finish Interview</button>

  <div id="log"></div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ================= STATE ================= */
let cvText = "";
let history = [];
let interviewActive = false;
let recognition;

/* ================= UI HELPERS ================= */
const logBox = document.getElementById("log");
const statusEl = document.getElementById("status");

function log(cls, text) {
  const div = document.createElement("div");
  div.className = cls;
  div.textContent = text;
  logBox.appendChild(div);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= PDF PARSER ================= */
document.getElementById("cvInput").onchange = async e => {
  const file = e.target.files[0];
  const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
  let text = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(s => s.str).join(" ") + " ";
  }
  cvText = text.trim();
  statusEl.textContent = "CV loaded. Ready.";
  document.getElementById("startBtn").disabled = false;
};

/* ================= SPEECH OUTPUT ================= */
function speak(text) {
  log("ai", "AI: " + text);
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.onend = () => {
    if (interviewActive) recognition.start(); // ðŸ” reopen mic
  };
  speechSynthesis.speak(u);
}

/* ================= SPEECH INPUT (REAL VAD) ================= */
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = async e => {
    const transcript = e.results[0][0].transcript.trim();
    log("user", "You: " + transcript);
    statusEl.textContent = "Thinkingâ€¦";

    const fd = new FormData();
    fd.append("mode", "interview");
    fd.append("cvText", cvText);
    fd.append("history", JSON.stringify(history));
    fd.append("text", transcript);

    const res = await fetch(API, { method: "POST", body: fd });
    const data = await res.json();

    history = data.history;
    speak(data.reply);
  };

  recognition.onerror = () => {
    if (interviewActive) recognition.start();
  };
}

/* ================= START ================= */
document.getElementById("startBtn").onclick = async () => {
  interviewActive = true;
  initRecognition();
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("endBtn").style.display = "block";
  statusEl.textContent = "Interview started";

  const fd = new FormData();
  fd.append("mode", "start");
  fd.append("cvText", cvText);

  const res = await fetch(API, { method: "POST", body: fd });
  const data = await res.json();
  history = data.history;
  speak(data.reply);
};

/* ================= END ================= */
document.getElementById("endBtn").onclick = async () => {
  interviewActive = false;
  recognition.stop();
  speechSynthesis.cancel();
  statusEl.textContent = "Generating reportâ€¦";

  const fd = new FormData();
  fd.append("mode", "score");
  fd.append("history", JSON.stringify(history));

  const res = await fetch(API, { method: "POST", body: fd });
  const data = await res.json();
  log("ai", "FINAL REPORT:\n" + data.reply);
};
</script>
</body>
</html>
