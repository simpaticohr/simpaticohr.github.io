<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Evalis AI Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin: 0;
  background: #020617;
  font-family: system-ui;
  color: #e5e7eb;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
.card {
  width: 380px;
  background: #0f172a;
  border-radius: 18px;
  padding: 26px;
  border: 1px solid #1e293b;
}
button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: #2563eb;
  color: white;
  font-weight: 600;
}
textarea {
  width: 100%;
  min-height: 90px;
  margin: 10px 0;
  border-radius: 10px;
}
</style>
</head>

<body>
<div class="card">

<h2>Evalis AI Interview</h2>

<input type="file" id="resumeInput" accept=".pdf,.txt" />
<p id="status">Upload resume to begin</p>
<p id="question"></p>

<textarea id="answer" placeholder="Type answer..."></textarea>

<button id="recordBtn">ðŸŽ¤ Speak Answer</button>
<button id="submitBtn">Submit</button>

</div>

<script>
/* ===== PDF CONFIG ===== */
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ===== RESUME PARSER ===== */
async function parseResume(file) {
  let text = "";
  if (file.type.includes("pdf")) {
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buf).promise;
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(i => i.str).join(" ");
    }
  } else {
    text = await file.text();
  }
  text = text.toLowerCase();
  return {
    role: text.match(/(content evaluator|developer|engineer|hr)/)?.[0] || "professional",
    skills: [...text.matchAll(/(python|javascript|ai|seo|nlp|quality)/g)].map(m => m[0]),
    company: text.match(/(google|amazon|telus|meta)/)?.[0] || "company"
  };
}

/* ===== INTERVIEW ENGINE (BRAIN) ===== */
function createInterview(p) {
  return {
    p,
    index: 0,
    questions: [
      `You worked as a ${p.role} at ${p.company}. What were your responsibilities?`,
      `How did you use ${p.skills[0] || "your skills"} in real work?`,
      `Describe a challenge you faced in this role.`,
      `What measurable impact did your work create?`
    ]
  };
}

function decideNext(answer, i) {
  if (answer.length < 40)
    return "Can you explain that in more detail?";
  i.index++;
  return i.questions[i.index] || null;
}

/* ===== VOICE + FLOW ===== */
let interview;
const resumeInput = document.getElementById("resumeInput");
const questionEl = document.getElementById("question");
const statusEl = document.getElementById("status");
const answerEl = document.getElementById("answer");

resumeInput.onchange = async () => {
  const profile = await parseResume(resumeInput.files[0]);
  interview = createInterview(profile);
  questionEl.innerText = interview.questions[0];
  statusEl.innerText = "Interview started";
};

document.getElementById("submitBtn").onclick = () => {
  const next = decideNext(answerEl.value, interview);
  answerEl.value = "";
  if (!next) {
    questionEl.innerText = "Interview complete âœ…";
    return;
  }
  questionEl.innerText = next;
};

/* ===== VOICE RECORD ===== */
document.getElementById("recordBtn").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const rec = new MediaRecorder(stream);
  let chunks = [];
  rec.ondataavailable = e => chunks.push(e.data);
  rec.onstop = async () => {
    const blob = new Blob(chunks, { type: "audio/webm" });
    const fd = new FormData();
    fd.append("audio", blob);

    const r = await fetch(
      "https://evalis-ai.simpaticohconsultancy.workers.dev",
      { method: "POST", body: fd }
    );
    const { transcript } = await r.json();
    answerEl.value = transcript;
  };
  rec.start();
  setTimeout(() => rec.stop(), 5000);
};
</script>

</body>
</html>
