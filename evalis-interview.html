<script>
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

let stage = "introduction";
let state = "idle";
let recognition;
let started = false;
let answerCaptured = false;

/* ---------- UI ---------- */
function setStatus(text="") {
  document.getElementById("status").textContent = text;
}
function setQuestion(text) {
  document.getElementById("question").textContent = text;
}

/* ---------- SPEAK ---------- */
function speak(text) {
  state = "speaking";
  setStatus("Speakingâ€¦");
  setQuestion(text);

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";

  u.onend = () => {
    state = "listening";
    startListening();
  };

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ---------- LISTEN (DESKTOP SAFE) ---------- */
function startListening() {
  if (state !== "listening") return;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("Speech recognition not supported");
    return;
  }

  recognition = new SR();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  let finalAnswer = "";
  answerCaptured = false;

  setStatus("Listeningâ€¦");

  recognition.onresult = (e) => {
    finalAnswer = e.results[0][0].transcript;
    answerCaptured = true;
  };

  recognition.onspeechend = () => {
    recognition.stop(); // ðŸ”‘ forces clean stop
  };

  recognition.onend = async () => {
    if (!answerCaptured || !finalAnswer.trim()) {
      setStatus("Listeningâ€¦");
      startListening(); // retry once, clean
      return;
    }

    state = "thinking";
    setStatus("Thinkingâ€¦");

    try {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          answer: finalAnswer,
          state: stage
        })
      });

      const data = await res.json();
      stage = data.nextState || stage;

      speak(data.followUp || "Tell me more.");

    } catch (e) {
      speak("Please repeat that.");
    }
  };

  recognition.onerror = () => {
    startListening();
  };

  recognition.start();
}

/* ---------- START ---------- */
document.getElementById("startBtn").onclick = () => {
  if (started) return;
  started = true;
  document.getElementById("startBtn").style.display = "none";
  speak("Tell me about yourself.");
};
</script>
