<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --bg: #06090f;
      --card: #0d1117;
      --card2: #161b22;
      --border: #21262d;
      --accent: #58a6ff;
      --accent2: #bc8cff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --text: #e6edf3;
      --text2: #8b949e;
      --glow: rgba(88,166,255,0.15);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background:
        radial-gradient(ellipse at 20% 0%, rgba(88,166,255,0.06) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(188,140,255,0.06) 0%, transparent 60%);
      z-index: 0; pointer-events: none;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
      z-index: 1;
    }

    /* ‚òÖ Header */
    .header { text-align: center; padding: 30px 0 20px; }
    .header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header p { color: var(--text2); font-size: 0.9rem; margin-top: 4px; }

    /* ‚òÖ Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 14px;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚òÖ Form */
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text2);
      margin: 12px 0 4px;
      font-weight: 500;
    }
    label:first-child { margin-top: 0; }

    select, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }
    select:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow);
    }
    select option { background: var(--card); }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* ‚òÖ Upload */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 12px;
    }
    .upload-area:hover { border-color: var(--accent); background: rgba(88,166,255,0.03); }
    .upload-area.ok { border-color: var(--green); background: rgba(63,185,80,0.05); }
    .upload-area p { font-size: 0.85rem; color: var(--text2); }
    .upload-area strong { color: var(--accent); }
    #fName { margin-top: 8px; font-size: 0.8rem; color: var(--text2); }

    /* ‚òÖ Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #fff;
      font-family: inherit;
    }
    .btn-go {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      margin-top: 16px;
    }
    .btn-go:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--glow);
    }
    .btn-go:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    /* ‚òÖ Progress */
    .progress-wrap {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      height: 8px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 20px;
      transition: width 0.5s ease;
      width: 0%;
    }
    .progress-text {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text2);
      margin-bottom: 16px;
    }

    /* ‚òÖ Screens */
    #interviewScreen { display: none; }
    #resultScreen { display: none; }

    /* ‚òÖ ORB */
    .orb-container {
      display: flex;
      justify-content: center;
      margin: 24px 0 16px;
    }
    .orb-wrap { text-align: center; }
    .orb {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%,
        rgba(88,166,255,0.8),
        rgba(188,140,255,0.6),
        rgba(88,166,255,0.3)
      );
      position: relative;
      animation: orbFloat 4s ease-in-out infinite;
      box-shadow:
        0 0 30px rgba(88,166,255,0.3),
        0 0 60px rgba(188,140,255,0.15),
        inset 0 0 30px rgba(255,255,255,0.1);
      margin: 0 auto;
    }
    .orb::before {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: var(--accent);
      border-right-color: var(--accent2);
      animation: orbSpin 3s linear infinite;
    }
    .orb::after {
      content: '';
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.2), transparent 70%);
      animation: orbPulse 2s ease-in-out infinite;
    }
    @keyframes orbFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }
    @keyframes orbSpin { to{transform:rotate(360deg);} }
    @keyframes orbPulse { 0%,100%{opacity:0.5;transform:scale(0.9);} 50%{opacity:1;transform:scale(1.1);} }

    .orb.speaking {
      background: radial-gradient(circle at 35% 35%, rgba(63,185,80,0.9), rgba(88,166,255,0.6), rgba(63,185,80,0.3));
      box-shadow: 0 0 40px rgba(63,185,80,0.4), 0 0 80px rgba(63,185,80,0.15), inset 0 0 30px rgba(255,255,255,0.1);
      animation: orbFloat 2s ease-in-out infinite, orbSpeak 0.5s ease-in-out infinite;
    }
    @keyframes orbSpeak { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-4px) scale(1.06);} }

    .orb.listening {
      background: radial-gradient(circle at 35% 35%, rgba(88,166,255,0.9), rgba(188,140,255,0.8), rgba(88,166,255,0.3));
      box-shadow: 0 0 40px rgba(88,166,255,0.5), 0 0 80px rgba(188,140,255,0.2), inset 0 0 30px rgba(255,255,255,0.1);
      animation: orbFloat 2s ease-in-out infinite, orbListen 1s ease-in-out infinite;
    }
    @keyframes orbListen { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-3px) scale(1.04);} }

    .orb.thinking {
      opacity: 0.6;
      animation: orbFloat 1.5s ease-in-out infinite;
    }

    .orb.processing {
      background: radial-gradient(circle at 35% 35%, rgba(210,153,34,0.9), rgba(188,140,255,0.6), rgba(210,153,34,0.3));
      box-shadow: 0 0 40px rgba(210,153,34,0.4), 0 0 80px rgba(210,153,34,0.15);
      animation: orbFloat 1.5s ease-in-out infinite;
    }

    .orb-label {
      margin-top: 12px;
      font-size: 0.8rem;
      color: var(--text2);
      letter-spacing: 1px;
    }

    /* ‚òÖ Status */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text2);
      margin-bottom: 12px;
    }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: blink 2s infinite;
    }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

    /* ‚òÖ Question */
    .question-box {
      background: linear-gradient(135deg, rgba(88,166,255,0.08), rgba(188,140,255,0.08));
      border: 1px solid rgba(88,166,255,0.15);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
      font-size: 1.1rem;
      line-height: 1.7;
      min-height: 70px;
      text-align: center;
    }

    /* ‚òÖ Error */
    .error-box {
      background: rgba(248,81,73,0.1);
      border: 1px solid rgba(248,81,73,0.3);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 12px;
      font-size: 0.85rem;
      color: var(--red);
      display: none;
    }
    .error-box.show { display: block; }

    /* ‚òÖ Thinking */
    .thinking {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text2);
      font-size: 0.85rem;
      margin: 12px 0;
    }
    .thinking-dots span {
      display: inline-block;
      width: 6px; height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: dot 1.2s infinite;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot { 0%,100%{opacity:0.2;transform:scale(0.8);} 50%{opacity:1;transform:scale(1.3);} }

    /* ‚òÖ Silence countdown */
    .silence-bar-wrap {
      width: 80%;
      max-width: 300px;
      margin: 12px auto;
      text-align: center;
      display: none;
    }
    .silence-bar-wrap.show { display: block; }
    .silence-bar {
      height: 4px;
      background: var(--card2);
      border-radius: 2px;
      overflow: hidden;
    }
    .silence-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s linear;
      width: 100%;
    }
    .silence-text {
      font-size: 0.75rem;
      color: var(--text2);
      margin-top: 4px;
    }

    /* ‚òÖ Waveform */
    .wave-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3px;
      height: 40px;
      margin: 12px 0;
    }
    .wave-bar {
      width: 4px; height: 8px;
      background: var(--accent);
      border-radius: 4px;
    }
    .wave-wrap.active .wave-bar {
      animation: wave 0.8s ease-in-out infinite alternate;
    }
    .wave-bar:nth-child(1) { animation-delay: 0s; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    .wave-bar:nth-child(6) { animation-delay: 0.3s; }
    .wave-bar:nth-child(7) { animation-delay: 0.2s; }
    .wave-bar:nth-child(8) { animation-delay: 0.1s; }
    .wave-bar:nth-child(9) { animation-delay: 0s; }
    @keyframes wave { from{height:8px;} to{height:36px;} }

    /* ‚òÖ Timer */
    .timer {
      text-align: center;
      font-size: 1.4rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin: 8px 0;
    }

    /* ‚òÖ Handsfree info */
    .hf-info {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text2);
      padding: 8px;
      background: rgba(88,166,255,0.05);
      border-radius: 8px;
      margin-bottom: 12px;
    }

    /* ‚òÖ End button only */
    .btn-end {
      background: rgba(248,81,73,0.15);
      color: var(--red);
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
    }

    /* ‚òÖ Results */
    .score-ring {
      width: 150px; height: 150px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }
    .score-inner { text-align: center; }
    .score-num { font-size: 2.2rem; font-weight: 800; }
    .score-max { font-size: 0.9rem; color: var(--text2); }
    .grade-badge {
      display: inline-block;
      padding: 4px 16px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    .fb-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
    }
    .fb-item .fb-q { font-weight: 600; color: var(--accent); margin-bottom: 4px; font-size: 0.9rem; }
    .fb-item .fb-score {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 8px;
      display: inline-block;
      margin-bottom: 6px;
    }
    .fb-item .fb-text { font-size: 0.85rem; color: var(--text2); line-height: 1.5; }

    /* ‚òÖ Toast */
    .toast-box {
      position: fixed; top: 16px; right: 16px; z-index: 9999;
      display: flex; flex-direction: column; gap: 8px;
    }
    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 0.85rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      animation: tIn 0.3s ease, tOut 0.3s ease 2.7s forwards;
    }
    @keyframes tIn { from{transform:translateX(120%);opacity:0;} to{transform:translateX(0);opacity:1;} }
    @keyframes tOut { to{transform:translateX(120%);opacity:0;} }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      .header h1 { font-size: 1.5rem; }
      .row2 { grid-template-columns: 1fr; }
      .orb { width: 90px; height: 90px; }
    }
  </style>
</head>

<body>
  <div class="toast-box" id="toasts"></div>

  <div class="container">
    <div class="header">
      <h1>üß† AI Interviewer</h1>
      <p>Intelligent ‚Ä¢ Adaptive ‚Ä¢ Unbiased</p>
    </div>

    <!-- ============================================================
         ‚òÖ SETUP SCREEN
         ============================================================ -->
    <div id="setupScreen">
      <div class="card">
        <h2>‚öôÔ∏è Interview Setup</h2>

        <label>üåê Language</label>
        <select id="langSel">
          <option value="en">English</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
          <option value="es">Espa√±ol (Spanish)</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
          <option value="fr">Fran√ßais (French)</option>
          <option value="de">Deutsch (German)</option>
          <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
        </select>

        <label>üíº Job Role</label>
        <select id="roleSel">
          <option value="">‚Äî Select Role ‚Äî</option>
          <option value="Frontend Developer">Frontend Developer</option>
          <option value="Backend Developer">Backend Developer</option>
          <option value="Full Stack Developer">Full Stack Developer</option>
          <option value="Mobile Developer">Mobile Developer</option>
          <option value="Data Scientist">Data Scientist / Analyst</option>
          <option value="DevOps Engineer">DevOps / Cloud Engineer</option>
          <option value="UI/UX Designer">UI/UX Designer</option>
          <option value="Product Manager">Product Manager</option>
          <option value="QA Engineer">QA / Test Engineer</option>
          <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
          <option value="Sales Representative">Sales / BDR</option>
          <option value="Marketing Manager">Marketing Manager</option>
          <option value="HR Recruiter">HR / Recruiter</option>
          <option value="Finance Analyst">Finance / Accounting</option>
          <option value="Customer Support">Customer Support</option>
          <option value="custom">‚úèÔ∏è Custom Role...</option>
        </select>

        <div id="customWrap" class="hidden">
          <label>Enter Role</label>
          <input type="text" id="customRole" placeholder="e.g. Blockchain Developer">
        </div>

        <div class="row2">
          <div>
            <label>üìä Level</label>
            <select id="levelSel">
              <option value="Fresher">Fresher / Entry</option>
              <option value="Junior">Junior (1-2 yrs)</option>
              <option value="Mid-Level" selected>Mid-Level (3-5 yrs)</option>
              <option value="Senior">Senior (5-10 yrs)</option>
              <option value="Lead">Lead / Principal (10+)</option>
            </select>
          </div>
          <div>
            <label>üî¢ Questions</label>
            <select id="qCount">
              <option value="5">5 (~10 min)</option>
              <option value="8">8 (~15 min)</option>
              <option value="10" selected>10 (~20 min)</option>
              <option value="15">15 (~30 min)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìÑ Resume (Optional)</h2>
        <div id="upArea" class="upload-area" onclick="document.getElementById('cvF').click()">
          <p>üìÇ Click to upload <strong>PDF, DOC, DOCX, TXT</strong></p>
          <p id="fName">No file selected</p>
          <input type="file" id="cvF" accept=".pdf,.doc,.docx,.txt" hidden>
        </div>
      </div>

      <button class="btn btn-go" id="startBtn" onclick="startInterview()">
        üöÄ Start Interview
      </button>
    </div>

    <!-- ============================================================
         ‚òÖ INTERVIEW SCREEN ‚Äî Hands-Free
         ============================================================ -->
    <div id="interviewScreen">
      <div class="card">
        <div class="progress-wrap"><div class="progress-fill" id="progBar"></div></div>
        <div class="progress-text" id="progText">Question 1 / 10</div>

        <div class="status-bar">
          <div class="status-dot"></div>
          <span id="statusText">Interview Active</span>
        </div>

        <!-- ORB -->
        <div class="orb-container">
          <div class="orb-wrap">
            <div class="orb" id="orb"></div>
            <div class="orb-label" id="orbLabel">Preparing...</div>
          </div>
        </div>

        <!-- Error -->
        <div class="error-box" id="errorBox"></div>

        <!-- Question -->
        <div class="question-box" id="questionBox">Preparing your first question...</div>

        <!-- Thinking -->
        <div class="thinking hidden" id="thinkBox">
          <div class="thinking-dots"><span></span><span></span><span></span></div>
          <span>Analyzing your response...</span>
        </div>

        <!-- Hands-free info -->
        <div class="hf-info" id="hfInfo">
          üé§ Hands-free mode ‚Äî Speak naturally. Your answer auto-submits after a pause.
        </div>

        <!-- Waveform -->
        <div class="wave-wrap" id="waveWrap">
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div>
        </div>

        <!-- Silence countdown bar -->
        <div class="silence-bar-wrap" id="silenceWrap">
          <div class="silence-bar">
            <div class="silence-fill" id="silenceFill"></div>
          </div>
          <div class="silence-text" id="silenceText">Auto-submit in 3s...</div>
        </div>

        <!-- Timer -->
        <div class="timer" id="timer">00:00</div>

        <!-- End button only -->
        <button class="btn btn-end" onclick="endEarly()">‚èπ End Interview Early</button>
      </div>
    </div>

    <!-- ============================================================
         ‚òÖ RESULT SCREEN
         ============================================================ -->
    <div id="resultScreen">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">üèÜ Interview Complete!</h2>
        <div class="score-ring" id="scoreRing">
          <div class="score-inner">
            <div class="score-num" id="scoreNum">0</div>
            <div class="score-max">/ 100</div>
          </div>
        </div>
        <div id="gradeBadge" class="grade-badge">‚Äî</div>
        <p id="scoreSummary" style="color:var(--text2);margin-bottom:20px;line-height:1.6;"></p>
      </div>

      <div class="card">
        <h2>üìù Detailed Feedback</h2>
        <div id="fbList"></div>
      </div>

      <button class="btn btn-go" onclick="location.reload()">üîÑ New Interview</button>
    </div>
  </div>

  <!-- ============================================================
       ‚òÖ JAVASCRIPT
       ============================================================ -->
  <script>
    // ‚òÖ‚òÖ‚òÖ YOUR CLOUDFLARE WORKER URL ‚òÖ‚òÖ‚òÖ
    const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev/";

    // ‚òÖ Hands-free config
    const SILENCE_TIMEOUT = 3.0;   // seconds of silence before auto-submit
    const MIN_ANSWER_LENGTH = 10;  // minimum characters to auto-submit

    // ‚òÖ State
    let cv = "";
    let lang = "en";
    let role = "";
    let level = "";
    let totalQ = 10;
    let currentQ = 0;
    let chatMessages = [];
    let answers = [];
    let recognition = null;
    let currentTranscript = "";
    let timerInterval = null;
    let seconds = 0;
    let isListening = false;
    let silenceTimer = null;
    let silenceCountdown = null;
    let lastSpeechTime = 0;
    let isSpeaking = false;         // TTS is speaking
    let isProcessing = false;       // AI is processing

    const langMap = {
      en: { speech: "en-US", tts: "en-US", name: "English" },
      hi: { speech: "hi-IN", tts: "hi-IN", name: "Hindi" },
      es: { speech: "es-ES", tts: "es-ES", name: "Spanish" },
      ar: { speech: "ar-SA", tts: "ar-SA", name: "Arabic" },
      fr: { speech: "fr-FR", tts: "fr-FR", name: "French" },
      de: { speech: "de-DE", tts: "de-DE", name: "German" },
      ur: { speech: "ur-PK", tts: "ur-PK", name: "Urdu" }
    };

    // ‚òÖ Toast
    function toast(m) {
      const c = document.getElementById("toasts");
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = m;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    function showError(msg) {
      const b = document.getElementById("errorBox");
      b.textContent = msg;
      b.classList.add("show");
      setTimeout(() => b.classList.remove("show"), 8000);
    }

    // ‚òÖ Custom role toggle
    document.getElementById("roleSel").addEventListener("change", e => {
      document.getElementById("customWrap").classList.toggle("hidden", e.target.value !== "custom");
    });

    // ‚òÖ Orb states
    function setOrb(state) {
      const orb = document.getElementById("orb");
      const label = document.getElementById("orbLabel");
      orb.className = "orb";

      switch(state) {
        case "speaking":
          orb.classList.add("speaking");
          label.textContent = "Speaking...";
          break;
        case "listening":
          orb.classList.add("listening");
          label.textContent = "Listening to you...";
          break;
        case "thinking":
          orb.classList.add("thinking");
          label.textContent = "Thinking...";
          break;
        case "processing":
          orb.classList.add("processing");
          label.textContent = "Processing answer...";
          break;
        default:
          label.textContent = "Ready";
      }
    }

    // ============================================================
    // ‚òÖ TTS
    // ============================================================
    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = () => {
        console.log("‚úÖ TTS voices:", speechSynthesis.getVoices().length);
      };
    }

    function speakText(text) {
      return new Promise((resolve) => {
        if (!('speechSynthesis' in window)) { resolve(); return; }

        speechSynthesis.cancel();
        isSpeaking = true;
        setOrb("speaking");

        setTimeout(() => {
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = langMap[lang].tts;
          utter.rate = 0.92;
          utter.pitch = 1;
          utter.volume = 1;

          const voices = speechSynthesis.getVoices();
          const match = voices.find(v => v.lang.startsWith(langMap[lang].tts.split('-')[0]));
          if (match) utter.voice = match;

          utter.onend = () => {
            isSpeaking = false;
            resolve();
          };
          utter.onerror = () => {
            isSpeaking = false;
            resolve();
          };

          speechSynthesis.speak(utter);
        }, 100);
      });
    }

    // ============================================================
    // ‚òÖ CV UPLOAD
    // ============================================================
    document.getElementById("cvF").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById("fName").textContent = "‚è≥ Processing...";
      document.getElementById("upArea").classList.remove("ok");

      try {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'txt') cv = await file.text();
        else if (ext === 'pdf') cv = await extractPDF(file);
        else if (ext === 'doc' || ext === 'docx') cv = await extractDOC(file);
        else cv = await file.text();

        cv = cv.replace(/\s+/g, ' ').replace(/[^\x20-\x7E\n]/g, '').trim().substring(0, 5000);
        if (cv.length < 30) { document.getElementById("fName").textContent = "‚ö†Ô∏è Try TXT format"; cv = ""; return; }

        document.getElementById("fName").textContent = `‚úÖ ${file.name} (${cv.length} chars)`;
        document.getElementById("upArea").classList.add("ok");
        toast("‚úÖ Resume loaded!");
      } catch(err) {
        document.getElementById("fName").textContent = "‚ùå Error";
        cv = "";
      }
    });

    async function extractPDF(file) {
      if (!window.pdfjsLib) return extractFallback(file);
      try {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let t = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const pg = await pdf.getPage(i);
          const c = await pg.getTextContent();
          t += c.items.map(x => x.str).join(' ') + "\n";
        }
        return t;
      } catch(e) { return extractFallback(file); }
    }

    async function extractDOC(file) {
      const buf = await file.arrayBuffer();
      if (file.name.endsWith('.docx')) {
        try {
          const t = new TextDecoder('utf-8').decode(new Uint8Array(buf));
          const m = t.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);
          if (m && m.length) return m.map(x => x.replace(/<[^>]+>/g, '')).join(' ');
        } catch(e) {}
      }
      return extractFallback(file);
    }

    async function extractFallback(file) {
      const buf = await file.arrayBuffer();
      const t = new TextDecoder('utf-8', { fatal: false }).decode(buf);
      const r = t.match(/[a-zA-Z0-9@.,:;!?\-/()\s]{5,}/g);
      if (!r) return "";
      return r.filter(s => (s.match(/[a-zA-Z]/g)||[]).length / s.length > 0.5 && s.trim().length > 5).join(' ');
    }

    // ============================================================
    // ‚òÖ CLOUDFLARE AI CALL
    // ============================================================
    async function callAI(messages) {
      console.log("[AI] Sending", messages.length, "messages");
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
          signal: controller.signal
        });
        clearTimeout(timeout);

        if (!res.ok) {
          const err = await res.text();
          throw new Error(`Error ${res.status}: ${err}`);
        }

        const data = await res.json();
        if (!data.response) throw new Error("Empty AI response");
        console.log("[AI] Got response:", data.response.substring(0, 100));
        return data.response;
      } catch(err) {
        clearTimeout(timeout);
        if (err.name === 'AbortError') throw new Error("Timed out. Try again.");
        throw err;
      }
    }

    // ============================================================
    // ‚òÖ SPEECH RECOGNITION ‚Äî Continuous Hands-Free
    // ============================================================
    function initSTT() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { toast("‚ö†Ô∏è Use Chrome for voice"); return; }

      recognition = new SR();
      recognition.lang = langMap[lang].speech;
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onresult = (e) => {
        let finalText = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            finalText += e.results[i][0].transcript + " ";
          }
        }

        if (finalText) {
          currentTranscript += finalText;
          lastSpeechTime = Date.now();
          console.log("[STT]", finalText);

          // Reset silence detection
          resetSilenceDetection();
          startSilenceDetection();
        }
      };

      recognition.onerror = (e) => {
        if (e.error !== 'no-speech' && e.error !== 'aborted') {
          console.error("[STT]", e.error);
        }
      };

      recognition.onend = () => {
        // Auto-restart if we should still be listening
        if (isListening && !isProcessing && !isSpeaking) {
          try { recognition.start(); } catch(e) {}
        }
      };
    }

    function startListening() {
      if (!recognition || isListening) return;
      isListening = true;
      currentTranscript = "";
      lastSpeechTime = Date.now();

      try { recognition.start(); } catch(e) {
        try { recognition.stop(); } catch(e2) {}
        setTimeout(() => { try { recognition.start(); } catch(e3) {} }, 200);
      }

      setOrb("listening");
      document.getElementById("waveWrap").classList.add("active");
      document.getElementById("hfInfo").textContent = "üé§ Listening ‚Äî Speak your answer naturally...";
      startTimer();
      startSilenceDetection();
    }

    function stopListening() {
      isListening = false;
      resetSilenceDetection();
      try { recognition.stop(); } catch(e) {}

      document.getElementById("waveWrap").classList.remove("active");
      stopTimer();
    }

    // ============================================================
    // ‚òÖ SILENCE DETECTION ‚Äî Auto-submit after pause
    // ============================================================
    function startSilenceDetection() {
      resetSilenceDetection();

      silenceTimer = setInterval(() => {
        if (!isListening || isProcessing || isSpeaking) return;

        const silentFor = (Date.now() - lastSpeechTime) / 1000;

        // Only show countdown if we have enough text
        if (currentTranscript.trim().length >= MIN_ANSWER_LENGTH && silentFor >= 1) {
          const remaining = Math.max(0, SILENCE_TIMEOUT - silentFor);
          const pct = (remaining / SILENCE_TIMEOUT) * 100;

          document.getElementById("silenceWrap").classList.add("show");
          document.getElementById("silenceFill").style.width = pct + "%";
          document.getElementById("silenceText").textContent =
            remaining > 0 ? `Auto-submitting in ${remaining.toFixed(1)}s...` : "Submitting...";

          // ‚òÖ AUTO-SUBMIT
          if (silentFor >= SILENCE_TIMEOUT) {
            console.log("[SILENCE] Auto-submitting after", SILENCE_TIMEOUT, "s silence");
            autoSubmit();
          }
        } else {
          document.getElementById("silenceWrap").classList.remove("show");
        }
      }, 200);
    }

    function resetSilenceDetection() {
      clearInterval(silenceTimer);
      silenceTimer = null;
      document.getElementById("silenceWrap").classList.remove("show");
      document.getElementById("silenceFill").style.width = "100%";
    }

    // ============================================================
    // ‚òÖ AUTO-SUBMIT (Hands-free)
    // ============================================================
    async function autoSubmit() {
      if (isProcessing) return;
      isProcessing = true;

      stopListening();
      setOrb("processing");

      const answer = currentTranscript.trim();
      if (!answer || answer.length < MIN_ANSWER_LENGTH) {
        // Not enough speech ‚Äî resume listening
        isProcessing = false;
        toast("üé§ Didn't catch that ‚Äî still listening...");
        setTimeout(() => startListening(), 500);
        return;
      }

      const question = document.getElementById("questionBox").textContent;
      answers.push({ question, answer, skipped: false });
      console.log(`[ANSWER Q${currentQ}]`, answer);
      currentTranscript = "";

      await getNextResponse(answer);
      isProcessing = false;
    }

    // ============================================================
    // ‚òÖ START INTERVIEW
    // ============================================================
    async function startInterview() {
      const roleSel = document.getElementById("roleSel").value;
      if (!roleSel) { toast("‚ùå Select a job role"); return; }

      role = roleSel === "custom" ? document.getElementById("customRole").value.trim() : roleSel;
      if (!role) { toast("‚ùå Enter a custom role"); return; }

      lang = document.getElementById("langSel").value;
      level = document.getElementById("levelSel").value;
      totalQ = parseInt(document.getElementById("qCount").value);

      const btn = document.getElementById("startBtn");
      btn.disabled = true;
      btn.textContent = "‚è≥ Connecting...";

      // Test worker
      try {
        const testRes = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: [{ role: "user", content: "Say OK" }] })
        });
        if (!testRes.ok) throw new Error("Worker error " + testRes.status);
      } catch(err) {
        toast("‚ùå Cannot connect: " + err.message);
        btn.disabled = false;
        btn.textContent = "üöÄ Start Interview";
        return;
      }

      const systemPrompt = `You are an expert AI interviewer conducting a professional ${level}-level interview for "${role}".

LANGUAGE: Respond ONLY in ${langMap[lang].name}.
${cv ? `\nCANDIDATE RESUME:\n${cv}\n` : ""}

RULES:
1. Ask exactly ${totalQ} main questions. Mix behavioral, technical, situational.
2. Use C.L.A.I.M. follow-ups for vague answers (Claims, Learning, Alternatives, Impact, Mechanism).
3. Follow-ups don't count toward ${totalQ} total.
4. Be conversational, professional, warm.
5. Adapt to ${level} level.
6. Never repeat topics.

Ask your FIRST question now. Output ONLY the question.`;

      chatMessages = [{ role: "system", content: systemPrompt }];

      // Switch screen
      document.getElementById("setupScreen").style.display = "none";
      document.getElementById("interviewScreen").style.display = "block";
      setOrb("thinking");
      showThinking(true);

      try {
        const firstQ = await callAI(chatMessages);
        chatMessages.push({ role: "assistant", content: firstQ });

        showThinking(false);
        document.getElementById("questionBox").textContent = firstQ;
        updateProgress();

        initSTT();

        // ‚òÖ Speak question, then auto-start listening
        await speakText(firstQ);
        startListening();

        toast("üéØ Interview started ‚Äî speak naturally!");
      } catch(err) {
        console.error(err);
        showError("‚ùå " + err.message);
        showThinking(false);
        document.getElementById("questionBox").textContent = "‚ùå Error. Check console (F12).";
        setOrb("idle");
      }

      btn.disabled = false;
      btn.textContent = "üöÄ Start Interview";
    }

    // ============================================================
    // ‚òÖ GET NEXT QUESTION / FOLLOW-UP
    // ============================================================
    async function getNextResponse(answerText) {
      showThinking(true);
      setOrb("thinking");

      const prompt = `The candidate answered: "${answerText}"

This was answer ${currentQ} of ${totalQ}.

Decide:
1. If vague/unverified ‚Üí C.L.A.I.M. follow-up. Prefix: [FOLLOWUP]
2. If thorough ‚Üí next main question. Prefix: [NEXT]
${currentQ >= totalQ ? "3. LAST question done. Prefix: [DONE] and briefly thank candidate." : ""}

Output ONLY prefix + question. Stay in ${langMap[lang].name}.`;

      chatMessages.push({ role: "user", content: prompt });

      try {
        const response = await callAI(chatMessages);
        chatMessages.push({ role: "assistant", content: response });

        showThinking(false);

        const cleaned = response
          .replace(/\[FOLLOWUP\]\s*/i, '')
          .replace(/\[NEXT\]\s*/i, '')
          .replace(/\[DONE\]\s*/i, '')
          .trim();

        if (response.toUpperCase().includes("[DONE]") || currentQ >= totalQ) {
          document.getElementById("questionBox").textContent = cleaned;
          await speakText(cleaned);
          setTimeout(() => showResults(), 2000);
          return;
        }

        if (response.toUpperCase().includes("[NEXT]")) {
          currentQ++;
        }

        document.getElementById("questionBox").textContent = cleaned;
        updateProgress();

        // ‚òÖ Speak, then auto-listen
        await speakText(cleaned);
        startListening();

      } catch(err) {
        console.error(err);
        showError("‚ùå " + err.message);
        showThinking(false);
        setOrb("idle");
      }
    }

    // ‚òÖ End early
    function endEarly() {
      if (answers.length < 1) { toast("‚ö†Ô∏è Answer at least 1 question"); return; }
      stopListening();
      speechSynthesis.cancel();
      showResults();
    }

    // ============================================================
    // ‚òÖ TIMER
    // ============================================================
    function startTimer() {
      seconds = 0; showTime();
      timerInterval = setInterval(() => { seconds++; showTime(); }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }
    function showTime() {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      document.getElementById("timer").textContent = `${m}:${s}`;
    }

    // ============================================================
    // ‚òÖ PROGRESS & THINKING
    // ============================================================
    function updateProgress() {
      const pct = Math.round((currentQ / totalQ) * 100);
      document.getElementById("progBar").style.width = pct + "%";
      document.getElementById("progText").textContent = `Question ${Math.min(currentQ + 1, totalQ)} of ${totalQ} ‚Äî ${pct}%`;
    }

    function showThinking(show) {
      document.getElementById("thinkBox").classList.toggle("hidden", !show);
      document.getElementById("waveWrap").style.display = show ? "none" : "flex";
      document.getElementById("hfInfo").style.display = show ? "none" : "block";
      document.getElementById("silenceWrap").classList.remove("show");
      if (show) document.getElementById("questionBox").textContent = "";
    }

    // ============================================================
    // ‚òÖ RESULTS
    // ============================================================
    async function showResults() {
      stopListening();
      speechSynthesis.cancel();
      document.getElementById("interviewScreen").style.display = "none";
      document.getElementById("resultScreen").style.display = "block";
      toast("üìä Generating evaluation...");

      const qaPairs = answers.map((a, i) =>
        `Q${i+1}: ${a.question}\nA${i+1}: ${a.skipped ? "[SKIPPED]" : a.answer}`
      ).join('\n\n');

      const evalMessages = [
        {
          role: "system",
          content: `You are an expert interview evaluator. Be fair and constructive. Respond in ${langMap[lang].name} for text.`
        },
        {
          role: "user",
          content: `Evaluate this ${level}-level interview for "${role}".

INTERVIEW:
${qaPairs}

RESPOND IN STRICT JSON ONLY (no markdown, no code fences):
{
  "overallScore": 0-100,
  "grade": "A+/A/B+/B/C+/C/D/F",
  "summary": "2-3 sentence assessment",
  "feedback": [
    { "question": "short text", "score": 0-10, "comment": "feedback" }
  ]
}

Skipped = 0. Be honest.`
        }
      ];

      try {
        const raw = await callAI(evalMessages);
        const cleaned = raw.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const jsonStr = cleaned.match(/\{[\s\S]*\}/)?.[0] || cleaned;
        const result = JSON.parse(jsonStr);
        renderResults(result);
        toast("üèÜ Evaluation complete!");
      } catch(err) {
        console.error(err);
        document.getElementById("scoreNum").textContent = "?";
        document.getElementById("scoreSummary").textContent = "Error: " + err.message;
      }
    }

    function renderResults(r) {
      const score = r.overallScore || 0;
      const grade = r.grade || "?";
      const isGood = score >= 80;
      const isOk = score >= 60;
      const color = isGood ? '#3fb950' : isOk ? '#d29922' : '#f85149';
      const colorBg = isGood ? 'rgba(63,185,80,0.15)' : isOk ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';

      document.getElementById("scoreRing").style.background =
        `conic-gradient(${color} ${score * 3.6}deg, rgba(255,255,255,0.05) 0deg)`;

      const badge = document.getElementById("gradeBadge");
      badge.textContent = `Grade: ${grade}`;
      badge.style.background = colorBg;
      badge.style.color = color;

      document.getElementById("scoreSummary").textContent = r.summary || "";

      const list = document.getElementById("fbList");
      list.innerHTML = "";
      (r.feedback || []).forEach((fb, i) => {
        const sc = fb.score || 0;
        const c = sc >= 7 ? '#3fb950' : sc >= 5 ? '#d29922' : '#f85149';
        const bg = sc >= 7 ? 'rgba(63,185,80,0.15)' : sc >= 5 ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';
        const div = document.createElement("div");
        div.className = "fb-item";
        div.innerHTML = `
          <div class="fb-q">Q${i+1}: ${fb.question}</div>
          <span class="fb-score" style="background:${bg};color:${c};">${sc}/10</span>
          <div class="fb-text">${fb.comment}</div>`;
        list.appendChild(div);
      });

      let cur = 0;
      const el = document.getElementById("scoreNum");
      const iv = setInterval(() => {
        cur += Math.ceil(score / 30);
        if (cur >= score) { cur = score; clearInterval(iv); }
        el.textContent = cur;
      }, 30);
    }

    // ‚òÖ Init
    window.addEventListener('DOMContentLoaded', () => {
      if (window.pdfjsLib) console.log("‚úÖ PDF.js v" + pdfjsLib.version);
      if (!window.SpeechRecognition && !window.webkitSpeechRecognition)
        console.warn("‚ö†Ô∏è SpeechRecognition ‚Äî use Chrome");
      if (WORKER_URL.includes("YOUR-NAME"))
        console.error("‚ùå Update WORKER_URL with your actual Cloudflare Worker URL!");
    });
  </script>
</body>
</html>
