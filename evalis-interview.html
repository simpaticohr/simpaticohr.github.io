<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Evalis AI - Elite Interviewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { background:#0f172a; color:white; font-family:sans-serif; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
        .card { background:#1e293b; padding:30px; border-radius:20px; width:90%; max-width:450px; border:1px solid #334155; text-align:center; position:relative; }
        #status { font-size:12px; color:#4f46e5; text-transform:uppercase; font-weight:bold; margin-bottom:15px; }
        #transcript { background:#020617; padding:15px; border-radius:10px; height:200px; overflow-y:auto; text-align:left; font-size:13px; margin:20px 0; border:1px solid #1e293b; }
        button { width:100%; padding:15px; border-radius:10px; cursor:pointer; font-weight:bold; border:none; transition:0.3s; margin-top:10px; }
        .btn-start { background:#4f46e5; color:white; }
        .btn-stop { background:#ef4444; color:white; display:none; }
        #score-view { display:none; position:absolute; inset:0; background:#1e293b; z-index:10; padding:20px; border-radius:20px; overflow-y:auto; }
    </style>
</head>
<body>
    <div class="card">
        <div id="score-view">
            <h2>Final Report</h2>
            <div id="score-text" style="text-align:left; font-size:14px; white-space: pre-wrap;"></div>
            <button onclick="location.reload()" class="btn-start">Exit</button>
        </div>

        <div id="status">Upload CV to Begin</div>
        <input type="file" id="cvInput" accept=".pdf" style="margin-bottom:20px;">
        <div id="transcript"></div>
        <button id="startBtn" class="btn-start" disabled>Start Interview</button>
        <button id="stopBtn" class="btn-stop">End & Get Score</button>
    </div>

<script>
const WORKER_URL = "https://your-worker-url.workers.dev"; // UPDATE THIS
let cvText = "", history = [], active = false, busy = false;

// 1. CV Text Extraction
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
cvInput.onchange = async e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = async function() {
        const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
        let t = "";
        for(let i=1; i<=pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            t += content.items.map(s => s.str).join(" ") + " ";
        }
        cvText = t.trim();
        startBtn.disabled = false;
        document.getElementById("status").innerText = "Resume Ready";
    };
    reader.readAsArrayBuffer(file);
};

// 2. Continuous Voice Loop
function speak(text) {
    const ts = document.getElementById("transcript");
    ts.innerHTML += `<div style="color:#a5b4fc; margin-bottom:8px;">AI: ${text}</div>`;
    ts.scrollTop = ts.scrollHeight;
    
    const u = new SpeechSynthesisUtterance(text);
    // When AI stops talking, the mic automatically opens
    u.onend = () => { if(active) listen(); };
    speechSynthesis.speak(u);
}

async function listen() {
    if(!active) return;
    document.getElementById("status").innerText = "Listening...";
    
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const rec = new MediaRecorder(stream);
    const chunks = [];
    rec.ondataavailable = e => chunks.push(e.data);
    
    rec.onstop = async () => {
        stream.getTracks().forEach(t => t.stop());
        document.getElementById("status").innerText = "Thinking...";
        
        const fd = new FormData();
        fd.append("mode", "interview");
        fd.append("audio", new Blob(chunks, { type: "audio/webm" }));
        fd.append("cvText", cvText);
        fd.append("history", JSON.stringify(history));

        const res = await fetch(WORKER_URL, { method: "POST", body: fd });
        const data = await res.json();
        if(data.transcript) {
            document.getElementById("transcript").innerHTML += `<div style="color:#94a3b8; font-style:italic;">You: ${data.transcript}</div>`;
        }
        history = data.history || history;
        speak(data.reply);
    };

    rec.start();
    // Auto-record in 6-second segments for continuous flow
    setTimeout(() => { if(rec.state === "recording") rec.stop(); }, 6000);
}

// 3. Final Scoring Logic
stopBtn.onclick = async () => {
    active = false;
    speechSynthesis.cancel();
    document.getElementById("score-view").style.display = "block";
    
    const fd = new FormData();
    fd.append("mode", "score");
    fd.append("cvText", cvText);
    fd.append("history", JSON.stringify(history));

    const res = await fetch(WORKER_URL, { method: "POST", body: fd });
    const data = await res.json();
    document.getElementById("score-text").innerText = data.reply;
};

// 4. Initial Start
startBtn.onclick = async () => {
    active = true;
    startBtn.style.display = "none";
    stopBtn.style.display = "block";
    cvInput.style.display = "none";
    
    const fd = new FormData();
    fd.append("mode", "start");
    fd.append("cvText", cvText);
    const res = await fetch(WORKER_URL, { method: "POST", body: fd });
    const data = await res.json();
    history = data.history;
    speak(data.reply);
};
</script>
</body>
</html>
