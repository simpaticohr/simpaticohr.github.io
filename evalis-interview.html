<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Career Lab AI â€“ Voice Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root {
  --bg:#0f172a;
  --card:#111827;
  --accent:#2563eb;
  --danger:#dc2626;
  --text:#e5e7eb;
  --muted:#94a3b8;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--text);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:16px;
}
.card{
  width:100%;
  max-width:420px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:22px;
  padding:26px;
  backdrop-filter:blur(10px);
}
h2{margin:0 0 6px}
#status{color:var(--muted);font-size:14px;margin-bottom:14px}
input[type=file]{
  width:100%;
  margin-bottom:14px;
  color:var(--muted);
}
button{
  width:100%;
  border:none;
  padding:14px;
  border-radius:14px;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
}
#startBtn{background:var(--accent);color:white}
#endBtn{background:var(--danger);color:white;display:none}
button:disabled{opacity:.6}

.pulse{
  width:68px;height:68px;
  border-radius:50%;
  background:var(--accent);
  margin:18px auto;
  display:none;
  animation:pulse 1.5s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(37,99,235,.7)}
  100%{box-shadow:0 0 0 26px rgba(37,99,235,0)}
}
#log{
  margin-top:16px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:14px;
  height:220px;
  overflow-y:auto;
  font-size:13px;
  line-height:1.55;
}
.report{
  background:#020617;
  border-left:4px solid var(--accent);
  padding:14px;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="card">
  <h2>Career Lab AI</h2>
  <div id="status">Upload your resume to begin</div>

  <input id="cvFile" type="file" accept=".pdf,.txt">

  <div id="mic" class="pulse"></div>

  <button id="startBtn" disabled>ðŸŽ¤ Start Interview</button>
  <button id="endBtn">ðŸ›‘ End & Evaluate</button>

  <div id="log">AI ready.</div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ================= STATE ================= */
let cvText = "";
let history = [];
let active = false;
let busy = false;
const synth = speechSynthesis;

/* ================= UI ================= */
const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const micEl = document.getElementById("mic");
const startBtn = document.getElementById("startBtn");
const endBtn = document.getElementById("endBtn");
const cvFile = document.getElementById("cvFile");

/* ================= RESUME PARSER ================= */
cvFile.onchange = async () => {
  const file = cvFile.files[0];
  if (!file) return;
  statusEl.innerText = "Reading resume...";
  try {
    if (file.type === "application/pdf") {
      const pdf = await pdfjsLib.getDocument(new Uint8Array(await file.arrayBuffer())).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(x => x.str).join(" ") + "\n";
      }
      cvText = text;
    } else {
      cvText = await file.text();
    }
    statusEl.innerText = "Resume loaded";
    startBtn.disabled = false;
  } catch {
    statusEl.innerText = "Resume read failed";
  }
};

/* ================= AI SPEAK ================= */
function speakAI(text){
  if (!text || text === "undefined") {
    busy = false;
    statusEl.innerText = "AI error. Tap Start.";
    return;
  }
  logEl.innerHTML += `<div><b>AI:</b> ${text}</div>`;
  logEl.scrollTop = logEl.scrollHeight;

  synth.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.onend = () => {
    busy = false;
    if (active) setTimeout(startRecording, 600);
  };
  synth.speak(u);
}

/* ================= RECORD ================= */
async function startRecording(){
  if (!active || busy) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const rec = new MediaRecorder(stream);
    const chunks = [];

    micEl.style.display = "block";
    statusEl.innerText = "Listening...";

    rec.ondataavailable = e => chunks.push(e.data);

    rec.onstop = async () => {
      micEl.style.display = "none";
      stream.getTracks().forEach(t => t.stop());

      const blob = new Blob(chunks, {type:"audio/webm"});
      if (blob.size < 1500) {
        busy = false;
        statusEl.innerText = "Speak clearly. Tap Start.";
        active = false;
        startBtn.style.display = "block";
        return;
      }

      busy = true;
      statusEl.innerText = "Analyzing...";

      const fd = new FormData();
      fd.append("audio", blob);
      fd.append("mode", "interview");
      fd.append("cvText", cvText);
      fd.append("history", JSON.stringify(history));

      try {
        const res = await fetch(WORKER_URL,{method:"POST",body:fd});
        if (!res.ok) throw 0;
        const data = await res.json();
        history = data.newHistory || history;
        speakAI(data.nextQuestion);
      } catch {
        busy = false;
        active = false;
        statusEl.innerText = "Network error. Tap Start.";
        startBtn.style.display = "block";
      }
    };

    rec.start();
    setTimeout(()=>rec.state==="recording"&&rec.stop(),8000);

  } catch {
    statusEl.innerText = "Mic permission denied";
    active = false;
  }
}

/* ================= BUTTONS ================= */
startBtn.onclick = () => {
  active = true;
  startBtn.style.display = "none";
  cvFile.style.display = "none";
  endBtn.style.display = "block";
  speakAI("I have reviewed your resume. Please introduce yourself and highlight your key strengths.");
};

endBtn.onclick = async () => {
  active = false;
  synth.cancel();
  statusEl.innerText = "Generating report...";
  endBtn.disabled = true;

  const fd = new FormData();
  fd.append("mode","evaluate");
  fd.append("history",JSON.stringify(history));

  try{
    const res = await fetch(WORKER_URL,{method:"POST",body:fd});
    const data = await res.json();
    logEl.innerHTML = `<div class="report"><h3>Interview Report</h3><pre>${data.report}</pre></div>`;
    statusEl.innerText = "Completed";
  }catch{
    statusEl.innerText = "Report failed";
    endBtn.disabled = false;
  }
};
</script>
</body>
</html>
