<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Evalis AI Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin: 0;
  background: #020617;
  font-family: system-ui;
  color: #e5e7eb;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
.card {
  width: 380px;
  background: #0f172a;
  border-radius: 18px;
  padding: 26px;
  border: 1px solid #1e293b;
}
h2 {
  margin-top: 0;
  text-align: center;
}
#status {
  font-size: 12px;
  color: #38bdf8;
  text-align: center;
  margin: 8px 0;
}
#question {
  min-height: 70px;
  font-size: 15px;
  margin: 12px 0;
}
textarea {
  width: 100%;
  min-height: 90px;
  border-radius: 10px;
  border: none;
  padding: 10px;
  font-size: 14px;
}
button {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  border-radius: 12px;
  border: none;
  background: #2563eb;
  color: white;
  font-weight: 600;
  cursor: pointer;
}
button.secondary {
  background: #1e293b;
}
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>
</head>

<body>
<div class="card">

<h2>Evalis AI Interview</h2>

<input type="file" id="resumeInput" accept=".pdf,.txt" />
<div id="status">Upload resume to begin</div>

<div id="question"></div>

<textarea id="answer" placeholder="Your answer will appear hereâ€¦" disabled></textarea>

<button id="recordBtn" class="secondary" disabled>ðŸŽ¤ Speak Answer</button>
<button id="submitBtn" disabled>Submit Answer</button>

</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohconsultancy.workers.dev";

/* ================= PDF SETUP ================= */
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ================= STATE ================= */
let resumeText = "";
let mediaRecorder;
let audioChunks = [];

/* ================= RESUME PARSER (TEXT ONLY) ================= */
async function extractResumeText(file) {
  let text = "";

  if (file.type.includes("pdf")) {
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buf).promise;
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(i => i.str).join(" ") + " ";
    }
  } else {
    text = await file.text();
  }

  return text.trim();
}

/* ================= ELEMENTS ================= */
const resumeInput = document.getElementById("resumeInput");
const statusEl = document.getElementById("status");
const questionEl = document.getElementById("question");
const answerEl = document.getElementById("answer");
const recordBtn = document.getElementById("recordBtn");
const submitBtn = document.getElementById("submitBtn");

/* ================= RESUME UPLOAD ================= */
resumeInput.onchange = async () => {
  if (!resumeInput.files.length) return;

  statusEl.innerText = "Reading resumeâ€¦";
  questionEl.innerText = "";
  answerEl.value = "";
  answerEl.disabled = true;
  recordBtn.disabled = true;
  submitBtn.disabled = true;

  resumeText = await extractResumeText(resumeInput.files[0]);

  if (!resumeText) {
    statusEl.innerText = "Failed to read resume";
    return;
  }

  statusEl.innerText = "Resume uploaded. Start answering.";
  questionEl.innerText = "Tell me about yourself based on your resume.";
  answerEl.disabled = false;
  recordBtn.disabled = false;
  submitBtn.disabled = false;
};

/* ================= VOICE RECORD ================= */
recordBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

    const formData = new FormData();
    formData.append("audio", audioBlob, "answer.webm");
    formData.append("resume", resumeText);

    statusEl.innerText = "Evaluating answerâ€¦";

    const res = await fetch(WORKER_URL, {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    answerEl.value = data.transcript || "";
    questionEl.innerText = data.nextQuestion || "Interview completed.";
    statusEl.innerText = "Listening";
  };

  mediaRecorder.start();
  statusEl.innerText = "Recordingâ€¦";

  setTimeout(() => mediaRecorder.stop(), 5000);
};

/* ================= TEXT SUBMIT ================= */
submitBtn.onclick = async () => {
  const text = answerEl.value.trim();
  if (!text) return;

  statusEl.innerText = "Evaluating answerâ€¦";

  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      transcript: text,
      resume: resumeText
    })
  });

  const data = await res.json();
  answerEl.value = "";
  questionEl.innerText = data.nextQuestion || "Interview completed.";
  statusEl.innerText = "Listening";
};
</script>

</body>
</html>
