package com.example.simpaticocareerlab

import android.Manifest
import android.app.Activity
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Bundle
import android.speech.RecognitionListener
import android.speech.RecognizerIntent
import android.speech.SpeechRecognizer
import android.speech.tts.TextToSpeech
import android.webkit.*
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.ui.viewinterop.AndroidView
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import org.json.JSONObject
import java.util.Locale

class MainActivity : ComponentActivity(), TextToSpeech.OnInitListener {

    private lateinit var webView: WebView
    private lateinit var tts: TextToSpeech
    private lateinit var speechRecognizer: SpeechRecognizer
    private lateinit var speechIntent: Intent

    private var fileCallback: ValueCallback<Array<Uri>>? = null

    /* ---------------- FILE PICKER ---------------- */
    private val filePickerLauncher =
        registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { result ->
            val uri =
                if (result.resultCode == Activity.RESULT_OK) result.data?.data else null
            fileCallback?.onReceiveValue(if (uri != null) arrayOf(uri) else null)
            fileCallback = null
        }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        /* ---------------- PERMISSIONS ---------------- */
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO)
            != PackageManager.PERMISSION_GRANTED
        ) {
            ActivityCompat.requestPermissions(
                this,
                arrayOf(Manifest.permission.RECORD_AUDIO),
                1
            )
        }

        /* ---------------- TTS ---------------- */
        tts = TextToSpeech(this, this)

        /* ---------------- SPEECH RECOGNIZER ---------------- */
        speechRecognizer = SpeechRecognizer.createSpeechRecognizer(this)

        speechIntent = Intent(RecognizerIntent.ACTION_RECOGNIZE_SPEECH).apply {
            putExtra(
                RecognizerIntent.EXTRA_LANGUAGE_MODEL,
                RecognizerIntent.LANGUAGE_MODEL_FREE_FORM
            )
            putExtra(RecognizerIntent.EXTRA_LANGUAGE, Locale.US)
            putExtra(RecognizerIntent.EXTRA_PARTIAL_RESULTS, false)
        }

        speechRecognizer.setRecognitionListener(object : RecognitionListener {

            override fun onResults(results: Bundle) {
                val text =
                    results.getStringArrayList(SpeechRecognizer.RESULTS_RECOGNITION)
                        ?.firstOrNull()
                        ?: return

                webView.post {
                    webView.evaluateJavascript(
                        "window.receiveVoskText(${JSONObject.quote(text)})",
                        null
                    )
                }
            }

            override fun onError(error: Int) {
                restartListening()
            }

            override fun onEndOfSpeech() {
                restartListening()
            }

            override fun onReadyForSpeech(params: Bundle?) {}
            override fun onBeginningOfSpeech() {}
            override fun onRmsChanged(rmsdB: Float) {}
            override fun onBufferReceived(buffer: ByteArray?) {}
            override fun onPartialResults(partialResults: Bundle?) {}
            override fun onEvent(eventType: Int, params: Bundle?) {}
        })

        /* ---------------- UI ---------------- */
        setContent {
            AndroidView(factory = { context ->
                webView = WebView(context).apply {

                    settings.javaScriptEnabled = true
                    settings.domStorageEnabled = true
                    settings.allowFileAccess = true
                    settings.allowContentAccess = true
                    settings.mediaPlaybackRequiresUserGesture = false
                    settings.cacheMode = WebSettings.LOAD_NO_CACHE

                    clearCache(true)
                    clearHistory()

                    webViewClient = WebViewClient()

                    webChromeClient = object : WebChromeClient() {
                        override fun onShowFileChooser(
                            webView: WebView?,
                            filePathCallback: ValueCallback<Array<Uri>>?,
                            fileChooserParams: FileChooserParams?
                        ): Boolean {
                            fileCallback = filePathCallback
                            filePickerLauncher.launch(
                                fileChooserParams?.createIntent()
                            )
                            return true
                        }
                    }

                    /* -------- JS â†” ANDROID BRIDGES -------- */
                    addJavascriptInterface(AndroidTTS(), "Android")
                    addJavascriptInterface(AndroidMic(), "AndroidSpeech")

                    /* -------- LOAD FINAL HTML -------- */
                    loadUrl("file:///android_asset/evalis-interview.html")
                }

                webView
            })
        }
    }

    /* ---------------- ANDROID TTS ---------------- */
    inner class AndroidTTS {
        @JavascriptInterface
        fun speak(text: String) {
            tts.speak(text, TextToSpeech.QUEUE_FLUSH, null, null)
        }
    }

    /* ---------------- ANDROID MIC ---------------- */
    inner class AndroidMic {
        @JavascriptInterface
        fun startListening() {
            restartListening()
        }
    }

    private fun restartListening() {
        try {
            speechRecognizer.cancel()
            speechRecognizer.startListening(speechIntent)
        } catch (_: Exception) {}
    }

    override fun onInit(status: Int) {
        if (status == TextToSpeech.SUCCESS) {
            tts.language = Locale.US
            tts.setSpeechRate(1.0f)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        speechRecognizer.destroy()
        tts.stop()
        tts.shutdown()
    }
}
