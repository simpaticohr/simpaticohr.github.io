<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Simpatico HR ‚Äî AI Interview Platform</title>
<meta name="description" content="Enterprise AI-Powered Interview Intelligence by Simpatico HR">
<meta name="theme-color" content="#0a0a12">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #7C6AF6;
    --primary-glow: rgba(124, 106, 246, 0.15);
    --accent: #36D6C3;
    --accent-glow: rgba(54, 214, 195, 0.15);
    --bg: #08080f;
    --bg-card: rgba(16, 16, 28, 0.8);
    --bg-elevated: rgba(22, 22, 38, 0.9);
    --border: rgba(255, 255, 255, 0.06);
    --border-active: rgba(124, 106, 246, 0.4);
    --text: #e8e8f0;
    --text-dim: #6a6a80;
    --text-muted: #44445a;
    --danger: #F6556A;
    --success: #36D6A0;
    --warning: #F6C136;
    --gradient-brand: linear-gradient(135deg, #7C6AF6 0%, #36D6C3 100%);
    --gradient-card: linear-gradient(135deg, rgba(124,106,246,0.05), rgba(54,214,195,0.03));
    --shadow-lg: 0 20px 60px rgba(0,0,0,0.5);
    --shadow-glow: 0 0 40px rgba(124,106,246,0.1);
    --radius: 16px;
    --radius-sm: 10px;
    --radius-xs: 6px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -webkit-text-size-adjust: 100%;
  }

  /* --- BACKGROUND AMBIANCE --- */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
      radial-gradient(ellipse at 20% 20%, rgba(124,106,246,0.06) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(54,214,195,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 50% 50%, rgba(124,106,246,0.02) 0%, transparent 80%);
    pointer-events: none;
    z-index: 0;
    animation: ambiance 20s ease-in-out infinite alternate;
  }

  @keyframes ambiance {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(-2%, -2%) rotate(3deg); }
  }

  /* --- GLASS MORPHISM BASE --- */
  .glass {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }

  /* --- SCROLLBAR --- */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* --- AUTH SCREEN --- */
  .auth-screen {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    padding: 24px;
    gap: 28px;
    text-align: center;
  }

  .brand-logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .brand-icon {
    width: 72px;
    height: 72px;
    border-radius: 20px;
    background: var(--gradient-brand);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    box-shadow: 0 8px 32px rgba(124,106,246,0.3);
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }

  .brand-name {
    font-size: 1.8rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    background: var(--gradient-brand);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .brand-tagline {
    color: var(--text-dim);
    font-size: 0.9rem;
    font-weight: 400;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .auth-card {
    width: 100%;
    max-width: 420px;
    padding: 32px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    text-align: left;
  }

  .input-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .input-field {
    width: 100%;
    padding: 14px 18px;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border);
    background: rgba(0,0,0,0.3);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    letter-spacing: 2px;
    text-align: center;
    outline: none;
    transition: all 0.3s;
  }

  .input-field:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-glow);
  }

  .upload-zone {
    width: 100%;
    padding: 28px;
    border: 2px dashed rgba(255,255,255,0.08);
    border-radius: var(--radius);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .upload-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--gradient-card);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .upload-zone:hover::before, .upload-zone.dragover::before {
    opacity: 1;
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--primary);
  }

  .upload-zone.loaded {
    border-color: var(--success);
    border-style: solid;
  }

  .upload-zone.loaded .upload-icon { color: var(--success); }

  .upload-icon {
    font-size: 2rem;
    margin-bottom: 8px;
    display: block;
  }

  .upload-text {
    font-size: 0.9rem;
    color: var(--text-dim);
    position: relative;
    z-index: 1;
  }

  .upload-filename {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 6px;
    position: relative;
    z-index: 1;
  }

  /* --- BUTTONS --- */
  .btn {
    padding: 14px 28px;
    border-radius: var(--radius-sm);
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  .btn:active { transform: scale(0.97); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

  .btn-brand {
    background: var(--gradient-brand);
    color: white;
    box-shadow: 0 4px 20px rgba(124,106,246,0.3);
  }

  .btn-brand:hover:not(:disabled) {
    box-shadow: 0 6px 30px rgba(124,106,246,0.4);
    transform: translateY(-1px);
  }

  .btn-brand::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .btn-brand:hover::after { opacity: 1; }

  .btn-ghost {
    background: rgba(255,255,255,0.04);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover:not(:disabled) {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.12);
  }

  .btn-accent {
    background: linear-gradient(135deg, var(--accent), #2BC4B0);
    color: #000;
    font-weight: 700;
    box-shadow: 0 4px 20px rgba(54,214,195,0.3);
  }

  .btn-danger {
    background: rgba(246,85,106,0.12);
    color: var(--danger);
    border: 1px solid rgba(246,85,106,0.2);
  }

  .btn-danger:hover:not(:disabled) {
    background: rgba(246,85,106,0.2);
  }

  .btn-score {
    background: linear-gradient(135deg, var(--success), #2BC4B0);
    color: #000;
    font-weight: 700;
    box-shadow: 0 4px 20px rgba(54,214,160,0.3);
  }

  .btn-sm { padding: 10px 18px; font-size: 0.85rem; }
  .btn-lg { padding: 16px 32px; font-size: 1rem; }
  .btn-full { width: 100%; }

  /* --- INTERVIEW SCREEN --- */
  .interview-screen {
    display: none;
    position: relative;
    z-index: 1;
  }

  .interview-screen.active { display: block; }

  .topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(8,8,15,0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }

  .topbar-brand {
    font-weight: 700;
    font-size: 0.95rem;
    background: var(--gradient-brand);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .topbar-center {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .timer-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--accent);
    background: var(--accent-glow);
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 500;
  }

  .mic-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-muted);
    transition: all 0.3s;
  }

  .mic-indicator.active { color: var(--success); }
  .mic-indicator.error { color: var(--danger); }

  .mic-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: all 0.3s;
  }

  .mic-indicator.active .mic-dot {
    background: var(--success);
    box-shadow: 0 0 8px rgba(54,214,160,0.5);
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(1.8); }
  }

  /* --- CHAT --- */
  .chat-area {
    max-width: 720px;
    margin: 0 auto;
    padding: 16px 20px;
    padding-bottom: 240px;
    min-height: calc(100dvh - 60px);
  }

  .msg {
    margin-bottom: 16px;
    max-width: 85%;
    animation: msgIn 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(12px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .msg-ai {
    margin-right: auto;
  }

  .msg-user {
    margin-left: auto;
  }

  .msg-bubble {
    padding: 14px 20px;
    border-radius: var(--radius);
    line-height: 1.6;
    font-size: 0.92rem;
  }

  .msg-ai .msg-bubble {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-bottom-left-radius: var(--radius-xs);
  }

  .msg-user .msg-bubble {
    background: linear-gradient(135deg, rgba(124,106,246,0.12), rgba(54,214,195,0.08));
    border: 1px solid rgba(124,106,246,0.15);
    border-bottom-right-radius: var(--radius-xs);
  }

  .msg-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .msg-ai .msg-label { color: var(--accent); }
  .msg-user .msg-label { color: var(--primary); text-align: right; justify-content: flex-end; }

  /* --- SCORE REPORT --- */
  .msg-score .msg-bubble {
    max-width: 100%;
    background: var(--bg-elevated);
    border: 1px solid rgba(54,214,160,0.15);
    font-family: 'Inter', sans-serif;
    font-size: 0.88rem;
    line-height: 1.7;
    white-space: pre-wrap;
  }

  .msg-score { max-width: 100%; }

  /* --- CONTROLS DOCK --- */
  .dock {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: linear-gradient(to top, var(--bg) 60%, transparent);
    padding: 0 16px 16px;
    padding-bottom: calc(env(safe-area-inset-bottom, 16px) + 16px);
  }

  .dock-inner {
    max-width: 720px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
  }

  /* Live transcript */
  .transcript-preview {
    width: 100%;
    min-height: 44px;
    padding: 12px 18px;
    border-radius: var(--radius-sm);
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    font-size: 0.88rem;
    color: var(--text-muted);
    text-align: center;
    transition: all 0.3s;
    font-style: italic;
  }

  .transcript-preview.has-text {
    color: var(--text);
    font-style: normal;
    border-color: var(--border-active);
    background: rgba(124,106,246,0.04);
    text-align: left;
  }

  /* Visualizer */
  .viz {
    display: flex;
    gap: 2px;
    align-items: center;
    height: 24px;
  }

  .viz-bar {
    width: 3px;
    height: 4px;
    background: var(--accent);
    border-radius: 2px;
    transition: height 0.08s ease;
    opacity: 0.7;
  }

  /* Button Row */
  .dock-btns {
    display: flex;
    gap: 10px;
    width: 100%;
  }

  .dock-btns .btn { flex: 1; }
  .dock-btns .btn-send { flex: 0 0 auto; }

  /* Fallback text input */
  .fallback-row {
    display: none;
    width: 100%;
    gap: 10px;
  }

  .fallback-row.active { display: flex; }

  .fallback-input {
    flex: 1;
    padding: 14px 18px;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border);
    background: rgba(0,0,0,0.3);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    outline: none;
    transition: all 0.3s;
  }

  .fallback-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-glow);
  }

  .score-row {
    display: none;
    width: 100%;
  }

  .score-row.active { display: flex; }

  /* --- TOAST --- */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    padding: 12px 24px;
    border-radius: var(--radius-sm);
    font-size: 0.88rem;
    font-weight: 500;
    z-index: 9999;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-lg);
  }

  .toast.show { transform: translateX(-50%) translateY(0); }

  /* --- ADMIN PANEL OVERLAY --- */
  .admin-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 500;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .admin-overlay.active { display: flex; }

  .admin-panel {
    width: 100%;
    max-width: 480px;
    padding: 32px;
    max-height: 80dvh;
    overflow-y: auto;
  }

  .admin-panel h2 {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 24px;
    background: var(--gradient-brand);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .admin-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .admin-section:last-child { border-bottom: none; }

  .admin-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 8px;
  }

  .code-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
  }

  .code-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    background: rgba(0,0,0,0.3);
    border-radius: var(--radius-xs);
    border: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
  }

  .code-item-label {
    font-family: 'Inter', sans-serif;
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  /* --- LOADING DOTS --- */
  .loading-dots::after {
    content: '';
    animation: dots 1.5s steps(4, end) infinite;
  }

  @keyframes dots {
    0% { content: ''; }
    25% { content: '.'; }
    50% { content: '..'; }
    75% { content: '...'; }
  }

  /* --- RESPONSIVE --- */
  @media (max-width: 480px) {
    .auth-card { padding: 24px 20px; }
    .chat-area { padding: 12px 14px 260px; }
    .msg { max-width: 92%; }
    .msg-bubble { padding: 12px 16px; font-size: 0.88rem; }
    .dock-btns .btn { padding: 12px 14px; font-size: 0.85rem; }
    .brand-name { font-size: 1.5rem; }
  }
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ADMIN OVERLAY -->
<div class="admin-overlay" id="adminOverlay">
  <div class="admin-panel glass" id="adminPanel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
      <h2 style="margin:0;">‚öôÔ∏è Admin Panel</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeAdmin()">‚úï Close</button>
    </div>

    <div class="admin-section">
      <div class="admin-label">Generate Access Code</div>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:8px;">
        <input type="text" class="input-field" id="adminLabel" placeholder="Label (e.g. John Doe)" style="letter-spacing:0; text-align:left; font-family:'Inter',sans-serif;">
        <div style="display:flex; gap:10px;">
          <select class="input-field" id="adminDuration" style="letter-spacing:0; font-family:'Inter',sans-serif;">
            <option value="1">1 Hour</option>
            <option value="6">6 Hours</option>
            <option value="24" selected>24 Hours</option>
            <option value="72">3 Days</option>
            <option value="168">7 Days</option>
            <option value="720">30 Days</option>
          </select>
          <button class="btn btn-brand btn-sm" onclick="adminGenCode()">Generate</button>
        </div>
      </div>
      <div id="adminGenResult" style="margin-top:12px;"></div>
    </div>

    <div class="admin-section">
      <div class="admin-label">Active Codes</div>
      <button class="btn btn-ghost btn-sm btn-full" onclick="adminListCodes()" style="margin-top:8px;">üîÑ Refresh List</button>
      <div class="code-list" id="codeList"></div>
    </div>
  </div>
</div>

<!-- ==================== AUTH SCREEN ==================== -->
<div class="auth-screen" id="authScreen">
  <div class="brand-logo">
    <div class="brand-icon">üß†</div>
    <div class="brand-name">Simpatico HR</div>
    <div class="brand-tagline">AI-Powered Interview Intelligence</div>
  </div>

  <div class="auth-card glass">
    <div class="input-group">
      <label class="input-label">Access Code</label>
      <input type="text" class="input-field" id="accessCode"
             placeholder="SHR-XXXXXX"
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>

    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('cvFile').click()">
      <input type="file" id="cvFile" accept=".pdf,.txt,.doc,.docx" hidden>
      <span class="upload-icon">üìÑ</span>
      <div class="upload-text">Upload Resume</div>
      <div class="upload-filename" id="fileName">PDF or TXT ‚Ä¢ Drop file here</div>
    </div>

    <button class="btn btn-brand btn-lg btn-full" onclick="startInterview()">
      üéôÔ∏è Begin Interview
    </button>

    <button class="btn btn-ghost btn-sm btn-full" id="adminBtn" style="display:none;" onclick="openAdmin()">
      ‚öôÔ∏è Admin Panel
    </button>
  </div>

  <div style="color:var(--text-muted); font-size:0.75rem; margin-top:8px;">
    Powered by Simpatico HR Consultancy
  </div>
</div>

<!-- ==================== INTERVIEW SCREEN ==================== -->
<div class="interview-screen" id="interviewScreen">
  <!-- TOP BAR -->
  <div class="topbar">
    <span class="topbar-brand">Simpatico HR</span>
    <div class="topbar-center">
      <span class="timer-badge" id="timer">00:00</span>
    </div>
    <div class="mic-indicator" id="micIndicator">
      <div class="mic-dot"></div>
      <span id="micLabel">Starting...</span>
    </div>
  </div>

  <!-- CHAT -->
  <div class="chat-area" id="chatArea"></div>

  <!-- DOCK -->
  <div class="dock">
    <div class="dock-inner">
      <div class="transcript-preview" id="liveTranscript">üéôÔ∏è Listening for your response...</div>

      <div class="viz" id="visualizer"></div>

      <div class="dock-btns" id="voiceRow">
        <button class="btn btn-ghost" id="btnMic" onclick="toggleListening()">
          üéôÔ∏è Listening
        </button>
        <button class="btn btn-brand btn-send" id="btnSend" onclick="sendCurrent()" disabled>
          Send ‚û§
        </button>
        <button class="btn btn-danger" id="btnEnd" onclick="endInterview()">
          End
        </button>
      </div>

      <div class="fallback-row" id="fallbackRow">
        <input type="text" class="fallback-input" id="fallbackInput"
               placeholder="Type your answer..." enterkeyhint="send">
        <button class="btn btn-brand btn-send" onclick="sendFallback()">Send ‚û§</button>
        <button class="btn btn-danger" onclick="endInterview()">End</button>
      </div>

      <div class="score-row" id="scoreRow">
        <button class="btn btn-score btn-lg btn-full" onclick="getScore()">
          üìä Generate Interview Report
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ===================================================
// CONFIG
// ===================================================
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

// ===================================================
// STATE
// ===================================================
let accessCode = "";
let cvText = "";
let history = [];
let timerInterval = null;
let seconds = 0;
let isInterviewActive = false;
let isSending = false;

// ===================================================
// CONTINUOUS LISTENING ENGINE (Production-Grade)
// ===================================================
class ContinuousListeningEngine {
  constructor() {
    this.recognition = null;
    this.isListening = false;
    this.isPaused = false;
    this.isSupported = false;
    this.finalTranscript = "";
    this.interimTranscript = "";
    this.restartAttempts = 0;
    this.maxRestartAttempts = 100;
    this.restartDelay = 80;
    this.silenceTimer = null;
    this.silenceThreshold = 2000;
    this.lastSpeechTime = 0;
    this.audioContext = null;
    this.analyser = null;
    this.mediaStream = null;
    this.animFrameId = null;
    this.isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    this.isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    this.wakeLock = null;

    this.onInterim = null;
    this.onFinal = null;
    this.onStateChange = null;
    this.onVolumeChange = null;

    this._init();
  }

  _init() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { this.isSupported = false; return; }
    this.isSupported = true;
  }

  _createRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const rec = new SR();
    rec.continuous = !this.isIOS;
    rec.interimResults = true;
    rec.maxAlternatives = 1;
    rec.lang = "en-US";

    rec.onstart = () => {
      this.isListening = true;
      this.restartAttempts = 0;
      this.restartDelay = 80;
      this._fire("listening");
    };

    rec.onresult = (e) => {
      this.interimTranscript = "";
      let newFinal = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) { newFinal += t + " "; }
        else { this.interimTranscript += t; }
      }
      if (newFinal) {
        this.finalTranscript += newFinal;
        this.lastSpeechTime = Date.now();
        this._resetSilenceTimer();
      }
      const display = this.finalTranscript + this.interimTranscript;
      if (this.interimTranscript && this.onInterim) this.onInterim(display);
      if (newFinal && this.onFinal) this.onFinal(display);
    };

    rec.onerror = (e) => {
      console.warn("SR error:", e.error);
      const recoverable = ["no-speech", "audio-capture", "network", "aborted"];
      if (recoverable.includes(e.error) && !this.isPaused && isInterviewActive) {
        this._scheduleRestart();
      } else if (e.error === "not-allowed") {
        this._fire("denied");
      }
    };

    rec.onend = () => {
      this.isListening = false;
      if (!this.isPaused && isInterviewActive) this._scheduleRestart();
      else this._fire("stopped");
    };

    this.recognition = rec;
  }

  _scheduleRestart() {
    if (this.restartAttempts >= this.maxRestartAttempts) {
      this._fire("error");
      return;
    }
    this.restartAttempts++;
    const delay = Math.min(this.restartDelay * Math.pow(1.2, this.restartAttempts - 1), 2000);
    setTimeout(() => { if (!this.isPaused && isInterviewActive) this._safeStart(); }, delay);
  }

  _safeStart() {
    try {
      this._createRecognition();
      this.recognition.start();
    } catch(e) {
      console.warn("SR start fail:", e.message);
      setTimeout(() => this._safeStart(), 500);
    }
  }

  _resetSilenceTimer() {
    clearTimeout(this.silenceTimer);
    this.silenceTimer = setTimeout(() => {
      if (this.finalTranscript.trim().length > 0) this._fire("ready");
    }, this.silenceThreshold);
  }

  _fire(state) { if (this.onStateChange) this.onStateChange(state); }

  async start() {
    if (!this.isSupported) return false;
    this.isPaused = false;
    this.finalTranscript = "";
    this.interimTranscript = "";
    this.restartAttempts = 0;

    try {
      this.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      this._initVisualizer(this.mediaStream);
    } catch(e) { console.warn("No media stream:", e); }

    if ('wakeLock' in navigator) {
      try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    }

    this._safeStart();
    return true;
  }

  pause() {
    this.isPaused = true;
    clearTimeout(this.silenceTimer);
    try { this.recognition.stop(); } catch(e) {}
    this._fire("paused");
  }

  resume() {
    if (!this.isSupported) return;
    this.isPaused = false;
    this.finalTranscript = "";
    this.interimTranscript = "";
    this._safeStart();
  }

  stop() {
    this.isPaused = true;
    clearTimeout(this.silenceTimer);
    try { this.recognition.stop(); } catch(e) {}
    this._destroyVisualizer();
    if (this.wakeLock) { this.wakeLock.release().catch(()=>{}); this.wakeLock = null; }
    this._fire("stopped");
  }

  getCurrentTranscript() { return (this.finalTranscript + this.interimTranscript).trim(); }
  clearTranscript() { this.finalTranscript = ""; this.interimTranscript = ""; }

  _initVisualizer(stream) {
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      this.analyser = this.audioContext.createAnalyser();
      this.analyser.fftSize = 64;
      this.audioContext.createMediaStreamSource(stream).connect(this.analyser);
      this._drawViz();
    } catch(e) {}
  }

  _drawViz() {
    if (!this.analyser || this.isPaused) return;
    const data = new Uint8Array(this.analyser.frequencyBinCount);
    this.analyser.getByteFrequencyData(data);
    if (this.onVolumeChange) this.onVolumeChange(data);
    this.animFrameId = requestAnimationFrame(() => this._drawViz());
  }

  _destroyVisualizer() {
    if (this.animFrameId) cancelAnimationFrame(this.animFrameId);
    if (this.audioContext) { this.audioContext.close().catch(()=>{}); this.audioContext = null; this.analyser = null; }
    if (this.mediaStream) { this.mediaStream.getTracks().forEach(t => t.stop()); this.mediaStream = null; }
  }
}

// ===================================================
// ENGINE INSTANCE + CALLBACKS
// ===================================================
const engine = new ContinuousListeningEngine();

engine.onInterim = (text) => updateTranscriptUI(text, false);
engine.onFinal = (text) => {
  updateTranscriptUI(text, true);
  document.getElementById("btnSend").disabled = false;
};

engine.onStateChange = (state) => {
  const ind = document.getElementById("micIndicator");
  const label = document.getElementById("micLabel");
  const btn = document.getElementById("btnMic");

  switch(state) {
    case "listening":
      ind.className = "mic-indicator active";
      label.textContent = "Listening";
      btn.innerHTML = "üéôÔ∏è Listening";
      btn.disabled = false;
      break;
    case "paused":
      ind.className = "mic-indicator";
      label.textContent = "Paused";
      btn.innerHTML = "üéôÔ∏è Resume";
      break;
    case "ready":
      ind.className = "mic-indicator active";
      label.textContent = "Ready";
      document.getElementById("btnSend").classList.add("pulse-send");
      break;
    case "stopped":
      ind.className = "mic-indicator";
      label.textContent = "Stopped";
      btn.innerHTML = "üéôÔ∏è Start";
      break;
    case "denied":
      ind.className = "mic-indicator error";
      label.textContent = "Denied";
      showFallbackInput();
      toast("üéôÔ∏è Mic denied ‚Äî type your answers instead");
      break;
    case "error":
      ind.className = "mic-indicator error";
      label.textContent = "Error";
      btn.innerHTML = "üéôÔ∏è Retry";
      btn.disabled = false;
      break;
  }
};

engine.onVolumeChange = (data) => {
  const bars = document.querySelectorAll("#visualizer .viz-bar");
  if (!bars.length) return;
  const step = Math.floor(data.length / bars.length);
  for (let i = 0; i < bars.length; i++) {
    const v = data[i * step] || 0;
    bars[i].style.height = Math.max(3, (v / 255) * 26) + "px";
  }
};

// ===================================================
// UI HELPERS
// ===================================================
function initViz() {
  const el = document.getElementById("visualizer");
  el.innerHTML = "";
  for (let i = 0; i < 24; i++) {
    const b = document.createElement("div");
    b.className = "viz-bar";
    el.appendChild(b);
  }
}

function updateTranscriptUI(text, isFinal) {
  const el = document.getElementById("liveTranscript");
  if (text.trim()) {
    el.textContent = text;
    el.className = "transcript-preview has-text";
  } else {
    el.textContent = "üéôÔ∏è Listening for your response...";
    el.className = "transcript-preview";
  }
}

function showFallbackInput() {
  document.getElementById("voiceRow").style.display = "none";
  document.getElementById("fallbackRow").classList.add("active");
  document.getElementById("liveTranscript").textContent = "‚å®Ô∏è Voice unavailable ‚Äî type below";
  document.getElementById("visualizer").style.display = "none";
  document.getElementById("fallbackInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendFallback();
  });
}

function toggleListening() {
  if (engine.isListening) engine.pause();
  else engine.resume();
}

function addMsg(role, text) {
  const area = document.getElementById("chatArea");
  const wrap = document.createElement("div");
  wrap.className = `msg msg-${role}`;

  const label = document.createElement("div");
  label.className = "msg-label";
  label.innerHTML = role === "ai" ? "üß† Aria ¬∑ Simpatico HR" : "üë§ You";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  bubble.textContent = text;

  wrap.appendChild(label);
  wrap.appendChild(bubble);
  area.appendChild(wrap);
  area.scrollTop = area.scrollHeight;
}

function addScoreMsg(text) {
  const area = document.getElementById("chatArea");
  const wrap = document.createElement("div");
  wrap.className = "msg msg-score";

  const label = document.createElement("div");
  label.className = "msg-label";
  label.innerHTML = "üìä Interview Report";
  label.style.color = "var(--success)";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  bubble.textContent = text;

  wrap.appendChild(label);
  wrap.appendChild(bubble);
  area.appendChild(wrap);
  area.scrollTop = area.scrollHeight;
}

// --- TTS ---
function speak(text) {
  if (!('speechSynthesis' in window)) return;
  const wasListening = engine.isListening;
  if (wasListening) engine.pause();
  speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.05; u.pitch = 1.0; u.volume = 1.0;

  const voices = speechSynthesis.getVoices();
  const pref = voices.find(v =>
    v.name.includes("Samantha") || v.name.includes("Google US") ||
    v.name.includes("Microsoft Aria") || (v.lang === "en-US" && v.localService)
  );
  if (pref) u.voice = pref;

  u.onend = () => { if (isInterviewActive) setTimeout(() => engine.resume(), 300); };
  u.onerror = () => { if (isInterviewActive) engine.resume(); };

  speechSynthesis.speak(u);
}

if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}

// --- TIMER ---
function startTimer() {
  seconds = 0;
  timerInterval = setInterval(() => {
    seconds++;
    const m = String(Math.floor(seconds / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    document.getElementById("timer").textContent = `${m}:${s}`;
  }, 1000);
}

// --- TOAST ---
function toast(msg) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 3500);
}

// ===================================================
// API
// ===================================================
async function api(mode, extra = {}) {
  const fd = new FormData();
  fd.append("mode", mode);
  fd.append("accessCode", accessCode);
  fd.append("cvText", cvText);
  fd.append("history", JSON.stringify(history));
  for (const [k, v] of Object.entries(extra)) fd.append(k, v);

  const res = await fetch(WORKER_URL, { method: "POST", body: fd });
  const data = await res.json();

  if (!res.ok) {
    toast(data.reply || "Something went wrong");
    throw new Error(data.reply || "API Error " + res.status);
  }
  return data;
}

// ===================================================
// CV UPLOAD
// ===================================================
document.getElementById("cvFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("fileName").textContent = file.name;
  document.getElementById("uploadZone").classList.add("loaded");

  if (file.type === "text/plain") {
    cvText = await file.text();
  } else if (file.type === "application/pdf") {
    try {
      const buf = await file.arrayBuffer();
      const txt = new TextDecoder("utf-8").decode(buf);
      const readable = txt.match(/[\x20-\x7E]{4,}/g);
      cvText = readable ? readable.join(" ").substring(0, 4000) : `[PDF: ${file.name}]`;
    } catch(e) { cvText = `[PDF: ${file.name}]`; }
  } else {
    cvText = `[Uploaded: ${file.name}]`;
  }
  toast("‚úÖ Resume loaded");
});

const uploadZone = document.getElementById("uploadZone");
uploadZone.addEventListener("dragover", (e) => { e.preventDefault(); uploadZone.classList.add("dragover"); });
uploadZone.addEventListener("dragleave", () => uploadZone.classList.remove("dragover"));
uploadZone.addEventListener("drop", (e) => {
  e.preventDefault();
  uploadZone.classList.remove("dragover");
  if (e.dataTransfer.files[0]) {
    document.getElementById("cvFile").files = e.dataTransfer.files;
    document.getElementById("cvFile").dispatchEvent(new Event("change"));
  }
});

// Show admin button if master key entered
document.getElementById("accessCode").addEventListener("input", (e) => {
  const v = e.target.value.trim();
  document.getElementById("adminBtn").style.display =
    (v === "ADMIN-MASTER-999" || v.length > 10) ? "flex" : "none";
});

// ===================================================
// INTERVIEW FLOW
// ===================================================
async function startInterview() {
  accessCode = document.getElementById("accessCode").value.trim();
  if (!accessCode) { toast("‚ö†Ô∏è Enter your access code"); return; }
  if (!cvText) { toast("‚ö†Ô∏è Upload a resume first"); return; }

  toast("üöÄ Launching interview...");

  try {
    const data = await api("start");

    document.getElementById("authScreen").style.display = "none";
    document.getElementById("interviewScreen").classList.add("active");
    isInterviewActive = true;

    history = data.history || [];
    addMsg("ai", data.reply);
    speak(data.reply);
    startTimer();
    initViz();

    if (engine.isSupported) {
      const ok = await engine.start();
      if (!ok) showFallbackInput();
    } else {
      showFallbackInput();
    }
  } catch(e) { console.error(e); }
}

async function sendCurrent() {
  if (isSending) return;
  const text = engine.getCurrentTranscript();
  if (!text) { toast("üéôÔ∏è Say something first"); return; }

  isSending = true;
  document.getElementById("btnSend").disabled = true;
  engine.pause();
  addMsg("user", text);
  engine.clearTranscript();
  updateTranscriptUI("", false);

  // Show typing indicator
  const typingId = showTyping();

  try {
    const data = await api("interview", { userMessage: text });
    history = data.history || history;
    removeTyping(typingId);
    addMsg("ai", data.reply);
    speak(data.reply);
  } catch(e) {
    console.error(e);
    removeTyping(typingId);
    engine.resume();
  }
  isSending = false;
}

async function sendFallback() {
  const input = document.getElementById("fallbackInput");
  const text = input.value.trim();
  if (!text || isSending) return;

  isSending = true;
  input.value = "";
  addMsg("user", text);
  const typingId = showTyping();

  try {
    const data = await api("interview", { userMessage: text });
    history = data.history || history;
    removeTyping(typingId);
    addMsg("ai", data.reply);
    speak(data.reply);
  } catch(e) {
    console.error(e);
    removeTyping(typingId);
  }
  isSending = false;
}

function showTyping() {
  const area = document.getElementById("chatArea");
  const wrap = document.createElement("div");
  const id = "typing-" + Date.now();
  wrap.id = id;
  wrap.className = "msg msg-ai";
  wrap.innerHTML = `<div class="msg-label">üß† Aria ¬∑ Simpatico HR</div><div class="msg-bubble" style="color:var(--text-dim);">Thinking<span class="loading-dots"></span></div>`;
  area.appendChild(wrap);
  area.scrollTop = area.scrollHeight;
  return id;
}

function removeTyping(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function endInterview() {
  isInterviewActive = false;
  engine.stop();
  clearInterval(timerInterval);
  speechSynthesis.cancel();

  document.getElementById("voiceRow").style.display = "none";
  document.getElementById("fallbackRow").className = "fallback-row";
  document.getElementById("liveTranscript").style.display = "none";
  document.getElementById("visualizer").style.display = "none";
  document.getElementById("scoreRow").classList.add("active");
  document.getElementById("micLabel").textContent = "Ended";

  addMsg("ai", "Interview complete. Generate your detailed performance report below.");
  toast("‚èπÔ∏è Interview ended");
}

async function getScore() {
  addMsg("ai", "Analyzing your performance ‚Äî this takes a moment...");
  toast("üìä Generating report...");
  document.getElementById("scoreRow").classList.remove("active");

  try {
    const data = await api("score");
    addScoreMsg(data.reply);
  } catch(e) {
    console.error(e);
    addMsg("ai", "Failed to generate report. Please try again.");
    document.getElementById("scoreRow").classList.add("active");
  }
}

// ===================================================
// ADMIN PANEL
// ===================================================
function openAdmin() { document.getElementById("adminOverlay").classList.add("active"); }
function closeAdmin() { document.getElementById("adminOverlay").classList.remove("active"); }

async function adminGenCode() {
  const label = document.getElementById("adminLabel").value.trim() || "user";
  const duration = document.getElementById("adminDuration").value;

  try {
    const data = await api("admin-gen", { duration, label });
    document.getElementById("adminGenResult").innerHTML =
      `<div class="code-item" style="border-color:var(--success); margin-top:8px;">
        <span style="color:var(--success); font-weight:700;">${data.code}</span>
        <span class="code-item-label">${label} ¬∑ ${duration}h</span>
      </div>`;
    toast("‚úÖ Code generated: " + data.code);
    adminListCodes();
  } catch(e) { console.error(e); }
}

async function adminListCodes() {
  try {
    const data = await api("admin-list");
    const list = document.getElementById("codeList");
    list.innerHTML = "";

    if (!data.codes || data.codes.length === 0) {
      list.innerHTML = `<div style="color:var(--text-muted); font-size:0.85rem; padding:12px;">No active codes</div>`;
      return;
    }

    data.codes.forEach(c => {
      let parsed = {};
      try { parsed = JSON.parse(c.data); } catch(e) { parsed = { label: c.data }; }
      const item = document.createElement("div");
      item.className = "code-item";
      item.innerHTML = `<span>${c.code}</span><span class="code-item-label">${parsed.label || ""}</span>`;
      list.appendChild(item);
    });
  } catch(e) { console.error(e); }
}

// ===================================================
// LIFECYCLE
// ===================================================
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && isInterviewActive && !engine.isPaused) {
    setTimeout(() => { if (!engine.isListening) engine.resume(); }, 300);
  }
});

document.addEventListener("touchstart", () => {
  if (engine.audioContext && engine.audioContext.state === "suspended") {
    engine.audioContext.resume();
  }
}, { once: true });

window.addEventListener("beforeunload", (e) => {
  if (isInterviewActive) { e.preventDefault(); e.returnValue = ""; }
});

document.getElementById("accessCode").addEventListener("keydown", (e) => {
  if (e.key === "Enter") startInterview();
});
</script>
</body>
</html>
