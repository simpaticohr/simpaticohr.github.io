<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#06090f;--card:#0d1117;--card2:#161b22;--border:#21262d;--accent:#58a6ff;--accent2:#bc8cff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--text:#e6edf3;--text2:#8b949e;--glow:rgba(88,166,255,0.15)}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
    body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(88,166,255,0.06) 0%,transparent 60%),radial-gradient(ellipse at 80% 100%,rgba(188,140,255,0.06) 0%,transparent 60%);z-index:0;pointer-events:none}
    .container{max-width:780px;margin:0 auto;padding:16px;position:relative;z-index:1}
    .header{text-align:center;padding:30px 0 20px}
    .header h1{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:var(--text2);font-size:0.9rem;margin-top:4px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:14px}
    .card h2{font-size:1rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    label{display:block;font-size:0.8rem;color:var(--text2);margin:12px 0 4px;font-weight:500}
    select,input[type="text"],input[type="email"],input[type="tel"],textarea{width:100%;padding:10px 12px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem;outline:none;transition:border-color 0.2s;font-family:inherit}
    select:focus,input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
    select option{background:var(--card)}
    textarea{resize:vertical;min-height:80px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .upload-area{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s;margin-top:8px}
    .upload-area:hover{border-color:var(--accent);background:rgba(88,166,255,0.03)}
    .upload-area.ok{border-color:var(--green);background:rgba(63,185,80,0.05)}
    .upload-area p{font-size:0.85rem;color:var(--text2)}
    .upload-area strong{color:var(--accent)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;color:#fff;font-family:inherit}
    .btn-go{width:100%;padding:14px;font-size:1rem;background:linear-gradient(135deg,var(--accent),var(--accent2));margin-top:16px}
    .btn-go:hover{transform:translateY(-1px);box-shadow:0 6px 20px var(--glow)}
    .btn-go:disabled{opacity:0.4;cursor:not-allowed;transform:none}
    .btn-secondary{background:var(--card2);border:1px solid var(--border);color:var(--text);width:100%;margin-top:8px;padding:12px}
    .btn-secondary:hover{border-color:var(--accent)}
    .btn-sm{padding:6px 12px;font-size:0.78rem;border-radius:6px}
    .btn-danger{background:rgba(248,81,73,0.15);color:var(--red)}
    .btn-success{background:rgba(63,185,80,0.15);color:var(--green)}

    /* Nav */
    .nav{display:flex;gap:0;margin-bottom:16px;background:var(--card2);border-radius:12px;padding:4px;border:1px solid var(--border);flex-wrap:wrap}
    .nav-btn{flex:1;padding:10px 6px;text-align:center;border:none;background:transparent;color:var(--text2);font-size:0.78rem;font-weight:600;cursor:pointer;border-radius:8px;transition:all 0.2s;font-family:inherit;min-width:60px}
    .nav-btn.active{background:var(--accent);color:#fff}
    .nav-btn:hover:not(.active){background:rgba(88,166,255,0.1)}

    /* Mode cards */
    .mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
    .mode-card{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:20px 16px;text-align:center;cursor:pointer;transition:all 0.3s}
    .mode-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px var(--glow)}
    .mode-card.selected{border-color:var(--accent);background:rgba(88,166,255,0.05)}
    .mode-card .mode-icon{font-size:2.2rem;margin-bottom:8px}
    .mode-card h3{font-size:0.95rem;margin-bottom:4px}
    .mode-card p{font-size:0.78rem;color:var(--text2);line-height:1.4}
    .mode-badge{display:inline-block;padding:2px 10px;border-radius:10px;font-size:0.7rem;font-weight:700;margin-top:6px}

    /* Job & Candidate */
    .job-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;transition:all 0.2s}
    .job-card:hover{border-color:var(--accent)}
    .job-card h3{font-size:0.95rem;margin-bottom:4px;color:var(--accent)}
    .job-meta{font-size:0.78rem;color:var(--text2);display:flex;gap:10px;flex-wrap:wrap}
    .skill-tag{background:rgba(88,166,255,0.1);color:var(--accent);padding:2px 8px;border-radius:6px;font-size:0.72rem;display:inline-block;margin:2px}
    .cand-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);gap:8px;flex-wrap:wrap}
    .cand-row:last-child{border-bottom:none}
    .cand-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;flex-shrink:0}
    .score-badge{padding:2px 8px;border-radius:8px;font-size:0.75rem;font-weight:600}
    .status-pill{padding:2px 8px;border-radius:10px;font-size:0.72rem;font-weight:600}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
    .stat-card{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
    .stat-num{font-size:1.4rem;font-weight:800}
    .stat-label{font-size:0.7rem;color:var(--text2)}

    /* Interview UI */
    .progress-wrap{background:rgba(255,255,255,0.05);border-radius:20px;height:8px;overflow:hidden;margin-bottom:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:20px;transition:width 0.5s;width:0%}
    .progress-info{display:flex;justify-content:space-between;font-size:0.8rem;color:var(--text2);margin-bottom:16px}
    .q-tag{background:rgba(88,166,255,0.15);color:var(--accent);padding:2px 10px;border-radius:12px;font-weight:600}
    .followup-tag{background:rgba(188,140,255,0.15);color:var(--accent2);padding:2px 10px;border-radius:12px;font-weight:600;font-size:0.75rem}
    .orb-container{display:flex;justify-content:center;margin:24px 0 16px}
    .orb{width:110px;height:110px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(88,166,255,0.8),rgba(188,140,255,0.6),rgba(88,166,255,0.3));position:relative;animation:orbFloat 4s ease-in-out infinite;box-shadow:0 0 30px rgba(88,166,255,0.3),0 0 60px rgba(188,140,255,0.15),inset 0 0 30px rgba(255,255,255,0.1);margin:0 auto}
    .orb::before{content:'';position:absolute;inset:-8px;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);border-right-color:var(--accent2);animation:orbSpin 3s linear infinite}
    .orb::after{content:'';position:absolute;inset:10px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,0.2),transparent 70%);animation:orbPulse 2s ease-in-out infinite}
    @keyframes orbFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes orbSpin{to{transform:rotate(360deg)}}
    @keyframes orbPulse{0%,100%{opacity:0.5;transform:scale(0.9)}50%{opacity:1;transform:scale(1.1)}}
    .orb.speaking{background:radial-gradient(circle at 35% 35%,rgba(63,185,80,0.9),rgba(88,166,255,0.6),rgba(63,185,80,0.3));box-shadow:0 0 40px rgba(63,185,80,0.4);animation:orbFloat 2s ease-in-out infinite,orbSpeak 0.5s ease-in-out infinite}
    @keyframes orbSpeak{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.06)}}
    .orb.listening{background:radial-gradient(circle at 35% 35%,rgba(88,166,255,0.9),rgba(188,140,255,0.8),rgba(88,166,255,0.3));box-shadow:0 0 40px rgba(88,166,255,0.5);animation:orbFloat 2s ease-in-out infinite,orbListen 1s ease-in-out infinite}
    @keyframes orbListen{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.04)}}
    .orb.thinking{opacity:0.6;animation:orbFloat 1.5s ease-in-out infinite}
    .orb.processing{background:radial-gradient(circle at 35% 35%,rgba(210,153,34,0.9),rgba(188,140,255,0.6),rgba(210,153,34,0.3));box-shadow:0 0 40px rgba(210,153,34,0.4);animation:orbFloat 1.5s ease-in-out infinite}
    .orb-label{margin-top:12px;font-size:0.8rem;color:var(--text2);letter-spacing:1px;text-align:center}
    .question-box{background:linear-gradient(135deg,rgba(88,166,255,0.08),rgba(188,140,255,0.08));border:1px solid rgba(88,166,255,0.15);border-radius:14px;padding:20px;margin-bottom:16px;font-size:1.05rem;line-height:1.7;min-height:70px;text-align:center}
    .error-box{background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);border-radius:10px;padding:12px;margin-bottom:12px;font-size:0.85rem;color:var(--red);display:none}
    .error-box.show{display:block}
    .thinking{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--text2);font-size:0.85rem;margin:12px 0}
    .thinking-dots span{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;animation:dot 1.2s infinite}
    .thinking-dots span:nth-child(2){animation-delay:0.2s}
    .thinking-dots span:nth-child(3){animation-delay:0.4s}
    @keyframes dot{0%,100%{opacity:0.2;transform:scale(0.8)}50%{opacity:1;transform:scale(1.3)}}
    .silence-bar-wrap{width:80%;max-width:300px;margin:12px auto;text-align:center;display:none}
    .silence-bar-wrap.show{display:block}
    .silence-bar{height:4px;background:var(--card2);border-radius:2px;overflow:hidden}
    .silence-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s linear;width:100%}
    .silence-text{font-size:0.75rem;color:var(--text2);margin-top:4px}
    .wave-wrap{display:flex;justify-content:center;align-items:center;gap:3px;height:40px;margin:12px 0}
    .wave-bar{width:4px;height:8px;background:var(--accent);border-radius:4px}
    .wave-wrap.active .wave-bar{animation:wave 0.8s ease-in-out infinite alternate}
    .wave-bar:nth-child(1){animation-delay:0s}.wave-bar:nth-child(2){animation-delay:0.1s}.wave-bar:nth-child(3){animation-delay:0.2s}.wave-bar:nth-child(4){animation-delay:0.3s}.wave-bar:nth-child(5){animation-delay:0.4s}.wave-bar:nth-child(6){animation-delay:0.3s}.wave-bar:nth-child(7){animation-delay:0.2s}.wave-bar:nth-child(8){animation-delay:0.1s}.wave-bar:nth-child(9){animation-delay:0s}
    @keyframes wave{from{height:8px}to{height:36px}}
    .timer{text-align:center;font-size:1.4rem;font-weight:700;font-variant-numeric:tabular-nums;margin:8px 0}
    .hf-info{text-align:center;font-size:0.8rem;color:var(--text2);padding:8px;background:rgba(88,166,255,0.05);border-radius:8px;margin-bottom:12px}
    .btn-end{background:rgba(248,81,73,0.15);color:var(--red);width:100%;margin-top:16px;padding:12px;border-radius:10px;border:none;cursor:pointer;font-family:inherit;font-weight:600}
    .status-bar{display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.8rem;color:var(--text2);margin-bottom:12px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

    /* Results */
    .score-ring{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
    .score-num{font-size:2.2rem;font-weight:800}
    .score-max{font-size:0.9rem;color:var(--text2)}
    .grade-badge{display:inline-block;padding:4px 16px;border-radius:16px;font-weight:700;font-size:0.85rem;margin-bottom:12px}
    .hire-badge{display:inline-block;padding:6px 20px;border-radius:20px;font-weight:700;font-size:0.9rem;margin-bottom:16px}
    .summary-section{margin-bottom:16px}
    .summary-section h3{font-size:0.9rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .summary-list{list-style:none;padding:0}
    .summary-list li{padding:6px 0;font-size:0.85rem;color:var(--text2);border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:8px}
    .summary-list li:last-child{border-bottom:none}
    .fb-item{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
    .fb-item .fb-q{font-weight:600;color:var(--accent);margin-bottom:4px;font-size:0.9rem}
    .fb-item .fb-a{font-size:0.8rem;color:var(--text2);margin-bottom:6px;font-style:italic;opacity:0.8}
    .fb-item .fb-score{font-size:0.75rem;padding:2px 8px;border-radius:8px;display:inline-block;margin-bottom:6px}
    .fb-item .fb-text{font-size:0.85rem;color:var(--text2);line-height:1.5}
    .fb-item .fb-type{font-size:0.7rem;padding:1px 6px;border-radius:4px;display:inline-block;margin-left:6px}

    /* Proctoring */
    .proctor-bar{background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.2);border-radius:10px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;font-size:0.8rem}
    .proctor-cam{width:120px;height:90px;border-radius:8px;border:2px solid var(--border);overflow:hidden;position:fixed;bottom:16px;right:16px;z-index:100;background:#000}
    .proctor-cam video{width:100%;height:100%;object-fit:cover}
    .proctor-cam .cam-label{position:absolute;bottom:2px;left:4px;font-size:0.6rem;color:rgba(255,255,255,0.7);background:rgba(0,0,0,0.5);padding:1px 4px;border-radius:3px}
    .violation-item{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(248,81,73,0.08);border-radius:6px;margin-bottom:4px;font-size:0.78rem;color:var(--red)}
    .screen-share-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:20px}
    .screen-share-overlay h2{color:var(--text)}
    .screen-share-overlay p{color:var(--text2);font-size:0.9rem;max-width:400px;text-align:center;line-height:1.6}

    .toast-box{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:10px;font-size:0.85rem;box-shadow:0 8px 24px rgba(0,0,0,0.4);animation:tIn 0.3s ease,tOut 0.3s ease 2.7s forwards}
    @keyframes tIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(120%);opacity:0}}
    .hidden{display:none!important}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:600px){
      .container{padding:10px}.header h1{font-size:1.5rem}
      .row2,.row3,.mode-cards{grid-template-columns:1fr}
      .stat-grid{grid-template-columns:1fr 1fr}
      .orb{width:90px;height:90px}
      .nav-btn{font-size:0.7rem;padding:8px 4px}
      .proctor-cam{width:80px;height:60px}
      .cand-row{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="toast-box" id="toasts"></div>
  <div class="container">
    <div class="header">
      <h1>ğŸ§  AI Interview Platform</h1>
      <p>Intelligent â€¢ Adaptive â€¢ Proctored</p>
    </div>

    <!-- NAV -->
    <div class="nav" id="mainNav">
      <button class="nav-btn active" onclick="nav('home')">ğŸ  Home</button>
      <button class="nav-btn" onclick="nav('jobs')">ğŸ’¼ Jobs</button>
      <button class="nav-btn" onclick="nav('apply')">ğŸ“ Apply</button>
      <button class="nav-btn" onclick="nav('setup')">ğŸ¤ Interview</button>
      <button class="nav-btn" onclick="nav('hr')">ğŸ¢ HR</button>
    </div>

    <!-- HOME -->
    <div id="page-home">
      <div class="mode-cards">
        <div class="mode-card" onclick="nav('jobs')"><div class="mode-icon">ğŸ’¼</div><h3>Browse Jobs</h3><p>View openings & apply</p><span class="mode-badge" style="background:rgba(63,185,80,0.15);color:var(--green);">APPLY</span></div>
        <div class="mode-card" onclick="startMode('mock')"><div class="mode-icon">ğŸ¯</div><h3>Mock Interview</h3><p>Practice freely. No monitoring.</p><span class="mode-badge" style="background:rgba(88,166,255,0.15);color:var(--accent);">FREE</span></div>
        <div class="mode-card" onclick="startMode('real')"><div class="mode-icon">ğŸ”’</div><h3>Real Interview</h3><p>Proctored. Anti-cheat. One attempt.</p><span class="mode-badge" style="background:rgba(248,81,73,0.15);color:var(--red);">PROCTORED</span></div>
        <div class="mode-card" onclick="nav('hr')"><div class="mode-icon">ğŸ¢</div><h3>HR Dashboard</h3><p>Post jobs, manage candidates</p><span class="mode-badge" style="background:rgba(210,153,34,0.15);color:var(--yellow);">ADMIN</span></div>
      </div>
    </div>

    <!-- JOBS -->
    <div id="page-jobs" class="hidden">
      <div class="card"><h2>ğŸ’¼ Open Positions</h2><div id="jobsList"><span class="loading"></span> Loading...</div></div>
    </div>

    <!-- APPLY -->
    <div id="page-apply" class="hidden">
      <div class="card">
        <h2>ğŸ“ Job Application</h2>
        <div id="applyJobInfo" style="color:var(--accent);font-weight:600;margin-bottom:12px;"></div>
        <div class="row2"><div><label>Full Name *</label><input type="text" id="applyName" placeholder="Your name"></div><div><label>Email *</label><input type="email" id="applyEmail" placeholder="you@email.com"></div></div>
        <label>Phone</label><input type="tel" id="applyPhone" placeholder="+91 XXXXX XXXXX">
        <label>Upload Resume (PDF) *</label>
        <div class="upload-area" id="applyUpload" onclick="document.getElementById('applyFile').click()">
          <p>ğŸ“‚ Click to upload <strong>PDF, TXT</strong></p>
          <p id="applyFileName" style="font-size:0.78rem;color:var(--text2);margin-top:4px;">No file</p>
          <input type="file" id="applyFile" accept=".pdf,.txt,.doc,.docx" hidden>
        </div>
        <button class="btn btn-go" id="applyBtn" onclick="submitApplication()">ğŸ“¨ Submit Application</button>
        <div id="applyStatus" style="text-align:center;margin-top:12px;font-size:0.9rem;"></div>
      </div>
    </div>

    <!-- INTERVIEW SETUP -->
    <div id="page-setup" class="hidden">
      <div class="card">
        <h2>âš™ï¸ Interview Setup</h2>
        <div id="modeIndicator" style="text-align:center;margin-bottom:14px;"></div>
        <label>ğŸŒ Language</label>
        <select id="langSel">
          <option value="en">English</option>
          <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)</option>
          <option value="ml">à´®à´²à´¯à´¾à´³à´‚ (Malayalam)</option>
          <option value="ta">à®¤à®®à®¿à®´à¯ (Tamil)</option>
          <option value="te">à°¤à±†à°²à±à°—à± (Telugu)</option>
          <option value="kn">à²•à²¨à³à²¨à²¡ (Kannada)</option>
          <option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾ (Bengali)</option>
          <option value="es">EspaÃ±ol (Spanish)</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
          <option value="fr">FranÃ§ais (French)</option>
          <option value="de">Deutsch (German)</option>
          <option value="ur">Ø§Ø±Ø¯Ùˆ (Urdu)</option>
        </select>
        <label>ğŸ’¼ Job Role</label>
        <select id="roleSel">
          <option value="">â€” Select â€”</option>
          <option value="Frontend Developer">Frontend Developer</option>
          <option value="Backend Developer">Backend Developer</option>
          <option value="Full Stack Developer">Full Stack Developer</option>
          <option value="Mobile Developer">Mobile Developer</option>
          <option value="Data Scientist">Data Scientist</option>
          <option value="DevOps Engineer">DevOps Engineer</option>
          <option value="UI/UX Designer">UI/UX Designer</option>
          <option value="Product Manager">Product Manager</option>
          <option value="QA Engineer">QA Engineer</option>
          <option value="Cybersecurity Analyst">Cybersecurity</option>
          <option value="Sales Representative">Sales</option>
          <option value="Marketing Manager">Marketing</option>
          <option value="HR Recruiter">HR</option>
          <option value="Finance Analyst">Finance</option>
          <option value="Customer Support">Support</option>
          <option value="custom">âœï¸ Custom...</option>
        </select>
        <div id="customWrap" class="hidden"><label>Enter Role</label><input type="text" id="customRole" placeholder="e.g. Blockchain Developer"></div>
        <div class="row2">
          <div><label>ğŸ“Š Level</label><select id="levelSel"><option value="Fresher">Fresher</option><option value="Junior">Junior</option><option value="Mid-Level" selected>Mid-Level</option><option value="Senior">Senior</option><option value="Lead">Lead</option></select></div>
          <div><label>ğŸ”¢ Questions</label><select id="qCount"><option value="5">5</option><option value="8">8</option><option value="10" selected>10</option><option value="15">15</option></select></div>
        </div>
      </div>
      <!-- Real mode: candidate info -->
      <div class="card hidden" id="realInfoCard">
        <h2>ğŸ‘¤ Your Information</h2>
        <div class="row2"><div><label>Full Name *</label><input type="text" id="candName"></div><div><label>Email *</label><input type="email" id="candEmail"></div></div>
        <label>Interview Token</label><input type="text" id="candToken" placeholder="Paste from invitation email">
      </div>
      <div class="card"><h2>ğŸ“„ Resume</h2>
        <div class="upload-area" id="cvUpArea" onclick="document.getElementById('cvFile').click()">
          <p>ğŸ“‚ Upload <strong>PDF, DOC, TXT</strong></p>
          <p id="cvFileName" style="font-size:0.78rem;color:var(--text2);margin-top:4px;">No file</p>
          <input type="file" id="cvFile" accept=".pdf,.doc,.docx,.txt" hidden>
        </div>
      </div>
      <!-- Proctor requirements -->
      <div class="card hidden" id="proctorReqCard">
        <h2>ğŸ”’ Proctoring Requirements</h2>
        <div style="font-size:0.85rem;color:var(--text2);line-height:1.8;">
          <p>âœ… Screen sharing â€” entire screen monitored</p>
          <p>âœ… Camera â€” face must be visible</p>
          <p>âœ… Tab switching â€” flagged as violation</p>
          <p>âœ… Copy/Paste â€” disabled</p>
          <p>âœ… Single attempt â€” cannot restart</p>
          <p style="margin-top:8px;color:var(--yellow);">âš ï¸ 3+ violations = auto-termination</p>
        </div>
      </div>
      <button class="btn btn-go" id="startBtn" onclick="startInterview()">ğŸš€ Start Interview</button>
      <button class="btn btn-secondary" onclick="nav('home')">â† Back</button>
    </div>

    <!-- SCREEN SHARE OVERLAY -->
    <div id="screenShareOverlay" class="screen-share-overlay hidden">
      <h2>ğŸ–¥ï¸ Screen Share Required</h2>
      <p>Share your <strong>entire screen</strong> to start.</p>
      <button class="btn btn-go" style="width:auto;padding:14px 40px;" onclick="requestScreenShare()">ğŸ“º Share Screen</button>
    </div>

    <!-- LIVE INTERVIEW -->
    <div id="page-live" class="hidden">
      <div class="card">
        <div class="proctor-bar" id="proctorBar" style="display:none;"><div style="display:flex;align-items:center;gap:4px;color:var(--green);"><div class="status-dot"></div>Proctored</div><div>âš ï¸ Violations: <span id="violationCount" style="color:var(--red);font-weight:700;">0</span>/3</div></div>
        <div class="progress-wrap"><div class="progress-fill" id="progBar"></div></div>
        <div class="progress-info"><span id="progText">Question 1 of 10</span><span class="q-tag" id="qTag">Q1</span></div>
        <div class="status-bar"><div class="status-dot"></div><span>Interview Active</span></div>
        <div class="orb-container"><div><div class="orb" id="orb"></div><div class="orb-label" id="orbLabel">Preparing...</div></div></div>
        <div class="error-box" id="errorBox"></div>
        <div class="question-box" id="questionBox">Preparing your first question...</div>
        <div class="thinking hidden" id="thinkBox"><div class="thinking-dots"><span></span><span></span><span></span></div><span>Analyzing...</span></div>
        <div class="hf-info" id="hfInfo">ğŸ¤ Hands-free â€” Speak naturally. Auto-submits after pause.</div>
        <div class="wave-wrap" id="waveWrap"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
        <div class="silence-bar-wrap" id="silenceWrap"><div class="silence-bar"><div class="silence-fill" id="silenceFill"></div></div><div class="silence-text" id="silenceText"></div></div>
        <div class="timer" id="timer">00:00</div>
        <button class="btn-end" onclick="endEarly()">â¹ End Interview Early</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="page-results" class="hidden">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">ğŸ† Interview Complete!</h2>
        <div class="score-ring" id="scoreRing"><div style="text-align:center"><div class="score-num" id="scoreNum">0</div><div class="score-max">/ 100</div></div></div>
        <div id="gradeBadge" class="grade-badge">â€”</div><br>
        <div id="hireBadge" class="hire-badge" style="display:none;"></div>
        <p id="scoreSummary" style="color:var(--text2);margin-bottom:20px;line-height:1.6;"></p>
        <div id="retryWrap" style="display:none;"><button class="btn btn-secondary" onclick="retryEvaluation()">ğŸ”„ Retry Evaluation</button></div>
      </div>
      <div class="card" id="violationsCard" style="display:none;"><h2>ğŸ” Proctoring Report</h2><div id="violationsList"></div></div>
      <div class="card" id="strengthsCard" style="display:none;">
        <div class="summary-section"><h3>ğŸ’ª Strengths</h3><ul class="summary-list" id="strengthsList"></ul></div>
        <div class="summary-section"><h3>ğŸ“ˆ Improvements</h3><ul class="summary-list" id="improveList"></ul></div>
      </div>
      <div class="card"><h2>ğŸ“ Detailed Feedback</h2><div id="fbList"></div></div>
      <button class="btn btn-go" onclick="nav('home')">ğŸ  Home</button>
    </div>

    <!-- HR DASHBOARD -->
    <div id="page-hr" class="hidden">
      <div class="stat-grid"><div class="stat-card"><div class="stat-num" id="statJobs">0</div><div class="stat-label">Jobs</div></div><div class="stat-card"><div class="stat-num" id="statApps">0</div><div class="stat-label">Applications</div></div><div class="stat-card"><div class="stat-num" id="statShort">0</div><div class="stat-label">Shortlisted</div></div><div class="stat-card"><div class="stat-num" id="statInt">0</div><div class="stat-label">Interviews</div></div></div>
      <div class="card">
        <h2>ğŸ“¢ Post Job</h2>
        <label>Title *</label><input type="text" id="hrTitle" placeholder="e.g. Senior Frontend Developer">
        <div class="row2"><div><label>Category</label><select id="hrCat"><option value="IT/Software">IT/Software</option><option value="Accounting">Accounting</option><option value="Sales/Marketing">Sales/Marketing</option><option value="Management">Management</option></select></div><div><label>Department</label><input type="text" id="hrDept" placeholder="Engineering"></div></div>
        <div class="row2"><div><label>Company</label><input type="text" id="hrCompany" placeholder="Company name"></div><div><label>Location</label><input type="text" id="hrLocation" placeholder="Kochi, Kerala"></div></div>
        <div class="row3"><div><label>Level</label><select id="hrLevel"><option value="Fresher">Fresher</option><option value="Junior">Junior</option><option value="Mid-Level" selected>Mid-Level</option><option value="Senior">Senior</option><option value="Lead">Lead</option></select></div><div><label>Questions</label><select id="hrQCount"><option value="5">5</option><option value="8">8</option><option value="10" selected>10</option><option value="15">15</option></select></div><div><label>ATS Threshold</label><select id="hrATS"><option value="0">Manual</option><option value="50">50+</option><option value="60">60+</option><option value="70" selected>70+</option><option value="80">80+</option></select></div></div>
        <label>Description</label><textarea id="hrJD" placeholder="Job description..."></textarea>
        <label>Skills (comma separated)</label><input type="text" id="hrSkills" placeholder="React, TypeScript, Node.js">
        <button class="btn btn-go" onclick="postJob()">ğŸ“¢ Post Job</button>
      </div>
      <div class="card"><h2>ğŸ“ Jobs</h2><div id="hrJobsList"></div></div>
      <div class="card" id="hrCandCard" style="display:none;"><h2 id="hrCandTitle">ğŸ‘¥ Candidates</h2><div id="hrCandList"></div></div>
    </div>
  </div>

  <!-- Proctor Cam -->
  <div class="proctor-cam hidden" id="proctorCam"><video id="proctorVideo" autoplay muted playsinline></video><div class="cam-label">ğŸ”´ REC</div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” NO SUPABASE KEYS EXPOSED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
const SILENCE_TIMEOUT=3.0, MIN_ANS=10, MAX_RETRIES=3, MAX_VIOLATIONS=3;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mode="mock",cv="",lang="en",role="",level="",totalQ=10;
let mainQ=0,isFollowUp=false,chat=[],answers=[];
let rec=null,transcript="",timerInt=null,secs=0;
let listening=false,silTimer=null,lastSpeech=0;
let speaking=false,processing=false,ansStart=0;
let evalRetry=0,violations=[],screenStr=null,camStr=null;
let curJobId=null,curAppId=null,selHRJob=null;

const L={
  en:{s:"en-US",t:"en-US",n:"English"},hi:{s:"hi-IN",t:"hi-IN",n:"Hindi"},
  ml:{s:"ml-IN",t:"ml-IN",n:"Malayalam"},ta:{s:"ta-IN",t:"ta-IN",n:"Tamil"},
  te:{s:"te-IN",t:"te-IN",n:"Telugu"},kn:{s:"kn-IN",t:"kn-IN",n:"Kannada"},
  bn:{s:"bn-IN",t:"bn-IN",n:"Bengali"},es:{s:"es-ES",t:"es-ES",n:"Spanish"},
  ar:{s:"ar-SA",t:"ar-SA",n:"Arabic"},fr:{s:"fr-FR",t:"fr-FR",n:"French"},
  de:{s:"de-DE",t:"de-DE",n:"German"},ur:{s:"ur-PK",t:"ur-PK",n:"Urdu"}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DB HELPER (calls Worker proxy â€” no keys in frontend)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function db(action,table,data=null,filters=null,select=null,order=null){
  const r=await fetch(W+"/db",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action,table,data,filters,select,order})});
  return await r.json();
}
async function uploadFile(file,fileName){
  const fd=new FormData();fd.append("file",file);fd.append("fileName",fileName);
  const r=await fetch(W+"/upload",{method:"POST",body:fd});return await r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(m){const c=document.getElementById("toasts"),t=document.createElement("div");t.className="toast";t.textContent=m;c.appendChild(t);setTimeout(()=>t.remove(),3200)}
function showError(m){const b=document.getElementById("errorBox");if(b){b.textContent=m;b.classList.add("show");setTimeout(()=>b.classList.remove("show"),8000)}}

function nav(p){
  const pages=['home','jobs','apply','setup','live','results','hr'];
  pages.forEach(x=>document.getElementById('page-'+x)?.classList.add('hidden'));
  document.getElementById('page-'+p)?.classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const map={home:0,jobs:1,apply:2,setup:3,live:3,results:3,hr:4};
  document.querySelectorAll('.nav-btn')[map[p]||0]?.classList.add('active');
  if(p==='jobs')loadJobs();
  if(p==='hr')loadHR();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOBS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadJobs(){
  const el=document.getElementById('jobsList');
  el.innerHTML='<span class="loading"></span> Loading...';
  try{
    const data=await db('select','jobs',null,{is_active:true},null,'created_at.desc');
    if(!data||!data.length||data.error){el.innerHTML='<p style="color:var(--text2);text-align:center;padding:20px;">No open positions.</p>';return}
    el.innerHTML=data.map(j=>`<div class="job-card">
      <h3>${j.title||''}</h3>
      <div class="job-meta"><span>ğŸ¢ ${j["Company Name"]||j.department||''}</span><span>ğŸ“ ${j.location||''} ${j.Country?'('+j.Country+')':''}</span><span>ğŸ“Š ${j.level||'Mid-Level'}</span></div>
      <p style="font-size:0.82rem;color:var(--text2);margin:6px 0;">${(j.description||'').substring(0,180)}${j.description?.length>180?'...':''}</p>
      <div>${(j.skills||[]).map(s=>'<span class="skill-tag">'+s+'</span>').join('')}</div>
      <button class="btn btn-go" style="margin-top:10px;padding:10px;" onclick="applyTo('${j.id}','${(j.title||'').replace(/'/g,"\\'")}')">ğŸ“ Apply</button>
    </div>`).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">Error: '+e.message+'</p>'}
}

function applyTo(jobId,title){curJobId=jobId;document.getElementById('applyJobInfo').textContent='Applying for: '+title;nav('apply')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLICATION + ATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _resumeFile=null;
document.getElementById('applyFile').addEventListener('change',async e=>{
  const file=e.target.files[0];if(!file)return;
  document.getElementById('applyFileName').textContent='â³ Processing...';
  try{
    cv=await extractFile(file);
    if(cv.length<30){document.getElementById('applyFileName').textContent='âš ï¸ Try TXT';cv='';return}
    document.getElementById('applyFileName').textContent='âœ… '+file.name;
    document.getElementById('applyUpload').classList.add('ok');
    _resumeFile=file;toast('âœ… Resume loaded!');
  }catch(err){document.getElementById('applyFileName').textContent='âŒ Error';cv=''}
});

async function submitApplication(){
  const name=document.getElementById('applyName').value.trim();
  const email=document.getElementById('applyEmail').value.trim();
  if(!name||!email){toast('âŒ Name & Email required');return}
  if(!cv){toast('âŒ Upload resume');return}
  const btn=document.getElementById('applyBtn');btn.disabled=true;btn.textContent='â³ Submitting...';
  const st=document.getElementById('applyStatus');st.textContent='';
  try{
    let resume_url='';
    if(_resumeFile){
      st.textContent='ğŸ“¤ Uploading resume...';
      const fn=Date.now()+'_'+_resumeFile.name;
      const up=await uploadFile(_resumeFile,fn);
      resume_url=up.url||'';
    }
    st.textContent='ğŸ“ Saving...';
    const result=await db('insert','applications',{
      job_id:curJobId||null,name,email,
      phone:document.getElementById('applyPhone').value.trim(),
      resume_url,resume_text:cv.substring(0,5000),status:'applied'
    });
    const app=Array.isArray(result)?result[0]:result;
    curAppId=app?.id;
    st.textContent='ğŸ¤– AI screening resume...';
    if(app?.id)await runATS(app);
    st.innerHTML='<span style="color:var(--green);">âœ… Application submitted!</span>';
    toast('âœ… Submitted!');
    document.getElementById('applyName').value='';document.getElementById('applyEmail').value='';
    document.getElementById('applyFileName').textContent='No file';document.getElementById('applyUpload').classList.remove('ok');
    cv='';_resumeFile=null;
  }catch(err){st.innerHTML='<span style="color:var(--red);">âŒ '+err.message+'</span>';toast('âŒ Failed')}
  btn.disabled=false;btn.textContent='ğŸ“¨ Submit Application';
}

async function runATS(app){
  try{
    let jobDesc='',jobSkills=[],atsThresh=70,jobRole='',jobLevel='';
    if(app.job_id){
      const job=await db('select','jobs',null,{id:app.job_id},null,null);
      const j=Array.isArray(job)?job[0]:job;
      if(j){jobDesc=j.description||'';jobSkills=j.skills||[];atsThresh=j.ats_threshold||70;jobRole=j.title;jobLevel=j.level}
    }
    const raw=await callAI([
      {role:"system",content:"You are an ATS screening AI. Return ONLY valid JSON."},
      {role:"user",content:`Score resume for "${jobRole||'General'}" (${jobLevel||'Mid-Level'}).
Job: ${jobDesc||'Standard role'}\nSkills: ${jobSkills.join(',')||'General'}\nResume: ${app.resume_text||cv}
Return ONLY: {"atsScore":75,"matchedSkills":["s1"],"missingSkills":["s1"],"summary":"Brief"}`}
    ]);
    const r=safeJSON(raw);const score=Math.min(100,Math.max(0,r.atsScore||50));
    const status=atsThresh>0&&score>=atsThresh?'shortlisted':'applied';
    await db('update','applications',{ats_score:score,ats_matched_skills:r.matchedSkills||[],ats_missing_skills:r.missingSkills||[],ats_summary:r.summary||'',status},{id:app.id});
    if(status==='shortlisted'){
      const token=crypto.randomUUID?crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36);
      await db('insert','interviews',{application_id:app.id,job_id:app.job_id,token,interview_type:'real',status:'pending',interview_role:jobRole,interview_level:jobLevel,question_count:10,interview_language:'en',expires_at:new Date(Date.now()+72*3600000).toISOString()});
    }
    console.log('[ATS] Score:',score,'Status:',status);
  }catch(e){console.error('[ATS]',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE EXTRACTORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function extractFile(f){
  const ext=f.name.split('.').pop().toLowerCase();
  let text='';
  if(ext==='txt')text=await f.text();
  else if(ext==='pdf')text=await extractPDF(f);
  else if(ext==='doc'||ext==='docx')text=await extractDOC(f);
  else text=await f.text();
  return text.replace(/\s+/g,' ').replace(/[^\x20-\x7E\n]/g,'').trim().substring(0,5000);
}
async function extractPDF(f){if(!window.pdfjsLib)return exFB(f);try{const b=await f.arrayBuffer(),p=await pdfjsLib.getDocument({data:b}).promise;let t='';for(let i=1;i<=p.numPages;i++){const pg=await p.getPage(i),c=await pg.getTextContent();t+=c.items.map(x=>x.str).join(' ')+'\n'}return t}catch(e){return exFB(f)}}
async function extractDOC(f){const b=await f.arrayBuffer();if(f.name.endsWith('.docx')){try{const t=new TextDecoder('utf-8').decode(new Uint8Array(b)),m=t.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);if(m&&m.length)return m.map(x=>x.replace(/<[^>]+>/g,'')).join(' ')}catch(e){}}return exFB(f)}
async function exFB(f){const b=await f.arrayBuffer(),t=new TextDecoder('utf-8',{fatal:false}).decode(b),r=t.match(/[a-zA-Z0-9@.,:;!?\-/()\s]{5,}/g);return r?r.filter(s=>(s.match(/[a-zA-Z]/g)||[]).length/s.length>0.5&&s.trim().length>5).join(' '):''}

// CV upload for interview setup
document.getElementById('cvFile').addEventListener('change',async e=>{
  const file=e.target.files[0];if(!file)return;
  document.getElementById('cvFileName').textContent='â³ Processing...';
  try{cv=await extractFile(file);if(cv.length<30){document.getElementById('cvFileName').textContent='âš ï¸ Try TXT';cv='';return}
  document.getElementById('cvFileName').textContent='âœ… '+file.name;document.getElementById('cvUpArea').classList.add('ok');toast('âœ… Loaded!')}catch(e){document.getElementById('cvFileName').textContent='âŒ Error';cv=''}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callAI(messages){
  const ctrl=new AbortController();const tm=setTimeout(()=>ctrl.abort(),45000);
  try{const r=await fetch(W,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages}),signal:ctrl.signal});clearTimeout(tm);
  if(!r.ok)throw new Error('Error '+r.status);const d=await r.json();if(!d.response)throw new Error("Empty");return d.response}
  catch(e){clearTimeout(tm);if(e.name==='AbortError')throw new Error("Timeout");throw e}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JSON PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function safeJSON(raw){let c=raw.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();const m=c.match(/\{[\s\S]*\}/);if(!m)throw new Error('No JSON');c=m[0].replace(/,\s*([}\]])/g,'$1');c=c.replace(/:\s*"([^"]*?)"/gs,(m,v)=>': "'+v.replace(/\n/g,' ').replace(/\r/g,'').replace(/\t/g,' ').replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'"');try{return JSON.parse(c)}catch(e){try{return JSON.parse(c.replace(/[\x00-\x1F\x7F]/g,' '))}catch(e2){return exFields(raw)}}}
function exFields(raw){const gn=k=>{const m=raw.match(new RegExp(`"${k}"\\s*:\\s*(\\d+)`));return m?parseInt(m[1]):0};const gs=k=>{const m=raw.match(new RegExp(`"${k}"\\s*:\\s*"([^"]*?)"`));return m?m[1]:''};const ga=k=>{const m=raw.match(new RegExp(`"${k}"\\s*:\\s*\\[([^\\]]*?)\\]`,'s'));if(!m)return[];const i=m[1].match(/"([^"]*?)"/g);return i?i.map(s=>s.replace(/"/g,'')):[]};const fb=[];for(const m of raw.matchAll(/"question"\s*:\s*"([^"]*?)"[^}]*?"score"\s*:\s*(\d+)[^}]*?"comment"\s*:\s*"([^"]*?)"/gs))fb.push({question:m[1].substring(0,100),score:parseInt(m[2]),comment:m[3],type:'main'});return{overallScore:gn('overallScore')||50,grade:gs('grade')||'C',recommendation:gs('recommendation')||'Pending',summary:gs('summary')||'Done.',strengths:ga('strengths'),improvements:ga('improvements'),feedback:fb.length?fb:answers.map(a=>({question:a.question.substring(0,80),score:a.skipped?0:5,comment:a.skipped?'Skipped':'Recorded',type:a.type}))}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERVIEW SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById("roleSel").addEventListener("change",e=>{document.getElementById("customWrap").classList.toggle("hidden",e.target.value!=="custom")});

function startMode(m){
  mode=m;nav('setup');
  const ind=document.getElementById('modeIndicator');
  if(m==='real'){
    ind.innerHTML='<span class="mode-badge" style="background:rgba(248,81,73,0.15);color:var(--red);font-size:0.85rem;padding:6px 16px;">ğŸ”’ PROCTORED</span>';
    document.getElementById('realInfoCard').classList.remove('hidden');
    document.getElementById('proctorReqCard').classList.remove('hidden');
  }else{
    ind.innerHTML='<span class="mode-badge" style="background:rgba(63,185,80,0.15);color:var(--green);font-size:0.85rem;padding:6px 16px;">ğŸ¯ MOCK PRACTICE</span>';
    document.getElementById('realInfoCard').classList.add('hidden');
    document.getElementById('proctorReqCard').classList.add('hidden');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORB / TTS / STT / SILENCE / TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setOrb(s){const o=document.getElementById('orb'),l=document.getElementById('orbLabel');if(!o)return;o.className='orb';switch(s){case'speaking':o.classList.add('speaking');l.textContent='Speaking...';break;case'listening':o.classList.add('listening');l.textContent='Listening...';break;case'thinking':o.classList.add('thinking');l.textContent='Thinking...';break;case'processing':o.classList.add('processing');l.textContent='Processing...';break;default:l.textContent='Ready'}}
function updateProg(){const p=Math.round((mainQ/totalQ)*100);document.getElementById('progBar').style.width=p+'%';if(isFollowUp){document.getElementById('progText').textContent=`Follow-up Q${mainQ}/${totalQ}`;document.getElementById('qTag').textContent=`Q${mainQ}â†©`;document.getElementById('qTag').className='followup-tag'}else{document.getElementById('progText').textContent=`Question ${mainQ}/${totalQ} â€” ${p}%`;document.getElementById('qTag').textContent=`Q${mainQ}`;document.getElementById('qTag').className='q-tag'}}

if('speechSynthesis' in window){speechSynthesis.getVoices();speechSynthesis.onvoiceschanged=()=>{}}
function speak(text){return new Promise(res=>{if(!('speechSynthesis' in window)){res();return}speechSynthesis.cancel();speaking=true;setOrb('speaking');setTimeout(()=>{const u=new SpeechSynthesisUtterance(text);u.lang=L[lang]?.t||'en-US';u.rate=0.92;u.pitch=1;u.volume=1;const v=speechSynthesis.getVoices().find(v=>v.lang.startsWith((L[lang]?.t||'en-US').split('-')[0]));if(v)u.voice=v;u.onend=()=>{speaking=false;res()};u.onerror=()=>{speaking=false;res()};speechSynthesis.speak(u)},100)})}

function initSTT(){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){toast('âš ï¸ Use Chrome');return}rec=new SR();rec.lang=L[lang]?.s||'en-US';rec.interimResults=true;rec.continuous=true;rec.onresult=e=>{let f='';for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)f+=e.results[i][0].transcript+' '}if(f){transcript+=f;lastSpeech=Date.now();resetSil();startSil()}};rec.onerror=e=>{if(e.error!=='no-speech'&&e.error!=='aborted')console.error('[STT]',e.error)};rec.onend=()=>{if(listening&&!processing&&!speaking)try{rec.start()}catch(e){}}}
function startListen(){if(!rec||listening)return;listening=true;transcript='';lastSpeech=Date.now();ansStart=Date.now();try{rec.start()}catch(e){try{rec.stop()}catch(e2){}setTimeout(()=>{try{rec.start()}catch(e3){}},200)}setOrb('listening');document.getElementById('waveWrap').classList.add('active');document.getElementById('hfInfo').textContent='ğŸ¤ Listening...';startTimer();startSil()}
function stopListen(){listening=false;resetSil();try{rec?.stop()}catch(e){}document.getElementById('waveWrap')?.classList.remove('active');stopTimer()}

function startSil(){resetSil();silTimer=setInterval(()=>{if(!listening||processing||speaking)return;const sf=(Date.now()-lastSpeech)/1000;if(transcript.trim().length>=MIN_ANS&&sf>=1){const rem=Math.max(0,SILENCE_TIMEOUT-sf);document.getElementById('silenceWrap').classList.add('show');document.getElementById('silenceFill').style.width=(rem/SILENCE_TIMEOUT*100)+'%';document.getElementById('silenceText').textContent=rem>0?`Auto-submit ${rem.toFixed(1)}s...`:'Submitting...';if(sf>=SILENCE_TIMEOUT)autoSubmit()}else{document.getElementById('silenceWrap').classList.remove('show')}},200)}
function resetSil(){clearInterval(silTimer);silTimer=null;document.getElementById('silenceWrap')?.classList.remove('show')}

function startTimer(){secs=0;showTime();timerInt=setInterval(()=>{secs++;showTime()},1000)}
function stopTimer(){clearInterval(timerInt)}
function showTime(){const el=document.getElementById('timer');if(el)el.textContent=`${Math.floor(secs/60).toString().padStart(2,'0')}:${(secs%60).toString().padStart(2,'0')}`}
function showThink(s){document.getElementById('thinkBox')?.classList.toggle('hidden',!s);const w=document.getElementById('waveWrap');if(w)w.style.display=s?'none':'flex';const h=document.getElementById('hfInfo');if(h)h.style.display=s?'none':'block';document.getElementById('silenceWrap')?.classList.remove('show');if(s)document.getElementById('questionBox').textContent=''}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCTORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addViolation(type,detail){if(mode!=='real')return;violations.push({type,detail,time:new Date().toLocaleTimeString(),qNum:mainQ});document.getElementById('violationCount').textContent=violations.length;toast('âš ï¸ '+detail);if(violations.length>=MAX_VIOLATIONS){toast('ğŸš« Terminated!');endEarly()}}
function startProctor(){if(mode!=='real')return;document.getElementById('proctorBar').style.display='flex';violations=[];document.addEventListener('visibilitychange',onVis);window.addEventListener('blur',onBlur);document.addEventListener('copy',onClip);document.addEventListener('paste',onClip);document.addEventListener('cut',onClip);document.addEventListener('contextmenu',onCtx);document.addEventListener('keydown',onKey);startCam()}
function stopProctor(){document.removeEventListener('visibilitychange',onVis);window.removeEventListener('blur',onBlur);document.removeEventListener('copy',onClip);document.removeEventListener('paste',onClip);document.removeEventListener('cut',onClip);document.removeEventListener('contextmenu',onCtx);document.removeEventListener('keydown',onKey);if(screenStr){screenStr.getTracks().forEach(t=>t.stop());screenStr=null}if(camStr){camStr.getTracks().forEach(t=>t.stop());camStr=null}document.getElementById('proctorCam')?.classList.add('hidden');document.getElementById('proctorBar').style.display='none'}
function onVis(){if(document.hidden&&mode==='real')addViolation('tab','Switched tab')}
function onBlur(){if(mode==='real'&&!document.hidden)addViolation('blur','Window lost focus')}
function onClip(e){if(mode==='real'){e.preventDefault();addViolation('clip','Attempted '+e.type)}}
function onCtx(e){if(mode==='real')e.preventDefault()}
function onKey(e){if(mode!=='real')return;if((e.ctrlKey||e.metaKey)&&['c','v','u','s','a','p'].includes(e.key.toLowerCase())){e.preventDefault();addViolation('key','Ctrl+'+e.key.toUpperCase())}if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&['i','j','c'].includes(e.key.toLowerCase()))){e.preventDefault();addViolation('dev','DevTools attempt')}}
async function startCam(){try{camStr=await navigator.mediaDevices.getUserMedia({video:true,audio:false});document.getElementById('proctorVideo').srcObject=camStr;document.getElementById('proctorCam').classList.remove('hidden')}catch(e){addViolation('cam','Camera denied')}}
async function requestScreenShare(){try{screenStr=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:'monitor'}});screenStr.getVideoTracks()[0].onended=()=>{if(mode==='real')addViolation('screen','Screen share stopped')};document.getElementById('screenShareOverlay').classList.add('hidden');toast('âœ… Screen sharing active');actuallyStart()}catch(e){toast('âŒ Screen share required')}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START INTERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startInterview(){
  const rs=document.getElementById('roleSel').value;
  if(!rs){toast('âŒ Select role');return}
  role=rs==='custom'?document.getElementById('customRole').value.trim():rs;
  if(!role){toast('âŒ Enter role');return}
  lang=document.getElementById('langSel').value;level=document.getElementById('levelSel').value;
  totalQ=parseInt(document.getElementById('qCount').value);
  mainQ=0;isFollowUp=false;answers=[];chat=[];evalRetry=0;violations=[];

  if(mode==='real'){
    const n=document.getElementById('candName').value.trim();
    const e=document.getElementById('candEmail').value.trim();
    if(!n||!e){toast('âŒ Name & Email required');return}
    document.getElementById('screenShareOverlay').classList.remove('hidden');return;
  }
  const btn=document.getElementById('startBtn');btn.disabled=true;btn.textContent='â³ Connecting...';
  try{const t=await fetch(W,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'user',content:'Say OK'}]})});if(!t.ok)throw new Error('Worker error')}
  catch(e){toast('âŒ '+e.message);btn.disabled=false;btn.textContent='ğŸš€ Start Interview';return}
  btn.disabled=false;btn.textContent='ğŸš€ Start Interview';actuallyStart();
}

async function actuallyStart(){
  document.getElementById('screenShareOverlay').classList.add('hidden');
  const sys=`You are an expert AI interviewer for a ${level}-level "${role}" position.
LANGUAGE: ${L[lang]?.n||'English'} only.
${cv?'\nRESUME:\n'+cv+'\n':''}
RULES:
1. Ask ${totalQ} MAIN questions. Mix behavioral, technical, situational.
2. For vague answers, ask C.L.A.I.M. follow-ups.
3. Follow-ups don't count toward ${totalQ} total.
4. Be conversational, professional. Adapt to ${level} level.
FORMAT: [NEXT] new question | [FOLLOWUP] follow-up | [DONE] end message
Start with [NEXT] and first question.`;

  chat=[{role:'system',content:sys}];nav('live');
  if(mode==='real')startProctor();
  setOrb('thinking');showThink(true);
  try{
    const fq=await callAI(chat);chat.push({role:'assistant',content:fq});
    const cl=fq.replace(/\[NEXT\]\s*/i,'').replace(/\[FOLLOWUP\]\s*/i,'').trim();
    mainQ=1;isFollowUp=false;showThink(false);document.getElementById('questionBox').textContent=cl;updateProg();
    initSTT();await speak(cl);startListen();toast('ğŸ¯ Started!');
  }catch(e){showError('âŒ '+e.message);showThink(false);setOrb('idle')}
}

async function autoSubmit(){
  if(processing)return;processing=true;stopListen();setOrb('processing');
  const ans=transcript.trim();
  if(!ans||ans.length<MIN_ANS){processing=false;toast('ğŸ¤ Still listening...');setTimeout(()=>startListen(),500);return}
  const q=document.getElementById('questionBox').textContent;
  const dur=Math.round((Date.now()-ansStart)/1000);
  answers.push({question:q,answer:ans,type:isFollowUp?'followup':'main',mainQNum:mainQ,duration:dur,skipped:false});
  transcript='';await getNext(ans);processing=false;
}

async function getNext(ans){
  showThink(true);setOrb('thinking');
  const p=`Candidate answered: "${ans}"
Main asked: ${mainQ}/${totalQ}.
- Vague â†’ [FOLLOWUP] probe
- Good â†’ [NEXT] new question
${mainQ>=totalQ&&!isFollowUp?'- All done â†’ [DONE] brief thanks':''}
Output ONLY tag + question. Stay in ${L[lang]?.n||'English'}.`;
  chat.push({role:'user',content:p});
  try{
    const r=await callAI(chat);chat.push({role:'assistant',content:r});showThink(false);
    const u=r.toUpperCase(),cl=r.replace(/\[FOLLOWUP\]\s*/i,'').replace(/\[NEXT\]\s*/i,'').replace(/\[DONE\]\s*/i,'').trim();
    if(u.includes('[DONE]')){document.getElementById('questionBox').textContent=cl;mainQ=totalQ;updateProg();await speak(cl);setTimeout(()=>showResults(),2000);return}
    if(u.includes('[NEXT]')){mainQ++;isFollowUp=false;if(mainQ>totalQ)mainQ=totalQ}
    if(u.includes('[FOLLOWUP]'))isFollowUp=true;
    document.getElementById('questionBox').textContent=cl;updateProg();await speak(cl);startListen();
  }catch(e){showError('âŒ '+e.message);showThink(false);setOrb('idle')}
}

function endEarly(){if(answers.length<1){toast('âš ï¸ Answer at least 1');return}stopListen();speechSynthesis?.cancel();showResults()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showResults(){stopListen();speechSynthesis?.cancel();stopProctor();nav('results');toast('ğŸ“Š Evaluating...');await genEval()}

async function genEval(){
  const qa=answers.map(a=>{const t=a.type==='followup'?'FOLLOW-UP':'MAIN Q'+a.mainQNum;return`[${t}] (${a.duration||0}s)\nQ: ${a.question.replace(/["\n\r\t\\]/g,' ').substring(0,200)}\nA: ${a.skipped?'SKIPPED':a.answer.replace(/["\n\r\t\\]/g,' ').substring(0,300)}`}).join('\n\n');
  const em=[{role:'system',content:'You are a hiring evaluator. Return ONLY valid JSON. No markdown.'},{role:'user',content:`Evaluate this ${level} interview for ${role}.
${violations.length?'VIOLATIONS: '+violations.length+'\n':''}Transcript:\n${qa}\n
Return ONLY: {"overallScore":65,"grade":"B","recommendation":"Lean Hire","summary":"Brief.","strengths":["s1"],"improvements":["i1"],"feedback":[{"question":"q","score":7,"comment":"c","type":"main"}]}
Keep strings short. ONLY JSON.`}];
  try{
    const raw=await callAI(em);const r=safeJSON(raw);
    if(typeof r.overallScore!=='number'||r.overallScore<0||r.overallScore>100)r.overallScore=50;
    if(violations.length){r.overallScore=Math.max(0,r.overallScore-violations.length*5);r.summary+=' ('+violations.length+' violations, -'+violations.length*5+'pts)'}
    renderRes(r);await saveResults(r);toast('ğŸ† Done!');document.getElementById('retryWrap').style.display='none';
  }catch(e){console.error('[EVAL]',e);evalRetry++;if(evalRetry<MAX_RETRIES){toast('âš ï¸ Retry '+evalRetry+'/'+MAX_RETRIES);await genEval()}else{toast('âš ï¸ Local eval');renderFallback();document.getElementById('retryWrap').style.display='block'}}
}

async function saveResults(r){
  try{if(!curAppId)return;
  const token=crypto.randomUUID?crypto.randomUUID():Date.now().toString(36);
  await db('insert','interviews',{application_id:curAppId,job_id:curJobId,token,interview_type:mode,status:'completed',interview_role:role,interview_level:level,interview_language:lang,question_count:totalQ,started_at:new Date(Date.now()-secs*1000).toISOString(),completed_at:new Date().toISOString(),duration_seconds:secs,overall_score:r.overallScore,grade:r.grade,recommendation:r.recommendation,summary:r.summary,strengths:r.strengths||[],improvements:r.improvements||[],feedback:r.feedback||[],answers:answers,violation_log:violations,violation_count:violations.length});
  await db('update','applications',{status:'interviewed'},{id:curAppId});
  console.log('[DB] Saved!')}catch(e){console.error('[DB]',e)}
}

async function retryEvaluation(){evalRetry=0;toast('ğŸ”„ Retrying...');document.getElementById('scoreNum').textContent='0';document.getElementById('gradeBadge').textContent='â€”';document.getElementById('fbList').innerHTML='';document.getElementById('strengthsCard').style.display='none';document.getElementById('hireBadge').style.display='none';document.getElementById('retryWrap').style.display='none';await genEval()}

function renderFallback(){const ma=answers.filter(a=>a.type==='main'&&!a.skipped).length;const sc=Math.max(0,Math.round((ma/Math.max(totalQ,1))*70)-violations.length*5);renderRes({overallScore:sc,grade:sc>=70?'B':sc>=50?'C':'D',recommendation:sc>=60?'Lean Hire':'Lean No Hire',summary:`Answered ${ma}/${totalQ}.${violations.length?' '+violations.length+' violations.':''}`,strengths:ma>0?['Participated']:[],improvements:['More detail'],feedback:answers.map(a=>({question:a.question.substring(0,80),score:a.skipped?0:5,comment:a.skipped?'Skipped':'Recorded',type:a.type}))})}

function renderRes(r){
  const sc=r.overallScore||0,gr=r.grade||'?',ok=sc>=80,mid=sc>=60;
  const col=ok?'#3fb950':mid?'#d29922':'#f85149',bg=ok?'rgba(63,185,80,0.15)':mid?'rgba(210,153,34,0.15)':'rgba(248,81,73,0.15)';
  document.getElementById('scoreRing').style.background=`conic-gradient(${col} ${sc*3.6}deg, rgba(255,255,255,0.05) 0deg)`;
  const b=document.getElementById('gradeBadge');b.textContent='Grade: '+gr;b.style.background=bg;b.style.color=col;
  if(r.recommendation){const h=document.getElementById('hireBadge');h.style.display='inline-block';h.textContent=r.recommendation;const hire=r.recommendation.toLowerCase().includes('hire')&&!r.recommendation.toLowerCase().includes('no');h.style.background=hire?'rgba(63,185,80,0.15)':'rgba(248,81,73,0.15)';h.style.color=hire?'#3fb950':'#f85149'}
  document.getElementById('scoreSummary').textContent=r.summary||'';
  if(r.strengths?.length||r.improvements?.length){document.getElementById('strengthsCard').style.display='block';const sl=document.getElementById('strengthsList');sl.innerHTML='';(r.strengths||[]).forEach(s=>{sl.innerHTML+='<li><span>âœ…</span> '+s+'</li>'});const il=document.getElementById('improveList');il.innerHTML='';(r.improvements||[]).forEach(s=>{il.innerHTML+='<li><span>ğŸ“ˆ</span> '+s+'</li>'})}
  if(violations.length){document.getElementById('violationsCard').style.display='block';const vl=document.getElementById('violationsList');vl.innerHTML='';violations.forEach(v=>{vl.innerHTML+='<div class="violation-item"><span style="font-size:0.7rem;color:var(--text2);">'+v.time+'</span> âš ï¸ '+v.detail+'</div>'})}
  const list=document.getElementById('fbList');list.innerHTML='';(r.feedback||[]).forEach((fb,i)=>{
    const s=fb.score||0,c=s>=7?'#3fb950':s>=5?'#d29922':'#f85149',bg2=s>=7?'rgba(63,185,80,0.15)':s>=5?'rgba(210,153,34,0.15)':'rgba(248,81,73,0.15)';
    const tc=fb.type==='followup'?'rgba(188,140,255,0.15)':'rgba(88,166,255,0.15)',tt=fb.type==='followup'?'#bc8cff':'#58a6ff',tl=fb.type==='followup'?'Follow-up':'Main';
    const ma=answers[i],pv=ma?(ma.skipped?'[Skipped]':ma.answer.substring(0,120)+(ma.answer.length>120?'...':'')):'';
    const d=document.createElement('div');d.className='fb-item';
    d.innerHTML=`<div class="fb-q">${fb.question}<span class="fb-type" style="background:${tc};color:${tt};">${tl}</span></div>${pv?`<div class="fb-a">"${pv}"</div>`:''}<span class="fb-score" style="background:${bg2};color:${c};">${s}/10</span><div class="fb-text">${fb.comment}</div>`;
    list.appendChild(d)});
  let cur=0;const el=document.getElementById('scoreNum');const iv=setInterval(()=>{cur+=Math.ceil(sc/30);if(cur>=sc){cur=sc;clearInterval(iv)}el.textContent=cur},30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HR DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHR(){
  try{
    const jobs=await db('select','jobs');
    const apps=await db('select','applications');
    const ints=await db('select','interviews');
    document.getElementById('statJobs').textContent=Array.isArray(jobs)?jobs.length:0;
    document.getElementById('statApps').textContent=Array.isArray(apps)?apps.length:0;
    document.getElementById('statShort').textContent=Array.isArray(apps)?apps.filter(a=>a.status==='shortlisted').length:0;
    document.getElementById('statInt').textContent=Array.isArray(ints)?ints.length:0;
  }catch(e){console.error(e)}
  loadHRJobs();
}

async function loadHRJobs(){
  const el=document.getElementById('hrJobsList');
  try{
    const data=await db('select','jobs',null,null,null,'created_at.desc');
    if(!data?.length||data.error){el.innerHTML='<p style="color:var(--text2);text-align:center;">No jobs.</p>';return}
    el.innerHTML=data.map(j=>`<div class="job-card" style="cursor:pointer;" onclick="loadCands('${j.id}','${(j.title||'').replace(/'/g,"\\'")}')">
      <div style="display:flex;justify-content:space-between;"><h3>${j.title}</h3><span class="status-pill" style="background:${j.is_active?'rgba(63,185,80,0.15)':'rgba(248,81,73,0.15)'};color:${j.is_active?'#3fb950':'#f85149'};">${j.is_active?'Active':'Inactive'}</span></div>
      <div class="job-meta"><span>ğŸ¢ ${j["Company Name"]||j.department||''}</span><span>ğŸ“ ${j.location||''}</span><span>ğŸ“Š ${j.level||''}</span><span>ğŸ¯ ATS:${j.ats_threshold>0?j.ats_threshold+'+':'Manual'}</span></div>
    </div>`).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}

async function postJob(){
  const title=document.getElementById('hrTitle').value.trim();if(!title){toast('âŒ Enter title');return}
  try{await db('insert','jobs',{
    title,category:document.getElementById('hrCat').value,
    department:document.getElementById('hrDept').value.trim(),
    "Company Name":document.getElementById('hrCompany').value.trim(),
    location:document.getElementById('hrLocation').value.trim(),
    level:document.getElementById('hrLevel').value,
    description:document.getElementById('hrJD').value.trim(),
    skills:document.getElementById('hrSkills').value.split(',').map(s=>s.trim()).filter(Boolean),
    question_count:parseInt(document.getElementById('hrQCount').value),
    ats_threshold:parseInt(document.getElementById('hrATS').value),
    is_active:true,status:'active'
  });toast('âœ… Posted!');document.getElementById('hrTitle').value='';document.getElementById('hrJD').value='';document.getElementById('hrSkills').value='';loadHRJobs();loadHR()}catch(e){toast('âŒ '+e.message)}
}

async function loadCands(jobId,title){
  selHRJob=jobId;document.getElementById('hrCandCard').style.display='block';
  document.getElementById('hrCandTitle').textContent='ğŸ‘¥ '+title;
  const el=document.getElementById('hrCandList');el.innerHTML='<span class="loading"></span>';
  try{
    const data=await db('select','applications',null,{job_id:jobId},null,'created_at.desc');
    if(!data?.length||data.error){el.innerHTML='<p style="color:var(--text2);text-align:center;padding:16px;">No candidates.</p>';return}
    el.innerHTML=data.map(c=>{
      const sc=c.ats_score||0,col=sc>=70?'#3fb950':sc>=50?'#d29922':'#f85149',bg=sc>=70?'rgba(63,185,80,0.15)':sc>=50?'rgba(210,153,34,0.15)':'rgba(248,81,73,0.15)';
      const stc={applied:'#d29922',shortlisted:'#3fb950',interviewed:'#58a6ff',rejected:'#f85149'}[c.status]||'#8b949e';
      const stb={applied:'rgba(210,153,34,0.15)',shortlisted:'rgba(63,185,80,0.15)',interviewed:'rgba(88,166,255,0.15)',rejected:'rgba(248,81,73,0.15)'}[c.status]||'rgba(255,255,255,0.05)';
      return`<div class="cand-row">
        <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:180px;">
          <div class="cand-avatar">${(c.name||'?')[0].toUpperCase()}</div>
          <div><div style="font-weight:600;font-size:0.88rem;">${c.name||'?'}</div><div style="font-size:0.72rem;color:var(--text2);">${c.email||''}</div></div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <span class="score-badge" style="background:${bg};color:${col};">ATS:${sc}</span>
          <span class="status-pill" style="background:${stb};color:${stc};">${c.status}</span>
          ${c.status==='applied'?`<button class="btn btn-sm btn-success" onclick="shortlist('${c.id}')">âœ…</button>`:''}
          ${c.status==='shortlisted'?`<button class="btn btn-sm" style="background:var(--accent);" onclick="sendInvite('${c.id}','${(c.email||'').replace(/'/g,"\\'")}')">ğŸ“§</button>`:''}
          ${c.status!=='rejected'?`<button class="btn btn-sm btn-danger" onclick="reject('${c.id}')">âŒ</button>`:''}
          ${c.resume_url?`<a href="${c.resume_url}" target="_blank" class="btn btn-sm btn-secondary" style="text-decoration:none;">ğŸ“„</a>`:''}
        </div></div>`;
    }).join('');
  }catch(e){el.innerHTML='<p style="color:var(--red);">'+e.message+'</p>'}
}

async function shortlist(id){try{await db('update','applications',{status:'shortlisted'},{id});toast('âœ… Shortlisted');loadCands(selHRJob,'')}catch(e){toast('âŒ '+e.message)}}
async function reject(id){try{await db('update','applications',{status:'rejected'},{id});toast('Rejected');loadCands(selHRJob,'')}catch(e){toast('âŒ '+e.message)}}
async function sendInvite(appId,email){
  try{const token=crypto.randomUUID?crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36);
  const job=await db('select','jobs',null,{id:selHRJob});const j=Array.isArray(job)?job[0]:job;
  await db('insert','interviews',{application_id:appId,job_id:selHRJob,token,interview_type:'real',status:'pending',interview_role:j?.title||'',interview_level:j?.level||'Mid-Level',question_count:j?.question_count||10,interview_language:j?.interview_language||'en',expires_at:new Date(Date.now()+72*3600000).toISOString()});
  const url=`${location.origin}${location.pathname}?token=${token}`;
  try{await navigator.clipboard.writeText(url)}catch(e){}
  toast('âœ… Link created!');alert(`ğŸ“§ Send to ${email}:\n\n${url}\n\n(Copied!)`);loadCands(selHRJob,'')}catch(e){toast('âŒ '+e.message)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN FROM URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkToken(){
  const token=new URLSearchParams(location.search).get('token');if(!token)return;
  toast('ğŸ”’ Token detected...');
  try{const data=await db('select','interviews',null,{token});
  const d=Array.isArray(data)?data[0]:data;
  if(!d||d.error){toast('âŒ Invalid token');return}
  if(d.status==='completed'){toast('âŒ Already completed');return}
  if(d.expires_at&&new Date(d.expires_at)<new Date()){toast('âŒ Expired');return}
  mode='real';curAppId=d.application_id;curJobId=d.job_id;
  startMode('real');
  if(d.interview_role){document.getElementById('roleSel').value=d.interview_role;role=d.interview_role}
  if(d.interview_level)document.getElementById('levelSel').value=d.interview_level;
  if(d.question_count)document.getElementById('qCount').value=d.question_count;
  if(d.interview_language)document.getElementById('langSel').value=d.interview_language;
  // Load candidate info
  if(d.application_id){const apps=await db('select','applications',null,{id:d.application_id});const a=Array.isArray(apps)?apps[0]:apps;
  if(a){document.getElementById('candName').value=a.name||'';document.getElementById('candEmail').value=a.email||'';if(a.resume_text){cv=a.resume_text;document.getElementById('cvFileName').textContent='âœ… Resume loaded'}}}
  document.getElementById('candToken').value=token;
  toast('âœ… Ready! Click Start.')}catch(e){toast('âŒ '+e.message)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  if(window.pdfjsLib)console.log('âœ… PDF.js');
  if(!window.SpeechRecognition&&!window.webkitSpeechRecognition)console.warn('âš ï¸ Use Chrome');
  checkToken();
});
</script>
</body>
</html>
