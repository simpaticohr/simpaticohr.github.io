<script>
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

/* ================= INTERVIEW STATE ================= */
let interviewState = {
  candidate: {
    role: "Candidate",
    experience: 0,
    skills: []
  },
  interview: {
    topic: "intro",
    depth: 0,
    maxDepth: 3,
    turn: 0,
    completed: false
  }
};

/* ================= QUESTION ENGINE ================= */
const TOPICS = ["intro", "skills", "experience", "impact", "close"];

function nextTopic(state) {
  const i = TOPICS.indexOf(state.interview.topic);
  state.interview.topic = TOPICS[i + 1] || "close";
  state.interview.depth = 0;

  if (state.interview.topic === "close") {
    state.interview.completed = true;
  }
}

function getBaseQuestion(state) {
  const q = {
    intro: [
      "Tell me about yourself.",
      "What is your current role?",
      "What kind of role are you looking for?"
    ],
    skills: [
      "What skills do you use daily?",
      "Which skill are you strongest at?",
      "How do you apply those skills?"
    ],
    experience: [
      "Describe a challenging situation you handled.",
      "What was your personal role in that?",
      "Why did you choose that approach?"
    ],
    impact: [
      "What was the outcome?",
      "How did it impact the organization?",
      "What did you learn from it?"
    ],
    close: [
      "Is there anything else you'd like to add?"
    ]
  };

  return q[state.interview.topic][state.interview.depth] || q[state.interview.topic][0];
}

/* ================= CORE FUNCTION (PASTE HERE) ================= */
async function sendAnswer(answer) {
  if (interviewState.interview.completed) return;

  interviewState.interview.turn++;
  interviewState.interview.depth++;

  const baseQ = getBaseQuestion(interviewState);

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        answer,
        state: interviewState
      })
    });

    const data = await res.json();

    if (interviewState.interview.depth >= interviewState.interview.maxDepth) {
      nextTopic(interviewState);
    }

    if (interviewState.interview.completed) {
      speakAndListen("Thank you. The interview is complete.");
      return;
    }

    speakAndListen(data.followUp || baseQ);

  } catch (e) {
    speakAndListen(baseQ);
  }
}
</script>
