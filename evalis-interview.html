<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evalis AI â€“ Elite Interviewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root { --bg:#0f172a; --card:#1e293b; --accent:#4f46e5; --muted:#94a3b8; }
body {
  margin:0; background:var(--bg); color:white;
  font-family:Inter,sans-serif;
  display:flex; justify-content:center; align-items:center; min-height:100vh;
}
.container {
  width:92%; max-width:480px;
  background:var(--card); padding:28px;
  border-radius:22px; border:1px solid #334155;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
}
#status {
  font-size:11px; letter-spacing:2px;
  color:var(--muted); margin-bottom:10px;
  text-transform:uppercase; text-align:center;
}
.timer {
  font-size:3.5rem; font-weight:800;
  color:var(--accent); text-align:center;
  font-family:monospace; margin:12px 0;
}
#volume-bar {
  width:100%; height:6px; background:#020617;
  border-radius:3px; margin-bottom:20px; overflow:hidden;
}
#volume-fill {
  height:100%; width:0%;
  background:var(--accent);
}
button {
  width:100%; padding:16px;
  border:none; border-radius:12px;
  background:var(--accent); color:white;
  font-weight:700; cursor:pointer;
}
button:disabled { opacity:.5; cursor:not-allowed; }
#transcript {
  margin-top:20px; height:180px;
  overflow-y:auto; background:#020617;
  padding:14px; border-radius:12px;
  border:1px solid #334155; font-size:13px;
}
.ai { color:#a5b4fc; margin-bottom:10px; }
.user { color:#94a3b8; font-style:italic; margin-bottom:8px; }
</style>
</head>

<body>
<div class="container">
  <div id="status">Upload Resume to Start</div>
  <div class="timer" id="timer">15:00</div>
  <div id="volume-bar"><div id="volume-fill"></div></div>

  <input type="file" id="cvInput" accept=".pdf" style="margin-bottom:15px;font-size:12px">
  <button id="startBtn" disabled>Start Technical Interview</button>

  <div id="transcript"></div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let cvText="", history=[], active=false, busy=false, timeLeft=900;

/* ================= PDF ================= */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

cvInput.onchange = async e => {
  const file = e.target.files[0];
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:new Uint8Array(buffer)}).promise;
  let text="";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const c = await page.getTextContent();
    text += c.items.map(x=>x.str).join(" ")+" ";
  }
  cvText = text.trim();
  status.innerText = "Resume Synced";
  startBtn.disabled = false;
};

/* ================= HELPERS ================= */
function isErrorReply(t){
  return /not clear|repeat|system issue|couldn't hear/i.test(t);
}

function logUser(t){
  transcript.innerHTML += `<div class="user">You: ${t}</div>`;
  transcript.scrollTop = transcript.scrollHeight;
}

function logAI(t){
  transcript.innerHTML += `<div class="ai">AI: ${t}</div>`;
  transcript.scrollTop = transcript.scrollHeight;
}

/* ================= SPEAK ================= */
function speak(text){
  if(!text) return;
  logAI(text);

  const u = new SpeechSynthesisUtterance(text);
  speechSynthesis.cancel();

  u.onend = () => {
    busy = false;
    if(active && !isErrorReply(text)){
      setTimeout(startTurn, 600);
    } else {
      status.innerText = "Waiting for your response...";
    }
  };
  speechSynthesis.speak(u);
}

/* ================= LISTEN ================= */
async function startTurn(){
  if(!active || busy || timeLeft<=0) return;
  status.innerText = "Listening...";

  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const rec = new MediaRecorder(stream);
  const chunks=[];

  const audioCtx = new AudioContext();
  const src = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  src.connect(analyser);
  const data = new Uint8Array(analyser.frequencyBinCount);

  function meter(){
    analyser.getByteFrequencyData(data);
    volume-fill.style.width = (Math.max(...data)/2)+"%";
    if(!busy) requestAnimationFrame(meter);
  }
  meter();

  rec.ondataavailable = e => chunks.push(e.data);

  rec.onstop = async ()=>{
    busy = true;
    stream.getTracks().forEach(t=>t.stop());
    audioCtx.close();

    const audio = new Blob(chunks,{type:"audio/webm"});
    if(audio.size < 2500){
      busy=false;
      status.innerText="Speak clearly...";
      return;
    }

    status.innerText="Analyzing...";
    const fd=new FormData();
    fd.append("mode","interview");
    fd.append("audio",audio);
    fd.append("cvText",cvText);
    fd.append("history",JSON.stringify(history));

    try{
      const r=await fetch(WORKER_URL,{method:"POST",body:fd});
      const d=await r.json();
      if(d.transcript) logUser(d.transcript);
      history=d.history||history;
      speak(d.reply);
    }catch{
      busy=false;
      speak("Connection issue. Please repeat.");
    }
  };

  rec.start();
  setTimeout(()=>rec.stop(),8000);
}

/* ================= START ================= */
startBtn.onclick = async ()=>{
  active=true;
  startBtn.style.display="none";
  status.innerText="Analyzing CV...";

  const fd=new FormData();
  fd.append("mode","start");
  fd.append("cvText",cvText);

  try{
    const r=await fetch(WORKER_URL,{method:"POST",body:fd});
    const d=await r.json();
    history=d.history||[];
    speak(d.reply);
  }catch{
    speak("Describe the most complex system you've built.");
  }
};

/* ================= TIMER ================= */
setInterval(()=>{
  if(active && timeLeft>0){
    timeLeft--;
    timer.innerText =
      Math.floor(timeLeft/60)+":"+String(timeLeft%60).padStart(2,"0");
  }
},1000);
</script>
</body>
</html>
