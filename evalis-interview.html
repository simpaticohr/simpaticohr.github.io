<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evalis AI – Voice Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin:0;
  background:#020617;
  color:white;
  font-family:system-ui,sans-serif;
  padding:20px;
}
button {
  width:100%;
  padding:16px;
  font-size:16px;
  font-weight:700;
  border-radius:12px;
  border:none;
  background:#6366f1;
  color:white;
  margin-top:10px;
}
button:disabled { opacity:.4 }
#status { color:#94a3b8; margin:10px 0 }
#log div { margin:10px 0 }
input { margin-top:10px }
</style>
</head>

<body>

<h2>Evalis AI – Live Interview</h2>
<p id="status">Upload your resume to begin</p>

<input type="file" id="cvInput" accept="application/pdf">
<button id="startBtn" disabled>Start Interview</button>

<div id="log"></div>

<script>
/* ---------------- CONFIG ---------------- */
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

/* ---------------- STATE ---------------- */
let recognition;
let history = [];
let cvText = "";
let listening = false;

/* ---------------- PDF ---------------- */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

document.getElementById("cvInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById("status").innerText = "Reading resume…";

  try {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({
      data: buffer,
      disableWorker: true
    }).promise;

    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(it => it.str).join(" ") + " ";
    }

    cvText = text.trim();
    if (cvText.length < 50) throw new Error();

    document.getElementById("status").innerText = "Resume loaded ✓";
    document.getElementById("startBtn").disabled = false;

  } catch {
    document.getElementById("status").innerText = "Failed to read PDF";
  }
};

/* ---------------- UI ---------------- */
function add(who, text) {
  const d = document.createElement("div");
  d.innerHTML = `<b>${who}:</b> ${text}`;
  document.getElementById("log").appendChild(d);
}

/* ---------------- SPEAK ---------------- */
function speak(text) {
  return new Promise(res => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.95;
    u.onend = res;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  });
}

/* ---------------- LISTEN ---------------- */
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("Speech Recognition not supported");
    return;
  }

  recognition = new SR();
  recognition.lang = "en-US";
  recognition.continuous = false;

  recognition.onresult = async e => {
    const text = e.results[0][0].transcript.trim();
    if (!text) return;

    add("You", text);
    document.getElementById("status").innerText = "Thinking…";

    const fd = new FormData();
    fd.append("mode","interview");
    fd.append("text", text);
    fd.append("history", JSON.stringify(history));
    fd.append("cvText", cvText);

    const r = await fetch(API,{method:"POST",body:fd});
    const d = await r.json();
    history = d.history || history;

    add("AI", d.reply);
    await speak(d.reply);

    document.getElementById("status").innerText = "Listening…";
    recognition.start(); // auto follow-up
  };

  recognition.onerror = () => {
    if (listening) recognition.start();
  };
}

/* ---------------- START ---------------- */
document.getElementById("startBtn").onclick = async () => {
  document.getElementById("startBtn").disabled = true;
  listening = true;
  initRecognition();

  document.getElementById("status").innerText = "Starting interview…";

  const fd = new FormData();
  fd.append("mode","start");
  fd.append("cvText", cvText);

  const r = await fetch(API,{method:"POST",body:fd});
  const d = await r.json();
  history = d.history || [];

  add("AI", d.reply);
  await speak(d.reply);

  document.getElementById("status").innerText = "Listening…";
  recognition.start();
};
</script>

</body>
</html>
