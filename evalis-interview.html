<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Evalis AI â€“ Elite Interviewer</title>

<style>
:root { --bg:#0f172a; --card:#1e293b; --accent:#4f46e5; --muted:#94a3b8; }
body {
  margin:0; background:var(--bg); color:white;
  font-family:Inter,system-ui,sans-serif;
  display:flex; justify-content:center; align-items:center; min-height:100vh;
}
.container {
  width:92%; max-width:480px;
  background:var(--card); padding:28px; border-radius:22px;
  border:1px solid #334155; box-shadow:0 20px 40px rgba(0,0,0,.45);
}
#status { font-size:11px; letter-spacing:2px; color:var(--muted);
  margin-bottom:10px; text-transform:uppercase; text-align:center; }
.timer { font-size:3.2rem; font-weight:800; color:var(--accent);
  text-align:center; font-family:monospace; margin:12px 0; }
button {
  width:100%; padding:16px; border:none; border-radius:12px;
  background:var(--accent); color:white; font-weight:700; cursor:pointer;
}
button:disabled { opacity:.5; cursor:not-allowed; }
#transcript {
  margin-top:18px; height:200px; overflow-y:auto;
  background:#020617; padding:14px; border-radius:12px;
  border:1px solid #334155; font-size:13px;
}
.ai { color:#a5b4fc; margin-bottom:10px; }
.user { color:#94a3b8; font-style:italic; margin-bottom:8px; }
</style>
</head>

<body>
<div class="container">
  <div id="status">UPLOAD RESUME TO START</div>
  <div class="timer" id="timer">15:00</div>

  <input type="file" id="cvInput" accept=".pdf" style="margin-bottom:14px;font-size:12px">
  <button id="startBtn" disabled>Start Technical Interview</button>

  <div id="transcript"></div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

let cvFile = null;
let history = [];
let active = false;
let busy = false;
let timeLeft = 900;

/* ================= FILE HANDLING ================= */
cvInput.onchange = e => {
  cvFile = e.target.files[0];
  if (!cvFile) return;
  status.innerText = "RESUME READY";
  startBtn.disabled = false;
};

/* ================= SPEAK ================= */
function speak(text) {
  if (!text) return;
  transcript.innerHTML += `<div class="ai">AI: ${text}</div>`;
  transcript.scrollTop = transcript.scrollHeight;

  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.onend = () => {
    busy = false;
    if (active) setTimeout(startListening, 400);
  };
  speechSynthesis.speak(u);
}

/* ================= LISTEN ================= */
async function startListening() {
  if (!active || busy || timeLeft <= 0) return;
  busy = true;
  status.innerText = "LISTENING...";

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const recorder = new MediaRecorder(stream);
  const chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = async () => {
    stream.getTracks().forEach(t => t.stop());
    const audio = new Blob(chunks, { type: "audio/webm" });

    if (audio.size < 3000) {
      busy = false;
      status.innerText = "PLEASE SPEAK CLEARLY";
      setTimeout(startListening, 1000);
      return;
    }

    status.innerText = "ANALYZING ANSWER...";

    const fd = new FormData();
    fd.append("mode", "interview");
    fd.append("audio", audio);
    fd.append("history", JSON.stringify(history));

    try {
      const res = await fetch(WORKER_URL, { method: "POST", body: fd });
      const data = await res.json();

      if (data.transcript) {
        transcript.innerHTML += `<div class="user">You: ${data.transcript}</div>`;
      }

      history = data.history || history;
      speak(data.reply);

    } catch {
      busy = false;
      speak("Connection issue. Please repeat your answer.");
    }
  };

  recorder.start();
  setTimeout(() => recorder.stop(), 7000);
}

/* ================= START ================= */
startBtn.onclick = async () => {
  if (!cvFile) return;

  active = true;
  busy = true;
  startBtn.style.display = "none";
  status.innerText = "ANALYZING RESUME...";

  const fd = new FormData();
  fd.append("mode", "start");
  fd.append("cv", cvFile);

  try {
    const res = await fetch(WORKER_URL, { method: "POST", body: fd });
    const data = await res.json();
    history = data.history || [];
    speak(data.reply);
  } catch {
    busy = false;
    speak("Describe the most complex system you have designed.");
  }
};

/* ================= TIMER ================= */
setInterval(() => {
  if (!active || timeLeft <= 0) return;
  timeLeft--;
  const m = Math.floor(timeLeft / 60);
  const s = timeLeft % 60;
  timer.innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
}, 1000);
</script>
</body>
</html>
