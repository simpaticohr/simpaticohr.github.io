```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>   simpatico hr | Elite AI Interviewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #06060b;
            --surface: #0d0d14;
            --surface-elevated: #14141f;
            --surface-hover: #1a1a28;
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-glow: rgba(99, 102, 241, 0.25);
            --accent: #a855f7;
            --accent-glow: rgba(168, 85, 247, 0.2);
            --success: #10b981;
            --success-light: #34d399;
            --success-glow: rgba(16, 185, 129, 0.25);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.25);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.2);
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-dim: #475569;
            --border: rgba(255, 255, 255, 0.06);
            --border-light: rgba(255, 255, 255, 0.1);
            --radius: 16px;
            --radius-sm: 10px;
            --radius-lg: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* â”€â”€ Ambient Background â”€â”€ */
        .bg-ambient {
            position: fixed; inset: 0;
            background:
                radial-gradient(ellipse 80% 60% at 50% 20%, rgba(99,102,241,0.07) 0%, transparent 60%),
                radial-gradient(ellipse 60% 50% at 80% 80%, rgba(168,85,247,0.05) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 20% 70%, rgba(16,185,129,0.04) 0%, transparent 60%);
            pointer-events: none; z-index: 0;
        }

        .noise-overlay {
            position: fixed; inset: 0;
            opacity: 0.015;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 0;
        }

        /* â”€â”€ Top Bar â”€â”€ */
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 56px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            background: rgba(6,6,11,0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }

        .top-bar .brand {
            display: flex; align-items: center; gap: 10px;
        }

        .top-bar .brand-icon {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: 700; color: white;
        }

        .top-bar .brand-name {
            font-weight: 700; font-size: 1.05rem;
            background: linear-gradient(135deg, var(--text), var(--text-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .top-bar .timer-display {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.95rem; font-weight: 600;
            color: var(--text-secondary);
            padding: 6px 14px;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 100px;
            letter-spacing: 0.05em;
            transition: all 0.3s;
        }

        .top-bar .timer-display.warning {
            color: var(--warning);
            border-color: rgba(245,158,11,0.3);
            background: rgba(245,158,11,0.08);
            animation: pulse-glow-warning 1.5s ease-in-out infinite;
        }

        .top-bar .timer-display.danger {
            color: var(--danger);
            border-color: rgba(239,68,68,0.3);
            background: rgba(239,68,68,0.08);
            animation: pulse-glow-danger 1s ease-in-out infinite;
        }

        /* â”€â”€ Phase Progress Bar â”€â”€ */
        .phase-bar {
            position: fixed; top: 56px; left: 0; right: 0;
            height: 44px;
            display: none; align-items: center; justify-content: center; gap: 6px;
            padding: 0 16px;
            background: rgba(6,6,11,0.8);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            z-index: 99;
        }

        .phase-bar.active { display: flex; }

        .phase-step {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.72rem; font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            transition: color 0.3s;
        }

        .phase-step.current { color: var(--primary-light); }
        .phase-step.done { color: var(--success); }

        .phase-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
            transition: all 0.3s;
        }

        .phase-step.current .phase-dot {
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary-glow);
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        .phase-step.done .phase-dot { background: var(--success); }

        .phase-connector {
            width: 20px; height: 1px;
            background: var(--border-light);
        }

        .phase-step.done + .phase-connector { background: var(--success); }

        /* â”€â”€ Main Content Area â”€â”€ */
        .main-content {
            flex: 1;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 80px 20px 20px;
            position: relative; z-index: 1;
            overflow: hidden;
        }

        .main-content.with-phase { padding-top: 120px; }

        /* â”€â”€ Orb â”€â”€ */
        .orb-wrapper {
            position: relative;
            width: 260px; height: 260px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 32px;
            flex-shrink: 0;
        }

        .orb-ring {
            position: absolute;
            border-radius: 50%;
            border: 1.5px solid rgba(99,102,241,0.08);
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: border-color 0.5s;
        }

        .orb-ring:nth-child(1) {
            width: 200px; height: 200px;
            animation: ring-float 8s ease-in-out infinite, ring-spin 25s linear infinite;
        }
        .orb-ring:nth-child(2) {
            width: 260px; height: 260px;
            animation: ring-float-alt 10s ease-in-out infinite, ring-spin-rev 30s linear infinite;
            border-style: dashed;
            border-color: rgba(168,85,247,0.06);
        }

        .orb-core {
            width: 130px; height: 130px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            box-shadow:
                0 0 60px var(--primary-glow),
                0 0 100px rgba(99,102,241,0.15),
                inset 0 0 30px rgba(255,255,255,0.08);
            position: relative; z-index: 3;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; justify-content: center;
        }

        .orb-core:active { transform: scale(0.93); }

        .orb-icon {
            font-size: 2rem;
            opacity: 0.9;
            transition: all 0.3s;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
        }

        /* Orb States */
        .orb-core.idle { animation: orb-breathe 4s ease-in-out infinite; }

        .orb-core.listening {
            background: linear-gradient(135deg, #059669, var(--success));
            box-shadow:
                0 0 60px var(--success-glow),
                0 0 100px rgba(16,185,129,0.15),
                inset 0 0 30px rgba(255,255,255,0.1);
            animation: orb-pulse-listen 1.5s ease-in-out infinite;
            transform: scale(1.08);
        }

        .orb-core.thinking {
            background: linear-gradient(135deg, #d97706, var(--warning));
            box-shadow:
                0 0 60px var(--warning-glow),
                0 0 100px rgba(245,158,11,0.15),
                inset 0 0 30px rgba(255,255,255,0.1);
            animation: orb-spin-think 2.5s linear infinite;
            border-radius: 42%;
        }

        .orb-core.speaking {
            animation: orb-breathe-speak 0.8s ease-in-out infinite;
            transform: scale(1.04);
        }

        .listening .orb-ring { border-color: rgba(16,185,129,0.12); }
        .thinking .orb-ring { border-color: rgba(245,158,11,0.1); }
        .speaking .orb-ring { border-color: rgba(99,102,241,0.12); }

        /* â”€â”€ Status Area â”€â”€ */
        .status-area {
            text-align: center;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 18px;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 0.85rem; font-weight: 500;
            color: var(--text-secondary);
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .status-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--text-dim);
            transition: all 0.3s;
        }

        .status-badge.listening { border-color: rgba(16,185,129,0.2); }
        .status-badge.listening .status-dot {
            background: var(--success);
            box-shadow: 0 0 6px var(--success-glow);
            animation: dot-pulse 1s ease-in-out infinite;
        }

        .status-badge.thinking { border-color: rgba(245,158,11,0.2); }
        .status-badge.thinking .status-dot {
            background: var(--warning);
            animation: dot-pulse 0.7s ease-in-out infinite;
        }

        .status-badge.speaking { border-color: rgba(99,102,241,0.2); }
        .status-badge.speaking .status-dot {
            background: var(--primary);
            animation: dot-pulse 0.5s ease-in-out infinite;
        }

        .question-counter {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 8px;
            font-weight: 500;
        }

        /* â”€â”€ Transcript Panel â”€â”€ */
        .transcript-panel {
            width: 100%; max-width: 600px;
            flex: 1;
            min-height: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        .transcript-panel.active { display: flex; }

        .transcript-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }

        .transcript-header span {
            font-size: 0.8rem; font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .transcript-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            scroll-behavior: smooth;
        }

        .transcript-body::-webkit-scrollbar { width: 4px; }
        .transcript-body::-webkit-scrollbar-track { background: transparent; }
        .transcript-body::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        .msg {
            margin-bottom: 16px;
            animation: msg-appear 0.3s ease-out;
        }

        .msg-label {
            font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 6px;
        }

        .msg-label.ai { color: var(--primary-light); }
        .msg-label.user { color: var(--success-light); }

        .msg-text {
            font-size: 0.88rem;
            line-height: 1.6;
            color: var(--text-secondary);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            background: var(--surface-elevated);
            border: 1px solid var(--border);
        }

        .msg.ai .msg-text {
            border-left: 3px solid var(--primary);
        }

        .msg.user .msg-text {
            border-left: 3px solid var(--success);
        }

        /* â”€â”€ Setup Panel â”€â”€ */
        .setup-panel {
            width: 100%; max-width: 480px;
            text-align: center;
        }

        .setup-title {
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
            letter-spacing: -0.02em;
        }

        .setup-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem; font-weight: 400;
            margin-bottom: 36px;
        }

        .upload-zone {
            border: 2px dashed var(--border-light);
            padding: 44px 28px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            display: block;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            background: var(--surface);
            margin-bottom: 16px;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            color: var(--text);
            background: rgba(99,102,241,0.04);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(99,102,241,0.1);
        }

        .upload-zone .uz-icon { font-size: 2.8rem; margin-bottom: 14px; display: block; }
        .upload-zone .uz-title { font-weight: 700; font-size: 1.05rem; margin-bottom: 4px; }
        .upload-zone .uz-sub { font-size: 0.82rem; color: var(--text-dim); }

        .upload-zone.loaded {
            border-color: var(--success);
            border-style: solid;
            background: rgba(16,185,129,0.04);
        }

        .upload-zone.loaded .uz-icon::after { content: ' âœ“'; }

        input[type="file"] { display: none; }

        /* â”€â”€ Buttons â”€â”€ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-weight: 600; font-size: 0.95rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--surface-elevated);
            color: var(--text);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .btn:active:not(:disabled) { transform: translateY(0); }

        .btn:disabled {
            opacity: 0.4; cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none; color: white;
            box-shadow: 0 4px 16px var(--primary-glow);
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 8px 32px var(--primary-glow);
        }

        .btn-end {
            background: rgba(239,68,68,0.08);
            border-color: rgba(239,68,68,0.2);
            color: var(--danger);
            width: auto;
            padding: 8px 18px;
            font-size: 0.82rem;
        }

        .btn-end:hover:not(:disabled) {
            background: rgba(239,68,68,0.12);
            box-shadow: 0 4px 16px var(--danger-glow);
        }

        /* â”€â”€ Report Modal â”€â”€ */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.92);
            backdrop-filter: blur(12px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
        }

        .modal-overlay.open { display: flex; }

        .modal-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            max-width: 640px; width: 100%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 24px 64px rgba(0,0,0,0.5);
            animation: modal-in 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column;
        }

        .modal-header {
            padding: 28px 28px 0;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 1.5rem; font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .modal-header p {
            color: var(--text-dim); font-size: 0.85rem;
        }

        .modal-body {
            flex: 1; overflow-y: auto;
            padding: 20px 28px;
        }

        .report-content {
            line-height: 1.75;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-size: 0.9rem;
            background: var(--bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .modal-footer {
            padding: 16px 28px 28px;
            flex-shrink: 0;
        }

        /* â”€â”€ Animations â”€â”€ */
        @keyframes orb-breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        @keyframes orb-breathe-speak {
            0%, 100% { transform: scale(1.04); }
            50% { transform: scale(1.1); }
        }

        @keyframes orb-pulse-listen {
            0%, 100% {
                box-shadow: 0 0 60px var(--success-glow), 0 0 100px rgba(16,185,129,0.15), inset 0 0 30px rgba(255,255,255,0.1);
            }
            50% {
                box-shadow: 0 0 80px var(--success-glow), 0 0 130px rgba(16,185,129,0.2), inset 0 0 40px rgba(255,255,255,0.15);
            }
        }

        @keyframes orb-spin-think {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes ring-float {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-8px); }
        }

        @keyframes ring-float-alt {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(8px); }
        }

        @keyframes ring-spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes ring-spin-rev { 100% { transform: translate(-50%, -50%) rotate(-360deg); } }

        @keyframes dot-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        @keyframes pulse-dot {
            0%, 100% { box-shadow: 0 0 4px var(--primary-glow); }
            50% { box-shadow: 0 0 12px var(--primary-glow); }
        }

        @keyframes pulse-glow-warning {
            0%, 100% { box-shadow: 0 0 0 rgba(245,158,11,0); }
            50% { box-shadow: 0 0 12px rgba(245,158,11,0.15); }
        }

        @keyframes pulse-glow-danger {
            0%, 100% { box-shadow: 0 0 0 rgba(239,68,68,0); }
            50% { box-shadow: 0 0 12px rgba(239,68,68,0.2); }
        }

        @keyframes msg-appear {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modal-in {
            from { opacity: 0; transform: scale(0.92) translateY(16px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 640px) {
            .orb-wrapper { width: 220px; height: 220px; margin-bottom: 24px; }
            .orb-core { width: 110px; height: 110px; }
            .orb-ring:nth-child(1) { width: 170px; height: 170px; }
            .orb-ring:nth-child(2) { width: 220px; height: 220px; }
            .setup-title { font-size: 1.6rem; }
            .modal-header, .modal-body, .modal-footer { padding-left: 20px; padding-right: 20px; }
            .phase-step { font-size: 0.65rem; }
            .phase-connector { width: 12px; }
        }

        @supports (padding: max(0px)) {
            .top-bar { padding-top: env(safe-area-inset-top); height: calc(56px + env(safe-area-inset-top)); }
        }

        /* â”€â”€ Scrollbar â”€â”€ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }
    </style>
</head>
<body>

<div class="bg-ambient"></div>
<div class="noise-overlay"></div>

<!-- Top Bar -->
<div class="top-bar">
    <div class="brand">
        <div class="brand-icon">E</div>
        <span class="brand-name">Evalis AI</span>
    </div>
    <div id="timerDisplay" class="timer-display" style="display:none;">15:00</div>
    <button id="endBtn" class="btn-end" style="display:none;" title="End Interview">âœ• End</button>
</div>

<!-- Phase Progress -->
<div id="phaseBar" class="phase-bar">
    <div class="phase-step" data-phase="intro"><span class="phase-dot"></span> Intro</div>
    <div class="phase-connector"></div>
    <div class="phase-step" data-phase="technical"><span class="phase-dot"></span> Technical</div>
    <div class="phase-connector"></div>
    <div class="phase-step" data-phase="behavioral"><span class="phase-dot"></span> Behavioral</div>
    <div class="phase-connector"></div>
    <div class="phase-step" data-phase="design"><span class="phase-dot"></span> Design</div>
    <div class="phase-connector"></div>
    <div class="phase-step" data-phase="wrapup"><span class="phase-dot"></span> Wrap-up</div>
</div>

<!-- Main Content -->
<div id="mainContent" class="main-content">

    <!-- Orb -->
    <div class="orb-wrapper" id="orbWrapper">
        <div class="orb-ring"></div>
        <div class="orb-ring"></div>
        <div class="orb-core idle" id="orbCore">
            <span class="orb-icon" id="orbIcon">ğŸ™ï¸</span>
        </div>
    </div>

    <!-- Status -->
    <div class="status-area">
        <div id="statusBadge" class="status-badge">
            <span class="status-dot"></span>
            <span id="statusText">Upload your resume to begin</span>
        </div>
        <div id="questionCounter" class="question-counter" style="display:none;"></div>
    </div>

    <!-- Setup Panel -->
    <div id="setupPanel" class="setup-panel">
        <h1 class="setup-title">Elite AI Interview</h1>
        <p class="setup-subtitle">Powered by advanced conversational AI</p>

        <label class="upload-zone" id="uploadZone">
            <span class="uz-icon">ğŸ“„</span>
            <div class="uz-title">Upload Your Resume</div>
            <div class="uz-sub">PDF format â€¢ Drag & drop supported</div>
            <input type="file" id="cvInput" accept=".pdf">
        </label>

        <button id="startBtn" class="btn btn-primary" disabled>
            ğŸš€ Begin Interview Session
        </button>
    </div>

    <!-- Transcript Panel (shown during interview) -->
    <div id="transcriptPanel" class="transcript-panel">
        <div class="transcript-header">
            <span>ğŸ’¬ Live Transcript</span>
            <span id="transcriptCount">0 exchanges</span>
        </div>
        <div class="transcript-body" id="transcriptBody"></div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <h2>ğŸ“Š Performance Evaluation</h2>
            <p>AI-generated assessment of your interview</p>
        </div>
        <div class="modal-body">
            <div class="report-content" id="reportContent">Generating report...</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="location.reload()">
                ğŸ”„ Start New Session
            </button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVALIS AI â€” Elite Interview Engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

// â”€â”€ Platform Detection â”€â”€
const isAndroid = typeof Android !== "undefined";
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// â”€â”€ State â”€â”€
const state = {
    cvText: "",
    history: [],
    timeLeft: 900,
    isInterviewing: false,
    isSpeaking: false,
    isListening: false,
    questionCount: 0,
    currentPhase: "intro",
    phases: ["intro", "technical", "behavioral", "design", "wrapup"]
};

let timerInterval = null;
let wakeLock = null;
let wakeLockHeartbeat = null;
let stateSaveInterval = null;
let recognition = null;
let fatalMicError = false;
let lastRecognitionStart = 0;
const MIN_RESTART_INTERVAL = 2500;
let recognitionRestartTimeout = null;

// â”€â”€ DOM â”€â”€
const $ = id => document.getElementById(id);
const orbCore = $('orbCore');
const orbIcon = $('orbIcon');
const statusBadge = $('statusBadge');
const statusText = $('statusText');
const timerDisplay = $('timerDisplay');
const phaseBar = $('phaseBar');
const transcriptPanel = $('transcriptPanel');
const transcriptBody = $('transcriptBody');
const transcriptCount = $('transcriptCount');
const questionCounter = $('questionCounter');
const mainContent = $('mainContent');
const uploadZone = $('uploadZone');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUAL STATE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setOrbState(mode, message) {
    orbCore.className = 'orb-core ' + mode;
    statusBadge.className = 'status-badge ' + mode;

    const icons = { idle: 'ğŸ™ï¸', listening: 'ğŸ‘‚', thinking: 'ğŸ§ ', speaking: 'ğŸ”Š' };
    const defaults = {
        idle: 'Ready',
        listening: 'Listening to your responseâ€¦',
        thinking: 'Analyzing your answerâ€¦',
        speaking: 'AI is respondingâ€¦'
    };

    orbIcon.textContent = icons[mode] || 'ğŸ™ï¸';
    statusText.textContent = message || defaults[mode] || 'Active';

    state.isListening = mode === 'listening';
    state.isSpeaking = mode === 'speaking';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHASE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updatePhase() {
    const q = state.questionCount;
    let phase;
    if (q <= 2) phase = "intro";
    else if (q <= 5) phase = "technical";
    else if (q <= 8) phase = "behavioral";
    else if (q <= 10) phase = "design";
    else phase = "wrapup";

    state.currentPhase = phase;

    document.querySelectorAll('.phase-step').forEach(el => {
        const p = el.dataset.phase;
        const idx = state.phases.indexOf(p);
        const currentIdx = state.phases.indexOf(phase);

        el.classList.remove('current', 'done');
        if (idx < currentIdx) el.classList.add('done');
        else if (idx === currentIdx) el.classList.add('current');
    });

    questionCounter.textContent = `Question ${q} â€¢ ${phase.charAt(0).toUpperCase() + phase.slice(1)} Phase`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSCRIPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addTranscriptMessage(role, text) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.innerHTML = `
        <div class="msg-label ${role}">${role === 'ai' ? 'ğŸ¤– Interviewer' : 'ğŸ‘¤ You'}</div>
        <div class="msg-text">${escapeHtml(text)}</div>
    `;
    transcriptBody.appendChild(div);
    transcriptBody.scrollTop = transcriptBody.scrollHeight;

    const exchanges = Math.floor(transcriptBody.children.length / 2);
    transcriptCount.textContent = `${exchanges} exchange${exchanges !== 1 ? 's' : ''}`;
}

function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPEECH RECOGNITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        console.warn('Speech Recognition not available');
        return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.continuous = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (e) => {
        const transcript = e.results[e.results.length - 1][0].transcript.trim();
        if (!transcript || transcript.length < 2) return;

        console.log('ğŸ—£ï¸ User said:', transcript);
        state.isListening = false;
        addTranscriptMessage('user', transcript);
        processUserResponse(transcript);
    };

    recognition.onerror = (e) => {
        console.log('âŒ Recognition error:', e.error);

        if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
            fatalMicError = true;
            state.isListening = false;
            setOrbState('idle', 'Mic blocked â€” tap orb to retry');
        }
        // 'no-speech' and 'aborted' are handled by onend
    };

    recognition.onend = () => {
        console.log('â¹ï¸ Recognition ended');

        if (state.isInterviewing && !state.isSpeaking && state.isListening && !fatalMicError) {
            console.log('ğŸ”„ Recycling micâ€¦');
            setTimeout(() => {
                if (state.isInterviewing && !state.isSpeaking) {
                    startListening();
                }
            }, 400);
        }
    };
}

function startListening() {
    if (!state.isInterviewing) return;
    if (state.isListening && !state.isSpeaking) return;

    const now = Date.now();
    if (now - lastRecognitionStart < MIN_RESTART_INTERVAL) {
        clearTimeout(recognitionRestartTimeout);
        recognitionRestartTimeout = setTimeout(startListening, MIN_RESTART_INTERVAL - (now - lastRecognitionStart));
        return;
    }

    if (state.isSpeaking) stopSpeaking();

    fatalMicError = false;
    setOrbState('listening');

    if (isAndroid) {
        Android.startInterview();
        lastRecognitionStart = now;
    } else if (recognition) {
        try {
            recognition.start();
            lastRecognitionStart = now;
            console.log('ğŸ¤ Mic active');
        } catch (e) {
            console.log('âš ï¸ Mic already active:', e.message);
        }
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT-TO-SPEECH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function speak(text) {
    // Stop recognition before speaking
    if (!isAndroid && recognition) {
        try { recognition.stop(); } catch (e) {}
    }
    clearTimeout(recognitionRestartTimeout);

    setOrbState('speaking');
    addTranscriptMessage('ai', text);

    if (isAndroid) {
        Android.speak(text);
        return;
    }

    const utterance = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();

    const preferred = voices.find(v =>
        v.name.includes('Google US English') ||
        v.name.includes('Samantha') ||
        v.name.includes('Natural') ||
        (v.lang === 'en-US' && !v.localService)
    ) || voices.find(v => v.lang.startsWith('en'));

    if (preferred) utterance.voice = preferred;
    utterance.rate = 1.0;
    utterance.pitch = 1.0;

    // Chrome bug workaround: keep synthesis alive
    const keepAlive = setInterval(() => {
        if (state.isSpeaking) window.speechSynthesis.resume();
        else clearInterval(keepAlive);
    }, 8000);

    // Safety timeout
    const wordCount = text.split(/\s+/).length;
    const estimatedMs = Math.max(5000, (wordCount / 150) * 60000 + 4000);
    const safety = setTimeout(() => {
        if (state.isSpeaking) {
            console.warn('âš ï¸ TTS onend never fired â€” forcing recovery');
            clearInterval(keepAlive);
            onFinishedSpeaking();
        }
    }, estimatedMs);

    utterance.onend = () => {
        clearInterval(keepAlive);
        clearTimeout(safety);
        onFinishedSpeaking();
    };

    utterance.onerror = (e) => {
        console.error('TTS error:', e);
        clearInterval(keepAlive);
        clearTimeout(safety);
        onFinishedSpeaking();
    };

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

function stopSpeaking() {
    if (!state.isSpeaking) return;
    console.log('ğŸ›‘ Stopping AI speech');
    state.isSpeaking = false;

    if (isAndroid) {
        if (typeof Android.stopSpeaking === 'function') Android.stopSpeaking();
    } else {
        window.speechSynthesis.cancel();
    }
}

function onFinishedSpeaking() {
    console.log('âœ… AI finished speaking');
    state.isSpeaking = false;

    if (state.isInterviewing) {
        setTimeout(startListening, 600);
    } else {
        setOrbState('idle', 'Session ended');
    }
}

// Android callbacks
window.onRecognitionResult = function(text) {
    if (!text || text.trim().length < 2) return;
    state.isListening = false;
    addTranscriptMessage('user', text.trim());
    processUserResponse(text.trim());
};

window.onFinishedSpeaking = onFinishedSpeaking;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERVIEW LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function processUserResponse(userText) {
    setOrbState('thinking');
    state.questionCount++;
    updatePhase();

    const fd = new FormData();
    fd.append("mode", "interview");
    fd.append("history", JSON.stringify(state.history));
    fd.append("userMessage", userText);
    fd.append("cvText", state.cvText);
    fd.append("questionCount", state.questionCount);
    fd.append("phase", state.currentPhase);

    try {
        const res = await fetch(API_URL, { method: "POST", body: fd });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        state.history = data.history || state.history;

        if (data.reply) {
            speak(data.reply);
        } else {
            throw new Error('Empty reply');
        }
    } catch (e) {
        console.error('API error:', e);
        setOrbState('idle', 'Connection error â€” tap orb to retry');

        // Auto-retry once after 3s
        setTimeout(() => {
            if (state.isInterviewing && !state.isSpeaking && !state.isListening) {
                startListening();
            }
        }, 3000);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function startTimer() {
    timerDisplay.style.display = '';
    updateTimerDisplay();

    timerInterval = setInterval(() => {
        if (state.timeLeft <= 0) {
            clearInterval(timerInterval);
            finishSession();
            return;
        }

        state.timeLeft--;
        updateTimerDisplay();

        if (state.timeLeft === 120) timerDisplay.classList.add('warning');
        if (state.timeLeft === 30) {
            timerDisplay.classList.remove('warning');
            timerDisplay.classList.add('danger');
        }
    }, 1000);
}

function updateTimerDisplay() {
    const m = Math.floor(state.timeLeft / 60);
    const s = state.timeLeft % 60;
    timerDisplay.textContent = `${m}:${s < 10 ? '0' + s : s}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$('cvInput').addEventListener('change', handleFileUpload);

// Drag & drop
uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') {
        processFile(file);
    }
});

async function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    await processFile(file);
}

async function processFile(file) {
    setOrbState('thinking', 'Analyzing your resumeâ€¦');

    try {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;

        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map(s => s.str).join(" ") + "\n";
        }

        state.cvText = fullText.trim();

        if (state.cvText.length < 50) {
            throw new Error('Resume text too short â€” may be a scanned image');
        }

        uploadZone.classList.add('loaded');
        uploadZone.querySelector('.uz-title').textContent = file.name;
        uploadZone.querySelector('.uz-sub').textContent = `${pdf.numPages} page${pdf.numPages > 1 ? 's' : ''} â€¢ ${state.cvText.length.toLocaleString()} characters extracted`;

        setOrbState('idle', 'Resume loaded â€” ready to begin');
        $('startBtn').disabled = false;

        console.log('ğŸ“„ Resume loaded:', state.cvText.length, 'chars');
    } catch (err) {
        console.error('PDF error:', err);
        setOrbState('idle', 'Error reading PDF â€” try another file');
        uploadZone.classList.remove('loaded');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START INTERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$('startBtn').addEventListener('click', async () => {
    $('setupPanel').style.display = 'none';
    $('endBtn').style.display = '';
    transcriptPanel.classList.add('active');
    phaseBar.classList.add('active');
    mainContent.classList.add('with-phase');
    questionCounter.style.display = '';

    state.isInterviewing = true;
    state.questionCount = 0;
    updatePhase();

    initRecognition();
    await requestWakeLock();
    startWakeLockHeartbeat();
    startStateSaving();
    startTimer();

    setOrbState('thinking', 'Starting your interviewâ€¦');

    const fd = new FormData();
    fd.append("mode", "start");
    fd.append("cvText", state.cvText);

    try {
        const res = await fetch(API_URL, { method: "POST", body: fd });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        state.history = data.history || [];

        if (data.reply) {
            speak(data.reply);
        } else {
            throw new Error('No initial reply');
        }
    } catch (e) {
        console.error('Failed to start:', e);
        setOrbState('idle', 'Connection failed â€” please refresh');
        alert('Could not connect to the AI server. Please check your connection and try again.');
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$('endBtn').addEventListener('click', () => {
    if (confirm('End the interview and generate your evaluation?')) {
        finishSession();
    }
});

async function finishSession() {
    state.isInterviewing = false;
    state.isSpeaking = false;
    state.isListening = false;

    clearInterval(timerInterval);
    clearTimeout(recognitionRestartTimeout);
    stopStateSaving();
    stopWakeLockHeartbeat();
    await releaseWakeLock();

    try { sessionStorage.removeItem('evalis_interview_state'); } catch (e) {}

    if (!isAndroid) {
        if (recognition) { try { recognition.stop(); } catch (e) {} }
        window.speechSynthesis.cancel();
    } else {
        if (typeof Android.stopSpeaking === 'function') Android.stopSpeaking();
    }

    $('endBtn').style.display = 'none';
    timerDisplay.style.display = 'none';
    phaseBar.classList.remove('active');
    transcriptPanel.classList.remove('active');
    mainContent.classList.remove('with-phase');

    setOrbState('thinking', 'Generating your evaluationâ€¦');

    const fd = new FormData();
    fd.append("mode", "score");
    fd.append("history", JSON.stringify(state.history));

    try {
        const res = await fetch(API_URL, { method: "POST", body: fd });
        const data = await res.json();
        $('reportContent').textContent = data.reply || 'Evaluation complete. Thank you for your time.';
    } catch (e) {
        console.error('Report error:', e);
        $('reportContent').textContent = 'Unable to generate report. Your interview data has been recorded.';
    }

    $('reportModal').classList.add('open');
    setOrbState('idle', 'Interview complete');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAKE LOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function requestWakeLock() {
    if (!('wakeLock' in navigator)) return;

    try {
        if (wakeLock) { try { await wakeLock.release(); } catch (e) {} }

        wakeLock = await navigator.wakeLock.request("screen");
        console.log('âœ… Wake Lock active');

        wakeLock.addEventListener('release', async () => {
            console.log('âš ï¸ Wake Lock released');
            if (state.isInterviewing) {
                setTimeout(() => requestWakeLock(), 500);
            }
        });
    } catch (err) {
        console.log('Wake Lock unavailable:', err.message);
    }
}

async function releaseWakeLock() {
    if (wakeLock) {
        try { await wakeLock.release(); } catch (e) {}
        wakeLock = null;
    }
}

function startWakeLockHeartbeat() {
    wakeLockHeartbeat = setInterval(async () => {
        if (state.isInterviewing && (!wakeLock || wakeLock.released)) {
            await requestWakeLock();
        }
    }, 15000);
}

function stopWakeLockHeartbeat() {
    clearInterval(wakeLockHeartbeat);
    wakeLockHeartbeat = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function saveInterviewState() {
    if (!state.isInterviewing) return;
    try {
        sessionStorage.setItem('evalis_interview_state', JSON.stringify({
            history: state.history,
            timeLeft: state.timeLeft,
            questionCount: state.questionCount,
            cvText: state.cvText,
            timestamp: Date.now()
        }));
    } catch (e) {}
}

function startStateSaving() {
    stateSaveInterval = setInterval(() => saveInterviewState(), 5000);
}

function stopStateSaving() {
    clearInterval(stateSaveInterval);
    stateSaveInterval = null;
}

// Visibility change handler
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && state.isInterviewing) {
        await requestWakeLock();

        // Resume if stuck
        if (!state.isSpeaking && !state.isListening) {
            setTimeout(startListening, 1000);
        }
    } else if (state.isInterviewing) {
        saveInterviewState();
    }
});

// Restore state after refresh
function tryRestoreState() {
    try {
        const saved = sessionStorage.getItem('evalis_interview_state');
        if (!saved) return;

        const data = JSON.parse(saved);
        if (Date.now() - data.timestamp > 300000) {
            sessionStorage.removeItem('evalis_interview_state');
            return;
        }

        if (data.history?.length > 0 && confirm('Resume interrupted interview?')) {
            state.history = data.history;
            state.timeLeft = data.timeLeft;
            state.questionCount = data.questionCount;
            state.cvText = data.cvText;

            $('setupPanel').style.display = 'none';
            $('endBtn').style.display = '';
            transcriptPanel.classList.add('active');
            phaseBar.classList.add('active');
            mainContent.classList.add('with-phase');
            questionCounter.style.display = '';

            state.isInterviewing = true;
            initRecognition();
            updatePhase();
            startTimer();
            requestWakeLock();
            startWakeLockHeartbeat();
            startStateSaving();

            // Rebuild transcript from history
            state.history.forEach(msg => {
                if (msg.role === 'assistant') addTranscriptMessage('ai', msg.content);
                else if (msg.role === 'user') addTranscriptMessage('user', msg.content);
            });

            setOrbState('idle', 'Interview resumed');
            setTimeout(startListening, 2000);
        } else {
            sessionStorage.removeItem('evalis_interview_state');
        }
    } catch (e) {
        console.log('Restore failed:', e);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener('load', () => {
    console.log('ğŸš€ Evalis AI loaded');
    console.log('ğŸ“± Platform:', isAndroid ? 'Android WebView' : isMobile ? 'Mobile Web' : 'Desktop');

    // Pre-load voices
    if (window.speechSynthesis) {
        window.speechSynthesis.getVoices();
        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    }

    // Orb click handler
    orbCore.addEventListener('click', () => {
        if (!state.isInterviewing) return;

        if (state.isSpeaking) {
            console.log('ğŸ‘† Barge-in: interrupting AI');
            stopSpeaking();
            setTimeout(startListening, 500);
        } else if (!state.isListening) {
            console.log('ğŸ‘† Manual mic restart');
            fatalMicError = false;
            startListening();
        }
    });

    // Mobile hint
    if (isMobile && !localStorage.getItem('evalis_hint')) {
        setTimeout(() => {
            if (!state.isInterviewing) {
                statusText.textContent = 'Tap the orb anytime to interrupt';
                setTimeout(() => {
                    if (!state.isInterviewing) statusText.textContent = 'Upload your resume to begin';
                }, 3000);
            }
            localStorage.setItem('evalis_hint', '1');
        }, 2000);
    }

    tryRestoreState();
});

// Prevent accidental navigation
window.addEventListener('beforeunload', (e) => {
    if (state.isInterviewing) {
        saveInterviewState();
        e.preventDefault();
        return e.returnValue = 'Interview in progress. Leave?';
    }
});

// Mobile audio unlock
if (isMobile) {
    document.addEventListener('touchstart', () => {
        if (window.speechSynthesis) window.speechSynthesis.cancel();
    }, { once: true });
}
</script>

</body>
</html>
