<script>
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

let state = "idle"; // idle | listening | thinking | speaking
let currentStage = "introduction";
let recognition;

function setStatus(text = "") {
  const el = document.getElementById("thinking");
  if (el) el.textContent = text;
}

function speak(text) {
  state = "speaking";
  setStatus("");

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "en-US";

  utter.onend = () => {
    state = "idle";
  };

  speechSynthesis.cancel(); // prevent overlap
  speechSynthesis.speak(utter);
}

function startListening() {
  if (state !== "idle") return;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("Speech recognition not supported in this browser");
    return;
  }

  recognition = new SR();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;

  let finalAnswer = "";

  state = "listening";
  setStatus("Listening…");

  recognition.onresult = e => {
    finalAnswer = e.results[0][0].transcript;
  };

  recognition.onspeechend = () => {
    recognition.stop();
  };

  recognition.onend = async () => {
    if (!finalAnswer) {
      state = "idle";
      setStatus("");
      return;
    }

    state = "thinking";
    setStatus("Thinking…");

    try {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          answer: finalAnswer,
          state: currentStage
        })
      });

      const data = await res.json();

      currentStage = data.nextState || currentStage;
      speak(data.followUp || "Tell me more.");

    } catch (e) {
      console.error(e);
      speak("Sorry, something went wrong. Please try again.");
    } finally {
      setStatus("");
    }
  };

  recognition.onerror = e => {
    console.error(e);
    state = "idle";
    setStatus("");
    speak("Microphone error. Please try again.");
  };

  recognition.start();
}
</script>
