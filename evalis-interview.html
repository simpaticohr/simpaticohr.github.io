<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#06090f;--card:#0d1117;--card2:#161b22;--border:#21262d;--accent:#58a6ff;--accent2:#bc8cff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--text:#e6edf3;--text2:#8b949e;--glow:rgba(88,166,255,0.15)}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
    body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(88,166,255,0.06) 0%,transparent 60%),radial-gradient(ellipse at 80% 100%,rgba(188,140,255,0.06) 0%,transparent 60%);z-index:0;pointer-events:none}
    .container{max-width:720px;margin:0 auto;padding:16px;position:relative;z-index:1}
    .header{text-align:center;padding:30px 0 20px}
    .header h1{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header p{color:var(--text2);font-size:0.9rem;margin-top:4px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:14px}
    .card h2{font-size:1rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    label{display:block;font-size:0.8rem;color:var(--text2);margin:12px 0 4px;font-weight:500}
    label:first-child{margin-top:0}
    select,input[type="text"]{width:100%;padding:10px 12px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem;outline:none;transition:border-color 0.2s}
    select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
    select option{background:var(--card)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .upload-area{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s;margin-top:12px}
    .upload-area:hover{border-color:var(--accent);background:rgba(88,166,255,0.03)}
    .upload-area.ok{border-color:var(--green);background:rgba(63,185,80,0.05)}
    .upload-area p{font-size:0.85rem;color:var(--text2)}
    .upload-area strong{color:var(--accent)}
    #fName{margin-top:8px;font-size:0.8rem;color:var(--text2)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;color:#fff;font-family:inherit}
    .btn-go{width:100%;padding:14px;font-size:1rem;background:linear-gradient(135deg,var(--accent),var(--accent2));margin-top:16px}
    .btn-go:hover{transform:translateY(-1px);box-shadow:0 6px 20px var(--glow)}
    .btn-go:disabled{opacity:0.4;cursor:not-allowed;transform:none}
    .progress-wrap{background:rgba(255,255,255,0.05);border-radius:20px;height:8px;overflow:hidden;margin-bottom:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:20px;transition:width 0.5s ease;width:0%}
    .progress-info{display:flex;justify-content:space-between;align-items:center;font-size:0.8rem;color:var(--text2);margin-bottom:16px}
    .q-tag{background:rgba(88,166,255,0.15);color:var(--accent);padding:2px 10px;border-radius:12px;font-weight:600}
    .followup-tag{background:rgba(188,140,255,0.15);color:var(--accent2);padding:2px 10px;border-radius:12px;font-weight:600;font-size:0.75rem}
    #interviewScreen{display:none}
    #resultScreen{display:none}
    .orb-container{display:flex;justify-content:center;margin:24px 0 16px}
    .orb-wrap{text-align:center}
    .orb{width:110px;height:110px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(88,166,255,0.8),rgba(188,140,255,0.6),rgba(88,166,255,0.3));position:relative;animation:orbFloat 4s ease-in-out infinite;box-shadow:0 0 30px rgba(88,166,255,0.3),0 0 60px rgba(188,140,255,0.15),inset 0 0 30px rgba(255,255,255,0.1);margin:0 auto}
    .orb::before{content:'';position:absolute;inset:-8px;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);border-right-color:var(--accent2);animation:orbSpin 3s linear infinite}
    .orb::after{content:'';position:absolute;inset:10px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,0.2),transparent 70%);animation:orbPulse 2s ease-in-out infinite}
    @keyframes orbFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes orbSpin{to{transform:rotate(360deg)}}
    @keyframes orbPulse{0%,100%{opacity:0.5;transform:scale(0.9)}50%{opacity:1;transform:scale(1.1)}}
    .orb.speaking{background:radial-gradient(circle at 35% 35%,rgba(63,185,80,0.9),rgba(88,166,255,0.6),rgba(63,185,80,0.3));box-shadow:0 0 40px rgba(63,185,80,0.4),0 0 80px rgba(63,185,80,0.15),inset 0 0 30px rgba(255,255,255,0.1);animation:orbFloat 2s ease-in-out infinite,orbSpeak 0.5s ease-in-out infinite}
    @keyframes orbSpeak{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.06)}}
    .orb.listening{background:radial-gradient(circle at 35% 35%,rgba(88,166,255,0.9),rgba(188,140,255,0.8),rgba(88,166,255,0.3));box-shadow:0 0 40px rgba(88,166,255,0.5),0 0 80px rgba(188,140,255,0.2),inset 0 0 30px rgba(255,255,255,0.1);animation:orbFloat 2s ease-in-out infinite,orbListen 1s ease-in-out infinite}
    @keyframes orbListen{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.04)}}
    .orb.thinking{opacity:0.6;animation:orbFloat 1.5s ease-in-out infinite}
    .orb.processing{background:radial-gradient(circle at 35% 35%,rgba(210,153,34,0.9),rgba(188,140,255,0.6),rgba(210,153,34,0.3));box-shadow:0 0 40px rgba(210,153,34,0.4),0 0 80px rgba(210,153,34,0.15);animation:orbFloat 1.5s ease-in-out infinite}
    .orb-label{margin-top:12px;font-size:0.8rem;color:var(--text2);letter-spacing:1px}
    .status-bar{display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.8rem;color:var(--text2);margin-bottom:12px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
    .question-box{background:linear-gradient(135deg,rgba(88,166,255,0.08),rgba(188,140,255,0.08));border:1px solid rgba(88,166,255,0.15);border-radius:14px;padding:20px;margin-bottom:16px;font-size:1.1rem;line-height:1.7;min-height:70px;text-align:center}
    .error-box{background:rgba(248,81,73,0.1);border:1px solid rgba(248,81,73,0.3);border-radius:10px;padding:12px 16px;margin-bottom:12px;font-size:0.85rem;color:var(--red);display:none}
    .error-box.show{display:block}
    .thinking{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--text2);font-size:0.85rem;margin:12px 0}
    .thinking-dots span{display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;animation:dot 1.2s infinite}
    .thinking-dots span:nth-child(2){animation-delay:0.2s}
    .thinking-dots span:nth-child(3){animation-delay:0.4s}
    @keyframes dot{0%,100%{opacity:0.2;transform:scale(0.8)}50%{opacity:1;transform:scale(1.3)}}
    .silence-bar-wrap{width:80%;max-width:300px;margin:12px auto;text-align:center;display:none}
    .silence-bar-wrap.show{display:block}
    .silence-bar{height:4px;background:var(--card2);border-radius:2px;overflow:hidden}
    .silence-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s linear;width:100%}
    .silence-text{font-size:0.75rem;color:var(--text2);margin-top:4px}
    .wave-wrap{display:flex;justify-content:center;align-items:center;gap:3px;height:40px;margin:12px 0}
    .wave-bar{width:4px;height:8px;background:var(--accent);border-radius:4px}
    .wave-wrap.active .wave-bar{animation:wave 0.8s ease-in-out infinite alternate}
    .wave-bar:nth-child(1){animation-delay:0s}.wave-bar:nth-child(2){animation-delay:0.1s}
    .wave-bar:nth-child(3){animation-delay:0.2s}.wave-bar:nth-child(4){animation-delay:0.3s}
    .wave-bar:nth-child(5){animation-delay:0.4s}.wave-bar:nth-child(6){animation-delay:0.3s}
    .wave-bar:nth-child(7){animation-delay:0.2s}.wave-bar:nth-child(8){animation-delay:0.1s}
    .wave-bar:nth-child(9){animation-delay:0s}
    @keyframes wave{from{height:8px}to{height:36px}}
    .timer{text-align:center;font-size:1.4rem;font-weight:700;font-variant-numeric:tabular-nums;margin:8px 0}
    .hf-info{text-align:center;font-size:0.8rem;color:var(--text2);padding:8px;background:rgba(88,166,255,0.05);border-radius:8px;margin-bottom:12px}
    .btn-end{background:rgba(248,81,73,0.15);color:var(--red);width:100%;margin-top:16px;padding:12px;border-radius:10px}
    .score-ring{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
    .score-inner{text-align:center}
    .score-num{font-size:2.2rem;font-weight:800}
    .score-max{font-size:0.9rem;color:var(--text2)}
    .grade-badge{display:inline-block;padding:4px 16px;border-radius:16px;font-weight:700;font-size:0.85rem;margin-bottom:12px}
    .hire-badge{display:inline-block;padding:6px 20px;border-radius:20px;font-weight:700;font-size:0.9rem;margin-bottom:16px}
    .summary-section{margin-bottom:16px}
    .summary-section h3{font-size:0.9rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .summary-list{list-style:none;padding:0}
    .summary-list li{padding:6px 0;font-size:0.85rem;color:var(--text2);border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:8px}
    .summary-list li:last-child{border-bottom:none}
    .fb-item{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
    .fb-item .fb-q{font-weight:600;color:var(--accent);margin-bottom:4px;font-size:0.9rem}
    .fb-item .fb-a{font-size:0.8rem;color:var(--text2);margin-bottom:6px;font-style:italic;opacity:0.8}
    .fb-item .fb-score{font-size:0.75rem;padding:2px 8px;border-radius:8px;display:inline-block;margin-bottom:6px}
    .fb-item .fb-text{font-size:0.85rem;color:var(--text2);line-height:1.5}
    .fb-item .fb-type{font-size:0.7rem;padding:1px 6px;border-radius:4px;display:inline-block;margin-left:6px}
    .toast-box{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:10px;font-size:0.85rem;box-shadow:0 8px 24px rgba(0,0,0,0.4);animation:tIn 0.3s ease,tOut 0.3s ease 2.7s forwards}
    @keyframes tIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes tOut{to{transform:translateX(120%);opacity:0}}
    .hidden{display:none !important}
    .retry-btn{background:var(--accent);color:#fff;padding:10px 24px;border-radius:8px;margin-top:12px;font-size:0.9rem;cursor:pointer;border:none;font-weight:600}
    @media(max-width:600px){.container{padding:10px}.header h1{font-size:1.5rem}.row2{grid-template-columns:1fr}.orb{width:90px;height:90px}}
  </style>
</head>

<body>
  <div class="toast-box" id="toasts"></div>
  <div class="container">
    <div class="header">
      <h1>üß† AI Interviewer</h1>
      <p>Intelligent ‚Ä¢ Adaptive ‚Ä¢ Unbiased</p>
    </div>

    <!-- SETUP -->
    <div id="setupScreen">
      <div class="card">
        <h2>‚öôÔ∏è Interview Setup</h2>
        <label>üåê Language</label>
        <select id="langSel">
          <option value="en">English</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
          <option value="es">Espa√±ol (Spanish)</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
          <option value="fr">Fran√ßais (French)</option>
          <option value="de">Deutsch (German)</option>
          <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
        </select>
        <label>üíº Job Role</label>
        <select id="roleSel">
          <option value="">‚Äî Select Role ‚Äî</option>
          <option value="Frontend Developer">Frontend Developer</option>
          <option value="Backend Developer">Backend Developer</option>
          <option value="Full Stack Developer">Full Stack Developer</option>
          <option value="Mobile Developer">Mobile Developer</option>
          <option value="Data Scientist">Data Scientist / Analyst</option>
          <option value="DevOps Engineer">DevOps / Cloud Engineer</option>
          <option value="UI/UX Designer">UI/UX Designer</option>
          <option value="Product Manager">Product Manager</option>
          <option value="QA Engineer">QA / Test Engineer</option>
          <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
          <option value="Sales Representative">Sales / BDR</option>
          <option value="Marketing Manager">Marketing Manager</option>
          <option value="HR Recruiter">HR / Recruiter</option>
          <option value="Finance Analyst">Finance / Accounting</option>
          <option value="Customer Support">Customer Support</option>
          <option value="custom">‚úèÔ∏è Custom Role...</option>
        </select>
        <div id="customWrap" class="hidden">
          <label>Enter Role</label>
          <input type="text" id="customRole" placeholder="e.g. Blockchain Developer">
        </div>
        <div class="row2">
          <div>
            <label>üìä Level</label>
            <select id="levelSel">
              <option value="Fresher">Fresher / Entry</option>
              <option value="Junior">Junior (1-2 yrs)</option>
              <option value="Mid-Level" selected>Mid-Level (3-5 yrs)</option>
              <option value="Senior">Senior (5-10 yrs)</option>
              <option value="Lead">Lead / Principal (10+)</option>
            </select>
          </div>
          <div>
            <label>üî¢ Questions</label>
            <select id="qCount">
              <option value="5">5 (~10 min)</option>
              <option value="8">8 (~15 min)</option>
              <option value="10" selected>10 (~20 min)</option>
              <option value="15">15 (~30 min)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>üìÑ Resume (Optional)</h2>
        <div id="upArea" class="upload-area" onclick="document.getElementById('cvF').click()">
          <p>üìÇ Click to upload <strong>PDF, DOC, DOCX, TXT</strong></p>
          <p id="fName">No file selected</p>
          <input type="file" id="cvF" accept=".pdf,.doc,.docx,.txt" hidden>
        </div>
      </div>
      <button class="btn btn-go" id="startBtn" onclick="startInterview()">üöÄ Start Interview</button>
    </div>

    <!-- INTERVIEW -->
    <div id="interviewScreen">
      <div class="card">
        <div class="progress-wrap"><div class="progress-fill" id="progBar"></div></div>
        <div class="progress-info">
          <span id="progText">Question 1 of 10</span>
          <span class="q-tag" id="qTag">Q1</span>
        </div>
        <div class="status-bar"><div class="status-dot"></div><span>Interview Active</span></div>
        <div class="orb-container"><div class="orb-wrap"><div class="orb" id="orb"></div><div class="orb-label" id="orbLabel">Preparing...</div></div></div>
        <div class="error-box" id="errorBox"></div>
        <div class="question-box" id="questionBox">Preparing your first question...</div>
        <div class="thinking hidden" id="thinkBox"><div class="thinking-dots"><span></span><span></span><span></span></div><span>Analyzing...</span></div>
        <div class="hf-info" id="hfInfo">üé§ Hands-free ‚Äî Speak naturally. Auto-submits after a pause.</div>
        <div class="wave-wrap" id="waveWrap"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
        <div class="silence-bar-wrap" id="silenceWrap"><div class="silence-bar"><div class="silence-fill" id="silenceFill"></div></div><div class="silence-text" id="silenceText"></div></div>
        <div class="timer" id="timer">00:00</div>
        <button class="btn btn-end" onclick="endEarly()">‚èπ End Interview Early</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="resultScreen">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">üèÜ Interview Complete!</h2>
        <div class="score-ring" id="scoreRing"><div class="score-inner"><div class="score-num" id="scoreNum">0</div><div class="score-max">/ 100</div></div></div>
        <div id="gradeBadge" class="grade-badge">‚Äî</div><br>
        <div id="hireBadge" class="hire-badge" style="display:none;"></div>
        <p id="scoreSummary" style="color:var(--text2);margin-bottom:20px;line-height:1.6;"></p>
        <div id="retryWrap" style="display:none;"><button class="retry-btn" onclick="retryEvaluation()">üîÑ Retry Evaluation</button></div>
      </div>
      <div class="card" id="strengthsCard" style="display:none;">
        <div class="summary-section"><h3>üí™ Strengths</h3><ul class="summary-list" id="strengthsList"></ul></div>
        <div class="summary-section"><h3>üìà Areas for Improvement</h3><ul class="summary-list" id="improveList"></ul></div>
      </div>
      <div class="card"><h2>üìù Question-by-Question Feedback</h2><div id="fbList"></div></div>
      <button class="btn btn-go" onclick="location.reload()">üîÑ New Interview</button>
    </div>
  </div>

  <script>
    // ‚òÖ YOUR WORKER URL
    const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

    const SILENCE_TIMEOUT = 3.0;
    const MIN_ANSWER_LENGTH = 10;
    const MAX_EVAL_RETRIES = 3;

    let cv="",lang="en",role="",level="",totalQ=10,mainQAsked=0,isFollowUp=false;
    let chatMessages=[],answers=[],recognition=null,currentTranscript="";
    let timerInterval=null,seconds=0,isListening=false,silenceTimer=null;
    let lastSpeechTime=0,isSpeaking=false,isProcessing=false,answerStartTime=0;
    let evalRetryCount=0;

    const langMap={
      en:{speech:"en-US",tts:"en-US",name:"English"},
      hi:{speech:"hi-IN",tts:"hi-IN",name:"Hindi"},
      es:{speech:"es-ES",tts:"es-ES",name:"Spanish"},
      ar:{speech:"ar-SA",tts:"ar-SA",name:"Arabic"},
      fr:{speech:"fr-FR",tts:"fr-FR",name:"French"},
      de:{speech:"de-DE",tts:"de-DE",name:"German"},
      ur:{speech:"ur-PK",tts:"ur-PK",name:"Urdu"}
    };

    function toast(m){const c=document.getElementById("toasts"),t=document.createElement("div");t.className="toast";t.textContent=m;c.appendChild(t);setTimeout(()=>t.remove(),3000)}
    function showError(m){const b=document.getElementById("errorBox");b.textContent=m;b.classList.add("show");setTimeout(()=>b.classList.remove("show"),8000)}

    document.getElementById("roleSel").addEventListener("change",e=>{document.getElementById("customWrap").classList.toggle("hidden",e.target.value!=="custom")});

    function setOrb(s){
      const o=document.getElementById("orb"),l=document.getElementById("orbLabel");
      o.className="orb";
      switch(s){
        case"speaking":o.classList.add("speaking");l.textContent="Speaking...";break;
        case"listening":o.classList.add("listening");l.textContent="Listening...";break;
        case"thinking":o.classList.add("thinking");l.textContent="Thinking...";break;
        case"processing":o.classList.add("processing");l.textContent="Processing...";break;
        default:l.textContent="Ready";
      }
    }

    function updateProgress(){
      const pct=Math.round((mainQAsked/totalQ)*100);
      document.getElementById("progBar").style.width=pct+"%";
      if(isFollowUp){
        document.getElementById("progText").textContent=`Follow-up on Q${mainQAsked} of ${totalQ}`;
        document.getElementById("qTag").textContent=`Q${mainQAsked} ‚Ü©`;
        document.getElementById("qTag").className="followup-tag";
      }else{
        document.getElementById("progText").textContent=`Question ${mainQAsked} of ${totalQ} ‚Äî ${pct}%`;
        document.getElementById("qTag").textContent=`Q${mainQAsked}`;
        document.getElementById("qTag").className="q-tag";
      }
    }

    // TTS
    if('speechSynthesis' in window){speechSynthesis.getVoices();speechSynthesis.onvoiceschanged=()=>{}}
    function speakText(text){
      return new Promise(resolve=>{
        if(!('speechSynthesis' in window)){resolve();return}
        speechSynthesis.cancel();isSpeaking=true;setOrb("speaking");
        setTimeout(()=>{
          const u=new SpeechSynthesisUtterance(text);
          u.lang=langMap[lang].tts;u.rate=0.92;u.pitch=1;u.volume=1;
          const voices=speechSynthesis.getVoices();
          const match=voices.find(v=>v.lang.startsWith(langMap[lang].tts.split('-')[0]));
          if(match)u.voice=match;
          u.onend=()=>{isSpeaking=false;resolve()};
          u.onerror=()=>{isSpeaking=false;resolve()};
          speechSynthesis.speak(u);
        },100);
      });
    }

    // CV
    document.getElementById("cvF").addEventListener("change",async e=>{
      const file=e.target.files[0];if(!file)return;
      document.getElementById("fName").textContent="‚è≥ Processing...";
      document.getElementById("upArea").classList.remove("ok");
      try{
        const ext=file.name.split('.').pop().toLowerCase();
        if(ext==='txt')cv=await file.text();
        else if(ext==='pdf')cv=await extractPDF(file);
        else if(ext==='doc'||ext==='docx')cv=await extractDOC(file);
        else cv=await file.text();
        cv=cv.replace(/\s+/g,' ').replace(/[^\x20-\x7E\n]/g,'').trim().substring(0,5000);
        if(cv.length<30){document.getElementById("fName").textContent="‚ö†Ô∏è Try TXT";cv="";return}
        document.getElementById("fName").textContent=`‚úÖ ${file.name} (${cv.length} chars)`;
        document.getElementById("upArea").classList.add("ok");toast("‚úÖ Resume loaded!");
      }catch(err){document.getElementById("fName").textContent="‚ùå Error";cv=""}
    });
    async function extractPDF(f){if(!window.pdfjsLib)return extractFallback(f);try{const b=await f.arrayBuffer(),p=await pdfjsLib.getDocument({data:b}).promise;let t="";for(let i=1;i<=p.numPages;i++){const pg=await p.getPage(i),c=await pg.getTextContent();t+=c.items.map(x=>x.str).join(' ')+"\n"}return t}catch(e){return extractFallback(f)}}
    async function extractDOC(f){const b=await f.arrayBuffer();if(f.name.endsWith('.docx')){try{const t=new TextDecoder('utf-8').decode(new Uint8Array(b)),m=t.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);if(m&&m.length)return m.map(x=>x.replace(/<[^>]+>/g,'')).join(' ')}catch(e){}}return extractFallback(f)}
    async function extractFallback(f){const b=await f.arrayBuffer(),t=new TextDecoder('utf-8',{fatal:false}).decode(b),r=t.match(/[a-zA-Z0-9@.,:;!?\-/()\s]{5,}/g);if(!r)return"";return r.filter(s=>(s.match(/[a-zA-Z]/g)||[]).length/s.length>0.5&&s.trim().length>5).join(' ')}

    // AI Call
    async function callAI(messages){
      const ctrl=new AbortController();const tm=setTimeout(()=>ctrl.abort(),45000);
      try{
        const res=await fetch(WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages}),signal:ctrl.signal});
        clearTimeout(tm);
        if(!res.ok){const e=await res.text();throw new Error(`Error ${res.status}: ${e}`)}
        const data=await res.json();
        if(!data.response)throw new Error("Empty response");
        return data.response;
      }catch(err){clearTimeout(tm);if(err.name==='AbortError')throw new Error("Timed out");throw err}
    }

    // ============================================================
    // ‚òÖ BULLETPROOF JSON PARSER
    // ============================================================
    function safeParseJSON(raw) {
      // Step 1: Remove markdown code fences
      let cleaned = raw
        .replace(/```json\s*/gi, '')
        .replace(/```\s*/g, '')
        .trim();

      // Step 2: Extract JSON object
      const match = cleaned.match(/\{[\s\S]*\}/);
      if (!match) throw new Error("No JSON object found in response");
      cleaned = match[0];

      // Step 3: Fix common LLM JSON issues
      // Fix trailing commas before ] or }
      cleaned = cleaned.replace(/,\s*([}\]])/g, '$1');

      // Fix unescaped newlines inside strings
      cleaned = cleaned.replace(/:\s*"([^"]*?)"/gs, (match, content) => {
        const fixed = content
          .replace(/\n/g, ' ')
          .replace(/\r/g, '')
          .replace(/\t/g, ' ')
          .replace(/\\/g, '\\\\')
          .replace(/"/g, '\\"');
        return ': "' + fixed + '"';
      });

      // Step 4: Try parsing
      try {
        return JSON.parse(cleaned);
      } catch(e1) {
        console.warn("[JSON] First parse failed, trying aggressive fix...", e1.message);

        // Step 5: More aggressive fixes
        try {
          // Remove all control characters
          cleaned = cleaned.replace(/[\x00-\x1F\x7F]/g, ' ');
          // Fix double-escaped quotes
          cleaned = cleaned.replace(/\\\\"/g, '\\"');
          // Fix single quotes used as string delimiters
          cleaned = cleaned.replace(/'([^']{2,})'/g, '"$1"');
          return JSON.parse(cleaned);
        } catch(e2) {
          console.warn("[JSON] Aggressive fix failed, trying field extraction...", e2.message);

          // Step 6: Manual field extraction as last resort
          return extractFieldsManually(raw);
        }
      }
    }

    // ‚òÖ Last resort: extract fields with regex
    function extractFieldsManually(raw) {
      console.log("[JSON] Extracting fields manually from:", raw.substring(0, 500));

      const getNum = (key) => {
        const m = raw.match(new RegExp(`"${key}"\\s*:\\s*(\\d+)`));
        return m ? parseInt(m[1]) : 0;
      };
      const getStr = (key) => {
        const m = raw.match(new RegExp(`"${key}"\\s*:\\s*"([^"]*?)"`));
        return m ? m[1] : "";
      };
      const getArr = (key) => {
        const m = raw.match(new RegExp(`"${key}"\\s*:\\s*\\[([^\\]]*?)\\]`, 's'));
        if (!m) return [];
        const items = m[1].match(/"([^"]*?)"/g);
        return items ? items.map(s => s.replace(/"/g, '')) : [];
      };

      // Extract feedback array manually
      const feedback = [];
      const fbMatches = raw.matchAll(/"question"\s*:\s*"([^"]*?)"[^}]*?"score"\s*:\s*(\d+)[^}]*?"comment"\s*:\s*"([^"]*?)"/gs);
      for (const m of fbMatches) {
        feedback.push({
          question: m[1].substring(0, 100),
          score: parseInt(m[2]),
          comment: m[3],
          type: "main"
        });
      }

      const result = {
        overallScore: getNum("overallScore") || 50,
        grade: getStr("grade") || "C",
        recommendation: getStr("recommendation") || "Pending Review",
        summary: getStr("summary") || "Evaluation completed. See detailed feedback below.",
        strengths: getArr("strengths"),
        improvements: getArr("improvements"),
        feedback: feedback.length > 0 ? feedback : answers.map((a, i) => ({
          question: a.question.substring(0, 80),
          score: a.skipped ? 0 : 5,
          comment: a.skipped ? "Question was skipped." : "Answer recorded.",
          type: a.type || "main"
        }))
      };

      console.log("[JSON] Manually extracted:", result);
      return result;
    }

    // STT
    function initSTT(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){toast("‚ö†Ô∏è Use Chrome");return}
      recognition=new SR();recognition.lang=langMap[lang].speech;recognition.interimResults=true;recognition.continuous=true;
      recognition.onresult=(e)=>{let f="";for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)f+=e.results[i][0].transcript+" "}if(f){currentTranscript+=f;lastSpeechTime=Date.now();resetSilence();startSilence()}};
      recognition.onerror=(e)=>{if(e.error!=='no-speech'&&e.error!=='aborted')console.error("[STT]",e.error)};
      recognition.onend=()=>{if(isListening&&!isProcessing&&!isSpeaking)try{recognition.start()}catch(e){}};
    }
    function startListening(){
      if(!recognition||isListening)return;isListening=true;currentTranscript="";lastSpeechTime=Date.now();answerStartTime=Date.now();
      try{recognition.start()}catch(e){try{recognition.stop()}catch(e2){}setTimeout(()=>{try{recognition.start()}catch(e3){}},200)}
      setOrb("listening");document.getElementById("waveWrap").classList.add("active");
      document.getElementById("hfInfo").textContent="üé§ Listening ‚Äî Speak your answer...";startTimer();startSilence();
    }
    function stopListening(){isListening=false;resetSilence();try{recognition.stop()}catch(e){}document.getElementById("waveWrap").classList.remove("active");stopTimer()}

    function startSilence(){
      resetSilence();
      silenceTimer=setInterval(()=>{
        if(!isListening||isProcessing||isSpeaking)return;
        const silentFor=(Date.now()-lastSpeechTime)/1000;
        if(currentTranscript.trim().length>=MIN_ANSWER_LENGTH&&silentFor>=1){
          const remaining=Math.max(0,SILENCE_TIMEOUT-silentFor);
          const pct=(remaining/SILENCE_TIMEOUT)*100;
          document.getElementById("silenceWrap").classList.add("show");
          document.getElementById("silenceFill").style.width=pct+"%";
          document.getElementById("silenceText").textContent=remaining>0?`Auto-submitting in ${remaining.toFixed(1)}s...`:"Submitting...";
          if(silentFor>=SILENCE_TIMEOUT)autoSubmit();
        }else{document.getElementById("silenceWrap").classList.remove("show")}
      },200);
    }
    function resetSilence(){clearInterval(silenceTimer);silenceTimer=null;document.getElementById("silenceWrap").classList.remove("show");document.getElementById("silenceFill").style.width="100%"}

    async function autoSubmit(){
      if(isProcessing)return;isProcessing=true;stopListening();setOrb("processing");
      const answer=currentTranscript.trim();
      if(!answer||answer.length<MIN_ANSWER_LENGTH){isProcessing=false;toast("üé§ Still listening...");setTimeout(()=>startListening(),500);return}
      const question=document.getElementById("questionBox").textContent;
      const duration=Math.round((Date.now()-answerStartTime)/1000);
      answers.push({question,answer,type:isFollowUp?"followup":"main",mainQNum:mainQAsked,duration,skipped:false});
      console.log(`[${isFollowUp?"FOLLOWUP":"MAIN Q"+mainQAsked}] (${duration}s)`,answer);
      currentTranscript="";
      await getNextResponse(answer);isProcessing=false;
    }

    async function startInterview(){
      const roleSel=document.getElementById("roleSel").value;
      if(!roleSel){toast("‚ùå Select a role");return}
      role=roleSel==="custom"?document.getElementById("customRole").value.trim():roleSel;
      if(!role){toast("‚ùå Enter a role");return}
      lang=document.getElementById("langSel").value;level=document.getElementById("levelSel").value;
      totalQ=parseInt(document.getElementById("qCount").value);mainQAsked=0;isFollowUp=false;answers=[];chatMessages=[];evalRetryCount=0;

      const btn=document.getElementById("startBtn");btn.disabled=true;btn.textContent="‚è≥ Connecting...";
      try{
        const t=await fetch(WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:"Say OK"}]})});
        if(!t.ok)throw new Error("Worker error "+t.status);
      }catch(err){toast("‚ùå Cannot connect: "+err.message);btn.disabled=false;btn.textContent="üöÄ Start Interview";return}

      const sysPrompt=`You are an expert AI interviewer for a ${level}-level "${role}" position.
LANGUAGE: ${langMap[lang].name} only.
${cv?"\nRESUME:\n"+cv+"\n":""}
RULES:
1. Ask ${totalQ} MAIN questions. Mix behavioral, technical, situational.
2. For vague answers, ask C.L.A.I.M. follow-ups (Claims, Learning, Alternatives, Impact, Mechanism).
3. Follow-ups do not count toward the ${totalQ} total.
4. Be conversational, professional.
5. Adapt to ${level} level. Never repeat topics.
RESPONSE FORMAT:
- New main question: [NEXT] question text
- Follow-up: [FOLLOWUP] follow-up text
- All ${totalQ} done: [DONE] thank you message
Start now with [NEXT] and your first question.`;

      chatMessages=[{role:"system",content:sysPrompt}];
      document.getElementById("setupScreen").style.display="none";
      document.getElementById("interviewScreen").style.display="block";
      setOrb("thinking");showThinking(true);

      try{
        const firstQ=await callAI(chatMessages);chatMessages.push({role:"assistant",content:firstQ});
        const cleaned=firstQ.replace(/\[NEXT\]\s*/i,'').replace(/\[FOLLOWUP\]\s*/i,'').trim();
        mainQAsked=1;isFollowUp=false;
        showThinking(false);document.getElementById("questionBox").textContent=cleaned;updateProgress();
        initSTT();await speakText(cleaned);startListening();toast("üéØ Interview started!");
      }catch(err){console.error(err);showError("‚ùå "+err.message);showThinking(false);document.getElementById("questionBox").textContent="‚ùå Error. Check console.";setOrb("idle")}
      btn.disabled=false;btn.textContent="üöÄ Start Interview";
    }

    async function getNextResponse(answerText){
      showThinking(true);setOrb("thinking");
      const prompt=`The candidate answered: "${answerText}"
Main questions asked: ${mainQAsked} of ${totalQ}.
Decide:
- Vague/unverified ‚Üí [FOLLOWUP] probe deeper
- Thorough ‚Üí [NEXT] new main question
${mainQAsked>=totalQ&&!isFollowUp?"- All done ‚Üí [DONE] thank candidate briefly":""}
Output ONLY the tag + question. Stay in ${langMap[lang].name}.`;

      chatMessages.push({role:"user",content:prompt});
      try{
        const response=await callAI(chatMessages);chatMessages.push({role:"assistant",content:response});
        showThinking(false);
        const upper=response.toUpperCase();
        const cleaned=response.replace(/\[FOLLOWUP\]\s*/i,'').replace(/\[NEXT\]\s*/i,'').replace(/\[DONE\]\s*/i,'').trim();

        if(upper.includes("[DONE]")){
          document.getElementById("questionBox").textContent=cleaned;isFollowUp=false;mainQAsked=totalQ;updateProgress();
          await speakText(cleaned);setTimeout(()=>showResults(),2000);return;
        }
        if(upper.includes("[NEXT]")){mainQAsked++;isFollowUp=false;if(mainQAsked>totalQ)mainQAsked=totalQ}
        if(upper.includes("[FOLLOWUP]")){isFollowUp=true}
        document.getElementById("questionBox").textContent=cleaned;updateProgress();
        await speakText(cleaned);startListening();
      }catch(err){console.error(err);showError("‚ùå "+err.message);showThinking(false);setOrb("idle")}
    }

    function endEarly(){if(answers.length<1){toast("‚ö†Ô∏è Answer at least 1 question");return}stopListening();speechSynthesis.cancel();showResults()}

    function startTimer(){seconds=0;showTime();timerInterval=setInterval(()=>{seconds++;showTime()},1000)}
    function stopTimer(){clearInterval(timerInterval)}
    function showTime(){document.getElementById("timer").textContent=`${Math.floor(seconds/60).toString().padStart(2,'0')}:${(seconds%60).toString().padStart(2,'0')}`}

    function showThinking(show){
      document.getElementById("thinkBox").classList.toggle("hidden",!show);
      document.getElementById("waveWrap").style.display=show?"none":"flex";
      document.getElementById("hfInfo").style.display=show?"none":"block";
      document.getElementById("silenceWrap").classList.remove("show");
      if(show)document.getElementById("questionBox").textContent="";
    }

    // ============================================================
    // ‚òÖ FIXED: BULLETPROOF REPORT GENERATION
    // ============================================================
    async function showResults() {
      stopListening();speechSynthesis.cancel();
      document.getElementById("interviewScreen").style.display="none";
      document.getElementById("resultScreen").style.display="block";
      toast("üìä Generating evaluation...");
      await generateEvaluation();
    }

    async function generateEvaluation() {
      // Build clean Q&A ‚Äî remove special chars that break JSON
      const qaPairs = answers.map((a, i) => {
        const t = a.type === "followup" ? "FOLLOW-UP" : "MAIN Q" + a.mainQNum;
        const ans = a.skipped ? "SKIPPED" : a.answer.replace(/["\n\r\t\\]/g, ' ').substring(0, 300);
        const q = a.question.replace(/["\n\r\t\\]/g, ' ').substring(0, 200);
        return `[${t}] (${a.duration || 0}s)\nQ: ${q}\nA: ${ans}`;
      }).join('\n\n');

      const mainCount = answers.filter(a => a.type === "main" && !a.skipped).length;
      const skipCount = answers.filter(a => a.skipped).length;

      const evalMessages = [
        {
          role: "system",
          content: "You are a hiring evaluator. You MUST respond with ONLY a valid JSON object. No markdown. No explanation. No text before or after the JSON. Just pure JSON."
        },
        {
          role: "user",
          content: `Evaluate this ${level} interview for ${role}.

Stats: ${mainCount} main answered, ${skipCount} skipped, ${answers.length} total exchanges.

Transcript:
${qaPairs}

Scoring: 9-10=expert with metrics, 7-8=strong detail, 5-6=adequate, 3-4=vague, 1-2=poor, 0=skipped.

Return ONLY this JSON structure:
{"overallScore": 65, "grade": "B", "recommendation": "Lean Hire", "summary": "Two sentence summary here.", "strengths": ["strength one", "strength two"], "improvements": ["improve one", "improve two"], "feedback": [{"question": "short question", "score": 7, "comment": "feedback here", "type": "main"}]}

IMPORTANT: Use simple short strings. No newlines inside strings. No special characters. Keep comments under 100 characters each. Return ONLY the JSON.`
        }
      ];

      try {
        const raw = await callAI(evalMessages);
        console.log("[EVAL RAW]", raw);

        const result = safeParseJSON(raw);
        console.log("[EVAL PARSED]", result);

        // Validate
        if (typeof result.overallScore !== 'number' || result.overallScore < 0 || result.overallScore > 100) {
          result.overallScore = 50;
        }

        renderResults(result);
        toast("üèÜ Evaluation complete!");
        document.getElementById("retryWrap").style.display = "none";

      } catch(err) {
        console.error("[EVAL ERROR]", err);
        evalRetryCount++;

        if (evalRetryCount < MAX_EVAL_RETRIES) {
          toast(`‚ö†Ô∏è Retry ${evalRetryCount}/${MAX_EVAL_RETRIES}...`);
          console.log("[EVAL] Retrying...", evalRetryCount);
          await generateEvaluation();
        } else {
          // ‚òÖ Generate fallback report from local data
          toast("‚ö†Ô∏è Using local evaluation");
          renderFallbackResults();
          document.getElementById("retryWrap").style.display = "block";
        }
      }
    }

    // ‚òÖ Retry button
    async function retryEvaluation() {
      evalRetryCount = 0;
      toast("üîÑ Retrying evaluation...");
      document.getElementById("scoreNum").textContent = "0";
      document.getElementById("gradeBadge").textContent = "‚Äî";
      document.getElementById("scoreSummary").textContent = "";
      document.getElementById("fbList").innerHTML = "";
      document.getElementById("strengthsCard").style.display = "none";
      document.getElementById("hireBadge").style.display = "none";
      document.getElementById("retryWrap").style.display = "none";
      await generateEvaluation();
    }

    // ‚òÖ Fallback report if AI fails completely
    function renderFallbackResults() {
      const mainAnswered = answers.filter(a => a.type === "main" && !a.skipped).length;
      const skipped = answers.filter(a => a.skipped).length;
      const score = Math.max(10, Math.round((mainAnswered / Math.max(totalQ, 1)) * 70));

      const result = {
        overallScore: score,
        grade: score >= 80 ? "A" : score >= 70 ? "B+" : score >= 60 ? "B" : score >= 50 ? "C+" : score >= 40 ? "C" : "D",
        recommendation: score >= 60 ? "Lean Hire" : "Lean No Hire",
        summary: `Candidate answered ${mainAnswered} of ${totalQ} main questions. ${skipped} questions were skipped. Detailed AI evaluation was unavailable.`,
        strengths: mainAnswered > 0 ? ["Participated in the interview"] : [],
        improvements: skipped > 0 ? ["Avoid skipping questions"] : ["Provide more detailed answers"],
        feedback: answers.map((a, i) => ({
          question: a.question.substring(0, 80),
          score: a.skipped ? 0 : Math.min(10, Math.max(1, Math.round(a.duration / 10))),
          comment: a.skipped ? "Question was skipped." : `Answered in ${a.duration}s.`,
          type: a.type
        }))
      };

      renderResults(result);
    }

    function renderResults(r) {
      const score = r.overallScore || 0;
      const grade = r.grade || "?";
      const isGood = score >= 80;
      const isOk = score >= 60;
      const color = isGood ? '#3fb950' : isOk ? '#d29922' : '#f85149';
      const colorBg = isGood ? 'rgba(63,185,80,0.15)' : isOk ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';

      document.getElementById("scoreRing").style.background = `conic-gradient(${color} ${score*3.6}deg, rgba(255,255,255,0.05) 0deg)`;

      const badge = document.getElementById("gradeBadge");
      badge.textContent = `Grade: ${grade}`;
      badge.style.background = colorBg;
      badge.style.color = color;

      if (r.recommendation) {
        const hb = document.getElementById("hireBadge");
        hb.style.display = "inline-block";
        hb.textContent = r.recommendation;
        const isHire = r.recommendation.toLowerCase().includes("hire") && !r.recommendation.toLowerCase().includes("no");
        hb.style.background = isHire ? 'rgba(63,185,80,0.15)' : 'rgba(248,81,73,0.15)';
        hb.style.color = isHire ? '#3fb950' : '#f85149';
      }

      document.getElementById("scoreSummary").textContent = r.summary || "";

      if ((r.strengths && r.strengths.length) || (r.improvements && r.improvements.length)) {
        document.getElementById("strengthsCard").style.display = "block";
        const sl = document.getElementById("strengthsList");
        sl.innerHTML = "";
        (r.strengths || []).forEach(s => { sl.innerHTML += `<li><span>‚úÖ</span> ${s}</li>`; });
        const il = document.getElementById("improveList");
        il.innerHTML = "";
        (r.improvements || []).forEach(s => { il.innerHTML += `<li><span>üìà</span> ${s}</li>`; });
      }

      const list = document.getElementById("fbList");
      list.innerHTML = "";
      (r.feedback || []).forEach((fb, i) => {
        const sc = fb.score || 0;
        const c = sc >= 7 ? '#3fb950' : sc >= 5 ? '#d29922' : '#f85149';
        const bg = sc >= 7 ? 'rgba(63,185,80,0.15)' : sc >= 5 ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';
        const typeColor = fb.type === "followup" ? 'rgba(188,140,255,0.15)' : 'rgba(88,166,255,0.15)';
        const typeText = fb.type === "followup" ? '#bc8cff' : '#58a6ff';
        const typeLabel = fb.type === "followup" ? "Follow-up" : "Main";
        const ma = answers[i];
        const preview = ma ? (ma.skipped ? "[Skipped]" : ma.answer.substring(0, 120) + (ma.answer.length > 120 ? "..." : "")) : "";

        const div = document.createElement("div");
        div.className = "fb-item";
        div.innerHTML = `
          <div class="fb-q">${fb.question}<span class="fb-type" style="background:${typeColor};color:${typeText};">${typeLabel}</span></div>
          ${preview ? `<div class="fb-a">"${preview}"</div>` : ""}
          <span class="fb-score" style="background:${bg};color:${c};">${sc}/10</span>
          <div class="fb-text">${fb.comment}</div>`;
        list.appendChild(div);
      });

      let cur = 0;
      const el = document.getElementById("scoreNum");
      const iv = setInterval(() => { cur += Math.ceil(score / 30); if (cur >= score) { cur = score; clearInterval(iv); } el.textContent = cur; }, 30);
    }

    window.addEventListener('DOMContentLoaded', () => {
      if (window.pdfjsLib) console.log("‚úÖ PDF.js v" + pdfjsLib.version);
      if (!window.SpeechRecognition && !window.webkitSpeechRecognition) console.warn("‚ö†Ô∏è Use Chrome");
    });
  </script>
</body>
</html>
