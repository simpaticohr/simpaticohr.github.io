<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Evalis AI – CV Interview</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  background:#0f172a;
  color:#fff;
  font-family:system-ui,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card {
  width:440px;
  background:#1e293b;
  padding:26px;
  border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
}
h2 { margin-top:0; text-align:center; }
button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#4f46e5;
  color:white;
  font-weight:700;
  cursor:pointer;
  margin-top:10px;
}
button:disabled { opacity:.5; cursor:not-allowed; }
#status {
  text-align:center;
  font-size:13px;
  color:#94a3b8;
  margin-bottom:10px;
}
#log {
  margin-top:15px;
  background:#020617;
  padding:15px;
  height:240px;
  overflow-y:auto;
  border-radius:12px;
  font-size:14px;
  border:1px solid #334155;
}
.ai { color:#a5b4fc; margin-bottom:10px; }
.user { color:#94a3b8; font-style:italic; margin-bottom:8px; }
input[type=file] {
  width:100%;
  margin-bottom:10px;
  font-size:12px;
}
</style>
</head>
<body>

<div class="card">
  <h2>Evalis AI Interview</h2>
  <div id="status">Upload CV to begin</div>

  <input type="file" id="cvInput" accept=".pdf,.txt">
  <button id="startBtn" disabled>Start Interview</button>
  <button id="finishBtn" style="display:none;background:#ef4444">
    Finish & Get Score
  </button>

  <div id="log"></div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

/* ================= STATE ================= */
let recognition;
let listening = false;
let speaking = false;
let history = [];
let cvText = "";

/* ================= UI ================= */
const logBox = document.getElementById("log");
const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const finishBtn = document.getElementById("finishBtn");
const cvInput = document.getElementById("cvInput");

function log(cls, text) {
  const d = document.createElement("div");
  d.className = cls;
  d.textContent = text;
  logBox.appendChild(d);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= CV LOAD ================= */
cvInput.onchange = async () => {
  const file = cvInput.files[0];
  if (!file) return;

  statusEl.textContent = "Reading CV…";

  if (file.type === "text/plain") {
    cvText = await file.text();
  } else {
    cvText = "PDF CV uploaded (content processed server-side)";
  }

  statusEl.textContent = "CV loaded. Ready.";
  startBtn.disabled = false;
};

/* ================= SPEAK ================= */
function speak(text) {
  if (!text) return;
  speaking = true;
  log("ai", "AI: " + text);

  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;

  u.onend = () => {
    speaking = false;
    if (listening) recognition.start();
  };

  speechSynthesis.speak(u);
}

/* ================= SPEECH RECOGNITION (VAD) ================= */
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = async (e) => {
    const transcript = e.results[0][0].transcript.trim();
    if (!transcript) return;

    log("user", "You: " + transcript);
    statusEl.textContent = "Thinking…";

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ transcript, history, cvText })
    });

    const data = await res.json();
    history = data.history || history;
    speak(data.reply);
  };

  recognition.onerror = () => {
    if (listening && !speaking) recognition.start();
  };

  recognition.onend = () => {
    if (listening && !speaking) recognition.start();
  };
}

/* ================= START ================= */
startBtn.onclick = async () => {
  initRecognition();
  listening = true;
  startBtn.style.display = "none";
  finishBtn.style.display = "block";

  statusEl.textContent = "Interview started…";

  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "start", cvText })
  });

  const data = await res.json();
  history = data.history || [];
  speak(data.reply);
};

/* ================= FINISH & SCORE ================= */
finishBtn.onclick = async () => {
  listening = false;
  speechSynthesis.cancel();
  recognition.stop();
  statusEl.textContent = "Evaluating interview…";

  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "score", history, cvText })
  });

  const data = await res.json();
  log("ai", "FINAL EVALUATION:");
  log("ai", data.reply);
};
</script>

</body>
</html>
