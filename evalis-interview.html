<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evalis AI – Live Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root{
  --primary:#6366f1;
  --bg:#020617;
  --card:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.1);
  --ok:#10b981;
  --bad:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:#fff;
  font-family:system-ui,sans-serif;
  display:flex;justify-content:center;align-items:center;
  min-height:100vh
}
.back-btn{
  position:fixed;top:18px;left:18px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  padding:10px 16px;border-radius:12px;
  color:#fff;cursor:pointer;z-index:9
}
.container{
  width:95%;max-width:1100px;
  display:grid;grid-template-columns:1fr 1fr;gap:24px
}
@media(max-width:900px){.container{grid-template-columns:1fr}}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:24px;padding:28px;
  box-shadow:0 25px 50px rgba(0,0,0,.5)
}
h1,h2{margin:0 0 6px}
p{margin:0;color:#94a3b8;font-size:14px}
#timer{
  font-size:42px;font-weight:800;
  color:var(--primary);text-align:center;margin:16px 0
}
#status{text-align:center;font-size:14px;color:#94a3b8;margin-bottom:20px}
input[type=file]{
  width:100%;padding:14px;border-radius:12px;
  background:transparent;color:#fff;
  border:2px dashed var(--border)
}
button{
  width:100%;padding:16px;border-radius:14px;
  font-size:16px;font-weight:700;border:none;cursor:pointer
}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--bad);color:#fff}
button:disabled{opacity:.4}
.log{max-height:460px;overflow-y:auto}
.msg{
  margin-bottom:14px;padding:12px 16px;border-radius:12px
}
.msg.user{background:rgba(103,232,249,.1);border-left:3px solid #67e8f9}
.msg.ai{background:rgba(165,180,252,.1);border-left:3px solid #a5b4fc}
.vosk{
  margin-top:16px;padding:12px 16px;
  border-radius:12px;border:1px solid var(--border);
  background:rgba(255,255,255,.03);font-size:13px
}
.ok{color:var(--ok)}
</style>
</head>

<body>

<button class="back-btn" id="backBtn">← Back</button>

<div class="container">

<!-- LEFT -->
<div class="card">
  <h1>Evalis AI Interview</h1>
  <p>Live voice interview</p>

  <div id="timer">15:00</div>
  <div id="status">Upload resume to begin</div>

  <input type="file" id="cvInput" accept=".pdf"><br><br>

  <button id="startBtn" class="btn-primary" disabled>Start Interview</button>
  <button id="endBtn" class="btn-danger" style="display:none">End Interview</button>

  <div class="vosk" id="voskBox" style="display:none">
    <div>Voice Engine: <span class="ok">Active</span></div>
    <div>Mode: Continuous</div>
  </div>
</div>

<!-- RIGHT -->
<div class="card">
  <h2>Conversation</h2>
  <p>Live transcript</p>
  <div class="log" id="log"></div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API="https://evalis-ai.simpaticohrconsultancy.workers.dev";

/* ================= STATE ================= */
let cvText="", history=[], interviewActive=false;
let isAISpeaking=false, isProcessing=false;
let timeLeft=15*60, timerInt;
let recognition=null;

/* ================= PDF ================= */
const pdfjsLib=window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc=
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const cvInput=document.getElementById("cvInput");
const startBtn=document.getElementById("startBtn");
const endBtn=document.getElementById("endBtn");
const status=document.getElementById("status");
const timer=document.getElementById("timer");
const logBox=document.getElementById("log");
const voskBox=document.getElementById("voskBox");
const backBtn=document.getElementById("backBtn");

/* ================= PDF LOAD ================= */
cvInput.onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  status.textContent="Reading resume...";
  const pdf=await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
  let t="";
  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const c=await p.getTextContent();
    t+=c.items.map(x=>x.str).join(" ")+" ";
  }
  cvText=t.trim()||"[Resume uploaded]";
  startBtn.disabled=false;
  status.textContent="Resume ready ✓";
};

/* ================= TIMER ================= */
function startTimer(){
  timerInt=setInterval(()=>{
    timeLeft--;
    timer.textContent=`${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,"0")}`;
    if(timeLeft<=0) finishInterview();
  },1000);
}

/* ================= TTS ================= */
function speak(text){
  return new Promise(res=>{
    isAISpeaking=true;
    status.textContent="AI speaking...";
    addMsg("ai",text);

    const u=new SpeechSynthesisUtterance(text);
    u.rate=0.95;

    u.onend=()=>{
      isAISpeaking=false;
      status.textContent="Listening...";
      if(recognition && interviewActive) recognition.start();
      res();
    };

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  });
}

/* ================= BROWSER MIC ================= */
function initBrowserSpeech(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return;

  recognition=new SR();
  recognition.lang="en-US";
  recognition.continuous=true;

  recognition.onresult=e=>{
    const text=e.results[e.results.length-1][0].transcript.trim();
    if(text && interviewActive && !isAISpeaking && !isProcessing){
      processUser(text);
    }
  };

  recognition.onend=()=>{
    if(interviewActive && !isAISpeaking){
      recognition.start();
    }
  };
}

/* ================= ANDROID VOSK ================= */
window.receiveVoskText=text=>{
  if(text && interviewActive && !isAISpeaking && !isProcessing){
    processUser(text);
  }
};

/* ================= USER INPUT ================= */
async function processUser(text){
  isProcessing=true;
  status.textContent="Thinking...";
  addMsg("user",text);

  try{
    const fd=new FormData();
    fd.append("mode","interview");
    fd.append("text",text);
    fd.append("cvText",cvText);
    fd.append("history",JSON.stringify(history));

    const r=await fetch(API,{method:"POST",body:fd});
    const d=await r.json();
    history=d.history||history;
    await speak(d.reply||"Please continue.");
  }catch{
    await speak("Can you explain that further?");
  }

  isProcessing=false;
}

/* ================= START ================= */
startBtn.onclick=async()=>{
  interviewActive=true;
  startTimer();

  cvInput.style.display="none";
  startBtn.style.display="none";
  endBtn.style.display="block";
  voskBox.style.display="block";

  initBrowserSpeech();
  if(recognition) recognition.start();

  status.textContent="Starting interview...";

  try{
    const fd=new FormData();
    fd.append("mode","start");
    fd.append("cvText",cvText);
    const r=await fetch(API,{method:"POST",body:fd});
    const d=await r.json();
    history=d.history||[];
    await speak(d.reply||"Tell me about yourself.");
  }catch{
    await speak("Tell me about yourself.");
  }
};

/* ================= END ================= */
endBtn.onclick=()=>confirm("End interview?")&&finishInterview();

async function finishInterview(){
  interviewActive=false;
  clearInterval(timerInt);
  if(recognition) recognition.stop();
  speechSynthesis.cancel();
  status.textContent="Generating report...";

  const fd=new FormData();
  fd.append("mode","score");
  fd.append("history",JSON.stringify(history));
  fd.append("cvText",cvText);

  const r=await fetch(API,{method:"POST",body:fd});
  const d=await r.json();

  document.body.innerHTML=`
    <div class="card" style="max-width:800px">
      <h1>Interview Complete</h1>
      <pre style="white-space:pre-wrap">${d.reply||"Report coming soon"}</pre>
      <button class="btn-primary" onclick="location.reload()">New Interview</button>
    </div>`;
}

/* ================= UI ================= */
function addMsg(role,text){
  const d=document.createElement("div");
  d.className="msg "+role;
  d.innerHTML=`<b>${role==="ai"?"AI":"You"}:</b> ${text}`;
  logBox.appendChild(d);
  logBox.scrollTop=logBox.scrollHeight;
}

/* ================= NAV ================= */
backBtn.onclick=()=>location.href="career-lab.html";
history.pushState(null,"",location.href);
window.onpopstate=()=>backBtn.click();
</script>

</body>
</html>
