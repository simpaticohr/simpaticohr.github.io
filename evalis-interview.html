<!DOCTYPE html>
<html>
<head>
    <title>Career Lab AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; text-align: center; padding: 40px; }
        .box { max-width: 400px; margin: auto; background: #1e293b; padding: 20px; border-radius: 15px; }
        #log { height: 200px; overflow-y: auto; background: #000; margin: 10px 0; padding: 10px; font-size: 13px; text-align: left; }
        button { width: 100%; padding: 15px; background: #3b82f6; border: none; color: white; cursor: pointer; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="box">
        <h3>Career Lab</h3>
        <input type="file" id="cv" style="margin-bottom: 20px;">
        <div id="log">Upload your CV to begin...</div>
        <button id="btn" disabled>Start Interview</button>
    </div>

<script>
const URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let chatHistory = [], resume = "", active = false, busy = false;

document.getElementById('cv').onchange = async (e) => {
    const file = e.target.files[0];
    if (file.type === "application/pdf") {
        const pdf = await pdfjsLib.getDocument(new Uint8Array(await file.arrayBuffer())).promise;
        for(let i=1; i<=pdf.numPages; i++) resume += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(" ");
    } else { resume = await file.text(); }
    document.getElementById('btn').disabled = false;
};

function aiSpeak(text) {
    if (!text) { busy = false; return; }
    window.speechSynthesis.cancel(); // Reset
    const u = new SpeechSynthesisUtterance(text);
    document.getElementById('log').innerHTML += `<p><b>AI:</b> ${text}</p>`;
    u.onend = () => { busy = false; if(active) startLoop(); };
    window.speechSynthesis.speak(u);
}

async function startLoop() {
    if (busy || !active) return;
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const rec = new MediaRecorder(stream);
    const chunks = [];
    
    rec.ondataavailable = e => chunks.push(e.data);
    rec.onstop = async () => {
        busy = true;
        stream.getTracks().forEach(t => t.stop());
        const fd = new FormData();
        fd.append("audio", new Blob(chunks));
        fd.append("cvText", resume);
        fd.append("history", JSON.stringify(chatHistory));

        try {
            const res = await fetch(URL, { method: "POST", body: fd });
            const data = await res.json();
            
            // SYNC CHECK: Use 'reply' and 'history' to match the Worker
            if (data.reply) {
                chatHistory = data.history;
                aiSpeak(data.reply);
            }
        } catch (err) { 
            busy = false; 
            aiSpeak("I lost connection. One second..."); 
        }
    };
    rec.start();
    setTimeout(() => rec.stop(), 5000); // 5-second turns
}

document.getElementById('btn').onclick = () => {
    active = !active;
    if (active) {
        document.getElementById('btn').innerText = "Stop Interview";
        aiSpeak("I have your resume. Let's start. Tell me about your background.");
    } else {
        location.reload(); // Quick reset
    }
};
</script>
</body>
</html>
