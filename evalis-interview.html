<script>
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

let isThinking = false;
let currentState = "introduction";

/* ===============================
   SPEAK AI RESPONSE
================================ */
function speak(text) {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = 1;
  speechSynthesis.speak(u);
}

/* ===============================
   THINKING UI
================================ */
function setThinking(on) {
  document.getElementById("thinking").textContent = on ? "Thinking..." : "";
  document.getElementById("micBtn").disabled = on;
}

/* ===============================
   SEND ANSWER TO BACKEND
================================ */
async function sendAnswer(answer) {
  if (isThinking || !answer) return;

  isThinking = true;
  setThinking(true);

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answer, state: currentState })
    });

    const data = await res.json();

    const followUp = data.followUp || "Tell me more.";
    document.getElementById("question").textContent = followUp;
    speak(followUp);

    currentState = data.nextState || currentState;

  } catch (e) {
    speak("Sorry, please try again.");
  } finally {
    setThinking(false);
    isThinking = false;
  }
}

/* ===============================
   START MIC (MOBILE SAFE)
================================ */
function startListening() {
  if (isThinking) return;

  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("Speech recognition not supported on this browser.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    sendAnswer(transcript);
  };

  recognition.onerror = () => {
    setThinking(false);
    isThinking = false;
  };

  recognition.start();
}

/* ===============================
   BUTTON CLICK
================================ */
document.getElementById("micBtn").onclick = startListening;

/* ===============================
   INITIAL PROMPT
================================ */
speak("Tell me about yourself.");
</script>
