<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Career Lab AI | Voice Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root {
  --bg:#0f172a; --card:#1e293b; --accent:#2563eb; --danger:#dc2626;
}
body {
  margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center;
  background:var(--bg); color:#e5e7eb; font-family:system-ui,-apple-system;
}
.card {
  width:100%; max-width:440px; background:var(--card); padding:28px;
  border-radius:22px; border:1px solid rgba(255,255,255,.08); text-align:center;
}
.pulse {
  width:64px;height:64px;border-radius:50%;background:var(--accent);
  margin:18px auto; display:none;
  animation:pulse 1.5s infinite;
}
@keyframes pulse {
  0%{box-shadow:0 0 0 0 rgba(37,99,235,.7)}
  100%{box-shadow:0 0 0 22px rgba(37,99,235,0)}
}
button {
  width:100%; padding:14px; border-radius:14px;
  border:none; font-weight:700; cursor:pointer;
}
button:disabled { opacity:.4; cursor:not-allowed }
#startBtn { background:var(--accent); color:#fff }
#stopBtn { background:var(--danger); color:#fff; display:none }
#log {
  margin-top:18px; background:rgba(0,0,0,.25);
  border-radius:14px; padding:14px; height:210px;
  overflow-y:auto; font-size:14px; text-align:left;
}
.status { font-size:13px; color:#94a3b8; margin-bottom:10px }
</style>
</head>

<body>
<div class="card">
  <h2>Career Lab AI</h2>
  <div class="status" id="status">Upload resume to begin</div>

  <input id="cvInput" type="file" accept=".pdf,.txt" style="width:100%;margin-bottom:14px">

  <div class="pulse" id="pulse"></div>

  <button id="startBtn" disabled>ðŸŽ¤ Start Interview</button>
  <button id="stopBtn">ðŸ›‘ Stop Session</button>

  <div id="log">AI ready.</div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

/* ================= STATE ================= */
let resumeText = "";
let history = [];
let interviewActive = false;
let processing = false;

/* ================= ELEMENTS ================= */
const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const pulseEl = document.getElementById("pulse");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const cvInput = document.getElementById("cvInput");

/* ================= RESUME PARSER ================= */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

cvInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  statusEl.textContent = "Reading resumeâ€¦";
  try {
    if (file.type === "application/pdf") {
      const pdf = await pdfjsLib
        .getDocument(new Uint8Array(await file.arrayBuffer())).promise;
      let text = "";
      for (let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(i=>i.str).join(" ") + "\n";
      }
      resumeText = text;
    } else {
      resumeText = await file.text();
    }
    statusEl.textContent = "Ready to start";
    logEl.textContent = "Resume parsed successfully.";
    startBtn.disabled = false;
  } catch {
    statusEl.textContent = "Failed to read resume";
  }
};

/* ================= AI SPEAK ================= */
function aiSpeak(text) {
  if (!text || text.trim().length < 2) {
    processing = false;
    return;
  }

  logEl.innerHTML += `<p style="color:#60a5fa"><b>AI:</b> ${text}</p>`;
  logEl.scrollTop = logEl.scrollHeight;

  const u = new SpeechSynthesisUtterance(text);
  u.onend = () => {
    processing = false;
    if (interviewActive) setTimeout(startRecording, 500);
  };

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ================= RECORD USER ================= */
async function startRecording() {
  if (processing || !interviewActive) return;

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  } catch {
    statusEl.textContent = "Mic permission denied";
    interviewActive = false;
    return;
  }

  const recorder = new MediaRecorder(stream, { mimeType:"audio/webm" });
  const chunks = [];

  pulseEl.style.display = "block";
  statusEl.textContent = "Listeningâ€¦";

  recorder.ondataavailable = e => e.data.size && chunks.push(e.data);

  recorder.onstop = async () => {
    pulseEl.style.display = "none";
    stream.getTracks().forEach(t=>t.stop());
    if (!chunks.length || !interviewActive) return;

    processing = true;
    statusEl.textContent = "Analyzingâ€¦";

    const fd = new FormData();
    fd.append("audio", new Blob(chunks,{type:"audio/webm"}));
    fd.append("mode","interview");
    fd.append("cvText",resumeText);
    fd.append("history",JSON.stringify(history));

    try {
      const res = await fetch(WORKER_URL,{method:"POST",body:fd});
      if (!res.ok) throw new Error();
      const data = await res.json();

      if (data.nextQuestion) {
        history = data.newHistory || history;
        aiSpeak(data.nextQuestion);
      } else {
        processing = false;
        statusEl.textContent = "Please repeat your answer";
      }
    } catch {
      processing = false;
      statusEl.textContent = "Temporary issue. Speak again.";
    }
  };

  recorder.start();
  setTimeout(()=>recorder.state==="recording"&&recorder.stop(),6500);
}

/* ================= BUTTONS ================= */
startBtn.onclick = () => {
  interviewActive = true;
  startBtn.style.display = "none";
  stopBtn.style.display = "block";
  cvInput.style.display = "none";
  aiSpeak("Iâ€™ve reviewed your resume. Please introduce yourself.");
};

stopBtn.onclick = () => location.reload();
</script>
</body>
</html>
