<script>
let state = {
  started: false,
  history: [],
  listening: false
};

const WORKER_URL = "https://evalis-ai.simpaticohconsultancy.workers.dev";

const orb = document.getElementById("orb");
const questionEl = document.getElementById("question");
const statusEl = document.getElementById("status");

let recognition;
let speaking = false;

// ---------- SPEAK ----------
function speak(text, onEnd) {
  speaking = true;
  statusEl.innerText = "Speaking...";
  const msg = new SpeechSynthesisUtterance(text);
  msg.onend = () => {
    speaking = false;
    onEnd && onEnd();
  };
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

// ---------- LISTEN ----------
function startListening() {
  if (speaking) return;

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.interimResults = false;

  recognition.onstart = () => {
    state.listening = true;
    orb.className = "orb listening";
    statusEl.innerText = "Listening...";
  };

  recognition.onresult = async (e) => {
    recognition.stop();
    state.listening = false;
    orb.className = "orb thinking";

    const answer = e.results[0][0].transcript;
    statusEl.innerText = "Thinking...";

    // ---- CALL BACKEND ----
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        answer,
        history: state.history
      })
    });

    const data = await res.json();
    state.history.push({ q: questionEl.innerText, a: answer });

    questionEl.innerText = data.followUp;

    // ðŸ” Speak then listen again
    speak(data.followUp, () => {
      setTimeout(startListening, 400);
    });
  };

  recognition.onerror = () => {
    statusEl.innerText = "Tap to continue";
    orb.className = "orb";
  };

  recognition.start();
}

// ---------- START INTERVIEW ----------
document.body.onclick = () => {
  if (state.started) return;

  state.started = true;
  questionEl.innerText = "Tell me about yourself.";
  speak("Tell me about yourself.", () => {
    setTimeout(startListening, 400);
  });
};
</script>
