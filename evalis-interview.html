<script>
let chatHistory = [];
let isInterviewActive = false;
const synth = window.speechSynthesis;
const API_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

// üîä AI speaks first, then listens
function aiSpeak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.onend = () => {
    if (isInterviewActive) startListening();
  };
  synth.speak(utter);
}

// üé§ Record user answer
async function startListening() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const recorder = new MediaRecorder(stream);
  const chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = async () => {
    stream.getTracks().forEach(t => t.stop());

    const fd = new FormData();
    fd.append("audio", new Blob(chunks, { type: "audio/webm" }));
    fd.append("mode", "interview");
    fd.append("candidate_id", candidateId);
    fd.append("job_id", jobId);
    fd.append("history", JSON.stringify(chatHistory));

    const res = await fetch(API_URL, { method: "POST", body: fd });
    const data = await res.json();

    // Interview finished?
    if (data.complete) {
      showFinalReport(data.report);
      isInterviewActive = false;
      return;
    }

    chatHistory = data.newHistory;
    aiSpeak(data.nextQuestion);
  };

  recorder.start();
  setTimeout(() => {
    if (recorder.state === "recording") recorder.stop();
  }, 8000);
}

// ‚ñ∂Ô∏è Start interview
function startInterview() {
  isInterviewActive = true;
  aiSpeak("Hello. Let's begin your interview. Please introduce yourself.");
}
</script>
