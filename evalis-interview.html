<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Evalis AI Interview</title>

<!-- VAD -->
<script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.7/dist/bundle.standard.js"></script>

<style>
body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #1e293b, #020617);
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
  color: #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: center;
}

.card {
  width: 92%;
  max-width: 420px;
  background: rgba(2,6,23,.9);
  border-radius: 18px;
  padding: 26px;
  box-shadow: 0 30px 80px rgba(0,0,0,.6);
  text-align: center;
}

h3 {
  margin: 0 0 8px;
  font-weight: 600;
}

#question {
  margin: 18px 0;
  font-size: 18px;
  min-height: 64px;
}

#status {
  font-size: 14px;
  color: #22c55e;
  min-height: 20px;
}

/* MIC */
.mic {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #22c55e;
  margin: 14px auto 6px;
  opacity: .3;
  transition: .2s;
}

.mic.active {
  opacity: 1;
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(34,197,94,.6); }
  70% { box-shadow: 0 0 0 16px rgba(34,197,94,0); }
  100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
}

button {
  width: 100%;
  margin-top: 18px;
  padding: 14px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg,#2563eb,#3b82f6);
  color: white;
}
button:disabled {
  opacity: .6;
}
</style>
</head>

<body>
<div class="card">
  <h3>Evalis AI Interview</h3>
  <div id="question">Ready to begin</div>
  <div id="status">Microphone permission required</div>
  <div id="mic" class="mic"></div>
  <button id="startBtn">Start Interview</button>
</div>

<script>
/* ================= STATE ================= */
let started = false;
let isAISpeaking = false;
let audioContext;
let micStream;
let myvad;

/* ================= ELEMENTS ================= */
const questionEl = document.getElementById("question");
const statusEl = document.getElementById("status");
const micEl = document.getElementById("mic");
const startBtn = document.getElementById("startBtn");

/* ================= HELPERS ================= */
function setStatus(t){ statusEl.innerText = t; }
function setMic(active){ micEl.classList.toggle("active", active); }

/* ================= AUDIO UNLOCK (CRITICAL FOR MOBILE) ================= */
async function unlockAudio(){
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  if(audioContext.state !== "running"){
    await audioContext.resume();
  }
}

/* ================= SPEECH SYNTH ================= */
const synth = window.speechSynthesis;

function speak(text){
  synth.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = .95;

  u.onstart = () => {
    isAISpeaking = true;
    setStatus("AI speaking‚Ä¶");
    setMic(false);
  };

  u.onend = () => {
    isAISpeaking = false;
    setStatus("Listening‚Ä¶");
  };

  questionEl.innerText = text;
  synth.speak(u);
}

/* ================= SPEECH RECOGNITION ================= */
const recognition =
  new (window.SpeechRecognition || window.webkitSpeechRecognition)();

recognition.lang = "en-US";
recognition.interimResults = false;
recognition.continuous = false;

recognition.onresult = (e)=>{
  const answer = e.results[0][0].transcript;
  setStatus("Thinking‚Ä¶");
  setMic(false);

  // üîπ TEMP LOGIC (replace with resume engine later)
  if(answer.length < 15){
    speak("Can you explain that in more detail?");
  } else {
    speak("What challenges did you face there?");
  }
};

/* ================= VAD ================= */
async function initVAD(stream){
  myvad = await vad.MicVAD.new({
    stream,
    onSpeechStart(){
      if(isAISpeaking) synth.cancel();
      setMic(true);
    },
    onSpeechEnd(){
      setMic(false);
      recognition.start();
    }
  });
  myvad.start();
}

/* ================= START ================= */
startBtn.onclick = async ()=>{
  if(started) return;
  started = true;
  startBtn.disabled = true;
  setStatus("Initializing audio‚Ä¶");

  try{
    // 1Ô∏è‚É£ Unlock audio (MANDATORY on mobile)
    await unlockAudio();

    // 2Ô∏è‚É£ Request mic
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // 3Ô∏è‚É£ Init VAD
    await initVAD(micStream);

    // 4Ô∏è‚É£ UI
    startBtn.style.display = "none";
    setStatus("Listening‚Ä¶");

    // 5Ô∏è‚É£ Speak
    speak("Tell me about yourself.");

  }catch(err){
    console.error(err);
    setStatus("Microphone permission required");
    started = false;
    startBtn.disabled = false;
  }
};
</script>
</body>
</html>
