<script>
    let active = false, busy = false, history = [], cvText = "";
    let mediaRecorder;

    // THE START: Triggers the first CV-based question
    document.getElementById('startBtn').onclick = async () => {
        active = true;
        document.getElementById('startBtn').style.display = "none";
        startTimer(); // 15:00 limit
        
        // Initial "CV Deep-Dive" fetch
        const fd = new FormData();
        fd.append("resume", cvText);
        fd.append("history", JSON.stringify([]));
        
        const res = await fetch(WORKER_URL, { method: "POST", body: fd });
        const data = await res.json();
        speak(data.reply); // First question will be about your specific tech stack
    };

    async function startTurn() {
        if (!active || busy) return;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        const chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
            if (!active) return;
            busy = true;
            document.getElementById('status').innerText = "Analyzing...";

            const fd = new FormData();
            fd.append("audio", new Blob(chunks), "v.webm");
            fd.append("resume", cvText);
            fd.append("history", JSON.stringify(history));

            const res = await fetch(WORKER_URL, { method: "POST", body: fd });
            const data = await res.json();
            
            history = data.history;
            updateUI(data.userText, data.reply);
            speak(data.reply);
            stream.getTracks().forEach(t => t.stop());
        };

        mediaRecorder.start();
        // AUTO-STOP: Stops when you are silent (Smart Timer)
        setTimeout(() => { if(mediaRecorder.state === "recording") mediaRecorder.stop(); }, 8000);
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const ut = new SpeechSynthesisUtterance(text);
        ut.rate = 1.05; // Slightly faster for a modern feel
        ut.onstart = () => { document.getElementById('status').innerText = "Interviewer Speaking..."; };
        ut.onend = () => {
            busy = false;
            if (active) setTimeout(startTurn, 200); // Instant mic re-open
        };
        window.speechSynthesis.speak(ut);
    }
</script>
