<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evalis AI – Live Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root{
  --primary:#6366f1;
  --bg:#020617;
  --card:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.1);
  --ok:#10b981;
  --bad:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:#fff;
  font-family:system-ui,sans-serif;
  display:flex;justify-content:center;align-items:center;
  min-height:100vh
}
.back-btn{
  position:fixed;top:18px;left:18px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  padding:10px 16px;border-radius:12px;
  color:#fff;cursor:pointer;z-index:9
}
.container{
  width:95%;max-width:1100px;
  display:grid;grid-template-columns:1fr 1fr;gap:24px
}
@media(max-width:900px){.container{grid-template-columns:1fr}}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:24px;padding:28px;
  box-shadow:0 25px 50px rgba(0,0,0,.5)
}
h1,h2{margin:0 0 6px}
p{margin:0;color:#94a3b8;font-size:14px}
#timer{
  font-size:42px;font-weight:800;
  color:var(--primary);text-align:center;margin:16px 0
}
#status{text-align:center;font-size:14px;color:#94a3b8;margin-bottom:20px}
input[type=file]{
  width:100%;padding:14px;border-radius:12px;
  background:transparent;color:#fff;
  border:2px dashed var(--border)
}
button{
  width:100%;padding:16px;border-radius:14px;
  font-size:16px;font-weight:700;border:none;cursor:pointer
}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--bad);color:#fff}
button:disabled{opacity:.4}
.log{max-height:460px;overflow-y:auto}
.msg{
  margin-bottom:14px;padding:12px 16px;border-radius:12px
}
.msg.user{background:rgba(103,232,249,.1);border-left:3px solid #67e8f9}
.msg.ai{background:rgba(165,180,252,.1);border-left:3px solid #a5b4fc}
.vosk{
  margin-top:16px;padding:12px 16px;
  border-radius:12px;border:1px solid var(--border);
  background:rgba(255,255,255,.03);font-size:13px
}
.ok{color:var(--ok)}
</style>
</head>

<body>

<button class="back-btn" id="backBtn">← Back</button>

<div class="container">

<div class="card">
  <h1>Evalis AI Interview</h1>
  <p>Vosk powered live interview</p>

  <div id="timer">15:00</div>
  <div id="status">Upload resume to begin</div>

  <input type="file" id="cvInput" accept=".pdf"><br><br>

  <button id="startBtn" class="btn-primary" disabled>Start Interview</button>
  <button id="endBtn" class="btn-danger" style="display:none">End Interview</button>

  <div class="vosk" id="voskBox" style="display:none">
    <div>Vosk Engine: <span class="ok">Active</span></div>
    <div>Microphone: <span class="ok">Connected</span></div>
    <div>Mode: Continuous</div>
  </div>
</div>

<div class="card">
  <h2>Conversation</h2>
  <p>Live transcript</p>
  <div class="log" id="log"></div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

/* ================= STATE ================= */
let cvText = "";
let history = [];
let interviewActive = false;
let isAISpeaking = false;
let isProcessing = false;
let timeLeft = 15 * 60;
let timerInt = null;
let voices = []; // Store voices here

/* ================= PDF ================= */
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const cvInput = document.getElementById('cvInput');
const startBtn = document.getElementById('startBtn');
const endBtn = document.getElementById('endBtn');
const status = document.getElementById('status');
const timer = document.getElementById('timer');
const voskBox = document.getElementById('voskBox');
const backBtn = document.getElementById('backBtn');

cvInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  status.textContent = "Reading resume...";
  startBtn.disabled = true;

  const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
  let text = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(i => i.str).join(" ") + " ";
  }

  cvText = text.trim() || "[Resume uploaded]";
  startBtn.disabled = false;
  status.textContent = "Resume ready ✓";
};

/* ================= TIMER ================= */
function startTimer() {
  timerInt = setInterval(() => {
    timeLeft--;
    timer.textContent =
      `${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,"0")}`;
    if (timeLeft <= 0) finishInterview();
  }, 1000);
}

/* ================= VOICE LOADER (NEW) ================= */
// Android needs to be forced to load voices
function loadVoices() {
  voices = window.speechSynthesis.getVoices();
  console.log("Voices loaded:", voices.length);
}
// Try loading immediately and on change
if ('speechSynthesis' in window) {
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
}

/* ================= SPEECH (WITH VOICE SELECTION) ================= */
function speak(text) {
  return new Promise(res => {
    isAISpeaking = true;
    
    // Check if voices are loaded, if not try one last time
    if (voices.length === 0) loadVoices();
    
    // Visual feedback
    status.textContent = "AI Speaking..."; 
    addMsg("ai", text);

    if (!window.speechSynthesis) {
      console.warn("No TTS support");
      setTimeout(() => endSpeak(res), 2000);
      return;
    }

    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1.0;
    u.volume = 1.0; // Force max volume

    // --- CRITICAL: VOICE SELECTION ---
    // Try to find an English voice. Android often defaults to silent if not picked.
    const englishVoice = voices.find(v => v.lang.includes('en-US') || v.lang.includes('en_US')) 
                      || voices.find(v => v.lang.includes('en'))
                      || voices[0];
    
    if (englishVoice) {
        u.voice = englishVoice;
        console.log("Selected voice:", englishVoice.name);
    } else {
        console.warn("No specific voice found, using default");
        // Status warning if phone has no voices
        if(voices.length === 0) status.textContent = "⚠️ No TTS Voices Found on Phone";
    }
    // ----------------------------------

    // Safety Timeout
    const safetyDuration = (text.length * 80) + 3000;
    const safetyTimer = setTimeout(() => {
      if (isAISpeaking) {
        console.warn("TTS timed out. Resetting.");
        speechSynthesis.cancel();
        endSpeak(res);
      }
    }, safetyDuration);

    u.onend = () => { clearTimeout(safetyTimer); endSpeak(res); };
    u.onerror = (e) => { console.error("TTS Error", e); clearTimeout(safetyTimer); endSpeak(res); };

    try {
      speechSynthesis.cancel(); // Clear any stuck audio first
      speechSynthesis.speak(u);
    } catch (e) {
      console.error("TTS Crash", e);
      clearTimeout(safetyTimer);
      endSpeak(res);
    }
  });
}

function endSpeak(resCallback) {
    isAISpeaking = false;
    status.textContent = "Listening...";
    resCallback();
}

/* ================= API ================= */
async function callAPI(mode, extra = {}) {
  const fd = new FormData();
  fd.append("mode", mode);
  if (extra.text) fd.append("text", extra.text);
  if (extra.cvText) fd.append("cvText", extra.cvText);
  if (extra.history) fd.append("history", JSON.stringify(extra.history));

  const res = await fetch(API, { method: "POST", body: fd });
  if (!res.ok) throw new Error("API failed");
  return await res.json();
}

/* ================= ANDROID BRIDGE ================= */
window.receiveVoskText = text => {
  // Debug log
  console.log("Vosk Input:", text);

  if (isAISpeaking || !interviewActive || isProcessing) return;
  if (!text || text.length < 2) return;
  
  processUser(text);
};

/* ================= USER ================= */
async function processUser(text) {
  isProcessing = true;
  status.textContent = "Thinking...";
  addMsg("user", text);

  try {
    const data = await callAPI("interview", {
      text,
      cvText,
      history
    });
    history = data.history || history;
    await speak(data.reply);
  } catch {
    await speak("Can you explain that further?");
  }

  isProcessing = false;
}

/* ================= START ================= */
startBtn.onclick = async () => {
  if (!cvText) return;

  interviewActive = true;
  startTimer();

  cvInput.style.display = "none";
  startBtn.style.display = "none";
  endBtn.style.display = "block";
  voskBox.style.display = "block";

  status.textContent = "Starting interview...";

  // Attempt to "prime" the audio engine
  if(window.speechSynthesis) {
      loadVoices();
      speechSynthesis.cancel();
  }

  try {
    const data = await callAPI("start", { cvText });
    history = data.history || [];
    await speak(data.reply || "Tell me about yourself.");
  } catch {
    await speak("Tell me about yourself.");
  }
};

/* ================= END ================= */
endBtn.onclick = () => confirm("End interview?") && finishInterview();

async function finishInterview() {
  interviewActive = false;
  clearInterval(timerInt);
  if(window.speechSynthesis) speechSynthesis.cancel();

  status.textContent = "Generating report...";

  try {
    const data = await callAPI("score", {
      history,
      cvText
    });

    document.body.innerHTML = `
      <div class="card" style="max-width:800px; margin: 20px auto;">
        <h1>Interview Complete</h1>
        <pre style="white-space:pre-wrap; font-family: inherit;">${data.reply || "Report unavailable"}</pre>
        <br>
        <button class="btn-primary" onclick="location.reload()">New Interview</button>
      </div>`;
  } catch (e) {
      status.textContent = "Error generating report.";
  }
}

/* ================= UI ================= */
const logBox = document.getElementById("log");

function addMsg(role, text) {
  const d = document.createElement("div");
  d.className = "msg " + role;
  d.innerHTML = `<b>${role === "ai" ? "AI" : "You"}:</b> ${text}`;
  logBox.appendChild(d);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= NAV ================= */
backBtn.onclick = () => location.href = "career-lab.html";
history.pushState(null, "", location.href);
window.onpopstate = () => backBtn.click();
</script>

</body>
</html>
