<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Evalis AI Interviewer</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  background:#0f172a;
  color:white;
  font-family:sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  margin:0;
}
.card {
  width:420px;
  background:#1e293b;
  padding:25px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
}
button {
  width:100%;
  padding:15px;
  border:none;
  border-radius:12px;
  background:#4f46e5;
  color:white;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
button:disabled {
  opacity:.5;
  cursor:not-allowed;
}
#log {
  margin-top:20px;
  background:#020617;
  padding:15px;
  height:200px;
  overflow-y:auto;
  border-radius:12px;
  font-size:14px;
  border:1px solid #334155;
}
.ai { color:#a5b4fc; margin-bottom:10px; }
.user { color:#94a3b8; font-style:italic; margin-bottom:10px; }
#status {
  text-align:center;
  font-size:13px;
  color:#94a3b8;
  margin-bottom:10px;
}
</style>
</head>

<body>
<div class="card">
  <h3>Evalis AI Interview</h3>
  <div id="status">Upload PDF Resume to Start</div>

  <input type="file" id="cvInput" accept=".pdf">
  <button id="startBtn" disabled>Start Interview</button>
  <button id="scoreBtn" style="display:none;background:#ef4444;">Finish & Get Score</button>

  <div id="log"></div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ================= STATE ================= */
let cvText = "";
let history = [];
let active = false;
let recording = false;

/* ================= UI LOG ================= */
function log(cls, text) {
  const d = document.createElement("div");
  d.className = cls;
  d.textContent = text;
  const box = document.getElementById("log");
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

/* ================= PDF ================= */
document.getElementById("cvInput").onchange = async e => {
  const file = e.target.files[0];
  const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
  let text = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(x => x.str).join(" ") + " ";
  }

  cvText = text.trim();
  document.getElementById("status").innerText = "Resume Loaded";
  document.getElementById("startBtn").disabled = false;
};

/* ================= SPEAK ================= */
function speak(text) {
  if (!text) return;

  log("ai", "AI: " + text);
  speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.onend = () => active && listen();
  speechSynthesis.speak(u);
}

/* ================= LISTEN (SAFE) ================= */
async function listen() {
  if (!active || recording) return;
  recording = true;

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch {
    recording = false;
    document.getElementById("status").innerText = "Microphone permission denied";
    return;
  }

  const recorder = new MediaRecorder(stream);
  const chunks = [];

  document.getElementById("status").innerText = "Listeningâ€¦";

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = async () => {
    stream.getTracks().forEach(t => t.stop());
    recording = false;

    const blob = new Blob(chunks, { type:"audio/webm" });

    /* ðŸ”’ HARD SILENCE GUARD */
    if (blob.size < 8000) {
      console.warn("Silent audio ignored");
      listen();
      return;
    }

    document.getElementById("status").innerText = "Thinkingâ€¦";

    const fd = new FormData();
    fd.append("mode", "interview");
    fd.append("audio", blob);
    fd.append("cvText", cvText);
    fd.append("history", JSON.stringify(history));

    try {
      const res = await fetch(WORKER_URL, { method:"POST", body:fd });
      const data = await res.json();

      if (data.transcript) log("user", "You: " + data.transcript);
      history = data.history || history;

      speak(data.reply);
    } catch {
      speak("I couldnâ€™t hear that clearly. Please repeat.");
    }
  };

  recorder.start();
  setTimeout(() => recorder.state === "recording" && recorder.stop(), 7000);
}

/* ================= START ================= */
document.getElementById("startBtn").onclick = async () => {
  active = true;
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("scoreBtn").style.display = "block";
  document.getElementById("status").innerText = "Analyzing CVâ€¦";

  const fd = new FormData();
  fd.append("mode", "start");
  fd.append("cvText", cvText);

  const res = await fetch(WORKER_URL, { method:"POST", body:fd });
  const data = await res.json();

  history = data.history || [];
  speak(data.reply);
};

/* ================= SCORE ================= */
document.getElementById("scoreBtn").onclick = async () => {
  active = false;
  speechSynthesis.cancel();
  document.getElementById("status").innerText = "Generating final scoreâ€¦";

  const fd = new FormData();
  fd.append("mode", "score");
  fd.append("history", JSON.stringify(history));

  const res = await fetch(WORKER_URL, { method:"POST", body:fd });
  const data = await res.json();

  log("ai", "FINAL REPORT: " + data.reply);
};
</script>
</body>
</html>
