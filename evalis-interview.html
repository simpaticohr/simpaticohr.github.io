<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Evalis AI â€“ Voice Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  background:#020617;
  color:white;
  font-family:system-ui;
  padding:20px;
}
button {
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:12px;
  font-size:16px;
  background:#6366f1;
  color:white;
}
#log div { margin-top:10px }
</style>
</head>

<body>

<h2>Evalis AI â€“ Live Interview</h2>
<p id="status">Upload resume</p>

<input type="file" id="cvInput" accept="application/pdf">
<button id="startBtn" disabled>Start Interview</button>
<button id="micBtn" disabled>ðŸŽ¤ Speak</button>
<button id="voiceBtn" disabled>ðŸ”Š Hear AI</button>

<div id="log"></div>

<script>
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let cvText="", history=[], lastAI="";

/* ---------- PDF ---------- */
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

cvInput.onchange = async e => {
  const pdf = await pdfjsLib.getDocument({
    data: await e.target.files[0].arrayBuffer(),
    disableWorker:true
  }).promise;
  let t="";
  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const c=await p.getTextContent();
    t+=c.items.map(x=>x.str).join(" ");
  }
  cvText=t;
  startBtn.disabled=false;
  status.innerText="Resume loaded âœ“";
};

/* ---------- UI ---------- */
function add(w,t){
  const d=document.createElement("div");
  d.innerHTML=`<b>${w}:</b> ${t}`;
  log.appendChild(d);
}

/* ---------- SPEAK ---------- */
function speak(text){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang="en-US";
  speechSynthesis.speak(u);
}

/* ---------- MIC ---------- */
function listen(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Mic not supported"); return; }
  const r=new SR();
  r.lang="en-US";
  r.onresult=async e=>{
    const text=e.results[0][0].transcript;
    add("You",text);

    const fd=new FormData();
    fd.append("mode","interview");
    fd.append("text",text);
    fd.append("history",JSON.stringify(history));
    fd.append("cvText",cvText);

    const res=await fetch(API,{method:"POST",body:fd});
    const d=await res.json();
    history=d.history;
    lastAI=d.reply;
    add("AI",lastAI);
    voiceBtn.disabled=false;
  };
  r.start();
}

/* ---------- START ---------- */
startBtn.onclick=async()=>{
  const fd=new FormData();
  fd.append("mode","start");
  fd.append("cvText",cvText);

  const r=await fetch(API,{method:"POST",body:fd});
  const d=await r.json();
  history=d.history;
  lastAI=d.reply;

  add("AI",lastAI);
  micBtn.disabled=false;
  voiceBtn.disabled=false;
};

micBtn.onclick=listen;
voiceBtn.onclick=()=>speak(lastAI);
</script>

</body>
</html>
