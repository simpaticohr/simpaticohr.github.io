<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Career Lab AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root { --accent: #2563eb; --bg: #0f172a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; display: flex; justify-content: center; padding: 20px; }
        .card { width: 100%; max-width: 440px; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .pulse { width: 60px; height: 60px; background: var(--accent); border-radius: 50%; margin: 20px auto; display: none; animation: pulse-ring 1.2s infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(37, 99, 235, 0); } }
        button { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #log { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; height: 200px; overflow-y: auto; font-size: 14px; text-align: left; margin-top: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .err { color: #f87171; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>Career Lab AI</h2>
    <p id="status">Upload CV to Start</p>
    <input type="file" id="cvInput" accept=".pdf,.txt" style="margin-bottom: 20px; width: 100%;">
    <div id="micVisual" class="pulse"></div>
    <button id="mainBtn" disabled>Start Interview</button>
    <div id="log">Welcome. Please upload your resume.</div>
</div>

<script>
    const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
    let history = [], cvText = "", active = false, busy = false;
    const synth = window.speechSynthesis;

    // 1. FIXED CV PARSING
    document.getElementById('cvInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('status').innerText = "Processing CV...";
        try {
            if (file.type === "application/pdf") {
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const loadingTask = pdfjsLib.getDocument(new Uint8Array(await file.arrayBuffer()));
                const pdf = await loadingTask.promise;
                let text = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join(" ") + " ";
                }
                cvText = text;
            } else { cvText = await file.text(); }
            document.getElementById('status').innerText = "CV Ready";
            document.getElementById('mainBtn').disabled = false;
        } catch (err) { document.getElementById('status').innerText = "Error reading PDF"; }
    };

    // 2. FIXED AI SPEECH (Handles "undefined" and locks turns)
    function speak(text) {
        if (!text || text === "undefined") {
            busy = false;
            return;
        }
        const log = document.getElementById('log');
        log.innerHTML += `<p><b>AI:</b> ${text}</p>`;
        log.scrollTop = log.scrollHeight;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.onend = () => {
            busy = false;
            if (active) setTimeout(startTurn, 500);
        };
        synth.cancel();
        synth.speak(utterance);
    }

    // 3. FIXED AUDIO HANDLING (Prevents 5006 Error)
    async function startTurn() {
        if (busy || !active) return;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const recorder = new MediaRecorder(stream);
            const chunks = [];

            document.getElementById('micVisual').style.display = "block";
            document.getElementById('status').innerText = "Listening...";

            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = async () => {
                document.getElementById('micVisual').style.display = "none";
                stream.getTracks().forEach(t => t.stop());

                if (chunks.length === 0) {
                    busy = false;
                    if (active) startTurn();
                    return;
                }

                busy = true;
                document.getElementById('status').innerText = "Analyzing...";

                const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append("audio", audioBlob, "user_voice.webm"); // Added filename for better Worker parsing
                formData.append("mode", "interview");
                formData.append("cvText", cvText);
                formData.append("history", JSON.stringify(history));

                try {
                    const res = await fetch(WORKER_URL, { method: "POST", body: formData });
                    const data = await res.json();
                    
                    if (data.reply) {
                        history = data.history || history;
                        speak(data.reply);
                    } else if (data.error) {
                        document.getElementById('log').innerHTML += `<p class="err">System Error: ${data.error}</p>`;
                        busy = false;
                    }
                } catch (err) {
                    document.getElementById('status').innerText = "Connection lost. Retrying...";
                    busy = false;
                    setTimeout(startTurn, 3000);
                }
            };

            recorder.start();
            setTimeout(() => { if (recorder.state === "recording") recorder.stop(); }, 6000);
        } catch (e) { document.getElementById('status').innerText = "Mic Access Denied"; }
    }

    // 4. BUTTON CONTROL
    document.getElementById('mainBtn').onclick = () => {
        const btn = document.getElementById('mainBtn');
        if (!active) {
            active = true;
            btn.innerText = "Stop Interview";
            btn.style.background = "#dc2626";
            speak("I have reviewed your resume. Let's begin. Can you introduce yourself?");
        } else {
            active = false;
            synth.cancel();
            location.reload(); 
        }
    };
</script>

</body>
</html>
