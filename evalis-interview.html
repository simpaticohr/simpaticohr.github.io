<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform</title>

  <!-- ‚òÖ PDF.js ‚Äî Load FIRST -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --bg: #0a0e1a;
      --card: #111827;
      --border: #1e293b;
      --accent: #3b82f6;
      --accent2: #8b5cf6;
      --green: #10b981;
      --red: #ef4444;
      --yellow: #f59e0b;
      --text: #e2e8f0;
      --text2: #94a3b8;
      --glow: rgba(59,130,246,0.3);
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle at 30% 40%, rgba(59,130,246,0.05) 0%, transparent 50%),
                  radial-gradient(circle at 70% 60%, rgba(139,92,246,0.05) 0%, transparent 50%);
      animation: bgShift 20s ease-in-out infinite;
      z-index: 0;
    }
    @keyframes bgShift {
      0%, 100% { transform: translate(0,0); }
      50% { transform: translate(-5%,-5%); }
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* ‚òÖ Header */
    .header {
      text-align: center;
      padding: 30px 0 20px;
    }
    .header h1 {
      font-size: 2rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 6px;
    }
    .header p { color: var(--text2); font-size: 0.9rem; }

    /* ‚òÖ Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    .card:hover {
      border-color: rgba(59,130,246,0.3);
      box-shadow: 0 0 20px rgba(59,130,246,0.08);
    }
    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚òÖ Form */
    label {
      display: block;
      font-size: 0.85rem;
      color: var(--text2);
      margin-bottom: 6px;
      margin-top: 12px;
    }
    label:first-child { margin-top: 0; }

    select, input[type="text"] {
      width: 100%;
      padding: 10px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.3s;
    }
    select:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow);
    }
    select option { background: var(--card); }

    /* ‚òÖ Upload */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 12px;
    }
    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(59,130,246,0.05);
    }
    .upload-area.ok {
      border-color: var(--green);
      background: rgba(16,185,129,0.05);
    }
    .upload-area label {
      display: inline; cursor: pointer;
      color: var(--accent); font-size: 0.95rem;
    }
    #fName {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text2);
    }

    /* ‚òÖ Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 28px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #fff;
      font-family: inherit;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      width: 100%;
      margin-top: 20px;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59,130,246,0.3);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ‚òÖ Model badge */
    .model-badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 10px;
      border-radius: 20px;
      background: rgba(139,92,246,0.15);
      color: var(--accent2);
      margin-top: 8px;
    }

    /* ‚òÖ Progress */
    .progress-wrap {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      height: 8px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 20px;
      transition: width 0.5s ease;
      width: 0%;
    }
    .progress-text {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text2);
      margin-bottom: 16px;
    }

    /* ‚òÖ Screens */
    #interviewScreen { display: none; }
    #resultScreen { display: none; }

    /* ‚òÖ Question box */
    .question-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1));
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 20px;
      font-size: 1.1rem;
      line-height: 1.6;
      min-height: 80px;
    }

    /* ‚òÖ Waveform */
    .wave-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      height: 50px;
      margin: 16px 0;
    }
    .wave-bar {
      width: 4px; height: 8px;
      background: var(--accent);
      border-radius: 4px;
    }
    .wave-wrap.active .wave-bar {
      animation: wave 0.8s ease-in-out infinite alternate;
    }
    .wave-bar:nth-child(1) { animation-delay: 0s; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    .wave-bar:nth-child(6) { animation-delay: 0.3s; }
    .wave-bar:nth-child(7) { animation-delay: 0.2s; }
    .wave-bar:nth-child(8) { animation-delay: 0.1s; }
    .wave-bar:nth-child(9) { animation-delay: 0s; }
    @keyframes wave {
      from { height: 8px; }
      to { height: 40px; }
    }

    /* ‚òÖ Mic button */
    .mic-btn {
      width: 72px; height: 72px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-size: 1.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      transition: all 0.3s;
    }
    .mic-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 30px var(--glow);
    }
    .mic-btn.recording {
      background: linear-gradient(135deg, var(--red), #dc2626);
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 15px rgba(239,68,68,0); }
    }

    .mic-label {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text2);
      margin-top: 10px;
    }

    .timer {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--text);
      margin: 10px 0;
    }

    /* ‚òÖ Controls */
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .controls .btn {
      flex: 1;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-radius: 10px;
    }
    .btn-skip { background: rgba(255,255,255,0.08); }
    .btn-skip:hover { background: rgba(255,255,255,0.15); }
    .btn-submit { background: var(--green); }
    .btn-submit:hover { background: #059669; }
    .btn-repeat { background: rgba(139,92,246,0.2); color: var(--accent2); }
    .btn-repeat:hover { background: rgba(139,92,246,0.3); }
    .btn-end { background: rgba(239,68,68,0.2); color: var(--red); }
    .btn-end:hover { background: rgba(239,68,68,0.3); }

    /* ‚òÖ Status */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text2);
      margin-bottom: 12px;
    }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: blink 2s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity:1; }
      50% { opacity:0.3; }
    }

    /* ‚òÖ Thinking */
    .thinking {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text2);
      font-size: 0.9rem;
      margin: 12px 0;
    }
    .thinking-dots span {
      display: inline-block;
      width: 6px; height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: dot 1.2s infinite;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot {
      0%, 100% { opacity: 0.3; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    /* ‚òÖ Results */
    .score-circle {
      width: 160px; height: 160px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }
    .score-inner { text-align: center; }
    .score-num {
      font-size: 2.5rem;
      font-weight: 800;
    }
    .score-max {
      font-size: 0.9rem;
      color: var(--text2);
    }
    .grade-badge {
      display: inline-block;
      padding: 6px 20px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .fb-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .fb-item .fb-q {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--accent);
    }
    .fb-item .fb-score {
      font-size: 0.8rem;
      padding: 2px 10px;
      border-radius: 10px;
      display: inline-block;
      margin-bottom: 8px;
    }
    .fb-item .fb-text {
      font-size: 0.9rem;
      color: var(--text2);
      line-height: 1.5;
    }

    /* ‚òÖ Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 0.9rem;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity:0; }
      to { transform: translateX(0); opacity:1; }
    }
    @keyframes fadeOut {
      from { opacity:1; }
      to { opacity:0; }
    }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      .container { padding: 12px; }
      .header h1 { font-size: 1.5rem; }
      .card { padding: 16px; }
      .question-box { font-size: 1rem; }
      .mic-btn { width: 64px; height: 64px; font-size: 1.5rem; }
      .controls { flex-wrap: wrap; }
      .controls .btn { flex: 1 1 45%; }
    }
  </style>
</head>

<body>
  <div class="toast-container" id="toastBox"></div>

  <div class="container">
    <!-- ‚òÖ HEADER -->
    <div class="header">
      <h1>üß† AI Interview</h1>
      <p>Intelligent adaptive interviews ‚Ä¢ Powered by Llama 3.3 70B</p>
    </div>

    <!-- ============================================================
         ‚òÖ SETUP SCREEN ‚Äî No API key!
         ============================================================ -->
    <div id="setupScreen">
      <div class="card">
        <h2>‚öôÔ∏è Interview Setup</h2>

        <label for="langSel">üåê Language</label>
        <select id="langSel">
          <option value="en">English</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
          <option value="es">Espa√±ol (Spanish)</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
          <option value="fr">Fran√ßais (French)</option>
          <option value="de">Deutsch (German)</option>
          <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
        </select>

        <label for="roleSel">üíº Job Role</label>
        <select id="roleSel">
          <option value="">‚Äî Select Role ‚Äî</option>
          <option value="Frontend Developer">Frontend Developer</option>
          <option value="Backend Developer">Backend Developer</option>
          <option value="Full Stack Developer">Full Stack Developer</option>
          <option value="Mobile Developer">Mobile Developer</option>
          <option value="Data Scientist">Data Scientist / Analyst</option>
          <option value="DevOps Engineer">DevOps / Cloud Engineer</option>
          <option value="UI/UX Designer">UI/UX Designer</option>
          <option value="Product Manager">Product Manager</option>
          <option value="QA Engineer">QA / Test Engineer</option>
          <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
          <option value="Sales Representative">Sales / BDR</option>
          <option value="Marketing Manager">Marketing Manager</option>
          <option value="HR Recruiter">HR / Recruiter</option>
          <option value="Finance Analyst">Finance / Accounting</option>
          <option value="Customer Support">Customer Support</option>
          <option value="custom">‚úèÔ∏è Custom Role...</option>
        </select>

        <div id="customRoleWrap" class="hidden">
          <label for="customRole">Enter Role</label>
          <input type="text" id="customRole" placeholder="e.g. Blockchain Developer">
        </div>

        <label for="levelSel">üìä Experience Level</label>
        <select id="levelSel">
          <option value="fresher">Fresher / Entry Level</option>
          <option value="junior">Junior (1-2 years)</option>
          <option value="mid" selected>Mid-Level (3-5 years)</option>
          <option value="senior">Senior (5-10 years)</option>
          <option value="lead">Lead / Principal (10+)</option>
        </select>

        <label for="qCount">üî¢ Number of Questions</label>
        <select id="qCount">
          <option value="5">5 Questions (~10 min)</option>
          <option value="8">8 Questions (~15 min)</option>
          <option value="10" selected>10 Questions (~20 min)</option>
          <option value="15">15 Questions (~30 min)</option>
        </select>
      </div>

      <!-- CV Upload -->
      <div class="card">
        <h2>üìÑ Resume (Optional)</h2>
        <div id="upArea" class="upload-area" onclick="document.getElementById('cvF').click()">
          <label for="cvF">üìÇ Click to upload PDF, DOC, DOCX, or TXT</label>
          <input type="file" id="cvF" accept=".pdf,.doc,.docx,.txt" hidden>
          <p id="fName">No file selected</p>
        </div>
      </div>

      <button class="btn btn-primary" id="startBtn" onclick="startInterview()">
        üöÄ Start Interview
      </button>
    </div>

    <!-- ============================================================
         ‚òÖ INTERVIEW SCREEN
         ============================================================ -->
    <div id="interviewScreen">
      <div class="card">
        <div class="progress-wrap"><div class="progress-fill" id="progBar"></div></div>
        <div class="progress-text" id="progText">Question 1 / 10</div>

        <div class="status-bar">
          <div class="status-dot"></div>
          <span id="statusLabel">AI Interview Active</span>
          <span class="model-badge" id="modelBadge">üß† Llama 3.3 70B</span>
        </div>

        <!-- Question -->
        <div class="question-box" id="questionBox">
          Preparing your first question...
        </div>

        <!-- Thinking -->
        <div class="thinking hidden" id="thinkingBox">
          <div class="thinking-dots"><span></span><span></span><span></span></div>
          <span>AI is analyzing...</span>
        </div>

        <!-- Waveform -->
        <div class="wave-wrap" id="waveWrap">
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div><div class="wave-bar"></div>
          <div class="wave-bar"></div>
        </div>

        <!-- Timer -->
        <div class="timer" id="timer">00:00</div>

        <!-- Mic -->
        <button class="mic-btn" id="micBtn" onclick="toggleMic()">üé§</button>
        <div class="mic-label" id="micLabel">Tap to start speaking</div>

        <!-- Controls -->
        <div class="controls">
          <button class="btn btn-repeat" onclick="repeatQuestion()">üîÅ Repeat</button>
          <button class="btn btn-skip" onclick="skipQuestion()">‚è≠ Skip</button>
          <button class="btn btn-submit" onclick="submitAnswer()">‚úÖ Submit</button>
        </div>
        <div class="controls" style="margin-top:8px;">
          <button class="btn btn-end" onclick="endEarly()" style="width:100%;">‚èπ End Interview Early</button>
        </div>
      </div>
    </div>

    <!-- ============================================================
         ‚òÖ RESULT SCREEN
         ============================================================ -->
    <div id="resultScreen">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">üèÜ Interview Complete!</h2>
        <div class="score-circle" id="scoreCircle">
          <div class="score-inner">
            <div class="score-num" id="scoreNum">0</div>
            <div class="score-max">/ 100</div>
          </div>
        </div>
        <div id="gradeBadge" class="grade-badge">‚Äî</div>
        <p id="scoreSummary" style="color:var(--text2);margin-bottom:20px;line-height:1.6;"></p>
      </div>

      <div class="card">
        <h2>üìù Detailed Feedback</h2>
        <div id="feedbackList"></div>
      </div>

      <button class="btn btn-primary" onclick="location.reload()">üîÑ Start New Interview</button>
    </div>
  </div>

  <!-- ============================================================
       ‚òÖ JAVASCRIPT
       ============================================================ -->
  <script>
    // ‚òÖ‚òÖ‚òÖ CHANGE THIS TO YOUR CLOUDFLARE WORKER URL ‚òÖ‚òÖ‚òÖ
    const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev/";

    // ‚òÖ State
    let cv = "";
    let lang = "en";
    let role = "";
    let level = "";
    let totalQ = 10;
    let currentQ = 0;
    let chatMessages = []; // Llama message format
    let answers = [];
    let isRecording = false;
    let recognition = null;
    let currentTranscript = "";
    let timerInterval = null;
    let seconds = 0;

    const langMap = {
      en: { speech: "en-US", tts: "en-US", name: "English" },
      hi: { speech: "hi-IN", tts: "hi-IN", name: "Hindi" },
      es: { speech: "es-ES", tts: "es-ES", name: "Spanish" },
      ar: { speech: "ar-SA", tts: "ar-SA", name: "Arabic" },
      fr: { speech: "fr-FR", tts: "fr-FR", name: "French" },
      de: { speech: "de-DE", tts: "de-DE", name: "German" },
      ur: { speech: "ur-PK", tts: "ur-PK", name: "Urdu" }
    };

    // ‚òÖ Toast
    function toast(msg) {
      const box = document.getElementById("toastBox");
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      box.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // ‚òÖ Custom role toggle
    document.getElementById("roleSel").addEventListener("change", e => {
      document.getElementById("customRoleWrap").classList.toggle("hidden", e.target.value !== "custom");
    });

    // ============================================================
    // ‚òÖ CV UPLOAD
    // ============================================================
    document.getElementById("cvF").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById("fName").textContent = "‚è≥ Processing " + file.name + "...";
      document.getElementById("upArea").classList.remove("ok");

      try {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'txt') cv = await file.text();
        else if (ext === 'pdf') cv = await extractPDF(file);
        else if (ext === 'doc' || ext === 'docx') cv = await extractDOC(file);
        else cv = await file.text();

        cv = cv.replace(/\s+/g, ' ').replace(/[^\x20-\x7E\n]/g, '').trim().substring(0, 5000);

        if (cv.length < 30) {
          document.getElementById("fName").textContent = "‚ö†Ô∏è Could not extract text ‚Äî try TXT";
          toast("‚ö†Ô∏è Extraction failed. Try .txt format.");
          cv = "";
          return;
        }
        document.getElementById("fName").textContent = "‚úÖ " + file.name + ` (${cv.length} chars)`;
        document.getElementById("upArea").classList.add("ok");
        toast("‚úÖ Resume loaded!");
      } catch(err) {
        console.error("[CV]", err);
        document.getElementById("fName").textContent = "‚ùå Error reading file";
        toast("‚ùå Error. Try .txt format.");
        cv = "";
      }
    });

    async function extractPDF(file) {
      if (!window.pdfjsLib) return extractFallback(file);
      try {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let t = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const pg = await pdf.getPage(i);
          const c = await pg.getTextContent();
          t += c.items.map(x => x.str).join(' ') + "\n";
        }
        return t;
      } catch(e) { return extractFallback(file); }
    }

    async function extractDOC(file) {
      const buf = await file.arrayBuffer();
      if (file.name.endsWith('.docx')) {
        try {
          const t = new TextDecoder('utf-8').decode(new Uint8Array(buf));
          const m = t.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);
          if (m && m.length) return m.map(x => x.replace(/<[^>]+>/g, '')).join(' ');
        } catch(e) {}
      }
      return extractFallback(file);
    }

    async function extractFallback(file) {
      const buf = await file.arrayBuffer();
      const t = new TextDecoder('utf-8', { fatal: false }).decode(buf);
      const r = t.match(/[a-zA-Z0-9@.,:;!?\-/()\s]{5,}/g);
      if (!r) return "";
      return r.filter(s => {
        const ratio = (s.match(/[a-zA-Z]/g) || []).length / s.length;
        return ratio > 0.5 && s.trim().length > 5;
      }).join(' ');
    }

    // ============================================================
    // ‚òÖ CLOUDFLARE WORKERS AI ‚Äî API CALL
    // ============================================================
    async function callAI(messages) {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      if (!res.ok) {
        const err = await res.text();
        throw new Error(`API ${res.status}: ${err}`);
      }

      const data = await res.json();

      // Update model badge
      const badge = document.getElementById("modelBadge");
      if (badge) {
        if (data.model && data.model.includes("70b")) {
          badge.textContent = "üß† Llama 3.3 70B";
          badge.style.background = "rgba(16,185,129,0.15)";
          badge.style.color = "#10b981";
        } else {
          badge.textContent = "‚ö° Llama 3.1 8B (fallback)";
          badge.style.background = "rgba(245,158,11,0.15)";
          badge.style.color = "#f59e0b";
        }
      }

      return data.response || "";
    }

    // ============================================================
    // ‚òÖ START INTERVIEW
    // ============================================================
    async function startInterview() {
      const roleSel = document.getElementById("roleSel").value;
      if (!roleSel) { toast("‚ùå Please select a job role"); return; }

      role = roleSel === "custom" ? document.getElementById("customRole").value.trim() : roleSel;
      if (!role) { toast("‚ùå Please enter a custom role"); return; }

      lang = document.getElementById("langSel").value;
      level = document.getElementById("levelSel").value;
      totalQ = parseInt(document.getElementById("qCount").value);

      const btn = document.getElementById("startBtn");
      btn.disabled = true;
      btn.textContent = "‚è≥ Starting...";

      // Build system prompt
      const systemPrompt = `You are an expert AI interviewer. You are conducting a professional ${level}-level interview for the role of "${role}".

LANGUAGE: Respond ONLY in ${langMap[lang].name}. Every question and follow-up must be in ${langMap[lang].name}.

${cv ? `CANDIDATE RESUME:\n${cv}\n` : "No resume provided."}

INTERVIEW RULES:
1. Ask exactly ${totalQ} main questions. Mix behavioral, technical, and situational.
2. After each answer, use the C.L.A.I.M. follow-up framework to decide:
   - If the answer is vague/has unverified claims ‚Üí ask a targeted follow-up probing:
     * Claims (verify what they did)
     * Learning (what they learned)
     * Alternatives (other approaches)
     * Impact (metrics/results)
     * Mechanism (exact steps/process)
   - If the answer is thorough and complete ‚Üí move to the next main question
3. Follow-ups do NOT count toward the ${totalQ} question total.
4. Be conversational, warm but professional.
5. Adapt difficulty to ${level} level.
6. NEVER repeat a similar question.

Start now. Ask your FIRST interview question. Output ONLY the question, nothing else.`;

      chatMessages = [
        { role: "system", content: systemPrompt }
      ];

      try {
        // Switch screen immediately
        document.getElementById("setupScreen").style.display = "none";
        document.getElementById("interviewScreen").style.display = "block";
        showThinking(true);

        const firstQ = await callAI(chatMessages);
        chatMessages.push({ role: "assistant", content: firstQ });

        showThinking(false);
        document.getElementById("questionBox").textContent = firstQ;
        updateProgress();
        speakText(firstQ);
        initSpeechRecognition();
        toast("üéØ Interview started! Good luck!");

      } catch(err) {
        console.error("[START]", err);
        toast("‚ùå Error: " + err.message);
        document.getElementById("setupScreen").style.display = "block";
        document.getElementById("interviewScreen").style.display = "none";
        btn.disabled = false;
        btn.textContent = "üöÄ Start Interview";
      }
    }

    // ============================================================
    // ‚òÖ GET NEXT QUESTION / FOLLOW-UP
    // ============================================================
    async function getNextResponse(answerText) {
      showThinking(true);

      const prompt = `The candidate answered: "${answerText}"

This was their answer to question ${currentQ} of ${totalQ}.

Based on their answer, decide:
1. If their answer was vague, surface-level, or made unverified claims ‚Üí ask a C.L.A.I.M. FOLLOW-UP question (probe deeper). Prefix with [FOLLOWUP]
2. If their answer was detailed and thorough ‚Üí ask the NEXT main interview question. Prefix with [NEXT]

Rules:
- Output ONLY the prefix tag and the question
- Stay in ${langMap[lang].name}
- Be professional and conversational
${currentQ >= totalQ ? "- This was the LAST question. Prefix with [DONE] and give a brief professional closing statement thanking the candidate." : ""}`;

      chatMessages.push({ role: "user", content: prompt });

      try {
        const response = await callAI(chatMessages);
        chatMessages.push({ role: "assistant", content: response });

        showThinking(false);

        // Parse response
        const cleaned = response.replace(/\[FOLLOWUP\]\s*/i, '').replace(/\[NEXT\]\s*/i, '').replace(/\[DONE\]\s*/i, '').trim();

        if (response.toUpperCase().includes("[DONE]") || currentQ >= totalQ) {
          // Interview complete
          speakText(cleaned);
          setTimeout(() => showResults(), 3000);
          return;
        }

        if (response.toUpperCase().includes("[NEXT]")) {
          currentQ++;
        }
        // [FOLLOWUP] doesn't increment currentQ

        document.getElementById("questionBox").textContent = cleaned;
        updateProgress();
        speakText(cleaned);

      } catch(err) {
        console.error("[NEXT]", err);
        toast("‚ùå AI error: " + err.message);
        showThinking(false);
      }
    }

    // ============================================================
    // ‚òÖ SUBMIT ANSWER
    // ============================================================
    async function submitAnswer() {
      if (isRecording) toggleMic();

      // Small delay to capture final speech
      await new Promise(r => setTimeout(r, 300));

      const answer = currentTranscript.trim();
      if (!answer) {
        toast("‚ö†Ô∏è No answer detected. Tap üé§ and speak first.");
        return;
      }

      const question = document.getElementById("questionBox").textContent;
      answers.push({ question, answer, skipped: false });
      console.log(`[ANSWER Q${currentQ}]`, answer);

      currentTranscript = "";
      resetTimer();

      await getNextResponse(answer);
    }

    // ‚òÖ Skip
    function skipQuestion() {
      if (isRecording) toggleMic();

      const question = document.getElementById("questionBox").textContent;
      answers.push({ question, answer: "[SKIPPED]", skipped: true });
      currentTranscript = "";
      resetTimer();
      currentQ++;

      toast("‚è≠ Skipped");

      if (currentQ >= totalQ) {
        showResults();
      } else {
        getNextResponse("[The candidate chose to skip this question]");
      }
    }

    // ‚òÖ Repeat
    function repeatQuestion() {
      speakText(document.getElementById("questionBox").textContent);
      toast("üîÅ Repeating...");
    }

    // ‚òÖ End Early
    function endEarly() {
      if (answers.length < 1) {
        toast("‚ö†Ô∏è Answer at least 1 question first");
        return;
      }
      if (isRecording) toggleMic();
      toast("‚èπ Ending interview...");
      showResults();
    }

    // ============================================================
    // ‚òÖ SPEECH RECOGNITION (Hidden transcription)
    // ============================================================
    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        toast("‚ö†Ô∏è Speech not supported. Use Chrome.");
        return;
      }
      recognition = new SR();
      recognition.lang = langMap[lang].speech;
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.maxAlternatives = 1;

      recognition.onresult = (e) => {
        let final = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            final += e.results[i][0].transcript + " ";
          }
        }
        if (final) currentTranscript += final;
        console.log("[SPEECH]", final || "(interim)");
      };

      recognition.onerror = (e) => {
        if (e.error !== 'no-speech' && e.error !== 'aborted') {
          toast("‚ö†Ô∏è Mic: " + e.error);
        }
      };

      recognition.onend = () => {
        if (isRecording) {
          try { recognition.start(); } catch(e) {}
        }
      };
    }

    function toggleMic() {
      if (!recognition) {
        toast("‚ö†Ô∏è Speech recognition unavailable");
        return;
      }

      const btn = document.getElementById("micBtn");
      const label = document.getElementById("micLabel");
      const wave = document.getElementById("waveWrap");

      if (isRecording) {
        isRecording = false;
        recognition.stop();
        btn.classList.remove("recording");
        btn.textContent = "üé§";
        label.textContent = "Tap to start speaking";
        wave.classList.remove("active");
        stopTimer();
      } else {
        window.speechSynthesis.cancel();
        isRecording = true;
        currentTranscript = "";
        try { recognition.start(); } catch(e) {
          recognition.stop();
          setTimeout(() => { try { recognition.start(); } catch(e2) {} }, 150);
        }
        btn.classList.add("recording");
        btn.textContent = "‚èπ";
        label.textContent = "Listening... Tap to stop";
        wave.classList.add("active");
        startTimer();
      }
    }

    // ============================================================
    // ‚òÖ TTS
    // ============================================================
    function speakText(text) {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = langMap[lang].tts;
      u.rate = 0.95;
      window.speechSynthesis.speak(u);
    }

    // ============================================================
    // ‚òÖ TIMER
    // ============================================================
    function startTimer() {
      seconds = 0;
      updateTimerDisplay();
      timerInterval = setInterval(() => { seconds++; updateTimerDisplay(); }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }
    function resetTimer() { clearInterval(timerInterval); seconds = 0; updateTimerDisplay(); }
    function updateTimerDisplay() {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      document.getElementById("timer").textContent = `${m}:${s}`;
    }

    // ============================================================
    // ‚òÖ PROGRESS
    // ============================================================
    function updateProgress() {
      const pct = Math.round((currentQ / totalQ) * 100);
      document.getElementById("progBar").style.width = pct + "%";
      document.getElementById("progText").textContent = `Question ${Math.min(currentQ + 1, totalQ)} of ${totalQ} (${pct}%)`;
    }

    function showThinking(show) {
      document.getElementById("thinkingBox").classList.toggle("hidden", !show);
      if (show) document.getElementById("questionBox").textContent = "";
    }

    // ============================================================
    // ‚òÖ RESULTS
    // ============================================================
    async function showResults() {
      document.getElementById("interviewScreen").style.display = "none";
      document.getElementById("resultScreen").style.display = "block";
      toast("üìä Generating results...");

      const qaPairs = answers.map((a, i) =>
        `Q${i+1}: ${a.question}\nA${i+1}: ${a.skipped ? "[SKIPPED]" : a.answer}`
      ).join('\n\n');

      const evalMessages = [
        {
          role: "system",
          content: `You are an expert interview evaluator. Be fair, detailed, and constructive. Respond in ${langMap[lang].name} for the summary, but keep JSON keys in English.`
        },
        {
          role: "user",
          content: `Evaluate this ${level}-level interview for "${role}".

INTERVIEW Q&A:
${qaPairs}

Respond in STRICT JSON only (no markdown, no code blocks, no extra text):
{
  "overallScore": 0-100,
  "grade": "A+/A/B+/B/C+/C/D/F",
  "summary": "2-3 sentence assessment in ${langMap[lang].name}",
  "feedback": [
    {
      "question": "short question text",
      "score": 0-10,
      "comment": "specific feedback"
    }
  ]
}

Rules: Skipped = 0 score. Evaluate depth, accuracy, communication, relevance. Be honest.`
        }
      ];

      try {
        const raw = await callAI(evalMessages);
        const cleaned = raw.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const jsonStr = cleaned.match(/\{[\s\S]*\}/)?.[0] || cleaned;
        const result = JSON.parse(jsonStr);
        renderResults(result);
      } catch(err) {
        console.error("[RESULTS]", err);
        toast("‚ùå Error generating results");
        document.getElementById("scoreNum").textContent = "?";
        document.getElementById("scoreSummary").textContent = "Error: " + err.message;
      }
    }

    function renderResults(result) {
      const score = result.overallScore || 0;
      const grade = result.grade || "?";
      const isGood = score >= 80;
      const isOk = score >= 60;
      const color = isGood ? '#10b981' : isOk ? '#f59e0b' : '#ef4444';
      const colorBg = isGood ? 'rgba(16,185,129,0.15)' : isOk ? 'rgba(245,158,11,0.15)' : 'rgba(239,68,68,0.15)';

      document.getElementById("scoreCircle").style.background =
        `conic-gradient(${color} ${score * 3.6}deg, rgba(255,255,255,0.05) 0deg)`;
      document.getElementById("scoreNum").textContent = score;

      const badge = document.getElementById("gradeBadge");
      badge.textContent = `Grade: ${grade}`;
      badge.style.background = colorBg;
      badge.style.color = color;

      document.getElementById("scoreSummary").textContent = result.summary || "";

      const list = document.getElementById("feedbackList");
      list.innerHTML = "";
      (result.feedback || []).forEach((fb, i) => {
        const sc = fb.score || 0;
        const c = sc >= 7 ? '#10b981' : sc >= 5 ? '#f59e0b' : '#ef4444';
        const bg = sc >= 7 ? 'rgba(16,185,129,0.15)' : sc >= 5 ? 'rgba(245,158,11,0.15)' : 'rgba(239,68,68,0.15)';
        const div = document.createElement("div");
        div.className = "fb-item";
        div.innerHTML = `
          <div class="fb-q">Q${i+1}: ${fb.question}</div>
          <span class="fb-score" style="background:${bg};color:${c};">${sc}/10</span>
          <div class="fb-text">${fb.comment}</div>`;
        list.appendChild(div);
      });

      animateScore(score);
    }

    function animateScore(target) {
      let cur = 0;
      const el = document.getElementById("scoreNum");
      const iv = setInterval(() => {
        cur += Math.ceil(target / 40);
        if (cur >= target) { cur = target; clearInterval(iv); }
        el.textContent = cur;
      }, 30);
    }

    // ============================================================
    // ‚òÖ INIT
    // ============================================================
    window.addEventListener('DOMContentLoaded', () => {
      if (!window.pdfjsLib) console.warn("‚ö†Ô∏è PDF.js not loaded");
      else console.log("‚úÖ PDF.js v" + pdfjsLib.version);

      if (!window.SpeechRecognition && !window.webkitSpeechRecognition)
        console.warn("‚ö†Ô∏è SpeechRecognition not supported");
    });
  </script>
</body>
</html>
