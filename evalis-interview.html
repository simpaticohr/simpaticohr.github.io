// ... [Use the PDF parsing logic from the previous response] ...

async function startTurn() {
    if(!active || busy || timeLeft <= 0) return;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const rec = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        const chunks = [];
        
        document.getElementById('status').innerText = "INTERVIEWER IS LISTENING...";

        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = async () => {
            if(!active) return;
            document.getElementById('status').innerText = "INTERVIEWER IS THINKING...";
            busy = true;

            const fd = new FormData();
            fd.append("audio", new Blob(chunks, {type: 'audio/webm'}), "voice.webm");
            fd.append("resume", cvText); // Sends the actual parsed PDF text
            fd.append("history", JSON.stringify(history));

            try {
                const res = await fetch(WORKER_URL, { method: "POST", body: fd });
                const data = await res.json();
                
                if (data.reply) {
                    history = data.history;
                    updateTranscript(data.userText, data.reply);
                    speak(data.reply); 
                } else {
                    busy = false; startTurn();
                }
            } catch (err) { busy = false; startTurn(); }
            stream.getTracks().forEach(t => t.stop());
        };

        rec.start();
        // Record in 8-second windows for detailed technical answers
        setTimeout(() => { if(rec.state === "recording") rec.stop(); }, 8000); 
    } catch (err) { alert("Mic required for technical assessment."); }
}

function speak(text) {
    window.speechSynthesis.cancel();
    const ut = new SpeechSynthesisUtterance(text);
    ut.pitch = 0.9; // More professional tone
    document.getElementById('status').innerText = "INTERVIEWER IS RESPONDING...";
    
    ut.onend = () => { 
        busy = false; 
        if(active) setTimeout(startTurn, 200); // Perfect Loop: Mic re-opens immediately
    };
    window.speechSynthesis.speak(ut);
}
