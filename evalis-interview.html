<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Evalis AI Interview</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
body{background:#0f172a;color:white;font-family:sans-serif;
display:flex;justify-content:center;align-items:center;height:100vh}
.card{width:420px;background:#1e293b;padding:25px;border-radius:18px}
button{width:100%;padding:14px;margin-top:10px;background:#4f46e5;color:white;border:none}
#log{height:160px;overflow:auto;background:#020617;margin-top:10px;padding:10px}
</style>
</head>
<body>

<div class="card">
<h3>Evalis AI Interview</h3>
<input type="file" id="cv" accept=".pdf"><br>
<button id="start" disabled>Start Interview</button>
<div id="log"></div>
</div>

<script>
const WORKER = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let cvText="", history=[], active=false, busy=false;

pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

cv.onchange = async e => {
  const pdf = await pdfjsLib.getDocument(
    await e.target.files[0].arrayBuffer()
  ).promise;
  let t="";
  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const c=await p.getTextContent();
    t+=c.items.map(x=>x.str).join(" ");
  }
  cvText=t;
  start.disabled=false;
};

start.onclick = async ()=>{
  active=true;
  start.style.display="none";
  const fd=new FormData();
  fd.append("mode","start");
  fd.append("cvText",cvText);
  const r=await fetch(WORKER,{method:"POST",body:fd});
  const d=await r.json();
  history=d.history;
  speak(d.reply);
};

function speak(text){
  log("AI: "+text);
  const u=new SpeechSynthesisUtterance(text);
  u.onend=()=>listen();
  speechSynthesis.speak(u);
}

async function listen(){
  if(!active||busy) return;
  busy=true;
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const rec=new MediaRecorder(stream);
  const chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=async()=>{
    stream.getTracks().forEach(t=>t.stop());
    busy=false;
    const fd=new FormData();
    fd.append("mode","interview");
    fd.append("audio",new Blob(chunks));
    fd.append("cvText",cvText);
    fd.append("history",JSON.stringify(history));
    const r=await fetch(WORKER,{method:"POST",body:fd});
    const d=await r.json();
    history=d.history;
    if(d.transcript) log("You: "+d.transcript);
    speak(d.reply);
  };
  rec.start();
  setTimeout(()=>rec.stop(),7000);
}

function log(t){
  const l=document.getElementById("log");
  l.innerHTML+=`<div>${t}</div>`;
  l.scrollTop=l.scrollHeight;
}
</script>
</body>
</html>
