<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evalis AI – Live Interview</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
:root{
  --primary:#6366f1;
  --bg:#020617;
  --card:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.1);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:system-ui,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh
}
.card{
  width:92%;
  max-width:420px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:22px;
  padding:24px;
  box-shadow:0 25px 50px rgba(0,0,0,.5);
  text-align:center
}
#timer{
  font-size:36px;
  font-weight:800;
  color:var(--primary);
  margin:10px 0
}
#status{
  font-size:12px;
  color:#94a3b8;
  margin-bottom:16px
}
input[type=file]{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:2px dashed var(--border);
  background:transparent;
  color:#fff
}
button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:14px;
  border:none;
  font-size:16px;
  font-weight:700;
  cursor:pointer
}
.start{background:var(--primary);color:#fff}
.end{background:#ef4444;color:#fff}
button:disabled{opacity:.4}
#log{
  margin-top:18px;
  max-height:220px;
  overflow-y:auto;
  text-align:left;
  font-size:14px
}
.msg{
  margin-bottom:10px;
  padding:10px 14px;
  border-radius:10px
}
.ai{background:rgba(165,180,252,.1)}
.user{background:rgba(103,232,249,.1)}
</style>
</head>

<body>

<div class="card">
  <div id="timer">15:00</div>
  <div id="status">Upload resume to begin</div>

  <input type="file" id="cvInput" accept=".pdf">
  <button id="startBtn" class="start" disabled>Start Interview</button>
  <button id="endBtn" class="end" style="display:none">End Interview</button>

  <div id="log"></div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ================= STATE ================= */
let cvText = "";
let history = [];
let interviewActive = false;
let isAISpeaking = false;
let recognition = null;
let audioCtx = null;
let audioUnlocked = false;
let timeLeft = 15 * 60;
let timerInt = null;

/* ================= PDF ================= */
cvInput.onchange = async e => {
  const f = e.target.files[0];
  if (!f) return;

  status.textContent = "Reading resume...";
  const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
  let t = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const p = await pdf.getPage(i);
    const c = await p.getTextContent();
    t += c.items.map(x => x.str).join(" ") + " ";
  }

  cvText = t.trim() || "[Resume uploaded]";
  startBtn.disabled = false;
  status.textContent = "Resume ready ✓";
};

/* ================= AUDIO UNLOCK (CRITICAL) ================= */
async function unlockAudio() {
  if (audioUnlocked) return;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") {
    await audioCtx.resume();
  }

  const buffer = audioCtx.createBuffer(1, 1, 22050);
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start(0);

  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(""));

  audioUnlocked = true;
}

/* ================= TIMER ================= */
function startTimer() {
  timerInt = setInterval(() => {
    timeLeft--;
    timer.textContent =
      `${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,"0")}`;
    if (timeLeft <= 0) finishInterview();
  }, 1000);
}

/* ================= SPEECH ================= */
function speak(text) {
  return new Promise(res => {
    // Android Fix: Ensure voices are ready
    const voices = speechSynthesis.getVoices();
    speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 1; 

    // Android Fix: Explicitly grab an English voice if available
    if(voices.length > 0) {
      u.voice = voices.find(v => v.lang.includes('en')) || voices[0];
    }

    u.onstart = () => {
      isAISpeaking = true;
      if (recognition) recognition.stop();
    };

    u.onend = () => {
      isAISpeaking = false;
      // Android Fix: Delay restarting mic to prevent self-hearing
      if (interviewActive) {
        setTimeout(() => {
           if(!isAISpeaking && recognition) recognition.start();
        }, 300);
      }
      res();
    };

    u.onerror = (e) => {
      console.log("TTS Error:", e);
      isAISpeaking = false; // Reset flag on error so mic can work
      res();
    };

    addMsg("ai", text);
    speechSynthesis.speak(u);
  });
}


/* ================= SPEECH RECOGNITION ================= */
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    status.textContent = "Speech not supported on this device";
    return;
  }

  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = e => {
    if (isAISpeaking || !interviewActive) return;
    const text = e.results[e.results.length - 1][0].transcript.trim();
    if (text.length < 2) return;
    processUser(text);
  };

  recognition.onend = () => {
    if (interviewActive && !isAISpeaking) {
      setTimeout(() => recognition.start(), 300);
    }
  };
}

/* ================= START ================= */
startBtn.onclick = async () => {
  await unlockAudio();

  interviewActive = true;
  startTimer();

  cvInput.style.display = "none";
  startBtn.style.display = "none";
  endBtn.style.display = "block";

  status.textContent = "Connecting...";

  // ANDROID FIX: Speak immediately to keep audio "awake" while fetching
  // This prevents the browser from sleeping the audio while waiting for the server
  speak("Please wait while I read your resume."); 

  initRecognition();

  try {
    const fd = new FormData();
    fd.append("mode", "start");
    fd.append("cvText", cvText);

    const r = await fetch(API, { method: "POST", body: fd });
    const d = await r.json();

    history = d.history || [];
    
    // This will override the "Please wait" message with the real question
    await speak(d.reply || "Tell me about yourself.");
  } catch {
    await speak("Tell me about yourself.");
  }
};


/* ================= START ================= */
startBtn.onclick = async () => {
  await unlockAudio();

  interviewActive = true;
  startTimer();

  cvInput.style.display = "none";
  startBtn.style.display = "none";
  endBtn.style.display = "block";

  initRecognition();
  status.textContent = "Starting interview...";

  try {
    const fd = new FormData();
    fd.append("mode", "start");
    fd.append("cvText", cvText);

    const r = await fetch(API, { method: "POST", body: fd });
    const d = await r.json();

    history = d.history || [];
    await speak(d.reply || "Tell me about yourself.");
  } catch {
    await speak("Tell me about yourself.");
  }
};

/* ================= END ================= */
endBtn.onclick = finishInterview;

async function finishInterview() {
  interviewActive = false;
  clearInterval(timerInt);
  if (recognition) recognition.stop();
  speechSynthesis.cancel();

  status.textContent = "Generating report...";

  const fd = new FormData();
  fd.append("mode", "score");
  fd.append("history", JSON.stringify(history));
  fd.append("cvText", cvText);

  const r = await fetch(API, { method: "POST", body: fd });
  const d = await r.json();

  document.body.innerHTML = `
    <div class="card">
      <h2>Interview Complete</h2>
      <pre style="white-space:pre-wrap">${d.reply || "Report unavailable"}</pre>
      <button class="start" onclick="location.reload()">New Interview</button>
    </div>`;
}

/* ================= UI ================= */
function addMsg(role, text) {
  const d = document.createElement("div");
  d.className = "msg " + role;
  d.innerHTML = `<b>${role === "ai" ? "AI" : "You"}:</b> ${text}`;
  log.appendChild(d);
  log.scrollTop = log.scrollHeight;
}
</script>

</body>
</html>
