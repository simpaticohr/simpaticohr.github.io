<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Evalis AI Interview</title>

<script src="https://unpkg.com/@ricky0123/vad-web@0.0.7/dist/bundle.standard.js"></script>

<style>
body {
  margin: 0;
  background: #020617;
  font-family: system-ui;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
}
.card {
  background: #0f172a;
  padding: 36px;
  border-radius: 20px;
  width: 320px;
  text-align: center;
  border: 1px solid #1e293b;
}
#status {
  font-size: 11px;
  color: #3b82f6;
  text-transform: uppercase;
  margin-bottom: 16px;
}
#question {
  font-size: 15px;
  color: #cbd5f5;
  min-height: 70px;
  margin-bottom: 20px;
}
button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: #2563eb;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
.pulse {
  width: 12px;
  height: 12px;
  background: #22c55e;
  border-radius: 50%;
  margin: 0 auto 12px;
  display: none;
  animation: pulse 1.2s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.6; }
  100% { transform: scale(1); opacity: 1; }
}
</style>
</head>

<body>
<div class="card">
  <div class="pulse" id="pulse"></div>
  <div id="status">Evalis AI Ready</div>
  <div id="question">Ready to begin?</div>
  <button id="startBtn">Start Interview</button>
</div>

<script>
  <script>
/* ================= INTERVIEW ENGINE ================= */

function createInterview(resume) {
  return {
    profile: resume,
    topics: buildTopics(resume),
    topicIndex: 0,
    depth: 0,
    maxDepth: 2,
    coveredIntents: new Set(),
    completed: false
  };
}

function buildTopics(resume) {
  const topics = [];
  if (resume.role) topics.push({ type: "role" });
  if (resume.skills?.length) topics.push({ type: "skill", value: resume.skills[0] });
  if (resume.projects?.length) topics.push({ type: "project", value: resume.projects[0] });
  topics.push({ type: "impact" });
  return topics;
}

function decideNextQuestion(answer, state) {
  if (state.completed) {
    return { question: "The interview is complete. Thank you.", done: true };
  }

  const s = analyze(answer);

  if (!s.detail && !state.coveredIntents.has("detail")) {
    state.coveredIntents.add("detail");
    return ask("Can you explain that in more detail?");
  }
  if (!s.ownership && !state.coveredIntents.has("ownership")) {
    state.coveredIntents.add("ownership");
    return ask("What was your personal responsibility there?");
  }
  if (!s.example && !state.coveredIntents.has("example")) {
    state.coveredIntents.add("example");
    return ask("Can you give a real example?");
  }
  if (!s.impact && !state.coveredIntents.has("impact")) {
    state.coveredIntents.add("impact");
    return ask("What was the outcome or impact?");
  }

  if (state.depth < state.maxDepth) {
    state.depth++;
    return ask("What challenges did you face?");
  }

  state.coveredIntents.clear();
  state.depth = 0;
  state.topicIndex++;

  if (state.topicIndex >= state.topics.length) {
    state.completed = true;
    return { question: "Thank you. The interview is complete.", done: true };
  }

  return ask(generateTopicQuestion(state.topics[state.topicIndex], state.profile));
}

function analyze(text = "") {
  const t = text.toLowerCase();
  return {
    detail: text.split(" ").length > 25,
    ownership: /\b(i|my|me)\b/.test(t),
    example: /(example|when|project|situation)/.test(t),
    impact: /(impact|result|improve|increase|reduce|learned)/.test(t)
  };
}

function generateTopicQuestion(topic, profile) {
  switch (topic.type) {
    case "role":
      return `You worked as a ${profile.role}. What were your responsibilities?`;
    case "skill":
      return `How did you use ${topic.value} in real work?`;
    case "project":
      return `Tell me about the project ${topic.value}.`;
    case "impact":
      return "What measurable impact did your work create?";
    default:
      return "Please tell me more.";
  }
}

function ask(q) {
  return { question: q, done: false };
}
</script>
const startBtn = document.getElementById("startBtn");
const statusEl = document.getElementById("status");
const questionEl = document.getElementById("question");
const pulse = document.getElementById("pulse");

const synth = window.speechSynthesis;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
  statusEl.innerText = "Voice not supported";
  questionEl.innerText = "Please use Chrome browser.";
  startBtn.disabled = true;
}

const questions = [
  "Tell me about your background.",
  "What experience do you have related to this role?",
  "Describe a challenge you handled well.",
  "Why should we hire you?"
];

let qIndex = 0;
let recognition;
let silenceTimer;

function speak(text) {
  synth.cancel();
  questionEl.innerText = text;
  statusEl.innerText = "Evalis AI Speaking";
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;
  u.onend = () => statusEl.innerText = "Listening…";
  synth.speak(u);
}

async function startInterview() {
  startBtn.style.display = "none";
  statusEl.innerText = "Requesting microphone…";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    recognition = new SpeechRecognition();
    recognition.lang = "en-US";

    recognition.onresult = () => {
      recognition.stop();
      qIndex++;
      if (qIndex < questions.length) {
        setTimeout(() => speak(questions[qIndex]), 800);
      } else {
        statusEl.innerText = "Interview Completed";
        questionEl.innerText = "Thank you. Interview complete.";
        pulse.style.display = "none";
      }
    };

    const vadInstance = await vad.MicVAD.new({
      stream,
      onSpeechStart: () => {
        pulse.style.display = "block";
        clearTimeout(silenceTimer);
        if (synth.speaking) synth.cancel();
      },
      onSpeechEnd: () => {
        pulse.style.display = "none";
        try { recognition.start(); } catch (e) {}
        silenceTimer = setTimeout(() => {
          statusEl.innerText = "Waiting for you…";
        }, 4000);
      }
    });

    vadInstance.start();
    speak(questions[0]);

  } catch {
    statusEl.innerText = "Microphone blocked";
    questionEl.innerText = "Please allow mic access and refresh.";
  }
}

startBtn.onclick = startInterview;
</script>
</body>
</html>
