<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interview Platform</title>

  <!-- ‚òÖ PDF.js ‚Äî Load FIRST in head -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <style>
    /* ============================================================
       ‚òÖ CSS VARIABLES & RESET
       ============================================================ */
    :root {
      --bg: #06090f;
      --card: #0d1117;
      --card2: #161b22;
      --border: #21262d;
      --accent: #58a6ff;
      --accent2: #bc8cff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --text: #e6edf3;
      --text2: #8b949e;
      --glow: rgba(88,166,255,0.15);
      --glow2: rgba(188,140,255,0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* ‚òÖ Subtle background */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background:
        radial-gradient(ellipse at 20% 0%, rgba(88,166,255,0.06) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(188,140,255,0.06) 0%, transparent 60%);
      z-index: 0; pointer-events: none;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
      z-index: 1;
    }

    /* ‚òÖ Header */
    .header {
      text-align: center;
      padding: 32px 0 24px;
    }
    .header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header p {
      color: var(--text2);
      font-size: 0.9rem;
      margin-top: 4px;
    }

    /* ‚òÖ Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 14px;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚òÖ Form */
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text2);
      margin: 12px 0 4px;
      font-weight: 500;
    }
    label:first-child { margin-top: 0; }

    select, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }
    select:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow);
    }
    select option { background: var(--card); }

    .row2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* ‚òÖ Upload */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(88,166,255,0.03);
    }
    .upload-area.ok {
      border-color: var(--green);
      background: rgba(63,185,80,0.05);
    }
    .upload-area .icon { font-size: 2rem; display: block; margin-bottom: 8px; }
    .upload-area p { font-size: 0.85rem; color: var(--text2); }
    .upload-area strong { color: var(--accent); }
    #fName { margin-top: 8px; font-size: 0.8rem; color: var(--text2); }

    /* ‚òÖ Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #fff;
      font-family: inherit;
    }
    .btn-go {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      margin-top: 16px;
    }
    .btn-go:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--glow);
    }
    .btn-go:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    /* ‚òÖ Mic */
    .mic-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 24px 0;
    }
    .mic-btn {
      width: 72px; height: 72px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-size: 1.8rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mic-btn:hover { transform: scale(1.08); box-shadow: 0 0 25px var(--glow); }
    .mic-btn.rec {
      background: linear-gradient(135deg, var(--red), #da3633);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(248,81,73,0.4); }
      50% { box-shadow: 0 0 0 14px rgba(248,81,73,0); }
    }
    .mic-text {
      font-size: 0.8rem;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .timer {
      font-size: 1.4rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    /* ‚òÖ Waveform */
    .wave {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 40px;
    }
    .wave i {
      display: block;
      width: 4px; height: 8px;
      border-radius: 2px;
      background: var(--accent);
      transition: height 0.1s;
    }
    .wave.on i { animation: w 0.8s ease-in-out infinite alternate; }
    .wave i:nth-child(1) { animation-delay: 0s; }
    .wave i:nth-child(2) { animation-delay: 0.1s; }
    .wave i:nth-child(3) { animation-delay: 0.2s; }
    .wave i:nth-child(4) { animation-delay: 0.3s; }
    .wave i:nth-child(5) { animation-delay: 0.4s; }
    .wave i:nth-child(6) { animation-delay: 0.3s; }
    .wave i:nth-child(7) { animation-delay: 0.2s; }
    .wave i:nth-child(8) { animation-delay: 0.1s; }
    .wave i:nth-child(9) { animation-delay: 0s; }
    @keyframes w { from { height: 8px; } to { height: 36px; } }

    /* ‚òÖ Question box */
    .q-box {
      background: linear-gradient(135deg, rgba(88,166,255,0.08), rgba(188,140,255,0.08));
      border: 1px solid rgba(88,166,255,0.15);
      border-radius: 10px;
      padding: 18px;
      font-size: 1.05rem;
      line-height: 1.7;
      min-height: 70px;
      margin-bottom: 16px;
    }

    /* ‚òÖ Progress */
    .prog-bar { height: 6px; background: var(--card2); border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
    .prog-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 3px; transition: width 0.5s; width: 0%; }
    .prog-text { text-align: center; font-size: 0.8rem; color: var(--text2); margin-bottom: 14px; }

    /* ‚òÖ Status */
    .status { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.8rem; color: var(--text2); margin-bottom: 14px; }
    .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); animation: blink 1.5s infinite; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

    /* ‚òÖ Controls row */
    .ctrls { display: flex; gap: 8px; margin-top: 12px; }
    .ctrls .btn { flex: 1; padding: 10px; font-size: 0.85rem; border-radius: 8px; }
    .btn-repeat { background: rgba(188,140,255,0.15); color: var(--accent2); }
    .btn-skip { background: rgba(255,255,255,0.06); color: var(--text); }
    .btn-done { background: var(--green); }
    .btn-end { background: var(--red); width: 100%; margin-top: 12px; padding: 12px; }

    /* ‚òÖ Thinking dots */
    .thinking { display: flex; align-items: center; gap: 8px; color: var(--text2); font-size: 0.85rem; margin: 12px 0; }
    .dots span { display: inline-block; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: dot 1.2s infinite; }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot { 0%,100%{opacity:0.2;transform:scale(0.8);} 50%{opacity:1;transform:scale(1.3);} }

    /* ‚òÖ Results */
    .score-ring {
      width: 150px; height: 150px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 16px; position: relative;
    }
    .score-ring::before {
      content: ''; position: absolute;
      width: 120px; height: 120px; border-radius: 50%;
      background: var(--card);
    }
    .score-num { position: relative; z-index: 1; font-size: 2.2rem; font-weight: 800; }
    .score-sub { text-align: center; color: var(--text2); font-size: 0.85rem; margin-bottom: 20px; }

    .grade {
      display: inline-block;
      padding: 4px 16px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    .fb { background: var(--card2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 10px; }
    .fb-q { font-weight: 600; color: var(--accent); margin-bottom: 4px; font-size: 0.9rem; }
    .fb-s { font-size: 0.75rem; padding: 2px 8px; border-radius: 8px; display: inline-block; margin-bottom: 6px; }
    .fb-t { font-size: 0.85rem; color: var(--text2); line-height: 1.5; }

    /* ‚òÖ Toast */
    .toast-box { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: var(--card); border: 1px solid var(--border); padding: 10px 18px; border-radius: 10px; font-size: 0.85rem; box-shadow: 0 8px 24px rgba(0,0,0,0.4); animation: tIn 0.3s ease, tOut 0.3s ease 2.7s forwards; }
    @keyframes tIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes tOut { to { transform: translateX(120%); opacity: 0; } }

    /* ‚òÖ Sections */
    .screen { display: none; }
    .screen.on { display: block; }

    .hidden { display: none !important; }

    /* ‚òÖ Responsive */
    @media (max-width: 600px) {
      .container { padding: 10px; }
      .header h1 { font-size: 1.5rem; }
      .row2 { grid-template-columns: 1fr; }
      .mic-btn { width: 64px; height: 64px; font-size: 1.5rem; }
    }
  </style>
</head>

<body>
  <div class="toast-box" id="toasts"></div>

  <div class="container">
    <!-- ‚òÖ HEADER -->
    <div class="header">
      <h1>üß† AI Interviewer</h1>
      <p>Adaptive interviews powered by Llama 3.3 70B</p>
    </div>

    <!-- ============================================================
         ‚òÖ SETUP SCREEN
         ============================================================ -->
    <div class="screen on" id="S_setup">

      <div class="card">
        <h2>‚öôÔ∏è Interview Setup</h2>

        <label>üåê Language</label>
        <select id="iLang">
          <option value="en">English</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
          <option value="es">Espa√±ol (Spanish)</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
          <option value="fr">Fran√ßais (French)</option>
          <option value="de">Deutsch (German)</option>
          <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
        </select>

        <label>üíº Job Role</label>
        <select id="iRole">
          <option value="">‚Äî Select Role ‚Äî</option>
          <option value="Frontend Developer">Frontend Developer</option>
          <option value="Backend Developer">Backend Developer</option>
          <option value="Full Stack Developer">Full Stack Developer</option>
          <option value="Mobile Developer">Mobile Developer</option>
          <option value="Data Scientist">Data Scientist / Analyst</option>
          <option value="DevOps Engineer">DevOps / Cloud Engineer</option>
          <option value="UI/UX Designer">UI/UX Designer</option>
          <option value="Product Manager">Product Manager</option>
          <option value="QA Engineer">QA / Test Engineer</option>
          <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
          <option value="Sales Representative">Sales / BDR</option>
          <option value="Marketing Manager">Marketing Manager</option>
          <option value="HR Recruiter">HR / Recruiter</option>
          <option value="Finance Analyst">Finance / Accounting</option>
          <option value="Customer Support">Customer Support</option>
          <option value="custom">‚úèÔ∏è Custom Role...</option>
        </select>

        <div id="customWrap" class="hidden">
          <label>Enter Role</label>
          <input type="text" id="iCustomRole" placeholder="e.g. Blockchain Developer">
        </div>

        <div class="row2">
          <div>
            <label>üìä Level</label>
            <select id="iLevel">
              <option value="Fresher">Fresher / Entry</option>
              <option value="Junior">Junior (1-2 yrs)</option>
              <option value="Mid-Level" selected>Mid-Level (3-5 yrs)</option>
              <option value="Senior">Senior (5-10 yrs)</option>
              <option value="Lead">Lead / Principal (10+)</option>
            </select>
          </div>
          <div>
            <label>üî¢ Questions</label>
            <select id="iCount">
              <option value="5">5 (~10 min)</option>
              <option value="8">8 (~15 min)</option>
              <option value="10" selected>10 (~20 min)</option>
              <option value="15">15 (~30 min)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- CV Upload -->
      <div class="card">
        <h2>üìÑ Resume (Optional)</h2>
        <div id="upArea" class="upload-area" onclick="document.getElementById('cvF').click()">
          <span class="icon">‚òÅÔ∏è</span>
          <p>Click to upload <strong>PDF, DOC, DOCX, TXT</strong></p>
          <p id="fName">No file selected</p>
          <input type="file" id="cvF" accept=".pdf,.doc,.docx,.txt" hidden>
        </div>
      </div>

      <!-- ‚òÖ NO API KEY CARD ‚Äî Removed! -->

      <button class="btn btn-go" id="startBtn" onclick="begin()">üöÄ Start Interview</button>
    </div>

    <!-- ============================================================
         ‚òÖ INTERVIEW SCREEN
         ============================================================ -->
    <div class="screen" id="S_interview">
      <div class="card">
        <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
        <div class="prog-text" id="progText">Question 1 / 10</div>

        <div class="status">
          <div class="dot"></div>
          <span>AI Interview Active</span>
          <span id="modelBadge" style="margin-left:auto;font-size:0.7rem;background:var(--card2);padding:2px 8px;border-radius:6px;">üß† 70B</span>
        </div>

        <div class="q-box" id="qBox">Preparing your first question...</div>

        <!-- Thinking -->
        <div class="thinking hidden" id="thinkBox">
          <div class="dots"><span></span><span></span><span></span></div>
          <span>AI is thinking...</span>
        </div>

        <!-- Mic area -->
        <div class="mic-wrap" id="micWrap">
          <div class="wave" id="wave">
            <i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
          </div>
          <button class="mic-btn" id="micBtn" onclick="toggleMic()">üé§</button>
          <span class="mic-text" id="micText">Tap to start speaking</span>
          <span class="timer" id="timer">00:00</span>
        </div>

        <!-- Controls -->
        <div class="ctrls">
          <button class="btn btn-repeat" onclick="repeatQ()">üîÅ Repeat</button>
          <button class="btn btn-skip" onclick="skipQ()">‚è≠ Skip</button>
          <button class="btn btn-done" onclick="submitAns()">‚úÖ Submit</button>
        </div>

        <button class="btn btn-end" onclick="finishNow()">‚èπ End Interview Early</button>
      </div>
    </div>

    <!-- ============================================================
         ‚òÖ RESULTS SCREEN
         ============================================================ -->
    <div class="screen" id="S_results">
      <div class="card" style="text-align:center;">
        <h2 style="justify-content:center;">üèÜ Interview Complete!</h2>
        <div class="score-ring" id="scoreRing">
          <span class="score-num" id="scoreNum">0</span>
        </div>
        <div id="gradeBadge" class="grade">‚Äî</div>
        <p class="score-sub" id="scoreSummary"></p>
      </div>

      <div class="card">
        <h2>üìù Detailed Feedback</h2>
        <div id="fbList"></div>
      </div>

      <div class="card">
        <h2>üìã Overall Summary</h2>
        <p id="summaryText" style="color:var(--text2);line-height:1.7;"></p>
      </div>

      <button class="btn btn-go" onclick="location.reload()">üîÑ New Interview</button>
    </div>
  </div>

  <!-- ============================================================
       ‚òÖ JAVASCRIPT
       ============================================================ -->
  <script>
    // ============================================================
    // ‚òÖ CONFIG ‚Äî Change this to YOUR Cloudflare Worker URL
    // ============================================================
    const WORKER_URL = "https://ai-interview.YOUR-NAME.workers.dev";

    // ============================================================
    // ‚òÖ STATE
    // ============================================================
    let cv = "";
    let role = "";
    let level = "";
    let lang = "en";
    let totalQ = 10;
    let currentQ = 0;
    let history = [];     // {question, answer}
    let answers = [];     // for results
    let isRec = false;
    let recog = null;
    let transcript = "";
    let timerInt = null;
    let secs = 0;

    const LANGS = {
      en: { stt: "en-US", tts: "en-US", name: "English" },
      hi: { stt: "hi-IN", tts: "hi-IN", name: "Hindi" },
      es: { stt: "es-ES", tts: "es-ES", name: "Spanish" },
      ar: { stt: "ar-SA", tts: "ar-SA", name: "Arabic" },
      fr: { stt: "fr-FR", tts: "fr-FR", name: "French" },
      de: { stt: "de-DE", tts: "de-DE", name: "German" },
      ur: { stt: "ur-PK", tts: "ur-PK", name: "Urdu" }
    };

    // ============================================================
    // ‚òÖ TOAST
    // ============================================================
    function toast(m) {
      const c = document.getElementById("toasts");
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = m;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // ============================================================
    // ‚òÖ SCREEN SWITCH
    // ============================================================
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('on'));
      document.getElementById(id).classList.add('on');
    }

    // ============================================================
    // ‚òÖ CUSTOM ROLE TOGGLE
    // ============================================================
    document.getElementById("iRole").addEventListener("change", e => {
      document.getElementById("customWrap").classList.toggle("hidden", e.target.value !== "custom");
    });

    // ============================================================
    // ‚òÖ CV UPLOAD
    // ============================================================
    document.getElementById("cvF").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById("fName").textContent = "‚è≥ Processing " + file.name + "...";
      document.getElementById("upArea").classList.remove("ok");

      try {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'txt') cv = await file.text();
        else if (ext === 'pdf') cv = await extractPDF(file);
        else if (ext === 'doc' || ext === 'docx') cv = await extractDOC(file);
        else cv = await file.text();

        cv = cv.replace(/\s+/g, ' ').replace(/[^\x20-\x7E\n]/g, '').trim().substring(0, 5000);

        if (cv.length < 30) {
          document.getElementById("fName").textContent = "‚ö†Ô∏è Could not extract ‚Äî try TXT";
          toast("‚ö†Ô∏è Try uploading as .txt"); cv = ""; return;
        }

        document.getElementById("fName").textContent = `‚úÖ ${file.name} (${cv.length} chars)`;
        document.getElementById("upArea").classList.add("ok");
        toast("‚úÖ Resume loaded!");
      } catch(err) {
        console.error(err);
        document.getElementById("fName").textContent = "‚ùå Error reading file";
        toast("‚ùå Error. Try .txt format."); cv = "";
      }
    });

    async function extractPDF(file) {
      if (!window.pdfjsLib) return extractFallback(file);
      try {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let txt = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const p = await pdf.getPage(i);
          const c = await p.getTextContent();
          txt += c.items.map(x => x.str).join(' ') + "\n";
        }
        return txt;
      } catch(e) { return extractFallback(file); }
    }

    async function extractDOC(file) {
      const buf = await file.arrayBuffer();
      if (file.name.endsWith('.docx')) {
        try {
          const t = new TextDecoder('utf-8').decode(new Uint8Array(buf));
          const m = t.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);
          if (m && m.length) return m.map(x => x.replace(/<[^>]+>/g, '')).join(' ');
        } catch(e) {}
      }
      return extractFallback(file);
    }

    async function extractFallback(file) {
      const buf = await file.arrayBuffer();
      const t = new TextDecoder('utf-8', { fatal: false }).decode(buf);
      const r = t.match(/[a-zA-Z0-9@.,:;!?\-/()\s]{5,}/g);
      if (!r) return "";
      return r.filter(s => (s.match(/[a-zA-Z]/g)||[]).length / s.length > 0.5 && s.trim().length > 5).join(' ');
    }

    // ============================================================
    // ‚òÖ CLOUDFLARE AI CALL (No API Key!)
    // ============================================================
    async function callAI(messages) {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages,
          maxTokens: 2048,
          temperature: 0.7
        })
      });

      if (!res.ok) {
        const err = await res.text();
        throw new Error(`Worker error ${res.status}: ${err}`);
      }

      const data = await res.json();

      // Show which model was used
      if (data.model) {
        const badge = document.getElementById("modelBadge");
        if (badge) {
          badge.textContent = data.model.includes("70b") ? "üß† 70B" : "‚ö° 8B fallback";
        }
      }

      return data.response || "";
    }

    // ============================================================
    // ‚òÖ BUILD SYSTEM PROMPT
    // ============================================================
    function buildSystemPrompt() {
      return `You are an expert AI interviewer conducting a professional interview.

ROLE: ${role}
LEVEL: ${level}
LANGUAGE: ${LANGS[lang].name} (respond in this language)

${cv ? `CANDIDATE RESUME:\n${cv}\n` : "No resume provided."}

INTERVIEW RULES:
1. Ask ONE clear, focused question at a time.
2. Use the C.L.A.I.M. follow-up framework for vague answers:
   - Claim: Verify what they actually did
   - Learning: What they took away
   - Alternatives: Other approaches considered
   - Impact: Measurable results & metrics
   - Mechanism: Exact steps and process
3. If answer was thorough and strong, move to a NEW topic.
4. Mix behavioral, technical, and situational questions.
5. Adapt difficulty to ${level} level.
6. Be conversational but professional.
7. NEVER repeat a question topic already covered.

TOTAL QUESTIONS: ${totalQ}

RESPONSE FORMAT: Return ONLY the question text. No labels, no numbering, no preamble, no "Question X:".`;
    }

    // ============================================================
    // ‚òÖ START INTERVIEW
    // ============================================================
    async function begin() {
      const roleSel = document.getElementById("iRole").value;
      if (!roleSel) { toast("‚ùå Select a job role"); return; }

      role = roleSel === "custom" ? document.getElementById("iCustomRole").value.trim() : roleSel;
      if (!role) { toast("‚ùå Enter a custom role"); return; }

      lang = document.getElementById("iLang").value;
      level = document.getElementById("iLevel").value;
      totalQ = parseInt(document.getElementById("iCount").value);
      currentQ = 0;
      history = [];
      answers = [];

      const btn = document.getElementById("startBtn");
      btn.disabled = true;
      btn.textContent = "‚è≥ Starting...";

      try {
        showScreen("S_interview");
        initSTT();
        await getNextQ();
        toast("üéØ Interview started! Good luck!");
      } catch(err) {
        console.error(err);
        toast("‚ùå " + err.message);
        showScreen("S_setup");
      }

      btn.disabled = false;
      btn.textContent = "üöÄ Start Interview";
    }

    // ============================================================
    // ‚òÖ GET NEXT QUESTION
    // ============================================================
    async function getNextQ() {
      showThinking(true);

      try {
        // Build messages array
        const messages = [
          { role: "system", content: buildSystemPrompt() }
        ];

        // Add conversation history
        history.forEach(h => {
          messages.push({ role: "assistant", content: h.question });
          messages.push({ role: "user", content: h.answer });
        });

        // Ask for next question
        messages.push({
          role: "user",
          content: currentQ === 0
            ? "Begin the interview. Ask the first question."
            : `That was answer ${currentQ} of ${totalQ}. ${currentQ >= totalQ ? "The interview is complete." : "Ask the next question based on the conversation so far. If my previous answer was vague, ask a C.L.A.I.M. follow-up instead."}`
        });

        const question = await callAI(messages);

        if (!question) throw new Error("Empty AI response");

        document.getElementById("qBox").textContent = question;
        updateProgress();
        speak(question);
        toast(`üìå Question ${currentQ + 1} of ${totalQ}`);

      } catch(err) {
        console.error(err);
        toast("‚ùå Error: " + err.message);
        document.getElementById("qBox").textContent = "‚ùå Error loading question. Please try again.";
      }

      showThinking(false);
    }

    // ============================================================
    // ‚òÖ SUBMIT ANSWER
    // ============================================================
    async function submitAns() {
      if (isRec) toggleMic();

      const answer = transcript.trim();
      if (!answer) {
        toast("‚ö†Ô∏è No answer recorded. Tap üé§ and speak.");
        return;
      }

      const question = document.getElementById("qBox").textContent;
      history.push({ question, answer });
      answers.push({ question, answer, skipped: false });

      console.log(`[A${currentQ + 1}]`, answer);
      transcript = "";
      resetTimer();
      currentQ++;

      if (currentQ >= totalQ) {
        await showResults();
      } else {
        await getNextQ();
      }
    }

    function skipQ() {
      if (isRec) toggleMic();
      const question = document.getElementById("qBox").textContent;
      history.push({ question, answer: "[SKIPPED]" });
      answers.push({ question, answer: "[SKIPPED]", skipped: true });
      transcript = "";
      resetTimer();
      currentQ++;
      toast("‚è≠ Skipped");
      if (currentQ >= totalQ) { showResults(); } else { getNextQ(); }
    }

    function repeatQ() {
      speak(document.getElementById("qBox").textContent);
      toast("üîÅ Repeating...");
    }

    function finishNow() {
      if (answers.length === 0) { toast("‚ö†Ô∏è Answer at least 1 question first"); return; }
      totalQ = currentQ; // Adjust total to current
      showResults();
    }

    // ============================================================
    // ‚òÖ SPEECH RECOGNITION (Hidden transcription)
    // ============================================================
    function initSTT() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { toast("‚ö†Ô∏è Use Chrome for voice input"); return; }

      recog = new SR();
      recog.lang = LANGS[lang].stt;
      recog.continuous = true;
      recog.interimResults = true;

      recog.onresult = e => {
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            transcript += e.results[i][0].transcript + " ";
          }
        }
        // ‚òÖ NO UI ‚Äî transcription is hidden from candidate
        console.log("[STT]", transcript);
      };

      recog.onerror = e => {
        if (e.error !== 'no-speech') toast("‚ö†Ô∏è Mic: " + e.error);
      };

      recog.onend = () => {
        if (isRec) try { recog.start(); } catch(e) {}
      };
    }

    function toggleMic() {
      if (!recog) { toast("‚ö†Ô∏è Speech not available"); return; }

      const btn = document.getElementById("micBtn");
      const txt = document.getElementById("micText");
      const wav = document.getElementById("wave");

      if (isRec) {
        isRec = false;
        recog.stop();
        btn.classList.remove("rec");
        btn.textContent = "üé§";
        txt.textContent = "Tap to start speaking";
        wav.classList.remove("on");
        stopTimer();
      } else {
        window.speechSynthesis.cancel();
        isRec = true;
        transcript = "";
        try { recog.start(); } catch(e) { recog.stop(); setTimeout(() => recog.start(), 100); }
        btn.classList.add("rec");
        btn.textContent = "‚èπ";
        txt.textContent = "Listening... Tap to stop";
        wav.classList.add("on");
        startTimer();
      }
    }

    // ============================================================
    // ‚òÖ TTS
    // ============================================================
    function speak(text) {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = LANGS[lang].tts;
      u.rate = 0.95;
      window.speechSynthesis.speak(u);
    }

    // ============================================================
    // ‚òÖ TIMER
    // ============================================================
    function startTimer() {
      secs = 0;
      showTime();
      timerInt = setInterval(() => { secs++; showTime(); }, 1000);
    }
    function stopTimer() { clearInterval(timerInt); }
    function resetTimer() { clearInterval(timerInt); secs = 0; showTime(); }
    function showTime() {
      const m = String(Math.floor(secs / 60)).padStart(2, '0');
      const s = String(secs % 60).padStart(2, '0');
      document.getElementById("timer").textContent = `${m}:${s}`;
    }

    // ============================================================
    // ‚òÖ PROGRESS & THINKING
    // ============================================================
    function updateProgress() {
      const pct = Math.round((currentQ / totalQ) * 100);
      document.getElementById("progFill").style.width = pct + "%";
      document.getElementById("progText").textContent = `Question ${currentQ + 1} of ${totalQ} ‚Äî ${pct}% complete`;
    }

    function showThinking(show) {
      document.getElementById("thinkBox").classList.toggle("hidden", !show);
      document.getElementById("micWrap").style.display = show ? "none" : "flex";
      if (show) document.getElementById("qBox").textContent = "";
    }

    // ============================================================
    // ‚òÖ RESULTS
    // ============================================================
    async function showResults() {
      showScreen("S_results");
      toast("üìä Generating evaluation...");

      try {
        const qaPairs = answers.map((a, i) =>
          `Q${i+1}: ${a.question}\nA${i+1}: ${a.skipped ? "[SKIPPED]" : a.answer}`
        ).join('\n\n');

        const messages = [
          {
            role: "system",
            content: `You are an expert interview evaluator. Be fair but honest. Evaluate depth, accuracy, communication, and relevance. Respond in ${LANGS[lang].name}.`
          },
          {
            role: "user",
            content: `Evaluate this interview for the role of ${role} at ${level} level.

INTERVIEW:
${qaPairs}

RESPOND IN STRICT JSON (no markdown, no code blocks, no backticks):
{
  "overallScore": <0-100>,
  "grade": "<A+/A/B+/B/C+/C/D/F>",
  "summary": "<2-3 paragraph detailed assessment>",
  "recommendation": "<Strong Hire / Hire / Maybe / No Hire>",
  "feedback": [
    {
      "question": "<short question text>",
      "score": <0-10>,
      "comment": "<specific feedback for this answer>"
    }
  ]
}`
          }
        ];

        const raw = await callAI(messages);
        const cleaned = raw.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

        let result;
        try {
          result = JSON.parse(cleaned);
        } catch(e) {
          // Try to extract JSON from response
          const match = cleaned.match(/\{[\s\S]*\}/);
          if (match) result = JSON.parse(match[0]);
          else throw new Error("Could not parse results");
        }

        renderResults(result);
        toast("üèÜ Evaluation complete!");

      } catch(err) {
        console.error(err);
        toast("‚ùå Evaluation error");
        document.getElementById("scoreNum").textContent = "?";
        document.getElementById("scoreSummary").textContent = "Error: " + err.message;
      }
    }

    function renderResults(r) {
      const score = r.overallScore || 0;
      const grade = r.grade || "?";
      const isGood = score >= 75;
      const isMid = score >= 50 && score < 75;
      const color = isGood ? 'var(--green)' : isMid ? 'var(--yellow)' : 'var(--red)';

      // Score ring
      document.getElementById("scoreRing").style.background =
        `conic-gradient(${isGood ? '#3fb950' : isMid ? '#d29922' : '#f85149'} ${score * 3.6}deg, var(--card2) 0deg)`;

      // Animate score number
      let cur = 0;
      const el = document.getElementById("scoreNum");
      const iv = setInterval(() => {
        cur += Math.ceil(score / 30);
        if (cur >= score) { cur = score; clearInterval(iv); }
        el.textContent = cur;
      }, 30);

      // Grade badge
      const badge = document.getElementById("gradeBadge");
      badge.textContent = `${grade} ‚Äî ${r.recommendation || ''}`;
      badge.style.background = isGood ? 'rgba(63,185,80,0.15)' : isMid ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';
      badge.style.color = color;

      document.getElementById("scoreSummary").textContent = "";
      document.getElementById("summaryText").textContent = r.summary || "";

      // Per-question feedback
      const list = document.getElementById("fbList");
      list.innerHTML = "";

      (r.feedback || []).forEach((fb, i) => {
        const sc = fb.score || 0;
        const c = sc >= 7 ? '#3fb950' : sc >= 5 ? '#d29922' : '#f85149';
        const bg = sc >= 7 ? 'rgba(63,185,80,0.15)' : sc >= 5 ? 'rgba(210,153,34,0.15)' : 'rgba(248,81,73,0.15)';
        list.innerHTML += `
          <div class="fb">
            <div class="fb-q">Q${i+1}: ${fb.question}</div>
            <span class="fb-s" style="background:${bg};color:${c};">${sc}/10</span>
            <div class="fb-t">${fb.comment}</div>
          </div>`;
      });
    }

    // ============================================================
    // ‚òÖ INIT
    // ============================================================
    window.addEventListener('DOMContentLoaded', () => {
      if (window.pdfjsLib) console.log("‚úÖ PDF.js v" + pdfjsLib.version);
      else console.warn("‚ö†Ô∏è PDF.js not loaded ‚Äî fallback active");

      if (!window.SpeechRecognition && !window.webkitSpeechRecognition)
        console.warn("‚ö†Ô∏è SpeechRecognition not supported");
    });
  </script>
</body>
</html>
