<script>
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let cvText = "";
let history = [];
let interviewActive = false;
let recognition;
let isAISpeaking = false;

/* ... keep PDF parser and log UI code ... */

function speak(text) {
  log("ai", "AI: " + text);
  const u = new SpeechSynthesisUtterance(text);
  
  u.onstart = () => { isAISpeaking = true; };
  u.onend = () => { 
    isAISpeaking = false; 
    // Resume listening after AI finishes if not already listening
    try { recognition.start(); } catch(e) {}
  };

  speechSynthesis.speak(u);
}

function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = "en-US";
  // ðŸŸ¢ UPGRADE: Continuous listening allows "Barge-in"
  recognition.continuous = true; 
  recognition.interimResults = true; // Hear user while they are still talking

  recognition.onresult = async e => {
    let interimTranscript = '';
    for (let i = e.resultIndex; i < e.results.length; ++i) {
      if (e.results[i].isFinal) {
        const transcript = e.results[i][0].transcript.trim();
        
        // ðŸ”´ BARGE-IN LOGIC: If user speaks while AI speaks, kill the AI voice
        if (isAISpeaking) {
          speechSynthesis.cancel();
          isAISpeaking = false;
        }
        
        handleTurn(transcript);
      }
    }
  };

  recognition.onerror = () => { if (interviewActive) try { recognition.start(); } catch(e) {} };
  // Keep mic open even when it idles
  recognition.onend = () => { if (interviewActive) try { recognition.start(); } catch(e) {} };
}

async function handleTurn(transcript) {
    log("user", "You: " + transcript);
    statusEl.textContent = "AI is processing...";
    
    const fd = new FormData();
    fd.append("mode", "interview");
    fd.append("cvText", cvText);
    fd.append("history", JSON.stringify(history));
    fd.append("text", transcript);

    try {
        const res = await fetch(API, { method: "POST", body: fd });
        const data = await res.json();
        history = data.history;
        speak(data.reply);
    } catch(e) {
        statusEl.textContent = "Connection error. Retrying...";
    }
}
</script>
