<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AI Interview</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body { background:#0f172a;color:white;font-family:sans-serif;
           display:flex;align-items:center;justify-content:center;height:100vh }
    .card { width:420px;background:#1e293b;padding:25px;border-radius:20px }
    button { width:100%;padding:14px;margin-top:10px;
             background:#2563eb;border:none;color:white;font-weight:bold }
    #log { margin-top:15px;font-size:14px;min-height:80px }
  </style>
</head>
<body>

<div class="card">
  <h3>AI Interviewer</h3>
  <input type="file" id="cv" accept=".pdf"><br><br>
  <button id="start" disabled>Start Interview</button>
  <div id="log"></div>
</div>

<script>
const WORKER = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
const log = msg => document.getElementById("log").innerHTML += `<p>${msg}</p>`;
let cvText = "", history = [], active = false;

/* PDF PARSE */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

document.getElementById("cv").onchange = async e => {
  const file = e.target.files[0];
  const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
  let text = "";
  for (let i=1;i<=pdf.numPages;i++) {
    const p = await pdf.getPage(i);
    const c = await p.getTextContent();
    text += c.items.map(x=>x.str).join(" ")+" ";
  }
  cvText = text.trim();
  log("CV loaded");
  document.getElementById("start").disabled = false;
};

/* START */
document.getElementById("start").onclick = async () => {
  active = true;
  const fd = new FormData();
  fd.append("mode","start");
  fd.append("cvText",cvText);

  const res = await fetch(WORKER,{method:"POST",body:fd});
  const data = await res.json();
  history = data.history;

  speak(data.reply);
};

/* SPEAK */
function speak(text){
  log("<b>AI:</b> "+text);
  const u = new SpeechSynthesisUtterance(text);
  u.onend = record;
  speechSynthesis.speak(u);
}

/* RECORD */
async function record(){
  if(!active) return;
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const rec = new MediaRecorder(stream);
  const chunks = [];
  rec.ondataavailable = e=>chunks.push(e.data);
  rec.onstop = async ()=>{
    stream.getTracks().forEach(t=>t.stop());
    const fd = new FormData();
    fd.append("mode","interview");
    fd.append("audio",new Blob(chunks));
    fd.append("cvText",cvText);
    fd.append("history",JSON.stringify(history));
    const res = await fetch(WORKER,{method:"POST",body:fd});
    const data = await res.json();
    history = data.history;
    speak(data.reply);
  };
  rec.start();
  setTimeout(()=>rec.stop(),6000);
}
</script>
</body>
</html>
