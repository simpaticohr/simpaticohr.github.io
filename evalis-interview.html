<script>
let recognition = null;
let interviewStarted = false;

const candidateProfile = {
  skills: ["ATS", "Client Handling", "Bulk Hiring"]
};

let interview = {
  topicIndex: 0,
  depth: 0,
  maxDepth: 3,
  completed: false
};

function speak(text, callback) {
  document.getElementById("question").innerText = text;
  document.getElementById("status").innerText = "Speaking…";

  const u = new SpeechSynthesisUtterance(text);
  speechSynthesis.cancel();
  speechSynthesis.speak(u);

  u.onend = () => {
    setTimeout(callback, 800);
  };
}

function startListening() {
  if (recognition) recognition.abort();

  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.start();

  document.getElementById("status").innerText = "Listening…";

  recognition.onresult = e => {
    recognition.stop();
    const answer = e.results[0][0].transcript;
    processAnswer(answer);
  };

  recognition.onerror = () => {
    document.getElementById("status").innerText = "Please speak again…";
    setTimeout(startListening, 1000);
  };
}

function analyze(answer) {
  return {
    ownership: /\b(i|my|me)\b/i.test(answer),
    example: /(example|when|project|situation)/i.test(answer),
    impact: /(result|impact|improved|achieved)/i.test(answer)
  };
}

function processAnswer(answer) {
  if (interview.completed) return;

  interview.depth++;
  const s = analyze(answer);

  let followUp;

  if (!s.ownership) {
    followUp = "What was your personal role in this?";
  } else if (!s.example) {
    followUp = "Can you give a specific example?";
  } else if (!s.impact) {
    followUp = "What was the outcome of your work?";
  } else {
    interview.depth = 0;
    interview.topicIndex++;

    if (interview.topicIndex >= candidateProfile.skills.length) {
      interview.completed = true;
      speak("Thank you. The interview is complete.", () => {
        document.getElementById("status").innerText = "";
      });
      return;
    }

    followUp = `How did you use ${candidateProfile.skills[interview.topicIndex]}?`;
  }

  speak(followUp, startListening);
}

function startInterview() {
  if (interviewStarted) return;
  interviewStarted = true;

  document.getElementById("startBtn").style.display = "none";

  const firstQ = `How did you use ${candidateProfile.skills[0]} in your role?`;
  speak(firstQ, startListening);
}
</script>
