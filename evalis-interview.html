<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evalis AI - Live Evaluation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        /* Main Interface */
        .card { width: 90%; max-width: 400px; background: var(--card); border-radius: 24px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; border: 1px solid rgba(255,255,255,0.05); position: relative; z-index: 2; }
        
        /* Timer & Status */
        #timer { font-size: 32px; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums; letter-spacing: -1px; margin: 10px 0; }
        #status { font-size: 13px; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; font-weight: 600; margin-bottom: 20px; min-height: 20px;}
        
        /* Audio Visualizer */
        .vis-container { height: 80px; width: 100%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; }
        canvas { width: 100%; height: 100%; border-radius: 12px; }

        /* Controls */
        .btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 16px; width: 100%; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; transition: transform 0.1s; display: block; }
        .btn:active { transform: scale(0.98); }
        .btn.danger { background: #ef4444; }
        input[type="file"] { margin-bottom: 15px; color: #cbd5e1; font-size: 12px; width: 100%; }
        
        /* Chat Log (Auto-scroll) */
        #log { height: 150px; overflow-y: auto; text-align: left; font-size: 14px; border-top: 1px solid #334155; padding-top: 10px; margin-top: 10px; scroll-behavior: smooth; }
        .msg { margin-bottom: 8px; line-height: 1.4; }
        .msg.ai { color: #a5b4fc; }
        .msg.user { color: #cbd5e1; text-align: right; opacity: 0.7; }

        /* Final Report */
        .report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .score-circle { width: 100px; height: 100px; border-radius: 50%; border: 8px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; margin: 0 auto 20px; }
    </style>
</head>
<body>

<div class="card" id="mainCard">
    <div id="status">Ready</div>
    <div id="timer">15:00</div>
    
    <div class="vis-container">
        <canvas id="canvas"></canvas>
    </div>

    <div id="controls">
        <input type="file" id="cvInput" accept=".pdf">
        <button id="startBtn" class="btn" disabled>Start Interview</button>
    </div>

    <button id="endBtn" class="btn danger" style="display:none">End Session</button>
    
    <div id="log"></div>
</div>

<div id="report" class="report-modal">
    <h2 style="text-align:center">Performance Report</h2>
    <div class="score-circle" id="finalScore">--</div>
    <div id="reportText" style="white-space: pre-wrap; line-height: 1.6; color: #cbd5e1;"></div>
    <button class="btn" onclick="location.reload()" style="margin-top:30px">New Interview</button>
</div>

<script>
// CONFIGURATION
const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev"; // Your Cloudflare Worker URL
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

// STATE
let cvText = "";
let history = [];
let interviewActive = false;
let isAISpeaking = false;
let recognition;
let timeLeft = 900; // 15 minutes
let timerInt;

// 1. PDF HANDLING
document.getElementById("cvInput").addEventListener("change", async (e) => {
    if(e.target.files[0]) {
        document.getElementById("status").innerText = "Parsing PDF...";
        try {
            const data = await e.target.files[0].arrayBuffer();
            const pdf = await pdfjsLib.getDocument(data).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const txt = await page.getTextContent();
                fullText += txt.items.map(s => s.str).join(" ") + " ";
            }
            cvText = fullText;
            document.getElementById("startBtn").disabled = false;
            document.getElementById("startBtn").innerText = "Start Interview";
            document.getElementById("status").innerText = "Resume Loaded";
        } catch (err) {
            alert("Error reading PDF");
        }
    }
});

// 2. AUDIO SYSTEM (Web Audio API for Visualizer)
let audioCtx, analyser, dataArray, canvasCtx;
async function initAudio() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        canvasCtx = document.getElementById("canvas").getContext("2d");
        drawVisualizer();
    } catch(e) {
        console.error("Mic Error", e);
    }
}

function drawVisualizer() {
    if(!interviewActive) return;
    requestAnimationFrame(drawVisualizer);
    analyser.getByteFrequencyData(dataArray);
    canvasCtx.fillStyle = '#1e293b';
    canvasCtx.fillRect(0, 0, 300, 150);
    const barWidth = (document.getElementById("canvas").width / dataArray.length) * 2.5;
    let x = 0;
    for(let i = 0; i < dataArray.length; i++) {
        let barHeight = dataArray[i] / 2;
        canvasCtx.fillStyle = isAISpeaking ? '#a5b4fc' : '#6366f1'; // Purple if AI, Blue if User
        canvasCtx.fillRect(x, 80 - barHeight/2, barWidth, barHeight);
        x += barWidth + 1;
    }
}

// 3. SPEECH RECOGNITION (STT)
function initSpeech() {
    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new Speech();
    recognition.continuous = false; // False is better for mobile to force restart on silence
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => { document.getElementById("status").innerText = "Listening..."; };
    
    recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        addLog(transcript, "user");
        await sendToAI(transcript);
    };

    recognition.onend = () => {
        // Auto-restart if interview is active and AI isn't talking
        if (interviewActive && !isAISpeaking) {
            try { recognition.start(); } catch(e){}
        }
    };
}

// 4. TEXT TO SPEECH (TTS)
function speak(text) {
    isAISpeaking = true;
    if(recognition) recognition.stop(); // Stop listening so AI doesn't hear itself
    document.getElementById("status").innerText = "Interviewer Speaking...";
    
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 1.1;
    utter.pitch = 1.0;
    
    utter.onend = () => {
        isAISpeaking = false;
        if(interviewActive) {
            try { recognition.start(); } catch(e){}
        }
    };
    
    window.speechSynthesis.speak(utter);
    addLog(text, "ai");
}

// 5. API COMMUNICATION
async function sendToAI(userText, mode="interview") {
    document.getElementById("status").innerText = "Thinking...";
    
    const formData = new FormData();
    formData.append("mode", mode);
    formData.append("cvText", cvText);
    formData.append("history", JSON.stringify(history));
    formData.append("text", userText || "");

    try {
        const res = await fetch(WORKER_URL, { method: "POST", body: formData });
        const data = await res.json();
        
        if (mode === "score") {
            showReport(data.reply);
        } else {
            history = data.history;
            speak(data.reply);
        }
    } catch (e) {
        document.getElementById("status").innerText = "Connection Error";
    }
}

function addLog(text, role) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    div.innerText = (role === "ai" ? "AI: " : "You: ") + text;
    const log = document.getElementById("log");
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

// 6. CONTROL LOGIC
document.getElementById("startBtn").onclick = async () => {
    // Need user gesture for audio
    await initAudio();
    initSpeech();
    
    document.getElementById("controls").style.display = "none";
    document.getElementById("endBtn").style.display = "block";
    
    interviewActive = true;
    startTimer();
    
    // Trigger "Start" mode on backend
    sendToAI("", "start");
};

document.getElementById("endBtn").onclick = () => {
    interviewActive = false;
    clearInterval(timerInt);
    window.speechSynthesis.cancel();
    recognition.stop();
    sendToAI("", "score");
};

function startTimer() {
    timerInt = setInterval(() => {
        timeLeft--;
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        document.getElementById("timer").innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        if(timeLeft <= 0) document.getElementById("endBtn").click();
    }, 1000);
}

function showReport(markdownReport) {
    document.getElementById("mainCard").style.display = "none";
    document.getElementById("report").style.display = "block";
    
    // Simple regex to find a score (e.g., "Score: 85/100")
    const scoreMatch = markdownReport.match(/(\d+)\/100/);
    if(scoreMatch) document.getElementById("finalScore").innerText = scoreMatch[1];
    
    document.getElementById("reportText").innerText = markdownReport;
}
</script>
</body>
</html>
