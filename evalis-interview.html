<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evalis AI â€“ Live Interview</title>

<style>
:root { --primary:#6366f1; --bg:#020617; }
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:system-ui,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:90%;
  max-width:460px;
  background:rgba(255,255,255,.06);
  border-radius:22px;
  padding:26px;
  text-align:center;
}
.btn{
  width:100%;
  padding:16px;
  margin-top:12px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:700;
  background:var(--primary);
  color:white;
}
.btn.secondary{ background:#0f172a }
#log{
  margin-top:20px;
  max-height:240px;
  overflow:auto;
  text-align:left;
  font-size:14px;
}
.msg{ margin-bottom:8px }
.msg b{ color:#a5b4fc }
</style>
</head>

<body>

<div class="card">
  <h2>Evalis AI Interview</h2>
  <p id="status">Tap Start â†’ then Speak</p>

  <button id="startBtn" class="btn">â–¶ Start Interview</button>
  <button id="micBtn" class="btn secondary" disabled>ðŸŽ¤ Speak</button>

  <div id="log"></div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

/* ================= STATE ================= */
let recognition;
let audioUnlocked = false;
let history = [];

/* ================= UI ================= */
function addMsg(who, text){
  const d = document.createElement("div");
  d.className = "msg";
  d.innerHTML = `<b>${who}:</b> ${text}`;
  document.getElementById("log").prepend(d);
}

/* ================= AUDIO UNLOCK (CRITICAL) ================= */
function unlockAudio(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  const u = new SpeechSynthesisUtterance(" ");
  speechSynthesis.speak(u);
}

/* ================= AI SPEAK ================= */
function speakAI(text){
  unlockAudio();
  speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = 1;

  const voices = speechSynthesis.getVoices();
  u.voice = voices.find(v => v.lang.startsWith("en")) || voices[0];

  speechSynthesis.speak(u);
}

/* ================= MIC ================= */
function initMic(){
  if(!("webkitSpeechRecognition" in window)){
    alert("Voice not supported on this browser");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = e => {
    const text = e.results[0][0].transcript;
    handleUserText(text);
  };

  recognition.onerror = e => {
    console.error("Mic error:", e);
  };
}

/* ================= SEND USER TEXT ================= */
async function handleUserText(text){
  addMsg("You", text);

  const res = await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      messages:[
        ...history,
        { role:"user", content:text }
      ]
    })
  });

  const data = await res.json();
  history.push({ role:"user", content:text });
  history.push({ role:"assistant", content:data.reply });

  addMsg("AI", data.reply);
  speakAI(data.reply);
}

/* ================= START ================= */
document.getElementById("startBtn").onclick = async ()=>{
  unlockAudio();
  initMic();
  document.getElementById("micBtn").disabled = false;
  document.getElementById("status").textContent = "Interview Started";

  const res = await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      messages:[
        { role:"system", content:"You are a professional interviewer. Ask short, clear questions." },
        { role:"user", content:"Start the interview." }
      ]
    })
  });

  const data = await res.json();
  history.push({ role:"assistant", content:data.reply });
  addMsg("AI", data.reply);
  speakAI(data.reply);
};

/* ================= MIC BUTTON ================= */
document.getElementById("micBtn").onclick = ()=>{
  unlockAudio();
  recognition.start();
};
</script>

</body>
</html>
