<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Simpatico HR ‚Äî AI Interview Intelligence</title>
<meta name="theme-color" content="#050510">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root{--primary:#6366f1;--primary-glow:rgba(99,102,241,.25);--accent:#06d6a0;--accent-glow:rgba(6,214,160,.25);--danger:#ef4444;--warning:#f59e0b;--bg-0:#050510;--bg-2:#111128;--border:rgba(255,255,255,.06);--border-hover:rgba(255,255,255,.12);--text:#f0f0ff;--text-dim:#8888aa;--text-muted:#555577;--glass:rgba(255,255,255,.03);--glass-border:rgba(255,255,255,.08);--radius:16px;--radius-sm:12px;--radius-xs:8px}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',-apple-system,system-ui,sans-serif;background:var(--bg-0);color:var(--text);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:4px}
  .bg-anim{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .bg-anim .orb{position:absolute;border-radius:50%;filter:blur(100px);opacity:.12;animation:orbF 25s ease-in-out infinite}
  .orb-1{width:600px;height:600px;background:var(--primary);top:-200px;left:-100px}
  .orb-2{width:400px;height:400px;background:var(--accent);bottom:-100px;right:-100px;animation-delay:-8s}
  .orb-3{width:300px;height:300px;background:#a855f7;top:50%;left:50%;transform:translate(-50%,-50%);animation-delay:-16s}
  @keyframes orbF{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(40px,-30px) scale(1.08)}66%{transform:translate(-30px,25px) scale(.95)}}
  .z1{position:relative;z-index:1}
  .glass-card{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px)}
  .auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;gap:28px;padding:24px;text-align:center}
  .brand{display:flex;flex-direction:column;align-items:center;gap:10px}
  .brand-icon{width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 0 50px var(--primary-glow);animation:bf 3s ease-in-out infinite}
  @keyframes bf{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  .brand h1{font-size:2.2rem;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .brand p{color:var(--text-dim);font-size:.9rem}
  .auth-card{width:100%;max-width:440px;padding:36px 30px;display:flex;flex-direction:column;gap:22px}
  .field-group{display:flex;flex-direction:column;gap:6px;text-align:left}
  .field-label{font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px}
  .field-input{width:100%;padding:14px 18px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);font-size:16px;font-family:'JetBrains Mono',monospace;letter-spacing:1.5px;text-align:center;outline:none;transition:all .3s}
  .field-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
  .field-input::placeholder{color:var(--text-muted);font-family:'Inter',sans-serif;letter-spacing:0}
  .upload-zone{border:2px dashed var(--border-hover);border-radius:var(--radius-sm);padding:30px;text-align:center;cursor:pointer;transition:all .3s}
  .upload-zone:hover,.upload-zone.dragover{border-color:var(--primary);background:rgba(99,102,241,.04)}
  .upload-zone.loaded{border-color:var(--accent);border-style:solid;background:rgba(6,214,160,.04)}
  .upload-icon{font-size:2.2rem;margin-bottom:8px;display:block}
  .upload-text{font-size:.9rem;color:var(--text-dim)}
  .upload-file{font-size:.8rem;color:var(--text-muted);margin-top:6px}
  .btn{padding:14px 24px;border-radius:var(--radius-sm);border:none;font-size:.95rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px;-webkit-tap-highlight-color:transparent;user-select:none}
  .btn:active{transform:scale(.97)}.btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
  .btn-primary{background:linear-gradient(135deg,var(--primary),#8b5cf6);color:#fff;box-shadow:0 4px 24px var(--primary-glow)}
  .btn-primary:hover:not(:disabled){box-shadow:0 6px 32px rgba(99,102,241,.4);transform:translateY(-1px)}
  .btn-accent{background:linear-gradient(135deg,var(--accent),#34d399);color:#000;box-shadow:0 4px 24px var(--accent-glow)}
  .btn-danger{background:rgba(239,68,68,.15);color:var(--danger);border:1px solid rgba(239,68,68,.25)}
  .btn-danger:hover:not(:disabled){background:rgba(239,68,68,.25)}
  .btn-ghost{background:rgba(255,255,255,.05);color:var(--text);border:1px solid var(--border)}
  .btn-ghost:hover:not(:disabled){background:rgba(255,255,255,.08)}
  .btn-sm{padding:10px 16px;font-size:.85rem}.btn-lg{padding:16px 32px;font-size:1.05rem}

  /* Recording pulse */
  .btn-recording{background:linear-gradient(135deg,var(--danger),#dc2626)!important;color:#fff!important;border:none!important;animation:recPulse 1.5s infinite}
  @keyframes recPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 12px rgba(239,68,68,0)}}

  .interview-screen{display:none}.interview-screen.active{display:block}
  .topbar{position:sticky;top:0;z-index:100;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;background:rgba(5,5,16,.88);backdrop-filter:blur(24px);border-bottom:1px solid var(--border)}
  .topbar-brand{display:flex;align-items:center;gap:10px}
  .topbar-logo{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:14px}
  .topbar-name{font-weight:700;font-size:.95rem}
  .topbar-meta{display:flex;align-items:center;gap:14px}
  .timer{font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:600;color:var(--primary);background:rgba(99,102,241,.1);padding:5px 12px;border-radius:20px}
  .status-badge{font-size:.78rem;font-weight:600;padding:4px 12px;border-radius:20px;transition:all .3s}
  .status-idle{background:rgba(85,85,119,.2);color:var(--text-muted)}
  .status-recording{background:rgba(239,68,68,.15);color:var(--danger)}
  .status-speaking{background:rgba(99,102,241,.15);color:var(--primary)}
  .status-processing{background:rgba(245,158,11,.15);color:var(--warning)}

  .chat-area{max-width:740px;margin:0 auto;padding:16px 20px 260px;min-height:calc(100dvh - 60px)}
  .msg{margin-bottom:18px;max-width:85%;animation:msgS .35s cubic-bezier(.175,.885,.32,1.275)}
  @keyframes msgS{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
  .msg-label{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;opacity:.55}
  .msg-bubble{padding:16px 20px;border-radius:var(--radius);line-height:1.65;font-size:.93rem}
  .msg.ai{margin-right:auto}.msg.ai .msg-label{color:var(--primary)}
  .msg.ai .msg-bubble{background:linear-gradient(135deg,rgba(99,102,241,.07),rgba(139,92,246,.04));border:1px solid rgba(99,102,241,.12);border-bottom-left-radius:4px}
  .msg.user{margin-left:auto}.msg.user .msg-label{color:var(--accent);text-align:right}
  .msg.user .msg-bubble{background:linear-gradient(135deg,rgba(6,214,160,.07),rgba(52,211,153,.04));border:1px solid rgba(6,214,160,.12);border-bottom-right-radius:4px}

  .typing-wrap{display:none;margin-bottom:18px}.typing-wrap.active{display:block}
  .typing-dots{display:flex;gap:5px;padding:16px 20px;background:linear-gradient(135deg,rgba(99,102,241,.07),rgba(139,92,246,.04));border:1px solid rgba(99,102,241,.12);border-radius:var(--radius);border-bottom-left-radius:4px;width:fit-content}
  .typing-dots span{width:8px;height:8px;border-radius:50%;background:var(--primary);animation:dotB 1.4s infinite}
  .typing-dots span:nth-child(2){animation-delay:.15s}.typing-dots span:nth-child(3){animation-delay:.3s}
  @keyframes dotB{0%,60%,100%{transform:translateY(0);opacity:.25}30%{transform:translateY(-10px);opacity:1}}

  .dock{position:fixed;bottom:0;left:0;right:0;z-index:100;background:linear-gradient(to top,var(--bg-0) 65%,transparent);padding:24px 16px 16px;padding-bottom:calc(env(safe-area-inset-bottom,16px) + 16px)}
  .dock-inner{max-width:740px;margin:0 auto;display:flex;flex-direction:column;gap:12px;align-items:center}

  .live-box{width:100%;min-height:46px;padding:12px 18px;border-radius:var(--radius-sm);background:rgba(0,0,0,.4);border:1px solid var(--border);font-size:.9rem;color:var(--text-muted);text-align:center;transition:all .3s}
  .live-box.recording{color:var(--danger);border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.04)}
  .live-box.speaking{color:var(--primary);border-color:rgba(99,102,241,.2)}

  .viz{display:flex;gap:2px;align-items:center;height:28px}
  .viz .vb{width:3px;border-radius:2px;background:var(--danger);height:4px;transition:height .06s ease;opacity:.8}

  .dock-row{display:flex;gap:10px;width:100%}.dock-row .btn{flex:1}

  .fallback-row{display:none;width:100%;gap:8px}.fallback-row.active{display:flex}
  .fallback-input{flex:1;padding:14px 16px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);font-size:16px;font-family:inherit;outline:none}
  .fallback-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
  .score-row{display:none;width:100%}.score-row.active{display:flex}

  .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120px);padding:14px 28px;border-radius:var(--radius-sm);font-size:.9rem;font-weight:500;z-index:9999;transition:transform .5s cubic-bezier(.175,.885,.32,1.275);pointer-events:none;background:var(--bg-2);border:1px solid var(--border-hover);box-shadow:0 12px 48px rgba(0,0,0,.6);backdrop-filter:blur(20px)}
  .toast.show{transform:translateX(-50%) translateY(0)}

  .admin-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);align-items:center;justify-content:center;padding:24px}
  .admin-overlay.active{display:flex}
  .admin-panel{width:100%;max-width:480px;padding:32px;max-height:85dvh;overflow-y:auto}
  .admin-panel h2{font-size:1.3rem;font-weight:700;margin-bottom:24px;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .admin-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border)}.admin-section:last-child{border-bottom:none}
  .admin-label{font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.6px;margin-bottom:10px}
  .code-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .code-item{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(0,0,0,.3);border-radius:var(--radius-xs);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:.85rem}
  .code-item-meta{font-family:'Inter',sans-serif;font-size:.75rem;color:var(--text-dim)}
  .select-field{width:100%;padding:12px 14px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);font-size:14px;font-family:inherit;outline:none}

  .score-card{padding:28px;margin-bottom:18px;max-width:100%}.score-header{text-align:center;margin-bottom:24px}
  .score-big{font-size:4rem;font-weight:800;line-height:1;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .score-verdict{font-size:.95rem;color:var(--text-dim);margin-top:6px}
  .dim-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:20px 0}
  .dim-item{padding:14px;border-radius:var(--radius-xs);background:rgba(0,0,0,.3);border:1px solid var(--border)}
  .dim-name{font-size:.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px}
  .dim-score{font-size:1.7rem;font-weight:700;margin:4px 0}
  .dim-bar{height:4px;border-radius:2px;background:rgba(255,255,255,.06);overflow:hidden}
  .dim-fill{height:100%;border-radius:2px;transition:width 1.2s cubic-bezier(.4,0,.2,1)}
  .score-sect{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
  .score-sect h4{font-size:.78rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
  .score-sect ul{list-style:none;display:flex;flex-direction:column;gap:8px}
  .score-sect li{font-size:.9rem;color:var(--text);line-height:1.5;padding-left:18px;position:relative}
  .score-sect li::before{content:'';position:absolute;left:0;top:8px;width:6px;height:6px;border-radius:50%}
  .list-green li::before{background:var(--accent)}.list-red li::before{background:var(--danger)}.list-yellow li::before{background:var(--warning)}
  .rec-badge{display:inline-block;padding:10px 24px;border-radius:24px;font-weight:700;font-size:.95rem;margin-top:8px}
  .rec-strong-hire{background:rgba(6,214,160,.12);color:var(--accent);border:1px solid rgba(6,214,160,.25)}
  .rec-hire{background:rgba(52,211,153,.1);color:#34d399;border:1px solid rgba(52,211,153,.2)}
  .rec-lean-hire{background:rgba(245,158,11,.1);color:var(--warning);border:1px solid rgba(245,158,11,.2)}
  .rec-lean-no{background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15)}
  .rec-no-hire{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.25)}
  @media(max-width:480px){.msg{max-width:93%}.msg-bubble{padding:14px 16px;font-size:.9rem}.auth-card{padding:28px 22px}.dim-grid{grid-template-columns:1fr}.brand h1{font-size:1.8rem}.chat-area{padding:12px 14px 280px}}
</style>
</head>
<body>
<div class="bg-anim"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div></div>
<div class="toast" id="toast"></div>

<div class="admin-overlay" id="adminOverlay">
  <div class="admin-panel glass-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
      <h2 style="margin:0">‚öôÔ∏è Admin Panel</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeAdmin()">‚úï</button>
    </div>
    <div class="admin-section">
      <div class="admin-label">Generate Code</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <input type="text" class="field-input" id="adminLabel" placeholder="Label" style="letter-spacing:0;text-align:left;font-family:inherit">
        <div style="display:flex;gap:10px">
          <select class="select-field" id="adminDuration"><option value="1">1h</option><option value="6">6h</option><option value="24" selected>24h</option><option value="72">3d</option><option value="168">7d</option><option value="720">30d</option></select>
          <button class="btn btn-primary btn-sm" onclick="adminGen()">Generate</button>
        </div>
      </div>
      <div id="adminResult" style="margin-top:12px"></div>
    </div>
    <div class="admin-section">
      <div class="admin-label">Active Codes</div>
      <button class="btn btn-ghost btn-sm" onclick="adminList()" style="width:100%;margin-top:6px">üîÑ Refresh</button>
      <div class="code-list" id="codeList"></div>
    </div>
  </div>
</div>

<div class="z1">

<div class="auth-screen" id="authScreen">
  <div class="brand">
    <div class="brand-icon">üß†</div>
    <h1>Simpatico HR</h1>
    <p>AI-Powered Interview Intelligence</p>
  </div>
  <div class="auth-card glass-card">
    <div class="field-group">
      <label class="field-label">Access Code</label>
      <input type="text" class="field-input" id="accessCode" placeholder="Enter code" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
    <div class="field-group">
      <label class="field-label">Resume</label>
      <div class="upload-zone" id="uploadArea" onclick="document.getElementById('cvFile').click()">
        <input type="file" id="cvFile" accept=".pdf,.txt,.doc,.docx" hidden>
        <span class="upload-icon">üìÑ</span>
        <div class="upload-text">Drop resume or click to upload</div>
        <div class="upload-file" id="fileName">PDF, TXT, DOC</div>
      </div>
    </div>
    <button class="btn btn-primary btn-lg" style="width:100%" onclick="startInterview()" id="btnStart">üéôÔ∏è Begin Interview</button>
    <button class="btn btn-ghost btn-sm" id="adminBtn" style="width:100%;display:none" onclick="openAdmin()">‚öôÔ∏è Admin</button>
    <p style="text-align:center;font-size:.72rem;color:var(--text-muted);margin-top:4px">Powered by Simpatico HR Consultancy</p>
  </div>
</div>

<div class="interview-screen" id="interviewScreen">
  <div class="topbar">
    <div class="topbar-brand"><div class="topbar-logo">üß†</div><span class="topbar-name">Simpatico HR</span></div>
    <div class="topbar-meta">
      <span class="timer" id="timer">00:00</span>
      <span class="status-badge status-idle" id="statusBadge">Ready</span>
    </div>
  </div>
  <div class="chat-area" id="chatArea">
    <div class="typing-wrap" id="typingWrap"><div class="typing-dots"><span></span><span></span><span></span></div></div>
  </div>
  <div class="dock">
    <div class="dock-inner">
      <div class="live-box" id="liveBox">Tap the mic to start recording your answer</div>
      <div class="viz" id="viz"></div>
      <div class="dock-row" id="voiceRow">
        <button class="btn btn-primary btn-lg" id="btnRecord" onclick="toggleRecord()" style="width:100%">
          üéôÔ∏è Hold to Answer
        </button>
      </div>
      <div class="dock-row" id="endRow">
        <button class="btn btn-danger" onclick="endInterview()" style="flex:none;padding:14px 20px">‚èπÔ∏è End Interview</button>
      </div>
      <div class="fallback-row" id="fallbackRow">
        <input type="text" class="fallback-input" id="fallbackInput" placeholder="Type your answer..." enterkeyhint="send">
        <button class="btn btn-primary" style="flex:none" onclick="sendFallback()">‚û§</button>
        <button class="btn btn-danger" style="flex:none" onclick="endInterview()">‚èπÔ∏è</button>
      </div>
      <div class="dock-row score-row" id="scoreRow">
        <button class="btn btn-accent btn-lg" style="width:100%" onclick="getScore()">üìä Generate Report</button>
      </div>
    </div>
  </div>
</div>

</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const WORKER = "https://evalis-ai.simpaticohrconsultancy.workers.dev";

// ============================================================
// STATE
// ============================================================
let accessCode = "", cvText = "", history = [];
let timerRef = null, secs = 0, isActive = false, isSending = false;

// ============================================================
// ‚òÖ MEDIA RECORDER ‚Äî Works on ALL browsers, no SpeechRecognition
// ============================================================
let micStream = null;
let recorder = null;
let audioChunks = [];
let isRecording = false;
let audioCtx = null, analyser = null, animFrame = null;
let silenceTimer = null;
let recordingStartTime = 0;

// Silence detection
let silenceStart = 0;
const SILENCE_THRESHOLD = 15;  // volume level below which = silence
const SILENCE_DURATION = 2500; // 2.5s silence = auto-stop

async function initMic() {
  try {
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true,
        sampleRate: 16000
      }
    });
    console.log("[MIC] ‚úÖ Got mic stream");

    // Audio context for visualizer + silence detection
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    audioCtx.createMediaStreamSource(micStream).connect(analyser);

    return true;
  } catch(e) {
    console.error("[MIC] ‚ùå Denied:", e);
    showToast("üéôÔ∏è Mic access denied");
    return false;
  }
}

function startRecording() {
  if (!micStream || isRecording) return;

  audioChunks = [];
  // Use webm/opus ‚Äî widely supported, good quality, small files
  const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
    ? 'audio/webm;codecs=opus'
    : MediaRecorder.isTypeSupported('audio/webm')
      ? 'audio/webm'
      : 'audio/mp4';

  recorder = new MediaRecorder(micStream, { mimeType });

  recorder.ondataavailable = (e) => {
    if (e.data.size > 0) audioChunks.push(e.data);
  };

  recorder.onstop = async () => {
    isRecording = false;
    cancelAnimationFrame(animFrame);
    clearInterval(silenceTimer);
    updateRecordUI(false);

    if (audioChunks.length === 0) {
      console.log("[REC] No audio data");
      setStatus("idle", "Ready");
      return;
    }

    const blob = new Blob(audioChunks, { type: recorder.mimeType });
    const duration = (Date.now() - recordingStartTime) / 1000;
    console.log(`[REC] Stopped. Duration: ${duration.toFixed(1)}s, Size: ${(blob.size/1024).toFixed(1)}KB`);

    if (duration < 0.8 || blob.size < 1000) {
      console.log("[REC] Too short, ignoring");
      setLiveBox("Recording too short ‚Äî try again");
      setStatus("idle", "Ready");
      return;
    }

    // Transcribe via Whisper
    await transcribeAndSend(blob);
  };

  recorder.start(250); // collect data every 250ms
  isRecording = true;
  recordingStartTime = Date.now();
  silenceStart = 0;
  updateRecordUI(true);
  setStatus("recording", "üî¥ Recording");
  setLiveBox("üî¥ Recording... speak now");
  startVisualizer();
  startSilenceDetection();
  console.log("[REC] ‚úÖ Started recording");
}

function stopRecording() {
  if (!recorder || !isRecording) return;
  console.log("[REC] Stopping...");
  recorder.stop();
}

function toggleRecord() {
  if (isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
}

function updateRecordUI(recording) {
  const btn = document.getElementById("btnRecord");
  if (recording) {
    btn.innerHTML = "‚èπÔ∏è Stop Recording";
    btn.className = "btn btn-recording btn-lg";
  } else {
    btn.innerHTML = "üéôÔ∏è Tap to Answer";
    btn.className = "btn btn-primary btn-lg";
  }
}

// ============================================================
// VISUALIZER + SILENCE DETECTION
// ============================================================
function startVisualizer() {
  if (!analyser) return;

  function draw() {
    if (!isRecording) return;
    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);

    const bars = document.querySelectorAll("#viz .vb");
    if (bars.length) {
      const step = Math.floor(data.length / bars.length);
      for (let i = 0; i < bars.length; i++) {
        const v = data[i * step] || 0;
        bars[i].style.height = Math.max(3, (v / 255) * 34) + "px";
      }
    }
    animFrame = requestAnimationFrame(draw);
  }
  draw();
}

function startSilenceDetection() {
  silenceTimer = setInterval(() => {
    if (!isRecording || !analyser) return;

    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);

    // Average volume
    let sum = 0;
    for (let i = 0; i < data.length; i++) sum += data[i];
    const avg = sum / data.length;

    const elapsed = Date.now() - recordingStartTime;

    if (avg < SILENCE_THRESHOLD && elapsed > 1500) {
      // Silence detected
      if (!silenceStart) silenceStart = Date.now();
      const silentFor = Date.now() - silenceStart;

      if (silentFor > 500) {
        const remaining = Math.max(0, SILENCE_DURATION - silentFor);
        setLiveBox(`üî¥ Recording... (auto-send in ${(remaining/1000).toFixed(1)}s)`);
      }

      if (silentFor >= SILENCE_DURATION) {
        console.log("[SILENCE] Auto-stopping after 2.5s silence");
        stopRecording();
      }
    } else {
      silenceStart = 0;
      if (isRecording) {
        const dur = ((Date.now() - recordingStartTime) / 1000).toFixed(0);
        setLiveBox(`üî¥ Recording... ${dur}s`);
      }
    }
  }, 200);
}

// ============================================================
// TRANSCRIBE & SEND
// ============================================================
async function transcribeAndSend(blob) {
  if (isSending) return;
  isSending = true;

  setStatus("processing", "‚è≥ Transcribing...");
  setLiveBox("‚è≥ Transcribing your answer...");
  showTyping(true);

  try {
    // Send audio to Whisper
    const fd = new FormData();
    fd.append("mode", "transcribe");
    fd.append("accessCode", accessCode);
    fd.append("audio", blob, "audio.webm");

    const res = await fetch(WORKER, { method: "POST", body: fd });
    const data = await res.json();

    const text = data.text || "";
    console.log("[WHISPER] Transcribed:", text);

    if (!text.trim() || text.trim().length < 2) {
      showTyping(false);
      setLiveBox("Couldn't hear you ‚Äî try again");
      setStatus("idle", "Ready");
      isSending = false;
      return;
    }

    // Show user message
    addMsg("user", text);
    setLiveBox("‚è≥ AI is thinking...");

    // Get AI response
    const aiRes = await api("interview", { userMessage: text });
    showTyping(false);
    history = aiRes.history || history;
    addMsg("ai", aiRes.reply);

    // Speak AI response, then ready for next recording
    speak(aiRes.reply, () => {
      setStatus("idle", "Ready");
      setLiveBox("üéôÔ∏è Tap the mic to answer");
    });

  } catch(e) {
    console.error("[ERROR]", e);
    showTyping(false);
    setLiveBox("Error ‚Äî try again");
    setStatus("idle", "Ready");
  }

  isSending = false;
}

// ============================================================
// TTS
// ============================================================
let ttsWD = null, ttsPoll = null, ttsKA = null;

function speak(text, onDone) {
  if (!('speechSynthesis' in window)) { if (onDone) onDone(); return; }

  setStatus("speaking", "üîä AI Speaking");
  setLiveBox("üîä AI is speaking...");

  speechSynthesis.cancel();
  clearTimeout(ttsWD); clearInterval(ttsPoll); clearInterval(ttsKA);

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.05; u.pitch = 1; u.volume = 1;

  const voices = speechSynthesis.getVoices();
  const pref = voices.find(v => v.name.includes("Samantha") || v.name.includes("Google US") || v.name.includes("Microsoft Aria") || (v.lang==="en-US" && v.localService));
  if (pref) u.voice = pref;

  let done = false;
  function finish() {
    if (done) return; done = true;
    clearTimeout(ttsWD); clearInterval(ttsPoll); clearInterval(ttsKA);
    speechSynthesis.cancel();
    console.log("[TTS] ‚úÖ Done");
    if (onDone) onDone();
  }

  u.onend = finish;
  u.onerror = finish;

  const est = Math.max(text.length * 90, 3000) + 2000;
  ttsWD = setTimeout(finish, est);

  let pc = 0;
  ttsPoll = setInterval(() => { pc++; if (!speechSynthesis.speaking && pc > 3) { clearInterval(ttsPoll); finish(); } if (pc > est/400+5) { clearInterval(ttsPoll); finish(); } }, 400);

  ttsKA = setInterval(() => { if (speechSynthesis.speaking && !speechSynthesis.paused) { speechSynthesis.pause(); speechSynthesis.resume(); } else if (!speechSynthesis.speaking) { clearInterval(ttsKA); } }, 5000);

  speechSynthesis.speak(u);
  console.log("[TTS] üîä", text.substring(0, 60));
}

if ('speechSynthesis' in window) { speechSynthesis.getVoices(); speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices(); }

// ============================================================
// UI
// ============================================================
function initViz() {
  const v = document.getElementById("viz"); v.innerHTML = "";
  for (let i = 0; i < 32; i++) { const b = document.createElement("div"); b.className = "vb"; v.appendChild(b); }
}

function setLiveBox(text) {
  const el = document.getElementById("liveBox");
  el.textContent = text;
  el.className = "live-box" + (isRecording ? " recording" : "");
}

function setStatus(type, text) {
  const el = document.getElementById("statusBadge");
  el.textContent = text;
  el.className = "status-badge status-" + type;
}

function addMsg(role, text) {
  const area = document.getElementById("chatArea");
  const typing = document.getElementById("typingWrap");
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.innerHTML = `<div class="msg-label">${role==="ai"?"üß† Simpatico HR":"üë§ You"}</div><div class="msg-bubble">${esc(text)}</div>`;
  area.insertBefore(div, typing);
  area.scrollTop = area.scrollHeight;
}

function esc(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function showTyping(s) {
  document.getElementById("typingWrap").className = s ? "typing-wrap active" : "typing-wrap";
  if (s) document.getElementById("chatArea").scrollTop = document.getElementById("chatArea").scrollHeight;
}

function startTimer() {
  secs = 0;
  timerRef = setInterval(() => { secs++; document.getElementById("timer").textContent = String(Math.floor(secs/60)).padStart(2,"0")+":"+String(secs%60).padStart(2,"0"); }, 1000);
}

function showToast(msg) { const t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 3500); }

// ============================================================
// API
// ============================================================
async function api(mode, extra = {}) {
  const fd = new FormData();
  fd.append("mode", mode); fd.append("accessCode", accessCode);
  fd.append("cvText", cvText); fd.append("history", JSON.stringify(history));
  for (const [k,v] of Object.entries(extra)) fd.append(k, v);
  const res = await fetch(WORKER, { method: "POST", body: fd });
  const data = await res.json();
  if (!res.ok) { showToast(data.reply || "Error"); throw new Error(data.reply); }
  return data;
}

// ============================================================
// CV UPLOAD
// ============================================================
document.getElementById("cvFile").addEventListener("change", async e => {
  const file = e.target.files[0]; if (!file) return;
  document.getElementById("fileName").textContent = "‚úÖ " + file.name;
  document.getElementById("uploadArea").classList.add("loaded");
  if (file.type === "text/plain") cvText = await file.text();
  else if (file.type === "application/pdf") { try { const b = await file.arrayBuffer(); const t = new TextDecoder().decode(b); const p = t.match(/[\x20-\x7E]{4,}/g); cvText = p ? p.join(" ").substring(0,4000) : "[PDF]"; } catch(e) { cvText = "[PDF]"; } }
  else cvText = "[File: " + file.name + "]";
  showToast("‚úÖ Resume loaded!");
});

const ua = document.getElementById("uploadArea");
ua.addEventListener("dragover", e => { e.preventDefault(); ua.classList.add("dragover"); });
ua.addEventListener("dragleave", () => ua.classList.remove("dragover"));
ua.addEventListener("drop", e => { e.preventDefault(); ua.classList.remove("dragover"); if (e.dataTransfer.files[0]) { document.getElementById("cvFile").files = e.dataTransfer.files; document.getElementById("cvFile").dispatchEvent(new Event("change")); } });

document.getElementById("accessCode").addEventListener("input", e => {
  document.getElementById("adminBtn").style.display = e.target.value.trim() === "ADMIN-MASTER-999" ? "flex" : "none";
});

// ============================================================
// ‚òÖ INTERVIEW FLOW
// ============================================================
async function startInterview() {
  accessCode = document.getElementById("accessCode").value.trim();
  if (!accessCode) { showToast("‚ö†Ô∏è Enter access code"); return; }

  const btn = document.getElementById("btnStart");
  btn.disabled = true; btn.innerHTML = "‚è≥ Connecting...";

  // Get mic from user click
  const micOk = await initMic();

  try {
    const data = await api("start");

    document.getElementById("authScreen").style.display = "none";
    document.getElementById("interviewScreen").classList.add("active");
    isActive = true;
    history = data.history || [];
    startTimer();
    initViz();
    addMsg("ai", data.reply);

    if (!micOk) {
      // Fallback to text
      document.getElementById("voiceRow").style.display = "none";
      document.getElementById("endRow").style.display = "none";
      document.getElementById("fallbackRow").className = "fallback-row active";
      document.getElementById("liveBox").textContent = "‚å®Ô∏è Type your answers below";
      document.getElementById("viz").style.display = "none";
    }

    // Speak AI greeting
    speak(data.reply, () => {
      setStatus("idle", "Ready");
      setLiveBox("üéôÔ∏è Tap the mic to answer");
    });

  } catch(e) {
    console.error(e);
    btn.disabled = false; btn.innerHTML = "üéôÔ∏è Begin Interview";
  }
}

function sendFallback() {
  const input = document.getElementById("fallbackInput");
  const text = input.value.trim();
  if (!text || isSending) return;
  isSending = true; input.value = "";
  addMsg("user", text); showTyping(true);
  setStatus("processing", "‚è≥ Processing");

  api("interview", { userMessage: text }).then(data => {
    showTyping(false); history = data.history || history;
    addMsg("ai", data.reply);
    speak(data.reply, () => { setStatus("idle", "Ready"); });
    isSending = false;
  }).catch(() => { showTyping(false); isSending = false; setStatus("idle", "Ready"); });
}

function endInterview() {
  isActive = false;
  if (isRecording) stopRecording();
  clearInterval(timerRef);
  speechSynthesis.cancel();
  clearTimeout(ttsWD); clearInterval(ttsPoll); clearInterval(ttsKA);
  setStatus("idle", "Ended");

  document.getElementById("voiceRow").style.display = "none";
  document.getElementById("endRow").style.display = "none";
  document.getElementById("fallbackRow").className = "fallback-row";
  document.getElementById("liveBox").style.display = "none";
  document.getElementById("viz").style.display = "none";
  document.getElementById("scoreRow").className = "dock-row score-row active";
  addMsg("ai", "Interview complete. Generate your report below.");
  showToast("‚èπÔ∏è Interview ended");
}

async function getScore() {
  document.getElementById("scoreRow").className = "dock-row score-row";
  showTyping(true); showToast("üìä Analyzing...");
  try {
    const data = await api("score");
    showTyping(false); renderScore(data.reply);
  } catch(e) { showTyping(false); addMsg("ai", "Failed. Try again."); document.getElementById("scoreRow").className = "dock-row score-row active"; }
}

// ============================================================
// SCORE RENDERER
// ============================================================
function renderScore(raw) {
  const area = document.getElementById("chatArea"), typing = document.getElementById("typingWrap");
  const oM = raw.match(/OVERALL SCORE:\s*(\d+)/i), oS = oM ? parseInt(oM[1]) : null;
  const vM = raw.match(/OVERALL SCORE:\s*\d+\/?1?0?0?\s*[‚Äî\-‚Äì]\s*(.+)/i), verdict = vM ? vM[1].trim() : "";
  const dims = [];
  [{n:"Technical Depth",p:/Technical Depth:\s*(\d+)/i},{n:"Communication",p:/Communication:\s*(\d+)/i},{n:"Problem Solving",p:/Problem Solving:\s*(\d+)/i},{n:"Leadership",p:/Leadership[^:]*:\s*(\d+)/i},{n:"Cultural Fit",p:/Cultural Fit:\s*(\d+)/i}].forEach(d=>{const m=raw.match(d.p);if(m)dims.push({n:d.n,s:parseInt(m[1])})});
  function pL(t,h,nx){const re=new RegExp(h+"[:\\s]*([\\s\\S]*?)(?="+nx.join("|")+"|$)","i");const m=t.match(re);if(!m)return[];return m[1].split(/\n/).map(l=>l.replace(/^[\d.\-‚Ä¢*]+\s*/,"").trim()).filter(l=>l.length>3)}
  const str=pL(raw,"TOP STRENGTHS",["RED FLAG","CONCERN","IMPROVEMENT","HIRING"]);
  const con=pL(raw,"RED FLAGS?|CONCERNS?",["IMPROVEMENT","HIRING"]);
  const imp=pL(raw,"IMPROVEMENT AREAS?",["HIRING RECOMMENDATION"]);
  const rM=raw.match(/HIRING RECOMMENDATION:\s*(STRONG HIRE|HIRE|LEAN HIRE|LEAN NO HIRE|NO HIRE)/i),rec=rM?rM[1].toUpperCase():"";
  const rJM=raw.match(/HIRING RECOMMENDATION:[^\n]*\n([\s\S]*?)$/i),rJ=rJM?rJM[1].trim().split("\n").filter(l=>l.trim()).join(" "):"";

  if(!oS&&!dims.length){const d=document.createElement("div");d.className="msg ai";d.style.maxWidth="100%";d.innerHTML=`<div class="msg-label">üìä Report</div><div class="msg-bubble" style="white-space:pre-wrap;font-family:'JetBrains Mono',monospace;font-size:.82rem">${esc(raw)}</div>`;area.insertBefore(d,typing);area.scrollTop=area.scrollHeight;return}

  const card=document.createElement("div");card.className="score-card glass-card";card.style.animation="msgS .5s ease";
  const clr=s=>s>=80?"var(--accent)":s>=60?"var(--primary)":s>=40?"var(--warning)":"var(--danger)";
  const rc=r=>{const k=r.toLowerCase().replace(/\s+/g,"-");return{["strong-hire"]:"rec-strong-hire",hire:"rec-hire",["lean-hire"]:"rec-lean-hire",["lean-no-hire"]:"rec-lean-no"}[k]||"rec-no-hire"};
  let h="";
  if(oS!==null)h+=`<div class="score-header"><div class="score-big">${oS}</div><div class="score-verdict">${verdict||"/100"}</div></div>`;
  if(dims.length){h+=`<div class="dim-grid">`;dims.forEach(d=>{const c=clr(d.s);h+=`<div class="dim-item"><div class="dim-name">${d.n}</div><div class="dim-score" style="color:${c}">${d.s}</div><div class="dim-bar"><div class="dim-fill" style="width:${d.s}%;background:${c}"></div></div></div>`});h+=`</div>`}
  if(str.length){h+=`<div class="score-sect"><h4>üí™ Strengths</h4><ul class="list-green">`;str.forEach(s=>h+=`<li>${esc(s)}</li>`);h+=`</ul></div>`}
  if(con.length&&!con[0].toLowerCase().includes("none")){h+=`<div class="score-sect"><h4>üö© Red Flags</h4><ul class="list-red">`;con.forEach(c=>h+=`<li>${esc(c)}</li>`);h+=`</ul></div>`}
  if(imp.length){h+=`<div class="score-sect"><h4>üìà Improve</h4><ul class="list-yellow">`;imp.forEach(a=>h+=`<li>${esc(a)}</li>`);h+=`</ul></div>`}
  if(rec){h+=`<div class="score-sect" style="text-align:center"><h4>üèÜ Recommendation</h4><div class="rec-badge ${rc(rec)}">${rec}</div>${rJ?`<p style="margin-top:14px;font-size:.9rem;color:var(--text-dim);line-height:1.6">${esc(rJ)}</p>`:""}</div>`}
  card.innerHTML=h;area.insertBefore(card,typing);area.scrollTop=area.scrollHeight;
}

// ============================================================
// ADMIN
// ============================================================
function openAdmin(){document.getElementById("adminOverlay").classList.add("active")}
function closeAdmin(){document.getElementById("adminOverlay").classList.remove("active")}
async function adminGen(){const l=document.getElementById("adminLabel").value.trim()||"user",d=document.getElementById("adminDuration").value;try{const data=await api("admin-gen",{duration:d,label:l});document.getElementById("adminResult").innerHTML=`<div class="code-item" style="border-color:var(--accent)"><span style="color:var(--accent);font-weight:700">${data.code}</span><span class="code-item-meta">${l}¬∑${d}h</span></div>`;showToast("‚úÖ "+data.code);adminList()}catch(e){}}
async function adminList(){try{const data=await api("admin-list");const list=document.getElementById("codeList");list.innerHTML="";if(!data.codes||!data.codes.length){list.innerHTML=`<div style="color:var(--text-muted);font-size:.85rem;padding:12px">No active codes</div>`;return}data.codes.forEach(c=>{let p={};try{p=JSON.parse(c.data)}catch(e){p={label:c.data}}const el=document.createElement("div");el.className="code-item";el.innerHTML=`<span>${c.code}</span><span class="code-item-meta">${p.label||""}¬∑${p.expiresIn||""}</span>`;list.appendChild(el)})}catch(e){}}

// ============================================================
// LIFECYCLE
// ============================================================
document.addEventListener("touchstart", () => { if (audioCtx && audioCtx.state === "suspended") audioCtx.resume(); }, { once: true });
window.addEventListener("beforeunload", e => { if (isActive) { e.preventDefault(); e.returnValue = ""; } });
document.getElementById("accessCode").addEventListener("keydown", e => { if (e.key === "Enter") startInterview(); });
document.getElementById("fallbackInput").addEventListener("keydown", e => { if (e.key === "Enter") sendFallback(); });
</script>
</body>
</html>
