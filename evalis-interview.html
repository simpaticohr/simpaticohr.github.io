<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Interviewer | Career Lab</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  :root { --accent: #2563eb; --bg: #0f172a; --danger: #dc2626; }
  body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
  .card { width: 90%; max-width: 420px; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
  
  .pulse { width: 64px; height: 64px; background: var(--accent); border-radius: 50%; margin: 20px auto; display: none; animation: pulse-ring 1.5s infinite; }
  @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(37, 99, 235, 0); } }
  
  button { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: 700; cursor: pointer; margin-top: 10px; transition: all 0.2s; }
  button:disabled { background: #475569; cursor: not-allowed; opacity: 0.6; }
  #endBtn { background: var(--danger); display: none; }
  
  #log { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; height: 200px; overflow-y: auto; font-size: 13px; text-align: left; margin-top: 20px; color: #cbd5e1; border: 1px solid rgba(255,255,255,0.1); line-height: 1.5; }
  #status { font-size: 14px; color: #94a3b8; margin-bottom: 15px; font-weight: 500; }
  .report-box { background: #1e293b; padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent); margin-top: 10px; }
</style>
</head>
<body>

<div class="card">
  <h2>Career Lab AI</h2>
  <p id="status">Upload Resume to Start</p>
  
  <input type="file" id="cvFile" accept=".pdf,.txt" style="margin-bottom: 15px; font-size: 12px; width: 100%;">
  
  <div id="micVisual" class="pulse"></div>
  
  <button id="startBtn" disabled>ðŸŽ¤ Start Interview</button>
  <button id="endBtn">ðŸ›‘ End & Evaluate</button>
  
  <div id="log">Welcome. Upload your resume to begin a multi-turn voice interview session.</div>
</div>

<script>
/* --- CONFIGURATION --- */
const API_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* --- STATE MANAGEMENT --- */
let chatHistory = [];
let isInterviewActive = false;
let isProcessing = false; 
let globalCVText = "";
const synth = window.speechSynthesis;

const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const micVisual = document.getElementById("micVisual");
const startBtn = document.getElementById("startBtn");
const endBtn = document.getElementById("endBtn");
const cvInput = document.getElementById("cvFile");

/* --- 1. RESUME PARSING --- */
cvInput.onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  statusEl.innerText = "Parsing Resume...";
  try {
    if (file.type === "application/pdf") {
      const reader = new FileReader();
      reader.onload = async function() {
        const loadingTask = pdfjsLib.getDocument(new Uint8Array(this.result));
        const pdf = await loadingTask.promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(s => s.str).join(" ");
        }
        globalCVText = text;
        statusEl.innerText = "Resume Ready";
        startBtn.disabled = false;
      };
      reader.readAsArrayBuffer(file);
    } else {
      globalCVText = await file.text();
      statusEl.innerText = "Resume Ready";
      startBtn.disabled = false;
    }
  } catch (err) { statusEl.innerText = "Error loading CV."; }
};

/* --- 2. THE VOICE LOOP --- */
function aiSpeak(text) {
  // Fix: Prevent the "undefined" loop
  if (!text || text === "undefined" || text.trim() === "") {
    console.warn("AI received invalid text. Skipping speech.");
    isProcessing = false;
    return;
  }
  
  logEl.innerHTML += `<br><b>AI:</b> ${text}`;
  logEl.scrollTop = logEl.scrollHeight;

  const utterance = new SpeechSynthesisUtterance(text);
  
  // Strict Lock: Only start the next recording turn when speech ends
  utterance.onend = () => {
    isProcessing = false; 
    if (isInterviewActive) {
      setTimeout(startRecording, 400); // Tiny buffer for UX
    }
  };
  
  utterance.onerror = () => { isProcessing = false; };
  
  synth.cancel(); // Clear any queued speech
  synth.speak(utterance);
}

async function startRecording() {
  if (isProcessing || !isInterviewActive) return;
  
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const recorder = new MediaRecorder(stream);
    const chunks = [];

    micVisual.style.display = "block";
    statusEl.innerText = "Listening...";

    recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
    
    recorder.onstop = async () => {
      micVisual.style.display = "none";
      stream.getTracks().forEach(t => t.stop());

      // Validation: If no sound was captured, don't ping the worker
      if (chunks.length === 0) {
        isProcessing = false;
        if (isInterviewActive) startRecording();
        return;
      }
      
      isProcessing = true; 
      statusEl.innerText = "Analyzing...";

      const fd = new FormData();
      fd.append("audio", new Blob(chunks, { type: "audio/webm" }));
      fd.append("mode", "interview");
      fd.append("cvText", globalCVText);
      fd.append("history", JSON.stringify(chatHistory));

      try {
        const res = await fetch(API_URL, { method: "POST", body: fd });
        if (!res.ok) throw new Error("Worker Error");
        
        const data = await res.json();
        if (data.nextQuestion && data.nextQuestion !== "undefined") {
          chatHistory = data.newHistory || chatHistory;
          aiSpeak(data.nextQuestion);
        } else {
          throw new Error("Invalid AI Data");
        }
      } catch (err) {
        console.error(err);
        statusEl.innerText = "Network Error. Speak again.";
        isProcessing = false;
        setTimeout(() => { if(isInterviewActive) startRecording(); }, 2000);
      }
    };

    recorder.start();
    // Auto-stop user response after 8 seconds
    setTimeout(() => { if(recorder.state === "recording") recorder.stop(); }, 8000);
    
  } catch (err) {
    statusEl.innerText = "Mic Error. Check permissions.";
    isInterviewActive = false;
  }
}

/* --- 3. UI CONTROLS --- */
startBtn.onclick = () => {
  isInterviewActive = true;
  startBtn.style.display = "none";
  cvInput.style.display = "none";
  endBtn.style.display = "block";
  
  // First Question: Uses Llama 3.3 70B for deep CV context
  aiSpeak("I've analyzed your background. Can you walk me through your most significant technical project or achievement?");
};

endBtn.onclick = async () => {
  isInterviewActive = false;
  synth.cancel(); 
  statusEl.innerText = "Generating Feedback...";
  endBtn.disabled = true;

  const fd = new FormData();
  fd.append("mode", "evaluate");
  fd.append("history", JSON.stringify(chatHistory));

  try {
    const res = await fetch(API_URL, { method: "POST", body: fd });
    const data = await res.json();
    
    logEl.innerHTML = `
      <div class="report-box">
        <h3 style="margin-top:0; color:#60a5fa;">Interview Performance Report</h3>
        <p style="white-space: pre-wrap;">${data.report}</p>
      </div>`;
    statusEl.innerText = "Interview Complete";
  } catch (err) {
    statusEl.innerText = "Evaluation failed.";
    endBtn.disabled = false;
  }
};
</script>
</body>
</html>
