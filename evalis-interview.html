<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evalis AI - Continuous Interview</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #1e293b; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 450px; text-align: center; border: 1px solid #334155; }
        #status { font-size: 0.9rem; color: #94a3b8; margin: 15px 0; padding: 8px; border-radius: 5px; }
        .active { color: #f87171; font-weight: bold; background: rgba(248, 113, 113, 0.1); }
        button { background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; width: 100%; }
        #log { margin-top: 20px; text-align: left; height: 150px; overflow-y: auto; font-size: 0.85rem; border-top: 1px solid #334155; padding-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Evalis AI Interview</h2>
    <div id="status">Press start to begin</div>
    <button id="startBtn" onclick="startInterview()">Start Interview</button>
    <div id="log"></div>
</div>

<script>
    const WORKER_URL = "https://your-worker.your-subdomain.workers.dev"; // ðŸ”´ Replace with your actual URL
    let history = [];
    let recognition;
    let isAISpeaking = false;

    // Initialize Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            if (transcript) {
                if (isAISpeaking) {
                    window.speechSynthesis.cancel(); // ðŸ”´ BARGE-IN: Stop AI if you talk
                    isAISpeaking = false;
                }
                handleUserSpeech(transcript);
            }
        };

        recognition.onerror = (e) => console.error("Speech Error:", e);
        recognition.onend = () => recognition.start(); // Keep mic always open
    }

    async function startInterview() {
        document.getElementById('startBtn').style.display = 'none';
        updateStatus("ðŸ”´ AI is thinking...", true);
        
        const fd = new FormData();
        fd.append("mode", "start");
        
        const res = await fetch(WORKER_URL, { method: "POST", body: fd });
        const data = await res.json();
        
        history = data.history;
        addLog("AI", data.reply);
        await speak(data.reply);
        
        recognition.start();
        updateStatus("ðŸ”´ Listening (Hands-free)");
    }

    async function handleUserSpeech(text) {
        addLog("You", text);
        updateStatus("Thinking...");

        const fd = new FormData();
        fd.append("text", text); // Send text, not audio
        fd.append("history", JSON.stringify(history));

        try {
            const res = await fetch(WORKER_URL, { method: "POST", body: fd });
            const data = await res.json();
            
            history = data.history;
            addLog("AI", data.reply);
            await speak(data.reply);
        } catch (e) {
            console.error("Worker error:", e);
        }
        updateStatus("ðŸ”´ Listening (Hands-free)");
    }

    function speak(text) {
        return new Promise((resolve) => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.onstart = () => { isAISpeaking = true; };
            utterance.onend = () => { isAISpeaking = false; resolve(); };
            window.speechSynthesis.speak(utterance);
        });
    }

    function updateStatus(msg, active = false) {
        const el = document.getElementById('status');
        el.innerText = msg;
        el.className = active ? "active" : "";
    }

    function addLog(role, text) {
        const log = document.getElementById('log');
        log.innerHTML = `<div><strong>${role}:</strong> ${text}</div>` + log.innerHTML;
    }
</script>
</body>
</html>
