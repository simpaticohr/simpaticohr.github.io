<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>simpaticoai | Elite Interviewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020205;
            --surface: #0a0b14;
            --primary: #6366f1;
            --accent: #a855f7;
            --text: #f8fafc;
            --text-dim: #64748b;
            --success: #10b981;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 100vh; overflow: hidden;
        }

        /* --- THE ELITE ORB --- */
        .orb-container { position: relative; width: 300px; height: 300px; display: flex; align-items: center; justify-content: center; }
        
        .orb {
            width: 160px; height: 160px;
            background: #000; border-radius: 50%;
            position: relative; z-index: 2;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 0 80px rgba(99, 102, 241, 0.1);
            overflow: hidden;
        }

        canvas { position: absolute; width: 100%; height: 100%; }

        /* Animation States */
        .orb.listening { border-color: var(--success); box-shadow: 0 0 100px rgba(16, 185, 129, 0.15); }
        .orb.speaking { border-color: var(--primary); box-shadow: 0 0 100px rgba(99, 102, 241, 0.2); }
        .orb.thinking { animation: pulse-thinking 2s infinite; border-color: var(--accent); }

        @keyframes pulse-thinking { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.7; } }

        .interface { width: 90%; max-width: 400px; text-align: center; z-index: 10; margin-top: 20px;}
        .status-pill { display: inline-block; padding: 8px 20px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 50px; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }

        .btn { background: var(--primary); color: white; border: none; padding: 16px 32px; border-radius: 14px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.3s; }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }

        .controls { margin-top: 30px; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 10px; }
        input[type=range] { width: 100%; accent-color: var(--primary); cursor: pointer; }

        .file-trigger { border: 2px dashed rgba(255, 255, 255, 0.1); padding: 40px 20px; border-radius: 24px; cursor: pointer; display:block; color: var(--text-dim); transition: 0.3s; }
        .file-trigger:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.02); }
        input[type="file"] { display: none; }

        .timer { font-family: monospace; color: var(--text-dim); margin-top: 15px; font-size: 1.1rem; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(10px); }
        .modal-content { background: var(--surface); padding: 40px; border-radius: 30px; width: 85%; max-width: 600px; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div class="orb-container">
        <div id="orb" class="orb">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <div class="interface">
        <div id="status" class="status-pill">System Ready</div>
        
        <div id="setupPanel">
            <label class="file-trigger">
                <span>ðŸ“‚ UPLOAD RESUME (PDF)</span>
                <input type="file" id="cvInput" accept=".pdf">
            </label>
            <br>
            <button id="startBtn" class="btn" style="display:none;">START ELITE INTERVIEW</button>
        </div>

        <div id="activePanel" style="display:none;">
            <button id="endBtn" class="btn btn-danger">FINISH SESSION</button>
            <div id="timer" class="timer">15:00</div>
            
            <div class="controls">
                <div class="slider-label">
                    <span>Barge-in Sensitivity</span>
                    <span id="sensVal">45</span>
                </div>
                <input type="range" id="sensSlider" min="10" max="100" value="45">
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary);">Interview Evaluation</h2>
            <div id="reportText" style="line-height: 1.8; color: var(--text-dim); white-space: pre-wrap; font-size: 0.95rem; max-height: 300px; overflow-y: auto;"></div>
            <button onclick="location.reload()" class="btn" style="margin-top:30px;">START NEW</button>
        </div>
    </div>

<script>
    const API_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    let state = {
        cvText: "",
        history: [],
        timeLeft: 900,
        isSessionActive: false,
        isAiSpeaking: false,
        isMicActive: false,
        bargeInThreshold: 45
    };

    let silenceTimeout = null;
    const PATIENCE_MS = 1500; // Time to wait for user to finish thought

    // --- AUDIO VISUALIZER & VAD ---
    let audioCtx, analyser, dataArray;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    async function initAudio() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            const source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            renderFrame();
            return true;
        } catch (e) {
            alert("Mic access denied.");
            return false;
        }
    }

    function renderFrame() {
        requestAnimationFrame(renderFrame);
        const width = canvas.width = canvas.offsetWidth;
        const height = canvas.height = canvas.offsetHeight;
        analyser.getByteFrequencyData(dataArray);
        
        ctx.clearRect(0, 0, width, height);
        
        let volumeSum = 0;
        for (let i = 0; i < dataArray.length; i++) volumeSum += dataArray[i];
        let average = volumeSum / dataArray.length;

        // ELITE BARGE-IN LOGIC
        if (state.isAiSpeaking && average > state.bargeInThreshold) {
            console.log("Interruption detected");
            window.speechSynthesis.cancel();
            state.isAiSpeaking = false;
            setOrbState('listening');
        }

        // WHISPER VISUALS
        ctx.beginPath();
        ctx.strokeStyle = state.isAiSpeaking ? '#6366f1' : '#10b981';
        ctx.lineWidth = 3;
        for (let i = 0; i < dataArray.length; i++) {
            let x = (i / dataArray.length) * width;
            let h = (dataArray[i] / 255) * height;
            ctx.lineTo(x, (height/2) + (h/2));
            ctx.lineTo(x, (height/2) - (h/2));
        }
        ctx.stroke();
    }

    // --- SPEECH ENGINE ---
    const Recognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    const recognition = new Recognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    function safeStartMic() {
        if (!state.isMicActive && state.isSessionActive) {
            try { 
                recognition.start(); 
                state.isMicActive = true;
            } catch(e) {}
        }
    }

    recognition.onstart = () => state.isMicActive = true;
    recognition.onend = () => {
        state.isMicActive = false;
        if (state.isSessionActive && !state.isAiSpeaking) safeStartMic();
    };

    recognition.onresult = (event) => {
        if (state.isAiSpeaking) return; // VAD handles interruptions

        if (silenceTimeout) clearTimeout(silenceTimeout);

        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
        }

        if (finalTranscript.trim()) {
            setOrbState('listening');
            // Patience timer: Wait for candidate to fully finish
            silenceTimeout = setTimeout(() => {
                handleUserResponse(finalTranscript);
            }, PATIENCE_MS);
        }
    };

    async function handleUserResponse(text) {
        setOrbState('thinking');
        const fd = new FormData();
        fd.append("mode", "interview");
        fd.append("history", JSON.stringify(state.history));
        fd.append("text", text);
        fd.append("cvText", state.cvText);

        try {
            const res = await fetch(API_URL, { method: "POST", body: fd });
            const data = await res.json();
            state.history = data.history;
            if (state.isSessionActive) speak(data.reply);
        } catch (e) {
            setOrbState('listening');
        }
    }

    function speak(text) {
        state.isAiSpeaking = true;
        setOrbState('speaking');
        
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        utterance.voice = voices.find(v => v.name.includes('Google US English') || v.name.includes('Natural')) || voices[0];
        utterance.rate = 0.95; 

        utterance.onend = () => {
            state.isAiSpeaking = false;
            if (state.isSessionActive) setOrbState('listening');
        };
        window.speechSynthesis.speak(utterance);
    }

    // --- CONTROLS ---
    document.getElementById('sensSlider').oninput = (e) => {
        state.bargeInThreshold = e.target.value;
        document.getElementById('sensVal').textContent = e.target.value;
    };

    document.getElementById('cvInput').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('status').textContent = "Analyzing PDF...";
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(buffer) }).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            fullText += textContent.items.map(s => s.str).join(" ");
        }
        state.cvText = fullText;
        document.getElementById('status').textContent = "Resume Authenticated";
        document.getElementById('startBtn').style.display = "block";
    };

    document.getElementById('startBtn').onclick = async () => {
        const ok = await initAudio();
        if (!ok) return;

        state.isSessionActive = true;
        document.getElementById('setupPanel').style.display = 'none';
        document.getElementById('activePanel').style.display = 'block';
        
        safeStartMic();

        // Start Call
        setOrbState('thinking');
        const fd = new FormData();
        fd.append("mode", "start");
        fd.append("cvText", state.cvText);
        const res = await fetch(API_URL, { method: "POST", body: fd });
        const data = await res.json();
        state.history = data.history;
        speak(data.reply);

        setInterval(() => {
            if (state.timeLeft > 0 && state.isSessionActive) {
                state.timeLeft--;
                const m = Math.floor(state.timeLeft/60);
                const s = state.timeLeft%60;
                document.getElementById('timer').textContent = `${m}:${s < 10 ? '0'+s : s}`;
            }
        }, 1000);
    };

    document.getElementById('endBtn').onclick = async () => {
        state.isSessionActive = false;
        window.speechSynthesis.cancel();
        document.getElementById('activePanel').style.display = 'none';
        setOrbState('thinking');
        
        const fd = new FormData();
        fd.append("mode", "score");
        fd.append("history", JSON.stringify(state.history));
        const res = await fetch(API_URL, { method: "POST", body: fd });
        const data = await res.json();
        
        document.getElementById('reportText').textContent = data.reply;
        document.getElementById('reportModal').style.display = 'flex';
    };

    function setOrbState(mode) {
        document.getElementById('orb').className = 'orb ' + mode;
        document.getElementById('status').textContent = mode;
    }

    // Prevents phone sleeping
    if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
</script>
</body>
</html>
