<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Career Lab AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  :root { --accent: #2563eb; --bg: #0b1d3a; }
  body { font-family: sans-serif; background: var(--bg); color: white; display: flex; justify-content: center; padding: 20px; }
  .card { width: 100%; max-width: 400px; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
  .pulse { width: 60px; height: 60px; background: var(--accent); border-radius: 50%; margin: 20px auto; display: none; animation: p 1.5s infinite; }
  @keyframes p { 0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.7); } 100% { box-shadow: 0 0 0 20px rgba(37,99,235,0); } }
  button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: bold; margin-top: 10px; cursor: pointer; }
  #log { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; height: 150px; overflow-y: auto; margin-top: 15px; font-size: 13px; text-align: left; }
</style>
</head>
<body>
<div class="card">
  <h3>Career Lab AI</h3>
  <p id="status" style="font-size: 14px; color: #94a3b8;">Upload CV to start</p>
  <input type="file" id="cvFile" accept=".pdf,.txt" style="font-size: 12px;">
  <div id="micVisual" class="pulse"></div>
  <button id="startBtn" disabled>Start Interview</button>
  <button id="endBtn" style="display:none; background:#dc2626;">End Interview</button>
  <div id="log"></div>
</div>

<script>
const API_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev";
let chatHistory = [], isInterviewActive = false, isProcessing = false, globalCVText = "";
const synth = window.speechSynthesis;

// CV Parser
document.getElementById("cvFile").onchange = async (e) => {
  const file = e.target.files[0];
  status.innerText = "Processing...";
  if (file.type === "application/pdf") {
    const pdf = await pdfjsLib.getDocument(new Uint8Array(await file.arrayBuffer())).promise;
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      globalCVText += (await page.getTextContent()).items.map(s => s.str).join(" ");
    }
  } else { globalCVText = await file.text(); }
  document.getElementById("startBtn").disabled = false;
  status.innerText = "Ready";
};

function aiSpeak(text) {
  if (!text) { isProcessing = false; return; }
  document.getElementById("log").innerHTML += `<br><b>AI:</b> ${text}`;
  const u = new SpeechSynthesisUtterance(text);
  u.onend = () => { isProcessing = false; if (isInterviewActive) startRecording(); };
  synth.speak(u);
}

async function startRecording() {
  if (isProcessing || !isInterviewActive) return;
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const recorder = new MediaRecorder(stream);
  const chunks = [];
  document.getElementById("micVisual").style.display = "block";
  status.innerText = "Listening...";

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = async () => {
    isProcessing = true;
    document.getElementById("micVisual").style.display = "none";
    status.innerText = "Analyzing...";
    
    const fd = new FormData();
    fd.append("audio", new Blob(chunks, { type: "audio/webm" }));
    fd.append("mode", "interview");
    fd.append("cvText", globalCVText);
    fd.append("history", JSON.stringify(chatHistory));

    try {
      const res = await fetch(API_URL, { method: "POST", body: fd });
      const data = await res.json();
      chatHistory = data.newHistory || chatHistory;
      aiSpeak(data.nextQuestion);
    } catch (e) { status.innerText = "Error"; isProcessing = false; }
  };
  recorder.start();
  setTimeout(() => recorder.stop(), 7000);
}

document.getElementById("startBtn").onclick = () => {
  isInterviewActive = true;
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("endBtn").style.display = "block";
  aiSpeak("Welcome. Based on your resume, tell me about your background.");
};

document.getElementById("endBtn").onclick = async () => {
  isInterviewActive = false; synth.cancel();
  status.innerText = "Generating Report...";
  const fd = new FormData();
  fd.append("mode", "evaluate");
  fd.append("history", JSON.stringify(chatHistory));
  const res = await fetch(API_URL, { method: "POST", body: fd });
  const data = await res.json();
  document.getElementById("log").innerHTML = `<b>Report:</b><br>${data.report}`;
};
</script>
</body>
</html>
