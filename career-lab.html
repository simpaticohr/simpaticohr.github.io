<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
// Initialize PDF.js
const pdfjsLib = window['pdfjs-dist/legacy/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

async function performAudit(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Show Loading UI
        document.getElementById('audit-initial').style.display = 'none';
        document.getElementById('audit-loading').style.display = 'block';
        const loadingMsg = document.getElementById('loading-msg');
        loadingMsg.innerText = "AI is reading " + file.name + "...";

        try {
            // 1. Read the PDF content
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";

            // Loop through first 2 pages to extract text
            for (let i = 1; i <= Math.min(pdf.numPages, 2); i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(s => s.str).join(" ");
            }

            // 2. AI Keyword Analysis Logic
            const keywords = ["experience", "education", "skills", "management", "project", "professional", "summary", "achievements", "contact", "email"];
            let foundCount = 0;
            const lowerText = fullText.toLowerCase();
            
            keywords.forEach(word => {
                if (lowerText.includes(word)) foundCount++;
            });

            // 3. Calculate Score (0 to 100)
            // Base score 20 + 7 points per professional keyword found
            let score = 20 + (foundCount * 7);
            if (score > 85) score = 84; // Keep it below 85 to encourage the paid fix

            // 4. Update UI with AI Results
            setTimeout(() => {
                document.getElementById('audit-loading').style.display = 'none';
                document.getElementById('audit-results').style.display = 'block';
                document.getElementById('final-score').style.display = 'block';
                document.getElementById('final-score').innerText = score + "%";
            }, 2000);

        } catch (error) {
            console.error("PDF Read Error:", error);
            // Fallback score if PDF is unreadable/protected
            document.getElementById('final-score').innerText = "28%";
            document.getElementById('audit-loading').style.display = 'none';
            document.getElementById('audit-results').style.display = 'block';
        }
    }
}
</script>

