<script>
document.addEventListener("DOMContentLoaded", () => {

  const mainQuestions = [
    "Tell me about yourself.",
    "What are your key strengths?",
    "Describe a challenge you faced and how you handled it.",
    "Why should we hire you?",
    "Where do you see yourself in the next few years?"
  ];

  let current = 0;
  let awaitingFollowUp = false;
  let lastAnswer = "";

  const questionEl = document.getElementById("question");
  const progressEl = document.getElementById("progress");
  const answerEl = document.getElementById("answer");
  const replyEl = document.getElementById("reply");

  if (!questionEl || !progressEl || !answerEl || !replyEl) return;

  function speakSoft(text) {
    if (!window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.85;
    u.pitch = 1;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  function getFollowUp(answer) {
    const a = answer.toLowerCase();

    if (answer.length < 25) {
      return "Could you expand a little more on that?";
    }
    if (a.includes("project")) {
      return "What was your specific role in that project?";
    }
    if (a.includes("team")) {
      return "How did you collaborate with your team?";
    }
    if (a.includes("challenge") || a.includes("problem")) {
      return "What did you learn from that experience?";
    }
    if (a.includes("strength")) {
      return "Can you give a real example where this strength helped you?";
    }

    return null; // no follow-up needed
  }

  function humanFeedback(answer) {
    if (answer.length < 30) {
      return "That’s a good start. Let’s go a bit deeper.";
    }
    if (answer.length < 80) {
      return "Good explanation. Thank you for clarifying.";
    }
    return "That was a clear and confident response.";
  }

  function askQuestion(text) {
    questionEl.innerText = text;
    speakSoft(text);
  }

  // Start interview
  progressEl.innerText = `Question 1 of ${mainQuestions.length}`;
  askQuestion(mainQuestions[current]);

  window.submitAnswer = function () {
    const answer = answerEl.value.trim();
    if (!answer) return;

    answerEl.disabled = true;
    replyEl.innerText = "Evalis AI is listening…";

    setTimeout(() => {

      replyEl.innerText = "Evalis AI: " + humanFeedback(answer);
      speakSoft(humanFeedback(answer));

      answerEl.value = "";
      answerEl.disabled = false;

      // FOLLOW-UP LOGIC
      if (!awaitingFollowUp) {
        const followUp = getFollowUp(answer);

        if (followUp) {
          awaitingFollowUp = true;
          lastAnswer = answer;

          setTimeout(() => {
            replyEl.innerText = "";
            askQuestion(followUp);
          }, 1500);

          return;
        }
      }

      // Move to next main question
      awaitingFollowUp = false;
      current++;

      if (current < mainQuestions.length) {
        setTimeout(() => {
          progressEl.innerText = `Question ${current + 1} of ${mainQuestions.length}`;
          replyEl.innerText = "";
          askQuestion(mainQuestions[current]);
        }, 1800);
      } else {
        setTimeout(() => {
          document.querySelector(".card").innerHTML = `
            <h2>Interview Completed</h2>
            <p>You handled the interview well.</p>
            <p><strong>Evalis AI:</strong> Detailed scoring and feedback will be available soon.</p>
          `;
        }, 2000);
      }

    }, 1500);
  };

});
</script>
