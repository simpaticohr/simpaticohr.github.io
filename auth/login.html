<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In — SimpaticoHR</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #080c14;
      --surface: #0e1520;
      --surface2: #141d2e;
      --border: rgba(255,255,255,0.07);
      --accent: #00e5c3;
      --accent2: #0066ff;
      --text: #e8edf5;
      --muted: #5a6a80;
      --muted2: #3a4a60;
      --danger: #ff4d6d;
      --success: #00e5c3;
      --warning: #f59e0b;
    }

    html, body { height: 100%; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      overflow: hidden;
    }

    .bg-canvas {
      position: fixed; inset: 0; z-index: 0;
      overflow: hidden; pointer-events: none;
    }
    .bg-canvas::before {
      content: '';
      position: absolute;
      width: 900px; height: 900px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0,229,195,0.06) 0%, transparent 70%);
      top: -300px; left: -200px;
      animation: drift1 18s ease-in-out infinite alternate;
    }
    .bg-canvas::after {
      content: '';
      position: absolute;
      width: 700px; height: 700px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0,102,255,0.07) 0%, transparent 70%);
      bottom: -200px; right: -100px;
      animation: drift2 14s ease-in-out infinite alternate;
    }
    @keyframes drift1 { from { transform: translate(0,0) scale(1); } to { transform: translate(60px,40px) scale(1.1); } }
    @keyframes drift2 { from { transform: translate(0,0) scale(1); } to { transform: translate(-40px,-60px) scale(1.08); } }

    .grid-lines {
      position: fixed; inset: 0; z-index: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
      background-size: 60px 60px;
    }

    .page { display: flex; width: 100%; position: relative; z-index: 1; }

    /* LEFT PANEL */
    .left-panel {
      flex: 1.1;
      display: flex; flex-direction: column;
      justify-content: center; padding: 4rem 5rem;
      position: relative;
      border-right: 1px solid var(--border);
    }
    .left-panel::after {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(0,229,195,0.03) 0%, transparent 60%);
      pointer-events: none;
    }

    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 4rem; }
    .brand-icon {
      width: 46px; height: 46px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; color: #fff;
      box-shadow: 0 0 30px rgba(0,229,195,0.3);
    }
    .brand-name { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; letter-spacing: -0.02em; }
    .brand-name span { color: var(--accent); }

    .left-headline {
      font-family: 'Syne', sans-serif;
      font-size: 3.2rem; font-weight: 800;
      line-height: 1.1; letter-spacing: -0.03em; margin-bottom: 1.25rem;
    }
    .left-headline em {
      font-style: normal;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .left-sub { font-size: 1rem; color: var(--muted); line-height: 1.7; max-width: 400px; margin-bottom: 3rem; }

    .features { display: flex; flex-direction: column; gap: 1rem; }
    .feature-item {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 18px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: border-color 0.2s, background 0.2s;
    }
    .feature-item:hover { border-color: rgba(0,229,195,0.2); background: rgba(0,229,195,0.04); }
    .feature-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); flex-shrink: 0; box-shadow: 0 0 8px var(--accent); }
    .feature-text { font-size: 0.9rem; color: var(--muted); font-weight: 500; }
    .feature-text strong { color: var(--text); font-weight: 600; }

    /* RIGHT PANEL */
    .right-panel {
      width: 480px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      padding: 3rem 3.5rem;
    }
    .form-card { width: 100%; animation: fadeUp 0.5s ease both; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .form-title { font-family: 'Syne', sans-serif; font-size: 2rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.4rem; }
    .form-subtitle { font-size: 0.9rem; color: var(--muted); margin-bottom: 2rem; }

    /* ROLE TABS */
    .role-tabs {
      display: flex; gap: 6px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 5px; margin-bottom: 2rem;
    }
    .role-tab {
      flex: 1; padding: 9px 10px; text-align: center;
      border-radius: 8px; font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      color: var(--muted); border: none; background: transparent;
      font-family: 'DM Sans', sans-serif;
    }
    .role-tab.active {
      background: linear-gradient(135deg, rgba(0,229,195,0.15), rgba(0,102,255,0.15));
      color: var(--accent); border: 1px solid rgba(0,229,195,0.25);
    }

    /* SOCIAL */
    .social-row { display: flex; gap: 10px; margin-bottom: 1.5rem; }
    .social-btn {
      flex: 1; padding: 11px 10px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text);
      font-size: 0.85rem; font-weight: 500; font-family: 'DM Sans', sans-serif;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; transition: all 0.2s;
    }
    .social-btn:hover { background: var(--surface2); border-color: rgba(255,255,255,0.15); }
    .social-btn .fab { font-size: 0.95rem; }
    .social-btn .fab.fa-google { color: #ea4335; }
    .social-btn .fab.fa-linkedin-in { color: #0a66c2; }

    /* DIVIDER */
    .divider { display: flex; align-items: center; gap: 12px; margin-bottom: 1.5rem; }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    .divider span { font-size: 0.75rem; color: var(--muted2); white-space: nowrap; }

    /* ALERT BANNER */
    .alert-banner {
      display: none;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 0.84rem;
      font-weight: 500;
      margin-bottom: 1.2rem;
      align-items: center;
      gap: 10px;
      animation: fadeUp 0.3s ease;
    }
    .alert-banner.show { display: flex; }
    .alert-banner.error { background: rgba(255,77,109,0.1); border: 1px solid rgba(255,77,109,0.3); color: #ff6b85; }
    .alert-banner.success { background: rgba(0,229,195,0.1); border: 1px solid rgba(0,229,195,0.3); color: var(--accent); }
    .alert-banner.warning { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: #fbbf24; }

    /* FORM FIELDS */
    .field { margin-bottom: 1.1rem; }
    .field label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 6px; }
    .field .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .field .label-row label { margin-bottom: 0; }
    .forgot-link { font-size: 0.78rem; color: var(--accent); font-weight: 500; text-decoration: none; transition: opacity 0.2s; }
    .forgot-link:hover { opacity: 0.7; }

    .input-wrap { position: relative; }
    .input-wrap i.icon-left { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--muted2); font-size: 0.85rem; pointer-events: none; }
    .input-wrap .toggle-pw {
      position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      color: var(--muted2); font-size: 0.85rem; cursor: pointer;
      background: none; border: none; padding: 0; transition: color 0.2s;
    }
    .input-wrap .toggle-pw:hover { color: var(--accent); }

    input[type="email"], input[type="password"], input[type="text"] {
      width: 100%; padding: 12px 40px 12px 40px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text);
      font-size: 0.92rem; font-family: 'DM Sans', sans-serif;
      outline: none; transition: all 0.2s;
    }
    input[type="email"]::placeholder,
    input[type="password"]::placeholder,
    input[type="text"]::placeholder { color: var(--muted2); }
    input:focus {
      border-color: rgba(0,229,195,0.4);
      background: var(--surface2);
      box-shadow: 0 0 0 3px rgba(0,229,195,0.07);
    }
    input.error-field { border-color: rgba(255,77,109,0.5) !important; }

    /* REMEMBER */
    .remember-row { display: flex; align-items: center; gap: 9px; margin-bottom: 1.5rem; }
    .remember-row input[type="checkbox"] { accent-color: var(--accent); width: 15px; height: 15px; cursor: pointer; }
    .remember-row label { font-size: 0.83rem; color: var(--muted); cursor: pointer; }

    /* SUBMIT */
    .submit-btn {
      width: 100%; padding: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none; border-radius: 12px;
      color: #fff; font-size: 0.95rem; font-weight: 700;
      font-family: 'Syne', sans-serif; letter-spacing: 0.02em;
      cursor: pointer; transition: all 0.25s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 4px 24px rgba(0,229,195,0.25);
    }
    .submit-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,229,195,0.35); }
    .submit-btn:active:not(:disabled) { transform: translateY(0); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* FOOTER */
    .form-footer { text-align: center; margin-top: 1.5rem; font-size: 0.83rem; color: var(--muted); line-height: 1.8; }
    .form-footer a { color: var(--accent); font-weight: 600; text-decoration: none; }
    .form-footer a:hover { text-decoration: underline; }

    /* SPINNER */
    .spinner {
      width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 900px) {
      .left-panel { display: none; }
      .right-panel { width: 100%; padding: 2rem; }
    }
  </style>
</head>
<body>

<div class="bg-canvas"></div>
<div class="grid-lines"></div>

<div class="page">
  <!-- LEFT -->
  <div class="left-panel">
    <div class="brand">
      <div class="brand-icon"><i class="fas fa-infinity"></i></div>
      <div class="brand-name">Simpatico<span>HR</span></div>
    </div>
    <h1 class="left-headline">Hire Smarter.<br><em>Close Faster.</em></h1>
    <p class="left-sub">India's most advanced AI recruitment platform — proctored interviews, eye-tracking, and complete hiring automation in one place.</p>
    <div class="features">
      <div class="feature-item">
        <div class="feature-dot"></div>
        <div class="feature-text"><strong>AI Proctored Interviews</strong> — hands-free &amp; tamper-proof</div>
      </div>
      <div class="feature-item">
        <div class="feature-dot"></div>
        <div class="feature-text"><strong>99.2% Cheat Detection</strong> — eye tracking + behavior AI</div>
      </div>
      <div class="feature-item">
        <div class="feature-dot"></div>
        <div class="feature-text"><strong>Automated Sourcing</strong> — from JD to shortlist in minutes</div>
      </div>
      <div class="feature-item">
        <div class="feature-dot"></div>
        <div class="feature-text"><strong>Multi-Client Isolation</strong> — enterprise-grade data security</div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right-panel">
    <div class="form-card">
      <h2 class="form-title">Welcome back</h2>
      <p class="form-subtitle">Sign in to continue to your dashboard</p>

      <!-- Role Tabs -->
      <div class="role-tabs" id="roleTabs">
        <button class="role-tab active" data-role="hr">HR / Admin</button>
        <button class="role-tab" data-role="candidate">Candidate</button>
        <button class="role-tab" data-role="super_admin">Super Admin</button>
      </div>

      <!-- Error / Success Alert -->
      <div class="alert-banner" id="alertBanner">
        <i class="fas fa-circle-exclamation"></i>
        <span id="alertMsg"></span>
      </div>

      <!-- Social -->
      <div class="social-row">
        <button class="social-btn" onclick="socialLogin('google')">
          <i class="fab fa-google"></i> Google
        </button>
        <button class="social-btn" onclick="socialLogin('linkedin_oidc')">
          <i class="fab fa-linkedin-in"></i> LinkedIn
        </button>
      </div>

      <div class="divider"><span>or sign in with email</span></div>

      <!-- Form -->
      <form id="loginForm" onsubmit="handleLogin(event)" autocomplete="on" novalidate>
        <div class="field">
          <label for="loginEmail">Email Address</label>
          <div class="input-wrap">
            <i class="fas fa-envelope icon-left"></i>
            <input type="email" id="loginEmail" placeholder="you@company.com" required autocomplete="email">
          </div>
        </div>

        <div class="field">
          <div class="label-row">
            <label for="loginPassword">Password</label>
            <a href="forgot-password.html" class="forgot-link">Forgot password?</a>
          </div>
          <div class="input-wrap">
            <i class="fas fa-lock icon-left"></i>
            <input type="password" id="loginPassword" placeholder="••••••••" required autocomplete="current-password">
            <button type="button" class="toggle-pw" onclick="togglePassword()" id="togglePwBtn" title="Show/hide password">
              <i class="fas fa-eye" id="eyeIcon"></i>
            </button>
          </div>
        </div>

        <div class="remember-row">
          <input type="checkbox" id="rememberMe" checked>
          <label for="rememberMe">Remember me for 30 days</label>
        </div>

        <button type="submit" class="submit-btn" id="loginBtn">
          <i class="fas fa-arrow-right-to-bracket"></i>
          Sign In
        </button>
      </form>

      <div class="form-footer">
        New here? <a href="register-company.html">Register your company</a><br>
        or <a href="register-candidate.html">sign up as a candidate</a>
      </div>
    </div>
  </div>
</div>

<!-- ─────────────────────────── SCRIPTS ─────────────────────────── -->
<script>
  // ── CONFIG ──────────────────────────────────────────────────────
  // ⚠️  REPLACE these two values with your actual Supabase project details
  // Found at: https://app.supabase.com → Project Settings → API
  const SUPABASE_URL = "https://YOUR_PROJECT_REF.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

  // Cloudflare Worker URL (kept as fallback)
  const WORKER_URL = "https://evalis-ai.simpaticohrconsultancy.workers.dev/api/auth/login";

  // Role → dashboard route map
  const ROLE_ROUTES = {
    super_admin:   "/platform/super-admin.html",
    company_admin: "/dashboard/hr.html",
    hr_manager:    "/dashboard/hr.html",
    interviewer:   "/dashboard/interviewer.html",
    candidate:     "/dashboard/candidate.html"
  };

  // ── STATE ────────────────────────────────────────────────────────
  let selectedRole = "hr";

  // On load: pre-select role from URL param e.g. ?role=super_admin
  window.addEventListener("DOMContentLoaded", () => {
    const urlRole = new URLSearchParams(window.location.search).get("role");
    if (urlRole) {
      const map = { super_admin: "super_admin", candidate: "candidate", hr: "hr" };
      const role = map[urlRole] || "hr";
      document.querySelectorAll(".role-tab").forEach(t => {
        t.classList.toggle("active", t.dataset.role === role);
      });
      selectedRole = role;
    }
  });

  // ── ROLE TABS ────────────────────────────────────────────────────
  document.querySelectorAll(".role-tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".role-tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      selectedRole = tab.dataset.role;
      hideAlert();
    });
  });

  // ── ALERT HELPERS ────────────────────────────────────────────────
  function showAlert(msg, type = "error") {
    const banner = document.getElementById("alertBanner");
    const msgEl  = document.getElementById("alertMsg");
    const icon   = banner.querySelector("i");

    banner.className = `alert-banner show ${type}`;
    msgEl.textContent = msg;
    icon.className = type === "error"   ? "fas fa-circle-exclamation"
                   : type === "success" ? "fas fa-check-circle"
                   :                      "fas fa-triangle-exclamation";
  }

  function hideAlert() {
    document.getElementById("alertBanner").classList.remove("show");
  }

  // ── TOGGLE PASSWORD ──────────────────────────────────────────────
  function togglePassword() {
    const input = document.getElementById("loginPassword");
    const icon  = document.getElementById("eyeIcon");
    const show  = input.type === "password";
    input.type  = show ? "text" : "password";
    icon.className = show ? "fas fa-eye-slash" : "fas fa-eye";
  }

  // ── SUPABASE DIRECT AUTH ─────────────────────────────────────────
  async function loginWithSupabase(email, password) {
    const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (!res.ok) {
      // Map Supabase error messages to human-friendly ones
      const msg = data?.error_description || data?.msg || data?.message || "Invalid email or password.";
      throw new Error(msg);
    }

    // Fetch user profile from 'users' table
    const profileRes = await fetch(
      `${SUPABASE_URL}/rest/v1/users?auth_id=eq.${data.user.id}&select=*,companies(*)&limit=1`,
      {
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${data.access_token}`,
          "Content-Type": "application/json"
        }
      }
    );

    const profiles = await profileRes.json();
    const profile  = profiles?.[0] ?? null;

    if (!profile) {
      throw new Error("User profile not found. Please contact your administrator.");
    }

    // Update last_login (best-effort, non-blocking)
    fetch(
      `${SUPABASE_URL}/rest/v1/users?auth_id=eq.${data.user.id}`,
      {
        method: "PATCH",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${data.access_token}`,
          "Content-Type": "application/json",
          "Prefer": "return=minimal"
        },
        body: JSON.stringify({ last_login: new Date().toISOString() })
      }
    ).catch(() => {});

    return {
      token:        data.access_token,
      refreshToken: data.refresh_token,
      user: {
        id:    data.user.id,
        email: data.user.email,
        role:  profile.role
      },
      profile
    };
  }

  // ── WORKER FALLBACK AUTH ─────────────────────────────────────────
  async function loginWithWorker(email, password) {
    const res  = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password, role: selectedRole })
    });

    let data;
    try {
      data = await res.json();
    } catch {
      throw new Error("Server returned an unexpected response. Please try again.");
    }

    if (!res.ok || data?.error) {
      throw new Error(data?.error || `Server error (${res.status}). Please try again.`);
    }

    return data;
  }

  // ── PERSIST SESSION ──────────────────────────────────────────────
  function persistSession(authData, remember) {
    const storage = remember ? localStorage : sessionStorage;
    storage.setItem("simpatico_token",   authData.token);
    storage.setItem("simpatico_user",    JSON.stringify(authData.user));
    if (authData.refreshToken) {
      storage.setItem("simpatico_refresh", authData.refreshToken);
    }
  }

  // ── MAIN LOGIN HANDLER ───────────────────────────────────────────
  async function handleLogin(e) {
    e.preventDefault();
    hideAlert();

    const email    = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;
    const remember = document.getElementById("rememberMe").checked;
    const btn      = document.getElementById("loginBtn");

    // Client-side validation
    if (!email) {
      showAlert("Please enter your email address.");
      document.getElementById("loginEmail").classList.add("error-field");
      return;
    }
    if (!password) {
      showAlert("Please enter your password.");
      document.getElementById("loginPassword").classList.add("error-field");
      return;
    }
    document.querySelectorAll("input").forEach(i => i.classList.remove("error-field"));

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Signing in…';

    let authData = null;

    // ① Try Supabase directly first (bypasses the broken Worker)
    const supabaseConfigured =
      SUPABASE_URL !== "https://YOUR_PROJECT_REF.supabase.co" &&
      SUPABASE_ANON_KEY !== "YOUR_SUPABASE_ANON_KEY";

    if (supabaseConfigured) {
      try {
        authData = await loginWithSupabase(email, password);
      } catch (err) {
        // If it's a credentials error, stop here — no point trying Worker
        const credErrors = ["invalid login credentials", "invalid email", "invalid password", "email not confirmed", "user not found", "profile not found"];
        const isCredErr  = credErrors.some(s => err.message.toLowerCase().includes(s));
        if (isCredErr) {
          showAlert(err.message);
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-arrow-right-to-bracket"></i> Sign In';
          return;
        }
        // Otherwise fall through to Worker
        console.warn("Supabase direct auth failed, trying Worker:", err.message);
      }
    }

    // ② Fall back to Cloudflare Worker
    if (!authData) {
      try {
        authData = await loginWithWorker(email, password);
      } catch (err) {
        showAlert(err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-arrow-right-to-bracket"></i> Sign In';
        return;
      }
    }

    // ③ Success — persist and redirect
    try {
      persistSession(authData, remember);

      btn.innerHTML = '<i class="fas fa-check"></i> Success!';
      showAlert("Login successful! Redirecting…", "success");

      const role  = authData.user?.role || "";
      const route = ROLE_ROUTES[role] || ROLE_ROUTES["candidate"];
      setTimeout(() => { window.location.href = route; }, 800);

    } catch (err) {
      showAlert("Unexpected error after login. Please try again.");
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-arrow-right-to-bracket"></i> Sign In';
    }
  }

  // ── SOCIAL LOGIN ─────────────────────────────────────────────────
  async function socialLogin(provider) {
    // ⚠️ Replace with your Supabase OAuth redirect call when ready
    showAlert("Social login coming soon.", "warning");
  }
</script>
</body>
</html>
